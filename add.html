<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vehicle & Driver Details with Expiry Tracking</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <style>
    body { 
      background-color: #f8f9fa; 
      font-family: "Segoe UI", Tahoma, Verdana, sans-serif; 
      color: #333; 
      margin: 0; 
      padding: 0; 
      line-height: 1.6;
    }
    .main-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-top: 20px;
    }
    .form-section {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #dee2e6;
    }
    .action-btns button {
      margin-right: 5px;
    }
    .hidden { display: none !important; }
    
    /* Custom styles for the vehicle/driver form */
    .preview { 
      max-width: 120px; 
      max-height: 120px; 
      border-radius: 6px; 
      display: block; 
      margin-top: 8px; 
      border: 1px solid #ddd;
    }
    .progress-wrap { 
      font-size: 13px; 
      margin-top: 6px; 
      color: #666;
    }
    .file-info {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
      display: block;
    }
    
    /* Expiry status styles */
    .expiry-status {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 12px; /* Pill shape */
      display: inline-block;
      margin-top: 5px;
      font-weight: 600; /* Bolder text */
      text-transform: uppercase; /* Uppercase text */
      letter-spacing: 0.5px;
    }
    .expiry-valid {
      background-color: #198754; /* Bootstrap's bg-success */
      color: #fff;
    }
    .expiry-warning {
      background-color: #ffc107; /* Bootstrap's bg-warning */
      color: #000;
    }
    .expiry-expired {
      background-color: #dc3545; /* Bootstrap's bg-danger */
      color: #fff;
    }
    
    /* Notification Styles */
    .notification-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      max-width: 400px;
    }
    .notification {
      background: white;
      border-left: 4px solid #e74c3c;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 6px;
      animation: slideIn 0.3s ease-out;
    }
    .notification.warning {
      border-left-color: #f39c12;
    }
    .notification.expired {
      border-left-color: #e74c3c;
    }
    .notification-title {
      font-weight: bold;
      margin-bottom: 8px;
      color: #333;
    }
    .notification-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .notification-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    .notification-btn.remind {
      background: #f39c12;
      color: white;
    }
    .notification-btn.done {
      background: #2e8b57;
      color: white;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    /* Loading animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Custom button styles */
    .download-btn {
      background-color: #198754;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.3s;
    }
    .download-btn:hover {
      background-color: #157347;
      color: white;
    }
    
    /* Branch info badge */
    .branch-badge {
      font-size: 0.7em;
      padding: 2px 6px;
      margin-left: 5px;
    }
    
    /* Summary Cards */
    .summary-card {
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      border: none;
    }
    .summary-card .card-body {
      padding: 1rem;
    }
    
    /* Responsive adjustments */
    @media (max-width: 900px) {
      .notification-container {
        left: 20px;
        right: 20px;
        max-width: none;
      }
    }

    /* Extra styles for the detail view */
    .detail-view-card {
      background-color: #fff;
      border: 1px solid #dee2e6;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
      margin-top: 1.5rem;
    }
    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 1rem;
      margin-bottom: 1.5rem;
    }
    .detail-header h3 {
      color: #2E8B57;
      margin: 0;
    }
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
    }
    .detail-group h5 {
      font-size: 1.1rem;
      color: #333;
      margin-bottom: 1rem;
      border-bottom: 1px solid #eee;
      padding-bottom: 0.5rem;
    }
    .detail-item {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid #f5f5f5;
    }

    /* **NEW**: Styles for the vehicle limit feature */
    .limit-reached-container {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      text-align: center;
      display: none; /* Hidden by default */
    }
    /* **NEW**: Progress bar styling */
    /* **NEW**: Styles for the payment status toggle switch */
    .form-switch .form-check-input {
      width: 2.5em;
      height: 1.25em;
      cursor: pointer;
      background-color: #ffc107; /* Yellow for Pending */
      border-color: #ffc107;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e");
    }
    .form-switch .form-check-input:checked {
      background-color: #198754; /* Green for Completed */
      border-color: #198754;
    }
    .payment-status-label {
      font-weight: 500;
      font-size: 0.85rem;
    }
    .payment-status-pending {
      color: #856404;
    }
    .payment-status-completed {
      color: #155724;
    }
    .progress {
      height: 8px;
      background-color: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-bar {
      background-color: #2E8B57;
      transition: width 0.2s ease;
    }
    .limit-reached-container p {
      margin: 0 0 10px 0;
      font-weight: 500;
    }

    /* ============================================= */
    /* CARD VIEW STYLES - NEW IMPLEMENTATION */
    /* ============================================= */
    
    .card-view-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .vehicle-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border: 1px solid #eaeaea;
    }
    
    .vehicle-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }
    
    .card-header {
      background: linear-gradient(135deg, #2E8B57 0%, #3CB371 100%);
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .vehicle-number {
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    
    .vehicle-type {
      font-size: 0.9rem;
      background: rgba(255,255,255,0.2);
      padding: 3px 10px;
      border-radius: 20px;
    }
    
    .card-body {
      padding: 20px;
    }
    
    .driver-info {
      margin-bottom: 15px;
    }
    
    .driver-name {
      font-size: 1.2rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }
    
    .driver-details {
      color: #666;
      font-size: 0.9rem;
    }
    
    .documents-section {
      margin: 15px 0;
      padding: 15px 0;
      border-top: 1px solid #eee;
      border-bottom: 1px solid #eee;
    }
    
    .documents-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 10px;
      color: #444;
    }
    
    .documents-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    
    .document-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
    }
    
    .document-icon {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.8rem;
    }
    
    .document-icon.license {
      background: #3498db;
    }
    
    .document-icon.puc {
      background: #2ecc71;
    }
    
    .document-icon.insurance {
      background: #9b59b6;
    }
    
    .document-icon.fitness {
      background: #e74c3c;
    }
    
    .document-status {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 600;
      margin-left: auto;
    }
    
    .status-valid {
      background: #d4edda;
      color: #155724;
    }
    
    .status-warning {
      background: #fff3cd;
      color: #856404;
    }
    
    .status-expired {
      background: #f8d7da;
      color: #721c24;
    }
    
    .card-footer {
      padding: 15px 20px;
      background: #f8f9fa;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
    }
    
    .action-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      border: none;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    
    .action-btn:hover {
      transform: scale(1.1);
    }
    
    .view-btn {
      background: #3498db;
    }
    
    .edit-btn {
      background: #f39c12;
    }
    
    .delete-btn {
      background: #e74c3c;
    }
    
    /* View Toggle */
    .view-toggle {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 15px;
    }
    
    .toggle-btn {
      background: white;
      border: 1px solid #ddd;
      padding: 8px 15px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .toggle-btn:first-child {
      border-radius: 5px 0 0 5px;
      border-right: none;
    }
    
    .toggle-btn:last-child {
      border-radius: 0 5px 5px 0;
    }
    
    .toggle-btn.active {
      background: #2E8B57;
      color: white;
      border-color: #2E8B57;
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #6c757d;
      grid-column: 1 / -1;
    }
    
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 15px;
      color: #dee2e6;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .card-view-container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>

  <div class="container">
    <div class="main-content">
      <h2 class="mb-4"><i class="fas fa-truck me-2"></i>Vehicle and Driver Management</h2>
      
      <div id="branchInfo" class="alert alert-info" style="display: none;">
        <i class="fas fa-info-circle"></i> 
        <span id="branchInfoText"></span>
      </div>
      
      <div id="successMessage" class="alert alert-success alert-dismissible fade show" role="alert" style="display:none">
        <i class="fas fa-check-circle"></i> <span id="successText">Operation completed successfully!</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
      
      <div id="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert" style="display:none">
        <i class="fas fa-exclamation-circle"></i> <span id="errorText"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>

      <div id="vehicleDetailView" class="detail-view-card hidden">
        <div class="detail-header">
          <h3 id="detailVehicleNumber">Vehicle Details</h3>
          <button class="btn btn-outline-secondary" onclick="hideDetailView()"><i class="fas fa-arrow-left me-2"></i>Back to List</button>
        </div>
        <div class="detail-grid">
          <div class="detail-group">
            <h5><i class="fas fa-calculator text-primary me-2"></i>Cost of Ownership</h5>
            <div class="detail-item">
              <strong>Total EMI Paid:</strong>
              <span id="tcoEmi" class="fw-bold">₹0.00</span>
            </div>
            <div class="detail-item">
              <strong>Total Driver Salary:</strong>
              <span id="tcoSalary" class="fw-bold">₹0.00</span>
            </div>
            <div class="detail-item">
              <strong>Total Work Expenses:</strong>
              <span id="tcoWork" class="fw-bold">₹0.00</span>
            </div>
            <div class="detail-item bg-light p-2 rounded mt-2">
              <strong class="text-primary">Total Cost of Ownership:</strong>
              <span id="tcoTotal" class="fw-bold text-primary fs-5">₹0.00</span>
            </div>
          </div>
          <div class="detail-group">
            <h5>Vehicle Information</h5>
            <div class="detail-item"><strong>Model:</strong> <span id="detailVehicleModel"></span></div>
            <div class="detail-item"><strong>Type:</strong> <span id="detailVehicleType"></span></div>
          </div>
          <div class="detail-group">
            <h5>Driver Information</h5>
            <div class="detail-item"><strong>Name:</strong> <span id="detailDriverName"></span></div>
            <div class="detail-item"><strong>License No:</strong> <span id="detailDriverLicense"></span></div>
            <div class="detail-item"><strong>Contact:</strong> <span id="detailContactNumber"></span></div>
          </div>
          <div class="detail-group">
            <h5>Documents</h5>
            <div class="detail-item">
              <span><i class="fas fa-id-card text-primary me-2"></i>License</span>
              <span id="detailLicenseLink"></span>
            </div>
            <div class="detail-item">
              <span><i class="fas fa-file-certificate text-success me-2"></i>PUC</span>
              <span id="detailPucLink"></span>
            </div>
            <div class="detail-item">
              <span><i class="fas fa-file-contract text-info me-2"></i>Insurance</span>
              <span id="detailInsuranceLink"></span>
            </div>
            <div class="detail-item">
              <span><i class="fas fa-heartbeat text-danger me-2"></i>Fitness</span>
              <span id="detailFitnessLink"></span>
            </div>
          </div>
        </div>
        
        <div id="vehicleSpecificData" class="mt-4">
            <h4 class="mb-3">Vehicle Activity</h4>
            <ul class="nav nav-tabs mb-3" id="vehicleDetailTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="detail-work-tab" data-bs-toggle="tab" data-bs-target="#detail-work-content" type="button" role="tab">Vehicle Work</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="detail-payments-tab" data-bs-toggle="tab" data-bs-target="#detail-payments-content" type="button" role="tab">Driver Payments</button>
                </li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane fade show active" id="detail-work-content" role="tabpanel">
                    <div class="table-responsive">
                        <table id="detailVehicleWorkTable" class="table table-sm table-striped" style="width:100%">
                            <thead><tr><th>Date</th><th>LR No.</th><th>From</th><th>To</th><th class="text-end">Amount (₹)</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="tab-pane fade" id="detail-payments-content" role="tabpanel">
                    <div class="table-responsive">
                        <table id="detailDriverPaymentsTable" class="table table-sm table-striped" style="width:100%">
                            <thead><tr><th>Date</th><th class="text-end">Amount (₹)</th><th>Remarks</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
      </div>

      <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="vehicle-entry-tab" data-bs-toggle="tab" data-bs-target="#vehicle-entry-content" type="button" role="tab">Vehicle Entry & Documents</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="driver-entry-tab" data-bs-toggle="tab" data-bs-target="#driver-entry-content" type="button" role="tab">Driver Entry & Assignment</button>
        </li>
      </ul>

      <div class="tab-content" id="mainView">
        
        <div class="tab-pane fade show active" id="vehicle-entry-content" role="tabpanel">
          <div id="limitReachedContainer" class="limit-reached-container">
            <p id="limitMessage">You have reached your vehicle limit.</p>
            <button id="addMoreVehiclesBtn" class="btn btn-warning">
              <i class="fas fa-plus-circle me-2"></i>Add More Vehicles
            </button>
          </div>
          
          <form id="vehicleForm" class="form-section">
            <h4 class="mb-3">Add Vehicle Details</h4>
            
            <div class="card mb-4">
              <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-truck me-2"></i>Vehicle Information</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="vehicleNumber" class="form-label">Vehicle Number *</label>
                    <input type="text" id="vehicleNumber" class="form-control" required placeholder="e.g. KA01AB1234" />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="vehicleType" class="form-label">Vehicle Type</label>
                    <input type="text" id="vehicleType" class="form-control" placeholder="e.g. Truck, Mini Truck" />
                  </div>
                </div>
                <div class="row">
                   <div class="col-md-6 mb-3">
                    <label for="monthlyInstallment" class="form-label">Monthly Installment (EMI)</label>
                    <input type="number" id="monthlyInstallment" class="form-control" placeholder="e.g., 25000" step="0.01" />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="vehicleModel" class="form-label">Vehicle Model (Optional)</label>
                    <input type="text" id="vehicleModel" class="form-control" placeholder="e.g. Ashok Leyland Ecomet" />
                  </div>
                </div>
              </div>
            </div>
            
            <div class="card mb-4">
              <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Vehicle Documents</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="pucFile" class="form-label"><i class="fas fa-file-certificate"></i> PUC Certificate (image/pdf)</label>
                    <input type="file" id="pucFile" class="form-control" accept="image/*,application/pdf" />
                    <img id="pucPreview" class="preview" style="display:none" />
                    <div id="pucProgress" class="progress-wrap small"></div>
                    <span id="pucFileInfo" class="file-info"></span>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="pucExpiryDate" class="form-label">PUC Expiry Date</label>
                    <input type="date" id="pucExpiryDate" class="form-control" />
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="insuranceFile" class="form-label"><i class="fas fa-file-contract"></i> Insurance Paper (image/pdf)</label>
                    <input type="file" id="insuranceFile" class="form-control" accept="image/*,application/pdf" />
                    <img id="insurancePreview" class="preview" style="display:none" />
                    <div id="insuranceProgress" class="progress-wrap small"></div>
                    <span id="insuranceFileInfo" class="file-info"></span>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="insuranceExpiryDate" class="form-label">Insurance Expiry Date</label>
                    <input type="date" id="insuranceExpiryDate" class="form-control" />
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="fitnessFile" class="form-label"><i class="fas fa-heartbeat"></i> Fitness Certificate (image/pdf)</label>
                    <input type="file" id="fitnessFile" class="form-control" accept="image/*,application/pdf" />
                    <img id="fitnessPreview" class="preview" style="display:none" />
                    <div id="fitnessProgress" class="progress-wrap small"></div>
                    <span id="fitnessFileInfo" class="file-info"></span>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="fitnessExpiryDate" class="form-label">Fitness Expiry Date</label>
                    <input type="date" id="fitnessExpiryDate" class="form-control" />
                  </div>
                </div>
              </div>
            </div>

            <div class="d-flex gap-2 flex-wrap align-items-center">
              <button type="submit" id="saveVehicleBtn" class="btn btn-primary"><i class="fas fa-save me-2"></i> Save Vehicle</button>
              <button type="button" id="cancelVehicleEdit" class="btn btn-warning" style="display:none"><i class="fas fa-times me-2"></i> Cancel Edit</button>
              <span class="small text-muted">Images will be resized (max width 1024px) and converted to WebP before upload.</span>
            </div>
          </form>

          <hr class="my-4">

          <h4 class="mb-3">Vehicle List</h4>
          
          <div class="form-section mb-3">
            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="vehicleSearchInput" class="form-label">Search Vehicle:</label>
                <input type="text" id="vehicleSearchInput" class="form-control" placeholder="Search by vehicle no..." />
              </div>
              <div class="col-md-4 mb-3">
                <label for="vehicleTypeFilter" class="form-label">Filter by Type:</label>
                <select id="vehicleTypeFilter" class="form-select">
                  <option value="">All Types</option>
                  <option value="Truck">Truck</option>
                  <option value="Mini Truck">Mini Truck</option>
                  <option value="Container">Container</option>
                  <option value="Trailer">Trailer</option>
                </select>
              </div>
              <div class="col-md-4 mb-3">
                <label for="vehicleEntriesPerPage" class="form-label">Entries per page:</label>
                <select id="vehicleEntriesPerPage" class="form-select">
                  <option value="5">5</option>
                  <option value="10" selected>10</option>
                  <option value="20">20</option>
                  <option value="50">50</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="view-toggle">
            <div class="btn-group" role="group">
              <button type="button" class="toggle-btn active" id="vehicleCardViewBtn">
                <i class="fas fa-th-large me-2"></i>Card View
              </button>
              <button type="button" class="toggle-btn" id="vehicleTableViewBtn">
                <i class="fas fa-table me-2"></i>Table View
              </button>
            </div>
          </div>

          <div id="vehicleCardView" class="card-view-container">
            </div>

          <div id="vehicleTableView" class="table-responsive" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5>Vehicle List</h5>
              <button class="btn btn-success" onclick="downloadVehicleExcel()"><i class="fas fa-file-excel me-2"></i> Export Excel</button>
            </div>

            <div class="entries-info mb-3 text-muted" id="vehicleEntriesInfo"></div>

            <table id="vehicleTable" class="table table-striped table-bordered" style="width:100%">
              <thead>
                <tr>
                  <th>Vehicle No.</th>
                  <th>Type</th>
                  <th>EMI</th>
                  <th>PUC</th>
                  <th>Insurance</th>
                  <th>Fitness</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody id="vehicleTableBody">
                </tbody>
            </table>
          </div>

          <div class="d-flex justify-content-center align-items-center mt-3">
            <button class="btn btn-outline-primary me-2" id="vehiclePrevPage" disabled><i class="fas fa-chevron-left"></i></button>
            <div class="btn-group me-2" id="vehicleTabNavigation">
              </div>
            <button class="btn btn-outline-primary" id="vehicleNextPage"><i class="fas fa-chevron-right"></i></button>
          </div>
        </div>
        
        <div class="tab-pane fade" id="driver-entry-content" role="tabpanel">
          <form id="driverForm" class="form-section">
            <h4 class="mb-3">Add Driver Details and Assign Vehicle</h4>
            
            <div class="card mb-4">
              <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-user me-2"></i>Driver Information</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-4 mb-3">
                    <label for="driverName" class="form-label">Driver Name *</label>
                    <input type="text" id="driverName" class="form-control" required placeholder="Driver's full name" />
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="driverFatherName" class="form-label">Father's Name</label>
                    <input type="text" id="driverFatherName" class="form-control" placeholder="Father's full name" />
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="driverContactNumber" class="form-label">Driver Contact Number *</label>
                    <input type="tel" id="driverContactNumber" class="form-control" required placeholder="+91 1234567890" />
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="driverLicense" class="form-label">Driver License No. *</label>
                    <input type="text" id="driverLicense" class="form-control" required placeholder="License number" />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="licenseExpiryDate" class="form-label">License Expiry Date</label>
                    <input type="date" id="licenseExpiryDate" class="form-control" />
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="monthlySalary" class="form-label">Monthly Salary (₹) *</label>
                    <input type="number" id="monthlySalary" class="form-control" required placeholder="e.g., 15000" step="0.01" />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="licenseImage" class="form-label">License Image (photo)</label>
                    <input type="file" id="licenseImage" class="form-control" accept="image/*" />
                    <img id="licensePreview" class="preview" style="display:none" />
                    <div id="licenseProgress" class="progress-wrap small"></div>
                    <span id="licenseFileInfo" class="file-info"></span>
                  </div>
                </div>
              </div>
            </div>

            <div class="d-flex gap-2 flex-wrap align-items-center">
              <button type="submit" id="saveDriverBtn" class="btn btn-primary"><i class="fas fa-save me-2"></i> Save Driver</button>
              <button type="button" id="cancelDriverEdit" class="btn btn-warning" style="display:none"><i class="fas fa-times me-2"></i> Cancel Edit</button>
            </div>
          </form>

          <hr class="my-4">

          <h4 class="mb-3">Driver List</h4>

          <div class="table-responsive">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5>Registered Drivers</h5>
              <button class="btn btn-success" onclick="downloadDriverExcel()"><i class="fas fa-file-excel me-2"></i> Export Excel</button>
            </div>
            
            <table id="driverTable" class="table table-striped table-bordered" style="width:100%">
              <thead>
                <tr>
                  <th>Driver Name</th>
                  <th>Father's Name</th>
                  <th>Contact</th>
                  <th>License No.</th>
                  <th>License Image</th>
                  <th>Monthly Salary</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody id="driverTableBody">
                </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="notification-container" id="notificationContainer"></div>

  <div class="modal fade lr-detail-modal" id="lrDetailModal" tabindex="-1" aria-labelledby="lrDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="lrDetailModalLabel">LR Report Details</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="lrDetailContent">
          </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="addVehiclesModal" tabindex="-1" aria-labelledby="addVehiclesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addVehiclesModalLabel">Add More Vehicle Slots</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>You can add more vehicle slots to your plan. The cost for each additional vehicle (<strong>₹14/vehicle</strong>) will be added to your next monthly bill.</p>
          
          <div class="mb-3">
            <label for="vehiclesToAdd" class="form-label">Number of additional vehicles to add:</label>
            <select id="vehiclesToAdd" class="form-select">
              <option value="5">5 Vehicles</option>
              <option value="10">10 Vehicles</option>
              <option value="20">20 Vehicles</option>
              <option value="50">50 Vehicles</option>
            </select>
          </div>
          <div class="text-center my-3">
            <h4>Additional Monthly Cost: <span id="addOnCost" class="text-primary fw-bold">₹70</span></h4>
          </div>
          <button id="confirmUpgradeBtn" class="btn btn-primary w-100">Confirm Upgrade</button>
          <p class="text-muted small mt-2 text-center">This change will be reflected in your next billing cycle.</p>
        </div>
      </div>
    </div>
  </div>

  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
  
  <script src="navbar-loader.js"></script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getDatabase, ref, onValue, update, push, remove, get, set, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

     // Cloudinary Configuration
     const CLOUDINARY_CLOUD_NAME = 'doqapn15f';
     const CLOUDINARY_UPLOAD_PRESET = 'vehicle-driver';

     // Ensure DOM-related setups run once DOM is ready
     document.addEventListener('DOMContentLoaded', () => {
       // Call basic UI initializers so toggles and pagination work immediately
       try {
         setupViewToggle();
       } catch (e) {
         console.warn('setupViewToggle() not ready yet:', e);
       }
       try {
         initTabInterface();
       } catch (e) {
         console.warn('initTabInterface() not ready yet:', e);
       }
     });
     
     // Resize image before upload
     async function resizeImage(file, maxWidth, quality = 0.8) {
       return new Promise((resolve) => {
         const reader = new FileReader();
         reader.onload = (event) => {
           const img = new Image();
           img.onload = () => {
             const canvas = document.createElement('canvas');
             let width = img.width;
             let height = img.height;

             if (width > maxWidth) {
               height = Math.round((height * maxWidth) / width);
               width = maxWidth;
             }

             canvas.width = width;
             canvas.height = height;
             const ctx = canvas.getContext('2d');
             ctx.drawImage(img, 0, 0, width, height);
             
             // Convert to Blob with specified quality
             canvas.toBlob(
               (blob) => resolve(blob),
               'image/jpeg',
               quality
             );
           };
           img.src = event.target.result;
         };
         reader.readAsDataURL(file);
       });
     }
     
     // Upload to Cloudinary
     async function uploadToCloudinary(blob, fileName = 'document.jpg') {
       if (!CLOUDINARY_CLOUD_NAME || !CLOUDINARY_UPLOAD_PRESET) {
         throw new Error('Cloudinary configuration is missing');
       }
       
       const formData = new FormData();
       formData.append('file', blob, fileName);
       formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
       
       const response = await fetch(
         `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`,
         {
           method: 'POST',
           body: formData,
         }
       );
       
       if (!response.ok) {
         const error = await response.text();
         throw new Error(`Cloudinary upload failed: ${error}`);
       }
       
       const data = await response.json();
       return data.secure_url;
     }
     
     // Set up PDF.js worker
     pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.worker.min.js';
     
     // Initialize Firebase
     const firebaseConfig = {
        apiKey: "AIzaSyDAlk_K8p8Of8Ne6Jpcl2QqXTtm95NgG7o",
        authDomain: "transport-dashboard-ad69a.firebaseapp.com",
        databaseURL: "https://transport-dashboard-ad69a-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "transport-dashboard-ad69a",
        storageBucket: "transport-dashboard-ad69a.appspot.com",
        messagingSenderId: "526889676196",
        appId: "1:526889676196:web:66032c80a4aede690ae531",
        measurementId: "G-7F9R7HJYDH"
     };
     
     // Initialize Firebase
     const app = initializeApp(firebaseConfig);
     const auth = getAuth(app);
     const database = getDatabase(app);

     // Configuration
     const ITEMS_PER_PAGE_OPTIONS = [5, 10, 20, 50];
     let currentPage = 1; // For Vehicle List
     let itemsPerPage = 10;
     let totalPages = 1;
     let allVehiclesData = {};
     let allDriversData = {}; // NEW: Separate data for drivers
     let filteredVehiclesData = {};
     let currentUser = null;
     let coreAccountId = null;
     let accountType = 'core';
     let branchType = 'main';
     let notifications = [];
     let isEditingVehicle = false; // NEW: Separate editing state
     let editingVehicleKey = null;
     let isEditingDriver = false; // NEW: Separate editing state
     let editingDriverKey = null;
     let currentVehicleData = {};
     let detailDriverPaymentsTable; 
     let vehicleWorkTable;
     let currentEditingDriverPaymentId = null;
     
     // **NEW**: Subscription variables
     let allClients = {}; 
     let vehicleLimit = 50; 
     let currentVehicleCount = 0;
     let allDriverPayments = []; // FIX: Define the missing array for salary status checks

     // DOM elements
     const vehicleTableBody = document.getElementById("vehicleTableBody"); // NEW
     const driverTableBody = document.getElementById("driverTableBody"); // NEW
     const vehicleTabNavigation = document.getElementById("vehicleTabNavigation"); // NEW
     const vehiclePrevPageBtn = document.getElementById("vehiclePrevPage"); // NEW
     const vehicleNextPageBtn = document.getElementById("vehicleNextPage"); // NEW
     const vehicleEntriesPerPageSelect = document.getElementById("vehicleEntriesPerPage"); // NEW
     const vehicleEntriesInfo = document.getElementById("vehicleEntriesInfo"); // NEW
     const vehicleSearchInput = document.getElementById("vehicleSearchInput"); // NEW
     const vehicleTypeFilter = document.getElementById("vehicleTypeFilter"); // NEW
     const notificationContainer = document.getElementById("notificationContainer");
     const branchInfo = document.getElementById("branchInfo");
     const branchInfoText = document.getElementById("branchInfoText");
     
     // View elements
     const vehicleCardView = document.getElementById("vehicleCardView"); // NEW
     const vehicleTableView = document.getElementById("vehicleTableView"); // NEW
     const vehicleCardViewBtn = document.getElementById("vehicleCardViewBtn"); // NEW
     const vehicleTableViewBtn = document.getElementById("vehicleTableViewBtn"); // NEW
     
     // NEW: Driver List Datatable
     let driverTable;

     // Show branch information
     function showBranchInfo() {
       if (accountType === 'branch') {
         branchInfoText.innerHTML = `
           You are viewing shared data from <strong>${branchType}</strong> branch. 
           Your changes will sync across all branches in real-time.
           ${branchType === 'sub' ? '<span class="badge bg-warning branch-badge">SUB BRANCH</span>' : '<span class="badge bg-primary branch-badge">MAIN BRANCH</span>'}
         `;
         branchInfo.style.display = 'block';
       }
     }
     
     // Setup real-time listeners for multi-branch sync
     function setupRealtimeListeners() {
       // Listen for vehicle data changes
       const vehiclesRef = ref(database, `users/${coreAccountId}/vehicles`);
       onValue(vehiclesRef, (snapshot) => {
         allVehiclesData = snapshot.val() || {};
         renderVehicleListWithPagination(); // NEW
         renderVehicleCardView(); // NEW
         checkVehicleLimit(); 
         // populateVehicleSelects(); // NEW: Refresh selectors for assignments/payments - REMOVED DUE TO TypeError
       });

       // NEW: Listen for driver data changes
       const driversRef = ref(database, `users/${coreAccountId}/drivers`);
       onValue(driversRef, (snapshot) => {
         allDriversData = snapshot.val() || {};
         renderDriverListTable(); // NEW
         // Re-render vehicle list to update assigned driver status
         renderVehicleListWithPagination();
         renderVehicleCardView();
       });

       // Listen for client data changes (needed for LR detail modal)
       const clientsRef = ref(database, `users/${coreAccountId}/clients`);
       onValue(clientsRef, (snapshot) => {
         allClients = {};
         if (snapshot.exists()) {
           snapshot.forEach(child => { allClients[child.key] = child.val(); });
         }
       });
     }

     // **NEW**: Function to check and enforce vehicle limit
     function checkVehicleLimit() {
        if (!coreAccountId) return;

        const limitContainer = document.getElementById('limitReachedContainer');
        const limitMessage = document.getElementById('limitMessage');
        const saveVehicleBtn = document.getElementById('saveVehicleBtn'); // NEW: Target vehicle save button

        get(ref(database, `users/${coreAccountId}`)).then(snapshot => {
            const userData = snapshot.val();
            // **FIX**: Check both root subscription and profile subscription for robustness.
            const sub = userData?.subscription || userData?.profile?.subscription;

            if (sub) {
              vehicleLimit = sub.vehicleLimit || 0;
              currentVehicleCount = Object.keys(allVehiclesData).length;

              // -1 means unlimited
              if (vehicleLimit !== -1 && currentVehicleCount >= vehicleLimit) {
                  limitMessage.textContent = `You have reached your plan limit of ${vehicleLimit} vehicles.`;
                  limitContainer.style.display = 'block';
                  saveVehicleBtn.disabled = true;
              } else {
                  limitContainer.style.display = 'none';
                  saveVehicleBtn.disabled = false;
              }
            } else {
                limitMessage.textContent = 'Could not verify your subscription plan. Please contact support.';
                limitContainer.style.display = 'block';
                saveVehicleBtn.disabled = true;
            }
        });
     }
     
     // Initialize the tab interface
     function initTabInterface() {
       // Vehicle List listeners (NEW)
       vehicleEntriesPerPageSelect.addEventListener('change', function() {
         itemsPerPage = parseInt(this.value);
         currentPage = 1;
         renderVehicleListWithPagination();
       });
       
       vehiclePrevPageBtn.addEventListener('click', function() {
         if (currentPage > 1) {
           currentPage--;
           renderVehicleListWithPagination();
         }
       });
       
       vehicleNextPageBtn.addEventListener('click', function() {
         if (currentPage < totalPages) {
           currentPage++;
           renderVehicleListWithPagination();
         }
       });
       
       // Initial render
       renderVehicleListWithPagination();
     }
     
     // Calculate pagination and render vehicle list
     function renderVehicleListWithPagination() {
       // Get filtered data
       filterVehicleData();
       
       // Calculate pagination values
       const totalItems = Object.keys(filteredVehiclesData).length;
       totalPages = Math.ceil(totalItems / itemsPerPage);
       
       // Update pagination controls
       updatePaginationControls(totalItems);
       
       // Get current page data
       const startIndex = (currentPage - 1) * itemsPerPage;
       const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
       const pageData = Object.entries(filteredVehiclesData)
         .slice(startIndex, endIndex)
         .reduce((obj, [key, value]) => {
           obj[key] = value;
           return obj;
         }, {});
       
       // Render table with only the current page data
       renderVehicleTable(pageData);
       renderVehicleCardView();
     }
     
     // Filter data based on search and filter inputs (Vehicle)
     function filterVehicleData() {
       const searchText = vehicleSearchInput.value ? vehicleSearchInput.value.toLowerCase() : '';
       const filterValue = vehicleTypeFilter.value || '';
       
       filteredVehiclesData = Object.entries(allVehiclesData).reduce((result, [key, vehicle]) => {
         const vehicleNumber = vehicle.vehicleNumber ? vehicle.vehicleNumber.toLowerCase() : '';
         const vehicleType = vehicle.vehicleType || '';
         
         const matchesSearch = searchText === '' || vehicleNumber.includes(searchText);
           
         const matchesFilter = filterValue === '' || vehicleType === filterValue;
         
         if (matchesSearch && matchesFilter) {
           result[key] = vehicle;
         }
         
         return result;
       }, {});
     }

     // Get driver's salary status for the current month (STUB)
     function getDriverSalaryStatus(driverName) {
       // This function requires a full implementation to check driver payments against monthly salary
       // For now, it will return a default status to prevent errors.
       if (!driverName || allDriverPayments.length === 0) {
         return 'Pending';
       }
       return 'Pending'; // Placeholder logic
     }
     
     // Sort data based on salary status (STUB)
     function sortDataBySalaryStatus(order = 'asc') {
       // Stubbed out as this logic is no longer strictly necessary with separate lists.
     }
     
     // Update pagination controls (Vehicle List)
     function updatePaginationControls(totalItems) {
       vehiclePrevPageBtn.disabled = currentPage === 1;
       vehicleNextPageBtn.disabled = currentPage === totalPages;
       
       const startIndex = Math.min((currentPage - 1) * itemsPerPage + 1, totalItems);
       const endIndex = Math.min(currentPage * itemsPerPage, totalItems);
       vehicleEntriesInfo.textContent = `Showing ${startIndex} to ${endIndex} of ${totalItems} entries`;
       
       generatePageTabs();
     }
     
     // Generate page tabs (Vehicle List)
     function generatePageTabs() {
       vehicleTabNavigation.innerHTML = '';
       addVehicleTab(1);
       
       let startPage = Math.max(2, currentPage - 2);
       let endPage = Math.min(totalPages - 1, currentPage + 2);
       
       if (startPage > 2) { addVehicleEllipsis(); }
       
       for (let i = startPage; i <= endPage; i++) { addVehicleTab(i); }
       
       if (endPage < totalPages - 1) { addVehicleEllipsis(); }
       
       if (totalPages > 1) { addVehicleTab(totalPages); }
     }
     
     // Add a tab for a specific page (Vehicle List)
     function addVehicleTab(pageNumber) {
       const tab = document.createElement('button');
       tab.className = `btn btn-sm ${pageNumber === currentPage ? 'btn-primary' : 'btn-outline-primary'}`;
       tab.textContent = pageNumber;
       tab.addEventListener('click', () => {
         currentPage = pageNumber;
         renderVehicleListWithPagination();
       });
       vehicleTabNavigation.appendChild(tab);
     }
     
     // Add ellipsis to tab navigation (Vehicle List)
     function addVehicleEllipsis() {
       const ellipsis = document.createElement('span');
       ellipsis.className = 'px-2';
       ellipsis.textContent = '...';
       vehicleTabNavigation.appendChild(ellipsis);
     }
     
     // Render the Vehicle table with given data (NEW)
     function renderVehicleTable(data) {
       vehicleTableBody.innerHTML = '';
       
       if (Object.keys(data).length === 0) {
         vehicleTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-muted">No vehicle data found</td></tr>`;
         return;
       }
       
       Object.entries(data).forEach(([key, vehicle]) => {
         const row = document.createElement('tr');
         
         const pucStatus = getExpiryStatus(vehicle.pucExpiry);
         const insuranceStatus = getExpiryStatus(vehicle.insuranceExpiry);
         const fitnessStatus = getExpiryStatus(vehicle.fitnessExpiry);
         
         row.innerHTML = `
           <td>
             <strong>${vehicle.vehicleNumber || 'N/A'}</strong>
             ${vehicle.vehicleModel ? `<br><small class="text-muted">${vehicle.vehicleModel}</small>` : ''}
           </td>
           <td>${vehicle.vehicleType || '-'}</td>
           <td>₹${(vehicle.monthlyInstallment || 0).toFixed(2)}</td>
           <td>
             ${pucStatus ? `<div class="expiry-status ${pucStatus.class}">${pucStatus.text}</div>` : '-'}
           </td>
           <td>
             ${insuranceStatus ? `<div class="expiry-status ${insuranceStatus.class}">${insuranceStatus.text}</div>` : '-'}
           </td>
           <td>
             ${fitnessStatus ? `<div class="expiry-status ${fitnessStatus.class}">${fitnessStatus.text}</div>` : '-'}
           </td>
           <td class="text-center">
             <div class="action-btns">
               <button class="btn btn-sm btn-outline-info" onclick="viewDetails('${key}')" title="View Details">
                 <i class="fas fa-eye"></i>
               </button>
               <button class="btn btn-sm btn-outline-warning" onclick="editVehicleEntry('${key}')" title="Edit">
                 <i class="fas fa-edit"></i>
               </button>
               <button class="btn btn-sm btn-outline-danger" onclick="deleteVehicleEntry('${key}')" title="Delete">
                 <i class="fas fa-trash"></i>
               </button>
             </div>
           </td>
         `;
         vehicleTableBody.appendChild(row);
       });
     }

     // =============================================
     // DRIVER LIST FUNCTIONS - NEW IMPLEMENTATION
     // =============================================
     
     // Initialize Driver List DataTable (NEW)
     function renderDriverListTable() {
         if (!driverTable) {
             driverTable = $('#driverTable').DataTable({
                 searching: true,
                 paging: true,
                 info: true,
                 autoWidth: false,
                 order: [[0, 'asc']],
                 columnDefs: [
                   { targets: [4, 6], orderable: false }
                 ]
             });
         }

         driverTable.clear();
         
         if (Object.keys(allDriversData).length === 0) {
           driverTable.draw();
           return;
         } 

         Object.entries(allDriversData).forEach(([key, driver]) => {
            const licenseStatus = getExpiryStatus(driver.licenseExpiry);
            
            driverTable.row.add([
                driver.driverName || 'N/A',
                driver.driverFatherName || '-',
                driver.contactNumber || '-',
                `${driver.driverLicense || '-'} ${licenseStatus ? `<div class="expiry-status ${licenseStatus.class}">${licenseStatus.text}</div>` : ''}`,
                driver.licenseImageUrl ? 
                    `<a href="${driver.licenseImageUrl}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fas fa-eye"></i> View</a>` : 
                    '<span class="text-muted">No image</span>',
                `₹${(driver.monthlySalary || 0).toFixed(2)}`, 
                `<button class="btn btn-sm btn-outline-warning" onclick="editDriverEntry('${key}')" title="Edit">
                   <i class="fas fa-edit"></i>
                 </button>
                 <button class="btn btn-sm btn-outline-danger" onclick="deleteDriverEntry('${key}')" title="Delete">
                   <i class="fas fa-trash"></i>
                 </button>`
            ]);
         });
         driverTable.draw();
     }

     // Edit Driver Entry (NEW)
     function editDriverEntry(key) {
        const driver = allDriversData[key];
        if (!driver) return;

        isEditingDriver = true;
        editingDriverKey = key;

        // Populate form
        document.getElementById('driverName').value = driver.driverName || '';
        document.getElementById('driverFatherName').value = driver.driverFatherName || '';
        document.getElementById('driverContactNumber').value = driver.contactNumber || '';
        document.getElementById('driverLicense').value = driver.driverLicense || '';
        document.getElementById('licenseExpiryDate').value = driver.licenseExpiry || '';
        document.getElementById('monthlySalary').value = driver.monthlySalary || '';

        // Show existing license image info
        const licensePreview = document.getElementById('licensePreview');
        if (driver.licenseImageUrl) {
            licensePreview.src = driver.licenseImageUrl;
            licensePreview.style.display = 'block';
            document.getElementById('licenseFileInfo').textContent = 'An image is already uploaded. Choose a new file to replace it.';
        } else {
            licensePreview.style.display = 'none';
            document.getElementById('licenseFileInfo').textContent = '';
        }

        // Show cancel button
        document.getElementById('cancelDriverEdit').style.display = 'inline-block';
        document.getElementById('saveDriverBtn').innerHTML = '<i class="fas fa-save me-2"></i> Update Driver';

        // Switch to the Driver Entry tab and scroll to form
        const driverTabBtn = document.getElementById('driver-entry-tab');
        new bootstrap.Tab(driverTabBtn).show();
        document.getElementById('driverForm').scrollIntoView({ behavior: 'smooth' });
    }

    // Delete Driver Entry (NEW)
    function deleteDriverEntry(key) {
        if (confirm('Are you sure you want to delete this driver entry? This will also unassign them from any vehicle.')) {
            // Since there's no assignment, we can just delete the driver.
            Promise.resolve()
                .then(() => { 
                    // Then delete the driver
                    return remove(ref(database, `users/${coreAccountId}/drivers/${key}`));
                })
                .then(() => {
                    showSuccess('Driver entry deleted and unassigned successfully');
                })
                .catch((error) => {
                    showError('Error deleting driver entry: ' + error.message);
                });
        }
    }
     
     // =============================================
     // CARD VIEW FUNCTIONS - NEW IMPLEMENTATION (Vehicle List)
     // =============================================
     
     // Render the card view
     function renderVehicleCardView() {
       filterVehicleData();
       
       if (Object.keys(filteredVehiclesData).length === 0) {
         vehicleCardView.innerHTML = `
           <div class="empty-state">
             <i class="fas fa-truck"></i>
             <h4>No Vehicles Found</h4>
             <p>Try adjusting your search or filter criteria</p>
           </div>
         `;
         return;
       }
       
       vehicleCardView.innerHTML = '';
       
       Object.entries(filteredVehiclesData).forEach(([key, vehicle]) => {
         const card = createVehicleCard(key, vehicle);
         vehicleCardView.appendChild(card);
       });
     }

     // Create a vehicle card
     function createVehicleCard(key, vehicle) {
       const card = document.createElement('div');
       card.className = 'vehicle-card';
       
       // Get expiry status for each document
       const pucStatus = getExpiryStatus(vehicle.pucExpiry);
       const insuranceStatus = getExpiryStatus(vehicle.insuranceExpiry);
       const fitnessStatus = getExpiryStatus(vehicle.fitnessExpiry);
       
       // Find driver data (NEW)
       const driver = allDriversData[vehicle.assignedDriverKey];
       const driverName = driver ? driver.driverName : 'No Driver Assigned';
       const driverLicense = driver ? driver.driverLicense : '-';
       const driverContact = driver ? driver.contactNumber : '-';
       const licenseStatus = driver ? getExpiryStatus(driver.licenseExpiry) : null;

      card.innerHTML = `
        <div class="card-header">
          <div class="vehicle-number">${vehicle.vehicleNumber || 'N/A'}</div>
          <div class="vehicle-type">${vehicle.vehicleType || '-'}</div>
        </div>
        <div class="card-body">
          <div class="driver-details">
              <div><i class="fas fa-rupee-sign me-2"></i>EMI: ₹${(vehicle.monthlyInstallment || 0).toFixed(2)}</div>
          </div>
          <div class="documents-section">
            <div class="documents-title">Vehicle Documents & Status</div>
            <div class="documents-grid">
              <div class="document-item">
                <div class="document-icon puc">
                  <i class="fas fa-file-certificate"></i>
                </div>
                <span>PUC</span>
                <div class="document-status ${pucStatus ? getStatusClass(pucStatus.class) : 'status-warning'}">
                  ${pucStatus ? pucStatus.text : 'No Data'}
                </div>
              </div>
              <div class="document-item">
                <div class="document-icon insurance">
                  <i class="fas fa-file-contract"></i>
                </div>
                <span>Insurance</span>
                <div class="document-status ${insuranceStatus ? getStatusClass(insuranceStatus.class) : 'status-warning'}">
                  ${insuranceStatus ? insuranceStatus.text : 'No Data'}
                </div>
              </div>
              <div class="document-item">
                <div class="document-icon fitness">
                  <i class="fas fa-heartbeat"></i>
                </div>
                <span>Fitness</span>
                <div class="document-status ${fitnessStatus ? getStatusClass(fitnessStatus.class) : 'status-warning'}">
                  ${fitnessStatus ? fitnessStatus.text : 'No Data'}
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <div class="last-updated">
            <small class="text-muted">Last updated: ${formatDate(new Date(vehicle.lastUpdated || Date.now()))}</small>
          </div>
          <div class="action-buttons">
            <button class="action-btn view-btn" title="View Details" onclick="viewDetails('${key}')">
              <i class="fas fa-eye"></i>
            </button>
            <button class="action-btn edit-btn" title="Edit" onclick="editVehicleEntry('${key}')">
              <i class="fas fa-edit"></i>
            </button>
            <button class="action-btn delete-btn" title="Delete" onclick="deleteVehicleEntry('${key}')">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `;
       
       return card;
     }
     
     // Convert expiry status class to card status class
     function getStatusClass(expiryClass) {
       switch(expiryClass) {
         case 'expiry-valid': return 'status-valid';
         case 'expiry-warning': return 'status-warning';
         case 'expiry-expired': return 'status-expired';
         default: return 'status-warning';
       }
     }
     
     // Format date for display
     function formatDate(date) {
       return date.toLocaleDateString('en-IN', {
         day: '2-digit',
         month: 'short',
         year: 'numeric'
       });
     }
     
     // Set up view toggle functionality (Vehicle List)
     function setupViewToggle() {
       // Clear old listeners by replacing elements
       const cardBtn = document.getElementById('vehicleCardViewBtn');
       const tableBtn = document.getElementById('vehicleTableViewBtn');
       const newCardBtn = cardBtn.cloneNode(true);
       const newTableBtn = tableBtn.cloneNode(true);
       cardBtn.parentNode.replaceChild(newCardBtn, cardBtn);
       tableBtn.parentNode.replaceChild(newTableBtn, tableBtn);

       newCardBtn.addEventListener('click', function() {
         newCardBtn.classList.add('active');
         newTableBtn.classList.remove('active');
         vehicleCardView.style.display = 'grid';
         vehicleTableView.style.display = 'none';
         renderVehicleCardView();
       });
       
       newTableBtn.addEventListener('click', function() {
         newTableBtn.classList.add('active');
         newCardBtn.classList.remove('active');
         vehicleTableView.style.display = 'block';
         vehicleCardView.style.display = 'none';
         renderVehicleListWithPagination();
       });
     }
     
     // Get expiry status for a date
     function getExpiryStatus(expiryDate) {
       if (!expiryDate) return null;
       
       const today = new Date();
       const expiry = new Date(expiryDate);
       // Reset time component for accurate day calculation
       today.setHours(0,0,0,0);
       expiry.setHours(0,0,0,0);

       const daysUntilExpiry = Math.ceil((expiry.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
       
       if (daysUntilExpiry < 0) {
         return { class: 'expiry-expired', text: 'Expired' };
       } else if (daysUntilExpiry <= 30) {
         return { class: 'expiry-warning', text: `${daysUntilExpiry}d left` };
       } else {
         return { class: 'expiry-valid', text: 'Valid' };
       }
     }
     
     // View details in detail view
     async function viewDetails(key) {
       const vehicle = allVehiclesData[key];
       if (!vehicle) return;
       
       currentVehicleData = vehicle;
       
       // Find driver data (NEW)
       document.getElementById('detailVehicleNumber').textContent = vehicle.vehicleNumber || 'Vehicle Details';
       document.getElementById('detailVehicleModel').textContent = vehicle.vehicleModel || '-';
       document.getElementById('detailVehicleType').textContent = vehicle.vehicleType || '-';

       // Document links (License comes from driver data now)
       document.getElementById('detailLicenseLink').innerHTML = driver && driver.licenseImageUrl ? 
         `<a href="${driver.licenseImageUrl}" target="_blank" class="btn btn-sm btn-outline-primary">View</a>` : 
         '<span class="text-muted">No file</span>';
         
       document.getElementById('detailPucLink').innerHTML = vehicle.pucFileUrl ? 
         `<a href="${vehicle.pucFileUrl}" target="_blank" class="btn btn-sm btn-outline-success">View</a>` : 
         '<span class="text-muted">No file</span>';
         
       document.getElementById('detailInsuranceLink').innerHTML = vehicle.insuranceFileUrl ? 
         `<a href="${vehicle.insuranceFileUrl}" target="_blank" class="btn btn-sm btn-outline-info">View</a>` : 
         '<span class="text-muted">No file</span>';
         
       document.getElementById('detailFitnessLink').innerHTML = vehicle.fitnessFileUrl ? 
         `<a href="${vehicle.fitnessFileUrl}" target="_blank" class="btn btn-sm btn-outline-danger">View</a>` : 
         '<span class="text-muted">No file</span>';
       
       // Show detail view, hide main view
       document.getElementById('vehicleDetailView').classList.remove('hidden');
       document.getElementById('mainView').classList.add('hidden');

       // --- Populate vehicle-specific tables and TCO ---

       // Initialize DataTables if they don't exist
       if (!detailDriverPaymentsTable) {
           detailDriverPaymentsTable = $('#detailDriverPaymentsTable').DataTable({ "pageLength": 5, "searching": false, "info": false, "lengthChange": false, "order": [[0, "desc"]] });
       }
       if (!vehicleWorkTable) { 
           vehicleWorkTable = $('#detailVehicleWorkTable').DataTable({ "pageLength": 5, "searching": false, "info": false, "lengthChange": false, "order": [[0, "desc"]] });
       }

       // Clear previous data
       vehicleWorkTable.clear();
       detailDriverPaymentsTable.clear();

       let totalWorkExpenses = 0;
       let totalDriverSalary = 0;
       let totalEmiPaid = parseFloat(vehicle.monthlyInstallment) || 0; // NEW: Use monthly installment for EMI for now

       document.getElementById('tcoEmi').textContent = `₹${totalEmiPaid.toFixed(2)}`;
       document.getElementById('tcoSalary').textContent = `₹0.00`; // Will be updated by salary payments query
       
       // 1. Load Vehicle Work data for this vehicle
       const lrQuery = query(ref(database, `users/${coreAccountId}/lrReports`), orderByChild('truckNumber'), equalTo(vehicle.vehicleNumber));
        get(lrQuery).then(snapshot => {
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    const lr = child.val();
                    const vehicleWorkAmount = parseFloat(lr.vehicleWorkAmount) || parseFloat(lr.vehicleWork) || 0;
                    if (vehicleWorkAmount > 0) {
                        totalWorkExpenses += vehicleWorkAmount; 
                        vehicleWorkTable.row.add([
                            lr.date || '-',
                            `${lr.lrNumber || '-'} <a href="#" onclick="event.preventDefault(); viewLRDetails('${child.key}')" class="ms-2 text-primary" title="View LR Details"><i class="fas fa-eye"></i></a>`,
                            lr.fromLocation || '-',
                            lr.toLocation || '-',
                            `₹${vehicleWorkAmount.toFixed(2)}`
                        ]);
                    }

                    const emptyWorkAmount = lr.emptyTripData ? (parseFloat(lr.emptyTripData.vehicleWorkAmount) || parseFloat(lr.emptyTripData.vehicleWork) || 0) : 0;
                    if (emptyWorkAmount > 0) {
                        totalWorkExpenses += emptyWorkAmount; 
                        vehicleWorkTable.row.add([
                            lr.date || '-',
                            `${lr.lrNumber || '-'} (Return) <a href="#" onclick="event.preventDefault(); viewLRDetails('${child.key}')" class="ms-2 text-primary" title="View LR Details"><i class="fas fa-eye"></i></a>`, 
                            lr.toLocation || '-', 
                            lr.fromLocation || '-', 
                            `₹${emptyWorkAmount.toFixed(2)}`
                        ]);
                    }
                });
            }
            document.getElementById('tcoWork').textContent = `₹${totalWorkExpenses.toFixed(2)}`; 
            vehicleWorkTable.draw();
            updateTCOSummary(totalWorkExpenses, totalDriverSalary, totalEmiPaid);
        });

       // 2. Load Driver Payments for this vehicle
       const paymentQuery = query(ref(database, `users/${coreAccountId}/driverSalaryPayments`), orderByChild('vehicleNumber'), equalTo(vehicle.vehicleNumber));
        get(paymentQuery).then(snapshot => {
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    const p = child.val();
                    totalDriverSalary += parseFloat(p.amount) || 0;
                    detailDriverPaymentsTable.row.add([p.date, `₹${(p.amount || 0).toFixed(2)}`, p.remarks || '-']);
                });
            }
            document.getElementById('tcoSalary').textContent = `₹${totalDriverSalary.toFixed(2)}`;
            detailDriverPaymentsTable.draw();
            updateTCOSummary(totalWorkExpenses, totalDriverSalary, totalEmiPaid);
        });

        function updateTCOSummary(work, salary, emi) {
             const total = work + salary + emi;
             document.getElementById('tcoTotal').textContent = `₹${total.toFixed(2)}`;
        }
     }
     
     // Hide detail view
     function hideDetailView() {
       document.getElementById('vehicleDetailView').classList.add('hidden');
       document.getElementById('mainView').classList.remove('hidden');
     }
     
     // Edit Vehicle entry (NEW)
     function editVehicleEntry(key) {
       const vehicle = allVehiclesData[key];
       if (!vehicle) return;
       
       isEditingVehicle = true;
       editingVehicleKey = key;
       
       // Populate form with existing data
       document.getElementById('vehicleNumber').value = vehicle.vehicleNumber || '';
       document.getElementById('vehicleType').value = vehicle.vehicleType || '';
       document.getElementById('vehicleModel').value = vehicle.vehicleModel || '';
       document.getElementById('monthlyInstallment').value = vehicle.monthlyInstallment || '';
       
       document.getElementById('pucExpiryDate').value = vehicle.pucExpiry || '';
       document.getElementById('insuranceExpiryDate').value = vehicle.insuranceExpiry || '';
       document.getElementById('fitnessExpiryDate').value = vehicle.fitnessExpiry || '';
       
       const pucPreview = document.getElementById('pucPreview');
       if (vehicle.pucFileUrl && vehicle.pucFileUrl.match(/\.(jpeg|jpg|gif|png|webp)$/i)) { pucPreview.src = vehicle.pucFileUrl; pucPreview.style.display = 'block'; }
       if (vehicle.pucFileUrl) { document.getElementById('pucFileInfo').textContent = 'A file is already uploaded. Choose a new file to replace it.'; }

       // ... (Similar logic for insurance and fitness previews/info) ...

       // Show cancel button
       document.getElementById('cancelVehicleEdit').style.display = 'inline-block';
       document.getElementById('saveVehicleBtn').innerHTML = '<i class="fas fa-save me-2"></i> Update Vehicle';
       
       const vehicleTabBtn = document.getElementById('vehicle-entry-tab');
       new bootstrap.Tab(vehicleTabBtn).show();
       document.getElementById('vehicleForm').scrollIntoView({ behavior: 'smooth' });
     }
     
     // Cancel Vehicle edit (NEW)
     function cancelVehicleEdit() {
       isEditingVehicle = false;
       editingVehicleKey = null;
       
       document.getElementById('vehicleForm').reset();
       document.getElementById('cancelVehicleEdit').style.display = 'none';
       document.getElementById('saveVehicleBtn').innerHTML = '<i class="fas fa-save me-2"></i> Save Vehicle';

       document.getElementById('pucExpiryDate').value = '';
       document.getElementById('insuranceExpiryDate').value = '';
       document.getElementById('fitnessExpiryDate').value = '';

       document.getElementById('pucPreview').style.display = 'none';
       document.getElementById('pucPreview').src = '';
       document.getElementById('insurancePreview').style.display = 'none';
       document.getElementById('insurancePreview').src = '';
       document.getElementById('fitnessPreview').style.display = 'none';
       document.getElementById('fitnessPreview').src = '';
       document.getElementById('pucFileInfo').textContent = '';
       document.getElementById('insuranceFileInfo').textContent = '';
       document.getElementById('fitnessFileInfo').textContent = '';
     }
     
     // Delete Vehicle entry (NEW)
     function deleteVehicleEntry(key) {
       if (confirm('Are you sure you want to delete this vehicle entry?')) {
         Promise.resolve().then(() => {
             // Then delete the vehicle
             return remove(ref(database, `users/${coreAccountId}/vehicles/${key}`));
         }).then(() => {
             showSuccess('Vehicle entry deleted and driver unassigned successfully');
         }).catch((error) => {
             showError('Error deleting vehicle entry: ' + error.message);
         });
       }
     }
     
     // Download Vehicle Excel (NEW)
     function downloadVehicleExcel() {
       // ... (Implementation to export vehicle list) ...
       showError('Excel download for Vehicles is not fully implemented in this restructured version.');
     }

     // Download Driver Excel (NEW)
     function downloadDriverExcel() {
       // ... (Implementation to export driver list) ...
       showError('Excel download for Drivers is not fully implemented in this restructured version.');
     }

     // Update Driver Salary Summary (STUB)
     function updateDriverSalarySummary() {
         document.getElementById('summaryTotalDrivers').textContent = Object.keys(allDriversData).length;
         document.getElementById('summaryTotalPaid').textContent = '₹0.00';
         document.getElementById('summaryTotalPending').textContent = '₹0.00';
         document.getElementById('driverSalarySummaryBody').innerHTML = '<tr><td colspan="6" class="text-center py-3">Driver salary calculation logic is pending implementation.</td></tr>';
     }
     
     // Show success message
     function showSuccess(message) {
       const successMessage = document.getElementById('successMessage');
       const successText = document.getElementById('successText');
       successText.textContent = message;
       successMessage.style.display = 'block';
       
       setTimeout(() => {
         successMessage.style.display = 'none';
       }, 5000);
     }
     
     // Show error message
     function showError(message) {
       const errorMessage = document.getElementById('errorMessage');
       const errorText = document.getElementById('errorText');
       errorText.textContent = message;
       errorMessage.style.display = 'block';
     }
     
     // Initialize the application
     function initApp() {
       try { setupViewToggle(); } catch (e) {}
       try { initTabInterface(); } catch (e) {}

       onAuthStateChanged(auth, (user) => {
         if (user) {
           currentUser = user;
           
           get(ref(database, 'users/' + user.uid)).then((snapshot) => {
             const userData = snapshot.val();
             if (userData) {
               accountType = userData.accountType || 'core';
               coreAccountId = userData.coreAccountId || user.uid;
               branchType = userData.branchType || 'main';
               
               setupRealtimeListeners();
               checkVehicleLimit();
               initTabInterface();
               loadDriverPayments();
               // populateVehicleSelects(); // Call removed to fix TypeError
               renderDriverListTable(); // Initialize driver table
             }
           });
         } else {
           window.location.href = 'login.html';
         }
       });
     }
     
     // Initialize when DOM is loaded
     document.addEventListener('DOMContentLoaded', function() {
       initApp();
       
       // NEW: Separate form submissions
       document.getElementById('vehicleForm').addEventListener('submit', handleVehicleFormSubmit);
       document.getElementById('driverForm').addEventListener('submit', handleDriverFormSubmit);
       document.getElementById('cancelVehicleEdit').addEventListener('click', cancelVehicleEdit);
       // NEW: Driver cancel edit (need to define)
       document.getElementById('cancelDriverEdit').addEventListener('click', cancelDriverEdit);
       
       // Set up search and filter events (Vehicle)
       vehicleSearchInput.addEventListener('input', debounce(function() {
         renderVehicleListWithPagination();
       }, 300));
       vehicleTypeFilter.addEventListener('change', function() {
         renderVehicleListWithPagination();
       });
       
       // Set up file info display for ALL files
       setupFileInfo('licenseImage', 'licenseFileInfo', 'licensePreview');
       setupFileInfo('pucFile', 'pucFileInfo', 'pucPreview');
       setupFileInfo('insuranceFile', 'insuranceFileInfo', 'insurancePreview');
       setupFileInfo('fitnessFile', 'fitnessFileInfo', 'fitnessPreview');

       setupAddVehiclesModal();
     });
     
     // Set up file info display
     function setupFileInfo(fileInputId, fileInfoId, previewId) {
       // ... (The original implementation is correct and remains here) ...
       document.getElementById(fileInputId).addEventListener('change', function(e) {
         const file = e.target.files[0];
         const fileInfo = document.getElementById(fileInfoId);
         
         if (file) {
           fileInfo.textContent = `Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
         } else {
           fileInfo.textContent = '';
         }

         // Handle image preview
         const preview = document.getElementById(previewId);
         if (preview && file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => { preview.src = e.target.result; preview.style.display = 'block'; };
            reader.readAsDataURL(file);
         } else if (preview) {
            preview.style.display = 'none';
         }
       });
     }
     
     // Debounce function for search
     function debounce(func, wait) {
       let timeout;
       return function executedFunction(...args) {
         const later = () => {
           clearTimeout(timeout);
           func(...args);
         };
         clearTimeout(timeout);
         timeout = setTimeout(later, wait);
       };
     }
     
     // Handle Vehicle form submission (NEW)
     async function handleVehicleFormSubmit(e) {
       e.preventDefault();
       
       const saveBtn = document.getElementById('saveVehicleBtn');
       const originalText = saveBtn.innerHTML;
       
       try {
         saveBtn.disabled = true;
         saveBtn.innerHTML = '<span class="loading"></span> Processing...';
         
         if (!isEditingVehicle) {
            if (vehicleLimit !== -1 && currentVehicleCount >= vehicleLimit) {
                throw new Error("Vehicle limit reached. Please upgrade your plan to add more vehicles.");
            }
         }

         const newVehicleNumber = document.getElementById('vehicleNumber').value.trim().toUpperCase();
         const isDuplicate = Object.entries(allVehiclesData).some(
           ([key, vehicle]) => 
             vehicle.vehicleNumber && 
             vehicle.vehicleNumber.trim().toUpperCase() === newVehicleNumber && 
             key !== editingVehicleKey 
         );
         if (isDuplicate) {
           throw new Error(`A vehicle with the number "${newVehicleNumber}" already exists.`);
         }
         
         // **FIX**: Validation change to only require vehicleNumber
         if (!newVehicleNumber) {
           throw new Error('Vehicle number is required');
         }


         // Vehicle data only
         const formData = {
           vehicleNumber: newVehicleNumber,
           vehicleType: document.getElementById('vehicleType').value.trim(), // Corrected typo from vehicleType
           vehicleModel: document.getElementById('vehicleModel').value.trim(),
           monthlyInstallment: parseFloat(document.getElementById('monthlyInstallment').value) || 0,
           lastEndingKm: 0, // **NEW**: Initialize lastEndingKm for new vehicles
           lastUpdated: new Date().toISOString(),
           lastUpdatedBy: currentUser.uid,
           lastUpdatedByName: currentUser.displayName || currentUser.email
         };

         formData.pucExpiry = document.getElementById('pucExpiryDate').value || null;
         formData.insuranceExpiry = document.getElementById('insuranceExpiryDate').value || null;
         formData.fitnessExpiry = document.getElementById('fitnessExpiryDate').value || null;
         
         // Upload files if selected
         const uploadPromises = [];
         
         const pucFile = document.getElementById('pucFile').files[0];
         if (pucFile) {
           uploadPromises.push(
             uploadFileWithProgress(pucFile, 'pucFileUrl', 'pucProgress', 'PUC')
           );
         }
         
         const insuranceFile = document.getElementById('insuranceFile').files[0];
         if (insuranceFile) {
           uploadPromises.push(
             uploadFileWithProgress(insuranceFile, 'insuranceFileUrl', 'insuranceProgress', 'Insurance')
           );
         }
         
         const fitnessFile = document.getElementById('fitnessFile').files[0];
         if (fitnessFile) {
           uploadPromises.push(
             uploadFileWithProgress(fitnessFile, 'fitnessFileUrl', 'fitnessProgress', 'Fitness')
           );
         }
         
         if (uploadPromises.length > 0) {
           const uploadResults = await Promise.all(uploadPromises);
           uploadResults.forEach(result => {
             formData[result.field] = result.url;
           });
         }
         
         // Merge with existing data if editing (to retain driver info)
         let finalData = isEditingVehicle && editingVehicleKey ? { ...allVehiclesData[editingVehicleKey], ...formData } : formData;

         let savePromise;
         if (isEditingVehicle && editingVehicleKey) {
           savePromise = update(ref(database, `users/${coreAccountId}/vehicles/${editingVehicleKey}`), finalData);
         } else {
           savePromise = push(ref(database, `users/${coreAccountId}/vehicles`), finalData);
         }
         
         await savePromise;
         
         cancelVehicleEdit();
         document.getElementById('vehicleForm').reset();
         showSuccess(isEditingVehicle ? 'Vehicle entry updated successfully' : 'Vehicle entry saved successfully');

       } catch (error) {
         console.error('Error saving vehicle entry:', error);
         showError('Error saving vehicle entry: ' + error.message);
       } finally {
         saveBtn.disabled = false;
         saveBtn.innerHTML = originalText;
       }
     }

     // Handle Driver form submission (NEW)
     async function handleDriverFormSubmit(e) {
        e.preventDefault();

        const saveBtn = document.getElementById('saveDriverBtn');
        const originalText = saveBtn.innerHTML;

        try {
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="loading"></span> Processing...';

            const newDriverLicense = document.getElementById('driverLicense').value.trim().toUpperCase();
            
            // Check for duplicate license number
            const isDuplicate = Object.entries(allDriversData).some(
                ([key, driver]) =>
                    driver.driverLicense &&
                    driver.driverLicense.trim().toUpperCase() === newDriverLicense &&
                    key !== editingDriverKey
            );
            if (isDuplicate) {
                throw new Error(`A driver with the license number "${newDriverLicense}" already exists.`);
            }

            const formData = {
                driverName: document.getElementById('driverName').value.trim(),
                driverFatherName: document.getElementById('driverFatherName').value.trim(),
                contactNumber: document.getElementById('driverContactNumber').value.trim(),
                driverLicense: newDriverLicense,
                licenseExpiry: document.getElementById('licenseExpiryDate').value || null,
                monthlySalary: parseFloat(document.getElementById('monthlySalary').value) || 0,
                lastUpdated: new Date().toISOString(),
                lastUpdatedBy: currentUser.uid,
                lastUpdatedByName: currentUser.displayName || currentUser.email
            };

            if (!formData.driverName || !formData.contactNumber || !formData.driverLicense || !formData.monthlySalary) {
                throw new Error('Driver name, contact, license, and monthly salary are required');
            }

            // Upload license image
            const licenseFile = document.getElementById('licenseImage').files[0];
            if (licenseFile) {
                const result = await uploadFileWithProgress(licenseFile, 'licenseImageUrl', 'licenseProgress', 'License Image');
                formData.licenseImageUrl = result.url;
            }

            // Save to Drivers database
            let savePromise;
            let driverKey = editingDriverKey;
            if (isEditingDriver && editingDriverKey) {
                // Update existing entry
                savePromise = update(ref(database, `users/${coreAccountId}/drivers/${editingDriverKey}`), formData);
            } else {
                // Create new entry
                const newRef = push(ref(database, `users/${coreAccountId}/drivers`), formData);
                savePromise = newRef;
                driverKey = newRef.key;
            }

            await savePromise; 

        } catch (error) {
            console.error('Error saving driver entry:', error);
            showError('Error saving driver entry: ' + error.message);
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
        }
    }

     // Cancel Driver edit (NEW)
     function cancelDriverEdit() {
       isEditingDriver = false;
       editingDriverKey = null;

       document.getElementById('driverForm').reset();
       document.getElementById('cancelDriverEdit').style.display = 'none';
       document.getElementById('saveDriverBtn').innerHTML = '<i class="fas fa-save me-2"></i> Save Driver';
       
       // Clear license image preview and info
       document.getElementById('licensePreview').style.display = 'none';
       document.getElementById('licensePreview').src = '';
       document.getElementById('licenseFileInfo').textContent = '';
       document.getElementById('licenseProgress').innerHTML = '';
     }
     
     // Upload file with progress tracking
     async function uploadFileWithProgress(file, fieldName, progressElementId, fileType) {
       const progressElement = document.getElementById(progressElementId);
       
       try {
         progressElement.innerHTML = `Uploading ${fileType}...`;
         
         let blobToUpload = file;
         
         if (file.type.startsWith('image/') && file.type !== 'image/svg+xml') {
           blobToUpload = await resizeImage(file, 1024, 0.8);
           progressElement.innerHTML = `Processing ${fileType} image...`;
         }
         
         const url = await uploadToCloudinary(blobToUpload, file.name);
         
         progressElement.innerHTML = `${fileType} uploaded successfully!`;
         
         return { field: fieldName, url };
         
       } catch (error) {
         progressElement.innerHTML = `Error uploading ${fileType}: ${error.message}`;
         throw error;
       }
     }
     
     // **NEW**: Logic for the "Add More Vehicles" modal
     function setupAddVehiclesModal() {
        const addVehiclesModal = new bootstrap.Modal(document.getElementById('addVehiclesModal'));
        const addMoreBtn = document.getElementById('addMoreVehiclesBtn');
        const addOnCostEl = document.getElementById('addOnCost');
        const confirmUpgradeBtn = document.getElementById('confirmUpgradeBtn');

        addMoreBtn.addEventListener('click', () => {
            calculateAddOnCost();
            addVehiclesModal.show();
        });

        const vehiclesToAddSelect = document.getElementById('vehiclesToAdd');
        vehiclesToAddSelect.addEventListener('change', calculateAddOnCost);

        function calculateAddOnCost() {
            const vehicles = parseInt(vehiclesToAddSelect.value, 10);
            const cost = vehicles * 80; // Your pricing: ₹80 per vehicle
            addOnCostEl.textContent = `₹${cost}`;
        }

        confirmUpgradeBtn.addEventListener('click', async () => {
            const vehiclesToAdd = parseInt(vehiclesToAddSelect.value, 10);
            const additionalCost = vehiclesToAdd * 80;

            try {
                confirmUpgradeBtn.disabled = true;
                confirmUpgradeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Upgrading...';

                const subRef = ref(database, `users/${coreAccountId}/subscription`);
                const snapshot = await get(subRef);
                if (!snapshot.exists()) {
                    throw new Error("Subscription data not found.");
                }

                const sub = snapshot.val();
                const currentLimit = sub.vehicleLimit || 0;
                const currentRate = sub.monthlyRate || 0;

                const newLimit = (currentLimit === -1) ? -1 : currentLimit + vehiclesToAdd;
                const newRate = currentRate + additionalCost;

                await update(subRef, {
                    vehicleLimit: newLimit,
                    monthlyRate: newRate
                });

                showSuccess('Plan upgraded successfully! Your vehicle limit has been increased.');
                addVehiclesModal.hide();
                checkVehicleLimit(); 

            } catch (error) {
                showError("Could not upgrade plan. " + error.message);
            } finally {
                confirmUpgradeBtn.disabled = false;
                confirmUpgradeBtn.innerHTML = 'Confirm Upgrade';
            }
        });
     }

     // Driver Payment Functions
     function loadDriverPayments() {
     }
     
     // **FIX**: Function stubbed to prevent TypeError. The elements it was trying to access 
     // (`vehicleSelect`) do not exist in this HTML file.
     function populateVehicleSelects() {
       // const paymentVehicleSelect = document.getElementById('vehicleSelect'); 
       
       // if (!paymentVehicleSelect) return;

       // paymentVehicleSelect.innerHTML = '<option value="">Loading vehicles...</option>';
       
       // get(ref(database, `users/${coreAccountId}/vehicles`)).then((snapshot) => {
       //   if (snapshot.exists()) {
       //     paymentVehicleSelect.innerHTML = '<option value="">Select Vehicle/Driver</option>';
       //     snapshot.forEach(child => {
       //       const vehicle = child.val();
             
       //       // Find driver for display
       //       const driver = allDriversData[vehicle.assignedDriverKey];
       //       const driverName = driver ? driver.driverName : 'No Driver';

       //       // Option for Payment Select
       //       let paymentOption = document.createElement('option');
       //       paymentOption.value = child.key; // Use vehicle key for assignment/payment
       //       paymentOption.textContent = `${vehicle.vehicleNumber} - ${driverName}`;
       //       paymentOption.setAttribute('data-vehicle-number', vehicle.vehicleNumber);
       //       paymentOption.setAttribute('data-driver-name', driverName);
       //       paymentVehicleSelect.appendChild(paymentOption);
       //     });
       //   } else {
       //     paymentVehicleSelect.innerHTML = '<option value="">No vehicles found</option>';
       //   }
       // });
     }
     
     // View LR Details (Copied from booking.html, adapted for add.html)
     async function viewLRDetails(lrId) {
       const dataRoot = coreAccountId || currentUser.uid;
       const lrRef = ref(database, `users/${dataRoot}/lrReports/${lrId}`);
       const lrSnap = await get(lrRef);

       if (!lrSnap.exists()) {
         alert('LR report not found.');
         return;
       }

       const lr = lrSnap.val();
       const modalContent = document.getElementById('lrDetailContent');

       // FIX: Use vehicleWorkAmount/vehicleWork
       const mainVehicleWork = parseFloat(lr.vehicleWorkAmount) || parseFloat(lr.vehicleWork) || 0;
       const emptyVehicleWork = lr.emptyTripData ? (parseFloat(lr.emptyTripData.vehicleWorkAmount) || parseFloat(lr.emptyTripData.vehicleWork) || 0) : 0;
       const totalVehicleWork = mainVehicleWork + emptyVehicleWork;

       const totalExpenses = (
         (parseFloat(lr.tyreExpenses) || 0) +
         (parseFloat(lr.dieselExpenses) || 0) +
         (parseFloat(lr.tollExpenses) || 0) +
         totalVehicleWork +
         (parseFloat(lr.foodExpenses) || 0) +
         (parseFloat(lr.otherExpenses) || 0) +
         (parseFloat(lr.advance) || 0)
       );
       const profit = (lr.billingAmount || 0) - totalExpenses;

       modalContent.innerHTML = `
         <div class="row">
           <div class="col-md-6">
             <div class="detail-row"><strong>LR Number:</strong> ${lr.lrNumber || 'N/A'}</div>
             <div class="detail-row"><strong>Date:</strong> ${lr.date || 'N/A'}</div>
             <div class="detail-row"><strong>Vehicle:</strong> ${lr.truckNumber || 'N/A'}</div>
             <div class="detail-row"><strong>Route:</strong> ${lr.fromLocation || 'N/A'} to ${lr.toLocation || 'N/A'}</div>
             <div class="detail-row"><strong>Item:</strong> ${lr.item || 'N/A'}</div>
             <div class="detail-row"><strong>Weight:</strong> ${lr.weight || 0} tonnes</div>
           </div>
           <div class="col-md-6">
             <div class="detail-row"><strong>Billing Amount:</strong> ₹${(lr.billingAmount || 0).toFixed(2)}</div>
             <div class="detail-row"><strong>Freight Amount:</strong> ₹${(lr.freightAmount || 0).toFixed(2)}</div>
             <div class="detail-row"><strong>Advance Paid:</strong> ₹${(lr.advance || 0).toFixed(2)}</div>
             <div class="detail-row"><strong>Balance:</strong> ₹${(lr.balance || 0).toFixed(2)}</div>
             <div class="detail-row"><strong>Total Amount (inc. GST):</strong> ₹${(lr.totalAmount || 0).toFixed(2)}</div>
             <div class="detail-row">
               <strong>Payment Status:</strong> 
               <span class="status-badge ${lr.paymentStatus === 'paid' ? 'status-paid' : lr.paymentStatus === 'partial' ? 'status-pending' : 'status-overdue'}">
                 ${lr.paymentStatus || 'pending'}
               </span>
             </div>
           </div>
         </div>
         <hr>
         <h5 class="mt-3">Expense Breakdown</h5>
         <div class="row">
             <div class="col-md-4"><div class="detail-row"><strong>Tyre:</strong> ₹${(lr.tyreExpenses || 0).toFixed(2)}</div></div>
             <div class="col-md-4"><div class="detail-row"><strong>Diesel:</strong> ₹${(lr.dieselExpenses || 0).toFixed(2)}</div></div>
             <div class="col-md-4"><div class="detail-row"><strong>Toll:</strong> ₹${(lr.tollExpenses || 0).toFixed(2)}</div></div>
             <div class="col-md-4"><div class="detail-row"><strong>Vehicle Work:</strong> ₹${totalVehicleWork.toFixed(2)}</div></div>
             <div class="col-md-4"><div class="detail-row"><strong>Food:</strong> ₹${(lr.foodExpenses || 0).toFixed(2)}</div></div>
             <div class="col-md-4"><div class="detail-row"><strong>Other:</strong> ₹${(lr.otherExpenses || 0).toFixed(2)}</div></div>
         </div>
         <hr>
         <div class="row fw-bold fs-5 mt-3">
             <div class="col-6 text-end">Total Expenses:</div>
             <div class="col-6 text-start">₹${totalExpenses.toFixed(2)}</div>
         </div>
         <div class="row fw-bold fs-5 mt-1 ${profit >= 0 ? 'text-success' : 'text-danger'}">
             <div class="col-6 text-end">Net Profit:</div>
             <div class="col-6 text-start">₹${profit.toFixed(2)}</div>
         </div>
       `;

       const modal = new bootstrap.Modal(document.getElementById('lrDetailModal'));
       modal.show();
     }

     // Make functions globally accessible
     window.viewLRDetails = viewLRDetails;
     window.editVehicleEntry = editVehicleEntry; // NEW
     window.deleteVehicleEntry = deleteVehicleEntry; // NEW
     window.editDriverEntry = editDriverEntry; // NEW
     window.deleteDriverEntry = deleteDriverEntry; // NEW
     window.viewDetails = viewDetails;
     window.hideDetailView = hideDetailView;
     window.downloadVehicleExcel = downloadVehicleExcel; // NEW
     window.downloadDriverExcel = downloadDriverExcel; // NEW
     window.cancelVehicleEdit = cancelVehicleEdit; // Expose cancel edit

     
  </script>
</body></html>
