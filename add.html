<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vehicle & Driver Details with Expiry Tracking</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <!-- Add Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <style>
    body { 
      background-color: #f8f9fa; 
      font-family: "Segoe UI", Tahoma, Verdana, sans-serif; 
      color: #333; 
      margin: 0; 
      padding: 0; 
      line-height: 1.6;
    }
    .main-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-top: 20px;
    }
    .form-section {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #dee2e6;
    }
    .action-btns button {
      margin-right: 5px;
    }
    .hidden { display: none !important; }
    
    /* Custom styles for the vehicle/driver form */
    .preview { 
      max-width: 120px; 
      max-height: 120px; 
      border-radius: 6px; 
      display: block; 
      margin-top: 8px; 
      border: 1px solid #ddd;
    }
    .progress-wrap { 
      font-size: 13px; 
      margin-top: 6px; 
      color: #666;
    }
    .file-info {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
      display: block;
    }
    
    /* Expiry status styles */
    .expiry-status {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 12px; /* Pill shape */
      display: inline-block;
      margin-top: 5px;
      font-weight: 600; /* Bolder text */
      text-transform: uppercase; /* Uppercase text */
      letter-spacing: 0.5px;
    }
    .expiry-valid {
      background-color: #198754; /* Bootstrap's bg-success */
      color: #fff;
    }
    .expiry-warning {
      background-color: #ffc107; /* Bootstrap's bg-warning */
      color: #000;
    }
    .expiry-expired {
      background-color: #dc3545; /* Bootstrap's bg-danger */
      color: #fff;
    }
    
    /* Notification Styles */
    .notification-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      max-width: 400px;
    }
    .notification {
      background: white;
      border-left: 4px solid #e74c3c;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 6px;
      animation: slideIn 0.3s ease-out;
    }
    .notification.warning {
      border-left-color: #f39c12;
    }
    .notification.expired {
      border-left-color: #e74c3c;
    }
    .notification-title {
      font-weight: bold;
      margin-bottom: 8px;
      color: #333;
    }
    .notification-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .notification-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    .notification-btn.remind {
      background: #f39c12;
      color: white;
    }
    .notification-btn.done {
      background: #2e8b57;
      color: white;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    /* Loading animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Custom button styles */
    .download-btn {
      background-color: #198754;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.3s;
    }
    .download-btn:hover {
      background-color: #157347;
      color: white;
    }
    
    /* Branch info badge */
    .branch-badge {
      font-size: 0.7em;
      padding: 2px 6px;
      margin-left: 5px;
    }
    
    /* Summary Cards */
    .summary-card {
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      border: none;
    }
    .summary-card .card-body {
      padding: 1rem;
    }
    
    /* Responsive adjustments */
    @media (max-width: 900px) {
      .notification-container {
        left: 20px;
        right: 20px;
        max-width: none;
      }
    }
  </style>
  <!-- Extra styles for the detail view -->
  <style>
    .detail-view-card {
      background-color: #fff;
      border: 1px solid #dee2e6;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
      margin-top: 1.5rem;
    }
    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 1rem;
      margin-bottom: 1.5rem;
    }
    .detail-header h3 {
      color: #2E8B57;
      margin: 0;
    }
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
    }
    .detail-group h5 {
      font-size: 1.1rem;
      color: #333;
      margin-bottom: 1rem;
      border-bottom: 1px solid #eee;
      padding-bottom: 0.5rem;
    }
    .detail-item {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid #f5f5f5;
    }
  </style>
  <!-- **NEW**: Styles for the vehicle limit feature -->
  <style>
    .limit-reached-container {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      text-align: center;
      display: none; /* Hidden by default */
    }
    /* **NEW**: Progress bar styling */
    /* **NEW**: Styles for the payment status toggle switch */
    .form-switch .form-check-input {
      width: 2.5em;
      height: 1.25em;
      cursor: pointer;
      background-color: #ffc107; /* Yellow for Pending */
      border-color: #ffc107;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e");
    }
    .form-switch .form-check-input:checked {
      background-color: #198754; /* Green for Completed */
      border-color: #198754;
    }
    .payment-status-label {
      font-weight: 500;
      font-size: 0.85rem;
    }
    .payment-status-pending {
      color: #856404;
    }
    .payment-status-completed {
      color: #155724;
    }
    .progress {
      height: 8px;
      background-color: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-bar {
      background-color: #2E8B57;
      transition: width 0.2s ease;
    }
    .limit-reached-container p {
      margin: 0 0 10px 0;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <!-- Navbar will be loaded here by navbar-loader.js -->
  <div id="navbar-placeholder"></div>

  <div class="container">
    <div class="main-content">
      <h2 class="mb-4"><i class="fas fa-truck me-2"></i>Vehicle and Driver Entry Form</h2>
      
      <!-- Branch Info Display -->
      <div id="branchInfo" class="alert alert-info" style="display: none;">
        <i class="fas fa-info-circle"></i> 
        <span id="branchInfoText"></span>
      </div>
      
      <!-- Success and Error Messages -->
      <div id="successMessage" class="alert alert-success alert-dismissible fade show" role="alert" style="display:none">
        <i class="fas fa-check-circle"></i> <span id="successText">Operation completed successfully!</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
      
      <div id="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert" style="display:none">
        <i class="fas fa-exclamation-circle"></i> <span id="errorText"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>

      <!-- Vehicle Detail View (Initially Hidden) -->
      <div id="vehicleDetailView" class="detail-view-card hidden">
        <div class="detail-header">
          <h3 id="detailVehicleNumber">Vehicle Details</h3>
          <button class="btn btn-outline-secondary" onclick="hideDetailView()"><i class="fas fa-arrow-left me-2"></i>Back to List</button>
        </div>
        <div class="detail-grid">
          <div class="detail-group">
            <h5>Vehicle Information</h5>
            <div class="detail-item"><strong>Model:</strong> <span id="detailVehicleModel"></span></div>
            <div class="detail-item"><strong>Type:</strong> <span id="detailVehicleType"></span></div>
          </div>
          <div class="detail-group">
            <h5>Driver Information</h5>
            <div class="detail-item"><strong>Name:</strong> <span id="detailDriverName"></span></div>
            <div class="detail-item"><strong>License No:</strong> <span id="detailDriverLicense"></span></div>
            <div class="detail-item"><strong>Contact:</strong> <span id="detailContactNumber"></span></div>
          </div>
          <div class="detail-group">
            <h5>Documents</h5>
            <div class="detail-item">
              <span><i class="fas fa-id-card text-primary me-2"></i>License</span>
              <span id="detailLicenseLink"></span>
            </div>
            <div class="detail-item">
              <span><i class="fas fa-file-certificate text-success me-2"></i>PUC</span>
              <span id="detailPucLink"></span>
            </div>
            <div class="detail-item">
              <span><i class="fas fa-file-contract text-info me-2"></i>Insurance</span>
              <span id="detailInsuranceLink"></span>
            </div>
            <div class="detail-item">
              <span><i class="fas fa-heartbeat text-danger me-2"></i>Fitness</span>
              <span id="detailFitnessLink"></span>
            </div>
          </div>
        </div>
        
        <!-- Vehicle-Specific Data Tables -->
        <div id="vehicleSpecificData" class="mt-4">
            <h4 class="mb-3">Vehicle Activity</h4>
            <ul class="nav nav-tabs mb-3" id="vehicleDetailTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="detail-work-tab" data-bs-toggle="tab" data-bs-target="#detail-work-content" type="button" role="tab">Vehicle Work</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="detail-payments-tab" data-bs-toggle="tab" data-bs-target="#detail-payments-content" type="button" role="tab">Driver Payments</button>
                </li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane fade show active" id="detail-work-content" role="tabpanel">
                    <div class="table-responsive">
                        <table id="detailVehicleWorkTable" class="table table-sm table-striped" style="width:100%">
                            <thead><tr><th>Date</th><th>LR No.</th><th>From</th><th>To</th><th class="text-end">Amount (₹)</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="tab-pane fade" id="detail-payments-content" role="tabpanel">
                    <div class="table-responsive">
                        <table id="detailDriverPaymentsTable" class="table table-sm table-striped" style="width:100%">
                            <thead><tr><th>Date</th><th class="text-end">Amount (₹)</th><th>Remarks</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
      </div>

      <!-- Tabs -->
      <ul class="nav nav-tabs mb-3" id="vehicleTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="vehicles-tab" data-bs-toggle="tab" data-bs-target="#vehicles-content" type="button" role="tab">Vehicle & Driver Entry</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="driver-payments-tab" data-bs-toggle="tab" data-bs-target="#driver-payments-content" type="button" role="tab">Driver Salary Payments</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="vehicle-work-tab" data-bs-toggle="tab" data-bs-target="#vehicle-work-content" type="button" role="tab">Vehicle Work Expenses</button>
        </li>
      </ul>

      <div class="tab-content" id="mainView">
        <div class="tab-pane fade show active" id="vehicles-content" role="tabpanel">
          <!-- **NEW**: Vehicle Limit Reached Container -->
          <div id="limitReachedContainer" class="limit-reached-container">
            <p id="limitMessage">You have reached your vehicle limit.</p>
            <button id="addMoreVehiclesBtn" class="btn btn-warning">
              <i class="fas fa-plus-circle me-2"></i>Add More Vehicles
            </button>
          </div>
          <!-- Vehicle & Driver Entry Form -->
          <form id="vehicleDriverForm" class="form-section">
            <h4 class="mb-3">Add Vehicle & Driver Details</h4>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="vehicleNumber" class="form-label"><i class="fas fa-truck"></i> Vehicle Number *</label>
                <input type="text" id="vehicleNumber" class="form-control" required placeholder="e.g. KA01AB1234" />
              </div>
              <div class="col-md-6 mb-3">
                <label for="vehicleType" class="form-label"><i class="fas fa-car"></i> Vehicle Type</label>
                <input type="text" id="vehicleType" class="form-control" placeholder="e.g. Truck, Mini Truck" />
              </div>
            </div>

            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="driverName" class="form-label"><i class="fas fa-user"></i> Driver Name</label>
                <input type="text" id="driverName" class="form-control" placeholder="Driver's full name" />
              </div>
              <div class="col-md-4 mb-3">
                <label for="driverLicense" class="form-label"><i class="fas fa-id-card"></i> Driver License No.</label>
                <input type="text" id="driverLicense" class="form-control" placeholder="License number" />
              </div>
              <div class="col-md-4 mb-3">
                <label for="licenseExpiryDate" class="form-label"><i class="fas fa-calendar-alt"></i> License Expiry Date</label>
                <input type="date" id="licenseExpiryDate" class="form-control" />
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="contactNumber" class="form-label"><i class="fas fa-phone"></i> Driver Contact Number</label>
                <input type="tel" id="contactNumber" class="form-control" placeholder="+91 1234567890" />
              </div>
              <div class="col-md-6 mb-3">
                <label for="licenseImage" class="form-label"><i class="fas fa-id-card"></i> License Image (photo)</label>
                <input type="file" id="licenseImage" class="form-control" accept="image/*" />
                <img id="licensePreview" class="preview" style="display:none" />
                <div id="licenseProgress" class="progress-wrap small"></div>
                <span id="licenseFileInfo" class="file-info"></span>
              </div>
            </div>

            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="pucFile" class="form-label"><i class="fas fa-file-certificate"></i> PUC Certificate (image/pdf)</label>
                <input type="file" id="pucFile" class="form-control" accept="image/*,application/pdf" />
                <img id="pucPreview" class="preview" style="display:none" />
                <div id="pucProgress" class="progress-wrap small"></div>
                <span id="pucFileInfo" class="file-info"></span>
              </div>
              <div class="col-md-2 mb-3">
                <label for="pucExpiryDate" class="form-label"><i class="fas fa-calendar-alt"></i> PUC Expiry</label>
                <input type="date" id="pucExpiryDate" class="form-control" />
              </div>
              <div class="col-md-4 mb-3">
                <label for="insuranceFile" class="form-label"><i class="fas fa-file-contract"></i> Insurance Paper (image/pdf)</label>
                <input type="file" id="insuranceFile" class="form-control" accept="image/*,application/pdf" />
                <img id="insurancePreview" class="preview" style="display:none" />
                <div id="insuranceProgress" class="progress-wrap small"></div>
                <span id="insuranceFileInfo" class="file-info"></span>
              </div>
              <div class="col-md-2 mb-3">
                <label for="insuranceExpiryDate" class="form-label"><i class="fas fa-calendar-alt"></i> Insurance Expiry</label>
                <input type="date" id="insuranceExpiryDate" class="form-control" />
              </div>
            </div>

            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="fitnessFile" class="form-label"><i class="fas fa-heartbeat"></i> Fitness Certificate (image/pdf)</label>
                <input type="file" id="fitnessFile" class="form-control" accept="image/*,application/pdf" />
                <img id="fitnessPreview" class="preview" style="display:none" />
                <div id="fitnessProgress" class="progress-wrap small"></div>
                <span id="fitnessFileInfo" class="file-info"></span>
              </div>
              <div class="col-md-2 mb-3">
                <label for="fitnessExpiryDate" class="form-label"><i class="fas fa-calendar-alt"></i> Fitness Expiry</label>
                <input type="date" id="fitnessExpiryDate" class="form-control" />
              </div>
            </div>

            <div class="d-flex gap-2 flex-wrap align-items-center">
              <button type="submit" id="saveBtn" class="btn btn-primary"><i class="fas fa-save me-2"></i> Save Entry</button>
              <button type="button" id="cancelEdit" class="btn btn-warning" style="display:none"><i class="fas fa-times me-2"></i> Cancel Edit</button>
              <span class="small text-muted">Images will be resized (max width 1024px) and converted to WebP before upload.</span>
            </div>
          </form>

          <hr class="my-4">

          <h4 class="mb-3">View Vehicle & Driver Info</h4>
          
          <!-- Filter Section -->
          <div class="form-section mb-3">
            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="searchInput" class="form-label">Search Vehicle/Driver:</label>
                <input type="text" id="searchInput" class="form-control" placeholder="Search by vehicle no, driver name..." />
              </div>
              <div class="col-md-4 mb-3">
                <label for="typeFilter" class="form-label">Filter by Vehicle Type:</label>
                <select id="typeFilter" class="form-select">
                  <option value="">All Types</option>
                  <option value="Truck">Truck</option>
                  <option value="Mini Truck">Mini Truck</option>
                  <option value="Container">Container</option>
                  <option value="Trailer">Trailer</option>
                </select>
              </div>
              <div class="col-md-4 mb-3">
                <label for="entriesPerPage" class="form-label">Entries per page:</label>
                <select id="entriesPerPage" class="form-select">
                  <option value="5">5</option>
                  <option value="10" selected>10</option>
                  <option value="20">20</option>
                  <option value="50">50</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>Vehicle & Driver List</h5>
            <button class="btn btn-success" onclick="downloadExcel()"><i class="fas fa-file-excel me-2"></i> Export Excel</button>
          </div>

          <div class="entries-info mb-3 text-muted" id="entriesInfo"></div>

          <div class="table-responsive">
            <table id="vehicleDriverTable" class="table table-striped table-bordered" style="width:100%">
              <thead>
                <tr>
                  <th>Vehicle Number</th>
                  <th>Type</th>
                  <th>Driver</th>
                  <th>License No.</th>
                  <th>Contact</th>
                  <th>License Image</th>
                  <th>PUC</th>
                  <th>Insurance</th>
                  <th>Fitness</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody id="tableBody">
                <!-- Data will be populated by JavaScript -->
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div class="d-flex justify-content-center align-items-center mt-3">
            <button class="btn btn-outline-primary me-2" id="prevPage" disabled><i class="fas fa-chevron-left"></i></button>
            <div class="btn-group me-2" id="tabNavigation">
              <!-- Tabs will be generated here -->
            </div>
            <button class="btn btn-outline-primary" id="nextPage"><i class="fas fa-chevron-right"></i></button>
          </div>
        </div>

        <div class="tab-pane fade" id="driver-payments-content" role="tabpanel">
          <!-- Driver Salary Payments Section -->
          <form id="driverPaymentForm" class="form-section">
            <h4 class="mb-3">Add Driver Salary Payment</h4>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="vehicleSelect" class="form-label">Select Vehicle/Driver:</label>
                <select id="vehicleSelect" class="form-select" required>
                  <option value="">Loading vehicles...</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label for="paymentAmount" class="form-label">Amount:</label>
                <input type="number" id="paymentAmount" class="form-control" required step="0.01" />
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="paymentDate" class="form-label">Date:</label>
                <input type="date" id="paymentDate" class="form-control" required />
              </div>
              <div class="col-md-6 mb-3">
                <label for="paymentRemarks" class="form-label">Remarks:</label>
                <input type="text" id="paymentRemarks" class="form-control" />
              </div>
            </div>
            <button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i> Save Payment</button>
          </form>
          
          <div class="mb-3">
            <label for="driverPaymentSearchInput" class="form-label">Search Payments:</label>
            <input type="text" id="driverPaymentSearchInput" class="form-control" placeholder="Search by vehicle, driver, remarks...">
          </div>
          
          <div class="table-responsive">
            <table id="driverPaymentTable" class="table table-striped table-bordered" style="width:100%">
              <thead>
                <tr>
                  <th>Vehicle No.</th>
                  <th>Driver Name</th>
                  <th>Amount</th>
                  <th>Date</th>
                  <th>Remarks</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody id="driverPaymentTableBody"></tbody>
            </table>
          </div>
        </div>

        <div class="tab-pane fade" id="vehicle-work-content" role="tabpanel">
          <h4 class="mb-3">Vehicle Work Expenses</h4>
          
          <!-- Summary Cards -->
          <div class="row mb-4">
            <div class="col-md-3 mb-3">
              <div class="card summary-card bg-primary text-white">
                <div class="card-body text-center">
                  <h6 class="card-title">Total Vehicle Work</h6>
                  <h4 id="totalVehicleWork">₹0.00</h4>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card summary-card bg-success text-white">
                <div class="card-body text-center">
                  <h6 class="card-title">Completed Trips</h6>
                  <h4 id="completedTrips">0</h4>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card summary-card bg-info text-white">
                <div class="card-body text-center">
                  <h6 class="card-title">Pending Trips</h6>
                  <h4 id="pendingTrips">0</h4>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card summary-card bg-warning text-white">
                <div class="card-body text-center">
                  <h6 class="card-title">This Month</h6>
                  <h4 id="monthlyVehicleWork">₹0.00</h4>
                </div>
              </div>
            </div>
          </div>

          <!-- Filters -->
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="vehicleWorkFromDate" class="form-label">From Date</label>
              <input type="date" id="vehicleWorkFromDate" class="form-control">
            </div>
            <div class="col-md-4">
              <label for="vehicleWorkToDate" class="form-label">To Date</label>
              <input type="date" id="vehicleWorkToDate" class="form-control">
            </div>
            <div class="col-md-4">
              <label for="vehicleWorkActionFilter" class="form-label">Action Status</label>
              <select id="vehicleWorkActionFilter" class="form-select">
                <option value="">All</option>
                <option value="Pending">Pending</option>
                <option value="Completed">Completed</option>
              </select>
            </div>
          </div>

          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <button class="btn btn-primary me-2" onclick="applyVehicleWorkFilters()">
                <i class="fas fa-filter me-2"></i>Apply Filters
              </button>
              <button class="btn btn-outline-secondary" onclick="clearVehicleWorkFilters()">
                <i class="fas fa-times me-2"></i>Clear
              </button>
            </div>
            <button class="btn btn-success" onclick="exportVehicleWorkExcel()">
              <i class="fas fa-file-excel me-2"></i> Export Excel
            </button>
          </div>

          <div class="table-responsive">
            <table id="vehicleWorkTable" class="table table-striped table-bordered" style="width:100%">
              <thead>
                <tr>
                  <th>Vehicle No.</th>
                  <th>Date</th>
                  <th>LR No.</th>
                  <th>From Location</th>
                  <th>To Location</th>
                  <th class="text-end">Vehicle Work (₹)</th>
                  <th>Status</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody id="vehicleWorkTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Notification Container -->
  <div class="notification-container" id="notificationContainer"></div>

  <!-- LR Detail Modal (Copied from booking.html) -->
  <div class="modal fade lr-detail-modal" id="lrDetailModal" tabindex="-1" aria-labelledby="lrDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="lrDetailModalLabel">LR Report Details</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="lrDetailContent">
          <!-- LR details will be loaded here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- **NEW**: Add More Vehicles Modal -->
  <div class="modal fade" id="addVehiclesModal" tabindex="-1" aria-labelledby="addVehiclesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addVehiclesModalLabel">Add More Vehicle Slots</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>You can add more vehicle slots to your plan. The cost for each additional vehicle (<strong>₹14/vehicle</strong>) will be added to your next monthly bill.</p>
          
          <div class="mb-3">
            <label for="vehiclesToAdd" class="form-label">Number of additional vehicles to add:</label>
            <select id="vehiclesToAdd" class="form-select">
              <option value="5">5 Vehicles</option>
              <option value="10">10 Vehicles</option>
              <option value="20">20 Vehicles</option>
              <option value="50">50 Vehicles</option>
            </select>
          </div>
          <div class="text-center my-3">
            <h4>Additional Monthly Cost: <span id="addOnCost" class="text-primary fw-bold">₹70</span></h4>
          </div>
          <button id="confirmUpgradeBtn" class="btn btn-primary w-100">Confirm Upgrade</button>
          <p class="text-muted small mt-2 text-center">This change will be reflected in your next billing cycle.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase compat SDKs -->
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js"></script>

  <!-- XLSX for Excel export (used by download button) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- PDF.js for PDF text extraction -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
  
  <!-- Navbar loader -->
  <script src="navbar-loader.js"></script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getDatabase, ref, onValue, update, push, remove, get, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

     // Cloudinary Configuration
     const CLOUDINARY_CLOUD_NAME = 'doqapn15f';
     const CLOUDINARY_UPLOAD_PRESET = 'vehicle-driver';
     
     // Resize image before upload
     async function resizeImage(file, maxWidth, quality = 0.8) {
       return new Promise((resolve) => {
         const reader = new FileReader();
         reader.onload = (event) => {
           const img = new Image();
           img.onload = () => {
             const canvas = document.createElement('canvas');
             let width = img.width;
             let height = img.height;

             if (width > maxWidth) {
               height = Math.round((height * maxWidth) / width);
               width = maxWidth;
             }

             canvas.width = width;
             canvas.height = height;
             const ctx = canvas.getContext('2d');
             ctx.drawImage(img, 0, 0, width, height);
             
             // Convert to Blob with specified quality
             canvas.toBlob(
               (blob) => resolve(blob),
               'image/jpeg',
               quality
             );
           };
           img.src = event.target.result;
         };
         reader.readAsDataURL(file);
       });
     }
     
     // Upload to Cloudinary
     async function uploadToCloudinary(blob, fileName = 'document.jpg') {
       if (!CLOUDINARY_CLOUD_NAME || !CLOUDINARY_UPLOAD_PRESET) {
         throw new Error('Cloudinary configuration is missing');
       }
       
       const formData = new FormData();
       formData.append('file', blob, fileName);
       formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
       
       const response = await fetch(
         `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`,
         {
           method: 'POST',
           body: formData,
         }
       );
       
       if (!response.ok) {
         const error = await response.text();
         throw new Error(`Cloudinary upload failed: ${error}`);
       }
       
       const data = await response.json();
       return data.secure_url;
     }
     
     // Set up PDF.js worker
     pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.worker.min.js';
     
     // Initialize Firebase
     const firebaseConfig = {
        apiKey: "AIzaSyDAlk_K8p8Of8Ne6Jpcl2QqXTtm95NgG7o",
        authDomain: "transport-dashboard-ad69a.firebaseapp.com",
        databaseURL: "https://transport-dashboard-ad69a-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "transport-dashboard-ad69a",
        storageBucket: "transport-dashboard-ad69a.appspot.com",
        messagingSenderId: "526889676196",
        appId: "1:526889676196:web:66032c80a4aede690ae531",
        measurementId: "G-7F9R7HJYDH"
     };
     
     // Initialize Firebase
     const app = initializeApp(firebaseConfig);
     const auth = getAuth(app);
     const database = getDatabase(app);

     // Configuration
     const ITEMS_PER_PAGE_OPTIONS = [5, 10, 20, 50];
     let currentPage = 1;
     let itemsPerPage = 10;
     let totalPages = 1;
     let allVehiclesData = {};
     let filteredVehiclesData = {};
     let currentUser = null;
     let coreAccountId = null;
     let accountType = 'core';
     let branchType = 'main';
     let notifications = [];
     let isEditing = false;
     let editingKey = null;
     let currentVehicleData = {};
      let detailVehicleWorkTable; // For detail view
      let detailDriverPaymentsTable; // For detail view
     let driverPaymentTable;
     let vehicleWorkTable;
     let currentEditingDriverPaymentId = null;
     
     // **NEW**: Subscription variables
     let allClients = {}; // To fetch client details for LR modal
     let vehicleLimit = 50; // Default to 50 for initial check
     let currentVehicleCount = 0;

     // DOM elements
     const tableBody = document.getElementById("tableBody");
     const tabNavigation = document.getElementById("tabNavigation");
     const prevPageBtn = document.getElementById("prevPage");
     const nextPageBtn = document.getElementById("nextPage");
     const entriesPerPageSelect = document.getElementById("entriesPerPage");
     const entriesInfo = document.getElementById("entriesInfo");
     const searchInput = document.getElementById("searchInput");
     const typeFilter = document.getElementById("typeFilter");
     const notificationContainer = document.getElementById("notificationContainer");
     const branchInfo = document.getElementById("branchInfo");
     const branchInfoText = document.getElementById("branchInfoText");
     
     // Show branch information
     function showBranchInfo() {
       if (accountType === 'branch') {
         branchInfoText.innerHTML = `
           You are viewing shared data from <strong>${branchType}</strong> branch. 
           Your changes will sync across all branches in real-time.
           ${branchType === 'sub' ? '<span class="badge bg-warning branch-badge">SUB BRANCH</span>' : '<span class="badge bg-primary branch-badge">MAIN BRANCH</span>'}
         `;
         branchInfo.style.display = 'block';
       }
     }
     
     // Setup real-time listeners for multi-branch sync
     function setupRealtimeListeners() {
       // Listen for vehicle data changes from any branch
       const vehiclesRef = ref(database, `users/${coreAccountId}/vehicles`);
       onValue(vehiclesRef, (snapshot) => {
         allVehiclesData = snapshot.val() || {};
         renderTableWithPagination();
         checkVehicleLimit(); // **NEW**: Check limit whenever vehicle data changes
         
         // Show notification if data was updated by another branch/user
         if (snapshot.size > 0 && currentUser) {
           const vehicles = Object.values(allVehiclesData);
           const lastVehicle = vehicles[vehicles.length - 1];
           if (lastVehicle && lastVehicle.lastUpdatedBy !== currentUser.uid) {
             showSuccess(`Data updated by ${lastVehicle.lastUpdatedByName || 'another branch'}`);
           }
         }
       });

       // Listen for driver payment changes from any branch
       const paymentsRef = ref(database, `users/${coreAccountId}/driverSalaryPayments`);
       onValue(paymentsRef, (snapshot) => {
         if (driverPaymentTable) {
           driverPaymentTable.clear();
           if (snapshot.exists()) {
             snapshot.forEach(child => {
               const p = child.val();
               driverPaymentTable.row.add([
                 p.vehicleNumber || 'N/A',
                 p.driverName || 'N/A',
                 `₹${(p.amount || 0).toFixed(2)}`,
                 p.date,
                 p.remarks || '-',
                 `<button class="btn btn-sm btn-outline-secondary" onclick="editDriverPayment('${child.key}')"><i class="fas fa-edit"></i></button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteDriverPayment('${child.key}')"><i class="fas fa-trash"></i></button>`
               ]);
             });
           }
           driverPaymentTable.draw();
         }
       });

       // Listen for client data changes (needed for LR detail modal)
       const clientsRef = ref(database, `users/${coreAccountId}/clients`);
       onValue(clientsRef, (snapshot) => {
         allClients = {};
         if (snapshot.exists()) {
           snapshot.forEach(child => { allClients[child.key] = child.val(); });
         }
         console.log("Clients loaded for LR detail modal:", Object.keys(allClients).length);
       });
     }

     // **NEW**: Function to check and enforce vehicle limit
     function checkVehicleLimit() {
        if (!coreAccountId) return;

        const limitContainer = document.getElementById('limitReachedContainer');
        const limitMessage = document.getElementById('limitMessage');
        const saveBtn = document.getElementById('saveBtn');

        get(ref(database, `users/${coreAccountId}`)).then(snapshot => {
            const userData = snapshot.val();
            // **FIX**: Check both root subscription and profile subscription for robustness.
            const sub = userData?.subscription || userData?.profile?.subscription;

            if (sub) {
              vehicleLimit = sub.vehicleLimit || 0;
              currentVehicleCount = Object.keys(allVehiclesData).length;

              // -1 means unlimited
              if (vehicleLimit !== -1 && currentVehicleCount >= vehicleLimit) {
                  limitMessage.textContent = `You have reached your plan limit of ${vehicleLimit} vehicles.`;
                  limitContainer.style.display = 'block';
                  saveBtn.disabled = true;
              } else {
                  limitContainer.style.display = 'none';
                  saveBtn.disabled = false;
              }
            } else {
                // No subscription data, disable saving as a precaution
                limitMessage.textContent = 'Could not verify your subscription plan. Please contact support.';
                limitContainer.style.display = 'block';
                saveBtn.disabled = true;
            }
        });
     }
     
     // Initialize the tab interface
     function initTabInterface() {
       // Set up event listeners
       entriesPerPageSelect.addEventListener('change', function() {
         itemsPerPage = parseInt(this.value);
         currentPage = 1;
         renderTableWithPagination();
       });
       
       prevPageBtn.addEventListener('click', function() {
         if (currentPage > 1) {
           currentPage--;
           renderTableWithPagination();
         }
       });
       
       nextPageBtn.addEventListener('click', function() {
         if (currentPage < totalPages) {
           currentPage++;
           renderTableWithPagination();
         }
       });
       
       // Initial render
       renderTableWithPagination();
     }
     
     // Calculate pagination and render table
     function renderTableWithPagination() {
       // Get filtered data
       filterData();
       
       // Calculate pagination values
       const totalItems = Object.keys(filteredVehiclesData).length;
       totalPages = Math.ceil(totalItems / itemsPerPage);
       
       // Update pagination controls
       updatePaginationControls(totalItems);
       
       // Get current page data
       const startIndex = (currentPage - 1) * itemsPerPage;
       const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
       const pageData = Object.entries(filteredVehiclesData)
         .slice(startIndex, endIndex)
         .reduce((obj, [key, value]) => {
           obj[key] = value;
           return obj;
         }, {});
       
       // Render table with only the current page data
       renderTable(pageData);
     }
     
     // Filter data based on search and filter inputs
     function filterData() {
       const searchText = searchInput.value ? searchInput.value.toLowerCase() : '';
       const filterValue = typeFilter.value || '';
       
       filteredVehiclesData = Object.entries(allVehiclesData).reduce((result, [key, vehicle]) => {
         const vehicleNumber = vehicle.vehicleNumber ? vehicle.vehicleNumber.toLowerCase() : '';
         const vehicleType = vehicle.vehicleType || '';
         const driverName = vehicle.driverName ? vehicle.driverName.toLowerCase() : '';
         
         const matchesSearch = searchText === '' || 
           vehicleNumber.includes(searchText) || 
           driverName.includes(searchText);
           
         const matchesFilter = filterValue === '' || 
           vehicleType === filterValue;
         
         if (matchesSearch && matchesFilter) {
           result[key] = vehicle;
         }
         
         return result;
       }, {});
     }
     
     // Update pagination controls
     function updatePaginationControls(totalItems) {
       // Update prev/next buttons
       prevPageBtn.disabled = currentPage === 1;
       nextPageBtn.disabled = currentPage === totalPages;
       
       // Update entries info
       const startIndex = Math.min((currentPage - 1) * itemsPerPage + 1, totalItems);
       const endIndex = Math.min(currentPage * itemsPerPage, totalItems);
       entriesInfo.textContent = `Showing ${startIndex} to ${endIndex} of ${totalItems} entries`;
       
       // Generate page tabs
       generatePageTabs();
     }
     
     // Generate page tabs
     function generatePageTabs() {
       tabNavigation.innerHTML = '';
       
       // Always show first page tab
       addTab(1);
       
       // Calculate range of tabs to show
       let startPage = Math.max(2, currentPage - 2);
       let endPage = Math.min(totalPages - 1, currentPage + 2);
       
       // Add ellipsis if needed after first page
       if (startPage > 2) {
         addEllipsis();
       }
       
       // Add page tabs in calculated range
       for (let i = startPage; i <= endPage; i++) {
         addTab(i);
       }
       
       // Add ellipsis if needed before last page
       if (endPage < totalPages - 1) {
         addEllipsis();
       }
       
       // Always show last page tab if there is more than one page
       if (totalPages > 1) {
         addTab(totalPages);
       }
     }
     
     // Add a tab for a specific page
     function addTab(pageNumber) {
       const tab = document.createElement('button');
       tab.className = `btn btn-sm ${pageNumber === currentPage ? 'btn-primary' : 'btn-outline-primary'}`;
       tab.textContent = pageNumber;
       tab.addEventListener('click', () => {
         currentPage = pageNumber;
         renderTableWithPagination();
       });
       tabNavigation.appendChild(tab);
     }
     
     // Add ellipsis to tab navigation
     function addEllipsis() {
       const ellipsis = document.createElement('span');
       ellipsis.className = 'px-2';
       ellipsis.textContent = '...';
       tabNavigation.appendChild(ellipsis);
     }
     
     // Render the table with given data
     function renderTable(data) {
       tableBody.innerHTML = '';
       
       if (Object.keys(data).length === 0) {
         tableBody.innerHTML = `<tr><td colspan="10" class="text-center py-4 text-muted">No vehicle data found</td></tr>`;
         return;
       }
       
       Object.entries(data).forEach(([key, vehicle]) => {
         const row = document.createElement('tr');
         
         // Determine expiry status
         const pucStatus = getExpiryStatus(vehicle.pucExpiry);
         const insuranceStatus = getExpiryStatus(vehicle.insuranceExpiry);
         const fitnessStatus = getExpiryStatus(vehicle.fitnessExpiry);
         const licenseStatus = getExpiryStatus(vehicle.licenseExpiry);
         
         row.innerHTML = `
           <td>
             <strong>${vehicle.vehicleNumber || 'N/A'}</strong>
             ${vehicle.vehicleModel ? `<br><small class="text-muted">${vehicle.vehicleModel}</small>` : ''}
           </td>
           <td>${vehicle.vehicleType || '-'}</td>
           <td>${vehicle.driverName || '-'}</td>
           <td>
             ${vehicle.driverLicense || '-'}
             ${licenseStatus ? `<div class="expiry-status ${licenseStatus.class}">${licenseStatus.text}</div>` : ''}
           </td>
           <td>${vehicle.contactNumber || '-'}</td>
           <td>
             ${vehicle.licenseImageUrl ? 
               `<a href="${vehicle.licenseImageUrl}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fas fa-eye"></i> View</a>` : 
               '<span class="text-muted">No image</span>'}
           </td>
           <td>
             ${vehicle.pucFileUrl ? 
               `<a href="${vehicle.pucFileUrl}" target="_blank" class="btn btn-sm btn-outline-success"><i class="fas fa-eye"></i> View</a>` : 
               '<span class="text-muted">No file</span>'}
             ${pucStatus ? `<div class="expiry-status ${pucStatus.class}">${pucStatus.text}</div>` : ''}
           </td>
           <td>
             ${vehicle.insuranceFileUrl ? 
               `<a href="${vehicle.insuranceFileUrl}" target="_blank" class="btn btn-sm btn-outline-info"><i class="fas fa-eye"></i> View</a>` : 
               '<span class="text-muted">No file</span>'}
             ${insuranceStatus ? `<div class="expiry-status ${insuranceStatus.class}">${insuranceStatus.text}</div>` : ''}
           </td>
           <td>
             ${vehicle.fitnessFileUrl ? 
               `<a href="${vehicle.fitnessFileUrl}" target="_blank" class="btn btn-sm btn-outline-danger"><i class="fas fa-eye"></i> View</a>` : 
               '<span class="text-muted">No file</span>'}
             ${fitnessStatus ? `<div class="expiry-status ${fitnessStatus.class}">${fitnessStatus.text}</div>` : ''}
           </td>
           <td class="text-center">
             <div class="action-btns">
               <button class="btn btn-sm btn-outline-info" onclick="viewDetails('${key}')" title="View Details">
                 <i class="fas fa-eye"></i>
               </button>
               <button class="btn btn-sm btn-outline-warning" onclick="editEntry('${key}')" title="Edit">
                 <i class="fas fa-edit"></i>
               </button>
               <button class="btn btn-sm btn-outline-danger" onclick="deleteEntry('${key}')" title="Delete">
                 <i class="fas fa-trash"></i>
               </button>
             </div>
           </td>
         `;
         tableBody.appendChild(row);
       });
     }
     
     // Get expiry status for a date
     function getExpiryStatus(expiryDate) {
       if (!expiryDate) return null;
       
       const today = new Date();
       const expiry = new Date(expiryDate);
       const daysUntilExpiry = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
       
       if (daysUntilExpiry < 0) {
         return { class: 'expiry-expired', text: 'Expired' };
       } else if (daysUntilExpiry <= 30) {
         return { class: 'expiry-warning', text: `${daysUntilExpiry}d left` };
       } else {
         return { class: 'expiry-valid', text: 'Valid' };
       }
     }
     
     // View details in detail view
     async function viewDetails(key) {
       const vehicle = allVehiclesData[key];
       if (!vehicle) return;
       
       currentVehicleData = vehicle;
       
       // Populate detail view
       document.getElementById('detailVehicleNumber').textContent = vehicle.vehicleNumber || 'Vehicle Details';
       document.getElementById('detailVehicleModel').textContent = vehicle.vehicleModel || '-';
       document.getElementById('detailVehicleType').textContent = vehicle.vehicleType || '-';
       document.getElementById('detailDriverName').textContent = vehicle.driverName || '-';
       document.getElementById('detailDriverLicense').textContent = vehicle.driverLicense || '-';
       document.getElementById('detailContactNumber').textContent = vehicle.contactNumber || '-';
       
       // Document links
       document.getElementById('detailLicenseLink').innerHTML = vehicle.licenseImageUrl ? 
         `<a href="${vehicle.licenseImageUrl}" target="_blank" class="btn btn-sm btn-outline-primary">View</a>` : 
         '<span class="text-muted">No file</span>';
         
       document.getElementById('detailPucLink').innerHTML = vehicle.pucFileUrl ? 
         `<a href="${vehicle.pucFileUrl}" target="_blank" class="btn btn-sm btn-outline-success">View</a>` : 
         '<span class="text-muted">No file</span>';
         
       document.getElementById('detailInsuranceLink').innerHTML = vehicle.insuranceFileUrl ? 
         `<a href="${vehicle.insuranceFileUrl}" target="_blank" class="btn btn-sm btn-outline-info">View</a>` : 
         '<span class="text-muted">No file</span>';
         
       document.getElementById('detailFitnessLink').innerHTML = vehicle.fitnessFileUrl ? 
         `<a href="${vehicle.fitnessFileUrl}" target="_blank" class="btn btn-sm btn-outline-danger">View</a>` : 
         '<span class="text-muted">No file</span>';
       
       // Show detail view, hide main view
       document.getElementById('vehicleDetailView').classList.remove('hidden');
       document.getElementById('mainView').classList.add('hidden');

       // --- NEW: Populate vehicle-specific tables ---

       // Initialize DataTables if they don't exist
       if (!detailVehicleWorkTable) {
           detailVehicleWorkTable = $('#detailVehicleWorkTable').DataTable({ "pageLength": 5, "searching": false, "info": false, "lengthChange": false, "order": [[0, "desc"]] });
       }
       if (!detailDriverPaymentsTable) {
           detailDriverPaymentsTable = $('#detailDriverPaymentsTable').DataTable({ "pageLength": 5, "searching": false, "info": false, "lengthChange": false, "order": [[0, "desc"]] });
       }

       // Clear previous data
       detailVehicleWorkTable.clear();
       detailDriverPaymentsTable.clear();

       // 1. Load Vehicle Work data for this vehicle
       const { getDatabase, ref, query, orderByChild, equalTo, get } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js");
       const lrQuery = query(ref(database, `users/${coreAccountId}/lrReports`), orderByChild('truckNumber'), equalTo(vehicle.vehicleNumber));
        get(lrQuery).then(snapshot => {
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    const lr = child.val();
                    
                    // **FIX**: Check for vehicle work on the main trip.
                    if (parseFloat(lr.vehicleWork) > 0) {
                        detailVehicleWorkTable.row.add([
                            lr.date || '-',
                            `${lr.lrNumber || '-'} <a href="#" onclick="event.preventDefault(); viewLRDetails('${child.key}')" class="ms-2 text-primary" title="View LR Details"><i class="fas fa-eye"></i></a>`,
                            lr.fromLocation || '-',
                            lr.toLocation || '-',
                            `₹${(parseFloat(lr.vehicleWork) || 0).toFixed(2)}`
                        ]);
                    }

                    // **FIX**: Check for vehicle work on the empty return trip.
                    if (lr.emptyTripData && parseFloat(lr.emptyTripData.vehicleWork) > 0) {
                        detailVehicleWorkTable.row.add([
                            lr.date || '-',
                            `${lr.lrNumber || '-'} (Return) <a href="#" onclick="event.preventDefault(); viewLRDetails('${child.key}')" class="ms-2 text-primary" title="View LR Details"><i class="fas fa-eye"></i></a>`, // Indicate it's a return trip
                            lr.toLocation || '-', // For return, 'from' is the original 'to'
                            lr.fromLocation || '-', // For return, 'to' is the original 'from'
                            `₹${(parseFloat(lr.emptyTripData.vehicleWork) || 0).toFixed(2)}`
                        ]);
                    }
                });
            }
            detailVehicleWorkTable.draw();
        });

       // 2. Load Driver Payments for this vehicle
       const paymentQuery = query(ref(database, `users/${coreAccountId}/driverSalaryPayments`), orderByChild('vehicleNumber'), equalTo(vehicle.vehicleNumber));
        get(paymentQuery).then(snapshot => {
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    const p = child.val();
                    detailDriverPaymentsTable.row.add([p.date, `₹${(p.amount || 0).toFixed(2)}`, p.remarks || '-']);
                });
            }
            detailDriverPaymentsTable.draw();
        });
     }
     
     // Hide detail view
     function hideDetailView() {
       document.getElementById('vehicleDetailView').classList.add('hidden');
       document.getElementById('mainView').classList.remove('hidden');
     }
     
     // Edit entry
     function editEntry(key) {
       const vehicle = allVehiclesData[key];
       if (!vehicle) return;
       
       isEditing = true;
       editingKey = key;
       
       // Populate form with existing data
       document.getElementById('vehicleNumber').value = vehicle.vehicleNumber || '';
       document.getElementById('vehicleType').value = vehicle.vehicleType || '';
       document.getElementById('driverName').value = vehicle.driverName || '';
       document.getElementById('driverLicense').value = vehicle.driverLicense || '';
       document.getElementById('contactNumber').value = vehicle.contactNumber || '';
       
       // --- NEW: Populate expiry date fields on edit ---
       document.getElementById('licenseExpiryDate').value = vehicle.licenseExpiry || '';
       document.getElementById('pucExpiryDate').value = vehicle.pucExpiry || '';
       document.getElementById('insuranceExpiryDate').value = vehicle.insuranceExpiry || '';
       document.getElementById('fitnessExpiryDate').value = vehicle.fitnessExpiry || '';
       
       // --- FIX: Show existing images and file info on edit ---
       const licensePreview = document.getElementById('licensePreview');
       if (vehicle.licenseImageUrl) {
         licensePreview.src = vehicle.licenseImageUrl;
         licensePreview.style.display = 'block';
         document.getElementById('licenseFileInfo').textContent = 'An image is already uploaded. Choose a new file to replace it.';
       }
       const pucPreview = document.getElementById('pucPreview');
       if (vehicle.pucFileUrl) {
         if (vehicle.pucFileUrl.match(/\.(jpeg|jpg|gif|png|webp)$/i)) {
            pucPreview.src = vehicle.pucFileUrl;
            pucPreview.style.display = 'block';
         }
         document.getElementById('pucFileInfo').textContent = 'A file is already uploaded. Choose a new file to replace it.';
       }
       const insurancePreview = document.getElementById('insurancePreview');
       if (vehicle.insuranceFileUrl) {
         if (vehicle.insuranceFileUrl.match(/\.(jpeg|jpg|gif|png|webp)$/i)) {
            insurancePreview.src = vehicle.insuranceFileUrl;
            insurancePreview.style.display = 'block';
         }
         document.getElementById('insuranceFileInfo').textContent = 'A file is already uploaded. Choose a new file to replace it.';
       }
       const fitnessPreview = document.getElementById('fitnessPreview');
       if (vehicle.fitnessFileUrl) {
         if (vehicle.fitnessFileUrl.match(/\.(jpeg|jpg|gif|png|webp)$/i)) {
            fitnessPreview.src = vehicle.fitnessFileUrl;
            fitnessPreview.style.display = 'block';
         }
         document.getElementById('fitnessFileInfo').textContent = 'A file is already uploaded. Choose a new file to replace it.';
       }

       // Show cancel button
       document.getElementById('cancelEdit').style.display = 'inline-block';
       document.getElementById('saveBtn').innerHTML = '<i class="fas fa-save me-2"></i> Update Entry';
       
       // Scroll to form
       document.getElementById('vehicleDriverForm').scrollIntoView({ behavior: 'smooth' });
     }
     
     // Cancel edit
     function cancelEdit() {
       isEditing = false;
       editingKey = null;
       
       // Reset form
       document.getElementById('vehicleDriverForm').reset();
       document.getElementById('cancelEdit').style.display = 'none';
       document.getElementById('saveBtn').innerHTML = '<i class="fas fa-save me-2"></i> Save Entry';
       
       // --- NEW: Clear expiry date fields on cancel ---
       document.getElementById('licenseExpiryDate').value = '';
       document.getElementById('pucExpiryDate').value = '';
       document.getElementById('insuranceExpiryDate').value = '';
       document.getElementById('fitnessExpiryDate').value = '';

       // Clear previews and file info
       const preview = document.getElementById('licensePreview');
       preview.style.display = 'none';
       preview.src = '';
       document.getElementById('pucPreview').style.display = 'none';
       document.getElementById('pucPreview').src = '';
       document.getElementById('insurancePreview').style.display = 'none';
       document.getElementById('insurancePreview').src = '';
       document.getElementById('fitnessPreview').style.display = 'none';
       document.getElementById('fitnessPreview').src = '';
       document.getElementById('licenseFileInfo').textContent = '';
       document.getElementById('pucFileInfo').textContent = '';
       document.getElementById('insuranceFileInfo').textContent = '';
       document.getElementById('fitnessFileInfo').textContent = '';
     }
     
     // Delete entry
     function deleteEntry(key) {
       if (confirm('Are you sure you want to delete this vehicle entry?')) {
         remove(ref(database, `users/${coreAccountId}/vehicles/${key}`))
           .then(() => {
             showSuccess('Vehicle entry deleted successfully');
           })
           .catch((error) => {
             showError('Error deleting vehicle entry: ' + error.message);
           });
       }
     }
     
     // Download Excel
     function downloadExcel() {
       try {
         // Prepare data for Excel
         const excelData = Object.values(allVehiclesData).map(vehicle => ({
           'Vehicle Number': vehicle.vehicleNumber || '',
           'Vehicle Type': vehicle.vehicleType || '',
           'Driver Name': vehicle.driverName || '',
           'Driver License': vehicle.driverLicense || '',
           'Contact Number': vehicle.contactNumber || '',
           'License Expiry': vehicle.licenseExpiry || '',
           'PUC Expiry': vehicle.pucExpiry || '',
           'Insurance Expiry': vehicle.insuranceExpiry || '',
           'Fitness Expiry': vehicle.fitnessExpiry || '',
           'Last Updated': vehicle.lastUpdated || ''
         }));
         
         // Create worksheet and workbook
         const ws = XLSX.utils.json_to_sheet(excelData);
         const wb = XLSX.utils.book_new();
         XLSX.utils.book_append_sheet(wb, ws, 'Vehicles');
         
         // Generate Excel file and download
         const fileName = `vehicle_data_${new Date().toISOString().split('T')[0]}.xlsx`;
         XLSX.writeFile(wb, fileName);
         
         showSuccess('Excel file downloaded successfully');
       } catch (error) {
         showError('Error downloading Excel file: ' + error.message);
       }
     }
     
     // Show success message
     function showSuccess(message) {
       const successMessage = document.getElementById('successMessage');
       const successText = document.getElementById('successText');
       successText.textContent = message;
       successMessage.style.display = 'block';
       
       // Auto hide after 5 seconds
       setTimeout(() => {
         successMessage.style.display = 'none';
       }, 5000);
     }
     
     // Show error message
     function showError(message) {
       const errorMessage = document.getElementById('errorMessage');
       const errorText = document.getElementById('errorText');
       errorText.textContent = message;
       errorMessage.style.display = 'block';
     }
     
     // Initialize the application
     function initApp() {
       onAuthStateChanged(auth, (user) => {
         if (user) {
           currentUser = user;
           
           // Get user account info
           get(ref(database, 'users/' + user.uid)).then((snapshot) => {
             const userData = snapshot.val();
             if (userData) {
               accountType = userData.accountType || 'core';
               coreAccountId = userData.coreAccountId || user.uid;
               branchType = userData.branchType || 'main';
               
               showBranchInfo();
               setupRealtimeListeners();
               checkVehicleLimit();
               initTabInterface();
               loadDriverPayments();
               loadVehicleWork();
               populateVehicleSelect();
             }
           });
         } else {
           // Redirect to login if not authenticated
           window.location.href = 'login.html';
         }
       });
     }
     
     // Initialize when DOM is loaded
     document.addEventListener('DOMContentLoaded', function() {
       initApp();
       
       // Set up form submission
       document.getElementById('vehicleDriverForm').addEventListener('submit', handleFormSubmit);
       document.getElementById('cancelEdit').addEventListener('click', cancelEdit);
       
       // Set up search and filter events
       searchInput.addEventListener('input', debounce(renderTableWithPagination, 300));
       typeFilter.addEventListener('change', renderTableWithPagination);
       
       // Set up file preview for license image
       document.getElementById('licenseImage').addEventListener('change', function(e) {
         const file = e.target.files[0];
         const preview = document.getElementById('licensePreview');
         const fileInfo = document.getElementById('licenseFileInfo');
         
         if (file) {
           fileInfo.textContent = `Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
           const reader = new FileReader();
           reader.onload = function(e) {
             preview.src = e.target.result;
             preview.style.display = 'block';
           };
           reader.readAsDataURL(file);
         } else {
           preview.style.display = 'none';
           fileInfo.textContent = '';
         }
       });
       
       // Set up file info display for other files
       setupFileInfo('pucFile', 'pucFileInfo', 'pucPreview');
       setupFileInfo('insuranceFile', 'insuranceFileInfo', 'insurancePreview');
       setupFileInfo('fitnessFile', 'fitnessFileInfo', 'fitnessPreview');

       // **NEW**: Set up "Add More Vehicles" modal logic
       setupAddVehiclesModal();
     });
     
     // Set up file info display
     function setupFileInfo(fileInputId, fileInfoId, previewId) {
       document.getElementById(fileInputId).addEventListener('change', function(e) {
         const file = e.target.files[0];
         const fileInfo = document.getElementById(fileInfoId);
         
         if (file) {
           fileInfo.textContent = `Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
         } else {
           fileInfo.textContent = '';
         }

         // Handle image preview
         const preview = document.getElementById(previewId);
         if (preview && file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => { preview.src = e.target.result; preview.style.display = 'block'; };
            reader.readAsDataURL(file);
         } else if (preview) {
            preview.style.display = 'none';
         }
       });
     }
     
     // Debounce function for search
     function debounce(func, wait) {
       let timeout;
       return function executedFunction(...args) {
         const later = () => {
           clearTimeout(timeout);
           func(...args);
         };
         clearTimeout(timeout);
         timeout = setTimeout(later, wait);
       };
     }
     
     // Handle form submission
     async function handleFormSubmit(e) {
       e.preventDefault();
       
       const saveBtn = document.getElementById('saveBtn');
       const originalText = saveBtn.innerHTML;
       
       try {
         // Show loading state
         saveBtn.disabled = true;
         saveBtn.innerHTML = '<span class="loading"></span> Processing...';
         
         // **NEW**: Final check before saving a new vehicle
         if (!isEditing) {
            if (vehicleLimit !== -1 && currentVehicleCount >= vehicleLimit) {
                throw new Error("Vehicle limit reached. Please upgrade your plan to add more vehicles.");
            }
         }

         // **FIX**: Duplicate Vehicle Number Validation for both create and update.
         const newVehicleNumber = document.getElementById('vehicleNumber').value.trim().toLowerCase();
         const isDuplicate = Object.entries(allVehiclesData).some(
           ([key, vehicle]) => 
             vehicle.vehicleNumber && 
             vehicle.vehicleNumber.toLowerCase() === newVehicleNumber && 
             key !== editingKey // Exclude the current vehicle being edited from the check
         );
         if (isDuplicate) {
           throw new Error(`A vehicle with the number "${document.getElementById('vehicleNumber').value.trim()}" already exists.`);
         }

         // Get form values
         const formData = {
           vehicleNumber: document.getElementById('vehicleNumber').value.trim(),
           vehicleType: document.getElementById('vehicleType').value.trim(),
           driverName: document.getElementById('driverName').value.trim(),
           driverLicense: document.getElementById('driverLicense').value.trim(),
           contactNumber: document.getElementById('contactNumber').value.trim(),
           lastUpdated: new Date().toISOString(),
           lastUpdatedBy: currentUser.uid,
           lastUpdatedByName: currentUser.displayName || currentUser.email
         };

         // --- NEW: Get expiry dates directly from the new input fields ---
         formData.licenseExpiry = document.getElementById('licenseExpiryDate').value || null;
         formData.pucExpiry = document.getElementById('pucExpiryDate').value || null;
         formData.insuranceExpiry = document.getElementById('insuranceExpiryDate').value || null;
         formData.fitnessExpiry = document.getElementById('fitnessExpiryDate').value || null;
         
         // Validate required fields
         if (!formData.vehicleNumber) {
           throw new Error('Vehicle number is required');
         }
         
         // Upload files if selected
         const uploadPromises = [];
         
         // License Image
         const licenseFile = document.getElementById('licenseImage').files[0];
         if (licenseFile) {
           uploadPromises.push(
             uploadFileWithProgress(licenseFile, 'licenseImageUrl', 'licenseProgress', 'license')
           );
         }
         
         // PUC File
         const pucFile = document.getElementById('pucFile').files[0];
         if (pucFile) {
           uploadPromises.push(
             uploadFileWithProgress(pucFile, 'pucFileUrl', 'pucProgress', 'puc')
           );
         }
         
         // Insurance File
         const insuranceFile = document.getElementById('insuranceFile').files[0];
         if (insuranceFile) {
           uploadPromises.push(
             uploadFileWithProgress(insuranceFile, 'insuranceFileUrl', 'insuranceProgress', 'insurance')
           );
         }
         
         // Fitness File
         const fitnessFile = document.getElementById('fitnessFile').files[0];
         if (fitnessFile) {
           uploadPromises.push(
             uploadFileWithProgress(fitnessFile, 'fitnessFileUrl', 'fitnessProgress', 'fitness')
           );
         }
         
         // Wait for all uploads to complete
         if (uploadPromises.length > 0) {
           const uploadResults = await Promise.all(uploadPromises);
           uploadResults.forEach(result => {
             formData[result.field] = result.url;
           });
         }
         
         // Save to database
         let savePromise;
         if (isEditing && editingKey) {
           // Update existing entry
           savePromise = update(ref(database, `users/${coreAccountId}/vehicles/${editingKey}`), formData);
         } else {
           // Create new entry
           savePromise = push(ref(database, `users/${coreAccountId}/vehicles`), formData);
         }
         
         await savePromise;
         
         // Reset form and show success
         cancelEdit();
         document.getElementById('vehicleDriverForm').reset();
         showSuccess(isEditing ? 'Vehicle entry updated successfully' : 'Vehicle entry saved successfully');
         
         // Clear file previews and info
         document.getElementById('licensePreview').style.display = 'none';
         document.getElementById('licenseFileInfo').textContent = '';
         document.getElementById('pucFileInfo').textContent = '';
         document.getElementById('insuranceFileInfo').textContent = '';
         document.getElementById('fitnessFileInfo').textContent = '';
         
       } catch (error) {
         console.error('Error saving vehicle entry:', error);
         showError('Error saving vehicle entry: ' + error.message);
       } finally {
         // Restore button state
         saveBtn.disabled = false;
         saveBtn.innerHTML = originalText;
       }
     }
     
     // Upload file with progress tracking
     async function uploadFileWithProgress(file, fieldName, progressElementId, fileType) {
       const progressElement = document.getElementById(progressElementId);
       
       try {
         // Update progress
         progressElement.innerHTML = `Uploading ${fileType}...`;
         
         let blobToUpload = file;
         
         // Resize images (except PDFs)
         if (file.type.startsWith('image/') && file.type !== 'image/svg+xml') {
           blobToUpload = await resizeImage(file, 1024, 0.8);
           progressElement.innerHTML = `Processing ${fileType} image...`;
         }
         
         // Upload to Cloudinary
         const url = await uploadToCloudinary(blobToUpload, file.name);
         
         progressElement.innerHTML = `${fileType} uploaded successfully!`;
         
         return { field: fieldName, url }; // Return only the URL, as date is handled manually
         
       } catch (error) {
         progressElement.innerHTML = `Error uploading ${fileType}: ${error.message}`;
         throw error;
       }
     }
     
     // Extract expiry date from PDF
     async function extractExpiryFromPDF(file) {
       return new Promise((resolve, reject) => {
         const fileReader = new FileReader();
         
         fileReader.onload = async function() {
           try {
             const typedarray = new Uint8Array(this.result);
             const pdf = await pdfjsLib.getDocument(typedarray).promise;
             let fullText = '';
             
             // Extract text from all pages
             for (let i = 1; i <= pdf.numPages; i++) {
               const page = await pdf.getPage(i);
               const textContent = await page.getTextContent();
               const pageText = textContent.items.map(item => item.str).join(' ');
               fullText += pageText + ' ';
             }
             
             // --- DEBUGGING: Print extracted text to the console ---
             console.log("--- OCR Text Extraction ---");
             console.log("Full text extracted from PDF:", fullText);
             // ----------------------------------------------------

             // Look for date patterns (simple implementation)
             const datePatterns = [
               /\b(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})\b/g,
               /\b(\d{2,4}[\/\-]\d{1,2}[\/\-]\d{1,2})\b/g,
               /\b(\d{1,2}\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\s+\d{2,4})\b/gi
             ];
             
             let foundDate = null;
             for (const pattern of datePatterns) {
               const matches = fullText.match(pattern);
               if (matches && matches.length > 0) {
                 // Use the last date found (often the expiry date is towards the end)
                 foundDate = matches[matches.length - 1];
                 break;
               }
             }
             
             // --- DEBUGGING: Print found date to the console ---
             console.log("Expiry date found:", foundDate || "None");
             console.log("---------------------------");
             // --------------------------------------------------

             resolve(foundDate);
           } catch (error) {
             reject(error);
           }
         };
         
         fileReader.onerror = reject;
         fileReader.readAsArrayBuffer(file);
       });
     }
     
     // **NEW**: Logic for the "Add More Vehicles" modal
     function setupAddVehiclesModal() {
        const addVehiclesModal = new bootstrap.Modal(document.getElementById('addVehiclesModal'));
        const addMoreBtn = document.getElementById('addMoreVehiclesBtn');
        const vehiclesToAddSelect = document.getElementById('vehiclesToAdd');
        const addOnCostEl = document.getElementById('addOnCost');
        const confirmUpgradeBtn = document.getElementById('confirmUpgradeBtn');

        addMoreBtn.addEventListener('click', () => {
            // Reset modal state
            calculateAddOnCost();
            addVehiclesModal.show();
        });

        vehiclesToAddSelect.addEventListener('change', calculateAddOnCost);

        function calculateAddOnCost() {
            const vehicles = parseInt(vehiclesToAddSelect.value, 10);
            const cost = vehicles * 14; // Your pricing: ₹14 per vehicle
            addOnCostEl.textContent = `₹${cost}`;
        }

        confirmUpgradeBtn.addEventListener('click', async () => {
            const vehiclesToAdd = parseInt(vehiclesToAddSelect.value, 10);
            const additionalCost = vehiclesToAdd * 14;

            try {
                confirmUpgradeBtn.disabled = true;
                confirmUpgradeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Upgrading...';

                const subRef = ref(database, `users/${coreAccountId}/subscription`);
                const snapshot = await get(subRef);
                if (!snapshot.exists()) {
                    throw new Error("Subscription data not found.");
                }

                const sub = snapshot.val();
                const currentLimit = sub.vehicleLimit || 0;
                const currentRate = sub.monthlyRate || 0;

                const newLimit = (currentLimit === -1) ? -1 : currentLimit + vehiclesToAdd;
                const newRate = currentRate + additionalCost;

                await update(subRef, {
                    vehicleLimit: newLimit,
                    monthlyRate: newRate
                });

                showSuccess('Plan upgraded successfully! Your vehicle limit has been increased.');
                addVehiclesModal.hide();
                checkVehicleLimit(); // Re-check limit to update UI

            } catch (error) {
                showError("Could not upgrade plan. " + error.message);
            } finally {
                confirmUpgradeBtn.disabled = false;
                confirmUpgradeBtn.innerHTML = 'Confirm Upgrade';
            }
        });
     }

     // Driver Payment Functions
     function loadDriverPayments() {
       driverPaymentTable = $('#driverPaymentTable').DataTable({
         searching: true,
         paging: true,
         info: true,
         autoWidth: false,
         order: [[3, 'desc']] // Sort by date descending
       });
       
       // Setup search for driver payments
       $('#driverPaymentSearchInput').on('keyup', function() {
         driverPaymentTable.search(this.value).draw();
       });
     }
     
     function populateVehicleSelect() {
       const vehicleSelect = document.getElementById('vehicleSelect');
       vehicleSelect.innerHTML = '<option value="">Loading vehicles...</option>';
       
       get(ref(database, `users/${coreAccountId}/vehicles`)).then((snapshot) => {
         if (snapshot.exists()) {
           vehicleSelect.innerHTML = '<option value="">Select Vehicle/Driver</option>';
           snapshot.forEach(child => {
             const vehicle = child.val();
             const option = document.createElement('option');
             option.value = child.key;
             option.textContent = `${vehicle.vehicleNumber} - ${vehicle.driverName || 'No Driver'}`;
             option.setAttribute('data-vehicle-number', vehicle.vehicleNumber);
             option.setAttribute('data-driver-name', vehicle.driverName || '');
             vehicleSelect.appendChild(option);
           });
         } else {
           vehicleSelect.innerHTML = '<option value="">No vehicles found</option>';
         }
       });
     }
     
     document.getElementById('driverPaymentForm').addEventListener('submit', function(e) {
       e.preventDefault();
       
       const vehicleSelect = document.getElementById('vehicleSelect');
       const selectedOption = vehicleSelect.options[vehicleSelect.selectedIndex];
       const vehicleNumber = selectedOption.getAttribute('data-vehicle-number');
       const driverName = selectedOption.getAttribute('data-driver-name');
       const amount = parseFloat(document.getElementById('paymentAmount').value);
       const date = document.getElementById('paymentDate').value;
       const remarks = document.getElementById('paymentRemarks').value;
       
       if (!vehicleSelect.value || !amount || !date) {
         showError('Please fill all required fields');
         return;
       }
       
       const paymentData = {
         vehicleNumber,
         driverName,
         amount,
         date,
         remarks,
         timestamp: new Date().toISOString(),
         addedBy: currentUser.uid,
         addedByName: currentUser.displayName || currentUser.email
       };
       
       let savePromise;
       if (currentEditingDriverPaymentId) {
         savePromise = update(ref(database, `users/${coreAccountId}/driverSalaryPayments/${currentEditingDriverPaymentId}`), paymentData);
       } else {
         savePromise = push(ref(database, `users/${coreAccountId}/driverSalaryPayments`), paymentData);
       }
       
       savePromise
         .then(() => {
           showSuccess(currentEditingDriverPaymentId ? 'Payment updated successfully' : 'Payment saved successfully');
           this.reset();
           document.getElementById('paymentDate').valueAsDate = new Date();
           currentEditingDriverPaymentId = null;
         })
         .catch(error => {
           showError('Error saving payment: ' + error.message);
         });
     });
     
     function editDriverPayment(paymentId) {
       get(ref(database, `users/${coreAccountId}/driverSalaryPayments/${paymentId}`)).then(snapshot => {
         const payment = snapshot.val();
         if (payment) {
           currentEditingDriverPaymentId = paymentId;
           
           // Find the vehicle option that matches
           const vehicleSelect = document.getElementById('vehicleSelect');
           for (let i = 0; i < vehicleSelect.options.length; i++) {
             const option = vehicleSelect.options[i];
             if (option.getAttribute('data-vehicle-number') === payment.vehicleNumber && 
                 option.getAttribute('data-driver-name') === payment.driverName) {
               vehicleSelect.selectedIndex = i;
               break;
             }
           }
           
           document.getElementById('paymentAmount').value = payment.amount;
           document.getElementById('paymentDate').value = payment.date;
           document.getElementById('paymentRemarks').value = payment.remarks || '';
           
           // Scroll to form
           document.getElementById('driverPaymentForm').scrollIntoView({ behavior: 'smooth' });
         }
       });
     }
     
     function deleteDriverPayment(paymentId) {
       if (confirm('Are you sure you want to delete this payment record?')) {
         remove(ref(database, `users/${coreAccountId}/driverSalaryPayments/${paymentId}`))
           .then(() => {
             showSuccess('Payment record deleted successfully');
           })
           .catch(error => {
             showError('Error deleting payment record: ' + error.message);
           });
       }
     }
     
     // =============================================
     // VEHICLE WORK FUNCTIONS - UPDATED & FIXED
     // =============================================
     
     function loadVehicleWork() {
       vehicleWorkTable = $('#vehicleWorkTable').DataTable({
         searching: true,
         paging: true,
         info: true,
         autoWidth: false,
         order: [[1, 'desc']], // Sort by date descending
         columns: [
           { data: 'vehicleNumber' },
           { data: 'date' },
           {
             data: 'lrNumber',
             render: function(data, type, row) { return `${data} <a href="#" onclick="event.preventDefault(); viewLRDetails('${row.id}')" class="ms-2 text-primary" title="View LR Details"><i class="fas fa-eye"></i></a>`; }
           },
           { data: 'fromLocation' },
           { data: 'toLocation' },
           { 
             data: 'vehicleWork',
             className: 'text-end',
             render: function(data) {
               return `₹${(parseFloat(data) || 0).toFixed(2)}`;
             }
           },
           { 
             data: 'status',
             render: function(data) {
               const statusClass = data === 'Completed' ? 'badge bg-success' : 
                                 data === 'Invoiced' ? 'badge bg-info' : 'badge bg-warning';
               return `<span class="${statusClass}">${data || 'Active'}</span>`;
             }
           },
           { // **FIX**: Added the missing payment status toggle button to the Actions column
             data: null,
             className: 'text-center',
             render: function(data, type, row) {
               // **FIX**: Use a Bootstrap switch toggle for a better UX.
               const isCompleted = row.paymentStatus === 'Completed';
               const statusText = isCompleted ? 'Completed' : 'Pending';
               const statusClass = isCompleted ? 'payment-status-completed' : 'payment-status-pending';

               return `
                 <div class="form-check form-switch d-flex flex-column align-items-center justify-content-center">
                   <input 
                     class="form-check-input" 
                     type="checkbox" 
                     role="switch" 
                     ${row.paymentStatus === 'Completed' ? 'checked' : ''}
                     onclick="togglePaymentStatus('${row.id}', '${row.paymentStatus || 'Pending'}', '${row.lrNumber.includes('(Empty Return)') ? 'empty' : 'main'}')">
                   <label class="form-check-label payment-status-label ${statusClass}">${statusText}</label>
                 </div>`;
             }
           }
         ]
       });
       
       // Load vehicle work data from LR reports
       loadVehicleWorkData();
     }

     // Load vehicle work data from LR reports
     function loadVehicleWorkData() {
       const vehicleWorkRef = ref(database, `users/${coreAccountId}/lrReports`);
       onValue(vehicleWorkRef, (snapshot) => {
         const vehicleWorkData = [];
         let totalVehicleWork = 0;
         let completedTrips = 0;
         let pendingTrips = 0;
         let monthlyTotal = 0;
         
         const currentMonth = new Date().getMonth();
         const currentYear = new Date().getFullYear();
         
         if (snapshot.exists()) {
           snapshot.forEach(child => {
             const lr = child.val();
             const lrId = child.key;
             
             // Only include entries that have vehicle work expense
             if (lr && parseFloat(lr.vehicleWork) > 0) {
               const vehicleWorkAmount = parseFloat(lr.vehicleWork) || 0;
               totalVehicleWork += vehicleWorkAmount;
               
               // Count by status
               if (lr.status === 'Completed' || lr.status === 'Invoiced') {
                 completedTrips++;
               } else {
                 pendingTrips++;
               }
               
               // Calculate monthly total
               if (lr.date) {
                 const lrDate = new Date(lr.date);
                 if (lrDate.getMonth() === currentMonth && lrDate.getFullYear() === currentYear) {
                   monthlyTotal += vehicleWorkAmount;
                 }
               }
               
               vehicleWorkData.push({
                 id: lrId,
                 vehicleNumber: lr.truckNumber || 'N/A',
                 date: lr.date || '-', // Keep date as plain text
                 lrNumber: lr.lrNumber || '-',
                 fromLocation: lr.fromLocation || '-',
                 toLocation: lr.toLocation || '-',
                 vehicleWork: vehicleWorkAmount,
                 status: lr.status || 'Active',
                 paymentStatus: lr.paymentStatus || 'Pending' // **FIX**: Pass the correct payment status
               });
             }
             
             // Also include empty trip vehicle work if exists
             if (lr.emptyTripData && parseFloat(lr.emptyTripData.vehicleWork) > 0) {
               const emptyTripWorkAmount = parseFloat(lr.emptyTripData.vehicleWork) || 0;
               totalVehicleWork += emptyTripWorkAmount;
               
               // For empty trips, count as completed if main trip is completed
               if (lr.status === 'Completed' || lr.status === 'Invoiced') {
                 completedTrips++;
               } else {
                 pendingTrips++;
               }
               
               // Calculate monthly total for empty trips
               if (lr.date) {
                 const lrDate = new Date(lr.date);
                 if (lrDate.getMonth() === currentMonth && lrDate.getFullYear() === currentYear) {
                   monthlyTotal += emptyTripWorkAmount;
                 }
               }
               
               vehicleWorkData.push({
                 id: lrId,
                 vehicleNumber: lr.truckNumber || 'N/A',
                 date: lr.date || '-', // Keep date as plain text
                 lrNumber: `${lr.lrNumber || '-'} (Empty Return)`,
                 fromLocation: lr.toLocation || '-', // Return trip: from becomes the original destination
                 toLocation: lr.fromLocation || '-', // Return trip: to becomes the original source
                 vehicleWork: emptyTripWorkAmount,
                 status: lr.status || 'Active',
                 // **FIX**: Pass the correct payment status for the empty trip
                 paymentStatus: lr.emptyTripData.paymentStatus || 'Pending'
               });
             }
           });
         }
         
         // Update summary cards
         updateVehicleWorkSummary(totalVehicleWork, completedTrips, pendingTrips, monthlyTotal);
         
         // Update DataTable
         if (vehicleWorkTable) {
           vehicleWorkTable.clear();
           if (vehicleWorkData.length > 0) {
             vehicleWorkTable.rows.add(vehicleWorkData);
           }
           vehicleWorkTable.draw();
         }
         
         // Update vehicle filter dropdown
         updateVehicleWorkVehicleFilter(vehicleWorkData);
       });
     }

     // Update vehicle work summary cards
     function updateVehicleWorkSummary(total, completed, pending, monthly) {
       document.getElementById('totalVehicleWork').textContent = `₹${total.toFixed(2)}`;
       document.getElementById('completedTrips').textContent = completed;
       document.getElementById('pendingTrips').textContent = pending;
       document.getElementById('monthlyVehicleWork').textContent = `₹${monthly.toFixed(2)}`;
     }

     // Update vehicle filter dropdown for vehicle work
     function updateVehicleWorkVehicleFilter(vehicleWorkData) {
       const vehicleFilter = document.getElementById('vehicleWorkVehicleFilter');
       if (!vehicleFilter) return;
       
       const currentValue = vehicleFilter.value;
       const uniqueVehicles = [...new Set(vehicleWorkData.map(item => item.vehicleNumber))].filter(v => v && v !== 'N/A');
       
       vehicleFilter.innerHTML = '<option value="">All Vehicles</option>';
       uniqueVehicles.sort().forEach(vehicle => {
         const option = document.createElement('option');
         option.value = vehicle;
         option.textContent = vehicle;
         vehicleFilter.appendChild(option);
       });
       
       // Restore selection if it still exists
       if (currentValue && uniqueVehicles.includes(currentValue)) {
         vehicleFilter.value = currentValue;
       }
     }

     // Apply filters to vehicle work table
     function applyVehicleWorkFilters() {
       const fromDate = document.getElementById('vehicleWorkFromDate').value;
       const toDate = document.getElementById('vehicleWorkToDate').value;
       const actionFilter = document.getElementById('vehicleWorkActionFilter').value;
       
       // Custom filtering function
       $.fn.dataTable.ext.search.push(
         function(settings, data, dataIndex) {
           if (settings.nTable.id !== 'vehicleWorkTable') {
             return true;
           }
           
           const row = vehicleWorkTable.row(dataIndex).data();
           if (!row) return true;
           
           const rowDate = row.date;
           const rowPaymentStatus = row.paymentStatus || 'Pending';
           
           let showRow = true;
           
           // Date filter
           if (fromDate && rowDate < fromDate) showRow = false;
           if (toDate && rowDate > toDate) showRow = false;
           
           // Action status filter
           if (actionFilter && rowPaymentStatus !== actionFilter) showRow = false;
           
           return showRow;
         }
       );
       
       vehicleWorkTable.draw();
       
       // Remove the custom filter function after drawing
       $.fn.dataTable.ext.search.pop();
     }

     // --- NEW: Toggle Payment Status ---
     function togglePaymentStatus(lrId, currentStatus, tripType) {
       const newStatus = currentStatus === 'Completed' ? 'Pending' : 'Completed';
       // **FIX**: Determine the correct database path based on the trip type.
       const pathSuffix = tripType === 'main' ? 'paymentStatus' : 'emptyTripData/paymentStatus';

       if (confirm(`Change payment status to "${newStatus}"?`)) {
         const updatePath = ref(database, `users/${coreAccountId}/lrReports/${lrId}/${pathSuffix}`);
         set(updatePath, newStatus)
           .then(() => {
             showSuccess('Payment status updated successfully!');
             // The table will auto-refresh due to the 'on' listener.
           })
           .catch(error => {
             showError('Error updating status: ' + error.message);
           });
       }
     }

     // Make the new function globally accessible for the onclick attribute
     window.togglePaymentStatus = togglePaymentStatus;


     // Clear vehicle work filters
     function clearVehicleWorkFilters() {
       document.getElementById('vehicleWorkFromDate').value = '';
       document.getElementById('vehicleWorkToDate').value = '';
       document.getElementById('vehicleWorkActionFilter').value = '';
       
       vehicleWorkTable.search('').columns().search('').draw();
     }

     // Export vehicle work to Excel
     function exportVehicleWorkExcel() {
       try {
         const data = vehicleWorkTable.rows({ search: 'applied' }).data().toArray();
         
         const excelData = data.map(row => ({
           'Vehicle Number': row.vehicleNumber,
           'Date': row.date,
           'LR Number': row.lrNumber,
           'From Location': row.fromLocation,
           'To Location': row.toLocation,
           'Vehicle Work Amount': parseFloat(row.vehicleWork) || 0,
           'Status': row.status
         }));
         
         // Create worksheet and workbook
         const ws = XLSX.utils.json_to_sheet(excelData);
         const wb = XLSX.utils.book_new();
         XLSX.utils.book_append_sheet(wb, ws, 'Vehicle Work');
         
         // Generate Excel file and download
         const fileName = `vehicle_work_data_${new Date().toISOString().split('T')[0]}.xlsx`;
         XLSX.writeFile(wb, fileName);
         
         showSuccess('Vehicle work Excel file downloaded successfully');
       } catch (error) {
         showError('Error downloading vehicle work Excel file: ' + error.message);
       }
     }

     // View LR Details (Copied from booking.html, adapted for add.html)
     async function viewLRDetails(lrId) {
       const dataRoot = coreAccountId || currentUser.uid;
       const lrRef = ref(database, `users/${dataRoot}/lrReports/${lrId}`);
       const lrSnap = await get(lrRef);

       if (!lrSnap.exists()) {
         alert('LR report not found.');
         return;
       }

       const lr = lrSnap.val();
       const modalContent = document.getElementById('lrDetailContent');

       // Calculate total expenses from the LR data
       const totalExpenses = (
         (parseFloat(lr.tyreExpenses) || 0) +
         (parseFloat(lr.dieselExpenses) || 0) +
         (parseFloat(lr.tollExpenses) || 0) +
         (parseFloat(lr.vehicleWork) || 0) +
         (parseFloat(lr.foodExpenses) || 0) +
         (parseFloat(lr.otherExpenses) || 0) +
         (parseFloat(lr.advance) || 0)
       );
       const profit = (lr.billingAmount || 0) - totalExpenses;

       modalContent.innerHTML = `
         <div class="row">
           <div class="col-md-6">
             <div class="detail-row"><strong>LR Number:</strong> ${lr.lrNumber || 'N/A'}</div>
             <div class="detail-row"><strong>Date:</strong> ${lr.date || 'N/A'}</div>
             <div class="detail-row"><strong>Vehicle:</strong> ${lr.truckNumber || 'N/A'}</div>
             <div class="detail-row"><strong>Route:</strong> ${lr.fromLocation || 'N/A'} to ${lr.toLocation || 'N/A'}</div>
             <div class="detail-row"><strong>Item:</strong> ${lr.item || 'N/A'}</div>
             <div class="detail-row"><strong>Weight:</strong> ${lr.weight || 0} tonnes</div>
           </div>
           <div class="col-md-6">
             <div class="detail-row"><strong>Billing Amount:</strong> ₹${(lr.billingAmount || 0).toFixed(2)}</div>
             <div class="detail-row"><strong>Freight Amount:</strong> ₹${(lr.freightAmount || 0).toFixed(2)}</div>
             <div class="detail-row"><strong>Advance Paid:</strong> ₹${(lr.advance || 0).toFixed(2)}</div>
             <div class="detail-row"><strong>Balance:</strong> ₹${(lr.balance || 0).toFixed(2)}</div>
             <div class="detail-row"><strong>Total Amount (inc. GST):</strong> ₹${(lr.totalAmount || 0).toFixed(2)}</div>
             <div class="detail-row">
               <strong>Payment Status:</strong> 
               <span class="status-badge ${lr.paymentStatus === 'paid' ? 'status-paid' : lr.paymentStatus === 'partial' ? 'status-pending' : 'status-overdue'}">
                 ${lr.paymentStatus || 'pending'}
               </span>
             </div>
           </div>
         </div>
         <hr>
         <h5 class="mt-3">Expense Breakdown</h5>
         <div class="row">
             <div class="col-md-4"><div class="detail-row"><strong>Tyre:</strong> ₹${(lr.tyreExpenses || 0).toFixed(2)}</div></div>
             <div class="col-md-4"><div class="detail-row"><strong>Diesel:</strong> ₹${(lr.dieselExpenses) || 0}</div></div>
             <div class="col-md-4"><div class="detail-row"><strong>Toll:</strong> ₹${(lr.tollExpenses || 0).toFixed(2)}</div></div>
             <div class="col-md-4"><div class="detail-row"><strong>Vehicle Work:</strong> ₹${(lr.vehicleWork || 0).toFixed(2)}</div></div>
             <div class="col-md-4"><div class="detail-row"><strong>Food:</strong> ₹${(lr.foodExpenses || 0).toFixed(2)}</div></div>
             <div class="col-md-4"><div class="detail-row"><strong>Other:</strong> ₹${(lr.otherExpenses || 0).toFixed(2)}</div></div>
         </div>
         <hr>
         <div class="row fw-bold fs-5 mt-3">
             <div class="col-6 text-end">Total Expenses:</div>
             <div class="col-6 text-start">₹${totalExpenses.toFixed(2)}</div>
         </div>
         <div class="row fw-bold fs-5 mt-1 ${profit >= 0 ? 'text-success' : 'text-danger'}">
             <div class="col-6 text-end">Net Profit:</div>
             <div class="col-6 text-start">₹${profit.toFixed(2)}</div>
         </div>
       `;

       // Show the modal
       const modal = new bootstrap.Modal(document.getElementById('lrDetailModal'));
       modal.show();
     }

     // Make functions globally accessible
     window.applyVehicleWorkFilters = applyVehicleWorkFilters;
     window.clearVehicleWorkFilters = clearVehicleWorkFilters;
     window.exportVehicleWorkExcel = exportVehicleWorkExcel;
     // **FIX**: Expose functions called by onclick attributes to the global scope.
     window.viewLRDetails = viewLRDetails; // Expose the new function
     window.editEntry = editEntry;
     window.deleteEntry = deleteEntry;
     window.viewDetails = viewDetails;
     window.hideDetailView = hideDetailView;
     window.downloadExcel = downloadExcel;
     window.editDriverPayment = editDriverPayment;
     window.deleteDriverPayment = deleteDriverPayment;

     
     // Set default date to today for payment form
     document.getElementById('paymentDate').valueAsDate = new Date();
  </script>
</body>
</html>
