<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vehicle & Driver Details</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <style>
    * { box-sizing: border-box; }
    body { 
      background: #f0f7fa; 
      font-family: "Segoe UI", Tahoma, Verdana, sans-serif; 
      color: #333; 
      margin: 0; 
      padding: 0; 
      line-height: 1.6;
    }
    .container { 
      max-width: 1200px; 
      margin: 20px auto; 
      background: white; 
      padding: 25px; 
      border-radius: 12px; 
      box-shadow: 0 5px 15px rgba(0,0,0,0.08); 
    }
    h2, h3 { 
      text-align: center; 
      color: #2e8b57; 
      margin: 0 0 20px 0; 
    }
    h2 {
      font-size: 28px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e0e0e0;
    }
    html[data-theme="dark"] {
      --bg: #0f172a;
      --card: #111827;
      --text: #e5e7eb;
      --border: #1f2937;
      --muted: #9ca3af;
      --shadow: 0 6px 18px rgba(0,0,0,.45);
    }
    form label { 
      display: block; 
      margin-bottom: 8px; 
      font-weight: 600; 
      color: #444;
    }
    form input, form textarea, form select { 
      width: 100%; 
      padding: 12px; 
      margin-bottom: 15px; 
      border: 1px solid #ccc; 
      border-radius: 6px; 
      font-size: 16px; 
      box-sizing: border-box; 
      transition: border 0.3s;
    }
    form input:focus, form textarea:focus, form select:focus {
      border-color: #43b97f;
      outline: none;
      box-shadow: 0 0 0 2px rgba(67, 185, 127, 0.2);
    }
    .row { 
      display: flex; 
      gap: 15px; 
      flex-wrap: wrap; 
      margin-bottom: 10px;
    }
    .row > * { 
      flex: 1 1 250px; 
      min-width: 200px; 
    }
    button, .download-btn { 
      background-color: #43b97f; 
      color: white; 
      padding: 12px 20px; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      font-size: 16px; 
      font-weight: 600;
      transition: background 0.3s, transform 0.2s;
    }
    button:hover, .download-btn:hover { 
      background: #3ba06f; 
      transform: translateY(-2px);
    }
    button:active {
      transform: translateY(0);
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 25px; 
      background: white; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    th, td { 
      border-bottom: 1px solid #e0e0e0; 
      padding: 12px 15px; 
      text-align: left; 
      vertical-align: middle; 
      font-size: 14px; 
    }
    th { 
      background: #2e8b57; 
      color: white; 
      font-size: 14px; 
      font-weight: 600;
      position: sticky;
      top: 0;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    tr:hover {
      background-color: #f0f7fa;
    }
    .action-btn { 
      background: #43b97f; 
      color: white; 
      border: none; 
      padding: 8px 12px; 
      border-radius: 4px; 
      cursor: pointer; 
      margin-right: 6px; 
      font-size: 13px;
      transition: background 0.3s;
    }
    .action-btn.delete { 
      background: #e74c3c; 
    }
    .action-btn.delete:hover {
      background: #c0392b;
    }
    .action-btn.report { 
      background: #3498db; 
    }
    .action-btn.report:hover {
      background: #2980b9;
    }
    .action-btn:hover {
      opacity: 0.9;
    }
    .preview { 
      max-width: 120px; 
      max-height: 120px; 
      border-radius: 6px; 
      display: block; 
      margin-top: 8px; 
      border: 1px solid #ddd;
    }
    .progress-wrap { 
      font-size: 13px; 
      margin-top: 6px; 
      color: #666;
    }
    .small { 
      font-size: 13px; 
      color: #666; 
    }
    .section-divider {
      height: 1px;
      background: linear-gradient(to right, transparent, #ddd, transparent);
      margin: 25px 0;
    }
    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 12px;
      border-radius: 6px;
      margin: 15px 0;
      display: none;
    }
    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 12px;
      border-radius: 6px;
      margin: 15px 0;
      display: none;
    }
    .filter-section {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    @media (max-width: 900px) {
      .row > * { 
        flex: 1 1 100%; 
      }
      th, td {
        padding: 8px 10px;
      }
      .action-btn {
        display: block;
        margin-bottom: 5px;
        width: 100%;
      }
    }

    /* Modal */
    #reportModal { 
      display: none; 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.5); 
      align-items: center; 
      justify-content: center; 
      z-index: 999; 
      padding: 20px;
    }
    #reportModal .card { 
      background: white; 
      padding: 25px; 
      border-radius: 10px; 
      width: 100%; 
      max-width: 500px; 
      box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    }
    #reportModal h3 {
      margin-top: 0;
    }
    #reportModal label {
      font-weight: 600;
      margin-top: 15px;
      display: block;
    }
    #reportModal input {
      margin-bottom: 20px;
    }
    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    /* Report Status Modal */
    #reportStatusModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    #reportStatusModal .card {
      background: white;
      padding: 25px;
      border-radius: 10px;
      width: 100%;
      max-width: 500px;
      text-align: center;
    }
    #reportStatusModal .progress-bar {
      height: 10px;
      background: #f0f0f0;
      border-radius: 5px;
      margin: 15px 0;
      overflow: hidden;
    }
    #reportStatusModal .progress-bar-inner {
      height: 100%;
      background: #43b97f;
      width: 0%;
      transition: width 0.3s;
    }

    /* Tyre Table Styles */
    .tyre-table {
      width: 100%;
      margin-top: 15px;
      border-collapse: collapse;
    }
    .tyre-table th {
      background: #3498db;
      padding: 8px;
      font-size: 12px;
    }
    .tyre-table td {
      padding: 8px;
      font-size: 12px;
      border: 1px solid #e0e0e0;
    }
    .tyre-section {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <!-- Navbar will be loaded here -->
  <div id="navbar"></div>

  <div class="container">
    <h2>Vehicle and Driver Entry Form</h2>
    
    <div id="successMessage" class="success-message">
      <i class="fas fa-check-circle"></i> Operation completed successfully!
    </div>
    
    <div id="errorMessage" class="error-message">
      <i class="fas fa-exclamation-circle"></i> <span id="errorText"></span>
    </div>

    <form id="vehicleDriverForm">
      <div class="row">
        <div>
          <label><i class="fas fa-truck"></i> Vehicle Number *</label>
          <input id="vehicleNumber" required placeholder="e.g. KA01AB1234" />
        </div>
        <div>
          <label><i class="fas fa-car"></i> Vehicle Type</label>
          <input id="vehicleType" placeholder="e.g. Truck, Mini Truck" />
        </div>
      </div>

      <div class="row">
        <div>
          <label><i class="fas fa-user"></i> Driver Name</label>
          <input id="driverName" placeholder="Driver's full name" />
        </div>
        <div>
          <label><i class="fas fa-id-card"></i> Driver License No.</label>
          <input id="driverLicense" placeholder="License number" />
        </div>
      </div>

      <div class="row">
        <div>
          <label><i class="fas fa-phone"></i> Driver Contact Number</label>
          <input id="contactNumber" type="tel" placeholder="+91 1234567890" />
        </div>
        <div>
          <label><i class="fas fa-id-card"></i> License Image (photo)</label>
          <input id="licenseImage" type="file" accept="image/*" />
          <img id="licensePreview" class="preview" style="display:none" />
          <div id="licenseProgress" class="progress-wrap small"></div>
        </div>
      </div>

      <div class="row">
        <div>
          <label><i class="fas fa-file-certificate"></i> PUC Certificate (image/pdf)</label>
          <input id="pucFile" type="file" accept="image/*,application/pdf" />
          <div id="pucProgress" class="progress-wrap small"></div>
        </div>
        <div>
          <label><i class="fas fa-file-contract"></i> Insurance Paper (image/pdf)</label>
          <input id="insuranceFile" type="file" accept="image/*,application/pdf" />
          <div id="insuranceProgress" class="progress-wrap small"></div>
        </div>
      </div>

      <div>
        <label><i class="fas fa-heartbeat"></i> Fitness Certificate (image/pdf)</label>
        <input id="fitnessFile" type="file" accept="image/*,application/pdf" />
        <div id="fitnessProgress" class="progress-wrap small"></div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:15px;">
        <button type="submit" id="saveBtn"><i class="fas fa-save"></i> Save Entry</button>
        <button type="button" id="cancelEdit" style="display:none;background:#f39c12"><i class="fas fa-times"></i> Cancel Edit</button>
        <span id="formNote" class="small">Images will be resized (max width 1024px) and converted to WebP before upload.</span>
      </div>
    </form>

    <div class="section-divider"></div>

    <h3>View Vehicle & Driver Info</h3>
    
    <div class="filter-section">
      <div class="row">
        <div>
          <label>Search Vehicle/Driver:</label>
          <input type="text" id="searchInput" placeholder="Search by vehicle no, driver name..." />
        </div>
        <div>
          <label>Filter by Vehicle Type:</label>
          <select id="typeFilter">
            <option value="">All Types</option>
            <option value="Truck">Truck</option>
            <option value="Mini Truck">Mini Truck</option>
            <option value="Container">Container</option>
            <option value="Trailer">Trailer</option>
          </select>
        </div>
      </div>
    </div>
    
    <button class="download-btn" onclick="downloadExcel()"><i class="fas fa-file-excel"></i> Download Excel</button>

    <table id="vehicleDriverTable">
      <thead>
        <tr>
          <th>Vehicle Number</th>
          <th>Type</th>
          <th>Driver</th>
          <th>License No.</th>
          <th>Contact</th>
          <th>License Image</th>
          <th>PUC</th>
          <th>Insurance</th>
          <th>Fitness</th>
          <th>Actions</th>
          <th>Report</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <!-- Data will be populated by JavaScript -->
      </tbody>
    </table>
  </div>

  <!-- Report Modal -->
  <div id="reportModal">
    <div class="card">
      <h3>Generate Vehicle Report</h3>
      <p class="small">Select date range for the report</p>
      
      <label>From:</label>
      <input type="date" id="reportFrom" />
      
      <label>To:</label>
      <input type="date" id="reportTo" />
      
      <div class="modal-buttons">
        <button onclick="closeReportModal()" style="background: #95a5a6;">Cancel</button>
        <button id="generatePdfBtn"><i class="fas fa-file-pdf"></i> Generate PDF</button>
      </div>
    </div>
  </div>

  <!-- Report Status Modal -->
  <div id="reportStatusModal">
    <div class="card">
      <h3>Generating Report</h3>
      <p>Fetching data from all collections...</p>
      <div class="progress-bar">
        <div class="progress-bar-inner" id="reportProgress"></div>
      </div>
      <div id="reportStatusText">Initializing...</div>
    </div>
  </div>

  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <!-- Firebase Authentication -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <!-- Firebase Realtime Database -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <!-- XLSX for Excel export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDAlk_K8p8Of8Ne6Jpcl2QqXTtm95NgG7o",
      authDomain: "transport-dashboard-ad69a.firebaseapp.com",
      databaseURL: "https://transport-dashboard-ad69a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "transport-dashboard-ad69a",
      storageBucket: "transport-dashboard-ad69a.appspot.com",
      messagingSenderId: "526889676196",
      appId: "1:526889676196:web:66032c80a4aede690ae531",
      measurementId: "G-7F9R7HJYDH"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    // Cloudinary settings
    const CLOUD_NAME = "doqapn15f";
    const UPLOAD_PRESET = "payment-billing"; // unsigned preset
    const CLOUD_FOLDER = "payment-billing";

    // DOM elements
    const form = document.getElementById("vehicleDriverForm");
    const successMessage = document.getElementById("successMessage");
    const errorMessage = document.getElementById("errorMessage");
    const errorText = document.getElementById("errorText");
    const licenseInput = document.getElementById("licenseImage");
    const licensePreview = document.getElementById("licensePreview");
    const cancelEditBtn = document.getElementById("cancelEdit");
    const searchInput = document.getElementById("searchInput");
    const typeFilter = document.getElementById("typeFilter");
    const tableBody = document.getElementById("tableBody");
    const generatePdfBtn = document.getElementById("generatePdfBtn");
    const reportProgress = document.getElementById("reportProgress");
    const reportStatusText = document.getElementById("reportStatusText");
    const reportStatusModal = document.getElementById("reportStatusModal");
    const vehicleNumberInput = document.getElementById("vehicleNumber");

    window.toggleMenu = function() {
      const el = document.getElementById("navLinks");
      if (el) el.classList.toggle("show");
    };
    
    // Global variables
    let currentUser = null;
    let editKey = null;
    let currentEntryCache = {};
    let selectedVehicle = null;
    let vehiclesData = {};
    let tyreData = {};

    // Load navbar from external file
    fetch('navbar.html')
      .then(response => response.text())
      .then(data => {
        document.getElementById('navbar').innerHTML = data;
        // Add event listener to logout button after navbar is loaded
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', function() {
            auth.signOut()
              .then(() => {
                window.location.href = "index.html";
              })
              .catch((error) => {
                showError('Logout failed: ' + error.message);
              });
          });
        }
      })
      .catch(error => {
        console.error('Error loading navbar:', error);
        // Create a fallback navbar if the external file can't be loaded
        document.getElementById('navbar').innerHTML = `
          <div class="navbar">
            <h1><i class="fas fa-truck"></i> Transport Management</h1>
            <button id="logoutBtn">Logout</button>
          </div>
        `;
        
        // Add event listener to the fallback logout button
        document.getElementById('logoutBtn').addEventListener('click', function() {
          auth.signOut()
            .then(() => {
              window.location.href = "index.html";
            })
            .catch((error) => {
              showError('Logout failed: ' + error.message);
            });
        });
      });

    // Initialize the application
    function initApp() {
      // Check auth state
      auth.onAuthStateChanged((user) => {
        if (user) {
          currentUser = user;
          loadVehicles();
          loadTyres();
        } else {
          // Redirect to login page if not authenticated
          window.location.href = "index.html";
        }
      });
    }

    // Load vehicles from Firebase
    function loadVehicles() {
      const vehiclesRef = database.ref(`users/${currentUser.uid}/vehicles`);
      
      vehiclesRef.on('value', (snapshot) => {
        vehiclesData = snapshot.val() || {};
        renderTable(vehiclesData);
      }, (error) => {
        showError('Failed to load vehicles: ' + error.message);
      });
    }

    // Load tyres from Firebase
    function loadTyres() {
      console.group('loadTyres');
      try {
        const tyresRef = database.ref(`users/${currentUser.uid}/vehicles`);
        console.log('Loading tyres from path:', `users/${currentUser.uid}/vehicles`);
        
        tyresRef.once('value').then((snapshot) => {
          console.log('Received vehicles data snapshot');
          const vehicles = snapshot.val() || {};
          tyreData = {};
          
          // Extract tyres from each vehicle
          Object.entries(vehicles).forEach(([vehicleId, vehicle]) => {
            if (vehicle.tyres) {
              Object.entries(vehicle.tyres).forEach(([tyreId, tyre]) => {
                tyreData[`${vehicleId}_${tyreId}`] = {
                  ...tyre,
                  vehicleNumber: vehicle.vehicleNumber,
                  vehicleId: vehicleId
                };
              });
            }
          });
          
          console.log('Processed tyre data:', tyreData);
          console.log(`Total tyres loaded: ${Object.keys(tyreData).length}`);
          
          if (Object.keys(tyreData).length > 0) {
            const sampleTyre = tyreData[Object.keys(tyreData)[0]];
            console.log('Sample tyre structure:', sampleTyre);
          } else {
            console.warn('No tyres found in any vehicles');
          }
          
          // Update the UI if needed
          if (window.renderTable) {
            renderTable(vehiclesData);
          }
          
          console.groupEnd();
        }).catch((error) => {
          console.error('Failed to load tyres:', error);
          console.groupEnd();
        });
      } catch (error) {
        console.error('Error in loadTyres:', error);
        console.groupEnd();
      }
    }

    // Check if vehicle already exists
    function checkVehicleExists(vehicleNumber) {
      return Object.values(vehiclesData).some(vehicle => 
        vehicle.vehicleNumber && vehicle.vehicleNumber.toLowerCase() === vehicleNumber.toLowerCase()
      );
    }

    // Get tyres for a specific vehicle
    function getTyresForVehicle(vehicleNumber) {
      console.group('getTyresForVehicle');
      try {
        console.log('Searching for vehicle number:', vehicleNumber);
        console.log('Current tyreData:', JSON.stringify(tyreData, null, 2));
        
        if (!tyreData) {
          console.warn('No tyre data available');
          console.groupEnd();
          return [];
        }
        
        if (!vehicleNumber) {
          console.warn('No vehicle number provided');
          console.groupEnd();
          return [];
        }
        
        // Normalize the search vehicle number - remove all spaces and convert to lowercase
        const normalizeNumber = (num) => num.toString().replace(/\s+/g, '').toLowerCase();
        const searchNumber = normalizeNumber(vehicleNumber);
        console.log('Normalized search number:', searchNumber);
        
        // Get all tyres that match the vehicle number (check multiple possible fields)
        const matchingTyres = Object.entries(tyreData).reduce((result, [tyreId, tyre]) => {
          // Check all possible vehicle number fields
          const possibleVehicleNumbers = [
            tyre.vehicleNumber,
            tyre.truckNumber,
            tyre.vehicleNo
          ].filter(Boolean); // Remove any undefined/null values
          
          // Check if any of the vehicle numbers match (after normalization)
          const matches = possibleVehicleNumbers.some(num => 
            normalizeNumber(num) === searchNumber
          );
          
          console.log(`Tyre ${tyreId} - ` +
            `Vehicle Numbers: [${possibleVehicleNumbers.join(', ')}], ` +
            `Matches '${searchNumber}': ${matches}`);
            
          if (matches) {
            // Normalize the tyre data to use consistent field names
            const normalizedTyre = {
              ...tyre,
              id: tyreId,
              tyreNumber: tyre.tyreNumber || tyre.number, // Handle both 'tyreNumber' and 'number' fields
              vehicleNumber: tyre.vehicleNumber || tyre.truckNumber || tyre.vehicleNo
            };
            result.push(normalizedTyre);
          }
          
          return result;
        }, []);
        
        console.log(`Found ${matchingTyres.length} tyres for vehicle ${vehicleNumber}`, matchingTyres);
        console.groupEnd();
        return matchingTyres;
      } catch (error) {
        console.error('Error in getTyresForVehicle:', error);
        console.groupEnd();
        return [];
      }
    }

    // Render table with vehicle data
    function renderTable(data) {
      tableBody.innerHTML = '';
      
      for (const key in data) {
        const vehicle = data[key];
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td>${vehicle.vehicleNumber || '-'}</td>
          <td>${vehicle.vehicleType || '-'}</td>
          <td>${vehicle.driverName || '-'}</td>
          <td>${vehicle.driverLicense || '-'}</td>
          <td>${vehicle.contactNumber || '-'}</td>
          <td>${vehicle.licenseImageUrl ? `<a href="${vehicle.licenseImageUrl}" target="_blank">View</a>` : '-'}</td>
          <td>${vehicle.pucUrl ? `<a href="${vehicle.pucUrl}" target="_blank">View</a>` : '-'}</td>
          <td>${vehicle.insuranceUrl ? `<a href="${vehicle.insuranceUrl}" target="_blank">View</a>` : '-'}</td>
          <td>${vehicle.fitnessUrl ? `<a href="${vehicle.fitnessUrl}" target="_blank">View</a>` : '-'}</td>
          <td>
            <button class="action-btn" onclick="editVehicle('${key}')">Edit</button>
            <button class="action-btn delete" onclick="deleteVehicle('${key}')">Delete</button>
          </td>
          <td>
            <button class="action-btn report" onclick="openReportModal('${vehicle.vehicleNumber}')">Report</button>
          </td>
        `;
        
        tableBody.appendChild(row);
      }
      
      // Apply filters if any
      filterTable();
    }

    // Image preview functionality
    licenseInput.addEventListener("change", function() {
      const file = this.files[0];
      if (file && file.type.startsWith("image/")) {
        const reader = new FileReader();
        reader.onload = function(e) {
          licensePreview.src = e.target.result;
          licensePreview.style.display = "block";
        };
        reader.readAsDataURL(file);
      } else {
        licensePreview.style.display = "none";
      }
    });
    
    // Check for duplicate vehicle number when input changes
    vehicleNumberInput.addEventListener('blur', function() {
      const vehicleNumber = this.value.trim();
      if (vehicleNumber && checkVehicleExists(vehicleNumber) && !editKey) {
        showError(`Vehicle ${vehicleNumber} already exists!`);
        this.focus();
      }
    });
    
    // Form submission
    form.addEventListener("submit", async function(e) {
      e.preventDefault();
      
      try {
        // Get form values
        const vehicleNumber = document.getElementById("vehicleNumber").value.trim();
        const vehicleType = document.getElementById("vehicleType").value.trim();
        const driverName = document.getElementById("driverName").value.trim();
        const driverLicense = document.getElementById("driverLicense").value.trim();
        const contactNumber = document.getElementById("contactNumber").value.trim();
        
        // Check for duplicate vehicle (if not in edit mode)
        if (!editKey && checkVehicleExists(vehicleNumber)) {
          showError(`Vehicle ${vehicleNumber} already exists!`);
          return;
        }
        
        // Initialize file URLs with empty strings to prevent undefined values
        let licenseImageUrl = '';
        let pucUrl = '';
        let insuranceUrl = '';
        let fitnessUrl = '';
        
        if (licenseInput.files[0]) {
          licenseImageUrl = await uploadToCloudinary(licenseInput.files[0], document.getElementById('licenseProgress'));
        }
        if (document.getElementById("pucFile").files[0]) {
          pucUrl = await uploadToCloudinary(document.getElementById("pucFile").files[0], document.getElementById('pucProgress'));
        }
        if (document.getElementById("insuranceFile").files[0]) {
          insuranceUrl = await uploadToCloudinary(document.getElementById("insuranceFile").files[0], document.getElementById('insuranceProgress'));
        }
        if (document.getElementById("fitnessFile").files[0]) {
          fitnessUrl = await uploadToCloudinary(document.getElementById("fitnessFile").files[0], document.getElementById('fitnessProgress'));
        }
        
        // Prepare vehicle data with proper fallbacks for all URL fields
        const vehicleData = {
          vehicleNumber: vehicleNumber || '',
          vehicleType: vehicleType || '',
          driverName: driverName || '',
          driverLicense: driverLicense || '',
          contactNumber: contactNumber || '',
          // Use existing URL if in edit mode and no new file was uploaded
          licenseImageUrl: licenseImageUrl || (editKey && currentEntryCache.licenseImageUrl) || '',
          pucUrl: pucUrl || (editKey && currentEntryCache.pucUrl) || '',
          insuranceUrl: insuranceUrl || (editKey && currentEntryCache.insuranceUrl) || '',
          fitnessUrl: fitnessUrl || (editKey && currentEntryCache.fitnessUrl) || '',
          timestamp: Date.now(),
        };
        
        // Ensure no undefined values in the vehicle data
        Object.keys(vehicleData).forEach(key => {
          if (vehicleData[key] === undefined) {
            vehicleData[key] = '';
          }
        });
        
        // Save to Firebase
        const vehiclesRef = database.ref(`users/${currentUser.uid}/vehicles`);
        
        try {
          if (editKey) {
            // Update existing vehicle
            await vehiclesRef.child(editKey).update(vehicleData);
            showSuccess('Vehicle updated successfully!');
            cancelEdit();
          } else {
            // Add new vehicle
            await vehiclesRef.push(vehicleData);
            showSuccess('Vehicle added successfully!');
          }
        } catch (error) {
          console.error('Error saving vehicle:', error);
          throw error; // Re-throw to be caught by the outer try-catch
        }
        
        // Reset form
        form.reset();
        licensePreview.style.display = "none";
        
      } catch (error) {
        showError('Failed to save vehicle: ' + error.message);
      }
    });
    
    // Upload to Cloudinary
    async function uploadToCloudinary(file, progressElem = null) {
      if (progressElem) {
        progressElem.innerHTML = '<span class="loading"></span> Uploading...';
      }
      
      try {
        // Compress image if it's an image
        let uploadFile = file;
        if (file.type.startsWith("image/")) {
          uploadFile = await compressImageToWebP(file, 1024, 0.8);
        }
        
        const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`;
        const formData = new FormData();
        formData.append("file", uploadFile);
        formData.append("upload_preset", UPLOAD_PRESET);
        formData.append("folder", CLOUD_FOLDER);

        const response = await fetch(url, { method: "POST", body: formData });
        const data = await response.json();
        
        if (progressElem) {
          progressElem.textContent = "Uploaded";
        }
        
        return data.secure_url;
      } catch (error) {
        if (progressElem) {
          progressElem.textContent = "Upload failed";
        }
        throw new Error('File upload failed: ' + error.message);
      }
    }
    
    // Compress image to WebP format
    function compressImageToWebP(file, maxWidth = 1024, quality = 0.8) {
      return new Promise((resolve, reject) => {
        if (!file.type.startsWith("image/")) return resolve(file);
        
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement("canvas");
          const scale = Math.min(1, maxWidth / img.width);
          canvas.width = Math.round(img.width * scale);
          canvas.height = Math.round(img.height * scale);
          
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          
          canvas.toBlob((blob) => {
            if (!blob) return reject(new Error("Canvas conversion failed"));
            
            const newFile = new File(
              [blob], 
              file.name.replace(/\.[^/.]+$/, "") + ".webp", 
              { type: "image/webp" }
            );
            
            resolve(newFile);
          }, "image/webp", quality);
        };
        
        img.onerror = (e) => reject(e);
        const reader = new FileReader();
        reader.onload = () => (img.src = reader.result);
        reader.onerror = (e) => reject(e);
        reader.readAsDataURL(file);
      });
    }
    
    // Edit vehicle
    function editVehicle(key) {
      const vehicle = vehiclesData[key];
      if (!vehicle) return;
      
      // Store the original data for reference
      currentEntryCache = { ...vehicle };
      
      // Set form values
      document.getElementById("vehicleNumber").value = vehicle.vehicleNumber || "";
      document.getElementById("vehicleType").value = vehicle.vehicleType || "";
      document.getElementById("driverName").value = vehicle.driverName || "";
      document.getElementById("driverLicense").value = vehicle.driverLicense || "";
      document.getElementById("contactNumber").value = vehicle.contactNumber || "";
      
      // Set preview for license image if it exists
      if (vehicle.licenseImageUrl) {
        licensePreview.src = vehicle.licenseImageUrl;
        licensePreview.style.display = "block";
      } else {
        licensePreview.style.display = "none";
      }
      
      // Store the edit key
      editKey = key;
      cancelEditBtn.style.display = "inline-block";
      
      // Scroll to form
      form.scrollIntoView({ behavior: 'smooth' });
    }
    
    // Cancel edit
    function cancelEdit() {
      editKey = null;
      currentEntryCache = {};
      cancelEditBtn.style.display = "none";
      form.reset();
      licensePreview.style.display = "none";
    }
    
    // Delete vehicle
    function deleteVehicle(key) {
      if (!confirm("Are you sure you want to delete this vehicle?")) return;
      
      database.ref(`users/${currentUser.uid}/vehicles/${key}`).remove()
        .then(() => {
          showSuccess('Vehicle deleted successfully!');
        })
        .catch((error) => {
          showError('Failed to delete vehicle: ' + error.message);
        });
    }
    
    // Show success message
    function showSuccess(message) {
      successMessage.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
      successMessage.style.display = "block";
      
      setTimeout(() => {
        successMessage.style.display = "none";
      }, 3000);
    }
    
    // Show error message
    function showError(message) {
      errorText.textContent = message;
      errorMessage.style.display = "block";
      
      setTimeout(() => {
        errorMessage.style.display = "none";
      }, 5000);
    }
    
    // Download Excel function
    function downloadExcel() {
      try {
        const table = document.getElementById("vehicleDriverTable");
        const wb = XLSX.utils.table_to_book(table, { sheet: "Vehicle & Driver Details" });
        XLSX.writeFile(wb, "vehicle-driver-details.xlsx");
        showSuccess('Excel file downloaded successfully!');
      } catch (error) {
        showError('Failed to download Excel: ' + error.message);
      }
    }
    
    // Report modal functions
    function openReportModal(vehicleNumber) {
      selectedVehicle = vehicleNumber;
      document.getElementById("reportModal").style.display = "flex";
      
      // Set default dates (last 30 days)
      const toDate = new Date();
      const fromDate = new Date();
      fromDate.setDate(toDate.getDate() - 30);
      
      document.getElementById("reportFrom").value = formatDateForInput(fromDate);
      document.getElementById("reportTo").value = formatDateForInput(toDate);
    }
    
    function closeReportModal() {
      document.getElementById("reportModal").style.display = "none";
    }
    
    function formatDateForInput(date) {
      return date.toISOString().split('T')[0];
    }
    
    // Show report status modal
    function showReportStatus() {
      reportStatusModal.style.display = "flex";
    }
    
    // Hide report status modal
    function hideReportStatus() {
      reportStatusModal.style.display = "none";
    }
    
    // Update report progress
    function updateReportProgress(percent, status) {
      reportProgress.style.width = percent + '%';
      reportStatusText.textContent = status;
    }
    
    // Parse date in various formats (dd-mm-yyyy, timestamp, etc.)
    function parseDate(dateValue) {
      if (!dateValue) return null;
      
      // If it's a timestamp
      if (typeof dateValue === 'number' || /^\d+$/.test(dateValue)) {
        return new Date(parseInt(dateValue));
      }
      
      // If it's in dd-mm-yyyy format
      if (typeof dateValue === 'string' && dateValue.includes('-')) {
        const parts = dateValue.split('-');
        if (parts.length === 3) {
          // Handle both dd-mm-yyyy and yyyy-mm-dd formats
          if (parts[0].length === 4) {
            // yyyy-mm-dd format
            return new Date(parts[0], parts[1] - 1, parts[2]);
          } else {
            // dd-mm-yyyy format
            return new Date(parts[2], parts[1] - 1, parts[0]);
          }
        }
      }
      
      // Try to parse as ISO date
      const parsedDate = new Date(dateValue);
      return isNaN(parsedDate.getTime()) ? null : parsedDate;
    }
    
    // Format date for display (dd-mm-yyyy)
    function formatDateForDisplay(dateString) {
      const date = parseDate(dateString);
      if (!date) return 'N/A';
      
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      
      return `${day}-${month}-${year}`;
    }
    
    // Check if date is within range
    function isDateInRange(date, fromDate, toDate) {
      if (!date) return false;
      
      const checkDate = parseDate(date);
      if (!checkDate) return false;
      
      const from = new Date(fromDate);
      const to = new Date(toDate);
      to.setHours(23, 59, 59, 999); // Include the entire end date
      
      return checkDate >= from && checkDate <= to;
    }
    
    // Fetch data from a Firebase path
    async function fetchData(path) {
      try {
        const snapshot = await database.ref(path).once('value');
        return snapshot.val() || {};
      } catch (error) {
        console.error(`Error fetching data from ${path}:`, error);
        return {};
      }
    }
    
    // Generate vehicle report with REAL data
    async function generateVehicleReport() {
      const fromDate = document.getElementById("reportFrom").value;
      const toDate = document.getElementById("reportTo").value;
      
      if (!fromDate || !toDate) {
        showError("Please select both from and to dates");
        return;
      }
      
      if (!selectedVehicle) {
        showError("Please select a vehicle first");
        return;
      }
      
      // Show loading state
      generatePdfBtn.innerHTML = '<span class="loading"></span> Generating...';
      generatePdfBtn.disabled = true;
      
      // Show report status modal
      showReportStatus();
      updateReportProgress(10, "Fetching vehicle details...");
      
      try {
        // Try to fetch vehicle details from the user's vehicles node
        updateReportProgress(20, "Fetching vehicle details...");
        let vehicleData = {};
        
        try {
          // First try the user's vehicles node
          const userVehiclesRef = database.ref(`users/${currentUser.uid}/vehicles`);
          const snapshot = await userVehiclesRef.once('value');
          const vehicles = snapshot.val() || {};
          
          // Find the vehicle by number
          const vehicleKey = Object.keys(vehicles).find(key => {
            return vehicles[key].vehicleNumber === selectedVehicle;
          });
          
          if (vehicleKey) {
            vehicleData = vehicles[vehicleKey];
          } else {
            console.warn("Vehicle not found in user's vehicles, trying alternative...");
            // Fallback to the vehicle number as the key
            const vehicleRef = database.ref(`users/${currentUser.uid}/vehicles/${selectedVehicle.replace(/\s+/g, '')}`);
            const vehicleSnapshot = await vehicleRef.once('value');
            if (vehicleSnapshot.exists()) {
              vehicleData = vehicleSnapshot.val();
            }
          }
        } catch (error) {
          console.warn("Error fetching vehicle details:", error);
          // Continue with empty vehicle data
        }
        
        updateReportProgress(30, "Fetching trip data...");
        
        // Fetch LR Reports data with proper error handling
        let filteredLrReports = [];
        try {
          console.log('Fetching LR reports for vehicle:', selectedVehicle);
          
          // First try the user's lrReports node
          const userLrReportsRef = database.ref(`users/${currentUser.uid}/lrReports`);
          const userLrReportsSnapshot = await userLrReportsRef.once('value');
          const userLrReports = userLrReportsSnapshot.val() || {};
          
          // Then try the global lrReports node
          const globalLrReportsRef = database.ref('lrReports');
          const globalLrReportsSnapshot = await globalLrReportsRef.once('value');
          const globalLrReports = globalLrReportsSnapshot.val() || {};
          
          // Combine both results
          const allLrReports = {...userLrReports, ...globalLrReports};
          console.log('Raw LR reports data:', allLrReports);
          
          // Convert dates to Date objects for comparison
          const fromDateObj = fromDate ? new Date(fromDate) : null;
          const toDateObj = toDate ? new Date(toDate) : null;
          if (toDateObj) {
            toDateObj.setHours(23, 59, 59, 999); // End of the day
          }

          // Filter LR reports by date range and status
          filteredLrReports = Object.entries(allLrReports).map(([key, report]) => {
            return {
              ...report,
              id: key // Include the Firebase key for debugging
            };
          }).filter(report => {
            console.log('Processing report:', report.id, 'with truckNumber:', report.truckNumber, 'date:', report.date);
            
            // Check if this report belongs to the selected vehicle
            if (report.truckNumber !== selectedVehicle) {
              console.log('Skipping - truck number mismatch:', report.truckNumber);
              return false;
            }
            
            // Check if report has a valid date
            const reportDate = report.date ? new Date(report.date) : null;
            if (!reportDate || isNaN(reportDate.getTime())) {
              console.log('Skipping - invalid date:', report.date);
              return false;
            }
            
            // Check date range
            if (fromDateObj && reportDate < fromDateObj) {
              console.log('Skipping - before from date');
              return false;
            }
            if (toDateObj && reportDate > toDateObj) {
              console.log('Skipping - after to date');
              return false;
            }
            
            console.log('Including report:', report.id);
            return true;
          });
          
          console.log('Filtered reports count:', filteredLrReports.length);
          console.log('Sample filtered report:', filteredLrReports[0]);
        } catch (error) {
          console.warn("Error fetching LR reports:", error);
          // Continue with empty array if LR reports fail
        }
        
        // Get tyre information for this vehicle
        updateReportProgress(50, "Fetching tyre information...");
        console.log('Selected vehicle for tyre lookup:', selectedVehicle);
        console.log('Current tyreData state:', JSON.stringify(tyreData, null, 2));
        
        const vehicleTyres = getTyresForVehicle(selectedVehicle);
        console.log('Vehicle tyres for report:', JSON.stringify(vehicleTyres, null, 2));
        
        // Debug: Check if we have any tyres at all
        const totalTyres = Object.keys(tyreData || {}).length;
        console.log(`Total tyres in database: ${totalTyres}`);
        
        if (totalTyres > 0 && vehicleTyres.length === 0) {
          console.warn('No tyres found for vehicle, but tyres exist in database. Possible vehicle number mismatch.');
          console.log('All vehicle numbers in tyres:', 
            Object.entries(tyreData).map(([key, t]) => ({
              key,
              vehicleNumber: t.vehicleNumber || t.truckNumber || t.vehicleNo,
              tyreNumber: t.tyreNumber,
              brand: t.brand,
              size: t.size,
              position: t.position,
              status: t.status,
              purchaseDate: t.purchaseDate
            }))
          );
        }
        
        // Calculate LR report statistics with debug logging
        console.log('Calculating statistics for', filteredLrReports.length, 'reports');
        
        const totalTrips = filteredLrReports.length;
        console.log('Total trips:', totalTrips);
        
        const totalFreight = filteredLrReports.reduce((sum, report, index) => {
          const amount = parseFloat(report.freightAmount) || parseFloat(report.totalAmount) || 0;
          console.log(`Report ${index + 1} freight:`, amount);
          return sum + amount;
        }, 0);
        console.log('Total freight:', totalFreight);
        
        const totalBilling = filteredLrReports.reduce((sum, report, index) => {
          const amount = parseFloat(report.billingAmount) || 0;
          console.log(`Report ${index + 1} billing:`, amount);
          return sum + amount;
        }, 0);
        console.log('Total billing:', totalBilling);
        
        // Calculate income and costs
        const totalIncome = totalFreight + totalBilling;
        
        // Create PDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Add title
        doc.setFontSize(20);
        doc.setTextColor(40, 40, 40);
        doc.text(`Vehicle Report: ${selectedVehicle}`, 105, 20, { align: 'center' });
        
        // Add date range
        doc.setFontSize(12);
        doc.setTextColor(100, 100, 100);
        doc.text(`From: ${formatDateForDisplay(fromDate)} to ${formatDateForDisplay(toDate)}`, 105, 30, { align: 'center' });
        
        // Add a line separator
        doc.setDrawColor(200, 200, 200);
        doc.line(20, 40, 190, 40);
        
        // Add Vehicle Details section
        doc.setFontSize(14);
        doc.setTextColor(46, 139, 87);
        doc.text('Vehicle Details', 20, 55);
        
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        
        // Vehicle information
        let yPos = 65;
        doc.text(`Vehicle Number: ${selectedVehicle}`, 20, yPos);
        yPos += 7;
        doc.text(`Vehicle Type: ${vehicleData.vehicleType || 'N/A'}`, 20, yPos);
        yPos += 7;
        doc.text(`Driver Name: ${vehicleData.driverName || 'N/A'}`, 20, yPos);
        yPos += 7;
        doc.text(`Driver License: ${vehicleData.driverLicense || 'N/A'}`, 20, yPos);
        yPos += 7;
        doc.text(`Contact Number: ${vehicleData.contactNumber || 'N/A'}`, 20, yPos);
        yPos += 12;
        
        // Document Status
        doc.setFontSize(14);
        doc.setTextColor(46, 139, 87);
        doc.text('Document Status', 20, yPos);
        yPos += 10;
        
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        
        // Document information
        doc.text(`License: ${vehicleData.licenseImageUrl ? 'Available' : 'Not Available'}`, 20, yPos);
        yPos += 7;
        doc.text(`PUC: ${vehicleData.pucUrl ? 'Available' : 'Not Available'}`, 20, yPos);
        yPos += 7;
        doc.text(`Insurance: ${vehicleData.insuranceUrl ? 'Available' : 'Not Available'}`, 20, yPos);
        yPos += 7;
        doc.text(`Fitness: ${vehicleData.fitnessUrl ? 'Available' : 'Not Available'}`, 20, yPos);
        yPos += 12;
        
        // Add Tyre Information section if tyres exist
        if (vehicleTyres.length > 0) {
          doc.setFontSize(14);
          doc.setTextColor(46, 139, 87);
          doc.text('Current Tyres', 20, yPos);
          yPos += 10;
          
          // Debug: Log the exact data being passed to the PDF table
          console.log('Data being passed to tyre table:', JSON.stringify(vehicleTyres.map(tyre => ({
            tyreNumber: tyre.tyreNumber,
            brand: tyre.brand,
            size: tyre.size,
            position: tyre.position,
            status: tyre.status,
            purchaseDate: tyre.purchaseDate,
            formattedDate: tyre.purchaseDate ? formatDateForDisplay(tyre.purchaseDate) : 'N/A'
          })), null, 2));
          
          // Create a table for tyre information using autoTable
          doc.autoTable({
            startY: yPos,
            head: [['Tyre Number', 'Brand', 'Size', 'Position']],
            body: vehicleTyres.map(tyre => [
              tyre.tyreNumber || '-',
              tyre.brand || '-',
              tyre.size || '-',
              tyre.position || '-'
            ]),
            theme: 'grid',
            headStyles: {
              fillColor: [52, 152, 219],
              textColor: [255, 255, 255],
              fontStyle: 'bold'
            },
            styles: {
              fontSize: 9,
              cellPadding: 3
            },
            margin: { top: 20 }
          });
          
          // Update y position after the table
          yPos = doc.lastAutoTable.finalY + 10;
        } else {
          doc.setFontSize(10);
          doc.setTextColor(100, 100, 100);
          doc.text('No tyre information available', 20, yPos);
          yPos += 10;
        }
        
        // Check if we need a new page for the next section
        if (yPos > 200) {
          doc.addPage();
          yPos = 20;
        }
        
        // Add trip statistics section
        doc.setFontSize(14);
        doc.setTextColor(46, 139, 87);
        doc.text('Trip Statistics', 20, yPos);
        yPos += 10;
        
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        
        // Trip information
        doc.text(`Report Period: ${formatDateForDisplay(fromDate)} to ${formatDateForDisplay(toDate)}`, 20, yPos);
        yPos += 7;
        doc.text(`Total Trips: ${totalTrips}`, 20, yPos);
        yPos += 12;
        
        // Check if we need a new page for the income section
        if (yPos > 220) {
          doc.addPage();
          yPos = 20;
        }
        
        // Income section
        doc.setFontSize(14);
        doc.setTextColor(46, 139, 87);
        doc.text('Income & Expenses', 20, yPos);
        yPos += 10;
        
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        
        // Income details
        doc.text('Income:', 20, yPos);
        doc.text(`Total Freight: ${totalFreight.toFixed(2)}`, 30, yPos + 7);
        doc.text(`Total Billing: ${totalBilling.toFixed(2)}`, 30, yPos + 14);
        doc.text(`Total Income: ${totalIncome.toFixed(2)}`, 30, yPos + 21);
        
        // Add a simple chart for visualization
        const chartY = yPos + 40;
        const chartHeight = 30;
        const chartWidth = 150;
        const maxValue = Math.max(totalIncome, 1000); // Ensure minimum width for visibility


                // Income bar
                const incomeWidth = (totalIncome / maxValue) * chartWidth;
        doc.setFillColor(46, 139, 87);
        doc.rect(30, chartY, Math.max(incomeWidth, 5), chartHeight / 2, 'F');
        doc.setFontSize(8);
        doc.text(`${totalIncome.toFixed(2)}`, 35, chartY + 5);
        
        // Add footer
        doc.setFontSize(8);
        doc.setTextColor(150, 150, 150);
        doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 280, { align: 'center' });
        
        // Save the PDF
        doc.save(`Vehicle_Report_${selectedVehicle}_${fromDate}_to_${toDate}.pdf`);
        
        // Hide status modal
        hideReportStatus();
        
        // Show success message
        showSuccess(`Report generated for ${selectedVehicle}`);
        
      } catch (error) {
        console.error("Error generating report:", error);
        hideReportStatus();
        showError(`Failed to generate report: ${error.message || 'Unknown error'}`);
      } finally {
        // Reset button state
        generatePdfBtn.innerHTML = '<i class="fas fa-file-pdf"></i> Generate PDF';
        generatePdfBtn.disabled = false;
      }
    }
    
    // Search and filter functionality
    searchInput.addEventListener("input", filterTable);
    typeFilter.addEventListener("change", filterTable);
    
    function filterTable() {
      try {
        if (!searchInput || !typeFilter || !tableBody) return;
        
        const searchText = searchInput.value ? searchInput.value.toLowerCase() : '';
        const filterValue = typeFilter.value || '';
        const rows = tableBody.querySelectorAll("tr");
        
        rows.forEach(row => {
          if (!row || !row.cells || row.cells.length < 3) {
            console.warn('Invalid row structure:', row);
            return;
          }
          
          const vehicleNumber = row.cells[0]?.textContent?.toLowerCase() || '';
          const vehicleType = row.cells[1]?.textContent || '';
          const driverName = row.cells[2]?.textContent?.toLowerCase() || '';
          
          const matchesSearch = searchText === '' || 
            vehicleNumber.includes(searchText) || 
            driverName.includes(searchText);
            
          const matchesFilter = filterValue === '' || 
            vehicleType === filterValue;
          
          row.style.display = matchesSearch && matchesFilter ? '' : 'none';
        });
      } catch (error) {
        console.error('Error in filterTable:', error);
      }
    }
    
    // Cancel edit button event
    cancelEditBtn.addEventListener('click', cancelEdit);
    
    // Generate PDF button event
    generatePdfBtn.addEventListener('click', generateVehicleReport);
    
    // Initialize the application
    initApp();
  </script>
</body>
</html>


