<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LR Management - Transport System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <style>
    body { padding: 0; margin: 0; background-color: #f8f9fa; }
    .tab-content { background: white; padding: 20px; border-radius: 0 0 8px 8px; }

    /* --- INVOICE MODAL & PRINT STYLES (Copied from invoice.html) --- */
    @media print {
      body * { visibility: hidden; }
      #invoiceDetailModal .modal-content {
          visibility: hidden; 
      }
      #printableInvoiceDetail, #printableInvoiceDetail * { 
          visibility: visible; 
      }
      #printableInvoiceDetail {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        min-height: 100vh; 
        page-break-before: always;
        page-break-after: always;
        overflow: visible;
      }
      .modal-footer, .style-panel-section { display: none !important; }
      
      .invoice-theme-color { color: #000 !important; }
      .invoice-theme-bg { background-color: #f0f0f0 !important; border-color: #000 !important; color: #000 !important;}
      .table-zebra-stripe { background-color: #f0f0f0 !important; }

      .table-responsive { overflow: visible !important; }
    }
    
    .hidden-print { display: none !important; }

    .paid-stamp, .partial-stamp, .pending-stamp {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-25deg);
      font-weight: 700;
      border: 8px solid;
      padding: 10px 25px;
      border-radius: 15px;
      opacity: 0.2;
      text-transform: uppercase;
      z-index: 1000;
      pointer-events: none;
    }
    .paid-stamp { font-size: 6rem; color: red; border-color: red; }
    .partial-stamp { font-size: 4rem; color: #ff8c00; border-color: #ff8c00; opacity: 0.35; }
    .pending-stamp { font-size: 6rem; color: #6c757d; border-color: #6c757d; }

    .invoice-header-box {
        display: flex;
        justify-content: space-between;
        margin-bottom: 25px;
    }
    .company-details-left {
        width: 45%;
    }
    .invoice-details-right {
        width: 45%;
        text-align: right;
    }
    .invoice-title {
        font-size: 32px;
        font-weight: 800;
        margin-bottom: 10px;
    }
    .logo-placeholder {
        width: 100px;
        height: 100px;
        background-color: #ccc;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #666;
        margin-left: auto;
        margin-bottom: 15px;
    }
    .logo-on-print {
        max-width: 100px;
        max-height: 100px;
        margin-left: auto;
        margin-bottom: 15px;
        display: block;
    }
    .billing-shipping-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
        border-bottom: 1px solid #ddd;
        padding-bottom: 10px;
    }
    .bill-to-box {
        width: 45%;
        border: 1px solid #ccc;
        padding: 15px;
    }
    .ship-to-box {
        width: 45%;
        border: 1px solid #ccc;
        padding: 15px;
    }

    .company-seal {
        width: 180px; 
        height: 180px; 
        margin: 0 auto; 
        display: block; 
    }
    
    .invoice-theme-color { transition: color 0.3s; }
    .invoice-theme-bg { 
        transition: background-color 0.3s, border-color 0.3s; 
        color: #fff !important;
    }
    .table-zebra-stripe {
        background-color: rgba(0, 0, 0, 0.03);
    }

    .invoice-preview-container {
        max-height: 80vh; 
        overflow: auto; /* Combined scroll for both axes */
    }

    /* Responsive adjustments for the invoice modal */
    @media (min-width: 992px) {
        .invoice-preview-container {
            padding-right: 15px;
            border-right: 1px solid #ccc;
        }
    }
    @media (max-width: 991.98px) {
        .style-panel-section { margin-bottom: 2rem; }
    }
    
    #styleSettingsPanel {
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    /* --- END INVOICE STYLES --- */
    
    /* Vehicle Validation Styles */
    .vehicle-suggestions {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      width: calc(100% - 30px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .lr-copy-container {
      font-family: Arial, sans-serif;
      font-size: 14px;
      color: #333;
      padding: 20px;
      background: #ffffff;
      max-width: 800px; /* Max-width for screen view */
      margin: 0 auto;
    }
    .lr-header {
      text-align: center;
      margin-bottom: 15px;
    }
    .lr-header h4 {
      margin: 0;
      font-size: 18px;
      font-weight: bold;
    }
    .lr-header p {
      margin: 5px 0 0 0;
    }
    .lr-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      /* IMPROVED RESPONSIVENESS FOR SMALL SCREENS */
      flex-wrap: wrap; 
    }
    .lr-info-left, .lr-info-right {
      width: 48%;
      /* IMPROVED RESPONSIVENESS FOR SMALL SCREENS */
      min-width: 300px; 
      margin-bottom: 10px;
    }
    .lr-row {
      margin-bottom: 10px;
    }
    .lr-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    .lr-table th, .lr-table td {
      border: 1px solid #000;
      padding: 8px;
      text-align: left;
    }
    .lr-table th {
      background-color: #f2f2f2;
    }
    .safety-section {
      margin-top: 20px;
      border-top: 1px solid #ddd;
      padding-top: 10px;
    }
    .receipt-section {
      margin-top: 20px;
      border-top: 1px solid #ddd;
      padding-top: 10px;
    }
    .lr-footer {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
      /* IMPROVED RESPONSIVENESS FOR SMALL SCREENS */
      flex-wrap: wrap; 
    }
    .signature-box {
      width: 45%;
      text-align: center;
      /* IMPROVED RESPONSIVENESS FOR SMALL SCREENS */
      min-width: 250px; 
    }
    .signature-line {
      margin-top: 50px;
      border-top: 1px solid #000;
    }
    .terms-conditions {
      margin-top: 25px;
      padding: 15px;
      font-size: 12px;
    }
    @media print {
      body {
        background-color: #ffffd9;
        padding: 0;
      }
      .lr-copy-container {
        box-shadow: none;
        max-width: 100%; /* FIX: Ensure full width for print/PDF on all devices */
      }
      .no-print {
        display: none;
      }
      /* **NEW**: Hide elements based on print settings */
      .printable-area .logo-on-print.hidden-print { display: none !important; }
      .printable-area .stamp-on-print.hidden-print { display: none !important; }
    }
    /* **FIX**: Add rule for live view toggling */
    .hidden-print {
      display: none !important;
    }
    .lr-header-content {
      display: flex; align-items: center; justify-content: center; gap: 20px;
      /* IMPROVED RESPONSIVENESS FOR SMALL SCREENS */
      /* MODIFIED: Changed from center to space-between for better logo placement */
      justify-content: space-between;
      text-align: left; /* Align text to the left within the details block */
      width: 100%;
      flex-wrap: wrap; 
    }
    .terms-conditions h6 {
      margin-top: 0;
      color: #2c3e50;
    }
    .lr-barcode {
      text-align: center;
      margin: 20px 0;
      padding: 10px;
      border-top: 1px dashed #ccc;
      border-bottom: 1px dashed #ccc;
    }

    .vehicle-suggestion {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .vehicle-suggestion:hover {
      background-color: #f8f9fa;
    }

    .vehicle-suggestion:last-child {
      border-bottom: none;
    }

    .vehicle-not-found {
      color: #dc3545;
      font-size: 0.875em;
      margin-top: 5px;
      display: none;
    }

    .vehicle-input-container {
      position: relative;
    }

    .vehicle-valid {
      border-color: #28a745 !important;
    }

    .vehicle-invalid {
      border-color: #dc3545 !important;
    }

    /* Custom style for the client dropdown */
    #clientId {
      color: #2E8B57;
      font-weight: 500;
    }
    
    .lr-copy-container {
      font-family: Arial, sans-serif;
      font-size: 14px;
      color: #333;
      padding: 20px;
      background: #ffffff;
      max-width: 800px;
      margin: 0 auto;
    }

    /* Expense Entry Styling */
    .expense-entry-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e9ecef;
      padding: 10px;
      border-radius: 4px;
    }
    
    /* New Tab Styles for Trip Details Modal */
    .trip-details-nav .nav-link {
      color: #495057;
      font-weight: 600;
      border-bottom: 3px solid transparent;
      border-top-left-radius: .5rem;
      border-top-right-radius: .5rem;
    }
    .trip-details-nav .nav-link.active {
      color: #0d6efd;
      background-color: #e9ecef;
      border-color: #0d6efd;
    }
    .trip-details-tab-content {
      background-color: #f8f9fa;
      padding: 1.5rem;
      border: 1px solid #dee2e6;
      border-top: none;
      border-radius: 0 0 .5rem .5rem;
    }
    .expense-row {
      transition: all 0.3s ease-in-out;
    }
    
    /* --- FIX: CSS/Layout Changes for 'Add New LR' Form --- */
    /* Add spacing for input groups */
    .input-group {
      margin-bottom: 15px; /* Add margin below input-group elements */
    }

    /* Target form-select elements for uniform height with text inputs */
    .form-select, .form-control {
      height: calc(1.5em + 0.75rem + 2px); /* Standard Bootstrap height */
    }

    /* Improve form label alignment for better readability */
    .form-label {
      font-weight: 500;
      margin-bottom: 0.25rem;
    }
    /* --- END FIX --- */

  </style>
</head>
<body>

  <div id="navbar-placeholder"></div>

  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="mb-0"><i class="fas fa-file-invoice me-2"></i>LR Management</h2>
      <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#autoGenerationSettingsModal">
        <i class="fas fa-cog me-2"></i>Settings
      </button>
    </div>
    
    <ul class="nav nav-tabs" id="lrTabs">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#view">View Entries</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#add">Add New LR</a>
      </li>
    </ul>

    <div class="tab-content">
      <div class="tab-pane fade show active" id="view">
        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label">From Date</label>
            <input type="date" class="form-control" id="fromDate">
          </div>
          <div class="col-md-3">
            <label class="form-label">To Date</label>
            <input type="date" class="form-control" id="toDate">
          </div>
          <div class="col-md-3">
            <label class="form-label">Truck Number</label>
            <select class="form-select" id="truckFilter">
              <option value="">All Trucks</option>
            </select>
          </div>
          <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-primary me-2" id="applyFiltersBtn">Filter</button>
            <button class="btn btn-success" id="exportPdfBtn">PDF</button>
          </div>
        </div>

        <ul class="nav nav-pills mb-3" id="lrViewTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="own-lrs-tab" data-bs-toggle="tab" data-bs-target="#own-lrs-content" type="button" role="tab">Own Company LRs</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="market-lrs-tab" data-bs-toggle="tab" data-bs-target="#market-lrs-content" type="button" role="tab">Market company LRs</button>
          </li>
        </ul>

        <div class="tab-content" id="lrViewTabsContent">
          <div class="tab-pane fade show active" id="own-lrs-content" role="tabpanel">
            <div class="mb-3">
              <button class="btn btn-primary" id="generateInvoiceBtn" onclick="showBankDetailsModal()" disabled>
                <i class="fas fa-file-invoice me-2"></i>Generate Client Invoice
              </button>
            </div>
            <div class="table-responsive">
              <table id="lrTable" class="table table-striped">
                <thead>
                  <tr>
                    <th>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAllCheckbox" onclick="toggleSelectAll()">
                      </div>
                    </th>
                    <th>Date</th>
                    <th>LR No</th>
                    <th>Truck No</th>
                    <th>Consignor</th>
                    <th>Consignee</th>
                    <th>Item</th>
                    <th>From</th>
                    <th>To</th>
                    <th>Weight</th>
                    <th><i class="fas fa-plus"></i> Details</th>
                    <th>Status</th>
                    <th>LR Copy</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  </tbody>
              </table>
            </div>
          </div>

          <div class="tab-pane fade" id="market-lrs-content" role="tabpanel">
            <div class="mb-3">
              <button class="btn btn-info" id="generateMarketInvoiceBtn" onclick="showBankDetailsModal(true)" disabled>
                <i class="fas fa-file-invoice me-2"></i>Generate Market Invoice
              </button>
            </div>
            <div class="table-responsive">
              <table id="marketLrTable" class="table table-striped">
                <thead>
                  <tr>
                    <th>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAllMarketCheckbox" onclick="toggleSelectAll(true)">
                      </div>
                    </th>
                    <th>Date</th>
                    <th>LR No</th>
                    <th>Truck No</th>
                    <th>Market Company</th>
                    <th>Item</th>
                    <th>From</th>
                    <th>To</th>
                    <th>Weight</th>
                    <th><i class="fas fa-plus"></i> Details</th>
                    <th>Status</th>
                    <th>LR Copy</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  </tbody>
              </table>
            </div>
          </div>
        </div>
        </div>

      <div class="tab-pane fade" id="add">
        <form id="lrForm">
          <div class="card mb-4">
            <div class="card-header bg-light">
              <h5 class="mb-0"><i class="fas fa-file-invoice me-2"></i>Basic LR Information</h5>
            </div>
            <div class="card-body">
              <div class="row mb-3">
                <div class="col-md-3">
                  <label for="lrDate" class="form-label">Date*</label>
                  <input type="date" class="form-control" id="lrDate" required />
                </div>
                <div class="col-md-3">
                  <label for="lrNumber" class="form-label">LR Number <span class="text-danger">*</span></label>                  
                  <input type="text" class="form-control" id="lrNumber" required placeholder="Auto-generated" />
                </div>
                <div class="col-md-6 vehicle-input-container">
                  <div class="form-check form-switch mb-2 pt-1">
                    <input class="form-check-input" type="checkbox" role="switch" id="vehicleTypeToggle" onchange="toggleVehicleInput(this.checked)">
<label class="form-check-label" for="vehicleTypeToggle">Use Market Vehicle</label>
                  </div>
                  <div id="ownVehicleFields">
                    <label for="truckNumber" class="form-label">Own Truck Number <span class="text-danger">*</span></label>
                    <div class="input-group">
                      <select id="truckNumber" class="form-select" required></select>
                      <button class="btn btn-outline-success" type="button" id="quickAddVehicleBtn" title="Add New Vehicle"><i class="fas fa-plus"></i></button>
                    </div>
                  </div>                  
                  <div id="marketVehicleFields" style="display: none;">
                    <label for="marketTruckNumber" class="form-label">Market Truck Number <span class="text-danger">*</span></label>
                    <input type="text" id="marketTruckNumber" class="form-control" placeholder="Enter vehicle number">
                  </div>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-3">
                  <label for="invoiceNumberInput" class="form-label">Invoice No.</label>
                  <input type="text" class="form-control" id="invoiceNumberInput" placeholder="Auto-generated" />
                </div>
                <div class="col-md-3">
<label for="shipmentNo" class="form-label">Shipment No</label>
                  <input type="text" class="form-control" id="shipmentNo" placeholder="Auto-generated" />
                </div>
                <div class="col-md-3">
                  <label class="form-label">Delivery No</label>
                  <input type="text" class="form-control" id="deliveryNo" placeholder="Auto-generated">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Order No</label>
                  <input type="text" class="form-control" id="orderNo" placeholder="Auto-generated">
                </div>
              </div>
              <div class="row">
                <div class="col-md-4 mb-3">                  
                  <div id="ownDriverField">
                    <label for="driverSelect" class="form-label">Driver</label>
                    <div class="input-group">
                      <select id="driverSelect" class="form-select"></select>
                      <button class="btn btn-outline-success" type="button" id="quickAddDriverBtn" title="Add New Driver"><i class="fas fa-plus"></i></button>
                    </div>
                  </div>
                  <div id="marketDriverField" style="display: none;">
                    <label for="marketDriverName" class="form-label">Driver Name</label>
                    <input type="text" id="marketDriverName" class="form-control" placeholder="Enter driver's name">
                  </div>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="clientId" class="form-label">Billed To (Client)*</label>
                  <div class="input-group">
                    <select id="clientId" class="form-select" required onchange="window.updateConsigneeFromClient()"></select>
                    <button class="btn btn-outline-success" type="button" id="quickAddClientBtn" title="Add New Client"><i class="fas fa-plus"></i></button>
                  </div>
                </div>
                <div class="col-md-4 mb-3">
                  <div id="transporterField" style="display: block;">
                    <label for="transporterSelect" class="form-label">Transporter</label>
                    <div class="input-group">
                      <select id="transporterSelect" class="form-select"></select>
                      <button class="btn btn-outline-success" type="button" id="quickAddTransporterBtn" title="Add New Transporter"><i class="fas fa-plus"></i></button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="employeeSelect" class="form-label">Employee</label>
                  <select id="employeeSelect" class="form-select">
                    <option value="">Select Employee</option>
                  </select>
                  <small class="text-muted">Select the employee managing this LR</small>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Route (From --> To) <span class="text-danger">*</span></label>
                  <div class="input-group">
                    <select class="form-select" id="routeSelect" required></select>
                    <button class="btn btn-outline-success" type="button" id="quickAddRouteBtn" title="Add New Route"><i class="fas fa-plus"></i></button>
                  </div>
                </div>
            </div>
          </div>
          <div class="card mb-4">
            <div class="card-header bg-light">
              <h5 class="mb-0"><i class="fas fa-box me-2"></i>Shipment Details</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="consigneeId" class="form-label">Consignee <span class="text-danger">*</span></label>
                  <div class="input-group">
                    <select id="consigneeId" class="form-select" required></select>
                    <button class="btn btn-outline-success" type="button" id="quickAddConsigneeBtn" title="Add New Consignee"><i class="fas fa-plus"></i></button>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Item</label>
                  <input type="text" class="form-control" id="item" placeholder="e.g., Cement Bags, Steel Bars">
                </div>
              </div>
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label class="form-label">Number of Packages</label>
                  <input type="number" class="form-control" id="numPackages" placeholder="For package goods" oninput="calculateWeightFromPackages()">
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">Weight per Package (kg)</label>
                  <input type="number" step="0.01" class="form-control" id="weightPerPackage" placeholder="e.g., 50" oninput="calculateWeightFromPackages()">
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">Weight (tonne) <span class="text-danger">*</span></label>
                  <input type="number" class="form-control" id="weight" step="0.01" required oninput="handleManualWeightInput()" placeholder="Total weight in MT">
                </div>
              </div>
            </div>
          </div>
          
          <button type="button" class="btn btn-primary" id="saveLRBtn">Save LR</button>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="autoGenerationSettingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title"><i class="fas fa-cog me-2"></i>Auto-Generation Settings</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted">Toggle which numbers should be auto-generated by the system.</p>
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="autoGenerateLrNo" checked>
            <label class="form-check-label" for="autoGenerateLrNo">Auto-generate LR Number</label>
          </div>
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="autoGenerateInvoiceNo" checked>
            <label class="form-check-label" for="autoGenerateInvoiceNo">Auto-generate Invoice Number</label>
          </div>
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="autoGenerateShipmentNo" checked>
            <label class="form-check-label" for="autoGenerateShipmentNo">Auto-generate Shipment No.</label>
          </div>
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="autoGenerateOrderNo" checked>
            <label class="form-check-label" for="autoGenerateOrderNo">Auto-generate Order No.</label>
          </div>
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="autoGenerateDeliveryNo" checked>
            <label class="form-check-label" for="autoGenerateDeliveryNo">Auto-generate Delivery No.</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="saveAutoGenerationSettings()" data-bs-dismiss="modal">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="tripDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title"><i class="fas fa-file-invoice-dollar me-2"></i>Trip Financials for LR: <span id="modalLrNumber"></span></h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <ul class="nav nav-tabs trip-details-nav" id="tripDetailsTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="billing-tab" data-bs-toggle="tab" data-bs-target="#billing-content" type="button" role="tab">1. Billing & Freight</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="fuel-tab" data-bs-toggle="tab" data-bs-target="#fuel-content" type="button" role="tab">2. KM & Fuel Usage</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="fuel-entry-tab" data-bs-toggle="tab" data-bs-target="#fuel-entry-content" type="button" role="tab" onclick="loadFuelPumps()">3. Fuel Entry</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="expenses-tab" data-bs-toggle="tab" data-bs-target="#expenses-content" type="button" role="tab">4. Trip Expenses</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="empty-expenses-tab" data-bs-toggle="tab" data-bs-target="#empty-expenses-content" type="button" role="tab">5. Empty Trip Expenses</button>
            </li>
          </ul>

          <div class="tab-content trip-details-tab-content" id="tripDetailsTabsContent">
            <div class="tab-pane fade show active" id="billing-content" role="tabpanel">
              <div class="card">
                <div class="card-body">
                  <div class="row align-items-end">
                    <div class="col-md-3 mb-3">
                      <label class="form-label">Billing Rate (₹/tonne)</label>
                      <input type="number" step="0.01" class="form-control" id="tripBillingRate" oninput="calculateTripBillingAmount()">
                    </div>
                    <div class="col-md-3 mb-3">
                      <label class="form-label">Billing Amount (₹)</label>
                      <input type="number" step="0.01" class="form-control" id="tripBillingAmount" oninput="calculateTripBillingRate()">
                    </div>
                    <div class="col-md-3 mb-3">
                      <label class="form-label">Freight Rate (₹/tonne)</label>
                      <input type="number" step="0.01" class="form-control" id="tripFreightRate" oninput="calculateTripFreightAmount()">
                    </div>
                    <div class="col-md-3 mb-3">
                      <label class="form-label">Freight Amount (₹)</label>
                      <input type="number" step="0.01" class="form-control" id="tripFreightAmount" oninput="calculateTripFreightRate()">
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3" id="tripAdvanceField">
                      <div class="row g-2">
                        <div class="col-7">
                          <label class="form-label">Driver Advance (₹)</label>
                          <input type="number" step="0.01" class="form-control" id="tripAdvance" value="0" oninput="calculateTripTotals()">
                        </div>
                        <div class="col-5">
                          <label class="form-label">Payment Mode</label>
                          <select id="tripAdvancePaymentMode" class="form-select">
                            <option value="Cash">Cash</option><option value="UPI">UPI</option><option value="Bank Transfer">Bank Transfer</option>
                          </select>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Shortage (kg)</label>
                      <input type="number" step="0.01" class="form-control" id="tripShortage" value="0" placeholder="Shortage in kg">
                    </div>
                    <div class="col-md-6 mb-3" id="commissionField" style="display: none;">
                      <label class="form-label fw-bold text-success">Commission (₹)</label>
                      <input type="number" step="0.01" class="form-control" id="tripCommission" placeholder="Your commission from this trip">
                    </div>
                  </div>
                  <hr>
                  <div class="row">
                    <div class="col-md-4 mb-3">
                      <label class="form-label">CGST %</label>
                      <input type="number" step="0.01" class="form-control" id="tripCgstPercentage" value="9" oninput="calculateTripTotals()">
                    </div>
                    <div class="col-md-4 mb-3">
                      <label class="form-label">SGST %</label>
                      <input type="number" step="0.01" class="form-control" id="tripSgstPercentage" value="9" oninput="calculateTripTotals()">
                    </div>
                    <div class="col-md-4 mb-3">
                      <label class="form-label">Total Billing (Incl. GST)</label>
                      <input type="number" step="0.01" class="form-control bg-success-subtle" id="tripTotalBillingAmount" readonly>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-pane fade" id="fuel-content" role="tabpanel">
              <div class="card">
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-4 mb-3">
                      <label class="form-label">Starting KM</label>
                      <input type="number" min="0" class="form-control" id="tripStartingKm" oninput="calculateTotalKm()">
                    </div>
                    <div class="col-md-4 mb-3">
                      <label class="form-label">Ending KM</label>
                      <input type="number" min="0" class="form-control" id="tripEndingKm" oninput="calculateTotalKm()">
                    </div>
                    <div class="col-md-4 mb-3">
                      <label class="form-label">Total Distance (KM)</label>
                      <input type="number" class="form-control bg-light" id="tripTotalKm" readonly>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-4 mb-3">
                      <label class="form-label">Vehicle Avg (km/l)</label>
                      <input type="number" step="0.01" min="0" class="form-control" id="tripVehicleAverage" oninput="calculateFuelUsed()">
                    </div>
                    <div class="col-md-4 mb-3">
                      <label class="form-label">Fuel Used (Litres)</label>
                      <input type="number" step="0.01" min="0" class="form-control bg-light" id="tripFuelUsedLiters" readonly>
                    </div>
                    <div class="col-md-4 mb-3">
                      <label class="form-label">Fuel Rate (₹/L)</label>
                      <input type="number" step="0.01" min="0" class="form-control" id="tripDieselRatePerLiter" oninput="calculateFuelAmount()">
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="tab-pane fade" id="fuel-entry-content" role="tabpanel">
              <div class="card mb-3">
                <div class="card-body bg-light">
                  <div class="row align-items-center">
                    <div class="col-md-6">
                      <h6 class="mb-0">Selected Truck: <strong id="fuelEntryTruckNumber">N/A</strong></h6>
                    </div>
                    <div class="col-md-6 text-end">
                      <h6 class="mb-0">Current Tank Level: <strong id="currentFuelLevel" class="text-secondary">-- L</strong></h6>
                    </div>
                  </div>
                </div>
              </div>
              <form id="fuelEntryForm">
                <h5 class="mb-3">Record Fuel Fill-up (Adds to Inventory)</h5>
                <div class="row">
                  <div class="col-md-3 mb-3">
                    <label for="fuelPumpSelect" class="form-label">Select Pump <span class="text-danger">*</span></label>
                    <select id="fuelPumpSelect" class="form-select" required>
                      <option value="">Select a Pump</option>
                    </select>
                  </div>
                  <div class="col-md-3 mb-3">
                    <label for="fuelFillDate" class="form-label">Date <span class="text-danger">*</span></label>
                    <input type="date" id="fuelFillDate" class="form-control" required>
                  </div>
                  <div class="col-md-3 mb-3">
                    <label for="fuelLiters" class="form-label">Liters <span class="text-danger">*</span></label>
                    <input type="number" id="fuelLiters" class="form-control" placeholder="0.00" required step="0.01" oninput="calculateFuelTotalAmount()">
                  </div>
                  <div class="col-md-3 mb-3">
                    <input type="number" id="fuelTripKm" class="form-control" required>
                  </div>
                  <div class="col-md-3 mb-3">
                    <label for="fuelPerLiter" class="form-label">Price/Liter <span class="text-danger">*</span></label>
                    <input type="number" id="fuelPerLiter" class="form-control" placeholder="0.00" required step="0.01" oninput="calculateFuelTotalAmount()">
                  </div>
                  <div class="col-md-3 mb-3">
                    <label class="form-label">Amount (₹)</label>
                    <input type="number" id="fuelAmount" class="form-control bg-light" placeholder="0.00" required step="0.01" readonly>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="fuelRemarks" class="form-label">Remarks</label>
                    <input type="text" id="fuelRemarks" class="form-control" placeholder="Driver name or note">
                  </div>
                </div>
                <button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i>Record Fuel Entry</button>
              </form>
              
              <h5 class="mt-4">Recent Fuel Entries (Fill-ups)</h5>
              <div class="table-responsive">
                <table id="recentFuelEntriesTable" class="table table-striped table-bordered" style="width:100%">
                  <thead>
                    <tr><th>Date</th><th>Pump</th><th class="text-end">Liters</th><th class="text-end">Amount (₹)</th><th>Remarks</th></tr>
                  </thead>
                  <tbody id="recentFuelEntriesBody"></tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="expenses-content" role="tabpanel">
              <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">Trip Expense Log</h5>
                  <button type="button" class="btn btn-sm btn-outline-success" onclick="addExpenseRow('tripGenericExpensesContainer')">
                    <i class="fas fa-plus me-1"></i>Add Expense
                  </button>
                </div>
                <div class="card-body">
                  <div id="tripGenericExpensesContainer" class="d-flex flex-column gap-2">
                    </div>
                  <hr>
                  <div class="text-end">
                    <h5 class="mb-0">Total Trip Expenses: <span id="tripTotalExpensesDisplay" class="fw-bold text-danger">₹0.00</span></h5>
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-pane fade" id="empty-expenses-content" role="tabpanel">
              <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">Empty Return Expense Log</h5>
                  <button type="button" class="btn btn-sm btn-outline-success" onclick="addExpenseRow('emptyTripGenericExpensesContainer')">
                    <i class="fas fa-plus me-1"></i>Add Expense
                  </button>
                </div>
                <div class="card-body">
                  <div id="emptyTripGenericExpensesContainer" class="d-flex flex-column gap-2">
                    </div>
                  <hr>
                  <div class="text-end">
                    <h5 class="mb-0">Total Empty Trip Expenses: <span id="emptyTripTotalExpensesDisplay" class="fw-bold text-danger">₹0.00</span></h5>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="card mt-4">
            <div class="card-header bg-light">
              <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Trip Summary</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-3 mb-3">
                  <label class="form-label">Total Payable to Driver (₹)</label>
                  <input type="number" step="0.01" class="form-control bg-info-subtle" id="tripDriverPayable" readonly>
                </div>
                <div class="col-md-3 mb-3">
                  <label class="form-label">Total Trip Expense (₹)</label>
                  <input type="number" step="0.01" class="form-control bg-warning-subtle" id="tripTotalExpenses" readonly>
                </div>
                <div class="col-md-3 mb-3">
                  <label class="form-label">Total Billing Amount (Incl. GST)</label>
                  <input type="number" step="0.01" class="form-control bg-success-subtle" id="tripTotalBillingAmount" readonly>
                </div>
                <div class="col-md-3 mb-3">
                  <label class="form-label">Client Balance (₹)</label>
                  <input type="number" step="0.01" class="form-control bg-primary-subtle" id="tripClientBalance" readonly>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer d-flex justify-content-between">
          <div>
            <button type="button" class="btn btn-outline-secondary" onclick="navigateTripTabs(-1)">Previous</button>
            <button type="button" class="btn btn-outline-secondary" onclick="navigateTripTabs(1)">Next</button>
          </div>
          <div>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-success" id="saveTripDetailsBtn">Save Trip Details</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- INVOICE DETAIL MODAL (Copied from invoice.html) -->
  <div class="modal fade" id="invoiceDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title">Invoice Details & Style Customization</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <div class="row">
                <div class="col-lg-3 style-panel-section">
                    <div id="styleSettingsPanel">
                        <h6 class="mb-3"><i class="fas fa-palette me-2"></i>Invoice Style</h6>
                        <form id="invoiceStyleForm">
                            <div class="mb-3">
                                <label for="templatePreset" class="form-label small fw-bold">Style Template</label>
                                <select id="templatePreset" class="form-select form-select-sm" onchange="applyTemplate(this.value)">
                                    <option value="custom">-- Custom Style --</option>
                                    <option value="default">Template 1: Default Red (Like Sample)</option>
                                    <option value="blue">Template 2: Corporate Blue</option>
                                    <option value="green">Template 3: Traditional Green</option>
                                    <option value="minimal">Template 4: Minimal</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="themeColor" class="form-label small fw-bold">Primary Theme Color</label>
                                <input type="color" id="themeColor" class="form-control form-control-color" value="#dc3545" title="Choose your primary color">
                            </div>
                            <div class="mb-3">
                                <label for="accentStyle" class="form-label small fw-bold">Table Accent Style</label>
                                <select id="accentStyle" class="form-select form-select-sm">
                                    <option value="header">Header Only</option>
                                    <option value="zebra">Zebra Stripes (Alternating Rows)</option>
                                    <option value="footer">Footer Only</option>
                                    <option value="none">No Accent</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="fontStyle" class="form-label small fw-bold">Font Style</label>
                                <select id="fontStyle" class="form-select form-select-sm">
                                    <option value="sans-serif">Modern Sans-serif (Default)</option>
                                    <option value="serif">Classic Serif</option>
                                    <option value="monospace">Monospace (Technical)</option>
                                </select>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="col-lg-9">
                    <h6 class="mb-3">Live Invoice Preview (Scrollable)</h6>
                    <div class="invoice-preview-container">
                        <div id="printableInvoiceDetail" style="width: 100%; min-height: 800px; padding: 15px; background: white; border: 1px solid #ddd;">
                            <div class="text-center p-5 text-muted">Select an invoice to see the live preview.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer d-flex justify-content-end">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="printInvoiceDetail()"><i class="fas fa-print me-2"></i>Print</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="lrCopyModal" tabindex="-1" aria-labelledby="lrCopyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header text-white" style="background-color: #2E8B57;">
          <h5 class="modal-title" id="lrCopyModalLabel">Lorry Receipt</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0" id="lrCopyContent" style="background-color: #ffffff;"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="fas fa-cog"></i> Print Settings
            </button>
            <ul class="dropdown-menu p-2" style="min-width: 200px;">
              <li class="form-check form-switch"><input class="form-check-input" type="checkbox" id="printLogoToggle" checked><label class="form-check-label" for="printLogoToggle">Show Logo</label></li>
              <li class="form-check form-switch"><input class="form-check-input" type="checkbox" id="printStampToggle" checked><label class="form-check-label" for="printStampToggle">Show Stamp</label></li>
              <li class="form-check form-switch"><input class="form-check-input" type="checkbox" id="printWatermarkToggle" checked><label class="form-check-label" for="printWatermarkToggle">Show Watermark</label></li>
            </ul>
          </div>
          <button type="button" class="btn btn-primary" onclick="downloadLRCopyPDF()"><i class="fas fa-file-pdf me-2"></i>Download PDF</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="editLRModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Edit LR Record</h5>
          <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#autoGenerationSettingsModal">
            <i class="fas fa-cog"></i>
          </button>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editLrForm">
            <div class="card mb-4">
              <div class="card-header bg-light"><h5 class="mb-0"><i class="fas fa-file-invoice me-2"></i>Basic LR Information</h5></div>
              <div class="card-body">
                <div class="row mb-3">
                  <div class="col-md-3">
                    <label for="editLrDate" class="form-label">Date*</label>
                    <input type="date" class="form-control" id="editLrDate" required>
                  </div>
                  <div class="col-md-3">
                    <label for="editLrNumber" class="form-label">LR Number*</label>
                    <input type="text" class="form-control" id="editLrNumber" required>
                  </div>
                  <div class="col-md-6 vehicle-input-container">
                    <div class="form-check form-switch mb-2 pt-1">
                      <input class="form-check-input" type="checkbox" role="switch" id="editVehicleTypeToggle" onchange="toggleEditVehicleInput(this.checked)">
                      <label class="form-check-label" for="editVehicleTypeToggle">Use Market Vehicle</label>
                    </div>
                    <div id="editOwnVehicleFields">
                      <label for="editTruckNumber" class="form-label">Own Truck Number</label>
                      <div class="input-group">
                        <select id="editTruckNumber" class="form-select" required></select>
                        <button class="btn btn-outline-success" type="button" id="editQuickAddVehicleBtn" title="Add New Vehicle"><i class="fas fa-plus"></i></button>
                      </div>
                    </div>
                    <div id="editMarketVehicleFields" style="display: none;">
                      <label for="editMarketTruckNumber" class="form-label">Market Truck Number</label>
                      <input type="text" id="editMarketTruckNumber" class="form-control">
                    </div>
                  </div>
                </div>
                <div class="row mb-3">
                  <div class="col-md-3"><label for="editInvoiceNumberInput" class="form-label">Invoice No.</label><input type="text" class="form-control" id="editInvoiceNumberInput"></div>
                  <div class="col-md-3"><label for="editShipmentNo" class="form-label">Shipment No.</label><input type="text" class="form-control" id="editShipmentNo"></div>
                  <div class="col-md-3"><label for="editDeliveryNo" class="form-label">Delivery No.</label><input type="text" class="form-control" id="editDeliveryNo"></div>
                  <div class="col-md-3"><label for="editOrderNo" class="form-label">Order No.</label><input type="text" class="form-control" id="editOrderNo"></div>
                </div>
                <div class="row">
                  <div class="col-md-4 mb-3">
                    <div id="editOwnDriverField">
                      <label for="editDriverSelect" class="form-label">Driver</label>
                      <div class="input-group">
                        <select id="editDriverSelect" class="form-select"></select>
                        <button class="btn btn-outline-success" type="button" id="editQuickAddDriverBtn" title="Add New Driver"><i class="fas fa-plus"></i></button>
                      </div>
                    </div>
                    <div id="editMarketDriverField" style="display: none;">
                      <label for="editMarketDriverName" class="form-label">Driver Name</label>
                      <input type="text" id="editMarketDriverName" class="form-control">
                    </div>
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="editClientId" class="form-label">Billed To (Client)*</label>
                    <div class="input-group">
                      <select id="editClientId" class="form-select" required></select>
                      <button class="btn btn-outline-success" type="button" id="editQuickAddClientBtn" title="Add New Client"><i class="fas fa-plus"></i></button>
                    </div>
                  </div>
                  <div class="col-md-4 mb-3">
                    <div id="editTransporterField" style="display: block;">
                      <label for="editTransporterSelect" class="form-label">Transporter</label>
                      <div class="input-group">
                        <select id="editTransporterSelect" class="form-select"></select>
                        <button class="btn btn-outline-success" type="button" id="editQuickAddTransporterBtn" title="Add New Transporter"><i class="fas fa-plus"></i></button>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="editEmployeeSelect" class="form-label">Employee</label>
                    <select id="editEmployeeSelect" class="form-select">
                      <option value="">Select Employee</option>
                    </select>
                    <small class="text-muted">Select the employee managing this LR</small>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="editRouteSelect" class="form-label">Route*</label>
                    <div class="input-group">
                      <select id="editRouteSelect" class="form-select" required></select>
                      <button class="btn btn-outline-success" type="button" id="editQuickAddRouteBtn" title="Add New Route"><i class="fas fa-plus"></i></button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="card mb-4">
              <div class="card-header bg-light"><h5 class="mb-0"><i class="fas fa-box me-2"></i>Shipment Details</h5></div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <label for="editConsigneeId" class="form-label">Consignee*</label>
                    <div class="input-group">
                      <select id="editConsigneeId" class="form-select" required></select>
                      <button class="btn btn-outline-success" type="button" id="editQuickAddConsigneeBtn" title="Add New Consignee"><i class="fas fa-plus"></i></button>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label for="editItem" class="form-label">Item</label>
                    <input type="text" class="form-control" id="editItem" placeholder="e.g., Cement Bags, Steel Bars">
                  </div>
                </div>
                <div class="row mt-3">
                  <div class="col-md-4">
                    <label for="editNumPackages" class="form-label">No. of Packages</label>
                    <input type="number" class="form-control" id="editNumPackages" placeholder="For package goods">
                  </div>
                  <div class="col-md-4">
                    <label for="editWeightPerPackage" class="form-label">Weight/Package (kg)</label>
                    <input type="number" class="form-control" id="editWeightPerPackage" step="0.01" placeholder="e.g., 50">
                  </div>
                  <div class="col-md-4">
                    <label for="editWeight" class="form-label">Total Weight (tonne)</label>
                    <input type="number" class="form-control" id="editWeight" step="0.01" required oninput="window.recalculateAmountsOnWeightChange()" placeholder="Total weight in MT">
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="updateLRBtn">Update LR</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="quickAddClientModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New Client</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="quickAddClientForm">
            <div class="row">
              <div class="col-md-6 mb-3"><label class="form-label">Client Name*</label><input type="text" id="q_clientName" class="form-control" required></div>
              <div class="col-md-6 mb-3"><label class="form-label">Contact Person</label><input type="text" id="q_contactPerson" class="form-control"></div>
              <div class="col-md-6 mb-3"><label class="form-label">Mobile*</label><input type="tel" id="q_mobile" class="form-control" required></div>
              <div class="col-md-6 mb-3"><label class="form-label">GSTIN</label><input type="text" id="q_gstin" class="form-control"></div>
              <div class="col-12 mb-3"><label class="form-label">Billing Address</label><textarea id="q_billingAddress" class="form-control" rows="2"></textarea></div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="saveQuickAddClientBtn">Save Client</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="quickAddRouteModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New Route</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="quickAddRouteForm">
            <div class="mb-3"><label class="form-label">From Location*</label><input type="text" id="q_fromLocation" class="form-control" required></div>
            <div class="mb-3"><label class="form-label">To Location*</label><input type="text" id="q_toLocation" class="form-control" required></div>
            <div class="mb-3"><label class="form-label">Distance (KM)</label><input type="number" id="q_distance" class="form-control"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="saveQuickAddRouteBtn">Save Route</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="quickAddTransporterModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New Transporter</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="quickAddTransporterForm">
            <div class="row">
              <div class="col-md-6 mb-3"><label class="form-label">Transporter Name*</label><input type="text" id="q_transporterName" class="form-control" required></div>
              <div class="col-md-6 mb-3"><label class="form-label">Contact Person</label><input type="text" id="q_transporterContactPerson" class="form-control"></div>
              <div class="col-md-6 mb-3"><label class="form-label">Mobile</label><input type="tel" id="q_transporterMobile" class="form-control"></div>
              <div class="col-md-6 mb-3"><label class="form-label">GSTIN</label><input type="text" id="q_transporterGstin" class="form-control"></div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="saveQuickAddTransporterBtn">Save Transporter</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="quickAddVehicleModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New Vehicle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="quickAddVehicleForm">
            <div class="mb-3"><label class="form-label">Vehicle Number*</label><input type="text" id="q_vehicleNumber" class="form-control" required></div>
            <div class="mb-3"><label class="form-label">Vehicle Type</label><input type="text" id="q_vehicleType" class="form-control" placeholder="e.g., Truck, Mini Truck"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="saveQuickAddVehicleBtn">Save Vehicle</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="quickAddDriverModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New Driver</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="quickAddDriverForm">
            <div class="mb-3"><label class="form-label">Driver Name*</label><input type="text" id="q_driverName" class="form-control" required></div>
            <div class="mb-3"><label class="form-label">Contact Number</label><input type="tel" id="q_driverContact" class="form-control"></div>
            <div class="mb-3"><label class="form-label">License No.</label><input type="text" id="q_driverLicense" class="form-control"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="saveQuickAddDriverBtn">Save Driver</button>
        </div>
      </div>
    </div>
  </div>


    <!-- Load secure configuration first -->
  <script src="evm.js"></script>
  

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  
  <script src="navbar-loader.js"></script>
  <script>
    // Firebase configuration
    // Load Firebase configuration securely from EVM
    let firebaseConfig;
    
    try {
      // Get Firebase configuration from secure EVM system
      firebaseConfig = window.FIREBASE_CONFIG;
      
      // Check if we're using fallback values
      if (false) {
        console.warn('⚠️  Using fallback Firebase configuration. Please update evm.js with real values.');
      } else {
        console.log('✅ Firebase configuration loaded securely from EVM');
      }
    } catch (error) {
      console.error('❌ Failed to load Firebase configuration:', error);
      
      // Use fallback configuration to prevent complete failure
      firebaseConfig = window.FIREBASE_CONFIG;
    }

    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();
    const auth = firebase.auth();

    window.db = db;
    window.auth = auth;

    auth.onAuthStateChanged(user => {
      if (user) {
        currentCoreAccountId = user.uid;
        console.log("currentCoreAccountId set to:", currentCoreAccountId);
      } else {
        currentCoreAccountId = null;
        console.log("User logged out, currentCoreAccountId set to null.");
      }
    });

    // --- Helper: Sync an existing invoice with current LR data ---
    async function syncInvoiceWithCurrentLR(invoiceId) {
      if (!currentCoreAccountId) throw new Error('Core account ID not found');
      const invRef = db.ref(`users/${currentCoreAccountId}/invoices/${invoiceId}`);
      const invSnap = await invRef.once('value');
      if (!invSnap.exists()) throw new Error('Invoice not found');
      const invoice = invSnap.val();

      const lrIds = Array.isArray(invoice.lrEntries) ? invoice.lrEntries : [];
      if (lrIds.length === 0) return; // Nothing to sync

      const snaps = await Promise.all(lrIds.map(id => db.ref(`users/${currentCoreAccountId}/lrReports/${id}`).once('value')));
      const lrs = snaps.map(s => ({ id: s.key, data: s.val() })).filter(x => !!x.data);
      if (lrs.length === 0) return;

      // Rebuild items and totals
      let subtotal = 0;
      const items = [];
      lrs.forEach(({ id, data: lr }) => {
        const amount = lr.tripDetails?.billingAmount || 0;
        subtotal += amount;
        const consignor = (allClients.find(c => c.id === lr.clientId)?.name) || 'N/A';
        const consignee = (allClients.find(c => c.id === lr.consigneeId)?.name) || consignor;
        items.push({
          lrId: id,
          date: lr.date,
          lrNumber: lr.lrNumber,
          truckNumber: lr.truckNumber,
          consignor: consignor,
          consignee: consignee,
          from: lr.fromLocation,
          to: lr.toLocation,
          weight: lr.weight,
          amount: amount,
          marketCompanyName: lr.transporterCompany || ''
        });
      });

      // Determine bill-to mode from current LRs
      const allMarketCompany = lrs.every(({ data }) => data.lrType === 'market_company');
      let invoiceType, transporterId = null, clientId = null;
      if (allMarketCompany) {
        const firstTid = lrs[0].data.transporterId || null;
        const sameTid = lrs.every(({ data }) => data.transporterId === firstTid);
        invoiceType = 'market_company';
        transporterId = sameTid ? firstTid : (firstTid || null);
        clientId = null;
      } else {
        const firstCid = lrs[0].data.clientId || null;
        const sameCid = lrs.every(({ data }) => data.clientId === firstCid);
        invoiceType = 'client';
        clientId = sameCid ? firstCid : (firstCid || null);
        transporterId = null;
      }

      const cgstPercentage = 9;
      const sgstPercentage = 9;
      const cgstAmount = (subtotal * cgstPercentage) / 100;
      const sgstAmount = (subtotal * sgstPercentage) / 100;
      const grandTotal = subtotal + cgstAmount + sgstAmount;

      const updates = {
        items: items,
        subtotal: subtotal,
        cgstAmount: cgstAmount,
        sgstAmount: sgstAmount,
        grandTotal: grandTotal,
        invoiceType: invoiceType,
        transporterId: transporterId,
        clientId: clientId
      };

      await invRef.update(updates);
    }

    // Global Constants
    const SHORTAGE_DEDUCTION_RATE = 100; // Example: Deduct ₹100 per tonne of shortage

    let allVehicles = [];
    let allClients = [];
    let allWorkVendors = []; 
    let allTransporters = []; // **NEW**
    let allPumps = []; // **NEW**: Global to store pump data
    let currentEditingLRId = null;
    let currentUserProfile = null; // For invoice rendering
    let currentCoreAccountId = null;
    let lrTable;
    let marketLrTable; // **NEW**
    let currentTripWeight = 0; 
    let currentTripLRId = null; 
    let currentTripTruckNumber = null; // **NEW**

    // --- INVOICE STYLING GLOBALS (Copied from invoice.html) ---
    let currentInvoiceData = null;
    let invoiceStyle = {
        themeColor: '#dc3545',
        accentStyle: 'header',
        fontStyle: 'sans-serif'
    };
    const styleTemplates = {
        default: { themeColor: '#dc3545', accentStyle: 'header', fontStyle: 'sans-serif' },
        blue: { themeColor: '#0d6efd', accentStyle: 'zebra', fontStyle: 'sans-serif' },
        green: { themeColor: '#198754', accentStyle: 'footer', fontStyle: 'serif' },
        minimal: { themeColor: '#343a40', accentStyle: 'none', fontStyle: 'sans-serif' }
    };
    // --- END INVOICE STYLING GLOBALS ---



    // Auto-Generation Settings
    let autoSettings = {
      lrNo: true,
      invoiceNo: true,
      shipmentNo: true,
      orderNo: true,
      deliveryNo: true
    };
    
    // Load and Save Auto-Generation Settings
    function loadAutoGenerationSettings() {
      const storedSettings = localStorage.getItem('lrAutoGenerateSettings');
      if (storedSettings) {
        autoSettings = JSON.parse(storedSettings);
      }
      // Apply settings to form fields
      document.getElementById('autoGenerateLrNo').checked = autoSettings.lrNo;
      document.getElementById('autoGenerateInvoiceNo').checked = autoSettings.invoiceNo;
      document.getElementById('autoGenerateShipmentNo').checked = autoSettings.shipmentNo;
      document.getElementById('autoGenerateOrderNo').checked = autoSettings.orderNo;
      document.getElementById('autoGenerateDeliveryNo').checked = autoSettings.deliveryNo;
      applyAutoGenerationSettings();
    }

    function saveAutoGenerationSettings() {
      autoSettings = {
        lrNo: document.getElementById('autoGenerateLrNo').checked,
        invoiceNo: document.getElementById('autoGenerateInvoiceNo').checked,
        shipmentNo: document.getElementById('autoGenerateShipmentNo').checked,
        orderNo: document.getElementById('autoGenerateOrderNo').checked,
        deliveryNo: document.getElementById('autoGenerateDeliveryNo').checked
      };
      localStorage.setItem('lrAutoGenerateSettings', JSON.stringify(autoSettings));
      applyAutoGenerationSettings();
    }

    function applyAutoGenerationSettings() {
      // LR Number
      const lrNoInput = document.getElementById('lrNumber');
      if (lrNoInput) {
        lrNoInput.readOnly = autoSettings.lrNo; // Keep it read-only if auto-generated
        if (autoSettings.lrNo) generateLRNumber(lrNoInput); else { lrNoInput.value = ''; lrNoInput.placeholder = 'Enter LR Number'; }
      }
      
      // Invoice Number
      const invoiceNoInput = document.getElementById('invoiceNumberInput');
      if (invoiceNoInput) {
        invoiceNoInput.readOnly = autoSettings.invoiceNo;
        if (autoSettings.invoiceNo) generateSequentialNumber(invoiceNoInput, 'INV'); else { invoiceNoInput.value = ''; invoiceNoInput.placeholder = 'Enter Invoice No.'; }
      }

      // Delivery Number
      const deliveryNoInput = document.getElementById('deliveryNo');
      if (deliveryNoInput) {
        deliveryNoInput.readOnly = autoSettings.deliveryNo;
        if (autoSettings.deliveryNo) generateSequentialNumber(deliveryNoInput, 'DLV'); else { deliveryNoInput.value = ''; deliveryNoInput.placeholder = 'Enter Delivery No.'; }
      }
      
      // Order Number
      const orderNoInput = document.getElementById('orderNo');
      if (orderNoInput) {
        orderNoInput.readOnly = autoSettings.orderNo;
        if (autoSettings.orderNo) generateSequentialNumber(orderNoInput, 'ORD'); else { orderNoInput.value = ''; orderNoInput.placeholder = 'Enter Order No.'; }
      }
      
      // Shipment Number
      const shipmentNoInput = document.getElementById('shipmentNo');
      if (shipmentNoInput) {
        shipmentNoInput.readOnly = autoSettings.shipmentNo;
        if (autoSettings.shipmentNo) generateSequentialNumber(shipmentNoInput, 'SHP'); else { shipmentNoInput.value = ''; shipmentNoInput.placeholder = 'Enter Shipment No.'; }
      }
    }

    function generateLRNumber(inputElement) {
      if (!autoSettings.lrNo) return;
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const random = Math.floor(1000 + Math.random() * 9000);
      inputElement.value = `LR${year}${month}${day}${random}`;
    }

    function generateSequentialNumber(inputElement, prefix) {
      if (!currentCoreAccountId) {
        console.error(`Cannot generate ${prefix} number without core account ID.`);
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const random = Math.floor(1000 + Math.random() * 9000);
        inputElement.value = `${prefix}${year}${month}${day}${random}`;
        return;
      }

      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      const datePrefix = `${prefix}${year}${month}${day}`;

      const counterRef = db.ref(`users/${currentCoreAccountId}/counters/${prefix.toLowerCase()}_${year}${month}${day}`);
      
      counterRef.transaction(currentValue => {
        return (currentValue || 0) + 1;
      }).then(({ committed, snapshot }) => {
        if (committed) {
          const nextNumber = snapshot.val();
          const runningNumber = String(nextNumber).padStart(4, '0');
          inputElement.value = `${datePrefix}${runningNumber}`;
        } else {
          console.error(`${prefix} number generation transaction was aborted.`);
          // Fallback to random number
          const random = Math.floor(1000 + Math.random() * 9000);
          inputElement.value = `${datePrefix}${random}`;
        }
      }).catch(error => {
        console.error(`Error with ${prefix} number generation transaction: `, error);
        // Fallback to random number
        const random = Math.floor(1000 + Math.random() * 9000);
        inputElement.value = `${datePrefix}${random}`;
      });
    }

    function generateRandomNumber(inputElement, prefix) {
      if (!autoSettings[`${prefix.toLowerCase()}No`]) return;
      const now = new Date();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const random = Math.floor(100 + Math.random() * 900);
      inputElement.value = `${prefix}-${month}-${random}`;
    }

    // Apply auto-generation for Edit modal fields without overwriting existing values
    function applyEditAutoGenerationSettings() {
      // LR Number (optional: keep editable by design; using auto setting to control readOnly)
      const eLR = document.getElementById('editLrNumber');
      if (eLR) {
        eLR.readOnly = !!autoSettings.lrNo;
        eLR.placeholder = autoSettings.lrNo ? 'Auto-Generated if empty' : 'Enter LR Number';
        if (autoSettings.lrNo && !eLR.value) {
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, '0');
          const day = String(now.getDate()).padStart(2, '0');
          const random = Math.floor(1000 + Math.random() * 9000);
          eLR.placeholder = `e.g., LR${year}${month}${day}${random}`;
        }
      }
      // Invoice No
      const eInv = document.getElementById('editInvoiceNumberInput');
      if (eInv) {
        eInv.readOnly = !!autoSettings.invoiceNo;
        eInv.placeholder = autoSettings.invoiceNo ? 'Auto-Generated if empty' : 'Enter Invoice No.';
        if (autoSettings.invoiceNo && !eInv.value) generateSequentialNumber(eInv, 'INV');
      }
      // Shipment No
      const eShip = document.getElementById('editShipmentNo');
      if (eShip) {
        eShip.readOnly = !!autoSettings.shipmentNo;
        eShip.placeholder = autoSettings.shipmentNo ? 'Auto-Generated if empty' : 'Enter Shipment No.';
        if (autoSettings.shipmentNo && !eShip.value) generateSequentialNumber(eShip, 'SHP');
      }
      // Order No
      const eOrder = document.getElementById('editOrderNo');
      if (eOrder) {
        eOrder.readOnly = !!autoSettings.orderNo;
        eOrder.placeholder = autoSettings.orderNo ? 'Auto-Generated if empty' : 'Enter Order No.';
        if (autoSettings.orderNo && !eOrder.value) generateSequentialNumber(eOrder, 'ORD');
      }
      // Delivery No
      const eDel = document.getElementById('editDeliveryNo');
      if (eDel) {
        eDel.readOnly = !!autoSettings.deliveryNo;
        eDel.placeholder = autoSettings.deliveryNo ? 'Auto-Generated if empty' : 'Enter Delivery No.';
        if (autoSettings.deliveryNo && !eDel.value) generateSequentialNumber(eDel, 'DLV');
      }
    }

    // Load all vehicles (includes driver info)
    async function loadAllVehicles(userId) {
      try {
         const userProfileRef = db.ref(`users/${userId}`);
         const userSnapshot = await userProfileRef.once('value');
         const userData = userSnapshot.val();

         // **NEW**: Fetch and store user profile for invoice generation
         const profileSnap = await db.ref(`users/${userId}/profile`).once('value');
         currentUserProfile = profileSnap.val() || {};

         currentCoreAccountId = (userData && userData.coreAccountId) || userId;
 
         // Load Vehicles
         const vehiclesRef = db.ref(`users/${currentCoreAccountId}/vehicles`);
         vehiclesRef.on('value', (snapshot) => {
             allVehicles = [];
             const truckSelect = document.getElementById('truckNumber');
             const editTruckSelect = document.getElementById('editTruckNumber');
             if (truckSelect) truckSelect.innerHTML = '<option value="">Select a Truck</option>';
             if (editTruckSelect) editTruckSelect.innerHTML = '<option value="">Select a Truck</option>';
 
             if (snapshot.exists()) {
                 snapshot.forEach((child) => {
                     const vehicle = { id: child.key, ...child.val() };
                     allVehicles.push(vehicle);
                     const option = document.createElement('option');
                     option.value = vehicle.vehicleNumber;
                     option.textContent = vehicle.vehicleNumber;
                     if (truckSelect) truckSelect.appendChild(option.cloneNode(true));
                     if (editTruckSelect) editTruckSelect.appendChild(option);
                 });
             }
             updateTruckFilterDropdown();
         });
 
         // Load Drivers
         const driversRef = db.ref(`users/${currentCoreAccountId}/drivers`);
         driversRef.on('value', (snapshot) => {
             populateDriverDropdowns(snapshot, 'driverSelect', 'editDriverSelect');
         });
      } catch (error) {
        console.error("❌ Failed to load vehicle master list:", error);
      }
    }

    // Load all clients, routes, and vendors
    async function loadAllData() {
      const user = auth.currentUser;
      if (!user) return;
      await loadAllVehicles(user.uid);
      
      // Apply auto-generation settings after currentCoreAccountId is set
      applyAutoGenerationSettings();

      // Load invoice style settings from localStorage
      loadStyleSettings();

      // **FIX**: Clients must be loaded from the core account's path to ensure
      // that clients added by any branch user are visible to all.
      if (!currentCoreAccountId) {
        console.error("Cannot load clients, coreAccountId is not set.");
        return;
      }
      const clientsRef = db.ref(`users/${currentCoreAccountId}/clients`);
      clientsRef.on('value', (snapshot) => {
        allClients = [];
        const clientSelect = document.getElementById('clientId');
        const consigneeSelect = document.getElementById('consigneeId');
        const editClientSelect = document.getElementById('editClientId');
        const editConsigneeSelect = document.getElementById('editConsigneeId'); // **NEW**
        if (clientSelect) clientSelect.innerHTML = '<option value="">Select a Client</option>';
        [consigneeSelect, editClientSelect, editConsigneeSelect].forEach(el => { if(el) el.innerHTML = '<option value="">Select...</option>'; });
        
        if (snapshot.exists()) {
          snapshot.forEach((childSnapshot) => {
            const client = childSnapshot.val();
            const clientData = { id: childSnapshot.key, name: client.clientName, ...client };
            allClients.push(clientData);
            const option = document.createElement('option');
            option.value = clientData.id;
            option.textContent = clientData.name;
            option.dataset.address = client.billingAddress || '';
            if (clientSelect) clientSelect.appendChild(option.cloneNode(true));
            if (consigneeSelect) consigneeSelect.appendChild(option.cloneNode(true));
            if (editConsigneeSelect) editConsigneeSelect.appendChild(option.cloneNode(true)); // **NEW**
            if (editClientSelect) editClientSelect.appendChild(option);
          });
        }
      });
      
      // Routes (using core account ID for shared data)
      const routesRef = db.ref(`users/${currentCoreAccountId}/routes`);
      routesRef.on('value', (snapshot) => {
        const routeSelect = document.getElementById('routeSelect');
        const editRouteSelect = document.getElementById('editRouteSelect');
        if (routeSelect) routeSelect.innerHTML = '<option value="">Select a Route</option>';
        if (editRouteSelect) editRouteSelect.innerHTML = '<option value="">Select a Route</option>';
        if (snapshot.exists()) {
          snapshot.forEach((child) => {
            const r = child.val() || {};
            const opt = document.createElement('option');
            opt.value = child.key;
            opt.textContent = `${r.from || '-'} --> ${r.to || '-'}`;
            opt.dataset.from = r.from || '';
            opt.dataset.to = r.to || '';
            opt.dataset.distance = r.distance !== undefined ? r.distance : 0;
            if (routeSelect) routeSelect.appendChild(opt.cloneNode(true));
            if (editRouteSelect) editRouteSelect.appendChild(opt);
          });
        }
      });

      // Work Vendors for the modal (using core account ID for shared data)
      const vendorsRef = db.ref(`users/${currentCoreAccountId}/workVendors`);
        vendorsRef.on('value', (snapshot) => {
            allWorkVendors = []; // Reset
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    allWorkVendors.push({ id: child.key, ...child.val() });
                });
                console.log("✅ Successfully loaded work vendors for expense modal:", allWorkVendors.length);
            } else {
                console.log("ℹ️ No work vendors found for this account.");
            }
        });

      // **NEW**: Load Transporters for the dropdown
      const transportersRef = db.ref(`users/${currentCoreAccountId}/transporters`);
      transportersRef.on('value', (snapshot) => {
        allTransporters = [];
        const addSelect = document.getElementById('transporterSelect');
        const editSelect = document.getElementById('editTransporterSelect');
        if (addSelect) addSelect.innerHTML = '<option value="">Select a Transporter</option>';
        if (editSelect) editSelect.innerHTML = '<option value="">Select a Transporter</option>';
        
        if (snapshot.exists()) {
          snapshot.forEach((child) => {
            const transporter = { id: child.key, ...child.val() };
            allTransporters.push(transporter);
            populateTransporterDropdowns(transporter, addSelect, editSelect);
          });
        }
      });

      // **NEW**: Load Employees for the dropdown
      const employeesRef = db.ref(`users/${currentCoreAccountId}/employees`);
      employeesRef.on('value', (snapshot) => {
        const employeeSelect = document.getElementById('employeeSelect');
        const editEmployeeSelect = document.getElementById('editEmployeeSelect');
        if (employeeSelect) employeeSelect.innerHTML = '<option value="">Select Employee</option>';
        if (editEmployeeSelect) editEmployeeSelect.innerHTML = '<option value="">Select Employee</option>';
        
        if (snapshot.exists()) {
          snapshot.forEach((child) => {
            const employee = { id: child.key, ...child.val() };
            const option = document.createElement('option');
            option.value = employee.id;
            option.textContent = `${employee.name || 'Unknown'} (${employee.designation || 'N/A'})`;
            if (employeeSelect) employeeSelect.appendChild(option.cloneNode(true));
            if (editEmployeeSelect) editEmployeeSelect.appendChild(option.cloneNode(true));
          });
        }
      });

      // **NEW**: Load all Pumps (for Fuel Entry tab)
      const pumpsRef = db.ref(`users/${auth.currentUser.uid}/petrolPumps`);
      pumpsRef.on('value', (snapshot) => {
          allPumps = [];
          if (snapshot.exists()) {
              snapshot.forEach(child => {
                  allPumps.push({ id: child.key, ...child.val() });
              });
              console.log("✅ Successfully loaded pumps:", allPumps.length);
          } else {
              console.log("ℹ️ No pumps found for this account.");
          }
      });

      // **FIX**: Call loadLRData here, outside of other listeners, to prevent re-attaching.
      loadLRData();
    }

    // Helper to populate transporter dropdowns
    function populateTransporterDropdowns(transporter, ...dropdowns) {
      const option = document.createElement('option');
      option.value = transporter.id;
      option.textContent = transporter.name;
      option.dataset.name = transporter.name; // Store name for saving
      dropdowns.forEach(dropdown => {
        if (dropdown) dropdown.appendChild(option.cloneNode(true));
      });
    }
    
    // --- NEW: Helper to populate driver dropdowns ---
    function populateDriverDropdowns(snapshot, ...dropdownIds) {
        const selects = dropdownIds.map(id => document.getElementById(id));
        selects.forEach(s => { if(s) s.innerHTML = '<option value="">Select a Driver</option>'; });

        if (snapshot.exists()) {
            snapshot.forEach((child) => {
                const driver = child.val();
                if (driver.driverName) {
                    const option = document.createElement('option');
                    option.value = driver.driverName; // Use name as value
                    option.textContent = driver.driverName;
                    selects.forEach(s => { if(s) s.appendChild(option.cloneNode(true)); });
                }
            });
        }
    }

    // --- NEW LOGIC FUNCTIONS ---

    // --- WEIGHT CALCULATION FUNCTIONS (RETAINED) ---

    function calculateWeightFromPackages() {
      const numPackages = parseFloat(document.getElementById('numPackages').value) || 0;
      const weightPerPackage = parseFloat(document.getElementById('weightPerPackage').value) || 0;
      
      if (numPackages > 0 && weightPerPackage > 0) {
        const totalWeightKg = numPackages * weightPerPackage;
        const totalWeightTonne = totalWeightKg / 1000;
        document.getElementById('weight').value = totalWeightTonne.toFixed(3);
      }
    }

    function handleManualWeightInput() {
      document.getElementById('numPackages').value = '';
      document.getElementById('weightPerPackage').value = '';
    }

    // --- MAIN LR SAVE FUNCTION (STREAMLINED) ---

    function saveLR() {
      const form = document.getElementById('lrForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const routeSelect = document.getElementById('routeSelect');
      const selectedRoute = routeSelect.options[routeSelect.selectedIndex];
      const fromLoc = selectedRoute ? (selectedRoute.dataset.from || '') : '';
      const toLoc = selectedRoute ? (selectedRoute.dataset.to || '') : '';
      const routeDistance = selectedRoute && selectedRoute.dataset && selectedRoute.dataset.distance ? parseFloat(selectedRoute.dataset.distance) || 0 : 0;

      // **MODIFIED**: Logic for Market LR Trip
      const isMarketVehicle = document.getElementById('vehicleTypeToggle').checked;
      const truckNumber = isMarketVehicle ? document.getElementById('marketTruckNumber').value : document.getElementById('truckNumber').value;
      const driverName = isMarketVehicle ? document.getElementById('marketDriverName').value.trim() : document.getElementById('driverSelect').value;
      
      const transporterSelect = document.getElementById('transporterSelect');
      const transporterId = transporterSelect.value;
      const transporterName = transporterSelect.value ? transporterSelect.options[transporterSelect.selectedIndex].dataset.name : null;

      const vehicle = allVehicles.find(v => (v.vehicleNo || '').toUpperCase() === truckNumber.toUpperCase() && v.driverName === driverName);

      const employeeSelect = document.getElementById('employeeSelect');
      const employeeId = employeeSelect ? employeeSelect.value : null;

      const lrData = {
        date: document.getElementById('lrDate').value,
        lrNumber: document.getElementById('lrNumber').value,
        // **FIX**: Correctly determine lrType. If a transporter is selected, it's a market_company LR.
        // If the market vehicle toggle is on (and no transporter), it's a generic market LR.
        // Otherwise, it's an own vehicle LR.
        lrType: transporterId 
          ? 'market_company' 
          : (isMarketVehicle ? 'market' : 'own'),
        transporterId: transporterId,
        transporterCompany: transporterName,
        routeId: document.getElementById('routeSelect').value, 
        invoiceNumber: document.getElementById('invoiceNumberInput').value,
        deliveryNo: document.getElementById('deliveryNo').value,
        orderNo: document.getElementById('orderNo').value,
        shipmentNo: document.getElementById('shipmentNo').value,
        truckNumber: truckNumber,
        driverName: driverName,
        truckId: vehicle ? vehicle.id : null,
        clientId: document.getElementById('clientId').value,
        consigneeId: document.getElementById('consigneeId').value || document.getElementById('clientId').value,
        employeeId: employeeId || null, // Store registered employee ID
        fromLocation: fromLoc,
        toLocation: toLoc,
        routeDistanceKm: routeDistance,
        numPackages: parseFloat(document.getElementById('numPackages').value) || 0,
        weightPerPackage: parseFloat(document.getElementById('weightPerPackage').value) || 0,
        weight: parseFloat(document.getElementById('weight').value) || 0,
        item: document.getElementById('item').value,
        // New fields for post-save entry
        tripDetails: {
          billingRate: 0, billingAmount: 0, freightRate: 0, freightAmount: 0,
          advance: 0, shortage: 0, 
          endingKm: 0, totalKm: 0,
          vehicleAverage: 0, fuelUsedLiters: 0, dieselRatePerLiter: 0,
          fuelAlreadyDeducted: false, // NEW: Track fuel deduction status
          // Aggregated Expense Fields (Start with zero)
          tyreExpenses: 0,
          tollExpenses: 0,
          foodExpenses: 0,
          loadingUnloadingExpenses: 0,
          policeChallanExpenses: 0,
          tacExpenses: 0,
          permitExpenses: 0,
          brokerageExpenses: 0,
          vehicleWorkAmount: 0,
          commissionExpenses: 0,
          tirpalRopeExpenses: 0,
          otherExpenses: 0,
          genericExpenses: [],
          
          cgstPercentage: 9, cgstAmount: 0, sgstPercentage: 9, sgstAmount: 0,
          totalBillingAmount: 0, totalExpenses: 0, driverPayable: 0, clientBalance: 0,
        },
        createdAt: new Date().toISOString(),
        status: 'active'
      };

      if (!currentCoreAccountId) {
          alert('Error: Core account ID not found. Cannot save LR.');
          return;
      }
      
      const newLRRef = db.ref(`users/${currentCoreAccountId}/lrReports`).push();
      newLRRef.set(lrData)
        .then(() => {
          alert('LR saved successfully! Please enter trip details next.');
          form.reset();
          document.getElementById('lrDate').value = new Date().toISOString().split('T')[0];
          applyAutoGenerationSettings();
          loadLRData();
          
          // Optionally auto-open the new trip details modal
          // showTripDetailsModal(newLRRef.key, lrData.lrNumber, lrData.weight, lrData.truckNumber, lrData.driverName);
        })
        .catch((error) => {
          console.error('Error saving LR:', error);
          alert('Error saving LR. Please try again.');
        });
    }

    // --- NEW: Function to sync consignee with consignor selection ---
    window.updateConsigneeFromClient = function() {
      const clientSelect = document.getElementById('clientId');
      const consigneeSelect = document.getElementById('consigneeId');
      if (clientSelect && consigneeSelect) {
        consigneeSelect.value = clientSelect.value;
      }
    }

    // **NEW**: Toggle between own and market vehicle inputs
    window.toggleVehicleInput = function(isMarket) {
      const ownVehicleFields = document.getElementById('ownVehicleFields');
      const marketVehicleFields = document.getElementById('marketVehicleFields');
      const ownDriverField = document.getElementById('ownDriverField');
      const marketDriverField = document.getElementById('marketDriverField');
      const transporterField = document.getElementById('transporterField'); // This is the container div
      
      // **FIXED**: Add button next to transporter dropdown and re-attach listeners
      if (transporterField) {
        transporterField.innerHTML = `
        <label for="transporterSelect" class="form-label">Transporter</label>
        <div class="input-group">
          <select id="transporterSelect" class="form-select">
            <option value="">Select a Transporter</option>
          </select>
          <button class="btn btn-outline-success" type="button" id="quickAddTransporterBtn" title="Add New Transporter">
            <i class="fas fa-plus"></i>
          </button>
        </div>
        `;
      }

      ownVehicleFields.style.display = isMarket ? 'none' : 'block';
      marketVehicleFields.style.display = isMarket ? 'block' : 'none';
      // The transporter field itself is toggled, not the innerHTML
      if (transporterField) transporterField.style.display = isMarket ? 'none' : 'block';
      if (ownDriverField) ownDriverField.style.display = isMarket ? 'none' : 'block';
      marketDriverField.style.display = isMarket ? 'block' : 'none';

      // Toggle required attribute to ensure form validation works correctly
      document.getElementById('truckNumber').required = !isMarket;
      document.getElementById('marketTruckNumber').required = isMarket;
      document.getElementById('transporterSelect').required = false; 

      // Re-attach event listener for the new transporter button
      const quickAddTransporterBtn = document.getElementById('quickAddTransporterBtn');
      if (quickAddTransporterBtn) {
        quickAddTransporterBtn.addEventListener('click', () => {
          const modal = new bootstrap.Modal(document.getElementById('quickAddTransporterModal'));
          modal.show();
        });
      }
      
      // **FIXED**: Re-attach save listener for Transporter modal
      const saveQuickAddTransporterBtn = document.getElementById('saveQuickAddTransporterBtn');
      if (saveQuickAddTransporterBtn) {
        saveQuickAddTransporterBtn.removeEventListener('click', saveQuickAddTransporter);
        saveQuickAddTransporterBtn.addEventListener('click', saveQuickAddTransporter);
      }

      // **NEW**: Populate the new dropdown
      const addSelect = document.getElementById('transporterSelect');
      addSelect.innerHTML = '<option value="">Select a Transporter</option>';
      allTransporters.forEach(transporter => {
        populateTransporterDropdowns(transporter, addSelect);
      });
    }

    // **NEW**: Toggle for the EDIT modal
    window.toggleEditVehicleInput = function(isMarket) {
      const ownVehicleFields = document.getElementById('editOwnVehicleFields');
      const marketVehicleFields = document.getElementById('editMarketVehicleFields');
      const transporterField = document.getElementById('editTransporterField');
      const ownDriverField = document.getElementById('editOwnDriverField'); // The container div
      const marketDriverField = document.getElementById('editMarketDriverField'); // The container div
      ownVehicleFields.style.display = isMarket ? 'none' : 'block';
      marketVehicleFields.style.display = isMarket ? 'block' : 'none';
      // Always show transporter field to allow switching bill-to in edit
      if (transporterField) transporterField.style.display = 'block';
      ownDriverField.style.display = isMarket ? 'none' : 'block';
      marketDriverField.style.display = isMarket ? 'block' : 'none';

      document.getElementById('editTruckNumber').required = !isMarket;
      document.getElementById('editMarketTruckNumber').required = isMarket;
      document.getElementById('editTransporterSelect').required = false; // Transporter optional
    }

    // --- TRIP DETAILS MODAL LOGIC (POST-SAVE) ---

    // Generic Expense Row Adder
    window.addExpenseRow = function(containerId, data = {}) {
      const container = document.getElementById(containerId);
      const entryDiv = document.createElement('div');
      entryDiv.className = 'row g-3 mb-2 expense-row align-items-center';

      // Create vendor dropdown HTML
      let vendorOptions = '<option value="">Select Vendor</option>';
      allWorkVendors.forEach(vendor => {
        vendorOptions += `<option value="${vendor.id}" ${data.vendorId === vendor.id ? 'selected' : ''}>${vendor.name}</option>`;
      });

      entryDiv.innerHTML = `
        <div class="col-md-2">
          <select class="form-select expense-type" onchange="window.toggleVendorDropdown(this)">
            <option value="Tyre">Tyre</option>
            <option value="Toll">Toll</option>
            <option value="Food">Food</option>
            <option value="Loading/Unloading">Loading/Unloading</option>
            <option value="Police Challan">Police Challan</option>
            <option value="TAC">TAC</option>
            <option value="Permit">Permit</option>
            <option value="Brokerage">Brokerage</option>
            <option value="Vehicle Work">Vehicle Work</option>
            <option value="Commission">Commission</option>
            <option value="Tirpal & Rope">Tirpal & Rope</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="col-md-2"><input type="number" step="0.01" class="form-control expense-amount" placeholder="Amount (₹)" value="${data.amount || ''}" oninput="calculateTripTotals()"></div>
        <div class="col-md-3 vendor-select-container" style="display: none;">
          <select class="form-select expense-vendor">${vendorOptions}</select>
        </div>
        <div class="col-md-2"><input type="date" class="form-control expense-date" value="${data.date || new Date().toISOString().split('T')[0]}"></div>
        <div class="col-md-2"><input type="text" class="form-control expense-note" placeholder="Remarks" value="${data.note || ''}"></div>
        <div class="col-md-1 text-center"><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.expense-row').remove(); calculateTripTotals();"><i class="fas fa-trash"></i></button></div>
      `;
      // Set selected type
      if (data.type) {
        entryDiv.querySelector('.expense-type').value = data.type;
      }
      container.appendChild(entryDiv);
      // Trigger the check to show/hide vendor dropdown on initial load
      window.toggleVendorDropdown(entryDiv.querySelector('.expense-type'));
    }

    // **NEW**: Show/hide vendor dropdown based on expense type
    window.toggleVendorDropdown = function(selectElement) {
        const expenseRow = selectElement.closest('.expense-row');
        const vendorContainer = expenseRow.querySelector('.vendor-select-container');
        const noteInput = expenseRow.querySelector('.expense-note');
        if (selectElement.value === 'Vehicle Work') {
            vendorContainer.style.display = 'block';
        } else {
            vendorContainer.style.display = 'none';
        }
    };

    // Open Trip Details Modal
    window.showTripDetailsModal = async function(lrId, lrNumber, weight, truckNumber, driverName) {
      // Reset to first tab
      const firstTab = document.querySelector('#tripDetailsTabs button');
      if (firstTab) new bootstrap.Tab(firstTab).show();
      
      currentTripLRId = lrId;

      // **FIX**: Check if the edit modal is open and use its weight value if it is.
      // This ensures that changes to weight in the edit form are reflected here.
      const editModal = document.getElementById('editLRModal');
      const isEditing = editModal.classList.contains('show');
      currentTripWeight = isEditing ? (parseFloat(document.getElementById('editWeight').value) || weight) : weight;

      currentTripTruckNumber = truckNumber; // **NEW**
      document.getElementById('modalLrNumber').textContent = lrNumber;
      document.getElementById('fuelEntryTruckNumber').textContent = truckNumber; // **NEW**

      // **NEW**: Fetch the last ending KM for this vehicle
      let lastKm = 0;
      if (truckNumber && currentCoreAccountId) {
        const vehicleQuery = db.ref(`users/${currentCoreAccountId}/vehicles`).orderByChild('vehicleNumber').equalTo(truckNumber);
        const vehicleSnap = await vehicleQuery.once('value');
        if (vehicleSnap.exists()) {
          const vehicleId = Object.keys(vehicleSnap.val())[0];
          const vehicleData = vehicleSnap.val()[vehicleId];
          lastKm = vehicleData.lastEndingKm || 0;
        }
      }
const lrRef = db.ref(`users/${currentCoreAccountId}/lrReports/${lrId}`);
      lrRef.once('value').then(snapshot => {
        const lr = snapshot.val();
        const details = lr.tripDetails || {};
        const isMarketVehicle = lr.lrType === 'market'; // This is now correct because the save logic is fixed
        const fuelTab = document.getElementById('fuel-tab');
        const fuelEntryTab = document.getElementById('fuel-entry-tab'); // **NEW**
        const expensesTab = document.getElementById('expenses-tab');
        const emptyExpensesTab = document.getElementById('empty-expenses-tab');
        const tripAdvanceField = document.getElementById('tripAdvanceField');
        const modalNavButtons = document.querySelectorAll('.modal-footer button[onclick^="navigateTripTabs"]');

        // Hide fields not applicable to market vehicles
        const ownVehicleOnlyElements = [fuelTab, fuelEntryTab, expensesTab, emptyExpensesTab, tripAdvanceField];
        ownVehicleOnlyElements.forEach(el => {
          if (el) el.style.display = isMarketVehicle ? 'none' : 'block';
        });

        // Reset advance to 0 if it's a market vehicle
        const tripAdvanceInput = document.getElementById('tripAdvance');
        if (isMarketVehicle) {
          tripAdvanceInput.value = 0;
        }

        modalNavButtons.forEach(btn => {
          btn.style.display = isMarketVehicle ? 'none' : 'inline-block';
        });

        // **NEW**: Show/hide commission field
        const commissionField = document.getElementById('commissionField');
        commissionField.style.display = isMarketVehicle ? 'block' : 'none';
        document.getElementById('tripCommission').value = details.commission || '';
        // END NEW

        // **NEW**: Pre-fill Starting KM if it hasn't been set for this trip yet.
        const startingKmInput = document.getElementById('tripStartingKm');
        startingKmInput.value = details.startingKm || lastKm;

        // 1. Billing, Freight & Advance
        document.getElementById('tripBillingRate').value = details.billingRate || '';
        document.getElementById('tripBillingAmount').value = details.billingAmount || '';
        document.getElementById('tripFreightRate').value = details.freightRate || '';
        document.getElementById('tripFreightAmount').value = details.freightAmount || '';
        document.getElementById('tripAdvance').value = details.advance || 0;
        document.getElementById('tripShortage').value = details.shortage || 0;
        document.getElementById('tripAdvancePaymentMode').value = details.advancePaymentMode || 'Cash';

        // 2. KM & Fuel Tracking
        document.getElementById('tripEndingKm').value = details.endingKm || '';
        document.getElementById('tripVehicleAverage').value = details.vehicleAverage || '';
        document.getElementById('tripDieselRatePerLiter').value = details.dieselRatePerLiter || '';
        calculateTotalKm(); // Recalculate auto fields

        // 3. Fuel Entry Tab - Load current fuel and recent entries
        loadCurrentFuelLevel(truckNumber);
        loadRecentFuelEntries(truckNumber);
        // Set default date for fuel entry
        document.getElementById('fuelFillDate').value = new Date().toISOString().split('T')[0];


        // 4. Trip Expenses (Generic List)
        const genericContainer = document.getElementById('tripGenericExpensesContainer');
        genericContainer.innerHTML = '';
        (details.genericExpenses || []).forEach(exp => addExpenseRow('tripGenericExpensesContainer', exp));
        
        // 5. Empty Trip Expenses (Generic List)
        const emptyGenericContainer = document.getElementById('emptyTripGenericExpensesContainer');
        emptyGenericContainer.innerHTML = '';
        const emptyDetails = lr.emptyTripData || {};
        (emptyDetails.genericExpenses || []).forEach(exp => addExpenseRow('emptyTripGenericExpensesContainer', exp));
        
        // 6. Taxes and Totals
        document.getElementById('tripCgstPercentage').value = details.cgstPercentage || 9;
        document.getElementById('tripSgstPercentage').value = details.sgstPercentage || 9;
        
        // Final calculation
        calculateTripTotals();

        // Show Modal
        const tripModal = new bootstrap.Modal(document.getElementById('tripDetailsModal'));
        tripModal.show();
      }).catch(error => {
        console.error("Error loading trip details:", error);
        alert("Failed to load trip details.");
      });
    }

    // **NEW**: Tab navigation helper
    window.navigateTripTabs = function(direction) {
      const tabs = Array.from(document.querySelectorAll('#tripDetailsTabs .nav-link'));
      const activeTab = document.querySelector('#tripDetailsTabs .nav-link.active');
      const activeTabIndex = tabs.findIndex(tab => tab.classList.contains('active'));
      
      let nextIndex = activeTabIndex + direction;
      // Skip hidden tabs (market vehicle scenario)
      while (tabs[nextIndex] && tabs[nextIndex].parentElement.style.display === 'none') {
          nextIndex += direction;
      }

      // Wrap around
      if (nextIndex >= tabs.length) nextIndex = 0;
      if (nextIndex < 0) nextIndex = tabs.length - 1;

      // Handle wrapping around to a hidden tab at the end/start
      if (tabs[nextIndex].parentElement.style.display === 'none') {
          // Fallback: If after wrap the tab is still hidden, just stop or go to the first visible one
          return;
      }
      
      // Load fuel pumps if navigating to the fuel entry tab
      if (tabs[nextIndex].id === 'fuel-entry-tab') {
        loadFuelPumps();
      }

      const newTab = new bootstrap.Tab(tabs[nextIndex]);
      newTab.show();
    }
    
    // **NEW**: Fuel Entry Functions
    
    // 1. Calculate Amount in Fuel Entry Tab
    window.calculateFuelTotalAmount = function() {
        const liters = parseFloat(document.getElementById('fuelLiters').value) || 0;
        const rate = parseFloat(document.getElementById('fuelPerLiter').value) || 0;
        document.getElementById('fuelAmount').value = (liters * rate).toFixed(2);
    }
    
    // 2. Load Pumps to Dropdown
    window.loadFuelPumps = function() {
        const select = document.getElementById('fuelPumpSelect');
        // Check if options are already loaded to avoid duplicates
        if (select.options.length > 1 && allPumps.length > 0) return;

        select.innerHTML = '<option value="">Select a Pump</option>';
        allPumps.forEach(pump => {
            const option = document.createElement('option');
            option.value = pump.id;
            option.textContent = pump.name;
            select.appendChild(option);
        });
    }
    
    // 3. Load Current Fuel Level
    async function loadCurrentFuelLevel(truckNumber) {
        // FIX 1: Ensure currentFuelLevel element exists
        const currentFuelDisplay = document.getElementById('currentFuelLevel');
        if (!currentFuelDisplay) {
            console.error("DOM element #currentFuelLevel not found.");
            return;
        }
        currentFuelDisplay.textContent = '...';
        
        const vehicle = allVehicles.find(v => (v.vehicleNo || v.vehicleNumber || '').toUpperCase() === truckNumber.toUpperCase());
        if (vehicle && currentCoreAccountId) {
            const vRef = db.ref(`users/${currentCoreAccountId}/vehicles/${vehicle.id}`);
            const curSnap = await vRef.child('currentFuel').once('value');
            const currentFuel = parseFloat(curSnap.val()) || 0;
            currentFuelDisplay.textContent = `${currentFuel.toFixed(2)} Liters`;
            currentFuelDisplay.classList.remove('text-danger', 'text-warning', 'text-success');
            if (currentFuel < 5) {
                currentFuelDisplay.classList.add('text-danger');
            } else if (currentFuel < 20) {
                currentFuelDisplay.classList.add('text-warning');
            } else {
                currentFuelDisplay.classList.add('text-success');
            }
        } else {
            currentFuelDisplay.textContent = 'N/A (Vehicle Not Found)';
        }
    }

    // 4. Load Recent Fuel Entries
    async function loadRecentFuelEntries(truckNumber) {
        const body = document.getElementById('recentFuelEntriesBody');
        body.innerHTML = '<tr><td colspan="6">Loading entries...</td></tr>';
        
        const fuelEntriesRef = db.ref(`users/${currentCoreAccountId}/fuelLogs`).orderByChild('truckNumber').equalTo(truckNumber);
        
        fuelEntriesRef.once('value').then(snapshot => {
            body.innerHTML = '';
            let hasData = false;
            // Convert snapshot to array and sort by timestamp/date descending
            const entries = [];
            snapshot.forEach(child => {
                const entry = child.val();
                if (entry.source === 'pump-fillup' || entry.source === 'manual') {
                    entries.push({ key: child.key, ...entry });
                }
            });

            entries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            entries.forEach(entry => {
                hasData = true;
                const pumpName = allPumps.find(p => p.id === entry.pumpId)?.name || 'N/A';
                const newRow = body.insertRow();
                newRow.innerHTML = `
                    <td>${entry.date || (new Date(entry.timestamp).toISOString().split('T')[0])}</td>
                    <td>${pumpName}</td>
                    <td class="text-end">${(entry.filledLiters || 0).toFixed(2)}</td>
                    <td class="text-end">${(entry.totalAmount || 0).toFixed(2)}</td>
                    <td>${entry.remarks || '-'}</td>
                `;
            });
            if (!hasData) {
                body.innerHTML = '<tr><td colspan="5">No recent fuel fill-up entries found for this truck.</td></tr>';
            }
        }).catch(error => {
            console.error("Error loading fuel entries:", error);
            body.innerHTML = '<tr><td colspan="5" class="text-danger">Failed to load entries.</td></tr>';
        });
    }

    // 5. Handle Fuel Entry Form Submission
    document.getElementById('fuelEntryForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const liters = parseFloat(document.getElementById('fuelLiters').value);
        const rate = parseFloat(document.getElementById('fuelPerLiter').value);
        const amount = parseFloat(document.getElementById('fuelAmount').value);
        const pumpId = document.getElementById('fuelPumpSelect').value;
        const fillDate = document.getElementById('fuelFillDate').value;
        // FIX 2: Added #fuelTripKm to HTML
        const kmReading = document.getElementById('fuelTripKm').value; 
        const remarks = document.getElementById('fuelRemarks').value;
        
        if (!currentTripTruckNumber || !currentCoreAccountId) {
            alert('Error: Truck or Account ID not set.');
            return;
        }

        const vehicle = allVehicles.find(v => (v.vehicleNo || v.vehicleNumber || '').toUpperCase() === currentTripTruckNumber.toUpperCase());
        if (!vehicle) {
            alert('Error: Vehicle not found in master list.');
            return;
        }
        
        const logData = {
            timestamp: new Date().toISOString(),
            date: fillDate, 
            source: 'pump-fillup',
            truckNumber: currentTripTruckNumber,
            vehicleId: vehicle.id,
            filledLiters: liters,
            perLiter: rate,
            totalAmount: amount,
            pumpId: pumpId,
            kmReading: kmReading ? parseFloat(kmReading) : null,
            remarks: remarks,
            userId: auth.currentUser.uid,
            coreAccountId: currentCoreAccountId, // Explicitly set coreAccountId for rules
            lrNumber: document.getElementById('modalLrNumber').textContent // Log the associated LR for context
        };

        try {
            const vRef = db.ref(`users/${currentCoreAccountId}/vehicles/${vehicle.id}`);
            const curSnap = await vRef.child('currentFuel').once('value');
            const before = parseFloat(curSnap.val()) || 0;
            const after = before + liters;

            const updates = {};
            const newLogKey = db.ref(`users/${currentCoreAccountId}/fuelLogs`).push().key;
            
            // 1. Update Vehicle's Current Fuel
            updates[`users/${currentCoreAccountId}/vehicles/${vehicle.id}/currentFuel`] = after;

            // 2. Add Fuel Log
            updates[`users/${currentCoreAccountId}/fuelLogs/${newLogKey}`] = {
                ...logData,
                beforeLiters: before,
                afterLiters: after,
            };

            // **NEW**: Add a reference to this log under the selected pump's transactions
            // Note: Pump data is stored under the user's direct UID, not the coreAccountId.
            updates[`users/${auth.currentUser.uid}/petrolPumps/${pumpId}/transactions/${newLogKey}`] = true;

            await db.ref().update(updates);
            
            alert(`Fuel entry recorded! Tank level updated to ${after.toFixed(2)} Liters.`);
            e.target.reset();
            loadCurrentFuelLevel(currentTripTruckNumber); // Refresh display
            loadRecentFuelEntries(currentTripTruckNumber); // Refresh table

        } catch (error) {
            console.error('Error saving fuel entry:', error);
            alert('Error saving fuel entry: ' + error.message);
        }
    });

    // Trip Details Calculations

    function calculateTotalKm() {
      const start = parseFloat(document.getElementById('tripStartingKm').value) || 0;
      const end = parseFloat(document.getElementById('tripEndingKm').value) || 0;
      const totalKm = Math.max(0, end - start);
      document.getElementById('tripTotalKm').value = totalKm.toFixed(2);
      calculateFuelUsed();
    }

    function calculateFuelUsed() {
      const totalKm = parseFloat(document.getElementById('tripTotalKm').value) || 0;
      const avg = parseFloat(document.getElementById('tripVehicleAverage').value) || 0;
      const fuelUsed = avg > 0 ? (totalKm / avg) : 0;
      // **FIXED**: Make sure this is still calculated even if the input is made readonly.
      document.getElementById('tripFuelUsedLiters').value = fuelUsed.toFixed(2);
      loadCurrentFuelLevel(currentTripTruckNumber); // Refresh display
      calculateFuelAmount();
    }
    
    function calculateFuelAmount() {
      const liters = parseFloat(document.getElementById('tripFuelUsedLiters').value) || 0;
      const rate = parseFloat(document.getElementById('tripDieselRatePerLiter').value) || 0;
      // This function's main purpose is to trigger calculateTripTotals()
      calculateTripTotals();
    }

    function calculateTripBillingAmount() {
      const weight = currentTripWeight || 0;
      const rate = parseFloat(document.getElementById('tripBillingRate').value) || 0;
      document.getElementById('tripBillingAmount').value = (weight * rate).toFixed(2);
      calculateTripTotals();
    }

    function calculateTripBillingRate() {
      const weight = currentTripWeight || 0;
      const amount = parseFloat(document.getElementById('tripBillingAmount').value) || 0;
      if (weight > 0) {
        document.getElementById('tripBillingRate').value = (amount / weight).toFixed(2);
      }
      calculateTripTotals();
    }

    function calculateTripFreightAmount() {
      const weight = currentTripWeight || 0;
      const rate = parseFloat(document.getElementById('tripFreightRate').value) || 0;
      document.getElementById('tripFreightAmount').value = (weight * rate).toFixed(2);
      calculateTripTotals();
    }

    function calculateTripFreightRate() {
      const weight = currentTripWeight || 0;
      const amount = parseFloat(document.getElementById('tripFreightAmount').value) || 0;
      if (weight > 0) {
        document.getElementById('tripFreightRate').value = (amount / weight).toFixed(2);
      }
      calculateTripTotals();
    }

    // **UPDATED** to calculate totals from generic expense containers
    function calculateTripTotals() {
        const billingAmount = parseFloat(document.getElementById('tripBillingAmount').value) || 0;
        const freightAmount = parseFloat(document.getElementById('tripFreightAmount').value) || 0;
        const advance = parseFloat(document.getElementById('tripAdvance').value) || 0;
        const shortage = parseFloat(document.getElementById('tripShortage').value) || 0;
        const billingRate = currentTripWeight > 0 ? (billingAmount / currentTripWeight) : 0;
        
        const cgstP = parseFloat(document.getElementById('tripCgstPercentage').value) || 0;
        const sgstP = parseFloat(document.getElementById('tripSgstPercentage').value) || 0;
        
        // Calculate Generic Expenses from the container (includes all categories)
        let genericE = 0;
        document.querySelectorAll('#tripGenericExpensesContainer .expense-amount').forEach(input => {
            genericE += parseFloat(input.value) || 0;
        });
        document.getElementById('tripTotalExpensesDisplay').textContent = `₹${genericE.toFixed(2)}`;

        let emptyGenericE = 0;
        document.querySelectorAll('#emptyTripGenericExpensesContainer .expense-amount').forEach(input => {
            emptyGenericE += parseFloat(input.value) || 0;
        });
        document.getElementById('emptyTripTotalExpensesDisplay').textContent = `₹${emptyGenericE.toFixed(2)}`;
        
        // Tax Calculations
        const cgstAmount = (billingAmount * cgstP) / 100;
        const sgstAmount = (billingAmount * sgstP) / 100;
        
        const totalBillingAmount = billingAmount + cgstAmount + sgstAmount;
        document.getElementById('tripTotalBillingAmount').value = totalBillingAmount.toFixed(2);

        // Total Expenses & Driver Payable
        // Total expenses = sum of all generic expense amounts (both trip and empty)
        const totalExpenses = genericE + emptyGenericE + advance; // Includes Advance in total expense
        document.getElementById('tripTotalExpenses').value = totalExpenses.toFixed(2);

        const oldDriverPayable = freightAmount - advance; 
        document.getElementById('tripDriverPayable').value = oldDriverPayable.toFixed(2);
        
        // Client Balance
        const shortageDeduction = (shortage / 1000) * billingRate;
        // **FIX**: Client balance should be based on the pre-GST billing amount.
        const clientBalance = billingAmount - advance - shortageDeduction;
        document.getElementById('tripClientBalance').value = clientBalance.toFixed(2); // This now reflects live changes correctly.
    }

    // Save Trip Details - FIXED FUEL DEDUCTION LOGIC
    document.getElementById('saveTripDetailsBtn').addEventListener('click', async () => {
      if (!currentTripLRId || !currentCoreAccountId) {
        alert('Error: LR not selected.');
        return;
      }
      
      const isMarketVehicle = (await db.ref(`users/${currentCoreAccountId}/lrReports/${currentTripLRId}/lrType`).once('value')).val() === 'market';
      const endingKm = parseFloat(document.getElementById('tripEndingKm').value) || 0;
      const startingKm = parseFloat(document.getElementById('tripStartingKm').value) || 0;
      const fuelUsedLiters = parseFloat(document.getElementById('tripFuelUsedLiters').value) || 0;
      const vehicleNumber = currentTripTruckNumber;

      // **MODIFIED**: Validation for Own Vehicles - only if Ending KM is entered.
      if (!isMarketVehicle && endingKm > 0) {
          if (endingKm < startingKm) {
              alert('Ending KM cannot be less than Starting KM.');
              return;
          }
      }

      // Collect Generic Expenses (Main Trip)
      const genericExpenses = [];
      document.querySelectorAll('#tripGenericExpensesContainer .expense-row').forEach(div => {
        const type = div.querySelector('.expense-type').value;
        const note = div.querySelector('.expense-note').value;
        const amount = parseFloat(div.querySelector('.expense-amount').value) || 0;
        if (amount > 0) {
          const expenseData = { type, note, amount, date: div.querySelector('.expense-date').value };
          // **NEW**: If it's vehicle work, also save the vendorId
          if (type === 'Vehicle Work') {
            const vendorSelect = div.querySelector('.expense-vendor');
            if (vendorSelect) expenseData.vendorId = vendorSelect.value;
          }
          genericExpenses.push(expenseData);
        }
      });

      // Collect Generic Expenses (Empty Trip)
      const emptyGenericExpenses = [];
      document.querySelectorAll('#emptyTripGenericExpensesContainer .expense-row').forEach(div => {
        const type = div.querySelector('.expense-type').value;
        const note = div.querySelector('.expense-note').value;
        const amount = parseFloat(div.querySelector('.expense-amount').value) || 0;
        if (amount > 0) {
          const expenseData = { type, note, amount, date: div.querySelector('.expense-date').value };
          // **NEW**: If it's vehicle work, also save the vendorId
          if (type === 'Vehicle Work') {
            const vendorSelect = div.querySelector('.expense-vendor');
            if (vendorSelect) expenseData.vendorId = vendorSelect.value;
          }
          emptyGenericExpenses.push(expenseData);
        }
      });
      
      // **NEW LOGIC: Aggregate generic expenses into separate fields**
      const aggregateExpenses = (expensesArray) => {
          const aggregated = {
              tyreExpenses: 0,
              tollExpenses: 0,
              foodExpenses: 0,
              loadingUnloadingExpenses: 0,
              policeChallanExpenses: 0,
              tacExpenses: 0,
              permitExpenses: 0,
              brokerageExpenses: 0,
              vehicleWorkAmount: 0,
              commissionExpenses: 0,
              tirpalRopeExpenses: 0,
              otherExpenses: 0,
          };
          expensesArray.forEach(exp => {
              switch (exp.type) {
                  case 'Tyre': aggregated.tyreExpenses += exp.amount; break;
                  case 'Toll': aggregated.tollExpenses += exp.amount; break;
                  case 'Food': aggregated.foodExpenses += exp.amount; break;
                  case 'Loading/Unloading': aggregated.loadingUnloadingExpenses += exp.amount; break;
                  case 'Police Challan': aggregated.policeChallanExpenses += exp.amount; break;
                  case 'TAC': aggregated.tacExpenses += exp.amount; break;
                  case 'Permit': aggregated.permitExpenses += exp.amount; break;
                  case 'Brokerage': aggregated.brokerageExpenses += exp.amount; break;
                  case 'Vehicle Work': aggregated.vehicleWorkAmount += exp.amount; break;
                  case 'Commission': aggregated.commissionExpenses += exp.amount; break;
                  case 'Tirpal & Rope': aggregated.tirpalRopeExpenses += exp.amount; break;
                  case 'Other': aggregated.otherExpenses += exp.amount; break;
              }
          });
          return aggregated;
      };
      
      const tripAggregated = aggregateExpenses(genericExpenses);
      const emptyTripAggregated = aggregateExpenses(emptyGenericExpenses);
      // **END NEW LOGIC**

      // Recalculate totals before saving to ensure correctness
      calculateTripTotals();

      const tripDetails = {
        // Billing, Freight & Advance
        billingRate: parseFloat(document.getElementById('tripBillingRate').value) || 0,
        billingAmount: parseFloat(document.getElementById('tripBillingAmount').value) || 0,
        freightRate: parseFloat(document.getElementById('tripFreightRate').value) || 0,
        freightAmount: parseFloat(document.getElementById('tripFreightAmount').value) || 0,
        advance: parseFloat(document.getElementById('tripAdvance').value) || 0,
        shortage: parseFloat(document.getElementById('tripShortage').value) || 0,
        advancePaymentMode: document.getElementById('tripAdvancePaymentMode').value,
        commission: parseFloat(document.getElementById('tripCommission').value) || 0, 
        
        // KM & Fuel Tracking
        startingKm: startingKm,
        endingKm: endingKm,
        totalKm: parseFloat(document.getElementById('tripTotalKm').value) || 0,
        vehicleAverage: parseFloat(document.getElementById('tripVehicleAverage').value) || 0,
        fuelUsedLiters: fuelUsedLiters,
        dieselRatePerLiter: parseFloat(document.getElementById('tripDieselRatePerLiter').value) || 0,
        
        // **UPDATED: Saved aggregated expenses**
        ...tripAggregated,
        genericExpenses: genericExpenses, // Keep raw array
        
        // Taxes and Totals
        cgstPercentage: parseFloat(document.getElementById('tripCgstPercentage').value) || 9,
        sgstPercentage: parseFloat(document.getElementById('tripSgstPercentage').value) || 9,
        
        totalBillingAmount: parseFloat(document.getElementById('tripTotalBillingAmount').value) || 0,
        totalExpenses: parseFloat(document.getElementById('tripTotalExpenses').value) || 0,
        driverPayable: parseFloat(document.getElementById('tripDriverPayable').value) || 0,
        clientBalance: parseFloat(document.getElementById('tripClientBalance').value) || 0,
        updatedAt: new Date().toISOString()
      };
      
      // Separate structure for empty trip data
      const emptyTripData = {
          emptyTrip: (emptyGenericExpenses.length > 0) || false,
          ...emptyTripAggregated,
          genericExpenses: emptyGenericExpenses, // Keep raw array
          updatedAt: new Date().toISOString()
      };


      try {
        // 1. Update the LR report with trip details and empty trip data
        const lrRef = db.ref(`users/${currentCoreAccountId}/lrReports/${currentTripLRId}`);
        
        // Get current trip details to check fuel deduction status
        const currentLRSnapshot = await lrRef.once('value');
        const currentLR = currentLRSnapshot.val();
        const currentTripDetails = currentLR.tripDetails || {};
        const fuelAlreadyDeducted = currentTripDetails.fuelAlreadyDeducted || false;

        // Update the main LR data
        await lrRef.update({
            tripDetails: tripDetails,
            emptyTripData: emptyTripData,
            emptyTrip: emptyTripData.emptyTrip // Flag on the root
        });

        // **FIXED FUEL DEDUCTION LOGIC**: Only deduct fuel if it hasn't been deducted before
        if (!isMarketVehicle && endingKm > 0 && fuelUsedLiters > 0 && !fuelAlreadyDeducted) {
            const vehicleQuery = db.ref(`users/${currentCoreAccountId}/vehicles`).orderByChild('vehicleNumber').equalTo(vehicleNumber);
            const vehicleSnap = await vehicleQuery.once('value');
            if (vehicleSnap.exists()) {
                const vehicleId = Object.keys(vehicleSnap.val())[0];
                const vehicleUpdateRef = db.ref(`users/${currentCoreAccountId}/vehicles/${vehicleId}`);

                const updates = { lastEndingKm: endingKm };
                
                // --- FUEL DEDUCTION LOGIC (ONLY ON FIRST SAVE) ---
                const vRef = db.ref(`users/${currentCoreAccountId}/vehicles/${vehicleId}`);
                const curSnap = await vRef.child('currentFuel').once('value');
                const before = parseFloat(curSnap.val()) || 0;
                
                // Check if the current fuel is enough for the deduction
                if (before < fuelUsedLiters) {
                    console.warn(`Attempted to deduct ${fuelUsedLiters.toFixed(2)}L but only ${before.toFixed(2)}L available in tank. Setting tank to 0L.`);
                }

                const after = Math.max(before - fuelUsedLiters, 0);
                updates.currentFuel = after;

                // Mark that fuel has been deducted for this trip
                await lrRef.child('tripDetails/fuelAlreadyDeducted').set(true);
                
                // Log fuel usage
                await db.ref(`users/${currentCoreAccountId}/fuelLogs`).push({
                  timestamp: new Date().toISOString(),
                  source: 'lr-detail-usage',
                  lrNumber: document.getElementById('modalLrNumber').textContent,
                  usedLiters: fuelUsedLiters,
                  vehicleAverageKmPerL: tripDetails.vehicleAverage,
                  totalKm: tripDetails.totalKm,
                  beforeLiters: before,
                  afterLiters: after,
                  truckNumber: vehicleNumber,
                  userId: auth.currentUser.uid,
                  coreAccountId: currentCoreAccountId,
                  fuelAlreadyDeducted: true
                });

                await vehicleUpdateRef.update(updates);
                console.log(`Fuel deducted: ${fuelUsedLiters.toFixed(2)}L. Tank level: ${before.toFixed(2)}L -> ${after.toFixed(2)}L`);
            }
        } else if (fuelAlreadyDeducted) {
            console.log('Fuel already deducted for this trip. Skipping fuel deduction.');
        }
        // --- END FIXED FUEL DEDUCTION LOGIC ---
        // **FIX**: 2. Log or Update vehicle work payment to prevent duplicates
        const workPaymentsRef = db.ref(`users/${currentCoreAccountId}/workPayments`);
        const existingPaymentQuery = workPaymentsRef.orderByChild('lrId').equalTo(currentTripLRId);
        const existingPaymentSnap = await existingPaymentQuery.once('value');

        if (existingPaymentSnap.exists()) {
            // Payment for this LR already exists, update it
            const paymentId = Object.keys(existingPaymentSnap.val())[0];
            const paymentUpdateRef = db.ref(`users/${currentCoreAccountId}/workPayments/${paymentId}`);
            if (tripDetails.vehicleWorkAmount > 0) {
                // Update the existing payment amount
                await paymentUpdateRef.update({ amount: tripDetails.vehicleWorkAmount });
                console.log(`Updated vehicle work payment for LR ${currentTripLRId}.`);
            } else {
                // If work amount is set to 0, remove the payment log
                await paymentUpdateRef.remove();
                console.log(`Removed vehicle work payment for LR ${currentTripLRId} as amount was zero.`);
            }
        } else if (tripDetails.vehicleWorkAmount > 0) {
            // No existing payment, create a new one
            const lrSnap = await lrRef.once('value');
            const lr = lrSnap.val() || {};
            const newWorkData = {
                amount: tripDetails.vehicleWorkAmount,
                date: lr.date,
                notes: `Work for LR No: ${lr.lrNumber} (Trip Expense)`,
                userId: auth.currentUser.uid,
                createdAt: new Date().toISOString(),
                lrId: currentTripLRId, // Associate payment with LR
                lrNumber: lr.lrNumber,
                truckNumber: lr.truckNumber
            };
            await workPaymentsRef.push(newWorkData);
            console.log(`Created new vehicle work payment for LR ${currentTripLRId}.`);
        }
        
        
        alert('Trip details saved and all related entries logged successfully!');
        const tripModal = bootstrap.Modal.getInstance(document.getElementById('tripDetailsModal'));
        tripModal.hide();

        // **NEW**: Update Tyre Running KMs
        if (!isMarketVehicle && tripDetails.totalKm > 0) {
          try {
            const vehicleQuery = db.ref(`users/${currentCoreAccountId}/vehicles`).orderByChild('vehicleNumber').equalTo(vehicleNumber);
            const vehicleSnap = await vehicleQuery.once('value');
            
            if (vehicleSnap.exists()) {
              const vehicleId = Object.keys(vehicleSnap.val())[0];
              const vehicleData = vehicleSnap.val()[vehicleId];
              const vehicleUpdateRef = db.ref(`users/${currentCoreAccountId}/vehicles/${vehicleId}`);

              const updates = {
                lastEndingKm: tripDetails.endingKm
              };

              // Update KMs for each tyre on the vehicle
              if (vehicleData.tyres && Array.isArray(vehicleData.tyres)) {
                updates.tyres = vehicleData.tyres.map(tyre => {
                  const currentKm = tyre.totalRunningKm || 0;
                  return {
                    ...tyre,
                    totalRunningKm: currentKm + tripDetails.totalKm
                  };
                });
              }

              await vehicleUpdateRef.update(updates);
              console.log(`Updated running KMs for vehicle ${vehicleNumber}.`);
            }
          } catch (kmError) {
            console.error("Error updating tyre running KMs:", kmError);
            // Non-critical error, so we don't show an alert to the user.
          }
        }

        loadLRData(); // Refresh the main table
        
      } catch (error) {
        console.error('Error saving trip details:', error);
        alert('Error saving trip details: ' + error.message);
      }
    });

    // --- QUICK ADD FUNCTIONS ---
    document.addEventListener('DOMContentLoaded', function() {
      // 1. Client/Consignee Quick Add Button Fix
      const quickAddClientBtn = document.getElementById('quickAddClientBtn');
      if (quickAddClientBtn) {
        quickAddClientBtn.addEventListener('click', () => {
             const modal = new bootstrap.Modal(document.getElementById('quickAddClientModal'));
             modal.show();
        });
      }

      const quickAddConsigneeBtn = document.getElementById('quickAddConsigneeBtn');
      if (quickAddConsigneeBtn) {
        quickAddConsigneeBtn.addEventListener('click', () => {
             const modal = new bootstrap.Modal(document.getElementById('quickAddClientModal'));
             modal.show();
        });
      }
      
      const saveQuickAddClientBtn = document.getElementById('saveQuickAddClientBtn');
      if (saveQuickAddClientBtn) {
        saveQuickAddClientBtn.addEventListener('click', saveQuickAddClient);
      }

      // 2. Route Quick Add Button Fix
      const routeSelect = document.getElementById('routeSelect');
      const routeSelectParent = routeSelect ? routeSelect.parentElement : null;
      if (routeSelect && routeSelectParent && !routeSelectParent.querySelector('#quickAddRouteBtn')) {
        const quickAddRouteBtn = document.createElement('button');
        quickAddRouteBtn.className = 'btn btn-outline-success';
        quickAddRouteBtn.type = 'button';
        quickAddRouteBtn.id = 'quickAddRouteBtn'; // Give it an ID
        quickAddRouteBtn.title = 'Add New Route';
        quickAddRouteBtn.innerHTML = '<i class="fas fa-plus"></i>';
        
        if (routeSelectParent.classList.contains('input-group')) { // Check if it's already an input group from HTML
            routeSelectParent.appendChild(quickAddRouteBtn);
        } else {
            // Fallback (though HTML should be fixed now)
            const inputGroup = document.createElement('div');
            inputGroup.className = 'input-group';
            routeSelectParent.replaceChild(inputGroup, routeSelect);
            inputGroup.appendChild(routeSelect);
            inputGroup.appendChild(quickAddRouteBtn);
        }
        
        quickAddRouteBtn.addEventListener('click', () => new bootstrap.Modal(document.getElementById('quickAddRouteModal')).show());
      }
      
      const saveQuickAddRouteBtn = document.getElementById('saveQuickAddRouteBtn');
      if (saveQuickAddRouteBtn) {
        saveQuickAddRouteBtn.addEventListener('click', saveQuickAddRoute);
      }

      // 3. Vehicle Quick Add Fix (Original logic is mostly fine, just ensuring listeners are clean)
      const truckNumberSelect = document.getElementById('truckNumber');
      if (truckNumberSelect) {
        const truckNumberParent = truckNumberSelect.closest('.input-group');
        if (truckNumberParent && !truckNumberParent.querySelector('#quickAddVehicleBtn')) {
            const quickAddVehicleBtn = document.createElement('button');
            quickAddVehicleBtn.className = 'btn btn-outline-success';
            quickAddVehicleBtn.type = 'button';
            quickAddVehicleBtn.id = 'quickAddVehicleBtn';
            quickAddVehicleBtn.title = 'Add New Vehicle';
            quickAddVehicleBtn.innerHTML = '<i class="fas fa-plus"></i>';
            truckNumberParent.appendChild(quickAddVehicleBtn);
            
            quickAddVehicleBtn.addEventListener('click', () => new bootstrap.Modal(document.getElementById('quickAddVehicleModal')).show());
        }
      }

      const saveQuickAddVehicleBtn = document.getElementById('saveQuickAddVehicleBtn');
      if (saveQuickAddVehicleBtn) {
        saveQuickAddVehicleBtn.addEventListener('click', saveQuickAddVehicle);
      }
      
      // 4. Driver Quick Add Fix (Original logic is mostly fine, just ensuring listeners are clean)
      const driverSelect = document.getElementById('driverSelect');
      if (driverSelect) {
        const driverSelectParent = driverSelect.closest('.input-group');
        if (driverSelectParent && !driverSelectParent.querySelector('#quickAddDriverBtn')) {
            const quickAddDriverBtn = document.createElement('button');
            quickAddDriverBtn.className = 'btn btn-outline-success';
            quickAddDriverBtn.type = 'button';
            quickAddDriverBtn.id = 'quickAddDriverBtn';
            quickAddDriverBtn.title = 'Add New Driver';
            quickAddDriverBtn.innerHTML = '<i class="fas fa-plus"></i>';
            driverSelectParent.appendChild(quickAddDriverBtn);
            
            quickAddDriverBtn.addEventListener('click', () => new bootstrap.Modal(document.getElementById('quickAddDriverModal')).show());
        }
      }

      const saveQuickAddDriverBtn = document.getElementById('saveQuickAddDriverBtn');
      if (saveQuickAddDriverBtn) {
        saveQuickAddDriverBtn.addEventListener('click', saveQuickAddDriver);
      }

      // **FIX**: Attach listener for the "Add New Route" button on the main form.
      const newQuickAddRouteBtn = document.getElementById('quickAddRouteBtn');
      if (newQuickAddRouteBtn) {
        newQuickAddRouteBtn.addEventListener('click', () => {
          new bootstrap.Modal(document.getElementById('quickAddRouteModal')).show();
        });
      }

      // **FIX**: Attach listeners for the new buttons added to the form.
      const newQuickAddVehicleBtn = document.getElementById('quickAddVehicleBtn');
      if (newQuickAddVehicleBtn) {
        newQuickAddVehicleBtn.addEventListener('click', () => {
          new bootstrap.Modal(document.getElementById('quickAddVehicleModal')).show();
        });
      }

      const newQuickAddDriverBtn = document.getElementById('quickAddDriverBtn');
      if (newQuickAddDriverBtn) {
        newQuickAddDriverBtn.addEventListener('click', () => {
          new bootstrap.Modal(document.getElementById('quickAddDriverModal')).show();
        });
      }

      // **NEW**: Attach listeners for the new buttons in the EDIT modal.
      const editQuickAddVehicleBtn = document.getElementById('editQuickAddVehicleBtn');
      if (editQuickAddVehicleBtn) {
        editQuickAddVehicleBtn.addEventListener('click', () => new bootstrap.Modal(document.getElementById('quickAddVehicleModal')).show());
      }
      const editQuickAddDriverBtn = document.getElementById('editQuickAddDriverBtn');
      if (editQuickAddDriverBtn) {
        editQuickAddDriverBtn.addEventListener('click', () => new bootstrap.Modal(document.getElementById('quickAddDriverModal')).show());
      }
      const editQuickAddClientBtn = document.getElementById('editQuickAddClientBtn');
      if (editQuickAddClientBtn) {
        editQuickAddClientBtn.addEventListener('click', () => new bootstrap.Modal(document.getElementById('quickAddClientModal')).show());
      }
      const editQuickAddTransporterBtn = document.getElementById('editQuickAddTransporterBtn');
      if (editQuickAddTransporterBtn) {
        editQuickAddTransporterBtn.addEventListener('click', () => new bootstrap.Modal(document.getElementById('quickAddTransporterModal')).show());
      }
      const editQuickAddRouteBtn = document.getElementById('editQuickAddRouteBtn');
      if (editQuickAddRouteBtn) {
        editQuickAddRouteBtn.addEventListener('click', () => new bootstrap.Modal(document.getElementById('quickAddRouteModal')).show());
      }
      const editQuickAddConsigneeBtn = document.getElementById('editQuickAddConsigneeBtn');
      if (editQuickAddConsigneeBtn) {
        editQuickAddConsigneeBtn.addEventListener('click', () => new bootstrap.Modal(document.getElementById('quickAddClientModal')).show());
      }

    });

    async function saveQuickAddClient() {
      const name = document.getElementById('q_clientName').value.trim();
      if (!name) { alert('Client Name is required.'); return; }
      const clientData = {
        clientName: name,
        contactPerson: document.getElementById('q_contactPerson').value,
        mobile: document.getElementById('q_mobile').value,
        gstin: document.getElementById('q_gstin').value,
        billingAddress: document.getElementById('q_billingAddress').value,
        createdAt: new Date().toISOString()
      };
      if (!currentCoreAccountId) { alert('Account not loaded.'); return; } // Added check
      const newRef = db.ref(`users/${currentCoreAccountId}/clients`).push();
      await newRef.set(clientData);
      bootstrap.Modal.getInstance(document.getElementById('quickAddClientModal')).hide();
      document.getElementById('quickAddClientForm').reset();
      alert('Client added successfully!');
      // The onValue listener will auto-refresh the dropdown. We just need to select it.
      setTimeout(() => {
        document.getElementById('clientId').value = newRef.key;
        document.getElementById('consigneeId').value = newRef.key;
      }, 500);
    }

    async function saveQuickAddRoute() {
      const from = document.getElementById('q_fromLocation').value.trim();
      const to = document.getElementById('q_toLocation').value.trim();
      if (!from || !to) { alert('From and To locations are required.'); return; }
      const routeData = {
        from: from,
        to: to,
        distance: parseFloat(document.getElementById('q_distance').value) || 0,
        updatedAt: new Date().toISOString() // **FIX**: Changed 'createdAt' to 'updatedAt' to match security rules.
      };
      if (!currentCoreAccountId) { alert('Account not loaded.'); return; } // Added check
      const newRef = db.ref(`users/${currentCoreAccountId}/routes`).push();
      await newRef.set(routeData);
      bootstrap.Modal.getInstance(document.getElementById('quickAddRouteModal')).hide();
      document.getElementById('quickAddRouteForm').reset();
      alert('Route added successfully!');
      setTimeout(() => document.getElementById('routeSelect').value = newRef.key, 500);
    }

    async function saveQuickAddTransporter() {
      const name = document.getElementById('q_transporterName').value.trim();
      if (!name) { alert('Transporter Name is required.'); return; }
      const transporterData = {
        name: name,
        contactPerson: document.getElementById('q_transporterContactPerson').value,
        mobile: document.getElementById('q_transporterMobile').value,
        gstin: document.getElementById('q_transporterGstin').value,
        createdAt: new Date().toISOString()
      };
      if (!currentCoreAccountId) { alert('Account not loaded.'); return; } // Added check
      const newRef = db.ref(`users/${currentCoreAccountId}/transporters`).push();
      await newRef.set(transporterData);
      bootstrap.Modal.getInstance(document.getElementById('quickAddTransporterModal')).hide();
      document.getElementById('quickAddTransporterForm').reset();
      alert('Transporter added successfully!');
      setTimeout(() => document.getElementById('transporterSelect').value = newRef.key, 500);
    }

    async function saveQuickAddVehicle() {
      const number = document.getElementById('q_vehicleNumber').value.trim().toUpperCase();
      if (!number) { alert('Vehicle Number is required.'); return; }
      const vehicleData = {
        vehicleNumber: number,
        vehicleType: document.getElementById('q_vehicleType').value,
        createdAt: new Date().toISOString()
      };
      if (!currentCoreAccountId) { alert('Account not loaded.'); return; } // Added check
      const newRef = db.ref(`users/${currentCoreAccountId}/vehicles`).push();
      await newRef.set(vehicleData);
      bootstrap.Modal.getInstance(document.getElementById('quickAddVehicleModal')).hide();
      document.getElementById('quickAddVehicleForm').reset();
      alert('Vehicle added successfully!');
      setTimeout(() => document.getElementById('truckNumber').value = number, 500);
    }

    async function saveQuickAddDriver() {
      const name = document.getElementById('q_driverName').value.trim();
      if (!name) { alert('Driver Name is required.'); return; }
      const driverData = {
        driverName: name,
        contactNumber: document.getElementById('q_driverContact').value,
        driverLicense: document.getElementById('q_driverLicense').value,
        createdAt: new Date().toISOString()
      };
      if (!currentCoreAccountId) { alert('Account not loaded.'); return; } // Added check
      const newRef = db.ref(`users/${currentCoreAccountId}/drivers`).push();
      await newRef.set(driverData);
      bootstrap.Modal.getInstance(document.getElementById('quickAddDriverModal')).hide();
      document.getElementById('quickAddDriverForm').reset();
      alert('Driver added successfully!');
      setTimeout(() => document.getElementById('driverSelect').value = name, 500);
    }


    // --- DATATABLE AND INITIALIZATION ---

    // Hook Add tab to auto-generate when user opens the form
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize DataTable
      lrTable = $('#lrTable').DataTable({
        pageLength: 10,
        order: [[1, 'desc']] // Sort by date descending
      });
      // **NEW**: Initialize Market LR DataTable
      marketLrTable = $('#marketLrTable').DataTable({
        pageLength: 10,
        order: [[1, 'desc']]
      });

      const addTab = document.querySelector('a[data-bs-toggle="tab"][href="#add"]');
      if (addTab) {
        addTab.addEventListener('shown.bs.tab', () => {
          // Generate values and placeholders when Add tab is shown
          applyAutoGenerationSettings();
          const d = document.getElementById('lrDate');
          if (d && !d.value) d.value = new Date().toISOString().split('T')[0];
        });
      }
      // Regenerate numbers when date changes (optional)
      const addDate = document.getElementById('lrDate');
      if (addDate) {
        addDate.addEventListener('change', () => {
          if (autoSettings.lrNo) generateLRNumber(document.getElementById('lrNumber'));
          if (autoSettings.invoiceNo) generateRandomNumber(document.getElementById('invoiceNumberInput'), 'INV');
          if (autoSettings.shipmentNo) generateRandomNumber(document.getElementById('shipmentNo'), 'SHP');
          if (autoSettings.orderNo) generateRandomNumber(document.getElementById('orderNo'), 'ORD');
          if (autoSettings.deliveryNo) generateRandomNumber(document.getElementById('deliveryNo'), 'DLV');
        });
      }
    });

    // Load LR Data (Updated to include + button)
    function loadLRData() {
      // ... (Filtering logic remains the same) ...
      
      const lrRef = db.ref(`users/${currentCoreAccountId}/lrReports`);
      lrRef.on('value', async (snapshot) => {
        // **FIX**: Check if DataTables are initialized. If not, do nothing.
        // This prevents errors on initial page load before tables are ready.
        if (!lrTable || !marketLrTable) {
          return;
        }

        if (lrTable) lrTable.clear();
        if (marketLrTable) marketLrTable.clear(); // **NEW**
        // **FIX**: Fetch clients from the core account ID to ensure consignor/consignee names are found.
        const clientsSnap = await db.ref(`users/${currentCoreAccountId}/clients`).once('value');
        const clients = clientsSnap.val() || {};
        const getClientName = (id) => clients[id]?.clientName || 'N/A';

        snapshot.forEach((childSnapshot) => {
          const lr = childSnapshot.val();
          const lrId = childSnapshot.key;
          
          // Skip invoiced LRs so they move off the LR page once invoiced
          if (lr.status === 'invoiced') return;

          const details = lr.tripDetails || {};
          const emptyDetails = lr.emptyTripData || {};
          const totalExpenses = (details.tyreExpenses || 0) + (details.tollExpenses || 0) + (details.foodExpenses || 0) + (details.loadingUnloadingExpenses || 0) + (details.policeChallanExpenses || 0) + (details.tacExpenses || 0) + (details.permitExpenses || 0) + (details.brokerageExpenses || 0) + (details.vehicleWorkAmount || 0) + (details.commissionExpenses || 0) + (details.tirpalRopeExpenses || 0) + (details.otherExpenses || 0) + (details.fuelUsedLiters || 0) + (details.advance || 0) + (details.billingAmount || 0) +
                                (emptyDetails.tyreExpenses || 0) + (emptyDetails.tollExpenses || 0) + (emptyDetails.foodExpenses || 0) + (emptyDetails.loadingUnloadingExpenses || 0) + (emptyDetails.policeChallanExpenses || 0) + (emptyDetails.tacExpenses || 0) + (emptyDetails.permitExpenses || 0) + (emptyDetails.brokerageExpenses || 0) + (emptyDetails.vehicleWorkAmount || 0) + (emptyDetails.commissionExpenses || 0) + (emptyDetails.tirpalRopeExpenses || 0) + (emptyDetails.otherExpenses || 0);

          const detailsExist = totalExpenses > 0 || (details.genericExpenses && details.genericExpenses.length > 0) || (emptyDetails.genericExpenses && emptyDetails.genericExpenses.length > 0);
          const detailButtonClass = detailsExist ? 'btn-success' : 'btn-warning';
          const detailButtonIcon = detailsExist ? 'fas fa-check' : 'fas fa-plus';
          const detailButtonTitle = detailsExist ? 'View/Edit Trip Details' : 'Add Trip Details';
          const isInvoiced = lr.status === 'invoiced';
          const displayStatus = isInvoiced ? 'Invoiced' : (detailsExist ? 'Completed' : 'Active');
          const displayStatusClass = isInvoiced ? 'bg-secondary' : (detailsExist ? 'bg-success' : 'bg-info');

          const invoiceButton = isInvoiced
            ? `<button class="btn btn-sm btn-outline-success" onclick="viewInvoice('${lr.invoiceId}')" title="View Invoice ${lr.invoiceNumber || ''}"><i class="fas fa-eye me-1"></i>View</button>`
            : `<button class="btn btn-sm btn-primary" onclick="createAndSaveInvoice(false, '${lrId}')" title="Generate Invoice"><i class="fas fa-file-invoice me-1"></i>Generate</button>`;
          
          // **NEW**: Logic to separate LRs into two tables
          if (lr.lrType === 'market_company') {
            marketLrTable.row.add([
              `<div class=\"form-check\">\n                 <input class=\"form-check-input market-lr-checkbox\" type=\"checkbox\" value=\"${lrId}\" onchange=\"toggleLRSelection('${lrId}', this.checked, true)\">\n               </div>`,
              lr.date,
              lr.lrNumber,
              lr.truckNumber,
              lr.transporterCompany || 'N/A', // **NEW**: Display transporter company name
              lr.item || 'N/A',
              lr.fromLocation,
              lr.toLocation,
              lr.weight,
              `<button class="btn btn-sm ${detailButtonClass}" onclick="showTripDetailsModal('${lrId}', '${lr.lrNumber}', ${lr.weight}, '${lr.truckNumber}', '${lr.driverName || 'N/A'}')" title="${detailButtonTitle}">
                 <i class="${detailButtonIcon}"></i>
               </button>`,
              `<span class="badge ${displayStatusClass}">${displayStatus}</span>`,
              `<button class="btn btn-sm btn-outline-info" onclick="showLRCopy('${lrId}')" title="View LR Copy">
                 <i class="fas fa-print"></i>
               </button>`,
              `<button class="btn btn-sm btn-outline-primary" onclick="editLR('${lrId}')">
                 <i class="fas fa-edit"></i>
               </button>
               <button class="btn btn-sm btn-outline-danger" onclick="deleteLR('${lrId}')">
                 <i class="fas fa-trash"></i>
               </button>`
            ]);
          } else { // Own vehicle LRs
            const consignorName = getClientName(lr.clientId);
            const consigneeName = getClientName(lr.consigneeId) || consignorName;

            lrTable.row.add([
              `<div class=\"form-check\">\n                 <input class=\"form-check-input lr-checkbox\" type=\"checkbox\" value=\"${lrId}\" onchange=\"toggleLRSelection('${lrId}', this.checked, false)\">\n               </div>`,
              lr.date,
              lr.lrNumber,
              lr.truckNumber,
              consignorName,
              consigneeName,
              lr.item || 'N/A',
              lr.fromLocation,
              lr.toLocation,
              lr.weight,
              `<button class="btn btn-sm ${detailButtonClass}" onclick="showTripDetailsModal('${lrId}', '${lr.lrNumber}', ${lr.weight}, '${lr.truckNumber}', '${lr.driverName || 'N/A'}')" title="${detailButtonTitle}">
                 <i class="${detailButtonIcon}"></i>
               </button>`,
              `<span class="badge ${displayStatusClass}">${displayStatus}</span>`,
              `<button class="btn btn-sm btn-outline-info" onclick="showLRCopy('${lrId}')" title="View LR Copy">
                 <i class="fas fa-print"></i>
               </button>`,
              `<button class="btn btn-sm btn-outline-primary" onclick="editLR('${lrId}')">
                 <i class="fas fa-edit"></i>
               </button>
               <button class="btn btn-sm btn-outline-danger" onclick="deleteLR('${lrId}')">
                 <i class="fas fa-trash"></i>
               </button>`
            ]);
          }
        });
        
        if (lrTable) lrTable.draw();
        if (marketLrTable) marketLrTable.draw(); // **NEW**
        updateInvoiceButtonStates();
      });
    }

    // Selection logic copied from lr-report1.html
    let selectedLRs = [];
    let selectedMarketLRs = [];

    function toggleLRSelection(lrId, isChecked, isMarket) {
      if (isChecked) {
        if (isMarket) {
          if (!selectedMarketLRs.includes(lrId)) selectedMarketLRs.push(lrId);
        } else {
          if (!selectedLRs.includes(lrId)) selectedLRs.push(lrId);
        }
      } else {
        if (isMarket) {
          selectedMarketLRs = selectedMarketLRs.filter(id => id !== lrId);
        } else {
          selectedLRs = selectedLRs.filter(id => id !== lrId);
        }
      }
      updateInvoiceButtonStates();
      updateSelectAllCheckboxes();
    }

    function updateInvoiceButtonStates() {
      const ownBtn = document.getElementById('generateInvoiceBtn');
      const mkBtn = document.getElementById('generateMarketInvoiceBtn');
      if (ownBtn) ownBtn.disabled = selectedLRs.length === 0;
      if (mkBtn) mkBtn.disabled = selectedMarketLRs.length === 0;
    }

    function updateSelectAllCheckboxes() {
      const allOwnCheckboxes = document.querySelectorAll('.lr-checkbox');
      const allMarketCheckboxes = document.querySelectorAll('.market-lr-checkbox');
      const selectAllOwn = document.getElementById('selectAllCheckbox');
      const selectAllMarket = document.getElementById('selectAllMarketCheckbox');

      if (selectAllOwn) {
        const allOwnChecked = allOwnCheckboxes.length > 0 && selectedLRs.length === allOwnCheckboxes.length;
        selectAllOwn.checked = allOwnChecked;
        selectAllOwn.indeterminate = selectedLRs.length > 0 && !allOwnChecked;
      }
      if (selectAllMarket) {
        const allMarketChecked = allMarketCheckboxes.length > 0 && selectedMarketLRs.length === allMarketCheckboxes.length;
        selectAllMarket.checked = allMarketChecked;
        selectAllMarket.indeterminate = selectedMarketLRs.length > 0 && !allMarketChecked;
      }
    }

    function toggleSelectAll(isMarket = false) {
      if (isMarket) {
        const selectAllMarketCheckbox = document.getElementById('selectAllMarketCheckbox');
        const allMarketCheckboxes = document.querySelectorAll('.market-lr-checkbox');
        const isChecked = selectAllMarketCheckbox && selectAllMarketCheckbox.checked;
        allMarketCheckboxes.forEach(checkbox => {
          checkbox.checked = !!isChecked;
          toggleLRSelection(checkbox.value, !!isChecked, true);
        });
      } else {
        const selectAllOwnCheckbox = document.getElementById('selectAllCheckbox');
        const allOwnCheckboxes = document.querySelectorAll('.lr-checkbox');
        const isChecked = selectAllOwnCheckbox && selectAllOwnCheckbox.checked;
        allOwnCheckboxes.forEach(checkbox => {
          checkbox.checked = !!isChecked;
          toggleLRSelection(checkbox.value, !!isChecked, false);
        });
      }
    }

    // Bridge function to trigger invoice generation for selected LRs
    window.showBankDetailsModal = function(isMarket = false) {
      const lrsToInvoice = isMarket ? selectedMarketLRs : selectedLRs;
      if (!lrsToInvoice || lrsToInvoice.length === 0) {
        alert('Please select at least one LR to generate an invoice.');
        return;
      }
      // Reuse existing creator; it will read selected arrays when single id is not provided
      createAndSaveInvoice(isMarket, null);
    }

    // Edit LR (Streamlined)
    function editLR(lrId) {
      currentEditingLRId = lrId;
      if (!currentCoreAccountId) { alert("Error: Cannot determine the account to fetch data from. Please reload."); return; }
      const lrRef = db.ref(`users/${currentCoreAccountId}/lrReports/${lrId}`);
      
      lrRef.once('value').then((snapshot) => {
        const lr = snapshot.val();
        
        // **NEW**: Handle market vehicle toggle in edit modal
        const isMarketVehicle = lr.lrType === 'market';
        document.getElementById('editVehicleTypeToggle').checked = isMarketVehicle;
        toggleEditVehicleInput(isMarketVehicle); // Show/hide correct fields

        // Populate edit form
        document.getElementById('editLrDate').value = lr.date;
        document.getElementById('editLrNumber').value = lr.lrNumber || '';
        document.getElementById('editInvoiceNumberInput').value = lr.invoiceNumber || '';
        document.getElementById('editDeliveryNo').value = lr.deliveryNo || '';
        document.getElementById('editOrderNo').value = lr.orderNo || '';
        document.getElementById('editClientId').value = lr.clientId; // Use clientId

        // **NEW**: Populate correct vehicle and driver fields based on type
        if (isMarketVehicle) {
          document.getElementById('editMarketTruckNumber').value = lr.truckNumber;
          document.getElementById('editMarketDriverName').value = lr.driverName || '';
        } else {
          // Clear market fields if it's an own vehicle
          document.getElementById('editMarketTruckNumber').value = '';
          document.getElementById('editMarketDriverName').value = '';
          document.getElementById('editTruckNumber').value = lr.truckNumber;
          // Set timeout to ensure driver dropdown is populated before setting value
          setTimeout(() => { document.getElementById('editDriverSelect').value = lr.driverName || ''; }, 100);
        }

        // Note: The edit modal doesn't have a separate consignee dropdown, it uses a text field.
        // **NEW**: Set transporter on edit
        document.getElementById('editTransporterSelect').value = lr.transporterId || '';
        document.getElementById('editConsigneeId').value = lr.consigneeId || '';
        document.getElementById('editRouteSelect').value = lr.routeId || '';
        // Set employee on edit
        const editEmployeeSelect = document.getElementById('editEmployeeSelect');
        if (editEmployeeSelect && lr.employeeId) {
          setTimeout(() => { editEmployeeSelect.value = lr.employeeId || ''; }, 100);
        }

        document.getElementById('editNumPackages').value = lr.numPackages || '';
        document.getElementById('editWeightPerPackage').value = lr.weightPerPackage || '';
        document.getElementById('editWeight').value = lr.weight;
        document.getElementById('editShipmentNo').value = lr.shipmentNo || ''; // Corrected
        document.getElementById('editItem').value = lr.item || '';
        // Note: ShipmentNo logic in the simplified form will use editShipmentNo if a field is added.
        
        // Apply auto-generation placeholders/values for empty edit fields
        applyEditAutoGenerationSettings();
        // Show modal
        const editModal = new bootstrap.Modal(document.getElementById('editLRModal'));
        editModal.show();
      });
    }

    // Update LR (Streamlined)
    document.getElementById('updateLRBtn').addEventListener('click', async () => {
      const form = document.getElementById('editLrForm'); // Corrected from editLrForm
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const editRouteSelect = document.getElementById('editRouteSelect');
      const selectedEditRoute = editRouteSelect ? editRouteSelect.options[editRouteSelect.selectedIndex] : null;
      const editFromLoc = selectedEditRoute ? (selectedEditRoute.dataset.from || '') : '';
      const editToLoc = selectedEditRoute ? (selectedEditRoute.dataset.to || '') : '';
      const routeDistance = selectedEditRoute && selectedEditRoute.dataset && selectedEditRoute.dataset.distance ? parseFloat(selectedEditRoute.dataset.distance) || 0 : 0;
      
      // **NEW**: Get data based on vehicle type toggle
      const isMarketVehicle = document.getElementById('editVehicleTypeToggle').checked;
      const truckNumber = isMarketVehicle ? document.getElementById('editMarketTruckNumber').value : document.getElementById('editTruckNumber').value;
      const driverName = isMarketVehicle ? document.getElementById('editMarketDriverName').value : document.getElementById('editDriverSelect').value;
      const editEmployeeSelect = document.getElementById('editEmployeeSelect');
      const employeeId = editEmployeeSelect ? editEmployeeSelect.value : null;
      const transporterSelect = document.getElementById('editTransporterSelect'); // Get the select element
      const transporterId = transporterSelect.value;
      const transporterName = transporterSelect.value ? transporterSelect.options[transporterSelect.selectedIndex].dataset.name : null;

      const vehicle = allVehicles.find(v => (v.vehicleNo || '').toUpperCase() === truckNumber.toUpperCase() && v.driverName === driverName);
      
      const lrUpdateData = {
        date: document.getElementById('editLrDate').value,
        lrNumber: document.getElementById('editLrNumber').value,
        // **FIX**: Correctly determine lrType on update.
        lrType: transporterId 
          ? 'market_company' 
          : (isMarketVehicle ? 'market' : 'own'),
        transporterId: transporterId,
        transporterCompany: transporterName,
        routeId: document.getElementById('editRouteSelect').value, // **FIX**: Save routeId on update
        invoiceNumber: document.getElementById('editInvoiceNumberInput').value,
        deliveryNo: document.getElementById('editDeliveryNo').value,
        orderNo: document.getElementById('editOrderNo').value,
        truckNumber: truckNumber,
        driverName: driverName,
        truckId: vehicle ? vehicle.id : null,
        clientId: document.getElementById('editClientId').value, // Use clientId
        fromLocation: editFromLoc,
        toLocation: editToLoc,
        routeDistanceKm: routeDistance,
        numPackages: parseFloat(document.getElementById('editNumPackages').value) || 0,
        weightPerPackage: parseFloat(document.getElementById('editWeightPerPackage').value) || 0,
        weight: parseFloat(document.getElementById('editWeight').value) || 0,
        consigneeId: document.getElementById('editConsigneeId').value,
        shipmentNo: document.getElementById('editShipmentNo').value,
        item: document.getElementById('editItem').value,
        employeeId: employeeId || null, // Store registered employee ID
        updatedAt: new Date().toISOString()
      };

      if (!currentCoreAccountId) { alert('Error: Core account ID not found. Cannot update LR.'); return; }
      
      const lrRef = db.ref(`users/${currentCoreAccountId}/lrReports/${currentEditingLRId}`);

      try {
        const snapshot = await lrRef.once('value');
        const existingLR = snapshot.val();
        const existingTripDetails = existingLR.tripDetails || {};
        const newWeight = lrUpdateData.weight;

        // Check if weight has changed and if rates exist to perform recalculation
        if (existingLR.weight !== newWeight && existingTripDetails.billingRate > 0) {
          console.log("Weight changed. Recalculating trip financials...");

          const newBillingAmount = newWeight * (existingTripDetails.billingRate || 0);
          const newFreightAmount = newWeight * (existingTripDetails.freightRate || 0);
          
          const cgstPercentage = existingTripDetails.cgstPercentage || 9;
          const sgstPercentage = existingTripDetails.sgstPercentage || 9;

          const newCgstAmount = (newBillingAmount * cgstPercentage) / 100;
          const newSgstAmount = (newBillingAmount * sgstPercentage) / 100;
          const newTotalBillingAmount = newBillingAmount + newCgstAmount + newSgstAmount;

          // Update the tripDetails object
          lrUpdateData.tripDetails = {
            ...existingTripDetails, // Preserve other details
            billingAmount: newBillingAmount,
            freightAmount: newFreightAmount,
            cgstAmount: newCgstAmount,
            sgstAmount: newSgstAmount,
            totalBillingAmount: newTotalBillingAmount,
            updatedAt: new Date().toISOString()
          };
        }

        // Perform the update
        await lrRef.update(lrUpdateData);

        // If LR is linked to an invoice, update that invoice to reflect current LR types and bill-to
        if (existingLR && existingLR.invoiceId) {
          try {
            await syncInvoiceWithCurrentLR(existingLR.invoiceId);
          } catch (e) {
            console.warn('Invoice sync warning:', e);
          }
        }

        alert('LR updated successfully!');
        const editModal = bootstrap.Modal.getInstance(document.getElementById('editLRModal'));
        editModal.hide();
        loadLRData();

      } catch (error) {
        console.error('Error updating LR:', error);
        alert('Error updating LR. Please try again.');
      }
    });

    // --- UTILITIES (Routinely used functions from original file) ---

    function updateTruckFilterDropdown() {
      const truckFilter = document.getElementById('truckFilter');
      if (!truckFilter) return;
      
      const currentValue = truckFilter.value;
      truckFilter.innerHTML = '<option value="">All Trucks</option>';
      const uniqueVehicles = [...new Set(allVehicles.map(v => v.vehicleNumber))].filter(Boolean);
      
      uniqueVehicles.sort().forEach(vehicleNo => {
        const option = document.createElement('option');
        option.value = vehicleNo;
        option.textContent = vehicleNo;
        truckFilter.appendChild(option);
      });
      if (currentValue && uniqueVehicles.includes(currentValue)) truckFilter.value = currentValue;
    }
    function searchVehicles(query) { /* ... (same as original) ... */ }
    function searchEditVehicles(query) { /* ... (same as original) ... */ }
    
    async function showLRCopy(lrId) {
      const user = auth.currentUser;
      if (!user) return;

      const lrRef = db.ref(`users/${currentCoreAccountId}/lrReports/${lrId}`);
      const profileRef = db.ref(`users/${user.uid}/profile`);

      try {
        const [lrSnapshot, profileSnapshot] = await Promise.all([
          lrRef.once('value'),
          profileRef.once('value')
        ]);

        if (!lrSnapshot.exists()) { alert('LR data not found.'); return; }
        
        const lr = lrSnapshot.val();
        const profile = profileSnapshot.exists() ? profileSnapshot.val() : {};
        const ownerName = profile.ownerName || 'N/A';
        const companyLogoUrl = profile.companyLogoUrl || '';
        
        // **FIX**: Get freight details from the tripDetails object
        const tripDetails = lr.tripDetails || {};

        const companyName = profile.transportName || 'Transvortex Logistics';
        const companyAddress = `${profile.address || ''}, ${profile.city || ''} - ${profile.pincode || ''}`;
        const companyPhone = profile.phoneNumber || 'N/A';
        const companyGstin = profile.gstin || 'N/A';

        const vehicle = allVehicles.find(v => (v.vehicleNo || v.vehicleNumber) === lr.truckNumber);
        // Removed driverName and driverContact as requested by user.

        const client = allClients.find(c => c.id === lr.clientId) || {};

        const lrCopyContent = `
          <div class="lr-copy-container printable-area" id="lr-pdf-content">
            <!-- MODIFIED: Wrapped header in a container for better alignment -->
            <div class="lr-header lr-header-content">
              ${companyLogoUrl ? `<img src="${companyLogoUrl}" alt="Logo" class="logo-on-print" style="max-height: 60px; max-width: 150px;">` : ''}
              <div style="text-align: center;">
                <h4>${companyName}</h4>
                <p>Authorized transport contractor of ${client.clientName || client.name || 'To be billed'}</p>
                <p>Address: ${profile.address || 'N/A'}, City: ${profile.city || 'N/A'}, Pincode: ${profile.pincode || 'N/A'}</p>
                <p>GSTIN: ${companyGstin} | Phone: ${companyPhone}</p>
              </div>
              <div style="width: 150px;"></div> <!-- Spacer to balance the flex layout -->
            </div>
            
            <div class="lr-info">
              <div class="lr-info-left">
                <div class="lr-row">From: <strong>${lr.fromLocation || 'N/A'}</strong></div>
                <div class="lr-row">Consignor: <strong>${client.clientName || client.name || 'To be billed'}</strong></div>
                <div class="lr-row">Consignee: <strong>${(allClients.find(c => c.id === lr.consigneeId) || {}).clientName || (allClients.find(c => c.id === lr.consigneeId) || {}).name || client.clientName || client.name || 'N/A'}</strong></div>
                <div class="lr-row">GSTIN: <strong>${client.gstin || 'N/A'}</strong></div>
                <div class="lr-row">Order No: <strong>${lr.orderNo || 'N/A'}</strong></div>
                <div class="lr-row">Delivery No: <strong>${lr.deliveryNo || 'N/A'}</strong></div>
              </div>
              <div class="lr-info-right">
                <div class="lr-row">LR No: <strong>${lr.lrNumber || 'N/A'}</strong></div>
                <div class="lr-row">Date: <strong>${lr.date || 'N/A'}</strong></div>
                <div class="lr-row">Vehicle No: <strong>${lr.truckNumber || 'N/A'}</strong></div>
                <div class="lr-row">Truck Type: <strong>${vehicle ? vehicle.vehicleType || 'N/A' : 'N/A'}</strong></div>
                <div class="lr-row">Party Name: <strong>${client.clientName || client.name || 'To be billed'}</strong></div>
                <div class="lr-row">Invoice No: <strong>${lr.invoiceNumber || lr.invoiceNumberInput || lr.invoiceNo || 'N/A'}</strong></div>
                <div class="lr-row">Shipment No: <strong>${lr.shipmentNo || 'N/A'}</strong></div>
              </div>
            </div>
            
            <table class="lr-table">
              <thead>
                <tr>
                  <th>${(lr.numPackages && lr.numPackages > 0) ? 'No of Bags' : 'Type'}</th>
                  <th>Goods Description</th>
                  <th>Weight in MT</th>
                  <th>Rate</th>
                  <th>Freight</th>
                  <th>Value of Goods Rs.</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>${(lr.numPackages && lr.numPackages > 0) ? lr.numPackages : 'Loose'}</td>
                  <td>${lr.item || 'N/A'}</td>
                  <td>${lr.weight || 'N/A'}</td>
                  <td>${(tripDetails.freightRate && parseFloat(tripDetails.freightRate) > 0) ? `₹${parseFloat(tripDetails.freightRate).toFixed(2)}` : 'To be billed'}</td>
                  <td>${(tripDetails.freightAmount && tripDetails.freightAmount > 0) ? `₹${(parseFloat(tripDetails.freightAmount)).toFixed(2)}` : 'To be billed'}</td>
                  <td>₹${(lr.goodsValue || 0).toFixed(2)}</td>
                </tr>
              </tbody>
            </table>
            
            <div class="lr-row">Remarks: <strong>GIT TO BE PAID BY CONSIGNOR / GOODS TRANSPORTED BY ${client.clientName || client.name || 'N/A'}.</strong></div>
            
            <div class="lr-row">Truck Owner: <strong>${ownerName || 'N/A'}</strong></div>
            <div class="lr-row">Truck Type: <strong>${vehicle ? (vehicle.vehicleType || 'N/A') : 'N/A'}</strong></div>
            
            <div class="safety-section">
              <h5>Safety PPE(Personal Protective Equipment) Details</h5>
              <div class="lr-row">Helmet No: <strong>N/A</strong> | Jacket No: <strong>N/A</strong> | Shoes: No: <strong>N/A</strong> | Vehicle Approved By Logistic: <strong>No</strong></div>
            </div>
            
            <div class="receipt-section">
              <h5>Receipt of Goods</h5>
              <div class="lr-row">Order No: <strong>${lr.orderNo || 'N/A'}</strong> | Delivery No: <strong>${lr.deliveryNo || 'N/A'}</strong> | Shipment No: <strong>${lr.shipmentNo || 'N/A'}</strong> | Invoice No: <strong>${lr.invoiceNumber || lr.invoiceNumberInput || lr.invoiceNo || 'N/A'}</strong></div>
              <div class="lr-row">Truck No: <strong>${lr.truckNumber || 'N/A'}</strong> | LR No: <strong>${lr.lrNumber || 'N/A'}</strong></div>
              <div class="lr-row">Truck received at site at time: <strong>__________</strong> | Date and time of receipt: <strong>__________</strong></div>
              <div class="lr-row">Number of bags received: <strong>__________</strong> | Number of bags received short: <strong>__________</strong></div>
              <div class="lr-row">Condition of cement received: <strong>__________</strong> | Quantity of cement found wet or in book and at: <strong>__________</strong></div>
              <div class="lr-row">of damaged bag for which recovery to be made from transporter: <strong>__________</strong></div>
            </div>
            
            <div class="lr-footer">
              <div class="signature-box">
                <div class="signature-line">Signature and seal of Consignor</div>
              </div>
              <div class="signature-box">
                <div class="stamp-on-print" style="width: 150px; height: 150px; margin: 0 auto;">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200">
                    <defs>
                      <path id="topTextPath" fill="none" d="M 30,100 a 70,70 0 1,1 140,0" />
                      <path id="bottomTextPath" fill="none" d="M 30,100 a 70,70 0 1,0 140,0" />
                    </defs>
                    <g fill="#003366" stroke="#003366">
                      <circle cx="100" cy="100" r="95" stroke-width="3" fill="none"/>
                      <circle cx="100" cy="100" r="88" stroke-width="1.5" fill="none"/>
                      <text font-family="'Arial Black', 'Impact', sans-serif" font-size="15" letter-spacing="1.5">
                    
                        <textPath xlink:href="#topTextPath" startOffset="50%" text-anchor="middle">${companyName.toUpperCase()}</textPath>
                      </text>
                      <text font-family="'Arial Black', 'Impact', sans-serif" font-size="12" letter-spacing="1">
                        <textPath xlink:href="#bottomTextPath" startOffset="50%" text-anchor="middle">LOGISTICS & TRANSPORT SERVICE</textPath>
                      </text>
                      <g transform="translate(65, 75) scale(0.4)">
<path d="M15,1H4A2,2,0,0,0,2,3V16H1V18H3A3,3,0,0,0,6,21H8A3,3,0,0,0,11,18H21A3,3,0,0,0,24,15V11.5A4.5,4.5,0,0,0,19.5,7H15V1M6,19a1,1,0,1,1,1-1A1,1,0,0,1,6,19M8,19a1,1,0,1,1,1-1A1,1,0,0,1,8,19M19.5,9A2.5,2.5,0,0,1,22,11.5V15H15V9h4.5Z" fill="#003366" stroke="none"/>
                      </g>
                      <text x="100" y="125" font-family="'Arial', sans-serif" font-size="14" font-weight="bold" text-anchor="middle" letter-spacing="1">OFFICIAL SEAL</text>
                      <text x="100" y="145" font-family="'Arial', sans-serif" font-size="9" font-weight="normal" text-anchor="middle">GSTIN: ${companyGstin}</text>
                    </g>
                  </svg>
                </div>
              </div>
            </div>
          </div>
        `;

        document.getElementById('lrCopyContent').innerHTML = lrCopyContent;
        document.getElementById('lrCopyModalLabel').textContent = `${companyName} - Lorry Receipt`;
        const lrCopyModal = new bootstrap.Modal(document.getElementById('lrCopyModal'));
        lrCopyModal.show();
// **NEW**: Add event listeners for print settings toggles
        document.getElementById('printLogoToggle').onchange = function() {
          document.querySelectorAll('.logo-on-print').forEach(el => el.classList.toggle('hidden-print', !this.checked));
        };
        document.getElementById('printStampToggle').onchange = function() {
          document.querySelectorAll('.stamp-on-print').forEach(el => el.classList.toggle('hidden-print', !this.checked));
        };


      } catch (error) {
        console.error('Error generating LR copy:', error);
        alert('Error loading LR details. Please try again.');
      }
    }

    async function downloadLRCopyPDF() {
      const { jsPDF } = window.jspdf;
      const content = document.getElementById('lr-pdf-content');
      if (!content) {
        alert('Could not find LR content to download.');
        return;
      }

      // --- FIX FOR MOBILE PDF GENERATION ---
      // Temporarily set a fixed width to ensure the layout is not cramped on mobile
      const originalWidth = content.style.width;
      const originalMaxWidth = content.style.maxWidth;
      content.style.width = '800px';
      content.style.maxWidth = '800px';
      // --- END FIX ---

      try {
        const canvas = await html2canvas(content, {
          scale: 2,
          useCORS: true
        });
        
        // --- FIX FOR MOBILE PDF GENERATION ---
        // Restore original styles after canvas is created
        content.style.width = originalWidth;
        content.style.maxWidth = originalMaxWidth;
        // --- END FIX ---

        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4'
        });

        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const imgProps = pdf.getImageProperties(imgData);
        const imgWidth = pdfWidth - 20;
        const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

        pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
        
        const lrNumberElement = content.querySelector('.lr-info-right .lr-row:nth-child(1) strong');
        const lrNumber = lrNumberElement ? lrNumberElement.textContent.trim() : 'LR_Copy';

        // **MODIFIED**: Add watermark based on the toggle setting
        const showWatermark = document.getElementById('printWatermarkToggle').checked;
        if (showWatermark) {
          const user = auth.currentUser;
          if (user) {
            const profileSnap = await db.ref(`users/${user.uid}/profile`).once('value');
            const profile = profileSnap.exists() ? profileSnap.val() : {};
            const watermarkText = profile.transportName || 'TransVortex';

            // Set watermark properties
            pdf.setFontSize(50);
            pdf.setTextColor(150, 150, 150); // Light grey color
            pdf.setFont('helvetica', 'bold');
            pdf.saveGraphicsState(); // Save current state
            pdf.setGState(new pdf.GState({opacity: 0.2})); // Set transparency

            // Rotate and place the watermark in the center
            const centerX = pdf.internal.pageSize.getWidth() / 2;
            const centerY = pdf.internal.pageSize.getHeight() / 2;
            pdf.text(watermarkText, centerX, centerY, { align: 'center', angle: -45 });

            pdf.restoreGraphicsState(); // Restore original state
          }
        }

        pdf.save(`${lrNumber}.pdf`); // This was already correct

      } catch (error) {
        console.error('Error generating PDF:', error);
        alert('Failed to generate PDF. Please try again.');
      }
    }
    function preselectEditRoute(from, to, attempt = 0) { /* ... (same as original) ... */ }
    function deleteLR(lrId) {
      if (!currentCoreAccountId) {
        alert('Error: Cannot determine account. Please reload.');
        return;
      }
      if (confirm('Are you sure you want to delete this LR record? This action cannot be undone.')) {
        db.ref(`users/${currentCoreAccountId}/lrReports/${lrId}`).remove()
          .then(() => {
            alert('LR deleted successfully!');
            loadLRData(); // Refresh the table
          })
          .catch((error) => {
            console.error('Error deleting LR:', error);
            alert('Error deleting LR. Please try again.');
          });
      }
    }
    
    // MODIFIED: This function now fetches bank details from the user's profile
    window.createAndSaveInvoice = async function(isMarket = false, singleLrId = null) {
      const user = auth.currentUser;
      // If a single LR ID is passed, use it. Otherwise, fall back to selected lists (from lr-report1.html behavior)
      const lrsToProcess = singleLrId ? [singleLrId] : (isMarket ? selectedMarketLRs : selectedLRs);

      if (!user || !currentCoreAccountId) {
        alert('Authentication error. Please log in again.');
        return;
      }

      try {
        // 1. Fetch company profile and bank details from /profile
        const profileRef = db.ref(`users/${user.uid}/profile`);
        const profileSnap = await profileRef.once('value');
        const profile = profileSnap.exists() ? profileSnap.val() : {};
        
        // Extract Company Details
        const companyDetails = {
          name: profile.transportName || 'N/A',
          address: `${profile.address || ''}, ${profile.city || ''} - ${profile.pincode || ''}`,
          gstNumber: profile.gstin || 'N/A',
        };
        
        // Extract Bank Details
        const bankDetails = {
          bankName: profile.bankName || 'N/A',
          accountNumber: profile.accountNumber || 'N/A',
          accountHolder: profile.accountHolder || 'N/A',
          ifscCode: profile.ifscCode || 'N/A',
        };

        // Basic check for mandatory bank details before proceeding
        if (bankDetails.bankName === 'N/A' || bankDetails.accountNumber === 'N/A') {
            alert('Bank details are missing in your profile. Please update your profile before generating an invoice.');
            return;
        }


        // 2. Fetch details for all selected LRs
        let subtotal = 0;
        let firstClientId = null;
        let firstTransporterId = null; 
        let invoiceItems = []; // **FIX**: Changed to let to allow reassignment.
        let marketMode = null; // null until determined; true => market_company, false => client

        const lrPromises = lrsToProcess.map(lrId => db.ref(`users/${currentCoreAccountId}/lrReports/${lrId}`).once('value')); 
        const lrSnapshots = await Promise.all(lrPromises);
        
        // --- STEP 1: Loop through LRs to calculate subtotal and validate entities ---
        for (const snap of lrSnapshots) {
          const lr = snap.val();
          if (!lr) continue;

          if (lr.tripDetails?.billingAmount === undefined || lr.tripDetails?.billingAmount <= 0) {
            alert(`Error: LR ${lr.lrNumber} does not have a valid billing amount. Please add trip details first.`);
            return;
          }

          // Determine invoice mode strictly from the LR's current type
          const isMarketLR = lr.lrType === 'market_company';

          // Establish or validate a consistent mode across all selected LRs
          if (marketMode === null) marketMode = isMarketLR;
          if (marketMode !== isMarketLR) {
            alert('Error: Mixed LR types selected. Please select LRs of the same type.');
            return;
          }

          if (invoiceItems.length === 0) {
            // Initialize once before pushing items
            invoiceItems = [];
          }

          if (marketMode) {
            // For market LRs, the billing entity is always the transporter.
            if (!firstTransporterId) firstTransporterId = lr.transporterId;
            if (lr.transporterId !== firstTransporterId) {
              alert('Error: All selected market LRs must belong to the same transporter/market company.');
              return;
            }
          } else {
            // For own company LRs, the billing entity is the client.
            if (!firstClientId) firstClientId = lr.clientId;
            if (lr.clientId !== firstClientId) {
              alert('Error: All selected LRs must belong to the same client.');
              return;
            }
          }

          const billingAmount = lr.tripDetails?.billingAmount || 0;
          subtotal += billingAmount;

          const consignor = allClients.find(c => c.id === lr.clientId)?.name || 'N/A';
          const consignee = allClients.find(c => c.id === lr.consigneeId)?.name || consignor;

          invoiceItems.push({
            lrId: snap.key,
            date: lr.date,
            lrNumber: lr.lrNumber,
            truckNumber: lr.truckNumber,
            consignor: consignor,
            consignee: consignee,
            from: lr.fromLocation,
            to: lr.toLocation,
            weight: lr.weight,
            amount: billingAmount,
            marketCompanyName: lr.transporterCompany || ''
          });
        }

        // --- STEP 2: Calculate final totals for the new invoice ---
        const cgstPercentage = 9;
        const sgstPercentage = 9;
        const cgstAmount = (subtotal * cgstPercentage) / 100;
        const sgstAmount = (subtotal * sgstPercentage) / 100;
        let grandTotal = subtotal + cgstAmount + sgstAmount;

        // --- STEP 3: Fetch the CURRENT outstanding balance for the relevant entity ---
        let entityOutstanding = 0;
        if (marketMode && firstTransporterId) {
            const transporterSnap = await db.ref(`users/${currentCoreAccountId}/transporters/${firstTransporterId}`).once('value');
            if (transporterSnap.exists()) entityOutstanding = transporterSnap.val().outstanding || 0;
        } else if (!marketMode && firstClientId) {
            const clientSnap = await db.ref(`users/${currentCoreAccountId}/clients/${firstClientId}`).once('value');
            if (clientSnap.exists()) entityOutstanding = clientSnap.val().outstanding || 0;
        }

        // --- STEP 4: Apply existing credit (if any) to the new invoice ---
        let paidAmount = 0;
        let paymentStatus = 'pending';
        if (entityOutstanding < 0) { // A negative balance means they have a credit.
            const creditToApply = Math.min(Math.abs(entityOutstanding), grandTotal);
            paidAmount = creditToApply;
            if (paidAmount >= grandTotal - 0.01) {
                paymentStatus = 'paid';
                paidAmount = grandTotal; // Cap the paid amount at the grand total
            }
            else if (paidAmount > 0) paymentStatus = 'partial';
        }

        // --- STEP 5: Create the final invoice object ---
        const invoiceNumber = `INV-${Date.now()}`;
        const invoiceData = {
          invoiceNumber: invoiceNumber,
          createdAt: new Date().toISOString(),
          // **FIX**: Correctly assign transporterId for market invoices and clientId for client invoices.
          // Ensure clientId is null for market invoices to prevent incorrect billing lookups. This was the final fix.
          transporterId: marketMode ? firstTransporterId : null,
          clientId: marketMode ? null : firstClientId,
          invoiceType: marketMode ? 'market_company' : 'client',
          companyDetails: companyDetails,
          bankDetails: bankDetails, // Use fetched bank details
          items: invoiceItems,
          lrEntries: lrsToProcess, // Keep the original LR IDs
          subtotal: subtotal,
          cgstAmount: cgstAmount, // This was already correct
          sgstAmount: sgstAmount,
          grandTotal: grandTotal,
          paymentStatus: paymentStatus,
          paidAmount: paidAmount,
        };

        // 5. Save invoice and update LRs atomically
        const updates = {};
        const newInvoiceKey = db.ref(`users/${currentCoreAccountId}/invoices`).push().key;
        updates[`/users/${currentCoreAccountId}/invoices/${newInvoiceKey}`] = invoiceData;
        lrsToProcess.forEach(lrId => {
          updates[`/users/${currentCoreAccountId}/lrReports/${lrId}/status`] = 'invoiced';
          updates[`/users/${currentCoreAccountId}/lrReports/${lrId}/invoiceId`] = newInvoiceKey;
        });

        // --- STEP 6: Update the outstanding balance for the entity ---
        if (marketMode) {
            const newOutstanding = entityOutstanding + grandTotal;
            updates[`/users/${currentCoreAccountId}/transporters/${firstTransporterId}/outstanding`] = newOutstanding;
        } else {
            const newOutstanding = entityOutstanding + grandTotal;
            updates[`/users/${currentCoreAccountId}/clients/${firstClientId}/outstanding`] = newOutstanding;
        }

        await db.ref().update(updates);

        alert('Invoice generated successfully!');
        // Redirect to the invoice page and open the created invoice
        window.location.href = `invoice.html?view=${newInvoiceKey}`;
      } catch (error) {
        console.error('Error creating invoice:', error);
        alert('Failed to create invoice: ' + error.message);
      }
    }

        // --- INVOICE VIEWING & STYLING FUNCTIONS (Copied from invoice.html) ---

        function loadStyleSettings() {
            const storedStyle = localStorage.getItem('invoiceStyleSettings');
            if (storedStyle) {
                invoiceStyle = JSON.parse(storedStyle);
            }
            const invoiceModal = document.getElementById('invoiceDetailModal');
            if (invoiceModal) {
                invoiceModal.addEventListener('show.bs.modal', setupLivePreviewListeners);
                invoiceModal.addEventListener('hidden.bs.modal', cleanupLivePreviewListeners);
            }
        }

        function setupLivePreviewListeners() {
            const colorInput = document.getElementById('themeColor');
            const accentInput = document.getElementById('accentStyle');
            const fontInput = document.getElementById('fontStyle');
            colorInput.value = invoiceStyle.themeColor;
            accentInput.value = invoiceStyle.accentStyle;
            fontInput.value = invoiceStyle.fontStyle;
            document.getElementById('templatePreset').value = 'custom';
            if (currentInvoiceData) {
                 applyLiveStyles();
            }
            colorInput.addEventListener('input', applyLiveStyles);
            accentInput.addEventListener('change', applyLiveStyles);
            fontInput.addEventListener('change', applyLiveStyles);
        }

        function cleanupLivePreviewListeners() {
            const colorInput = document.getElementById('themeColor');
            const accentInput = document.getElementById('accentStyle');
            const fontInput = document.getElementById('fontStyle');
            if (colorInput) colorInput.removeEventListener('input', applyLiveStyles);
            if (accentInput) accentInput.removeEventListener('change', applyLiveStyles);
            if (fontInput) fontInput.removeEventListener('change', applyLiveStyles);
        }

        window.applyTemplate = function(templateName) {
            if (templateName === 'custom') return;
            const template = styleTemplates[templateName] || styleTemplates.default;
            document.getElementById('themeColor').value = template.themeColor;
            document.getElementById('accentStyle').value = template.accentStyle;
            document.getElementById('fontStyle').value = template.fontStyle;
            applyLiveStyles();
            document.getElementById('templatePreset').value = templateName;
        }

        function applyLiveStyles() {
            if (!currentInvoiceData) return;
            const themeColor = document.getElementById('themeColor').value;
            const accentStyle = document.getElementById('accentStyle').value;
            const fontStyle = document.getElementById('fontStyle').value;
            const previewElement = document.getElementById('printableInvoiceDetail');
            if (!previewElement) return;
            previewElement.style.fontFamily = fontStyle;
            document.querySelectorAll('#printableInvoiceDetail .invoice-theme-color').forEach(el => {
                el.style.color = themeColor;
            });
            const table = previewElement.querySelector('.table');
            if (table) {
                const thead = table.querySelector('thead');
                const tfoot = table.querySelector('tfoot');
                const tbodyRows = table.querySelectorAll('tbody tr');
                const tfootTotalRow = tfoot ? tfoot.querySelector('tr:last-child') : null;
                if (thead) { thead.style.backgroundColor = ''; thead.style.color = ''; }
                if (tfootTotalRow) { tfootTotalRow.style.backgroundColor = ''; tfootTotalRow.style.color = ''; }
                tbodyRows.forEach(row => row.classList.remove('table-zebra-stripe'));
                if (accentStyle === 'header' && thead) {
                    thead.style.backgroundColor = themeColor;
                    thead.style.color = 'white';
                } else if (accentStyle === 'footer' && tfootTotalRow) {
                    tfootTotalRow.style.backgroundColor = themeColor;
                    tfootTotalRow.style.color = 'white';
                } else if (accentStyle === 'zebra') {
                    tbodyRows.forEach((row, index) => {
                        if (index % 2 !== 0) row.classList.add('table-zebra-stripe');
                    });
                }
            }
        }

        window.viewInvoice = async function(invoiceId) {
          const modalBody = document.getElementById('printableInvoiceDetail');
          modalBody.innerHTML = '<div class="text-center p-5"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Loading invoice...</p></div>';
          
          new bootstrap.Modal(document.getElementById('invoiceDetailModal')).show();

          try {
            const user = auth.currentUser;
            if (!user) throw new Error("User not authenticated.");

            const invoiceSnap = await db.ref(`users/${currentCoreAccountId}/invoices/${invoiceId}`).once('value');
            if (!invoiceSnap.exists()) {
              modalBody.innerHTML = '<p class="text-danger text-center">Invoice not found.</p>';
              return;
            }
            const invoice = invoiceSnap.val();
            currentInvoiceData = invoice;
            
            const themeColor = document.getElementById('themeColor').value;
            const accentStyle = document.getElementById('accentStyle').value;
            const fontStyle = document.getElementById('fontStyle').value;

            // **FIX**: Define getSealSVG before it is called in the invoiceHtml template.
            const getSealSVG = (name, gstin) => `
              <svg class="company-seal stamp-on-print" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" style="display: block;"><defs><path id="topTextPath" fill="none" d="M 30,100 a 70,70 0 1,1 140,0" /><path id="bottomTextPath" fill="none" d="M 30,100 a 70,70 0 1,0 140,0" /></defs><g fill="${themeColor}" stroke="${themeColor}"><circle cx="100" cy="100" r="95" stroke-width="3" fill="none"/><circle cx="100" cy="100" r="88" stroke-width="1.5" fill="none"/><text font-family="'Arial Black', 'Impact', sans-serif" font-size="15" letter-spacing="1.5"><textPath xlink:href="#topTextPath" startOffset="50%" text-anchor="middle">${name.toUpperCase().substring(0, 20)}</textPath></text><text font-family="'Arial Black', 'Impact', sans-serif" font-size="12" letter-spacing="1"><textPath xlink:href="#bottomTextPath" startOffset="50%" text-anchor="middle">OFFICIAL SEAL</textPath></text><text x="100" y="125" font-family="'Arial', sans-serif" font-size="14" font-weight="bold" text-anchor="middle" letter-spacing="1">TRANSPORT</text><text x="100" y="145" font-family="'Arial', sans-serif" font-size="9" font-weight="normal" text-anchor="middle">GSTIN: ${gstin || 'N/A'}</text></g></svg>
            `;

            let billedToName = 'N/A', billedToGstin = 'N/A', billedToAddress = 'N/A', billedToMobile = 'N/A';
            let billToLabel = 'Client Company';
            const lrs = invoice.items || [];
            
            if (invoice.invoiceType === 'market' || invoice.invoiceType === 'market_company') {
                billToLabel = 'Transporter Company';
                if (invoice.transporterId) {
                    const transporterSnap = await db.ref(`users/${currentCoreAccountId}/transporters/${invoice.transporterId}`).once('value');
                    if (transporterSnap.exists()) {
                        const t = transporterSnap.val();
                        billedToName = t.name || 'Market Company';
                        billedToGstin = t.gstin || 'N/A';
                        // **FIX**: Use the correct address field from the transporter object.
                        billedToAddress = t.address || t.billingAddress || 'N/A';
                        billedToMobile = t.mobile || 'N/A';
                    }
                }
            } else if (invoice.clientId) {
                const clientSnap = await db.ref(`users/${currentCoreAccountId}/clients/${invoice.clientId}`).once('value');
                if (clientSnap.exists()) {
                    const c = clientSnap.val();
                    billedToName = c.clientName || 'N/A';
                    billedToGstin = c.gstin || 'N/A';
                    billedToAddress = c.billingAddress || 'N/A';
                    billedToMobile = c.mobile || 'N/A';
                }
            }

            const profile = currentUserProfile; 
            const companyLogoUrl = profile.companyLogoUrl || '';
            const companyName = profile.transportName || 'Transvortex Logistics';
            const companyPhone = profile.phoneNumber || 'N/A';
            const fullCompanyAddress = `${profile.address || 'N/A'}, ${profile.city || 'N/A'}, ${profile.pincode || 'N/A'}`;
            const companyGstin = profile.gstin || 'N/A';
            const ownerName = profile.ownerName || 'N/A';

            const status = invoice.paymentStatus || 'pending';
            let stampHtml = '';
            switch (status) {
              case 'paid': stampHtml = '<div class="paid-stamp">Paid</div>'; break;
              case 'partial': stampHtml = '<div class="partial-stamp">Partially Paid</div>'; break;
              case 'pending': stampHtml = '<div class="pending-stamp">Pending</div>'; break;
            }
            
            const headerBgStyle = accentStyle === 'header' ? `style="background-color: ${themeColor}; color: white !important;" class="invoice-theme-bg"` : 'class="table-light"';
            const footerBgStyle = accentStyle === 'footer' ? `style="background-color: ${themeColor}; color: white !important;" class="invoice-theme-bg"` : 'class="table-success"';
            const fontStyleAttr = `style="font-family: ${fontStyle}, sans-serif;"`;

            const invoiceHtml = `
              <div class="printable-area" ${fontStyleAttr} style="position: relative;">
                ${stampHtml}
                <div style="height: 10px; background-color: ${themeColor}; margin-bottom: 20px;"></div>
                <div class="invoice-header-box px-3">
                    <div class="company-details-left">
                        <div class="invoice-title invoice-theme-color" style="color: ${themeColor} !important;">INVOICE</div>
                        <p class="fw-bold mb-1">${companyName}</p>
                        <p class="small mb-0">${fullCompanyAddress}</p>
                        <p class="small mb-0">GSTIN: ${companyGstin}</p>
                    </div>
                    <div class="invoice-details-right">
                        ${companyLogoUrl ? `<img src="${companyLogoUrl}" alt="Logo" class="logo-on-print" style="max-height: 80px; max-width: 100px;">` : `<div class="logo-placeholder">LOGO</div>`}
                        <p class="small mb-1 mt-3">DATE: ${new Date(invoice.createdAt).toLocaleDateString('en-IN')}</p>
                        <p class="small mb-3 fw-bold">INVOICE NO: ${invoice.invoiceNumber}</p>
                    </div>
                </div>
                <div class="billing-shipping-row px-3">
                    <div class="bill-to-box">
                        <p class="fw-bold mb-1 invoice-theme-color" style="color: ${themeColor} !important; border-bottom: 2px solid ${themeColor}; padding-bottom: 5px;">BILL TO:</p>
                        <p class="mb-1 small">${billToLabel}: ${billedToName}</p>
                        <p class="mb-1 small">Address: ${billedToAddress}</p>
                        <p class="mb-0 small">GSTIN: ${billedToGstin}</p>
                    </div>
                </div>
                <div class="table-responsive px-3">
                  <table class="table table-bordered">
                    <thead ${headerBgStyle}>
                      <tr>
                        <th>LR No / Item</th><th>Date</th><th>Truck No</th><th class="text-end">Weight (MT)</th><th class="text-end">Rate</th><th class="text-end">Amount (₹)</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${lrs.map((lr, index) => {
                          const rate = lr.weight > 0 ? (lr.amount / lr.weight).toFixed(2) : '0.00';
                          const rowStyle = accentStyle === 'zebra' && index % 2 !== 0 ? `class="table-zebra-stripe"` : '';
                          return `<tr ${rowStyle}><td>${lr.lrNumber || 'N/A'} - ${lr.item || 'Freight'}</td><td>${new Date(lr.date).toLocaleDateString('en-IN')}</td><td>${lr.truckNumber || 'N/A'}</td><td class="text-end">${(lr.weight || 0).toFixed(2)}</td><td class="text-end">₹${rate}</td><td class="text-end">₹${(lr.amount || 0).toFixed(2)}</td></tr>`;
                      }).join('')}
                    </tbody>
                    <tfoot>
                      <tr>
                        <td colspan="3" rowspan="4" class="align-bottom">
                          <p class="fw-bold mb-1">Remarks / Payment Instructions:</p>
                          <p class="small">Payment is due on receipt. Please include the Invoice number in all bank transfers.</p>
                          <div class="row">
                            <div class="col-md-6"><p class="mb-1 mt-3 fw-bold">Bank Details:</p><p class="mb-1 small">Bank: <span>${invoice.bankDetails.bankName}</span></p><p class="mb-1 small">A/C No: <span>${invoice.bankDetails.accountNumber}</span></p><p class="mb-1 small">IFSC: <span>${invoice.bankDetails.ifscCode || 'N/A'}</span></p></div>
                            <div class="col-md-6 text-end">
                                ${getSealSVG(companyName, companyGstin)}
                            </div>
                          </div>
                        </td><td colspan="2" class="text-end"><strong>SUBTOTAL:</strong></td><td class="text-end fw-bold">₹${(invoice.subtotal || 0).toFixed(2)}</td></tr>
                      <tr><td colspan="2" class="text-end"><strong>CGST (${invoice.cgstPercentage || 9}%):</strong></td><td class="text-end fw-bold">₹${(invoice.cgstAmount || 0).toFixed(2)}</td></tr>
                      <tr><td colspan="2" class="text-end"><strong>SGST (${invoice.sgstPercentage || 9}%):</strong></td><td class="text-end fw-bold">₹${(invoice.sgstAmount || 0).toFixed(2)}</td></tr>
                      <tr ${footerBgStyle}><td colspan="3" class="text-start ps-3 small fw-bold">AMOUNT IN WORDS: ${numberToWords(invoice.grandTotal || 0)}</td><td colspan="2" class="text-end"><strong>BALANCE DUE:</strong></td><td class="text-end fw-bold fs-5">₹${(invoice.grandTotal || 0).toFixed(2)}</td></tr>
                    </tfoot>
                  </table>
                </div>
                <div class="row mt-5 px-3"><div class="col-md-7"><p class="small text-muted">Note: Subject to ${invoice.companyDetails.city || 'Jurisdiction'} Jurisdiction.</p></div><div class="col-md-5 text-end signature-on-print"><div class="mt-4"><p class="mb-4">For <strong class="invoice-theme-color" style="color: ${themeColor} !important;">${companyName}</strong></p><p class="mb-0">___________________</p><p class="mb-0">Authorized Signatory</p></div></div></div>
                <div style="height: 10px; background-color: ${themeColor}; margin-top: 20px;"></div>
              </div>
            `;
            modalBody.innerHTML = invoiceHtml;
            applyLiveStyles();

          } catch (error) {
            console.error("Error viewing invoice:", error);
            modalBody.innerHTML = '<p class="text-danger text-center">Could not load invoice details.</p>';
          }
        }

        window.printInvoiceDetail = function() {
          window.print();
        }

        function numberToWords(num) {
          const a = ['', 'one ', 'two ', 'three ', 'four ', 'five ', 'six ', 'seven ', 'eight ', 'nine ', 'ten ', 'eleven ', 'twelve ', 'thirteen ', 'fourteen ', 'fifteen ', 'sixteen ', 'seventeen ', 'eighteen ', 'nineteen '];
          const b = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
          
          if ((num = Math.floor(num).toString()).length > 9) return 'overflow';
          const n = ('000000000' + num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
          if (!n) return '';
          
          let str = '';
          str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'crore ' : '';
          str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'lakh ' : '';
          str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'thousand ' : '';
          str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'hundred ' : '';
          str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) : '';
          
          return str.trim().replace(/\s+/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ') + ' Only';
        }
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', function() {
          // Initialize DataTable
          // The initialization for lrTable is now at the top of the DOMContentLoaded block
          
          auth.onAuthStateChanged(async (user) => {
            if (user) {
              await loadAllData();
              loadAutoGenerationSettings();
              
              // Set default date to today
              const today = new Date().toISOString().split('T')[0];
              document.getElementById('lrDate').value = today;

              // Event listeners
              document.getElementById('saveLRBtn').addEventListener('click', saveLR);
              document.getElementById('applyFiltersBtn').addEventListener('click', loadLRData);

              // Auto-open invoice modal if invoiceId provided in URL
              try {
                const params = new URLSearchParams(window.location.search);
                const invoiceId = params.get('view') || params.get('invoiceId') || params.get('viewInvoice');
                if (invoiceId) {
                  setTimeout(() => {
                    window.viewInvoice(invoiceId);
                  }, 150);
                }
              } catch (e) { /* ignore */ }

            } else {
              window.location.href = "index.html";
            }
          });
        });

        // --- NEW TRANSPORTER FUNCTIONS (KEEPING FOR COMPLETENESS, BUT NOT RELEVANT TO LR PAGE FIX) ---
        // (Omitted the `loadTransporterList`, `saveTransporterPayment`, and `viewTransporterDetails` functions to save space, assuming they are defined elsewhere or not used on this specific page)

      </script>
<script>
          document.addEventListener('DOMContentLoaded', function() {
            // Initial call to set the correct state based on the checkbox
            const vehicleTypeToggle = document.getElementById('vehicleTypeToggle');
            if (vehicleTypeToggle) {
              toggleVehicleInput(vehicleTypeToggle.checked);
            }

            const editVehicleTypeToggle = document.getElementById('editVehicleTypeToggle');
            if (editVehicleTypeToggle) {
              toggleEditVehicleInput(editVehicleTypeToggle.checked);
            }
          });
        </script>
      </body>
    </html>
