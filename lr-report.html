<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LR Management - Transport System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <style>
    body { padding: 0; margin: 0; background-color: #f8f9fa; }
    .tab-content { background: white; padding: 20px; border-radius: 0 0 8px 8px; }
    .subtotal-row { background-color: #f8f9fa; font-weight: bold; }
    
    /* Vehicle Validation Styles */
    .vehicle-suggestions {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      width: calc(100% - 30px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .vehicle-suggestion {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .vehicle-suggestion:hover {
      background-color: #f8f9fa;
    }

    .vehicle-suggestion:last-child {
      border-bottom: none;
    }

    .vehicle-not-found {
      color: #dc3545;
      font-size: 0.875em;
      margin-top: 5px;
      display: none;
    }

    .vehicle-input-container {
      position: relative;
    }

    .vehicle-valid {
      border-color: #28a745 !important;
    }

    .vehicle-invalid {
      border-color: #dc3545 !important;
    }

    /* Custom style for the client dropdown */
    #clientId {
      color: #2E8B57;
      font-weight: 500;
    }

    /* Modern LR Copy Styles */
    .lr-copy-container {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 14px;
      color: #333;
      border: 2px solid #2c3e50;
      border-radius: 8px;
      padding: 20px;
      background: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .lr-header {
      text-align: center;
      border-bottom: 3px double #2c3e50;
      padding-bottom: 15px;
      margin-bottom: 20px;
      background: linear-gradient(135deg, #2c3e50, #3498db);
      color: white;
      padding: 15px;
      border-radius: 6px 6px 0 0;
      margin: -20px -20px 20px -20px;
    }

    .lr-header h4 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
      letter-spacing: 1px;
    }

    .lr-header p {
      margin: 5px 0 0 0;
      opacity: 0.9;
    }

    .lr-details-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .lr-detail-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px dashed #e0e0e0;
    }

    .lr-detail-item .label {
      font-weight: 600;
      color: #2c3e50;
    }

    .lr-detail-item .value {
      font-weight: 500;
    }

    .lr-section {
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 20px;
      background: #f9f9f9;
    }

    .lr-section h5 {
      font-size: 16px;
      font-weight: 600;
      margin-top: 0;
      border-bottom: 1px solid #ddd;
      padding-bottom: 8px;
      color: #2c3e50;
    }

    .lr-section p {
      margin: 8px 0;
    }

    .lr-amounts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 20px;
    }

    .lr-footer {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-top: 40px;
      padding-top: 20px;
      border-top: 2px solid #2c3e50;
    }

    .signature-area {
      text-align: center;
    }

    .signature-line {
      display: inline-block;
      width: 200px;
      border-top: 1px solid #333;
      margin-top: 60px;
      padding-top: 5px;
    }

    .stamp-area {
      text-align: center;
      margin-top: 20px;
    }

    .stamp {
      display: inline-block;
      border: 2px solid #e74c3c;
      border-radius: 50%;
      width: 120px;
      height: 120px;
      line-height: 120px;
      text-align: center;
      font-weight: bold;
      color: #e74c3c;
      transform: rotate(-15deg);
    }

    .terms-conditions {
      margin-top: 25px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 6px;
      font-size: 12px;
    }

    .terms-conditions h6 {
      margin-top: 0;
      color: #2c3e50;
    }

    .lr-barcode {
      text-align: center;
      margin: 20px 0;
      padding: 10px;
      border-top: 1px dashed #ccc;
      border-bottom: 1px dashed #ccc;
    }

  </style>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

  <!-- Navbar will be loaded here by navbar-loader.js -->
  <div id="navbar-placeholder"></div>

  <div class="container">
    <h2 class="mb-4"><i class="fas fa-file-invoice me-2"></i>LR Management</h2>
    
    <!-- Tabs -->
    <ul class="nav nav-tabs" id="lrTabs">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#view">View Entries</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#add">Add New LR</a>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- View Tab -->
      <div class="tab-pane fade show active" id="view">
        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label">From Date</label>
            <input type="date" class="form-control" id="fromDate">
          </div>
          <div class="col-md-3">
            <label class="form-label">To Date</label>
            <input type="date" class="form-control" id="toDate">
          </div>
          <div class="col-md-3">
            <label class="form-label">Truck Number</label>
            <select class="form-select" id="truckFilter">
              <option value="">All Trucks</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">LR Number</label>
            <input type="text" class="form-control" id="lrSearchInput" placeholder="Search by LR No...">
          </div>
          <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-primary me-2" id="applyFiltersBtn">Filter</button>
            <button class="btn btn-success" id="exportPdfBtn">PDF</button>
          </div>
        </div>
        <div class="mb-3">
          <button class="btn btn-primary" id="generateInvoiceBtn" onclick="showBankDetailsModal()" disabled>
            <i class="fas fa-file-invoice me-2"></i>Generate Invoice
          </button>
        </div>
        <div class="table-responsive">
          <table id="lrTable" class="table table-striped">
            <thead>
              <tr>
                <th>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="selectAllCheckbox">
                  </div>
                </th>
                <th>Date</th>
                <th>LR No</th>
                <th>Truck No</th>
                <th>Consignor</th>
                <th>Consignee</th>
                <th>Item</th>
                <th>From</th>
                <th>To</th>
                <th>Weight</th>
                <th>Billing Amount</th>
                <th>Freight Amount</th>
                <th>Status</th>
                <th>LR Copy</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Rows will be populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Add Tab -->
      <div class="tab-pane fade" id="add">
        <form id="lrForm">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Date <span class="text-danger">*</span></label>
              <input type="date" class="form-control" id="lrDate" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">LR Number <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="lrNumber" readonly>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3 vehicle-input-container">
              <label class="form-label">Truck Number <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="truckNumber" required 
                     placeholder="Start typing vehicle number..."
                     oninput="searchVehicles(this.value)">
              <div id="vehicleSuggestions" class="vehicle-suggestions" style="display: none;"></div>
              <div id="vehicleNotFound" class="vehicle-not-found">
                <i class="fas fa-exclamation-triangle"></i> This vehicle is not registered in the system.
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label for="clientId" class="form-label">Client / Consignor <span class="text-danger">*</span></label>
              <select id="clientId" class="form-select" required>
                <option value="">Select a Client</option>
                <!-- Clients will be populated here by JavaScript -->
              </select>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">From Location <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="fromLocation" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">To Location <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="toLocation" required>
            </div>
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Number of Packages</label>
              <input type="number" class="form-control" id="numPackages" placeholder="For package goods" oninput="calculateWeightFromPackages()">
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Weight per Package (kg)</label>
              <input type="number" step="0.01" class="form-control" id="weightPerPackage" placeholder="e.g., 50" oninput="calculateWeightFromPackages()">
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Weight (tonne) <span class="text-danger">*</span></label>
              <input type="number" class="form-control" id="weight" step="0.01" required oninput="handleManualWeightInput()">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Consignee (if different from client)</label>
              <input type="text" class="form-control" id="consignee">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Item</label>
              <input type="text" class="form-control" id="item">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Shipment No.</label>
              <input type="text" class="form-control" id="shipmentNo">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Billing Rate (₹/tonne)</label>
              <input type="number" step="0.01" class="form-control" id="billingRate" oninput="calculateBillingAmount()">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Billing Amount (₹)</label>
              <input type="number" step="0.01" class="form-control" id="billingAmount" oninput="calculateBillingRate()">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Freight Rate (₹/tonne)</label>
              <input type="number" step="0.01" class="form-control" id="freightRate" oninput="calculateFreightAmount()">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Freight Amount (₹)</label>
              <input type="number" step="0.01" class="form-control" id="freightAmount" oninput="calculateFreightRate()">
            </div>
          </div>
          
          <!-- NEW EXPENSE FIELDS -->
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Tyre Expenses (₹)</label>
              <input type="number" step="0.01" class="form-control" id="tyreExpenses" value="0">
            </div>
            <div class="col-md-8 mb-3">
                <label class="form-label">Diesel Expenses</label>
                <div class="input-group">
                    <select id="dieselPumpName" class="form-select">
                        <option value="">Select a Pump</option>
                        <!-- Petrol pumps will be populated here -->
                    </select>
                    <input type="number" step="0.01" class="form-control" id="dieselLiters" placeholder="Liters" oninput="calculateDieselTotal()">
                    <input type="number" step="0.01" class="form-control" id="dieselPerLiter" placeholder="Price/Liter" oninput="calculateDieselTotal()">
                    <input type="number" step="0.01" class="form-control" id="dieselExpenses" placeholder="Total" readonly>
                </div>
                <div class="form-text">
                    Select a pump, enter liters and price/liter to auto-calculate total.
                </div>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Toll Expenses (₹)</label>
              <input type="number" step="0.01" class="form-control" id="tollExpenses" value="0">
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Vehicle Work (₹)</label>
              <input type="number" step="0.01" class="form-control" id="vehicleWork" value="0">
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Food Expenses (₹)</label>
              <input type="number" step="0.01" class="form-control" id="foodExpenses" value="0">
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Other Expenses (₹)</label>
              <input type="number" step="0.01" class="form-control" id="otherExpenses" value="0" oninput="calculateAmount()">
            </div>
          </div>
          <!-- END NEW EXPENSE FIELDS -->
          
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Payment Type</label>
              <select class="form-select" id="paymentType" onchange="toggleBankNameField('paymentType', 'bankNameContainer')">
                <option value="">Select Payment Type</option>
                <option value="Cash">Cash</option>
                <option value="Bank Transfer">Bank Transfer</option>
              </select>
            </div>
            <div class="col-md-4 mb-3" id="bankNameContainer" style="display: none;">
              <label class="form-label">Bank Name</label>
              <input type="text" class="form-control" id="bankName">
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Advance (₹)</label> 
              <input type="number" step="0.01" class="form-control" id="advance" value="0" oninput="calculateAmount()"> 
            </div>
            <div class="col-md-12 mb-3">
              <label class="form-label">Shortage (kg)</label>
              <input type="number" step="0.01" class="form-control" id="shortage" value="0" oninput="calculateAmount()" placeholder="Shortage in tonnes">
            </div>
          </div>
          <div class="row">
            <div class="col-md-3 mb-3">
              <label class="form-label">CGST %</label>
              <input type="number" step="0.01" class="form-control" id="cgstPercentage" value="9" oninput="calculateAmount()">
            </div>
            <div class="col-md-3 mb-3">
              <label class="form-label">CGST Amount (₹)</label>
              <input type="number" step="0.01" class="form-control" id="cgstAmount" readonly>
            </div>
            <div class="col-md-3 mb-3">
              <label class="form-label">SGST %</label>
              <input type="number" step="0.01" class="form-control" id="sgstPercentage" value="9" oninput="calculateAmount()">
            </div>
            <div class="col-md-3 mb-3">
              <label class="form-label">SGST Amount (₹)</label>
              <input type="number" step="0.01" class="form-control" id="sgstAmount" readonly>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Balance (₹)</label>
              <input type="number" step="0.01" class="form-control" id="balance" readonly>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Total Amount (₹)</label>
              <input type="number" step="0.01" class="form-control" id="totalAmount" readonly>
            </div>
          </div>
          <button type="button" class="btn btn-primary" id="saveLRBtn">Save LR</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Bank Details Modal -->
  <div class="modal fade" id="bankDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Enter Bank & Company Details</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="bankDetailsForm">
            <div class="row mb-3">
              <div class="col-md-6">
                <h6>Company Details</h6>
                <div class="mb-3">
                  <label for="inputCompanyName" class="form-label">Company Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="inputCompanyName" required>
                </div>
                <div class="mb-3">
                  <label for="inputCompanyAddress" class="form-label">Company Address</label>
                  <textarea class="form-control" id="inputCompanyAddress" rows="2"></textarea>
                </div>
                <div class="mb-3">
                  <label for="inputGstNumber" class="form-label">GST Number</label>
                  <input type="text" class="form-control" id="inputGstNumber">
                </div>
                <div class="mb-3">
                  <label for="inputCompanyPhone" class="form-label">Phone Number</label>
                  <input type="text" class="form-control" id="inputCompanyPhone">
                </div>
              </div>
              <div class="col-md-6">
                <h6>Bank Details</h6>
                <div class="mb-3">
                  <label for="inputBankName" class="form-label">Bank Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="inputBankName" required>
                </div>
                <div class="mb-3">
                  <label for="inputAccountHolder" class="form-label">Account Holder Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="inputAccountHolder" required>
                </div>
                <div class="mb-3">
                  <label for="inputAccountNumber" class="form-label">Account Number <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="inputAccountNumber" required>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="inputIfscCode" class="form-label">IFSC Code <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="inputIfscCode" required>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="inputAccountType" class="form-label">Account Type</label>
                      <select class="form-select" id="inputAccountType">
                        <option value="Current">Current</option>
                        <option value="Savings">Savings</option>
                        <option value="CC">Cash Credit</option>
                        <option value="OD">Overdraft</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="createAndSaveInvoice()">Generate Invoice</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Invoice Modal -->
  <div class="modal fade" id="invoiceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title">Invoice Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-4" id="invoiceContent">
          <style>
            @media print {
              @page {
                size: A4 landscape;
                margin: 0.5cm;
              }
              body {
                font-family: Arial, sans-serif;
                font-size: 9px;
                line-height: 1.3;
                color: #333;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
              }
              .no-print {
                display: none !important;
              }
              .table {
                page-break-inside: auto;
                border-collapse: collapse;
                width: 100% !important;
                margin: 0;
                table-layout: fixed;
                width: 100%;
                margin-bottom: 1rem;
              }
              .table th, .table td {
                padding: 3px 5px;
                border: 1px solid #dee2e6 !important;
                vertical-align: middle;
                word-wrap: break-word;
                font-size: 8px;
              }
              .table thead th {
                background-color: #f8f9fa;
                font-weight: 600;
                text-align: center;
              }
              .table tbody td {
                padding: 4px 6px;
              }
              .text-end {
                text-align: right !important;
              }
              .text-center {
                text-align: center !important;
              }
              .invoice-header {
                margin-bottom: 15px;
                padding-bottom: 10px;
                border-bottom: 2px solid #dee2e6;
              }
              .company-details {
                margin-bottom: 15px;
              }
              .invoice-details {
                margin-bottom: 15px;
              }
              .bank-details {
                margin-top: 15px;
                padding: 10px;
                border: 1px solid #dee2e6;
                border-radius: 4px;
                background-color: #f8f9fa;
              }
              .signature-area {
                margin-top: 40px;
                padding-top: 20px;
                border-top: 1px solid #dee2e6;
              }
              .signature-line {
                display: inline-block;
                width: 200px;
                border-top: 1px solid #333;
                margin-top: 30px;
                padding-top: 5px;
              }  .text-end {
                text-align: right !important;
              }
              .text-center {
                text-align: center !important;
              }
              .fw-bold {
                font-weight: bold !important;
              }
              .table-active {
                background-color: #f8f9fa !important;
              }
              .table-light {
                background-color: #f8f9fa !important;
              }
              .border-bottom {
                border-bottom: 1px solid #dee2e6 !important;
              }
              .mt-4 {
                margin-top: 1.5rem !important;
              }
              .mb-0 {
                margin-bottom: 0 !important;
              }
              .mb-1 {
                margin-bottom: 0.25rem !important;
              }
              .mb-4 {
                margin-bottom: 1.5rem !important;
              }
              .me-2 {
                margin-right: 0.5rem !important;
              }
              .p-4 {
                padding: 1.5rem !important;
              }
              .small {
                font-size: 80% !important;
              }
            }
            .invoice-header {
              border-bottom: 2px solid #dee2e6;
              margin-bottom: 20px;
              padding-bottom: 15px;
            }
            .invoice-table th {
              white-space: nowrap;
              background-color: #f8f9fa !important;
            }
          </style>
          
          <div id="printableInvoice">
            <div class="row mb-4">
              <div class="col-12 text-center">
                <h3 class="mb-1">TRANSPORT INVOICE</h3>
                <p class="mb-1" id="companyName">Loading company details...</p>
                <p class="mb-1" id="companyAddress">Loading address...</p>
                <p class="mb-0" id="companyGst">GST: Loading...</p>
              </div>
            </div>
            
            <div class="row mb-4">
              <div class="col-6">
                <p class="mb-1"><strong>Bill To:</strong></p>
                <p id="billToAddress" class="mb-0">Consolidated Invoice</p>
              </div>
              <div class="col-6 text-end">
                <p class="mb-1"><strong>Invoice #: </strong><span id="invoiceNumber">INV-${new Date().getFullYear()}${String(new Date().getMonth() + 1).padStart(2, '0')}${String(new Date().getDate()).padStart(2, '0')}-${Math.floor(1000 + Math.random() * 9000)}</span></p>
                <p class="mb-1"><strong>Date: </strong><span id="invoiceDate">${new Date().toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' })}</span></p>
              </div>
            </div>
            
            <div class="table-responsive">
              <table class="table table-bordered table-sm invoice-table">
                <thead class="table-light" style="background-color: #f8f9fa !important;">
                  <tr>
                    <th style="width: 70px;">Date</th>
                    <th style="width: 90px;">LR No</th>
                    <th style="width: 70px;">Truck No</th>
                    <th style="width: 100px;">Consignor</th>
                    <th style="width: 100px;">Consignee</th>
                    <th style="width: 80px;">From</th>
                    <th style="width: 80px;">To</th>
                    <th class="text-end" style="width: 60px;">Weight</th>
                    <th class="text-end" style="width: 60px;">Rate</th>
                    <th class="text-end" style="width: 45px;">GST %</th>
                    <th class="text-end" style="width: 70px;">GST Amt</th>
                    <th class="text-end" style="width: 80px;">Amount</th>
                  </tr>
                </thead>
                <tbody id="invoiceItems">
                  <!-- Invoice items will be populated here -->
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="7" class="border-0"></td>
                    <td class="text-end border-0"><strong>Subtotal:</strong></td>
                    <td class="text-end border-0"></td>
                    <td class="text-end border-0"></td>
                    <td class="text-end border-0" colspan="2">-</td>
                    <td class="text-end fw-bold border-0" id="subtotalAmount">₹0.00</td>
                  </tr>
                  <tr id="cgstRow">
                    <td colspan="7" class="border-0"></td>
                    <td class="text-end border-0" colspan="4"><strong>CGST:</strong></td>
                    <td class="text-end fw-bold border-0" id="invoiceCgstAmount">₹0.00</td>
                  </tr>
                  <tr id="sgstRow">
                    <td colspan="7" class="border-0"></td>
                    <td class="text-end border-0" colspan="4"><strong>SGST:</strong></td>
                    <td class="text-end fw-bold border-0" id="invoiceSgstAmount">₹0.00</td>
                  </tr>
                  <tr class="table-active">
                    <td colspan="7" class="border-0"></td>
                    <td class="text-end border-0"><strong>Grand Total:</strong></td>
                    <td class="text-end border-0" colspan="3">-</td>
                    <td class="text-end fw-bold border-0" id="grandTotal">₹0.00</td>
                  </tr>
                </tfoot>
              </table>
            </div>
            
            <div class="row mt-4">
              <div class="col-md-6">
                <p class="mb-1"><strong>Bank Details:</strong></p>
                <p class="mb-1">Bank: <span id="invoiceBankName">-</span></p>
                <p class="mb-1">Account Number: <span id="invoiceAccountNumber">-</span></p>
                <p class="mb-1">Account Holder: <span id="invoiceAccountHolder">-</span></p>
                <p class="mb-1">IFSC: <span id="invoiceIfscCode">-</span></p>
                <p class="mb-0">Account Type: <span id="invoiceAccountType">Current</span></p>
                <div class="mt-3">
                  <p class="mb-1"><strong>Amount in Words:</strong></p>
                  <p class="mb-0 small" id="amountInWords">-</p>
                </div>
              </div>
              <div class="col-md-6 text-end">
                <div class="mt-5">
                  <p class="mb-4">For <span id="companyNameFooter">[Company Name]</span></p>
                  <p class="mb-0">___________________</p>
                  <p class="mb-0">Authorized Signatory</p>
                </div>
              </div>
            </div>
            
            <div class="row mt-4 text-center">
              <div class="col-12">
                <p class="mb-0"><small>This is a computer-generated invoice. No signature required.</small></p>
              </div>
            </div>
          </div>
          
          <div class="mt-4 no-print text-center">
            <button class="btn btn-primary me-2" onclick="printInvoice()">
              <i class="fas fa-print me-2"></i>Print Invoice
            </button>
            
            <button class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times me-2"></i>Close
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="printInvoice()">
            <i class="fas fa-print me-2"></i>Print Invoice
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- LR Copy Modal -->
  <div class="modal fade" id="lrCopyModal" tabindex="-1" aria-labelledby="lrCopyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="lrCopyModalLabel">Lorry Receipt</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="lrCopyContent">
          <!-- LR Copy content will be populated here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="printLRCopy()"><i class="fas fa-print me-2"></i>Print LR</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="editLRModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit LR Record</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editLrForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Date <span class="text-danger">*</span></label>
                <input type="date" class="form-control" id="editLrDate" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">LR Number <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="editLrNumber" readonly>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3 vehicle-input-container">
                <label class="form-label">Truck Number <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="editTruckNumber" required 
                       placeholder="Start typing vehicle number..."
                       oninput="searchEditVehicles(this.value)">
                <div id="editVehicleSuggestions" class="vehicle-suggestions" style="display: none;"></div>
                <div id="editVehicleNotFound" class="vehicle-not-found">
                  <i class="fas fa-exclamation-triangle"></i> This vehicle is not registered in the system.
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label for="editClientId" class="form-label">Client / Consignor <span class="text-danger">*</span></label>
                <select id="editClientId" class="form-select" required>
                  <option value="">Select a Client</option>
                  <!-- Clients will be populated here by JavaScript -->
                </select>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">From Location <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="editFromLocation" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">To Location <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="editToLocation" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">Number of Packages</label>
                <input type="number" class="form-control" id="editNumPackages" oninput="calculateEditWeightFromPackages()">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Weight per Package (kg)</label>
                <input type="number" step="0.01" class="form-control" id="editWeightPerPackage" oninput="calculateEditWeightFromPackages()">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Weight (tonne) <span class="text-danger">*</span></label>
                <input type="number" class="form-control" id="editWeight" step="0.01" required oninput="handleEditManualWeightInput()">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Consignee</label>
                <input type="text" class="form-control" id="editConsignee">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Item</label>
                <input type="text" class="form-control" id="editItem">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Shipment No.</label>
                <input type="text" class="form-control" id="editShipmentNo">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Billing Rate (₹/tonne)</label>
                <input type="number" step="0.01" class="form-control" id="editBillingRate" oninput="calculateEditBillingAmount()">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Billing Amount (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editBillingAmount" oninput="calculateEditBillingRate()">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Freight Rate (₹/tonne)</label>
                <input type="number" step="0.01" class="form-control" id="editFreightRate" oninput="calculateEditFreightAmount()">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Freight Amount (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editFreightAmount" oninput="calculateEditFreightRate()">
              </div>
            </div>
            
            <!-- NEW EXPENSE FIELDS -->
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">Tyre Expenses (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editTyreExpenses" value="0">
              </div>
              <div class="col-md-8 mb-3">
                  <label class="form-label">Diesel Expenses</label>
                  <div class="input-group">
                      <select id="editDieselPumpName" class="form-select">
                          <option value="">Select a Pump</option>
                          <!-- Petrol pumps will be populated here -->
                      </select>
                      <input type="number" step="0.01" class="form-control" id="editDieselLiters" placeholder="Liters" oninput="calculateEditDieselTotal()">
                      <input type="number" step="0.01" class="form-control" id="editDieselPerLiter" placeholder="Price/Liter" oninput="calculateEditDieselTotal()">
                      <input type="number" step="0.01" class="form-control" id="editDieselExpenses" placeholder="Total" readonly>
                  </div>
                  <div class="form-text">
                      Select a pump, enter liters and price/liter to auto-calculate total.
                  </div>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Toll Expenses (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editTollExpenses" value="0">
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">Vehicle Work (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editVehicleWork" value="0">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Food Expenses (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editFoodExpenses" value="0">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Other Expenses (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editOtherExpenses" value="0" oninput="calculateEditAmount()">
              </div>
            </div>
            <!-- END NEW EXPENSE FIELDS -->
            
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">Payment Type</label>
                <select class="form-select" id="editPaymentType" onchange="toggleBankNameField('editPaymentType', 'editBankNameContainer')">
                  <option value="">Select Payment Type</option>
                  <option value="Cash">Cash</option>
                  <option value="Bank Transfer">Bank Transfer</option>
                </select>
              </div>
              <div class="col-md-4 mb-3" id="editBankNameContainer" style="display: none;">
                <label class="form-label">Bank Name</label>
                <input type="text" class="form-control" id="editBankName">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Advance (₹)</label> 
                <input type="number" step="0.01" class="form-control" id="editAdvance" value="0" oninput="calculateEditAmount()"> 
              </div>
              <div class="col-md-12 mb-3">
                <label class="form-label">Shortage (kg)</label>
                <input type="number" step="0.01" class="form-control" id="editShortage" value="0" oninput="calculateEditAmount()" placeholder="Shortage in tonnes">
              </div>
            </div>
            <div class="row">
              <div class="col-md-3 mb-3">
                <label class="form-label">CGST %</label>
                <input type="number" step="0.01" class="form-control" id="editCgstPercentage" value="9" oninput="calculateEditAmount()">
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label">CGST Amount (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editCgstAmount" readonly>
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label">SGST %</label>
                <input type="number" step="0.01" class="form-control" id="editSgstPercentage" value="9" oninput="calculateEditAmount()">
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label">SGST Amount (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editSgstAmount" readonly>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Balance (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editBalance" readonly>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Total Amount (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editTotalAmount" readonly>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="updateLRBtn">Update LR</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="navbar-loader.js"></script>
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDAlk_K8p8Of8Ne6Jpcl2QqXTtm95NgG7o",
      authDomain: "transport-dashboard-ad69a.firebaseapp.com",
      databaseURL: "https://transport-dashboard-ad69a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "transport-dashboard-ad69a",
      storageBucket: "transport-dashboard-ad69a.appspot.com",
      messagingSenderId: "526889676196",
      appId: "1:526889676196:web:66032c80a4aede690ae531",
      measurementId: "G-7F9R7HJYDH"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    // Global Constants
    const SHORTAGE_DEDUCTION_RATE = 100; // Example: Deduct ₹100 per tonne of shortage

    let allVehicles = [];
    let allClients = [];
    let allPetrolPumps = [];
    let selectedLRs = [];
    let currentEditingLRId = null;
    let currentCoreAccountId = null;

    // Load all vehicles from Firebase - COMPLETELY FIXED VERSION
    async function loadAllVehicles(userId) {
      try {
        console.log("🔍 Starting vehicle load for user:", userId);
        
        // Method 1: Try to get coreAccountId from user profile first
        const userProfileRef = database.ref(`users/${userId}`);
        const userSnapshot = await userProfileRef.once('value');
        const userData = userSnapshot.val();
        
        if (userData) {
          // Check if this is a branch account
          if (userData.coreAccountId) {
            currentCoreAccountId = userData.coreAccountId;
            console.log("✅ Branch account detected. Core account ID:", currentCoreAccountId);
          } else if (userData.accountType === 'branch' && userData.coreAccountId) {
            currentCoreAccountId = userData.coreAccountId;
            console.log("✅ Branch account detected via accountType. Core account ID:", currentCoreAccountId);
          } else {
            // This is a core account - use their own ID
            currentCoreAccountId = userId;
            console.log("✅ Core account detected. Using user ID:", currentCoreAccountId);
          }
        } else {
          // Fallback: use user's own ID
          currentCoreAccountId = userId;
          console.log("⚠️ No user data found, using user ID as core account:", currentCoreAccountId);
        }

        console.log("🚗 Loading vehicles from path: users/" + currentCoreAccountId + "/vehicles");
        
        const vehiclesRef = database.ref(`users/${currentCoreAccountId}/vehicles`);
        vehiclesRef.on('value', (snapshot) => {
          allVehicles = [];
          if (snapshot.exists()) {
            snapshot.forEach((childSnapshot) => {
              const vehicle = childSnapshot.val();
              allVehicles.push({
                id: childSnapshot.key,
                vehicleNo: vehicle.vehicleNumber || '', // Correct field name from add.html
                driverName: vehicle.driverName || ''
              });
            });
            console.log("✅ Successfully loaded vehicles:", allVehicles);
          } else {
            console.log("❌ No vehicles found at path: users/" + currentCoreAccountId + "/vehicles");
          }
          updateTruckFilterDropdown();
        }, (error) => {
          console.error("❌ Error loading vehicles:", error);
        });
        
      } catch (error) {
        console.error("❌ Failed to load vehicle master list:", error);
      }
    }

    // Update truck filter dropdown with available vehicles
    function updateTruckFilterDropdown() {
      const truckFilter = document.getElementById('truckFilter');
      if (!truckFilter) return;
      
      // Store current selection
      const currentValue = truckFilter.value;
      
      // Clear and rebuild dropdown
      truckFilter.innerHTML = '<option value="">All Trucks</option>';
      
      // Create a unique set of vehicle numbers
      const uniqueVehicles = [...new Set(allVehicles.map(v => v.vehicleNo))].filter(v => v);
      
      console.log("🔄 Updating truck filter with vehicles:", uniqueVehicles);
      
      uniqueVehicles.sort().forEach(vehicleNo => {
        const option = document.createElement('option');
        option.value = vehicleNo;
        option.textContent = vehicleNo;
        truckFilter.appendChild(option);
      });
      
      // Restore selection if it still exists
      if (currentValue && uniqueVehicles.includes(currentValue)) {
        truckFilter.value = currentValue;
      }
      
      // Also update the truck number input placeholder with count
      const truckInput = document.getElementById('truckNumber');
      if (truckInput && allVehicles.length > 0) {
        truckInput.placeholder = `Start typing vehicle number... (${allVehicles.length} vehicles available)`;
      }
    }

    // Load all clients from Firebase
    async function loadAllClients() {
      const user = auth.currentUser;
      if (!user) return;

      // **FIX**: Fetch from the user-specific path
      const coreAccountId = await getCoreAccountId(user.uid);
      const clientsRef = database.ref(`users/${coreAccountId}/clients`);

      clientsRef.on('value', (snapshot) => {
        allClients = [];
        const clientSelect = document.getElementById('clientId');
        const editClientSelect = document.getElementById('editClientId');
        
        clientSelect.innerHTML = '<option value="">Select a Client</option>';
        editClientSelect.innerHTML = '<option value="">Select a Client</option>';
        
        if (snapshot.exists()) {
          snapshot.forEach((childSnapshot) => {
            const client = childSnapshot.val();
            const clientData = { id: childSnapshot.key, ...client };
            allClients.push(clientData);
            
            // Add to client select dropdowns
            const option = document.createElement('option');
            option.value = clientData.id; // The key of the client object
            option.textContent = clientData.clientName; // The name of the client
            clientSelect.appendChild(option);
            
            const editOption = document.createElement('option');
            editOption.value = clientData.id; // The key of the client object
            editOption.textContent = clientData.clientName; // The name of the client
            editClientSelect.appendChild(editOption);
          });
          console.log("✅ Loaded clients:", allClients.length);
          // **FIX**: Now that clients are loaded, we can safely load the LR data.
          loadLRData();

        } else {
          console.log("❌ No clients found");
        }
      });
    }

    // Load all petrol pumps from Firebase
    async function loadAllPetrolPumps() {
      const user = auth.currentUser;
      if (!user) return;
 
      // **FIX**: Fetch pumps from the currently logged-in user's own data path.
      const pumpsRef = database.ref(`users/${user.uid}/petrolPumps`);
 
      pumpsRef.on('value', (snapshot) => {
        allPetrolPumps = [];
        const pumpSelect = document.getElementById('dieselPumpName');
        const editPumpSelect = document.getElementById('editDieselPumpName');
        
        pumpSelect.innerHTML = '<option value="">Select a Pump</option>';
        editPumpSelect.innerHTML = '<option value="">Select a Pump</option>';
        
        if (snapshot.exists()) {
          snapshot.forEach((childSnapshot) => {
            const pump = childSnapshot.val();
            const pumpData = { id: childSnapshot.key, ...pump };
            allPetrolPumps.push(pumpData);
            
            // Add to pump select dropdowns
            const option = document.createElement('option');
            option.value = pumpData.name;
            option.textContent = `${pumpData.name} - ${pumpData.place || 'N/A'}`;
            pumpSelect.appendChild(option);
            
            const editOption = document.createElement('option');
            editOption.value = pumpData.name;
            editOption.textContent = `${pumpData.name} - ${pumpData.location}`;
            editPumpSelect.appendChild(editOption);
          });
          console.log("✅ Loaded petrol pumps:", allPetrolPumps.length);
        } else {
          console.log("❌ No petrol pumps found");
        }
      });
    }

    // **NEW**: Helper function to get the core account ID for any user
    async function getCoreAccountId(userId) {
        if (!userId) return null;
        const userProfileRef = database.ref(`users/${userId}/profile`);
        const userProfileSnap = await userProfileRef.once('value');
        if (userProfileSnap.exists()) {
            const profileData = userProfileSnap.val();
            return profileData.coreAccountId || userId;
        }
        return userId; // Fallback to the user's own ID
    }

    // Vehicle search and validation functions
    function searchVehicles(query) {
      const suggestionsContainer = document.getElementById('vehicleSuggestions');
      const notFoundMessage = document.getElementById('vehicleNotFound');
      const truckNumberInput = document.getElementById('truckNumber');
      
      if (query.length < 1) {
        suggestionsContainer.style.display = 'none';
        notFoundMessage.style.display = 'none';
        truckNumberInput.classList.remove('vehicle-valid', 'vehicle-invalid');
        return;
      }
      
      const filteredVehicles = allVehicles.filter(vehicle => 
        vehicle.vehicleNo.toLowerCase().includes(query.toLowerCase())
      );
      
      if (filteredVehicles.length > 0) {
        suggestionsContainer.innerHTML = '';
        filteredVehicles.forEach(vehicle => {
          const suggestion = document.createElement('div');
          suggestion.className = 'vehicle-suggestion';
          suggestion.textContent = vehicle.vehicleNo;
          suggestion.onclick = () => {
            truckNumberInput.value = vehicle.vehicleNo;
            suggestionsContainer.style.display = 'none';
            notFoundMessage.style.display = 'none';
            truckNumberInput.classList.add('vehicle-valid');
            truckNumberInput.classList.remove('vehicle-invalid');
          };
          suggestionsContainer.appendChild(suggestion);
        });
        suggestionsContainer.style.display = 'block';
        notFoundMessage.style.display = 'none';
        truckNumberInput.classList.remove('vehicle-valid', 'vehicle-invalid');
      } else {
        suggestionsContainer.style.display = 'none';
        notFoundMessage.style.display = 'block';
        truckNumberInput.classList.add('vehicle-invalid');
        truckNumberInput.classList.remove('vehicle-valid');
      }
    }

    function searchEditVehicles(query) {
      const suggestionsContainer = document.getElementById('editVehicleSuggestions');
      const notFoundMessage = document.getElementById('editVehicleNotFound');
      const truckNumberInput = document.getElementById('editTruckNumber');
      
      if (query.length < 1) {
        suggestionsContainer.style.display = 'none';
        notFoundMessage.style.display = 'none';
        truckNumberInput.classList.remove('vehicle-valid', 'vehicle-invalid');
        return;
      }
      
      const filteredVehicles = allVehicles.filter(vehicle => 
        vehicle.vehicleNo.toLowerCase().includes(query.toLowerCase())
      );
      
      if (filteredVehicles.length > 0) {
        suggestionsContainer.innerHTML = '';
        filteredVehicles.forEach(vehicle => {
          const suggestion = document.createElement('div');
          suggestion.className = 'vehicle-suggestion';
          suggestion.textContent = vehicle.vehicleNo;
          suggestion.onclick = () => {
            truckNumberInput.value = vehicle.vehicleNo;
            suggestionsContainer.style.display = 'none';
            notFoundMessage.style.display = 'none';
            truckNumberInput.classList.add('vehicle-valid');
            truckNumberInput.classList.remove('vehicle-invalid');
          };
          suggestionsContainer.appendChild(suggestion);
        });
        suggestionsContainer.style.display = 'block';
        notFoundMessage.style.display = 'none';
        truckNumberInput.classList.remove('vehicle-valid', 'vehicle-invalid');
      } else {
        suggestionsContainer.style.display = 'none';
        notFoundMessage.style.display = 'block';
        truckNumberInput.classList.add('vehicle-invalid');
        truckNumberInput.classList.remove('vehicle-valid');
      }
    }

    // Close suggestions when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.matches('#truckNumber')) {
        document.getElementById('vehicleSuggestions').style.display = 'none';
      }
      if (!e.target.matches('#editTruckNumber')) {
        document.getElementById('editVehicleSuggestions').style.display = 'none';
      }
    });

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          console.log("👤 User authenticated:", user.uid);
          
          // Load vehicles first (this is critical for the form to work)
          await loadAllVehicles(user.uid);
          
          // Then load other data
          loadAllClients(); // Changed to not await, as it uses onValue
          loadAllPetrolPumps(); // Changed to not await, as it uses onValue
          generateLRNumber(); // This can run independently
          
          // Set default date to today
          const today = new Date().toISOString().split('T')[0];
          document.getElementById('lrDate').value = today;

          // **FIX**: Check for a `view` parameter in the URL to auto-open an LR for editing.
          const urlParams = new URLSearchParams(window.location.search);
          const lrToView = urlParams.get('view');
          if (lrToView) {
            // Use a timeout to ensure the data is loaded before trying to edit
            setTimeout(() => editLR(lrToView), 500);
          }
        } else {
          console.log("❌ User not authenticated");
        }
      });

      // Event listeners
      document.getElementById('saveLRBtn').addEventListener('click', saveLR);
      document.getElementById('updateLRBtn').addEventListener('click', updateLR);
      document.getElementById('applyFiltersBtn').addEventListener('click', loadLRData);
      document.getElementById('selectAllCheckbox').addEventListener('change', toggleSelectAll);
      
      // Initialize DataTable
      $('#lrTable').DataTable({
        pageLength: 10,
        responsive: true,
        autoWidth: false
      });
    });

    // Generate LR Number
    function generateLRNumber() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const random = Math.floor(1000 + Math.random() * 9000);
      const lrNumber = `LR${year}${month}${day}${random}`;
      document.getElementById('lrNumber').value = lrNumber;
    }

    // Show LR Copy - FIXED FUNCTION
    function showLRCopy(lrId) {
      const user = auth.currentUser;
      if (!user) return;
      
      const lrRef = database.ref(`users/${currentCoreAccountId}/lrReports/${lrId}`);
      // **FIX**: The company profile details (transportName, address, gstNumber) are stored
      // directly under the core account's profile, not in a nested 'profile' object
      // for the main branch user. This change points to the correct location.
      const userProfileRef = database.ref(`users/${currentCoreAccountId}`);
      
      Promise.all([lrRef.once('value'), userProfileRef.once('value')]).then(([lrSnapshot, profileSnapshot]) => {
        const lr = lrSnapshot.val();
        const client = allClients.find(c => c.id === lr.clientId) || {};
        const profile = profileSnapshot.exists() ? profileSnapshot.val() : {};
        const companyName = profile.transportName || 'TRANSPORT COMPANY LTD.';
        
        // Format date
        const lrDate = new Date(lr.date);
        const formattedDate = lrDate.toLocaleDateString('en-IN', { 
          day: '2-digit', 
          month: 'short', 
          year: 'numeric' 
        });
        
        // Create professional LR copy content
        const lrCopyContent = `
          <div class="lr-copy-container">
            <div class="lr-header">
              <h4>LORRY RECEIPT</h4>
              <p>${companyName}</p>
              <p>${profile.address || 'Registered Office Address'}</p>
            </div>
            
            <div class="lr-details-grid">
              <div class="lr-detail-item">
                <span class="label">LR No:</span>
                <span class="value">${lr.lrNumber}</span>
              </div>
              <div class="lr-detail-item">
                <span class="label">Date:</span>
                <span class="value">${formattedDate}</span>
              </div>
              <div class="lr-detail-item">
                <span class="label">Truck No:</span>
                <span class="value">${lr.truckNumber}</span>
              </div>
              <div class="lr-detail-item">
                <span class="label">Shipment No:</span>
                <span class="value">${lr.shipmentNo || 'N/A'}</span>
              </div>
            </div>
            
            <div class="lr-section">
              <h5>CONSIGNOR DETAILS</h5>
              <p><strong>Name:</strong> ${client.clientName || lr.consignor || 'N/A'}</p>
              <p><strong>Address:</strong> ${client.billingAddress || 'Address not available'}</p>
              <p><strong>GSTIN:</strong> ${client.gstin || 'Not available'}</p>
              <p><strong>Contact:</strong> ${client.mobile || 'Not available'}</p>
            </div>
            
            <div class="lr-section">
              <h5>CONSIGNEE DETAILS</h5>
              <p><strong>Name:</strong> ${lr.consignee || client.clientName || 'N/A'}</p>
              <p><strong>From:</strong> ${lr.fromLocation}</p>
              <p><strong>To:</strong> ${lr.toLocation}</p>
            </div>
            
            <div class="lr-section">
              <h5>GOODS DETAILS</h5>
              <p><strong>Item:</strong> ${lr.item || 'General Goods'}</p>
              <p><strong>Weight:</strong> ${lr.weight} tonnes</p>
              <p><strong>Packages:</strong> ${lr.numPackages || 'N/A'}</p>
              <p><strong>Package Details:</strong> ${lr.numPackages ? lr.numPackages + ' packages, ' + (lr.weightPerPackage || 0) + ' kg each' : 'N/A'}</p>
            </div>
            
            <div class="lr-amounts-grid">
              <div class="lr-section">
                <h5>BILLING DETAILS</h5>
                <p><strong>Rate:</strong> ₹${lr.billingRate || 0}/tonne</p>
                <p><strong>Amount:</strong> ₹${lr.billingAmount || 0}</p>
                <p><strong>Advance:</strong> ₹${lr.advance || 0}</p>
                <p><strong>Balance:</strong> ₹${lr.balance || 0}</p>
              </div>
              
              <div class="lr-section">
                <h5>FREIGHT DETAILS</h5>
                <p><strong>Rate:</strong> ₹${lr.freightRate || 0}/tonne</p>
                <p><strong>Amount:</strong> ₹${lr.freightAmount || 0}</p>
                <p><strong>Payment Type:</strong> ${lr.paymentType || 'N/A'}</p>
                ${lr.bankName ? `<p><strong>Bank:</strong> ${lr.bankName}</p>` : ''}
              </div>
            </div>
            
            <div class="lr-section">
              <h5>TAX DETAILS</h5>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                <p><strong>CGST (${lr.cgstPercentage || 0}%):</strong> ₹${lr.cgstAmount || 0}</p>
                <p><strong>SGST (${lr.sgstPercentage || 0}%):</strong> ₹${lr.sgstAmount || 0}</p>
                <p><strong>Shortage:</strong> ${lr.shortage || 0} kg</p>
                <p><strong>Total Amount:</strong> ₹${lr.totalAmount || 0}</p>
              </div>
            </div>
            
            <div class="lr-barcode">
              <p>*** ${lr.lrNumber} ***</p>
            </div>
            
            <div class="terms-conditions">
              <h6>TERMS & CONDITIONS</h6>
              <p>1. Goods are carried subject to the conditions of the Carriage of Goods Act.</p>
              <p>2. The carrier shall not be responsible for loss or damage due to natural calamities.</p>
              <p>3. Payment should be made within 15 days from the date of receipt.</p>
              <p>4. All disputes subject to Delhi jurisdiction only.</p>
            </div>
            
            <div class="lr-footer">
              <div class="signature-area">
                <p>Consignor's Signature</p>
                <div class="signature-line"></div>
              </div>
              <div class="signature-area">
                <p>Authorized Signatory</p>
                <div class="signature-line"></div>
                <div class="stamp-area">
                  <div class="stamp">RECEIVED</div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // Populate the modal content
        document.getElementById('lrCopyContent').innerHTML = lrCopyContent;
        
        // Show the modal
        const lrCopyModal = new bootstrap.Modal(document.getElementById('lrCopyModal'));
        lrCopyModal.show();
      }).catch((error) => {
        console.error('Error loading LR data:', error);
        alert('Error loading LR details. Please try again.');
      });
    }

    // Print LR Copy
    function printLRCopy() {
      const printContent = document.getElementById('lrCopyContent').innerHTML;
      const originalContent = document.body.innerHTML;

      // Temporarily replace the body's content with just the LR copy
      document.body.innerHTML = printContent;

      // Trigger the print dialog
      window.print();

      // Restore the original content after printing
      document.body.innerHTML = originalContent;

      // Re-initialize event listeners and components that were lost
      // This is a simplified re-initialization. A more robust solution might
      // involve a dedicated function to re-attach all event listeners.
      window.location.reload();
    }

    // Calculate functions for the main form
    function calculateWeightFromPackages() {
      const numPackages = parseFloat(document.getElementById('numPackages').value) || 0;
      const weightPerPackage = parseFloat(document.getElementById('weightPerPackage').value) || 0;
      
      if (numPackages > 0 && weightPerPackage > 0) {
        const totalWeightKg = numPackages * weightPerPackage;
        const totalWeightTonne = totalWeightKg / 1000;
        document.getElementById('weight').value = totalWeightTonne.toFixed(3);
        calculateBillingAmount();
        calculateFreightAmount();
      }
    }

    function handleManualWeightInput() {
      // Clear package fields when manually entering weight
      document.getElementById('numPackages').value = '';
      document.getElementById('weightPerPackage').value = '';
      calculateBillingAmount();
      calculateFreightAmount();
    }

    function calculateBillingAmount() {
      const weight = parseFloat(document.getElementById('weight').value) || 0;
      const billingRate = parseFloat(document.getElementById('billingRate').value) || 0;
      const billingAmount = weight * billingRate;
      document.getElementById('billingAmount').value = billingAmount.toFixed(2);
      calculateAmount();
    }

    function calculateBillingRate() {
      const weight = parseFloat(document.getElementById('weight').value) || 0;
      const billingAmount = parseFloat(document.getElementById('billingAmount').value) || 0;
      if (weight > 0) {
        const billingRate = billingAmount / weight;
        document.getElementById('billingRate').value = billingRate.toFixed(2);
      }
      calculateAmount();
    }

    function calculateFreightAmount() {
      const weight = parseFloat(document.getElementById('weight').value) || 0;
      const freightRate = parseFloat(document.getElementById('freightRate').value) || 0;
      const freightAmount = weight * freightRate;
      document.getElementById('freightAmount').value = freightAmount.toFixed(2);
      calculateAmount();
    }

    function calculateFreightRate() {
      const weight = parseFloat(document.getElementById('weight').value) || 0;
      const freightAmount = parseFloat(document.getElementById('freightAmount').value) || 0;
      if (weight > 0) {
        const freightRate = freightAmount / weight;
        document.getElementById('freightRate').value = freightRate.toFixed(2);
      }
      calculateAmount();
    }

    function calculateDieselTotal() {
      const liters = parseFloat(document.getElementById('dieselLiters').value) || 0;
      const perLiter = parseFloat(document.getElementById('dieselPerLiter').value) || 0;
      const total = liters * perLiter;
      document.getElementById('dieselExpenses').value = total.toFixed(2);
      calculateAmount();
    }

    function calculateAmount() {
      const billingAmount = parseFloat(document.getElementById('billingAmount').value) || 0;
      const advance = parseFloat(document.getElementById('advance').value) || 0;
      const shortage = parseFloat(document.getElementById('shortage').value) || 0;
      const cgstPercentage = parseFloat(document.getElementById('cgstPercentage').value) || 0;
      const sgstPercentage = parseFloat(document.getElementById('sgstPercentage').value) || 0;
      
      // Calculate GST amounts
      const cgstAmount = (billingAmount * cgstPercentage) / 100;
      const sgstAmount = (billingAmount * sgstPercentage) / 100;
      
      document.getElementById('cgstAmount').value = cgstAmount.toFixed(2);
      document.getElementById('sgstAmount').value = sgstAmount.toFixed(2);
      
      // Calculate total amount (billing + GST)
      const totalAmount = billingAmount + cgstAmount + sgstAmount;
      document.getElementById('totalAmount').value = totalAmount.toFixed(2);
      
      // Calculate balance (total - advance - shortage deduction)
      // **FIX**: Use the dynamic billingRate for shortage calculation, not a fixed rate.
      const currentBillingRate = parseFloat(document.getElementById('billingRate').value) || 0;
      const shortageDeduction = (shortage / 1000) * currentBillingRate;
      const balance = totalAmount - advance - shortageDeduction;
      document.getElementById('balance').value = balance.toFixed(2);
    }

    // Calculate functions for the edit form
    function calculateEditWeightFromPackages() {
      const numPackages = parseFloat(document.getElementById('editNumPackages').value) || 0;
      const weightPerPackage = parseFloat(document.getElementById('editWeightPerPackage').value) || 0;
      
      if (numPackages > 0 && weightPerPackage > 0) {
        const totalWeightKg = numPackages * weightPerPackage;
        const totalWeightTonne = totalWeightKg / 1000;
        document.getElementById('editWeight').value = totalWeightTonne.toFixed(3);
        calculateEditBillingAmount();
        calculateEditFreightAmount();
      }
    }

    function handleEditManualWeightInput() {
      document.getElementById('editNumPackages').value = '';
      document.getElementById('editWeightPerPackage').value = '';
      calculateEditBillingAmount();
      calculateEditFreightAmount();
    }

    function calculateEditBillingAmount() {
      const weight = parseFloat(document.getElementById('editWeight').value) || 0;
      const billingRate = parseFloat(document.getElementById('editBillingRate').value) || 0;
      const billingAmount = weight * billingRate;
      document.getElementById('editBillingAmount').value = billingAmount.toFixed(2);
      calculateEditAmount();
    }

    function calculateEditBillingRate() {
      const weight = parseFloat(document.getElementById('editWeight').value) || 0;
      const billingAmount = parseFloat(document.getElementById('editBillingAmount').value) || 0;
      if (weight > 0) {
        const billingRate = billingAmount / weight;
        document.getElementById('editBillingRate').value = billingRate.toFixed(2);
      }
      calculateEditAmount();
    }

    function calculateEditFreightAmount() {
      const weight = parseFloat(document.getElementById('editWeight').value) || 0;
      const freightRate = parseFloat(document.getElementById('editFreightRate').value) || 0;
      const freightAmount = weight * freightRate;
      document.getElementById('editFreightAmount').value = freightAmount.toFixed(2);
      calculateEditAmount();
    }

    function calculateEditFreightRate() {
      const weight = parseFloat(document.getElementById('editWeight').value) || 0;
      const freightAmount = parseFloat(document.getElementById('editFreightAmount').value) || 0;
      if (weight > 0) {
        const freightRate = freightAmount / weight;
        document.getElementById('editFreightRate').value = freightRate.toFixed(2);
      }
      calculateEditAmount();
    }

    function calculateEditDieselTotal() {
      const liters = parseFloat(document.getElementById('editDieselLiters').value) || 0;
      const perLiter = parseFloat(document.getElementById('editDieselPerLiter').value) || 0;
      const total = liters * perLiter;
      document.getElementById('editDieselExpenses').value = total.toFixed(2);
      calculateEditAmount();
    }

    function calculateEditAmount() {
      const billingAmount = parseFloat(document.getElementById('editBillingAmount').value) || 0;
      const advance = parseFloat(document.getElementById('editAdvance').value) || 0;
      const shortage = parseFloat(document.getElementById('editShortage').value) || 0;
      const cgstPercentage = parseFloat(document.getElementById('editCgstPercentage').value) || 0;
      const sgstPercentage = parseFloat(document.getElementById('editSgstPercentage').value) || 0;
      
      const cgstAmount = (billingAmount * cgstPercentage) / 100;
      const sgstAmount = (billingAmount * sgstPercentage) / 100;
      
      document.getElementById('editCgstAmount').value = cgstAmount.toFixed(2);
      document.getElementById('editSgstAmount').value = sgstAmount.toFixed(2);
      
      const totalAmount = billingAmount + cgstAmount + sgstAmount;
      document.getElementById('editTotalAmount').value = totalAmount.toFixed(2);
      
      // **FIX**: Use the dynamic billingRate from the edit form for shortage calculation.
      const currentEditBillingRate = parseFloat(document.getElementById('editBillingRate').value) || 0;
      const shortageDeduction = (shortage / 1000) * currentEditBillingRate;
      const balance = totalAmount - advance - shortageDeduction; 
      document.getElementById('editBalance').value = balance.toFixed(2);
    }

    // Toggle bank name field based on payment type
    function toggleBankNameField(paymentTypeId, containerId) {
      const paymentType = document.getElementById(paymentTypeId).value;
      const bankNameContainer = document.getElementById(containerId);
      
      if (paymentType === 'Bank Transfer') {
        bankNameContainer.style.display = 'block';
      } else {
        bankNameContainer.style.display = 'none';
        document.getElementById(containerId.replace('Container', '')).value = '';
      }
    }

    // Save LR to Firebase
    function saveLR() {
      const form = document.getElementById('lrForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const lrData = {
        date: document.getElementById('lrDate').value,
        lrNumber: document.getElementById('lrNumber').value,
        truckNumber: document.getElementById('truckNumber').value,
        clientId: document.getElementById('clientId').value,
        fromLocation: document.getElementById('fromLocation').value,
        toLocation: document.getElementById('toLocation').value,
        numPackages: parseFloat(document.getElementById('numPackages').value) || 0,
        weightPerPackage: parseFloat(document.getElementById('weightPerPackage').value) || 0,
        weight: parseFloat(document.getElementById('weight').value) || 0,
        consignee: document.getElementById('consignee').value,
        item: document.getElementById('item').value,
        shipmentNo: document.getElementById('shipmentNo').value,
        billingRate: parseFloat(document.getElementById('billingRate').value) || 0,
        billingAmount: parseFloat(document.getElementById('billingAmount').value) || 0,
        freightRate: parseFloat(document.getElementById('freightRate').value) || 0,
        freightAmount: parseFloat(document.getElementById('freightAmount').value) || 0,
        // --- TRIP EXPENSES - INCLUDING VEHICLE WORK ---
        tyreExpenses: parseFloat(document.getElementById('tyreExpenses').value) || 0,
        dieselPumpName: document.getElementById('dieselPumpName').value,
        dieselLiters: parseFloat(document.getElementById('dieselLiters').value) || 0,
        dieselPerLiter: parseFloat(document.getElementById('dieselPerLiter').value) || 0,
        dieselExpenses: parseFloat(document.getElementById('dieselExpenses').value) || 0,
        tollExpenses: parseFloat(document.getElementById('tollExpenses').value) || 0,
        vehicleWork: parseFloat(document.getElementById('vehicleWork').value) || 0, // Key field for vehicle work
        foodExpenses: parseFloat(document.getElementById('foodExpenses').value) || 0,
        otherExpenses: parseFloat(document.getElementById('otherExpenses').value) || 0,
        // ----------------------------------------------
        paymentType: document.getElementById('paymentType').value,
        bankName: document.getElementById('bankName').value,
        advance: parseFloat(document.getElementById('advance').value) || 0,
        shortage: parseFloat(document.getElementById('shortage').value) || 0,
        cgstPercentage: parseFloat(document.getElementById('cgstPercentage').value) || 0,
        cgstAmount: parseFloat(document.getElementById('cgstAmount').value) || 0,
        sgstPercentage: parseFloat(document.getElementById('sgstPercentage').value) || 0,
        sgstAmount: parseFloat(document.getElementById('sgstAmount').value) || 0,
        balance: parseFloat(document.getElementById('balance').value) || 0,
        totalAmount: parseFloat(document.getElementById('totalAmount').value) || 0,
        createdAt: new Date().toISOString(),
        status: 'active' // Set default status
      };

      // **FIX**: Use the `currentCoreAccountId` to save the LR report.
      // This ensures that LRs created by branch accounts are saved to the shared
      // data location, allowing the "Vehicle Work" tab in add.html to see them.
      if (!currentCoreAccountId) {
          alert('Error: Core account ID not found. Cannot save LR.');
          return;
      }
      const newLRRef = database.ref(`users/${currentCoreAccountId}/lrReports`).push();
      newLRRef.set(lrData)
        .then(() => {
          alert('LR saved successfully!');
          form.reset();
          generateLRNumber();
          document.getElementById('lrDate').value = new Date().toISOString().split('T')[0];
          loadLRData();
        })
        .catch((error) => {
          console.error('Error saving LR:', error);
          alert('Error saving LR. Please try again.');
        });
    }

    // Load LR Data
    function loadLRData() {
      const fromDate = document.getElementById('fromDate').value;
      const toDate = document.getElementById('toDate').value;
      const truckFilter = document.getElementById('truckFilter').value;
      const lrSearchTerm = document.getElementById('lrSearchInput').value.trim().toLowerCase();
      
      const user = auth.currentUser;
      if (!user) return;

      const lrRef = database.ref(`users/${currentCoreAccountId}/lrReports`);
      lrRef.on('value', (snapshot) => {
        const tbody = document.querySelector('#lrTable tbody');
        if ($.fn.DataTable.isDataTable('#lrTable')) { $('#lrTable').DataTable().clear(); } else { tbody.innerHTML = ''; }
        selectedLRs = [];
        
        snapshot.forEach((childSnapshot) => {
          const lr = childSnapshot.val();
          const lrId = childSnapshot.key;

          // **FIX**: Only show LRs that have not been invoiced.
          // This prevents already-invoiced LRs from appearing in the list.
          if (lr.status === 'invoiced') return; // Skip this LR if it's invoiced

          // Apply filters
          if (fromDate && lr.date < fromDate) return;
          if (toDate && lr.date > toDate) return;
          if (truckFilter && lr.truckNumber !== truckFilter) return;
          if (lrSearchTerm && !lr.lrNumber.toLowerCase().includes(lrSearchTerm)) return;
          
          // Find client name
          const client = allClients.find(c => c.id === lr.clientId) || {};
          
          $('#lrTable').DataTable().row.add([
            `<div class="form-check">
               <input class="form-check-input lr-checkbox" type="checkbox" value="${lrId}" onchange="toggleLRSelection('${lrId}', this.checked)">
             </div>`,
            lr.date,
            lr.lrNumber,
            lr.truckNumber,
            client.clientName || 'N/A',
            lr.consignee || client.clientName || 'N/A',
            lr.item || 'N/A',
            lr.fromLocation,
            lr.toLocation,
            lr.weight,
            `₹${lr.billingAmount || 0}`,
            `₹${(lr.freightAmount || 0).toFixed(2)}`,
            `<span class="badge bg-success">Completed</span>`,
            `<button class="btn btn-sm btn-outline-info" onclick="showLRCopy('${lrId}')" title="View LR Copy">
               <i class="fas fa-print"></i>
             </button>`,
            `<button class="btn btn-sm btn-outline-primary" onclick="editLR('${lrId}')">
               <i class="fas fa-edit"></i>
             </button>
             <button class="btn btn-sm btn-outline-danger" onclick="deleteLR('${lrId}')">
               <i class="fas fa-trash"></i>
             </button>`
          ]);
        });
        
        $('#lrTable').DataTable().draw();

        // Update generate invoice button state
        document.getElementById('generateInvoiceBtn').disabled = selectedLRs.length === 0;
      });
    }

    // Toggle LR selection
    function toggleLRSelection(lrId, isChecked) {
      if (isChecked) {
        selectedLRs.push(lrId);
      } else {
        selectedLRs = selectedLRs.filter(id => id !== lrId);
        document.getElementById('selectAllCheckbox').checked = false;
      }
      document.getElementById('generateInvoiceBtn').disabled = selectedLRs.length === 0;
    }

    // Toggle select all
    function toggleSelectAll() {
      const checkboxes = document.querySelectorAll('.lr-checkbox');
      const selectAll = document.getElementById('selectAllCheckbox').checked;
      
      selectedLRs = [];
      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll;
        if (selectAll) {
          selectedLRs.push(checkbox.value);
        }
      });
      
      document.getElementById('generateInvoiceBtn').disabled = selectedLRs.length === 0;
    }

    // Edit LR
    function editLR(lrId) {
      currentEditingLRId = lrId;
      // **FIX**: Use the globally available `currentCoreAccountId` to ensure
      // that LR reports can be fetched regardless of whether a core or branch
      // user is logged in. This was previously using `auth.currentUser.uid`,
      // which would fail for branch accounts.
      if (!currentCoreAccountId) {
        alert("Error: Cannot determine the account to fetch data from. Please reload.");
        return;
      }
      const lrRef = database.ref(`users/${currentCoreAccountId}/lrReports/${lrId}`);
      lrRef.once('value').then((snapshot) => {
        const lr = snapshot.val();
        
        // Populate edit form
        document.getElementById('editLrDate').value = lr.date;
        document.getElementById('editLrNumber').value = lr.lrNumber;
        document.getElementById('editTruckNumber').value = lr.truckNumber;
        document.getElementById('editClientId').value = lr.clientId;
        document.getElementById('editFromLocation').value = lr.fromLocation;
        document.getElementById('editToLocation').value = lr.toLocation;
        document.getElementById('editNumPackages').value = lr.numPackages || '';
        document.getElementById('editWeightPerPackage').value = lr.weightPerPackage || '';
        document.getElementById('editWeight').value = lr.weight;
        document.getElementById('editConsignee').value = lr.consignee || '';
        document.getElementById('editItem').value = lr.item || '';
        document.getElementById('editShipmentNo').value = lr.shipmentNo || '';
        document.getElementById('editBillingRate').value = lr.billingRate || '';
        document.getElementById('editBillingAmount').value = lr.billingAmount || '';
        document.getElementById('editFreightRate').value = lr.freightRate || '';
        document.getElementById('editFreightAmount').value = lr.freightAmount || '';
        
        // Populate expense fields
        document.getElementById('editTyreExpenses').value = lr.tyreExpenses || 0;
        document.getElementById('editDieselPumpName').value = lr.dieselPumpName || '';
        document.getElementById('editDieselLiters').value = lr.dieselLiters || '';
        document.getElementById('editDieselPerLiter').value = lr.dieselPerLiter || '';
        document.getElementById('editDieselExpenses').value = lr.dieselExpenses || '';
        document.getElementById('editTollExpenses').value = lr.tollExpenses || 0;
        document.getElementById('editVehicleWork').value = lr.vehicleWork || 0; // Key field for vehicle work
        document.getElementById('editFoodExpenses').value = lr.foodExpenses || 0;
        document.getElementById('editOtherExpenses').value = lr.otherExpenses || 0;
        
        document.getElementById('editPaymentType').value = lr.paymentType || '';
        document.getElementById('editBankName').value = lr.bankName || '';
        document.getElementById('editAdvance').value = lr.advance || 0;
        document.getElementById('editShortage').value = lr.shortage || 0;
        document.getElementById('editCgstPercentage').value = lr.cgstPercentage || 9;
        document.getElementById('editCgstAmount').value = lr.cgstAmount || 0;
        document.getElementById('editSgstPercentage').value = lr.sgstPercentage || 9;
        document.getElementById('editSgstAmount').value = lr.sgstAmount || 0;
        document.getElementById('editBalance').value = lr.balance || 0;
        document.getElementById('editTotalAmount').value = lr.totalAmount || 0;
        
        // Show/hide bank name field
        toggleBankNameField('editPaymentType', 'editBankNameContainer');
        
        // Show modal
        const editModal = new bootstrap.Modal(document.getElementById('editLRModal'));
        editModal.show();
      });
    }

    // Update LR
    function updateLR() {
      const form = document.getElementById('editLrForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const lrData = {
        date: document.getElementById('editLrDate').value,
        lrNumber: document.getElementById('editLrNumber').value,
        truckNumber: document.getElementById('editTruckNumber').value,
        clientId: document.getElementById('editClientId').value,
        fromLocation: document.getElementById('editFromLocation').value,
        toLocation: document.getElementById('editToLocation').value,
        numPackages: parseFloat(document.getElementById('editNumPackages').value) || 0,
        weightPerPackage: parseFloat(document.getElementById('editWeightPerPackage').value) || 0,
        weight: parseFloat(document.getElementById('editWeight').value) || 0,
        consignee: document.getElementById('editConsignee').value,
        item: document.getElementById('editItem').value,
        shipmentNo: document.getElementById('editShipmentNo').value,
        billingRate: parseFloat(document.getElementById('editBillingRate').value) || 0,
        billingAmount: parseFloat(document.getElementById('editBillingAmount').value) || 0,
        freightRate: parseFloat(document.getElementById('editFreightRate').value) || 0,
        freightAmount: parseFloat(document.getElementById('editFreightAmount').value) || 0,
        // --- TRIP EXPENSES - INCLUDING VEHICLE WORK ---
        tyreExpenses: parseFloat(document.getElementById('editTyreExpenses').value) || 0,
        dieselPumpName: document.getElementById('editDieselPumpName').value,
        dieselLiters: parseFloat(document.getElementById('editDieselLiters').value) || 0,
        dieselPerLiter: parseFloat(document.getElementById('editDieselPerLiter').value) || 0,
        dieselExpenses: parseFloat(document.getElementById('editDieselExpenses').value) || 0,
        tollExpenses: parseFloat(document.getElementById('editTollExpenses').value) || 0,
        vehicleWork: parseFloat(document.getElementById('editVehicleWork').value) || 0, // Key field for vehicle work
        foodExpenses: parseFloat(document.getElementById('editFoodExpenses').value) || 0,
        otherExpenses: parseFloat(document.getElementById('editOtherExpenses').value) || 0,
        // ----------------------------------------------
        paymentType: document.getElementById('editPaymentType').value,
        bankName: document.getElementById('editBankName').value,
        advance: parseFloat(document.getElementById('editAdvance').value) || 0,
        shortage: parseFloat(document.getElementById('editShortage').value) || 0,
        cgstPercentage: parseFloat(document.getElementById('editCgstPercentage').value) || 0,
        cgstAmount: parseFloat(document.getElementById('editCgstAmount').value) || 0,
        sgstPercentage: parseFloat(document.getElementById('editSgstPercentage').value) || 0,
        sgstAmount: parseFloat(document.getElementById('editSgstAmount').value) || 0,
        balance: parseFloat(document.getElementById('editBalance').value) || 0,
        totalAmount: parseFloat(document.getElementById('editTotalAmount').value) || 0,
        updatedAt: new Date().toISOString()
      };

      // **FIX**: Use the `currentCoreAccountId` to update the LR report.
      // This ensures that updates made by any user (core or branch) are saved
      // to the correct shared data location, making the change visible across the app.
      if (!currentCoreAccountId) {
          alert('Error: Core account ID not found. Cannot update LR.');
          return;
      }
      database.ref(`users/${currentCoreAccountId}/lrReports/${currentEditingLRId}`).update(lrData)
        .then(() => {
          alert('LR updated successfully!');
          const editModal = bootstrap.Modal.getInstance(document.getElementById('editLRModal'));
          editModal.hide();
          loadLRData();
        })
        .catch((error) => {
          console.error('Error updating LR:', error);
          alert('Error updating LR. Please try again.');
        });
    }

    // Delete LR
    function deleteLR(lrId) {
      if (confirm('Are you sure you want to delete this LR?')) {
        database.ref(`users/${currentCoreAccountId}/lrReports/${lrId}`).remove()
          .then(() => {
            alert('LR deleted successfully!');
            loadLRData();
          })
          .catch((error) => {
            console.error('Error deleting LR:', error);
            alert('Error deleting LR. Please try again.');
          });
      }
    }

    // Show bank details modal
    async function showBankDetailsModal() {
      if (selectedLRs.length === 0) {
        alert('Please select at least one LR to generate invoice.');
        return;
      }

      // **FIX**: Check if all selected LRs belong to the same client before proceeding.
      try {
        let firstClientId = null;
        let allSameClient = true;

        // Create promises to fetch all selected LR data at once.
        const promises = selectedLRs.map(lrId => 
          database.ref(`users/${currentCoreAccountId}/lrReports/${lrId}`).once('value')
        );

        const snapshots = await Promise.all(promises);

        for (const snapshot of snapshots) {
          if (snapshot.exists()) {
            const lr = snapshot.val();
            if (firstClientId === null) {
              firstClientId = lr.clientId; // Set the client ID from the first LR.
            } else if (lr.clientId !== firstClientId) {
              allSameClient = false; // Found an LR with a different client.
              break;
            }
          }
        }

        if (!allSameClient) {
          alert('Invoice generation failed: All selected LRs must belong to the same consignor.');
          return;
        }

        // If all checks pass, show the bank details modal.
        const bankModal = new bootstrap.Modal(document.getElementById('bankDetailsModal'));
        bankModal.show();
      } catch (error) {
        console.error("Error validating LRs for invoice generation:", error);
        alert("An error occurred while validating the selected LRs. Please try again.");
      }
    }

    // Create and save invoice
    function createAndSaveInvoice() {
      const bankForm = document.getElementById('bankDetailsForm');
      if (!bankForm.checkValidity()) {
        bankForm.reportValidity();
        return;
      }

      // Get company and bank details
      const companyDetails = {
        name: document.getElementById('inputCompanyName').value,
        address: document.getElementById('inputCompanyAddress').value,
        gstNumber: document.getElementById('inputGstNumber').value,
        phone: document.getElementById('inputCompanyPhone').value
      };

      const bankDetails = {
        bankName: document.getElementById('inputBankName').value,
        accountHolder: document.getElementById('inputAccountHolder').value,
        accountNumber: document.getElementById('inputAccountNumber').value,
        ifscCode: document.getElementById('inputIfscCode').value,
        accountType: document.getElementById('inputAccountType').value
      };

      // Generate invoice number
      const now = new Date();
      const invoiceNumber = `INV-${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}-${Math.floor(1000 + Math.random() * 9000)}`;

      // Fetch selected LR data
      const invoiceItems = [];
      let subtotal = 0;
      let totalCgst = 0;
      let totalSgst = 0;
      let firstClientId = null; // To associate the invoice with a client

      const promises = selectedLRs.map(lrId => {
        // **FIX**: Use the correct `currentCoreAccountId` to fetch LR data,
        // ensuring it works for both core and branch accounts.
        return database.ref(`users/${currentCoreAccountId}/lrReports/${lrId}`).once('value').then(snapshot => {
          const lr = snapshot.val();
          // **FIX**: Add a check to ensure the LR data exists before processing it.
          if (!lr) {
            console.warn(`Could not find LR data for ID: ${lrId}. Skipping.`);
            return; // Skip this LR if it's not found
          }
          const client = allClients.find(c => c.id === lr.clientId) || {};
          
          invoiceItems.push({
            date: lr.date,
            lrNumber: lr.lrNumber,
            truckNumber: lr.truckNumber,
            consignor: client.clientName || 'N/A',
            consignee: lr.consignee || client.clientName || 'N/A',
            from: lr.fromLocation,
            to: lr.toLocation,
            weight: lr.weight,
            rate: lr.billingRate || 0,
            gstPercentage: (lr.cgstPercentage || 0) + (lr.sgstPercentage || 0),
            gstAmount: (lr.cgstAmount || 0) + (lr.sgstAmount || 0),
            amount: lr.billingAmount || 0,
          });
          if (!firstClientId) firstClientId = lr.clientId;
          
          subtotal += lr.billingAmount || 0;
          totalCgst += lr.cgstAmount || 0;
          totalSgst += lr.sgstAmount || 0;
        });
      });

      Promise.all(promises).then(() => {
        const grandTotal = subtotal + totalCgst + totalSgst;

        const user = auth.currentUser;

        // Save invoice to database
        const invoiceData = {
          invoiceNumber: invoiceNumber,
          date: now.toISOString().split('T')[0],
          companyDetails: companyDetails,
          bankDetails: bankDetails,
          lrEntries: selectedLRs,
          items: invoiceItems,
          subtotal: subtotal,
          cgstAmount: totalCgst,
          sgstAmount: totalSgst,
          grandTotal: grandTotal,
          createdAt: new Date().toISOString(),
          userId: user.uid,
          clientId: firstClientId
        };

        // **FIX**: Use a multi-path update to save the invoice and update LRs atomically.
        // Also, use `currentCoreAccountId` to ensure LRs are updated in the shared data location,
        // which is critical for branch accounts.
        const updates = {};
        const dataRoot = currentCoreAccountId || user.uid;
        const newInvoiceKey = database.ref(`users/${dataRoot}/invoices`).push().key;
        
        // 1. Add the new invoice to the updates object.
        updates[`/users/${dataRoot}/invoices/${newInvoiceKey}`] = invoiceData;

        // 2. Update the status of each selected LR.
        selectedLRs.forEach(lrId => {
          updates[`/users/${dataRoot}/lrReports/${lrId}/status`] = 'invoiced';
          updates[`/users/${dataRoot}/lrReports/${lrId}/invoiceId`] = newInvoiceKey;
        });

        // 3. Execute the atomic update.
        database.ref().update(updates)
          .then(() => {
            const bankModal = bootstrap.Modal.getInstance(document.getElementById('bankDetailsModal'));
            bankModal.hide();
            window.location.href = `invoice.html?view=${newInvoiceKey}`;
          })
          .catch(error => {
            console.error('Error saving invoice:', error);
            alert('Error saving invoice. Please try again.');
          });
      });
    }

    // Show invoice preview
    function showInvoicePreview(invoiceData) {
      // Populate invoice content
      document.getElementById('companyName').textContent = invoiceData.companyDetails.name;
      document.getElementById('companyAddress').textContent = invoiceData.companyDetails.address;
      document.getElementById('companyGst').textContent = `GST: ${invoiceData.companyDetails.gstNumber}`;
      document.getElementById('invoiceNumber').textContent = invoiceData.invoiceNumber;
      document.getElementById('invoiceDate').textContent = new Date(invoiceData.date).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
      
      document.getElementById('invoiceBankName').textContent = invoiceData.bankDetails.bankName;
      document.getElementById('invoiceAccountNumber').textContent = invoiceData.bankDetails.accountNumber;
      document.getElementById('invoiceAccountHolder').textContent = invoiceData.bankDetails.accountHolder;
      document.getElementById('invoiceIfscCode').textContent = invoiceData.bankDetails.ifscCode;
      document.getElementById('invoiceAccountType').textContent = invoiceData.bankDetails.accountType;
      document.getElementById('companyNameFooter').textContent = invoiceData.companyDetails.name;

      // Populate invoice items
      const invoiceItems = document.getElementById('invoiceItems');
      invoiceItems.innerHTML = '';
      
      invoiceData.items.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.date}</td>
          <td>${item.lrNumber}</td>
          <td>${item.truckNumber}</td>
          <td>${item.consignor}</td>
          <td>${item.consignee}</td>
          <td>${item.from}</td>
          <td>${item.to}</td>
          <td class="text-end">${item.weight}</td>
          <td class="text-end">₹${item.rate.toFixed(2)}</td>
          <td class="text-end">${item.gstPercentage}%</td>
          <td class="text-end">₹${item.gstAmount.toFixed(2)}</td>
          <td class="text-end">₹${item.amount.toFixed(2)}</td>
        `;
        invoiceItems.appendChild(row);
      });

      // Update totals
      document.getElementById('subtotalAmount').textContent = `₹${invoiceData.subtotal.toFixed(2)}`;
      document.getElementById('invoiceCgstAmount').textContent = `₹${invoiceData.cgstAmount.toFixed(2)}`;
      document.getElementById('invoiceSgstAmount').textContent = `₹${invoiceData.sgstAmount.toFixed(2)}`;
      document.getElementById('grandTotal').textContent = `₹${invoiceData.grandTotal.toFixed(2)}`;

      // Amount in words
      document.getElementById('amountInWords').textContent = convertNumberToWords(invoiceData.grandTotal);

      // Show invoice modal
      const invoiceModal = new bootstrap.Modal(document.getElementById('invoiceModal'));
      invoiceModal.show();
    }

    // Print invoice
    function printInvoice() {
      const printContent = document.getElementById('printableInvoice').innerHTML;
      const originalContent = document.body.innerHTML;
      
      document.body.innerHTML = printContent;
      window.print();
      document.body.innerHTML = originalContent;
      
      // Reload the page to restore functionality
      window.location.reload();
    }

    // Convert number to words (Indian numbering system)
    function convertNumberToWords(num) {
      const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
      const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
      
      if (num === 0) return 'Zero Rupees';
      
      let words = '';
      
      // Handle rupees part
      let rupees = Math.floor(num);
      
      if (rupees >= 10000000) {
        words += convertNumberToWords(Math.floor(rupees / 10000000)) + ' Crore ';
        rupees %= 10000000;
      }
      
      if (rupees >= 100000) {
        words += convertNumberToWords(Math.floor(rupees / 100000)) + ' Lakh ';
        rupees %= 100000;
      }
      
      if (rupees >= 1000) {
        words += convertNumberToWords(Math.floor(rupees / 1000)) + ' Thousand ';
        rupees %= 1000;
      }
      
      if (rupees >= 100) {
        words += convertNumberToWords(Math.floor(rupees / 100)) + ' Hundred ';
        rupees %= 100;
      }
      
      if (rupees > 0) {
        if (words !== '') words += 'and ';
        
        if (rupees < 20) {
          words += ones[rupees];
        } else {
          words += tens[Math.floor(rupees / 10)];
          if (rupees % 10 > 0) {
            words += ' ' + ones[rupees % 10];
          }
        }
      }
      
      words += ' Rupees';
      
      // Handle paise part
      const paise = Math.round((num - Math.floor(num)) * 100);
      if (paise > 0) {
        words += ' and ';
        if (paise < 20) {
          words += ones[paise];
        } else {
          words += tens[Math.floor(paise / 10)];
          if (paise % 10 > 0) {
            words += ' ' + ones[paise % 10];
          }
        }
        words += ' Paise';
      }
      
      return words + ' Only';
    }

    // Export to PDF
    document.getElementById('exportPdfBtn').addEventListener('click', function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l', 'mm', 'a4');
      
      // Add content to PDF
      doc.text('LR Report', 10, 10);
      // Add more content as needed...
      
      doc.save('lr-report.pdf');
    });
  </script>
</body>
</html> 
