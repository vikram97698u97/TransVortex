<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LR Management - Transport System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <style>
    body { padding-top: 80px; background: #f5f5f5; }
    .navbar { background: #2E8B57; padding: 10px 20px; position: fixed; top: 0; width: 100%; z-index: 1000; }
    .logo { height: 40px; }
    .nav-links { display: flex; gap: 15px; list-style: none; margin: 0; padding: 0; }
    .nav-links a { color: white; text-decoration: none; }
    .nav-links a.active { font-weight: bold; }
    .tab-content { background: white; padding: 20px; border-radius: 0 0 8px 8px; }
    .hamburger { display: none; color: white; font-size: 1.5em; background: none; border: none; }
    @media (max-width: 768px) {
      .hamburger { display: block; }
      .nav-links { display: none; flex-direction: column; width: 100%; }
      .nav-links.show { display: flex; }
    }
  </style>
</head>
<body>
  <!-- Navbar will be loaded here -->
  <div id="navbar-container"></div>

  <div class="container">
    <h2 class="mb-4"><i class="fas fa-file-invoice me-2"></i>LR Management</h2>
    
    <!-- Tabs -->
    <ul class="nav nav-tabs" id="lrTabs">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#view">View Entries</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#add">Add New LR</a>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- View Tab -->
      <div class="tab-pane fade show active" id="view">
        <div class="row mb-3">
          <div class="col-md-3">
            <input type="date" class="form-control" id="fromDate">
          </div>
          <div class="col-md-3">
            <input type="date" class="form-control" id="toDate">
          </div>
          <div class="col-md-3">
            <select class="form-select" id="truckFilter">
              <option value="">All Trucks</option>
            </select>
          </div>
          <div class="col-md-3">
            <button class="btn btn-primary" id="applyFiltersBtn">Filter</button>
            <button class="btn btn-success" onclick="exportToPDF()">PDF</button>
          </div>
        </div>
        <div class="table-responsive">
          <table id="lrTable" class="table table-striped">
            <thead>
              <tr>
                <th>Date</th>
                <th>LR No</th>
                <th>Truck No</th>
                <th>Consignor</th>
                <th>Consignee</th>
                <th>Item</th>
                <th>From</th>
                <th>To</th>
                <th>Shipment No.</th>
                <th>Invoice No.</th>
                <th>Weight</th>
                <th>Billing Rate</th>
                <th>Billing Amount</th>
                <th>Freight Rate</th>
                <th>Freight Amount</th>
                <th>Payment Type</th>
                <th>Bank Name</th>
                <th>Shortage</th>
                <th>Other Expenses</th>
                <th>Diesel Cost</th>
                <th>Total Amount</th>
                <th>Actions</th>
              </tr>
            </thead>
          <tbody>
              <!-- Data will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Add Tab -->
      <div class="tab-pane fade" id="add">
        <form id="lrForm" onsubmit="saveLR(event)">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Date</label>
              <input type="date" class="form-control" id="lrDate" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">LR Number</label>
              <input type="text" class="form-control" id="lrNumber" required>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Truck Number</label>
              <input type="text" class="form-control" id="truckNumber" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Consignor</label>
              <input type="text" class="form-control" id="consignor" required>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">From</label>
              <input type="text" class="form-control" id="fromLocation" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">To</label>
              <input type="text" class="form-control" id="toLocation" required>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Weight (tonne)</label>
              <input type="number" class="form-control" id="weight" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Consignee</label>
              <input type="text" class="form-control" id="consignee" placeholder="Enter Consignee">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Item</label>
              <input type="text" class="form-control" id="item" placeholder="Enter Item">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Shipment No.</label>
              <input type="text" class="form-control" id="shipmentNo" placeholder="Enter Shipment Number">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Invoice No.</label>
              <input type="text" class="form-control" id="invoiceNo" placeholder="Enter Invoice Number">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Billing Rate (₹/tonne)</label>
              <input type="number" step="0.01" class="form-control" id="billingRate" placeholder="Enter Billing Rate" oninput="calculateBillingAmount()">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Billing Amount (₹)</label>
              <input type="number" class="form-control" id="billingAmount" placeholder="Enter Billing Amount" oninput="calculateAmount()">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Freight Rate (₹/tonne)</label>
              <input type="number" step="0.01" class="form-control" id="freightRate" placeholder="Enter Freight Rate" oninput="calculateFreightAmount()">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Freight Amount (₹)</label>
              <input type="number" class="form-control" id="freightAmount" placeholder="Enter Freight Amount" oninput="calculateFreightRate(); calculateAmount();">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Payment Type</label>
              <input type="text" class="form-control" id="paymentType" placeholder="Cash / Credit">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Bank Name</label>
              <input type="text" class="form-control" id="bankName" placeholder="Enter Bank Name">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Shortage (₹)</label>
              <input type="number" class="form-control" id="shortage" placeholder="Enter Shortage" oninput="calculateAmount()">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Other Expenses (₹)</label>
              <input type="number" class="form-control" id="otherExpenses" placeholder="Enter Other Expenses" oninput="calculateAmount()">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Diesel Cost (₹)</label>
              <input type="number" class="form-control" id="dieselCost" placeholder="Enter Diesel Cost" oninput="calculateAmount()">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Subtotal (Before GST) (₹)</label>
              <input type="number" class="form-control" id="subtotal" readonly>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">GST %</label>
              <input type="number" class="form-control" id="gstPercentage" value="15" onchange="calculateGST('add')">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">GST Amount (₹)</label>
              <input type="number" class="form-control" id="gstAmount" readonly>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Total Amount (₹)</label>
              <input type="number" class="form-control" id="totalAmount" readonly>
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Save LR</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="editLRModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit LR Record</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editLrForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Date</label>
                <input type="date" class="form-control" id="editLrDate" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">LR Number</label>
                <input type="text" class="form-control" id="editLrNumber" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Truck Number</label>
                <input type="text" class="form-control" id="editTruckNumber" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Consignor</label>
                <input type="text" class="form-control" id="editConsignor" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">From</label>
                <input type="text" class="form-control" id="editFromLocation" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">To</label>
                <input type="text" class="form-control" id="editToLocation" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Weight (tonne)</label>
                <input type="number" class="form-control" id="editWeight" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Consignee</label>
                <input type="text" class="form-control" id="editConsignee" placeholder="Enter Consignee">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Item</label>
                <input type="text" class="form-control" id="editItem" placeholder="Enter Item">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Shipment No.</label>
                <input type="text" class="form-control" id="editShipmentNo" placeholder="Enter Shipment Number">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Invoice No.</label>
                <input type="text" class="form-control" id="editInvoiceNo" placeholder="Enter Invoice Number">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Billing Rate (₹/tonne)</label>
                <input type="number" class="form-control" id="editBillingRate" placeholder="Enter Billing Rate" oninput="calculateBillingAmount('edit')">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Billing Amount (₹)</label>
                <input type="number" class="form-control" id="editBillingAmount" placeholder="Enter Billing Amount" oninput="calculateAmount('edit')">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Freight Rate (₹/tonne)</label>
                <input type="number" class="form-control" id="editFreightRate" placeholder="Enter Freight Rate" oninput="calculateFreightAmount('edit')">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Freight Amount (₹)</label>
                <input type="number" class="form-control" id="editFreightAmount" placeholder="Enter Freight Amount" oninput="calculateFreightRate('edit'); calculateAmount('edit');">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Payment Type</label>
                <input type="text" class="form-control" id="editPaymentType" placeholder="Cash / Credit">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Bank Name</label>
                <input type="text" class="form-control" id="editBankName" placeholder="Enter Bank Name">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Shortage (₹)</label>
                <input type="number" class="form-control" id="editShortage" placeholder="Enter Shortage" oninput="calculateAmount('edit')">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Other Expenses (₹)</label>
                <input type="number" class="form-control" id="editOtherExpenses" placeholder="Enter Other Expenses" oninput="calculateAmount('edit')">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Diesel Cost (₹)</label>
                <input type="number" class="form-control" id="editDieselCost" placeholder="Enter Diesel Cost" oninput="calculateAmount('edit')">
              </div>
            </div>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">GST %</label>
                <input type="number" class="form-control" id="editGstPercentage" value="15" onchange="calculateGST('edit')">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">GST Amount (₹)</label>
                <input type="number" class="form-control" id="editGstAmount" readonly>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Total Amount (₹)</label>
                <input type="number" class="form-control" id="editTotalAmount" readonly>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="saveEditBtn">Save changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    $(document).ready(function() {
      $("#navbar-container").load("navbar.html", function() {
        // Set active class on current page
        $("#navbar-container a[href='lr-management.html']").addClass('active');
      });
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  
  <!-- Global functions -->
  <script>
    // Function to safely get element value
    function getElementValue(id, prefix = '', isNumber = true) {
      const element = document.getElementById(`${prefix}${id}`);
      if (!element) return isNumber ? 0 : '';
      return isNumber ? (parseFloat(element.value) || 0) : element.value;
    }

    // Function to safely set element value
    function setElementValue(id, value, prefix = '') {
      const element = document.getElementById(`${prefix}${id}`);
      if (element) {
        element.value = typeof value === 'number' ? value.toFixed(2) : value;
      }
    }

    // Function to calculate billing amount based on weight and rate
    function calculateBillingAmount(mode = 'add') {
      try {
        const prefix = mode === 'edit' ? 'edit' : '';
        const weight = getElementValue('Weight', prefix);
        const billingRate = getElementValue('BillingRate', prefix);
        const billingAmount = weight * billingRate;
        setElementValue('BillingAmount', billingAmount, prefix);
        calculateAmount(mode);
      } catch (error) {
        console.error('Error in calculateBillingAmount:', error);
      }
    }

    // Function to calculate billing rate based on amount and weight
    function calculateBillingRate(mode = 'add') {
      try {
        const prefix = mode === 'edit' ? 'edit' : '';
        const weight = getElementValue('Weight', prefix);
        const billingAmount = getElementValue('BillingAmount', prefix);
        let billingRate = 0;
        
        if (weight > 0) {
          billingRate = billingAmount / weight;
        }
        
        setElementValue('BillingRate', billingRate, prefix);
        calculateAmount(mode);
      } catch (error) {
        console.error('Error in calculateBillingRate:', error);
      }
    }

    // Function to calculate freight amount based on weight and rate
    function calculateFreightAmount(mode = 'add') {
      try {
        const prefix = mode === 'edit' ? 'edit' : '';
        const weight = getElementValue('Weight', prefix);
        const freightRate = getElementValue('FreightRate', prefix);
        const freightAmount = weight * freightRate;
        setElementValue('FreightAmount', freightAmount, prefix);
        calculateAmount(mode);
      } catch (error) {
        console.error('Error in calculateFreightAmount:', error);
      }
    }

    // Function to calculate freight rate based on amount and weight
    function calculateFreightRate(mode = 'add') {
      try {
        const prefix = mode === 'edit' ? 'edit' : '';
        const weight = getElementValue('Weight', prefix);
        const freightAmount = getElementValue('FreightAmount', prefix);
        let freightRate = 0;
        
        if (weight > 0) {
          freightRate = freightAmount / weight;
        }
        
        setElementValue('FreightRate', freightRate, prefix);
        calculateAmount(mode);
      } catch (error) {
        console.error('Error in calculateFreightRate:', error);
      }
    }
    // Function to calculate amount based on the expression: billing amount + freight amount - shortage + other expenses + diesel cost
    window.calculateAmount = function(mode = 'add') {
      try {
        const prefix = mode === 'edit' ? 'edit' : '';
        const lcPrefix = prefix ? 'edit' : ''; // Lowercase prefix for field IDs
        
        // Get all input values, defaulting to 0 if empty
        const billingAmount = parseFloat(document.getElementById(`${lcPrefix}billingAmount`?.value) || 0);
        const freightAmount = parseFloat(document.getElementById(`${lcPrefix}freightAmount`?.value) || 0);
        const shortage = parseFloat(document.getElementById(`${lcPrefix}shortage`?.value) || 0);
        const otherExpenses = parseFloat(document.getElementById(`${lcPrefix}otherExpenses`?.value) || 0);
        const dieselCost = parseFloat(document.getElementById(`${lcPrefix}dieselCost`?.value) || 0);
        
        // Calculate total amount using the expression
        const subtotal = billingAmount + freightAmount - shortage + otherExpenses + dieselCost;
        
        // Update the subtotal field if it exists
        const subtotalField = document.getElementById(`${prefix}Subtotal`);
        if (subtotalField) {
          subtotalField.value = subtotal.toFixed(2);
        }
        
        // Trigger GST calculation
        setTimeout(() => calculateGST(mode), 10);
      } catch (error) {
        console.error('Error in calculateAmount:', error);
      }
    }
    
    // Function to calculate GST and total amount
    window.calculateGST = function(mode = 'add') {
      try {
        const prefix = mode === 'edit' ? 'edit' : '';
        const lcPrefix = prefix ? 'edit' : ''; // Lowercase prefix for field IDs
        
        // Get all amount fields with correct case sensitivity
        const billingAmount = parseFloat(document.getElementById(`${lcPrefix}billingAmount`)?.value || 0);
        const freightAmount = parseFloat(document.getElementById(`${lcPrefix}freightAmount`)?.value || 0);
        const shortage = parseFloat(document.getElementById(`${lcPrefix}shortage`)?.value || 0);
        const otherExpenses = parseFloat(document.getElementById(`${lcPrefix}otherExpenses`)?.value || 0);
        const dieselCost = parseFloat(document.getElementById(`${lcPrefix}dieselCost`)?.value || 0);
        
        // Calculate subtotal (sum of all amounts)
        const subtotal = billingAmount + freightAmount - shortage + otherExpenses + dieselCost;
        
        // Update subtotal field
        const subtotalField = document.getElementById(`${prefix}subtotal`);
        if (subtotalField) {
          subtotalField.value = subtotal.toFixed(2);
        }
        
        // Get GST percentage and calculate GST amount
        const gstPercentage = parseFloat(document.getElementById(`${prefix}gstPercentage`)?.value || 0);
        const gstAmount = (subtotal * gstPercentage) / 100;
        const totalAmount = subtotal + gstAmount;
        
        // Update GST amount field
        const gstAmountField = document.getElementById(`${prefix}gstAmount`);
        if (gstAmountField) {
          gstAmountField.value = gstAmount.toFixed(2);
        }
        
        // Update total amount field
        const totalAmountField = document.getElementById(`${prefix}totalAmount`);
        if (totalAmountField) {
          totalAmountField.value = totalAmount.toFixed(2);
        }
        
        return { 
          subtotal: parseFloat(subtotal.toFixed(2)), 
          gstPercentage: parseFloat(gstPercentage.toFixed(2)), 
          gstAmount: parseFloat(gstAmount.toFixed(2)), 
          totalAmount: parseFloat(totalAmount.toFixed(2)) 
        };
      } catch (error) {
        console.error('Error in calculateGST:', error);
        return { subtotal: 0, gstPercentage: 0, gstAmount: 0, totalAmount: 0 };
      }
    }
    
    // Function to calculate total amount by summing all amounts and adding GST
    window.calculateTotalAmount = function(formType = 'add') {
      try {
        const prefix = formType === 'edit' ? 'edit' : '';
        const lcPrefix = prefix ? 'edit' : ''; // Lowercase prefix for field IDs
        
        // Get all amount fields with correct case sensitivity
        const billingAmount = parseFloat(document.getElementById(`${lcPrefix}billingAmount`?.value) || 0);
        const freightAmount = parseFloat(document.getElementById(`${lcPrefix}freightAmount`?.value) || 0);
        const shortage = parseFloat(document.getElementById(`${lcPrefix}shortage`?.value) || 0);
        const otherExpenses = parseFloat(document.getElementById(`${lcPrefix}otherExpenses`?.value) || 0);
        const dieselCost = parseFloat(document.getElementById(`${lcPrefix}dieselCost`?.value) || 0);
        
        // Calculate subtotal (sum of all amounts)
        const subtotal = billingAmount + freightAmount - shortage + otherExpenses + dieselCost;
        
        // Calculate GST and total
        const gstPercentage = parseFloat(document.getElementById(`${lcPrefix}gstPercentage`?.value) || 0);
        const gstAmount = (subtotal * gstPercentage) / 100;
        const totalAmount = subtotal + gstAmount;
        
        // Update the UI
        const totalAmountField = document.getElementById(`${lcPrefix}totalAmount`);
        if (totalAmountField) {
          totalAmountField.value = totalAmount.toFixed(2);
        }
        
        return { subtotal, gstPercentage, gstAmount, totalAmount };
      } catch (error) {
        console.error('Error in calculateTotalAmount:', error);
        return { subtotal: 0, gstPercentage: 0, gstAmount: 0, totalAmount: 0 };
      }
    };
    
    // Format date for display
    window.formatDate = function(dateString) {
      if (!dateString) return '-';
      const options = { year: 'numeric', month: 'short', day: 'numeric' };
      return new Date(dateString).toLocaleDateString('en-US', options);
    };
    
    // Format cell content for PDF
    function formatCellContent(content) {
      if (!content) return '';
      // Remove any extra whitespace and newlines
      return content.toString().replace(/\s+/g, ' ').trim();
    }

    // Export data to PDF
    window.exportToPDF = function() {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
          orientation: 'landscape',
          unit: 'mm',
          format: 'a4',
          compress: true,
          precision: 16 // Higher precision for better layout
        });
        
        // Calculate table height and position
        const startY = 15; // Start table right after header
        const pageHeight = doc.internal.pageSize.height;
        const tableHeight = pageHeight - startY - 5; // Leave space for footer
        
        // Make startY available in the global scope for the autoTable callback
        window._currentPdfStartY = startY;
        
        // Use full page with minimal margins
        const pageWidth = doc.internal.pageSize.getWidth();
        const margin = 2; // Minimize margins
        const availableWidth = pageWidth - (margin * 2);
        
        // Add title with smaller font
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(10);  // Reduced from 12
        doc.text('LR Management Report', margin + 2, margin + 6);  // Moved up slightly
        
        // Add date with smaller font
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(6);  // Reduced from 7
        doc.text(`Generated: ${new Date().toLocaleString('en-US', {
          year: '2-digit',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          hour12: true
        })}`, margin + 2, margin + 9);  // Moved up and closer to title
        
        // Get table data
        const table = document.getElementById('lrTable');
        const headers = [];
        const rows = [];
        
        // Column configuration with reduced widths to fit all columns
        const columnConfig = [
          { key: 'date', width: 10, header: 'Date' },
          { key: 'lrNo', width: 10, header: 'LR No' },
          { key: 'truckNo', width: 12, header: 'Truck No' },
          { key: 'consignor', width: 16, header: 'Consignor' },
          { key: 'consignee', width: 16, header: 'Consignee' },
          { key: 'item', width: 12, header: 'Item' },
          { key: 'from', width: 12, header: 'From' },
          { key: 'to', width: 10, header: 'To' },
          { key: 'shipmentNo', width: 12, header: 'Shipment No' },
          { key: 'invoiceNo', width: 12, header: 'Invoice No' },
          { key: 'weight', width: 8, header: 'Weight', align: 'right' },
          { key: 'billingRate', width: 10, header: 'Billing Rt', align: 'right' },
          { key: 'billingAmount', width: 10, header: 'Bill Amt', align: 'right' },
          { key: 'freightRate', width: 10, header: 'Frt Rt', align: 'right' },
          { key: 'freightAmount', width: 10, header: 'Frt Amt', align: 'right' },
          { key: 'paymentType', width: 8, header: 'Pmt' },
          { key: 'bankName', width: 10, header: 'Bank' },
          { key: 'shortage', width: 8, header: 'Short', align: 'right' },
          { key: 'otherExpenses', width: 10, header: 'Exp', align: 'right' },
          { key: 'dieselCost', width: 8, header: 'Diesel', align: 'right' },
          { key: 'totalAmount', width: 10, header: 'Total', align: 'right' }
        ];
        
        // Calculate total width needed
        const totalConfiguredWidth = columnConfig.reduce((sum, col) => sum + col.width, 0);
        const scaleFactor = availableWidth / totalConfiguredWidth;
        
        // Prepare headers with dynamic widths
        columnConfig.forEach((col, index) => {
          headers.push({
            content: col.header,
            styles: { 
              fontStyle: 'bold',
              fillColor: [46, 139, 87],
              textColor: 255,
              fontSize: 6,
              cellPadding: 0.5,
              lineWidth: 0.05,
              cellWidth: col.width * scaleFactor,
              halign: col.align || 'left'
            }
          });
        });
        
        // Get rows with proper formatting
        table.querySelectorAll('tbody tr').forEach((tr) => {
          const row = [];
          tr.querySelectorAll('td:not(:last-child)').forEach((td, index) => {
            if (index < columnConfig.length) {
              const config = columnConfig[index];
              let cellContent = formatCellContent(td.textContent);
              
              // Format numbers if needed
              if (config.align === 'right' && !isNaN(parseFloat(cellContent))) {
                cellContent = parseFloat(cellContent).toFixed(2);
              } else if (cellContent.length > 15) {
                cellContent = cellContent.substring(0, 12) + '...';
              }
              
              row.push({
                content: cellContent,
                styles: { 
                  fontSize: 5.5,
                  cellPadding: 0.5,
                  lineWidth: 0.05,
                  cellWidth: config.width * scaleFactor,
                  halign: config.align || 'left',
                  valign: 'middle',
                  fontStyle: config.align === 'middle' ? 'bold' : 'normal'
                }
              });
            }
          });
          if (row.length > 0) {
            rows.push(row);
          }
        });
        
        // Generate column styles
        const columnStyles = {};
        columnConfig.forEach((col, index) => {
          columnStyles[index] = { 
            cellWidth: col.width * scaleFactor,
            halign: col.align || 'left'
          };
        });
        
        // Add table to PDF with full page width
        doc.autoTable({
          head: [headers],
          body: rows,
          startY: window._currentPdfStartY || 20,
          margin: { 
            left: margin,
            right: margin,
            top: window._currentPdfStartY || 20,
            bottom: 5
          },
          tableWidth: availableWidth,
          styles: {
            fontSize: 5,  // Reduced from 6
            cellPadding: 0.3,  // Reduced from 0.5
            lineWidth: 0.05,  // Thinner lines
            lineColor: [200, 200, 200],
            textColor: [0, 0, 0],
            overflow: 'linebreak',
            minCellHeight: 3,  // Reduced from 4
            halign: 'left',
            valign: 'middle',
            font: 'helvetica',
            fontStyle: 'normal',
            cellWidth: 'wrap',
            fillColor: [255, 255, 255]
          },
          headStyles: {
            fillColor: [46, 139, 87],
            textColor: 255,
            fontStyle: 'bold',
            fontSize: 5.5,  // Slightly larger than body but still small
            lineWidth: 0.05,
            cellPadding: 0.5,  // Reduced from 1
            halign: 'center',
            valign: 'middle',
            textColor: [255, 255, 255]
          },
          bodyStyles: {
            lineWidth: 0.05,  // Thinner lines
            lineColor: [220, 220, 220],
            fontSize: 5  // Ensure body text is small
          },
          alternateRowStyles: {
            fillColor: [250, 250, 250]
          },
          columnStyles: columnStyles,
          tableWidth: 'wrap',
          margin: { top: 5, right: 2, bottom: 5, left: 2 },  // Reduced margins
          tableLineWidth: 0.05,  // Thinner grid lines
          theme: 'grid',
          showHead: 'firstPage',
          horizontalPageBreak: true,
          showFoot: 'lastPage',
          tableLineWidth: 0.1,
          tableLineColor: [200, 200, 200],
          didDrawPage: function(data) {
            // Footer with page number
            doc.setFontSize(6);
            doc.setTextColor(100);
            doc.text(
              'Page ' + data.pageNumber,
              margin,
              pageHeight - 3,
              { align: 'left' }
            );
            
            // Add total pages
            const pageCount = doc.internal.getNumberOfPages();
            if (pageCount > 1) {
              doc.text(
                `Page ${data.pageNumber} of ${pageCount}`,
                pageWidth - margin,
                pageHeight - 3,
                { align: 'right' }
              );
            }
          },
          willDrawCell: function(data) {
            // Ensure text fits in cells
            if (data.cell.text && data.cell.text.length > 0) {
              const maxLength = data.column.index < 10 ? 20 : 12; // Longer text for first 10 columns
              if (data.cell.text[0].length > maxLength) {
                data.cell.text[0] = data.cell.text[0].substring(0, maxLength - 3) + '...';
              }
            }
            
            // Highlight important numeric cells
            if (data.column.index >= 10 && data.cell.raw) { // For numeric columns
              const value = parseFloat(data.cell.raw);
              if (!isNaN(value)) {
                data.cell.styles.fontStyle = 'bold';
                if (value < 0) {
                  data.cell.styles.textColor = [255, 0, 0]; // Red for negative values
                }
              }
            }
          },
          // Ensure table takes full width
          tableWidth: availableWidth,
          // Add horizontal scrolling for very wide tables
          overflow: 'linebreak',
          // Optimize for better text fitting
          styles: {
            overflow: 'linebreak',
            lineWidth: 0.05,
            fontSize: 5.5,
            cellPadding: 0.5,
            minCellHeight: 4
          }
        });
        
        // Save the PDF with timestamp
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        doc.save(`LR_Report_${timestamp}.pdf`);
        
      } catch (error) {
        console.error('Error generating PDF:', error);
        alert('Error generating PDF. Please try again.');
      }
    };
  </script>
  
  <!-- Firebase and app logic -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDAlk_K8p8Of8Ne6Jpcl2QqXTtm95NgG7o",
      authDomain: "transport-dashboard-ad69a.firebaseapp.com",
      databaseURL: "https://transport-dashboard-ad69a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "transport-dashboard-ad69a",
      storageBucket: "transport-dashboard-ad69a.appspot.com",
      messagingSenderId: "526889676196",
      appId: "1:526889676196:web:66032c80a4aede690ae531"
    };

    // Initialize Firebase if not already initialized
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    
    // Initialize Firebase services
    const db = firebase.database();
    const auth = firebase.auth();
    
    // Helper function to get database reference
    function getDatabaseRef(path = '') {
      return db.ref(path);
    }
  </script>
  
  <script type="module">
    // Global variables
    let lrTable;
    let lrData = [];
    let currentEditId = null; // Track the ID of the LR being edited
    
    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      // Set today's date as default
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('lrDate').value = today;
      document.getElementById('fromDate').value = today;
      document.getElementById('toDate').value = today;
      
      // Initialize DataTable
      lrTable = $('#lrTable').DataTable({
        order: [[0, 'desc']],
        pageLength: 25,
        responsive: true,
        columns: [
          { data: 'date', render: formatDate },
          { data: 'lrNumber' },
          { data: 'truckNumber' },
          { data: 'consignor' },
          { data: 'consignee' },
          { data: 'item' },
          { data: 'fromLocation' },
          { data: 'toLocation' },
          { data: 'shipmentNo' },
          { data: 'invoiceNo' },
          { data: 'weight', render: (data) => data ? `${data} tonne` : '-' },
          { data: 'billingRate', render: (data) => data ? `₹${parseFloat(data).toFixed(2)}` : '-' },
          { data: 'billingAmount', render: (data) => data ? `₹${parseFloat(data).toFixed(2)}` : '-' },
          { data: 'freightRate', render: (data) => data ? `₹${parseFloat(data).toFixed(2)}` : '-' },
          { data: 'freightAmount', render: (data) => data ? `₹${parseFloat(data).toFixed(2)}` : '-' },
          { data: 'paymentType' },
          { data: 'bankName' },
          { data: 'shortage', render: (data) => data ? `₹${parseFloat(data).toFixed(2)}` : '-' },
          { data: 'otherExpenses', render: (data) => data ? `₹${parseFloat(data).toFixed(2)}` : '-' },
          { data: 'dieselCost', render: (data) => data ? `₹${parseFloat(data).toFixed(2)}` : '-' },
          { data: 'totalAmount', render: (data) => data ? `₹${parseFloat(data).toFixed(2)}` : '-', className: 'fw-bold' },
          {
            data: null,
            render: function(data, type, row) {
              return `
                <div class="btn-group">
                  <button class="btn btn-sm btn-primary" onclick="editLR('${row.id}')">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="deleteLR('${row.id}')">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>`;
            },
            orderable: false,
            searchable: false
          }
        ]
      });
      
      document.getElementById('applyFiltersBtn')?.addEventListener('click', applyFilters);
      
      // Load LR data
      loadLRData();
    });
    
    // Toggle mobile menu
    window.toggleMenu = function() {
      const navLinks = document.getElementById('navLinks');
      navLinks.classList.toggle('show');
    };
    
    // Logout function
    window.logout = function() {
      signOut(auth).then(() => {
        window.location.href = 'index.html';
      }).catch((error) => {
        console.error('Logout error:', error);
      });
    };
    
    // Load LR data from Firebase
    function loadLRData() {
      const lrRef = getDatabaseRef('lrReports');
      
      lrRef.on('value', (snapshot) => {
        lrData = [];
        const trucks = new Set();
        
        snapshot.forEach((child) => {
          const data = child.val();
          // Ensure all fields have default values
          const lrEntry = {
            id: child.key,
            date: data.date || '',
            lrNumber: data.lrNumber || '',
            truckNumber: data.truckNumber || '',
            consignor: data.consignor || '',
            consignee: data.consignee || '',
            item: data.item || '',
            fromLocation: data.fromLocation || '',
            toLocation: data.toLocation || '',
            shipmentNo: data.shipmentNo || '',
            invoiceNo: data.invoiceNo || '',
            weight: data.weight || 0,
            billingRate: data.billingRate || 0,
            billingAmount: data.billingAmount || 0,
            freightRate: data.freightRate || 0,
            freightAmount: data.freightAmount || 0,
            paymentType: data.paymentType || '',
            bankName: data.bankName || '',
            shortage: data.shortage || 0,
            otherExpenses: data.otherExpenses || 0,
            dieselCost: data.dieselCost || 0,
            totalAmount: data.totalAmount || data.amount || 0,
            status: data.status || 'active',
            createdAt: data.createdAt || new Date().toISOString(),
            updatedAt: data.updatedAt || new Date().toISOString()
          };
          
          lrData.push(lrEntry);
          if (lrEntry.truckNumber) {
            trucks.add(lrEntry.truckNumber);
          }
        });
        
        // Update truck filter dropdown
        updateTruckFilter(Array.from(trucks).sort());
        
        // Apply filters and update table
        applyFilters();
      });
    }
    
    // Update truck filter dropdown
    function updateTruckFilter(trucks) {
      const truckSelect = document.getElementById('truckFilter');
      if (!truckSelect) return;
      
      const currentValue = truckSelect.value;
      truckSelect.innerHTML = '<option value="">All Trucks</option>';
      
      trucks.forEach(truck => {
        const option = document.createElement('option');
        option.value = truck;
        option.textContent = truck;
        truckSelect.appendChild(option);
      });
      
      if (currentValue) {
        truckSelect.value = currentValue;
      }
    }
    
    // Apply filters to the table
    window.applyFilters = function() {
      const fromDate = document.getElementById('fromDate')?.value;
      const toDate = document.getElementById('toDate')?.value;
      const truckNumber = document.getElementById('truckFilter')?.value;
      
      let filteredData = [...lrData];
      
      // Apply date filter
      if (fromDate) {
        const from = new Date(fromDate);
        filteredData = filteredData.filter(item => {
          const itemDate = new Date(item.date);
          return itemDate >= from;
        });
      }
      
      if (toDate) {
        const to = new Date(toDate);
        to.setHours(23, 59, 59, 999); // End of the day
        filteredData = filteredData.filter(item => {
          const itemDate = new Date(item.date);
          return itemDate <= to;
        });
      }
      
      // Apply truck number filter
      if (truckNumber) {
        filteredData = filteredData.filter(item => item.truckNumber === truckNumber);
      }
      
      // Update table
      updateTable(filteredData);
    }
    
    // Update the table with filtered data
    function updateTable(data) {
      lrTable.clear().rows.add(data).draw();
    }
    
    // Save LR to Firebase
    window.saveLR = async function(e) {
      e.preventDefault();
      
      // Get form element
      const form = e.target;
      if (!form) {
        console.error('Form element not found');
        return;
      }
      
      // Get form elements safely
      const getFormValue = (id) => {
        const el = document.getElementById(id);
        return el ? el.value : '';
      };
      
      const getFormNumber = (id) => {
        const val = getFormValue(id);
        return val ? parseFloat(val) : 0;
      };
      
      // Calculate amounts before saving
      calculateAmount('add');
      const { gstPercentage, gstAmount, totalAmount } = calculateGST('add');
      
      // Get total amount from the form field to ensure we have the latest value
      const totalAmountField = document.getElementById('totalAmount');
      const totalAmountValue = totalAmountField ? parseFloat(totalAmountField.value) || 0 : 0;
      
      const lrData = {
        date: getFormValue('lrDate'),
        lrNumber: getFormValue('lrNumber'),
        truckNumber: getFormValue('truckNumber'),
        consignor: getFormValue('consignor'),
        consignee: getFormValue('consignee'),
        item: getFormValue('item'),
        fromLocation: getFormValue('fromLocation'),
        toLocation: getFormValue('toLocation'),
        shipmentNo: getFormValue('shipmentNo'),
        invoiceNo: getFormValue('invoiceNo'),
        weight: getFormNumber('weight'),
        billingRate: getFormNumber('billingRate'),
        billingAmount: getFormNumber('billingAmount'),
        freightRate: getFormNumber('freightRate'),
        freightAmount: getFormNumber('freightAmount'),
        paymentType: getFormValue('paymentType'),
        bankName: getFormValue('bankName'),
        shortage: getFormNumber('shortage'),
        otherExpenses: getFormNumber('otherExpenses'),
        dieselCost: getFormNumber('dieselCost'),
        gstPercentage: gstPercentage || 0,
        gstAmount: gstAmount || 0,
        totalAmount: totalAmount,
        status: 'active',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };

      try {
        const lrRef = getDatabaseRef('lrReports');
        await lrRef.push(lrData);
        
        // Reset form
        document.getElementById('lrForm').reset();
        
        // Show success message
        alert('LR saved successfully!');
        
        // Switch to view tab
        const triggerEl = document.querySelector('a[data-bs-toggle="tab"][href="#view"]');
        if (triggerEl) {
          const tab = new bootstrap.Tab(triggerEl);
          tab.show();
        }
        
      } catch (error) {
        console.error('Error saving LR:', error);
        alert('Error saving LR. Please try again.');
      }
    };
    
    // Edit LR
    // Function to open edit modal with LR data
    window.editLR = function(id) {
      currentEditId = id;
      const lr = lrData.find(item => item.id === id);
      
      if (!lr) return;
      
      // Populate the edit form with LR data
      document.getElementById('editLrDate').value = lr.date || '';
      document.getElementById('editLrNumber').value = lr.lrNumber || '';
      document.getElementById('editTruckNumber').value = lr.truckNumber || '';
      document.getElementById('editConsignor').value = lr.consignor || '';
      document.getElementById('editConsignee').value = lr.consignee || '';
      document.getElementById('editItem').value = lr.item || '';
      document.getElementById('editFromLocation').value = lr.fromLocation || '';
      document.getElementById('editToLocation').value = lr.toLocation || '';
      document.getElementById('editShipmentNo').value = lr.shipmentNo || '';
      document.getElementById('editInvoiceNo').value = lr.invoiceNo || '';
      document.getElementById('editWeight').value = lr.weight || '';
      document.getElementById('editBillingRate').value = lr.billingRate || '';
      document.getElementById('editBillingAmount').value = lr.billingAmount || '';
      document.getElementById('editFreightRate').value = lr.freightRate || '';
      document.getElementById('editFreightAmount').value = lr.freightAmount || '';
      document.getElementById('editPaymentType').value = lr.paymentType || '';
      document.getElementById('editBankName').value = lr.bankName || '';
      document.getElementById('editShortage').value = lr.shortage || '';
      document.getElementById('editOtherExpenses').value = lr.otherExpenses || '';
      document.getElementById('editDieselCost').value = lr.dieselCost || '';
      document.getElementById('editGstPercentage').value = lr.gstPercentage || '15';
      
      // Show the modal
      const editModal = new bootstrap.Modal(document.getElementById('editLRModal'));
      editModal.show();
      
      // Trigger calculation after a small delay to ensure modal is fully shown
      setTimeout(() => {
        calculateAmount('edit');
        calculateGST('edit');
      }, 100);
    };
    
    // Save edited LR
    document.getElementById('saveEditBtn').addEventListener('click', async function() {
      if (!currentEditId) return;
      
      // Recalculate all amounts to ensure they're up to date
      calculateAmount('edit');
      const result = calculateGST('edit');
      
      // Get the total amount directly from the total amount field as a fallback
      const totalAmountField = document.getElementById('editTotalAmount');
      const calculatedTotal = result?.totalAmount || parseFloat(totalAmountField?.value) || 0;
      
      const lrData = {
        date: document.getElementById('editLrDate').value,
        lrNumber: document.getElementById('editLrNumber').value,
        truckNumber: document.getElementById('editTruckNumber').value,
        consignor: document.getElementById('editConsignor').value,
        consignee: document.getElementById('editConsignee').value,
        item: document.getElementById('editItem').value,
        fromLocation: document.getElementById('editFromLocation').value,
        toLocation: document.getElementById('editToLocation').value,
        shipmentNo: document.getElementById('editShipmentNo').value,
        invoiceNo: document.getElementById('editInvoiceNo').value,
        weight: parseFloat(document.getElementById('editWeight').value) || 0,
        billingRate: parseFloat(document.getElementById('editBillingRate').value) || 0,
        billingAmount: parseFloat(document.getElementById('editBillingAmount').value) || 0,
        freightRate: parseFloat(document.getElementById('editFreightRate').value) || 0,
        freightAmount: parseFloat(document.getElementById('editFreightAmount').value) || 0,
        paymentType: document.getElementById('editPaymentType').value,
        bankName: document.getElementById('editBankName').value,
        shortage: parseFloat(document.getElementById('editShortage').value) || 0,
        otherExpenses: parseFloat(document.getElementById('editOtherExpenses').value) || 0,
        dieselCost: parseFloat(document.getElementById('editDieselCost').value) || 0,
        gstPercentage: parseFloat(document.getElementById('editGstPercentage').value) || 0,
        gstAmount: result?.gstAmount || 0,
        totalAmount: calculatedTotal,
        status: 'active',
        updatedAt: new Date().toISOString()
      };
      
      // Ensure we have a valid total amount
      if (isNaN(lrData.totalAmount) || lrData.totalAmount <= 0) {
        // Recalculate total amount if it's not valid
        const subtotal = lrData.billingAmount + lrData.freightAmount - lrData.shortage + 
                        lrData.otherExpenses + lrData.dieselCost;
        lrData.gstAmount = (subtotal * lrData.gstPercentage) / 100;
        lrData.totalAmount = subtotal + lrData.gstAmount;
      }
      
      try {
        // Update the LR in Firebase
        const lrRef = getDatabaseRef(`lrReports/${currentEditId}`);
        await lrRef.update(lrData);
        
        // Hide the modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('editLRModal'));
        if (modal) modal.hide();
        
        // Show success message
        alert('LR updated successfully!');
        
      } catch (error) {
        console.error('Error updating LR:', error);
        alert('Error updating LR. Please try again.');
      }
    });
    
    // Delete LR
    window.deleteLR = function(id) {
      if (!confirm('Are you sure you want to delete this LR?')) return;
      
      const lrRef = ref(db, `lrReports/${id}`);
      set(lrRef, null)
        .then(() => {
          alert('LR deleted successfully!');
        })
        .catch((error) => {
          console.error('Error deleting LR:', error);
          alert('Error deleting LR. Please try again.');
        });
    };
    
    // Initialize modal event listeners
    document.addEventListener('DOMContentLoaded', function() {
      const editModal = document.getElementById('editLRModal');
      if (editModal) {
        editModal.addEventListener('hidden.bs.modal', function () {
          currentEditId = null;
          document.getElementById('editLrForm')?.reset();
        });
      }
      
      // Load LR data when the page loads
      loadLRData();
    });
    
    // Make functions available globally
    window.calculateGST = calculateGST;
    window.calculateAmount = calculateAmount;
    window.calculateTotalAmount = calculateTotalAmount;
  </script>
  <script>
    // Initialize calculation when the page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Trigger initial calculation after a small delay to ensure all elements are loaded
      setTimeout(() => {
        calculateAmount();
        calculateGST();
      }, 500);
    });
  </script>
</body>
</html>
