<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LR Management - Transport System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <style>
    body { padding: 0; margin: 0; background-color: #f8f9fa; }
    .tab-content { background: white; padding: 20px; border-radius: 0 0 8px 8px; }
    
    /* Vehicle Validation Styles */
    .vehicle-suggestions {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      width: calc(100% - 30px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .lr-copy-container {
      font-family: Arial, sans-serif;
      font-size: 14px;
      color: #333;
      padding: 20px;
      background: #ffffff;
      max-width: 800px;
      margin: 0 auto;
    }
    .lr-header {
      text-align: center;
      margin-bottom: 15px;
    }
    .lr-header h4 {
      margin: 0;
      font-size: 18px;
      font-weight: bold;
    }
    .lr-header p {
      margin: 5px 0 0 0;
    }
    .lr-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    .lr-info-left, .lr-info-right {
      width: 48%;
    }
    .lr-row {
      margin-bottom: 10px;
    }
    .lr-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    .lr-table th, .lr-table td {
      border: 1px solid #000;
      padding: 8px;
      text-align: left;
    }
    .lr-table th {
      background-color: #f2f2f2;
    }
    .safety-section {
      margin-top: 20px;
      border-top: 1px solid #ddd;
      padding-top: 10px;
    }
    .receipt-section {
      margin-top: 20px;
      border-top: 1px solid #ddd;
      padding-top: 10px;
    }
    .lr-footer {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
    }
    .signature-box {
      width: 45%;
      text-align: center;
    }
    .signature-line {
      margin-top: 50px;
      border-top: 1px solid #000;
    }
    .terms-conditions {
      margin-top: 25px;
      padding: 15px;
      font-size: 12px;
    }
    @media print {
      body {
        background-color: #ffffd9;
        padding: 0;
      }
      .lr-copy-container {
        box-shadow: none;
        max-width: 100%;
      }
      .no-print {
        display: none;
      }
      /* **NEW**: Hide elements based on print settings */
      .printable-area .logo-on-print.hidden-print { display: none !important; }
      .printable-area .stamp-on-print.hidden-print { display: none !important; }
    }
    /* **FIX**: Add rule for live view toggling */
    .hidden-print {
      display: none !important;
    }
    .lr-header-content {
      display: flex; align-items: center; justify-content: center; gap: 20px;
    }
    .terms-conditions h6 {
      margin-top: 0;
      color: #2c3e50;
    }
    .lr-barcode {
      text-align: center;
      margin: 20px 0;
      padding: 10px;
      border-top: 1px dashed #ccc;
      border-bottom: 1px dashed #ccc;
    }

    .vehicle-suggestion {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .vehicle-suggestion:hover {
      background-color: #f8f9fa;
    }

    .vehicle-suggestion:last-child {
      border-bottom: none;
    }

    .vehicle-not-found {
      color: #dc3545;
      font-size: 0.875em;
      margin-top: 5px;
      display: none;
    }

    .vehicle-input-container {
      position: relative;
    }

    .vehicle-valid {
      border-color: #28a745 !important;
    }

    .vehicle-invalid {
      border-color: #dc3545 !important;
    }

    /* Custom style for the client dropdown */
    #clientId {
      color: #2E8B57;
      font-weight: 500;
    }
    
    .lr-copy-container {
      font-family: Arial, sans-serif;
      font-size: 14px;
      color: #333;
      padding: 20px;
      background: #ffffff;
      max-width: 800px;
      margin: 0 auto;
    }

    /* Expense Entry Styling */
    .expense-entry-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e9ecef;
      padding: 10px;
      border-radius: 4px;
    }
    
    /* New Tab Styles for Trip Details Modal */
    .trip-details-nav .nav-link {
      color: #495057;
      font-weight: 600;
      border-bottom: 3px solid transparent;
      border-top-left-radius: .5rem;
      border-top-right-radius: .5rem;
    }
    .trip-details-nav .nav-link.active {
      color: #0d6efd;
      background-color: #e9ecef;
      border-color: #0d6efd;
    }
    .trip-details-tab-content {
      background-color: #f8f9fa;
      padding: 1.5rem;
      border: 1px solid #dee2e6;
      border-top: none;
      border-radius: 0 0 .5rem .5rem;
    }
    .expense-row {
      transition: all 0.3s ease-in-out;
    }

  </style>
</head>
<body>

  <div id="navbar-placeholder"></div>

  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="mb-0"><i class="fas fa-file-invoice me-2"></i>LR Management</h2>
      <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#autoGenerationSettingsModal">
        <i class="fas fa-cog me-2"></i>Settings
      </button>
    </div>
    
    <ul class="nav nav-tabs" id="lrTabs">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#view">View Entries</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#add">Add New LR</a>
      </li>
    </ul>

    <div class="tab-content">
      <div class="tab-pane fade show active" id="view">
        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label">From Date</label>
            <input type="date" class="form-control" id="fromDate">
          </div>
          <div class="col-md-3">
            <label class="form-label">To Date</label>
            <input type="date" class="form-control" id="toDate">
          </div>
          <div class="col-md-3">
            <label class="form-label">Truck Number</label>
            <select class="form-select" id="truckFilter">
              <option value="">All Trucks</option>
            </select>
          </div>
          <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-primary me-2" id="applyFiltersBtn">Filter</button>
            <button class="btn btn-success" id="exportPdfBtn">PDF</button>
          </div>
        </div>

        <!-- **NEW**: Tabs for Own vs Market LRs -->
        <ul class="nav nav-pills mb-3" id="lrViewTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="own-lrs-tab" data-bs-toggle="tab" data-bs-target="#own-lrs-content" type="button" role="tab">Own Company LRs</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="market-lrs-tab" data-bs-toggle="tab" data-bs-target="#market-lrs-content" type="button" role="tab">Market company LRs</button>
          </li>
        </ul>

        <div class="tab-content" id="lrViewTabsContent">
          <!-- Own Vehicle LRs Content -->
          <div class="tab-pane fade show active" id="own-lrs-content" role="tabpanel">
            <div class="mb-3">
              <button class="btn btn-primary" id="generateInvoiceBtn" onclick="showBankDetailsModal()" disabled>
                <i class="fas fa-file-invoice me-2"></i>Generate Client Invoice
              </button>
            </div>
            <div class="table-responsive">
              <table id="lrTable" class="table table-striped">
                <!-- Existing table structure -->
                <thead>
                  <tr>
                    <th>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAllCheckbox" onclick="toggleSelectAll()">
                      </div>
                    </th>
                    <th>Date</th>
                    <th>LR No</th>
                    <th>Truck No</th>
                    <th>Consignor</th>
                    <th>Consignee</th>
                    <th>Item</th>
                    <th>From</th>
                    <th>To</th>
                    <th>Weight</th>
                    <th><i class="fas fa-plus"></i> Details</th>
                    <th>Status</th>
                    <th>LR Copy</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  </tbody>
              </table>
            </div>
          </div>

          <!-- Market Vehicle LRs Content -->
          <div class="tab-pane fade" id="market-lrs-content" role="tabpanel">
            <div class="mb-3">
              <button class="btn btn-info" id="generateMarketInvoiceBtn" onclick="showBankDetailsModal(true)" disabled>
                <i class="fas fa-file-invoice me-2"></i>Generate Market Invoice
              </button>
            </div>
            <div class="table-responsive">
              <table id="marketLrTable" class="table table-striped">
                <thead>
                  <tr>
                    <th>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAllMarketCheckbox" onclick="toggleSelectAll(true)">
                      </div>
                    </th>
                    <th>Date</th>
                    <th>LR No</th>
                    <th>Truck No</th>
                    <th>Market Company</th>
                    <th>Item</th>
                    <th>From</th>
                    <th>To</th>
                    <th>Weight</th>
                    <th><i class="fas fa-plus"></i> Details</th>
                    <th>Status</th>
                    <th>LR Copy</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  </tbody>
              </table>
            </div>
          </div>
        </div>
        <!-- Old table location removed -->
        <!-- <div class="table-responsive">
          <table id="lrTable" class="table table-striped">
            <thead>
              <tr>
                <th>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="selectAllCheckbox" onclick="toggleSelectAll()">
                  </div>
                </th>
                <th>Date</th>
                <th>LR No</th>
                <th>Truck No</th>
                <th>Consignor</th>
                <th>Consignee</th>
                <th>Item</th>
                <th>From</th>
                <th>To</th>
                <th>Weight</th>
                <th><i class="fas fa-plus"></i> Details</th>
                <th>Status</th>
                <th>LR Copy</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              </tbody>
          </table>
        </div> -->
      </div>

      <div class="tab-pane fade" id="add">
        <form id="lrForm">
          <div class="card mb-4">
            <div class="card-header bg-light">
              <h5 class="mb-0"><i class="fas fa-file-invoice me-2"></i>Basic LR Information</h5>
            </div>
            <div class="card-body">
              <div class="row mb-3">
                <div class="col-md-3">
                  <label for="lrDate" class="form-label">Date <span class="text-danger">*</span></label>
                  <input type="date" class="form-control" id="lrDate" required />
                </div>
                <div class="col-md-3">
                  <label for="lrNumber" class="form-label">LR Number <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="lrNumber" required />
                </div>
                <div class="col-md-3">
                  <label for="invoiceNumberInput" class="form-label">Invoice No.</label>
                  <input type="text" class="form-control" id="invoiceNumberInput" placeholder="Auto-generated" />
                </div>
                <div class="col-md-3">
                  <label for="shipmentNo" class="form-label">Shipment No.</label>
                  <input type="text" class="form-control" id="shipmentNo" placeholder="Auto-generated" />
                </div>
              </div>
              <div class="row">
                <div class="col-md-4 mb-3">

                  <label class="form-label">Delivery No.</label>
                  <input type="text" class="form-control" id="deliveryNo" placeholder="Auto-generated">
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">Order No.</label>
                  <input type="text" class="form-control" id="orderNo" placeholder="Auto-generated">
                </div>
                <div class="col-md-4 mb-3 vehicle-input-container">
                  <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" role="switch" id="vehicleTypeToggle" onchange="toggleVehicleInput(this.checked)">
                    <label class="form-check-label" for="vehicleTypeToggle">Use Market Vehicle</label>
                  </div>
                  <div id="ownVehicleFields">
                    <label for="truckNumber" class="form-label">Own Truck Number <span class="text-danger">*</span></label>
                    <select id="truckNumber" class="form-select" required>
                      <option value="">Select a Truck</option>
                    </select>
                  </div>
                  <div id="marketVehicleFields" style="display: none;">
                    <label for="marketTruckNumber" class="form-label">Market Truck Number <span class="text-danger">*</span></label>
                    <input type="text" id="marketTruckNumber" class="form-control" placeholder="Enter vehicle number">
                  </div>
                  <div id="transporterField" style="display: block;">
                    <label for="transporterSelect" class="form-label mt-2">Transporter</label>
                    <select id="transporterSelect" class="form-select">
                      <option value="">Select a Transporter</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <div id="ownDriverField">
                    <label for="driverSelect" class="form-label">Driver</label>
                    <select id="driverSelect" class="form-select"><option value="">Select a Driver</option></select>
                  </div>
                  <div id="marketDriverField" style="display: none;">
                    <label for="marketDriverName" class="form-label">Driver Name (if not in list)</label>
                    <input type="text" id="marketDriverName" class="form-control" placeholder="Enter driver's name">
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="clientId" class="form-label">Billed To (Client) <span class="text-danger">*</span></label>
                  <select id="clientId" class="form-select" required onchange="window.updateConsigneeFromClient()">
                    <option value="">Select a Client</option>
                    </select>
                </div>
              </div>
              <div class="row">
                <div class="col-md-12 mb-3">
                  <label class="form-label">Route (From --> To) <span class="text-danger">*</span></label>
                  <select class="form-select" id="routeSelect" required>
                    <option value="">Select a Route</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div class="card mb-4">
            <div class="card-header bg-light">
              <h5 class="mb-0"><i class="fas fa-box me-2"></i>Shipment Details</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="consigneeId" class="form-label">Consignee <span class="text-danger">*</span></label>
                  <select id="consigneeId" class="form-select" required>
                    <option value="">Select a Consignee</option>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Item</label>
                  <input type="text" class="form-control" id="item">
                </div>
              </div>
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label class="form-label">Number of Packages</label>
                  <input type="number" class="form-control" id="numPackages" placeholder="For package goods" oninput="calculateWeightFromPackages()">
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">Weight per Package (kg)</label>
                  <input type="number" step="0.01" class="form-control" id="weightPerPackage" placeholder="e.g., 50" oninput="calculateWeightFromPackages()">
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">Weight (tonne) <span class="text-danger">*</span></label>
                  <input type="number" class="form-control" id="weight" step="0.01" required oninput="handleManualWeightInput()">
                </div>
              </div>
            </div>
          </div>
          
          <button type="button" class="btn btn-primary" id="saveLRBtn">Save LR</button>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="autoGenerationSettingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title"><i class="fas fa-cog me-2"></i>Auto-Generation Settings</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted">Toggle which numbers should be auto-generated by the system.</p>
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="autoGenerateLrNo" checked>
            <label class="form-check-label" for="autoGenerateLrNo">Auto-generate LR Number</label>
          </div>
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="autoGenerateInvoiceNo" checked>
            <label class="form-check-label" for="autoGenerateInvoiceNo">Auto-generate Invoice Number</label>
          </div>
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="autoGenerateShipmentNo" checked>
            <label class="form-check-label" for="autoGenerateShipmentNo">Auto-generate Shipment No.</label>
          </div>
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="autoGenerateOrderNo" checked>
            <label class="form-check-label" for="autoGenerateOrderNo">Auto-generate Order No.</label>
          </div>
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="autoGenerateDeliveryNo" checked>
            <label class="form-check-label" for="autoGenerateDeliveryNo">Auto-generate Delivery No.</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="saveAutoGenerationSettings()" data-bs-dismiss="modal">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="tripDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title"><i class="fas fa-file-invoice-dollar me-2"></i>Trip Financials for LR: <span id="modalLrNumber"></span></h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <ul class="nav nav-tabs trip-details-nav" id="tripDetailsTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="billing-tab" data-bs-toggle="tab" data-bs-target="#billing-content" type="button" role="tab">1. Billing & Freight</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="fuel-tab" data-bs-toggle="tab" data-bs-target="#fuel-content" type="button" role="tab">2. KM & Fuel Usage</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="fuel-entry-tab" data-bs-toggle="tab" data-bs-target="#fuel-entry-content" type="button" role="tab" onclick="loadFuelPumps()">3. Fuel Entry</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="expenses-tab" data-bs-toggle="tab" data-bs-target="#expenses-content" type="button" role="tab">4. Trip Expenses</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="empty-expenses-tab" data-bs-toggle="tab" data-bs-target="#empty-expenses-content" type="button" role="tab">5. Empty Trip Expenses</button>
            </li>
          </ul>

          <div class="tab-content trip-details-tab-content" id="tripDetailsTabsContent">
            <div class="tab-pane fade show active" id="billing-content" role="tabpanel">
              <div class="card">
                <div class="card-body">
                  <div class="row align-items-end">
                    <div class="col-md-3 mb-3">
                      <label class="form-label">Billing Rate (₹/tonne)</label>
                      <input type="number" step="0.01" class="form-control" id="tripBillingRate" oninput="calculateTripBillingAmount()">
                    </div>
                    <div class="col-md-3 mb-3">
                      <label class="form-label">Billing Amount (₹)</label>
                      <input type="number" step="0.01" class="form-control" id="tripBillingAmount" oninput="calculateTripBillingRate()">
                    </div>
                    <div class="col-md-3 mb-3">
                      <label class="form-label">Freight Rate (₹/tonne)</label>
                      <input type="number" step="0.01" class="form-control" id="tripFreightRate" oninput="calculateTripFreightAmount()">
                    </div>
                    <div class="col-md-3 mb-3">
                      <label class="form-label">Freight Amount (₹)</label>
                      <input type="number" step="0.01" class="form-control" id="tripFreightAmount" oninput="calculateTripFreightRate()">
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3" id="tripAdvanceField">
                      <label class="form-label">Driver Advance (₹)</label>
                      <input type="number" step="0.01" class="form-control" id="tripAdvance" value="0" oninput="calculateTripTotals()">
                    </div>
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Shortage (kg)</label>
                      <input type="number" step="0.01" class="form-control" id="tripShortage" value="0" placeholder="Shortage in kg">
                    </div>
                    <div class="col-md-6 mb-3" id="commissionField" style="display: none;">
                      <label class="form-label fw-bold text-success">Commission (₹)</label>
                      <input type="number" step="0.01" class="form-control" id="tripCommission" placeholder="Your commission from this trip">
                    </div>
                  </div>
                  <hr>
                  <div class="row">
                    <div class="col-md-4 mb-3">
                      <label class="form-label">CGST %</label>
                      <input type="number" step="0.01" class="form-control" id="tripCgstPercentage" value="9" oninput="calculateTripTotals()">
                    </div>
                    <div class="col-md-4 mb-3">
                      <label class="form-label">SGST %</label>
                      <input type="number" step="0.01" class="form-control" id="tripSgstPercentage" value="9" oninput="calculateTripTotals()">
                    </div>
                    <div class="col-md-4 mb-3">
                      <label class="form-label">Total Billing (Incl. GST)</label>
                      <input type="number" step="0.01" class="form-control bg-success-subtle" id="tripTotalBillingAmount" readonly>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-pane fade" id="fuel-content" role="tabpanel">
              <div class="card">
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-4 mb-3">
                      <label class="form-label">Starting KM</label>
                      <input type="number" min="0" class="form-control" id="tripStartingKm" oninput="calculateTotalKm()">
                    </div>
                    <div class="col-md-4 mb-3">
                      <label class="form-label">Ending KM</label>
                      <input type="number" min="0" class="form-control" id="tripEndingKm" oninput="calculateTotalKm()">
                    </div>
                    <div class="col-md-4 mb-3">
                      <label class="form-label">Total Distance (KM)</label>
                      <input type="number" class="form-control bg-light" id="tripTotalKm" readonly>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-4 mb-3">
                      <label class="form-label">Vehicle Avg (km/l)</label>
                      <input type="number" step="0.01" min="0" class="form-control" id="tripVehicleAverage" oninput="calculateFuelUsed()">
                    </div>
                    <div class="col-md-4 mb-3">
                      <label class="form-label">Fuel Used (Litres)</label>
                      <input type="number" step="0.01" min="0" class="form-control bg-light" id="tripFuelUsedLiters" readonly>
                    </div>
                    <div class="col-md-4 mb-3">
                      <label class="form-label">Fuel Rate (₹/L)</label>
                      <input type="number" step="0.01" min="0" class="form-control" id="tripDieselRatePerLiter" oninput="calculateFuelAmount()">
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="tab-pane fade" id="fuel-entry-content" role="tabpanel">
              <div class="card mb-3">
                <div class="card-body bg-light">
                  <div class="row">
                    <div class="col-md-6">
                      <h6 class="mb-0">Selected Truck: <strong id="fuelEntryTruckNumber">N/A</strong></h6>
                    </div>
                    <div class="col-md-6 text-end">
                      <h6 class="mb-0">Fuel in Tank: <strong id="currentFuelLevel" class="text-success">...</strong></h6>
                    </div>
                  </div>
                </div>
              </div>
              <form id="fuelEntryForm">
                <h5 class="mb-3">Record Fuel Fill-up (Adds to Inventory)</h5>
                <div class="row">
                  <div class="col-md-3 mb-3">
                    <label for="fuelPumpSelect" class="form-label">Select Pump <span class="text-danger">*</span></label>
                    <select id="fuelPumpSelect" class="form-select" required>
                      <option value="">Select a Pump</option>
                    </select>
                  </div>
                  <div class="col-md-3 mb-3">
                    <label for="fuelFillDate" class="form-label">Date <span class="text-danger">*</span></label>
                    <input type="date" id="fuelFillDate" class="form-control" required>
                  </div>
                  <div class="col-md-2 mb-3">
                    <label for="fuelLiters" class="form-label">Liters <span class="text-danger">*</span></label>
                    <input type="number" id="fuelLiters" class="form-control" placeholder="0.00" required step="0.01" oninput="calculateFuelTotalAmount()">
                  </div>
                  <div class="col-md-2 mb-3">
                    <label for="fuelPerLiter" class="form-label">₹/Liter <span class="text-danger">*</span></label>
                    <input type="number" id="fuelPerLiter" class="form-control" placeholder="0.00" required step="0.01" oninput="calculateFuelTotalAmount()">
                  </div>
                  <div class="col-md-2 mb-3">
                    <label class="form-label">Amount (₹)</label>
                    <input type="number" id="fuelAmount" class="form-control bg-light" placeholder="0.00" required step="0.01" readonly>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="fuelTripKm" class="form-label">Current KM Reading</label>
                    <input type="number" id="fuelTripKm" class="form-control" placeholder="Odometer reading (optional)">
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="fuelRemarks" class="form-label">Remarks</label>
                    <input type="text" id="fuelRemarks" class="form-control" placeholder="Driver name or note">
                  </div>
                </div>
                <button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i>Record Fuel Entry</button>
              </form>
              
              <h5 class="mt-4">Recent Fuel Entries (Fill-ups)</h5>
              <div class="table-responsive">
                <table id="recentFuelEntriesTable" class="table table-striped table-bordered" style="width:100%">
                  <thead>
                    <tr><th>Date</th><th>Pump</th><th class="text-end">Liters</th><th class="text-end">Amount (₹)</th><th>KM</th><th>Remarks</th></tr>
                  </thead>
                  <tbody id="recentFuelEntriesBody"></tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="expenses-content" role="tabpanel">
              <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">Trip Expense Log</h5>
                  <button type="button" class="btn btn-sm btn-outline-success" onclick="addExpenseRow('tripGenericExpensesContainer')">
                    <i class="fas fa-plus me-1"></i>Add Expense
                  </button>
                </div>
                <div class="card-body">
                  <div id="tripGenericExpensesContainer" class="d-flex flex-column gap-2">
                    </div>
                  <hr>
                  <div class="text-end">
                    <h5 class="mb-0">Total Trip Expenses: <span id="tripTotalExpensesDisplay" class="fw-bold text-danger">₹0.00</span></h5>
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-pane fade" id="empty-expenses-content" role="tabpanel">
              <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">Empty Return Expense Log</h5>
                  <button type="button" class="btn btn-sm btn-outline-success" onclick="addExpenseRow('emptyTripGenericExpensesContainer')">
                    <i class="fas fa-plus me-1"></i>Add Expense
                  </button>
                </div>
                <div class="card-body">
                  <div id="emptyTripGenericExpensesContainer" class="d-flex flex-column gap-2">
                    </div>
                  <hr>
                  <div class="text-end">
                    <h5 class="mb-0">Total Empty Trip Expenses: <span id="emptyTripTotalExpensesDisplay" class="fw-bold text-danger">₹0.00</span></h5>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="card mt-4">
            <div class="card-header bg-light">
              <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Trip Summary</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-3 mb-3">
                  <label class="form-label">Total Payable to Driver (₹)</label>
                  <input type="number" step="0.01" class="form-control bg-info-subtle" id="tripDriverPayable" readonly>
                </div>
                <div class="col-md-3 mb-3">
                  <label class="form-label">Total Trip Expense (₹)</label>
                  <input type="number" step="0.01" class="form-control bg-warning-subtle" id="tripTotalExpenses" readonly>
                </div>
                <div class="col-md-3 mb-3">
                  <label class="form-label">Total Billing Amount (Incl. GST)</label>
                  <input type="number" step="0.01" class="form-control bg-success-subtle" id="tripTotalBillingAmount" readonly>
                </div>
                <div class="col-md-3 mb-3">
                  <label class="form-label">Client Balance (₹)</label>
                  <input type="number" step="0.01" class="form-control bg-primary-subtle" id="tripClientBalance" readonly>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer d-flex justify-content-between">
          <div>
            <button type="button" class="btn btn-outline-secondary" onclick="navigateTripTabs(-1)">Previous</button>
            <button type="button" class="btn btn-outline-secondary" onclick="navigateTripTabs(1)">Next</button>
          </div>
          <div>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-success" id="saveTripDetailsBtn">Save Trip Details</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="invoiceModal" tabindex="-1" aria-hidden="true"></div>
  <div class="modal fade" id="lrCopyModal" tabindex="-1" aria-labelledby="lrCopyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header text-white" style="background-color: #2E8B57;">
          <h5 class="modal-title" id="lrCopyModalLabel">Lorry Receipt</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0" id="lrCopyContent" style="background-color: #ffffff;"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="fas fa-cog"></i> Print Settings
            </button>
            <ul class="dropdown-menu p-2" style="min-width: 200px;">
              <li class="form-check form-switch"><input class="form-check-input" type="checkbox" id="printLogoToggle" checked><label class="form-check-label" for="printLogoToggle">Show Logo</label></li>
              <li class="form-check form-switch"><input class="form-check-input" type="checkbox" id="printStampToggle" checked><label class="form-check-label" for="printStampToggle">Show Stamp</label></li>
              <li class="form-check form-switch"><input class="form-check-input" type="checkbox" id="printWatermarkToggle" checked><label class="form-check-label" for="printWatermarkToggle">Show Watermark</label></li>
            </ul>
          </div>
          <button type="button" class="btn btn-primary" onclick="downloadLRCopyPDF()"><i class="fas fa-file-pdf me-2"></i>Download PDF</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="editLRModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Edit LR Record</h5>
          <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#autoGenerationSettingsModal">
            <i class="fas fa-cog"></i>
          </button>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editLrForm">
            <div class="card mb-4">
              <div class="card-header bg-light"><h5 class="mb-0">Basic Information</h5></div>
              <div class="card-body">
                <div class="row mb-3">
                  <div class="col-md-4">
                    <label for="editLrDate" class="form-label">Date</label>
                    <input type="date" class="form-control" id="editLrDate" required>
                  </div>
                  <div class="col-md-4">
                    <label for="editLrNumber" class="form-label">LR Number</label>
                    <input type="text" class="form-control" id="editLrNumber" required>
                  </div>
                  <div class="col-md-4">
                    <label for="editInvoiceNumberInput" class="form-label">Invoice No.</label>
                    <input type="text" class="form-control" id="editInvoiceNumberInput">
                  </div>
                </div>
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="editDeliveryNo" class="form-label">Delivery No.</label>
                    <input type="text" class="form-control" id="editDeliveryNo">
                  </div>
                  <div class="col-md-6">
                    <label for="editOrderNo" class="form-label">Order No.</label>
                    <input type="text" class="form-control" id="editOrderNo">
                  </div>
                </div>
                <div class="row mb-3">
                  <div class="col-md-4">
                    <div class="form-check form-switch mb-2">
                      <input class="form-check-input" type="checkbox" role="switch" id="editVehicleTypeToggle" onchange="toggleEditVehicleInput(this.checked)">
                      <label class="form-check-label" for="editVehicleTypeToggle">Use Market Vehicle</label>
                    </div>
                    <div id="editOwnVehicleFields">
                      <label for="editTruckNumber" class="form-label">Own Truck Number</label>
                      <select id="editTruckNumber" class="form-select" required></select>
                    </div>
                    <div id="editMarketVehicleFields" style="display: none;">
                      <label for="editMarketTruckNumber" class="form-label">Market Truck Number</label>
                      <input type="text" id="editMarketTruckNumber" class="form-control">
                    </div>
                    <div id="editTransporterField" style="display: block;">
                      <label for="editTransporterSelect" class="form-label mt-2">Transporter</label>
                      <select id="editTransporterSelect" class="form-select">
                        <option value="">Select a Transporter</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div id="editOwnDriverField">
                      <label for="editDriverSelect" class="form-label">Driver</label>
                      <select id="editDriverSelect" class="form-select"></select>
                    </div>
                    <div id="editMarketDriverField" style="display: none;">
                      <label for="editMarketDriverName" class="form-label">Driver Name</label>
                      <input type="text" id="editMarketDriverName" class="form-control">
                    </div>
                  </div>
                  <div class="col-md-4">
                    <label for="editClientId" class="form-label">Client</label>
                    <select id="editClientId" class="form-select" required></select>
                  </div>
                </div>
                <div class="row mb-3">
                  <div class="col-md-12">
                    <label for="editRouteSelect" class="form-label">Route</label>
                    <select id="editRouteSelect" class="form-select" required></select>
                  </div>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-header bg-light"><h5 class="mb-0">Shipment Details</h5></div>
              <div class="card-body">
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="editItem" class="form-label">Item Description</label>
                    <input type="text" class="form-control" id="editItem">
                  </div>
                  <div class="col-md-6">
                    <label for="editConsigneeId" class="form-label">Consignee</label>
                    <select id="editConsigneeId" class="form-select" required></select>
                  </div>
                </div>
                <div class="row mb-3">
                  <div class="col-md-4">
                    <label for="editNumPackages" class="form-label">No. of Packages</label>
                    <input type="number" class="form-control" id="editNumPackages">
                  </div>
                  <div class="col-md-4">
                    <label for="editWeightPerPackage" class="form-label">Weight/Package (kg)</label>
                    <input type="number" class="form-control" id="editWeightPerPackage">
                  </div>
                  <div class="col-md-4">
                    <label for="editWeight" class="form-label">Total Weight (tonne)</label>
                    <input type="number" class="form-control" id="editWeight" step="0.01" required oninput="window.recalculateAmountsOnWeightChange()">
                  </div>
                </div>
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="editShipmentNo" class="form-label">Shipment No.</label>
                    <input type="text" class="form-control" id="editShipmentNo">
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="updateLRBtn">Update LR</button>
        </div>
      </div>
    </div>
  </div>


  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  
  <script src="navbar-loader.js"></script>
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDAlk_K8p8Of8Ne6Jpcl2QqXTtm95NgG7o",
      authDomain: "transport-dashboard-ad69a.firebaseapp.com",
      databaseURL: "https://transport-dashboard-ad69a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "transport-dashboard-ad69a",
      storageBucket: "transport-dashboard-ad69a.appspot.com",
      messagingSenderId: "526889676196",
      appId: "1:526889676196:web:66032c80a4aede690ae531",
      measurementId: "G-7F9R7HJYDH"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();
    const auth = firebase.auth();

    window.db = db;
    window.auth = auth;

    auth.onAuthStateChanged(user => {
      if (user) {
        currentCoreAccountId = user.uid;
        console.log("currentCoreAccountId set to:", currentCoreAccountId);
      } else {
        currentCoreAccountId = null;
        console.log("User logged out, currentCoreAccountId set to null.");
      }
    });

    // Global Constants
    const SHORTAGE_DEDUCTION_RATE = 100; // Example: Deduct ₹100 per tonne of shortage

    let allVehicles = [];
    let allClients = [];
    let allWorkVendors = []; 
    let allTransporters = []; // **NEW**
    let allPumps = []; // **NEW**: Global to store pump data
    let selectedLRs = [];
    let currentEditingLRId = null;
    let currentCoreAccountId = null;
    let lrTable;
    let marketLrTable; // **NEW**
    let currentTripWeight = 0; 
    let currentTripLRId = null; 
    let currentTripTruckNumber = null; // **NEW**

    // Auto-Generation Settings
    let autoSettings = {
      lrNo: true,
      invoiceNo: true,
      shipmentNo: true,
      orderNo: true,
      deliveryNo: true
    };
    
    // Load and Save Auto-Generation Settings
    function loadAutoGenerationSettings() {
      const storedSettings = localStorage.getItem('lrAutoGenerateSettings');
      if (storedSettings) {
        autoSettings = JSON.parse(storedSettings);
      }
      // Apply settings to form fields
      document.getElementById('autoGenerateLrNo').checked = autoSettings.lrNo;
      document.getElementById('autoGenerateInvoiceNo').checked = autoSettings.invoiceNo;
      document.getElementById('autoGenerateShipmentNo').checked = autoSettings.shipmentNo;
      document.getElementById('autoGenerateOrderNo').checked = autoSettings.orderNo;
      document.getElementById('autoGenerateDeliveryNo').checked = autoSettings.deliveryNo;
      applyAutoGenerationSettings();
    }

    function saveAutoGenerationSettings() {
      autoSettings = {
        lrNo: document.getElementById('autoGenerateLrNo').checked,
        invoiceNo: document.getElementById('autoGenerateInvoiceNo').checked,
        shipmentNo: document.getElementById('autoGenerateShipmentNo').checked,
        orderNo: document.getElementById('autoGenerateOrderNo').checked,
        deliveryNo: document.getElementById('autoGenerateDeliveryNo').checked
      };
      localStorage.setItem('lrAutoGenerateSettings', JSON.stringify(autoSettings));
      applyAutoGenerationSettings();
    }

    function applyAutoGenerationSettings() {
      // LR Number
      const lrNoInput = document.getElementById('lrNumber');
      if (lrNoInput) {
        lrNoInput.readOnly = autoSettings.lrNo; // Keep it read-only if auto-generated
        if (autoSettings.lrNo) generateLRNumber(lrNoInput); else { lrNoInput.value = ''; lrNoInput.placeholder = 'Enter LR Number'; }
      }
      
      // Invoice Number
      const invoiceNoInput = document.getElementById('invoiceNumberInput');
      if (invoiceNoInput) {
        invoiceNoInput.readOnly = autoSettings.invoiceNo;
        if (autoSettings.invoiceNo) generateSequentialNumber(invoiceNoInput, 'INV'); else { invoiceNoInput.value = ''; invoiceNoInput.placeholder = 'Enter Invoice No.'; }
      }

      // Delivery Number
      const deliveryNoInput = document.getElementById('deliveryNo');
      if (deliveryNoInput) {
        deliveryNoInput.readOnly = autoSettings.deliveryNo;
        if (autoSettings.deliveryNo) generateSequentialNumber(deliveryNoInput, 'DLV'); else { deliveryNoInput.value = ''; deliveryNoInput.placeholder = 'Enter Delivery No.'; }
      }
      
      // Order Number
      const orderNoInput = document.getElementById('orderNo');
      if (orderNoInput) {
        orderNoInput.readOnly = autoSettings.orderNo;
        if (autoSettings.orderNo) generateSequentialNumber(orderNoInput, 'ORD'); else { orderNoInput.value = ''; orderNoInput.placeholder = 'Enter Order No.'; }
      }
      
      // Shipment Number
      const shipmentNoInput = document.getElementById('shipmentNo');
      if (shipmentNoInput) {
        shipmentNoInput.readOnly = autoSettings.shipmentNo;
        if (autoSettings.shipmentNo) generateSequentialNumber(shipmentNoInput, 'SHP'); else { shipmentNoInput.value = ''; shipmentNoInput.placeholder = 'Enter Shipment No.'; }
      }
    }

    function generateLRNumber(inputElement) {
      if (!autoSettings.lrNo) return;
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const random = Math.floor(1000 + Math.random() * 9000);
      inputElement.value = `LR${year}${month}${day}${random}`;
    }

    function generateSequentialNumber(inputElement, prefix) {
      if (!currentCoreAccountId) {
        console.error(`Cannot generate ${prefix} number without core account ID.`);
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const random = Math.floor(1000 + Math.random() * 9000);
        inputElement.value = `${prefix}${year}${month}${day}${random}`;
        return;
      }

      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      const datePrefix = `${prefix}${year}${month}${day}`;

      const counterRef = db.ref(`users/${currentCoreAccountId}/counters/${prefix.toLowerCase()}_${year}${month}${day}`);
      
      counterRef.transaction(currentValue => {
        return (currentValue || 0) + 1;
      }).then(({ committed, snapshot }) => {
        if (committed) {
          const nextNumber = snapshot.val();
          const runningNumber = String(nextNumber).padStart(4, '0');
          inputElement.value = `${datePrefix}${runningNumber}`;
        } else {
          console.error(`${prefix} number generation transaction was aborted.`);
          // Fallback to random number
          const random = Math.floor(1000 + Math.random() * 9000);
          inputElement.value = `${datePrefix}${random}`;
        }
      }).catch(error => {
        console.error(`Error with ${prefix} number generation transaction: `, error);
        // Fallback to random number
        const random = Math.floor(1000 + Math.random() * 9000);
        inputElement.value = `${datePrefix}${random}`;
      });
    }

    function generateRandomNumber(inputElement, prefix) {
      if (!autoSettings[`${prefix.toLowerCase()}No`]) return;
      const now = new Date();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const random = Math.floor(100 + Math.random() * 900);
      inputElement.value = `${prefix}-${month}-${random}`;
    }

    // Apply auto-generation for Edit modal fields without overwriting existing values
    function applyEditAutoGenerationSettings() {
      // LR Number (optional: keep editable by design; using auto setting to control readOnly)
      const eLR = document.getElementById('editLrNumber');
      if (eLR) {
        eLR.readOnly = !!autoSettings.lrNo;
        eLR.placeholder = autoSettings.lrNo ? 'Auto-Generated if empty' : 'Enter LR Number';
        if (autoSettings.lrNo && !eLR.value) {
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, '0');
          const day = String(now.getDate()).padStart(2, '0');
          const random = Math.floor(1000 + Math.random() * 9000);
          eLR.placeholder = `e.g., LR${year}${month}${day}${random}`;
        }
      }
      // Invoice No
      const eInv = document.getElementById('editInvoiceNumberInput');
      if (eInv) {
        eInv.readOnly = !!autoSettings.invoiceNo;
        eInv.placeholder = autoSettings.invoiceNo ? 'Auto-Generated if empty' : 'Enter Invoice No.';
        if (autoSettings.invoiceNo && !eInv.value) generateSequentialNumber(eInv, 'INV');
      }
      // Shipment No
      const eShip = document.getElementById('editShipmentNo');
      if (eShip) {
        eShip.readOnly = !!autoSettings.shipmentNo;
        eShip.placeholder = autoSettings.shipmentNo ? 'Auto-Generated if empty' : 'Enter Shipment No.';
        if (autoSettings.shipmentNo && !eShip.value) generateSequentialNumber(eShip, 'SHP');
      }
      // Order No
      const eOrder = document.getElementById('editOrderNo');
      if (eOrder) {
        eOrder.readOnly = !!autoSettings.orderNo;
        eOrder.placeholder = autoSettings.orderNo ? 'Auto-Generated if empty' : 'Enter Order No.';
        if (autoSettings.orderNo && !eOrder.value) generateSequentialNumber(eOrder, 'ORD');
      }
      // Delivery No
      const eDel = document.getElementById('editDeliveryNo');
      if (eDel) {
        eDel.readOnly = !!autoSettings.deliveryNo;
        eDel.placeholder = autoSettings.deliveryNo ? 'Auto-Generated if empty' : 'Enter Delivery No.';
        if (autoSettings.deliveryNo && !eDel.value) generateSequentialNumber(eDel, 'DLV');
      }
    }

    // Load all vehicles (includes driver info)
    async function loadAllVehicles(userId) {
      try {
         const userProfileRef = db.ref(`users/${userId}`);
         const userSnapshot = await userProfileRef.once('value');
         const userData = userSnapshot.val();
         currentCoreAccountId = (userData && userData.coreAccountId) || userId;
 
         // Load Vehicles
         const vehiclesRef = db.ref(`users/${currentCoreAccountId}/vehicles`);
         vehiclesRef.on('value', (snapshot) => {
             allVehicles = [];
             const truckSelect = document.getElementById('truckNumber');
             const editTruckSelect = document.getElementById('editTruckNumber');
             if (truckSelect) truckSelect.innerHTML = '<option value="">Select a Truck</option>';
             if (editTruckSelect) editTruckSelect.innerHTML = '<option value="">Select a Truck</option>';
 
             if (snapshot.exists()) {
                 snapshot.forEach((child) => {
                     const vehicle = { id: child.key, ...child.val() };
                     allVehicles.push(vehicle);
                     const option = document.createElement('option');
                     option.value = vehicle.vehicleNumber;
                     option.textContent = vehicle.vehicleNumber;
                     if (truckSelect) truckSelect.appendChild(option.cloneNode(true));
                     if (editTruckSelect) editTruckSelect.appendChild(option);
                 });
             }
             updateTruckFilterDropdown();
         });
 
         // Load Drivers
         const driversRef = db.ref(`users/${currentCoreAccountId}/drivers`);
         driversRef.on('value', (snapshot) => {
             populateDriverDropdowns(snapshot, 'driverSelect', 'editDriverSelect');
         });
      } catch (error) {
        console.error("❌ Failed to load vehicle master list:", error);
      }
    }

    // Load all clients, routes, and vendors
    async function loadAllData() {
      const user = auth.currentUser;
      if (!user) return;
      await loadAllVehicles(user.uid);
      
      // Apply auto-generation settings after currentCoreAccountId is set
      applyAutoGenerationSettings();

      // Clients
      const clientsRef = db.ref(`users/${user.uid}/clients`);
      clientsRef.on('value', (snapshot) => {
        allClients = [];
        const clientSelect = document.getElementById('clientId');
        const consigneeSelect = document.getElementById('consigneeId');
        const editClientSelect = document.getElementById('editClientId');
        const editConsigneeSelect = document.getElementById('editConsigneeId'); // **NEW**
        if (clientSelect) clientSelect.innerHTML = '<option value="">Select a Client</option>';
        [consigneeSelect, editClientSelect, editConsigneeSelect].forEach(el => { if(el) el.innerHTML = '<option value="">Select...</option>'; });
        
        if (snapshot.exists()) {
          snapshot.forEach((childSnapshot) => {
            const client = childSnapshot.val();
            const clientData = { id: childSnapshot.key, name: client.clientName, ...client };
            allClients.push(clientData);
            const option = document.createElement('option');
            option.value = clientData.id;
            option.textContent = clientData.name;
            option.dataset.address = client.billingAddress || '';
            if (clientSelect) clientSelect.appendChild(option.cloneNode(true));
            if (consigneeSelect) consigneeSelect.appendChild(option.cloneNode(true));
            if (editConsigneeSelect) editConsigneeSelect.appendChild(option.cloneNode(true)); // **NEW**
            if (editClientSelect) editClientSelect.appendChild(option);
          });
          loadLRData(); // Load LRs after clients are available for display
        }
      });
      
      // Routes (using core account ID for shared data)
      const routesRef = db.ref(`users/${currentCoreAccountId}/routes`);
      routesRef.on('value', (snapshot) => {
        const routeSelect = document.getElementById('routeSelect');
        const editRouteSelect = document.getElementById('editRouteSelect');
        if (routeSelect) routeSelect.innerHTML = '<option value="">Select a Route</option>';
        if (editRouteSelect) editRouteSelect.innerHTML = '<option value="">Select a Route</option>';
        if (snapshot.exists()) {
          snapshot.forEach((child) => {
            const r = child.val() || {};
            const opt = document.createElement('option');
            opt.value = child.key;
            opt.textContent = `${r.from || '-'} --> ${r.to || '-'}`;
            opt.dataset.from = r.from || '';
            opt.dataset.to = r.to || '';
            opt.dataset.distance = r.distance !== undefined ? r.distance : 0;
            if (routeSelect) routeSelect.appendChild(opt.cloneNode(true));
            if (editRouteSelect) editRouteSelect.appendChild(opt);
          });
        }
      });

      // Work Vendors for the modal (using core account ID for shared data)
      const vendorsRef = db.ref(`users/${currentCoreAccountId}/workVendors`);
        vendorsRef.on('value', (snapshot) => {
            allWorkVendors = []; // Reset
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    allWorkVendors.push({ id: child.key, ...child.val() });
                });
                console.log("✅ Successfully loaded work vendors for expense modal:", allWorkVendors.length);
            } else {
                console.log("ℹ️ No work vendors found for this account.");
            }
        });

      // **NEW**: Load Transporters for the dropdown
      const transportersRef = db.ref(`users/${currentCoreAccountId}/transporters`);
      transportersRef.on('value', (snapshot) => {
        allTransporters = [];
        const addSelect = document.getElementById('transporterSelect');
        const editSelect = document.getElementById('editTransporterSelect');
        if (addSelect) addSelect.innerHTML = '<option value="">Select a Transporter</option>';
        if (editSelect) editSelect.innerHTML = '<option value="">Select a Transporter</option>';
        
        if (snapshot.exists()) {
          snapshot.forEach((child) => {
            const transporter = { id: child.key, ...child.val() };
            allTransporters.push(transporter);
            populateTransporterDropdowns(transporter, addSelect, editSelect);
          });
        }
      });

      // **NEW**: Load all Pumps (for Fuel Entry tab)
      const pumpsRef = db.ref(`users/${auth.currentUser.uid}/petrolPumps`);
      pumpsRef.on('value', (snapshot) => {
          allPumps = [];
          if (snapshot.exists()) {
              snapshot.forEach(child => {
                  allPumps.push({ id: child.key, ...child.val() });
              });
              console.log("✅ Successfully loaded pumps:", allPumps.length);
          } else {
              console.log("ℹ️ No pumps found for this account.");
          }
      });
    }

    // Helper to populate transporter dropdowns
    function populateTransporterDropdowns(transporter, ...dropdowns) {
      const option = document.createElement('option');
      option.value = transporter.id;
      option.textContent = transporter.name;
      option.dataset.name = transporter.name; // Store name for saving
      dropdowns.forEach(dropdown => {
        if (dropdown) dropdown.appendChild(option.cloneNode(true));
      });
    }
    
    // --- NEW: Helper to populate driver dropdowns ---
    function populateDriverDropdowns(snapshot, ...dropdownIds) {
        const selects = dropdownIds.map(id => document.getElementById(id));
        selects.forEach(s => { if(s) s.innerHTML = '<option value="">Select a Driver</option>'; });

        if (snapshot.exists()) {
            snapshot.forEach((child) => {
                const driver = child.val();
                if (driver.driverName) {
                    const option = document.createElement('option');
                    option.value = driver.driverName; // Use name as value
                    option.textContent = driver.driverName;
                    selects.forEach(s => { if(s) s.appendChild(option.cloneNode(true)); });
                }
            });
        }
    }

    // --- NEW LOGIC FUNCTIONS ---

    // --- WEIGHT CALCULATION FUNCTIONS (RETAINED) ---

    function calculateWeightFromPackages() {
      const numPackages = parseFloat(document.getElementById('numPackages').value) || 0;
      const weightPerPackage = parseFloat(document.getElementById('weightPerPackage').value) || 0;
      
      if (numPackages > 0 && weightPerPackage > 0) {
        const totalWeightKg = numPackages * weightPerPackage;
        const totalWeightTonne = totalWeightKg / 1000;
        document.getElementById('weight').value = totalWeightTonne.toFixed(3);
      }
    }

    function handleManualWeightInput() {
      document.getElementById('numPackages').value = '';
      document.getElementById('weightPerPackage').value = '';
    }

    // --- MAIN LR SAVE FUNCTION (STREAMLINED) ---

    function saveLR() {
      const form = document.getElementById('lrForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const routeSelect = document.getElementById('routeSelect');
      const selectedRoute = routeSelect.options[routeSelect.selectedIndex];
      const fromLoc = selectedRoute ? (selectedRoute.dataset.from || '') : '';
      const toLoc = selectedRoute ? (selectedRoute.dataset.to || '') : '';
      const routeDistance = selectedRoute && selectedRoute.dataset && selectedRoute.dataset.distance ? parseFloat(selectedRoute.dataset.distance) || 0 : 0;

      // **MODIFIED**: Logic for Market LR Trip
      const isMarketVehicle = document.getElementById('vehicleTypeToggle').checked;
      const truckNumber = isMarketVehicle ? document.getElementById('marketTruckNumber').value : document.getElementById('truckNumber').value;
      const driverName = isMarketVehicle ? document.getElementById('marketDriverName').value.trim() : document.getElementById('driverSelect').value;
      
      const transporterSelect = document.getElementById('transporterSelect');
      const transporterId = transporterSelect.value;
      const transporterName = transporterSelect.value ? transporterSelect.options[transporterSelect.selectedIndex].dataset.name : null;

      const vehicle = allVehicles.find(v => (v.vehicleNo || '').toUpperCase() === truckNumber.toUpperCase() && v.driverName === driverName);

      const lrData = {
        date: document.getElementById('lrDate').value,
        lrNumber: document.getElementById('lrNumber').value,
        lrType: isMarketVehicle ? 'market' : (transporterId ? 'market_company' : 'own'),
        transporterId: transporterId,
        transporterCompany: transporterName,
        routeId: document.getElementById('routeSelect').value, 
        invoiceNumber: document.getElementById('invoiceNumberInput').value,
        deliveryNo: document.getElementById('deliveryNo').value,
        orderNo: document.getElementById('orderNo').value,
        shipmentNo: document.getElementById('shipmentNo').value,
        truckNumber: truckNumber,
        driverName: driverName,
        truckId: vehicle ? vehicle.id : null,
        clientId: document.getElementById('clientId').value,
        consigneeId: document.getElementById('consigneeId').value || document.getElementById('clientId').value,
        fromLocation: fromLoc,
        toLocation: toLoc,
        routeDistanceKm: routeDistance,
        numPackages: parseFloat(document.getElementById('numPackages').value) || 0,
        weightPerPackage: parseFloat(document.getElementById('weightPerPackage').value) || 0,
        weight: parseFloat(document.getElementById('weight').value) || 0,
        item: document.getElementById('item').value,
        // New fields for post-save entry
        tripDetails: {
          billingRate: 0, billingAmount: 0, freightRate: 0, freightAmount: 0,
          advance: 0, shortage: 0, 
          endingKm: 0, totalKm: 0,
          vehicleAverage: 0, fuelUsedLiters: 0, dieselRatePerLiter: 0,
          // Aggregated Expense Fields (Start with zero)
          tyreExpenses: 0,
          tollExpenses: 0,
          foodExpenses: 0,
          loadingUnloadingExpenses: 0,
          policeChallanExpenses: 0,
          tacExpenses: 0,
          permitExpenses: 0,
          brokerageExpenses: 0,
          vehicleWorkAmount: 0,
          commissionExpenses: 0,
          tirpalRopeExpenses: 0,
          otherExpenses: 0,
          genericExpenses: [],
          
          cgstPercentage: 9, cgstAmount: 0, sgstPercentage: 9, sgstAmount: 0,
          totalBillingAmount: 0, totalExpenses: 0, driverPayable: 0, clientBalance: 0,
        },
        createdAt: new Date().toISOString(),
        status: 'active'
      };

      if (!currentCoreAccountId) {
          alert('Error: Core account ID not found. Cannot save LR.');
          return;
      }
      
      const newLRRef = db.ref(`users/${currentCoreAccountId}/lrReports`).push();
      newLRRef.set(lrData)
        .then(() => {
          alert('LR saved successfully! Please enter trip details next.');
          form.reset();
          document.getElementById('lrDate').value = new Date().toISOString().split('T')[0];
          applyAutoGenerationSettings();
          loadLRData();
          
          // Optionally auto-open the new trip details modal
          // showTripDetailsModal(newLRRef.key, lrData.lrNumber, lrData.weight, lrData.truckNumber, lrData.driverName);
        })
        .catch((error) => {
          console.error('Error saving LR:', error);
          alert('Error saving LR. Please try again.');
        });
    }

    // --- NEW: Function to sync consignee with consignor selection ---
    window.updateConsigneeFromClient = function() {
      const clientSelect = document.getElementById('clientId');
      const consigneeSelect = document.getElementById('consigneeId');
      if (clientSelect && consigneeSelect) {
        consigneeSelect.value = clientSelect.value;
      }
    }

    // **NEW**: Toggle between own and market vehicle inputs
    window.toggleVehicleInput = function(isMarket) {
      const ownVehicleFields = document.getElementById('ownVehicleFields');
      const marketVehicleFields = document.getElementById('marketVehicleFields');
      const ownDriverField = document.getElementById('ownDriverField');
      const marketDriverField = document.getElementById('marketDriverField');
      const transporterField = document.getElementById('transporterField');

      ownVehicleFields.style.display = isMarket ? 'none' : 'block';
      marketVehicleFields.style.display = isMarket ? 'block' : 'none';
      transporterField.style.display = isMarket ? 'none' : 'block'; // **FIX**: Show Transporter for OWN vehicles
      ownDriverField.style.display = isMarket ? 'none' : 'block';
      marketDriverField.style.display = isMarket ? 'block' : 'none';

      // Toggle required attribute to ensure form validation works correctly
      document.getElementById('truckNumber').required = !isMarket;
      document.getElementById('marketTruckNumber').required = isMarket;
      document.getElementById('transporterSelect').required = false; // **FIX**: Transporter is always optional
    }

    // **NEW**: Toggle for the EDIT modal
    window.toggleEditVehicleInput = function(isMarket) {
      const ownVehicleFields = document.getElementById('editOwnVehicleFields');
      const marketVehicleFields = document.getElementById('editMarketVehicleFields');
      const transporterField = document.getElementById('editTransporterField');
      const ownDriverField = document.getElementById('editOwnDriverField');
      const marketDriverField = document.getElementById('editMarketDriverField');

      ownVehicleFields.style.display = isMarket ? 'none' : 'block';
      marketVehicleFields.style.display = isMarket ? 'block' : 'none';
      transporterField.style.display = isMarket ? 'none' : 'block'; // Transporter field appears when 'Use Market Vehicle' is unchecked
      ownDriverField.style.display = isMarket ? 'none' : 'block';
      marketDriverField.style.display = isMarket ? 'block' : 'none';

      document.getElementById('editTruckNumber').required = !isMarket;
      document.getElementById('editMarketTruckNumber').required = isMarket;
      document.getElementById('editTransporterSelect').required = false; // **FIX**: Transporter is always optional
    }

    // --- TRIP DETAILS MODAL LOGIC (POST-SAVE) ---

    // Generic Expense Row Adder
    window.addExpenseRow = function(containerId, data = {}) {
      const container = document.getElementById(containerId);
      const entryDiv = document.createElement('div');
      entryDiv.className = 'row g-3 mb-2 expense-row align-items-center';

      // Create vendor dropdown HTML
      let vendorOptions = '<option value="">Select Vendor</option>';
      allWorkVendors.forEach(vendor => {
        vendorOptions += `<option value="${vendor.id}" ${data.vendorId === vendor.id ? 'selected' : ''}>${vendor.name}</option>`;
      });

      entryDiv.innerHTML = `
        <div class="col-md-2">
          <select class="form-select expense-type" onchange="window.toggleVendorDropdown(this)">
            <option value="Tyre">Tyre</option>
            <option value="Toll">Toll</option>
            <option value="Food">Food</option>
            <option value="Loading/Unloading">Loading/Unloading</option>
            <option value="Police Challan">Police Challan</option>
            <option value="TAC">TAC</option>
            <option value="Permit">Permit</option>
            <option value="Brokerage">Brokerage</option>
            <option value="Vehicle Work">Vehicle Work</option>
            <option value="Commission">Commission</option>
            <option value="Tirpal & Rope">Tirpal & Rope</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="col-md-2"><input type="number" step="0.01" class="form-control expense-amount" placeholder="Amount (₹)" value="${data.amount || ''}" oninput="calculateTripTotals()"></div>
        <div class="col-md-3 vendor-select-container" style="display: none;">
          <select class="form-select expense-vendor">${vendorOptions}</select>
        </div>
        <div class="col-md-2"><input type="date" class="form-control expense-date" value="${data.date || new Date().toISOString().split('T')[0]}"></div>
        <div class="col-md-2"><input type="text" class="form-control expense-note" placeholder="Remarks" value="${data.note || ''}"></div>
        <div class="col-md-1 text-center"><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.expense-row').remove(); calculateTripTotals();"><i class="fas fa-trash"></i></button></div>
      `;
      // Set selected type
      if (data.type) {
        entryDiv.querySelector('.expense-type').value = data.type;
      }
      container.appendChild(entryDiv);
      // Trigger the check to show/hide vendor dropdown on initial load
      window.toggleVendorDropdown(entryDiv.querySelector('.expense-type'));
    }

    // **NEW**: Show/hide vendor dropdown based on expense type
    window.toggleVendorDropdown = function(selectElement) {
        const expenseRow = selectElement.closest('.expense-row');
        const vendorContainer = expenseRow.querySelector('.vendor-select-container');
        const noteInput = expenseRow.querySelector('.expense-note');
        if (selectElement.value === 'Vehicle Work') {
            vendorContainer.style.display = 'block';
        } else {
            vendorContainer.style.display = 'none';
        }
    };

    // Open Trip Details Modal
    window.showTripDetailsModal = async function(lrId, lrNumber, weight, truckNumber, driverName) {
      // Reset to first tab
      const firstTab = document.querySelector('#tripDetailsTabs button');
      if (firstTab) new bootstrap.Tab(firstTab).show();
      
      currentTripLRId = lrId;

      // **FIX**: Check if the edit modal is open and use its weight value if it is.
      // This ensures that changes to weight in the edit form are reflected here.
      const editModal = document.getElementById('editLRModal');
      const isEditing = editModal.classList.contains('show');
      currentTripWeight = isEditing ? (parseFloat(document.getElementById('editWeight').value) || weight) : weight;

      currentTripTruckNumber = truckNumber; // **NEW**
      document.getElementById('modalLrNumber').textContent = lrNumber;
      document.getElementById('fuelEntryTruckNumber').textContent = truckNumber; // **NEW**

      // **NEW**: Fetch the last ending KM for this vehicle
      let lastKm = 0;
      if (truckNumber && currentCoreAccountId) {
        const vehicleQuery = db.ref(`users/${currentCoreAccountId}/vehicles`).orderByChild('vehicleNumber').equalTo(truckNumber);
        const vehicleSnap = await vehicleQuery.once('value');
        if (vehicleSnap.exists()) {
          const vehicleId = Object.keys(vehicleSnap.val())[0];
          const vehicleData = vehicleSnap.val()[vehicleId];
          lastKm = vehicleData.lastEndingKm || 0;
        }
      }

      const lrRef = db.ref(`users/${currentCoreAccountId}/lrReports/${lrId}`);
      lrRef.once('value').then(snapshot => {
        const lr = snapshot.val();
        const details = lr.tripDetails || {};
        const isMarketVehicle = lr.lrType === 'market'; // This is now correct because the save logic is fixed
        const fuelTab = document.getElementById('fuel-tab');
        const fuelEntryTab = document.getElementById('fuel-entry-tab'); // **NEW**
        const expensesTab = document.getElementById('expenses-tab');
        const emptyExpensesTab = document.getElementById('empty-expenses-tab');
        const tripAdvanceField = document.getElementById('tripAdvanceField');
        const modalNavButtons = document.querySelectorAll('.modal-footer button[onclick^="navigateTripTabs"]');

        // Hide fields not applicable to market vehicles
        const ownVehicleOnlyElements = [fuelTab, fuelEntryTab, expensesTab, emptyExpensesTab, tripAdvanceField];
        ownVehicleOnlyElements.forEach(el => {
          if (el) el.style.display = isMarketVehicle ? 'none' : 'block';
        });

        // Reset advance to 0 if it's a market vehicle
        const tripAdvanceInput = document.getElementById('tripAdvance');
        if (isMarketVehicle) {
          tripAdvanceInput.value = 0;
        }

        modalNavButtons.forEach(btn => {
          btn.style.display = isMarketVehicle ? 'none' : 'inline-block';
        });

        // **NEW**: Show/hide commission field
        const commissionField = document.getElementById('commissionField');
        commissionField.style.display = isMarketVehicle ? 'block' : 'none';
        document.getElementById('tripCommission').value = details.commission || '';
        // END NEW

        // **NEW**: Pre-fill Starting KM if it hasn't been set for this trip yet.
        const startingKmInput = document.getElementById('tripStartingKm');
        startingKmInput.value = details.startingKm || lastKm;

        // 1. Billing, Freight & Advance
        document.getElementById('tripBillingRate').value = details.billingRate || '';
        document.getElementById('tripBillingAmount').value = details.billingAmount || '';
        document.getElementById('tripFreightRate').value = details.freightRate || '';
        document.getElementById('tripFreightAmount').value = details.freightAmount || '';
        document.getElementById('tripAdvance').value = details.advance || 0;
        document.getElementById('tripShortage').value = details.shortage || 0;

        // 2. KM & Fuel Tracking
        document.getElementById('tripEndingKm').value = details.endingKm || '';
        document.getElementById('tripVehicleAverage').value = details.vehicleAverage || '';
        document.getElementById('tripDieselRatePerLiter').value = details.dieselRatePerLiter || '';
        calculateTotalKm(); // Recalculate auto fields

        // 3. Fuel Entry Tab - Load current fuel and recent entries
        loadCurrentFuelLevel(truckNumber);
        loadRecentFuelEntries(truckNumber);
        // Set default date for fuel entry
        document.getElementById('fuelFillDate').value = new Date().toISOString().split('T')[0];


        // 4. Trip Expenses (Generic List)
        const genericContainer = document.getElementById('tripGenericExpensesContainer');
        genericContainer.innerHTML = '';
        (details.genericExpenses || []).forEach(exp => addExpenseRow('tripGenericExpensesContainer', exp));
        
        // 5. Empty Trip Expenses (Generic List)
        const emptyGenericContainer = document.getElementById('emptyTripGenericExpensesContainer');
        emptyGenericContainer.innerHTML = '';
        const emptyDetails = lr.emptyTripData || {};
        (emptyDetails.genericExpenses || []).forEach(exp => addExpenseRow('emptyTripGenericExpensesContainer', exp));
        
        // 6. Taxes and Totals
        document.getElementById('tripCgstPercentage').value = details.cgstPercentage || 9;
        document.getElementById('tripSgstPercentage').value = details.sgstPercentage || 9;
        
        // Final calculation
        calculateTripTotals();

        // Show Modal
        const tripModal = new bootstrap.Modal(document.getElementById('tripDetailsModal'));
        tripModal.show();
      }).catch(error => {
        console.error("Error loading trip details:", error);
        alert("Failed to load trip details.");
      });
    }

    // **NEW**: Tab navigation helper
    window.navigateTripTabs = function(direction) {
      const tabs = Array.from(document.querySelectorAll('#tripDetailsTabs .nav-link'));
      const activeTab = document.querySelector('#tripDetailsTabs .nav-link.active');
      const activeTabIndex = tabs.findIndex(tab => tab.classList.contains('active'));
      
      let nextIndex = activeTabIndex + direction;
      // Skip hidden tabs (market vehicle scenario)
      while (tabs[nextIndex] && tabs[nextIndex].parentElement.style.display === 'none') {
          nextIndex += direction;
      }

      // Wrap around
      if (nextIndex >= tabs.length) nextIndex = 0;
      if (nextIndex < 0) nextIndex = tabs.length - 1;

      // Handle wrapping around to a hidden tab at the end/start
      if (tabs[nextIndex].parentElement.style.display === 'none') {
          // Fallback: If after wrap the tab is still hidden, just stop or go to the first visible one
          return;
      }
      
      // Load fuel pumps if navigating to the fuel entry tab
      if (tabs[nextIndex].id === 'fuel-entry-tab') {
        loadFuelPumps();
      }

      const newTab = new bootstrap.Tab(tabs[nextIndex]);
      newTab.show();
    }
    
    // **NEW**: Fuel Entry Functions
    
    // 1. Calculate Amount in Fuel Entry Tab
    window.calculateFuelTotalAmount = function() {
        const liters = parseFloat(document.getElementById('fuelLiters').value) || 0;
        const rate = parseFloat(document.getElementById('fuelPerLiter').value) || 0;
        document.getElementById('fuelAmount').value = (liters * rate).toFixed(2);
    }
    
    // 2. Load Pumps to Dropdown
    window.loadFuelPumps = function() {
        const select = document.getElementById('fuelPumpSelect');
        // Check if options are already loaded to avoid duplicates
        if (select.options.length > 1 && allPumps.length > 0) return;

        select.innerHTML = '<option value="">Select a Pump</option>';
        allPumps.forEach(pump => {
            const option = document.createElement('option');
            option.value = pump.id;
            option.textContent = pump.name;
            select.appendChild(option);
        });
    }
    
    // 3. Load Current Fuel Level
    async function loadCurrentFuelLevel(truckNumber) {
        const currentFuelDisplay = document.getElementById('currentFuelLevel');
        currentFuelDisplay.textContent = '...';
        
        const vehicle = allVehicles.find(v => (v.vehicleNo || v.vehicleNumber || '').toUpperCase() === truckNumber.toUpperCase());
        if (vehicle && currentCoreAccountId) {
            const vRef = db.ref(`users/${currentCoreAccountId}/vehicles/${vehicle.id}`);
            const curSnap = await vRef.child('currentFuel').once('value');
            const currentFuel = parseFloat(curSnap.val()) || 0;
            currentFuelDisplay.textContent = `${currentFuel.toFixed(2)} Liters`;
            currentFuelDisplay.classList.remove('text-danger', 'text-warning', 'text-success');
            if (currentFuel < 5) {
                currentFuelDisplay.classList.add('text-danger');
            } else if (currentFuel < 20) {
                currentFuelDisplay.classList.add('text-warning');
            } else {
                currentFuelDisplay.classList.add('text-success');
            }
        } else {
            currentFuelDisplay.textContent = 'N/A (Vehicle Not Found)';
        }
    }

    // 4. Load Recent Fuel Entries
    async function loadRecentFuelEntries(truckNumber) {
        const body = document.getElementById('recentFuelEntriesBody');
        body.innerHTML = '<tr><td colspan="6">Loading entries...</td></tr>';
        
        const fuelEntriesRef = db.ref(`users/${currentCoreAccountId}/fuelLogs`).orderByChild('truckNumber').equalTo(truckNumber);
        
        fuelEntriesRef.once('value').then(snapshot => {
            body.innerHTML = '';
            let hasData = false;
            // Convert snapshot to array and sort by timestamp/date descending
            const entries = [];
            snapshot.forEach(child => {
                const entry = child.val();
                if (entry.source === 'pump-fillup' || entry.source === 'manual') {
                    entries.push({ key: child.key, ...entry });
                }
            });

            entries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            entries.forEach(entry => {
                hasData = true;
                const pumpName = allPumps.find(p => p.id === entry.pumpId)?.name || 'N/A';
                const newRow = body.insertRow();
                newRow.innerHTML = `
                    <td>${entry.date || (new Date(entry.timestamp).toISOString().split('T')[0])}</td>
                    <td>${pumpName}</td>
                    <td class="text-end">${(entry.filledLiters || 0).toFixed(2)}</td>
                    <td class="text-end">${(entry.totalAmount || 0).toFixed(2)}</td>
                    <td>${entry.kmReading || '-'}</td>
                    <td>${entry.remarks || '-'}</td>
                `;
            });
            if (!hasData) {
                body.innerHTML = '<tr><td colspan="6">No recent fuel fill-up entries found for this truck.</td></tr>';
            }
        }).catch(error => {
            console.error("Error loading fuel entries:", error);
            body.innerHTML = '<tr><td colspan="6" class="text-danger">Failed to load entries.</td></tr>';
        });
    }

    // 5. Handle Fuel Entry Form Submission
    document.getElementById('fuelEntryForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const liters = parseFloat(document.getElementById('fuelLiters').value);
        const rate = parseFloat(document.getElementById('fuelPerLiter').value);
        const amount = parseFloat(document.getElementById('fuelAmount').value);
        const pumpId = document.getElementById('fuelPumpSelect').value;
        const fillDate = document.getElementById('fuelFillDate').value;
        const kmReading = document.getElementById('fuelTripKm').value;
        const remarks = document.getElementById('fuelRemarks').value;
        
        if (!currentTripTruckNumber || !currentCoreAccountId) {
            alert('Error: Truck or Account ID not set.');
            return;
        }

        const vehicle = allVehicles.find(v => (v.vehicleNo || v.vehicleNumber || '').toUpperCase() === currentTripTruckNumber.toUpperCase());
        if (!vehicle) {
            alert('Error: Vehicle not found in master list.');
            return;
        }
        
        const logData = {
            timestamp: new Date().toISOString(),
            date: fillDate,
            source: 'pump-fillup',
            truckNumber: currentTripTruckNumber,
            vehicleId: vehicle.id,
            filledLiters: liters,
            perLiter: rate,
            totalAmount: amount,
            pumpId: pumpId,
            kmReading: kmReading ? parseFloat(kmReading) : null,
            remarks: remarks,
            userId: auth.currentUser.uid,
            coreAccountId: currentCoreAccountId, // Explicitly set coreAccountId for rules
            lrNumber: document.getElementById('modalLrNumber').textContent // Log the associated LR for context
        };

        try {
            const vRef = db.ref(`users/${currentCoreAccountId}/vehicles/${vehicle.id}`);
            const curSnap = await vRef.child('currentFuel').once('value');
            const before = parseFloat(curSnap.val()) || 0;
            const after = before + liters;

            const updates = {};
            const newLogKey = db.ref(`users/${currentCoreAccountId}/fuelLogs`).push().key;
            
            // 1. Update Vehicle's Current Fuel
            updates[`users/${currentCoreAccountId}/vehicles/${vehicle.id}/currentFuel`] = after;

            // 2. Add Fuel Log
            updates[`users/${currentCoreAccountId}/fuelLogs/${newLogKey}`] = {
                ...logData,
                beforeLiters: before,
                afterLiters: after,
            };

            // **NEW**: Add a reference to this log under the selected pump's transactions
            // Note: Pump data is stored under the user's direct UID, not the coreAccountId.
            updates[`users/${auth.currentUser.uid}/petrolPumps/${pumpId}/transactions/${newLogKey}`] = true;

            await db.ref().update(updates);
            
            alert(`Fuel entry recorded! Tank level updated to ${after.toFixed(2)} Liters.`);
            e.target.reset();
            loadCurrentFuelLevel(currentTripTruckNumber); // Refresh display
            loadRecentFuelEntries(currentTripTruckNumber); // Refresh table

        } catch (error) {
            console.error('Error saving fuel entry:', error);
            alert('Error saving fuel entry: ' + error.message);
        }
    });

    // Trip Details Calculations

    function calculateTotalKm() {
      const start = parseFloat(document.getElementById('tripStartingKm').value) || 0;
      const end = parseFloat(document.getElementById('tripEndingKm').value) || 0;
      const totalKm = Math.max(0, end - start);
      document.getElementById('tripTotalKm').value = totalKm.toFixed(2);
      calculateFuelUsed();
    }

    function calculateFuelUsed() {
      const totalKm = parseFloat(document.getElementById('tripTotalKm').value) || 0;
      const avg = parseFloat(document.getElementById('tripVehicleAverage').value) || 0;
      const fuelUsed = avg > 0 ? (totalKm / avg) : 0;
      // **FIXED**: Make sure this is still calculated even if the input is made readonly.
      document.getElementById('tripFuelUsedLiters').value = fuelUsed.toFixed(2);
      calculateFuelAmount();
    }
    
    function calculateFuelAmount() {
      const liters = parseFloat(document.getElementById('tripFuelUsedLiters').value) || 0;
      const rate = parseFloat(document.getElementById('tripDieselRatePerLiter').value) || 0;
      // This function's main purpose is to trigger calculateTripTotals()
      calculateTripTotals();
    }

    function calculateTripBillingAmount() {
      const weight = currentTripWeight || 0;
      const rate = parseFloat(document.getElementById('tripBillingRate').value) || 0;
      document.getElementById('tripBillingAmount').value = (weight * rate).toFixed(2);
      calculateTripTotals();
    }

    function calculateTripBillingRate() {
      const weight = currentTripWeight || 0;
      const amount = parseFloat(document.getElementById('tripBillingAmount').value) || 0;
      if (weight > 0) {
        document.getElementById('tripBillingRate').value = (amount / weight).toFixed(2);
      }
      calculateTripTotals();
    }

    function calculateTripFreightAmount() {
      const weight = currentTripWeight || 0;
      const rate = parseFloat(document.getElementById('tripFreightRate').value) || 0;
      document.getElementById('tripFreightAmount').value = (weight * rate).toFixed(2);
      calculateTripTotals();
    }

    function calculateTripFreightRate() {
      const weight = currentTripWeight || 0;
      const amount = parseFloat(document.getElementById('tripFreightAmount').value) || 0;
      if (weight > 0) {
        document.getElementById('tripFreightRate').value = (amount / weight).toFixed(2);
      }
      calculateTripTotals();
    }

    // **UPDATED** to calculate totals from generic expense containers
    function calculateTripTotals() {
        const billingAmount = parseFloat(document.getElementById('tripBillingAmount').value) || 0;
        const freightAmount = parseFloat(document.getElementById('tripFreightAmount').value) || 0;
        const advance = parseFloat(document.getElementById('tripAdvance').value) || 0;
        const shortage = parseFloat(document.getElementById('tripShortage').value) || 0;
        const billingRate = currentTripWeight > 0 ? (billingAmount / currentTripWeight) : 0;
        
        const cgstP = parseFloat(document.getElementById('tripCgstPercentage').value) || 0;
        const sgstP = parseFloat(document.getElementById('tripSgstPercentage').value) || 0;
        
        // Calculate Generic Expenses from the container (includes all categories)
        let genericE = 0;
        document.querySelectorAll('#tripGenericExpensesContainer .expense-amount').forEach(input => {
            genericE += parseFloat(input.value) || 0;
        });
        document.getElementById('tripTotalExpensesDisplay').textContent = `₹${genericE.toFixed(2)}`;

        let emptyGenericE = 0;
        document.querySelectorAll('#emptyTripGenericExpensesContainer .expense-amount').forEach(input => {
            emptyGenericE += parseFloat(input.value) || 0;
        });
        document.getElementById('emptyTripTotalExpensesDisplay').textContent = `₹${emptyGenericE.toFixed(2)}`;
        
        // Tax Calculations
        const cgstAmount = (billingAmount * cgstP) / 100;
        const sgstAmount = (billingAmount * sgstP) / 100;
        
        const totalBillingAmount = billingAmount + cgstAmount + sgstAmount;
        document.getElementById('tripTotalBillingAmount').value = totalBillingAmount.toFixed(2);

        // Total Expenses & Driver Payable
        // Total expenses = sum of all generic expense amounts (both trip and empty)
        const totalExpenses = genericE + emptyGenericE + advance; // Includes Advance in total expense
        document.getElementById('tripTotalExpenses').value = totalExpenses.toFixed(2);

        const oldDriverPayable = freightAmount - advance; 
        document.getElementById('tripDriverPayable').value = oldDriverPayable.toFixed(2);
        
        // Client Balance
        const shortageDeduction = (shortage / 1000) * billingRate;
        // **FIX**: Client balance should be based on the pre-GST billing amount.
        const clientBalance = billingAmount - advance - shortageDeduction;
        document.getElementById('tripClientBalance').value = clientBalance.toFixed(2); // This now reflects live changes correctly.
    }

    // Save Trip Details
    document.getElementById('saveTripDetailsBtn').addEventListener('click', async () => {
      if (!currentTripLRId || !currentCoreAccountId) {
        alert('Error: LR not selected.');
        return;
      }
      
      const isMarketVehicle = (await db.ref(`users/${currentCoreAccountId}/lrReports/${currentTripLRId}/lrType`).once('value')).val() === 'market';
      const endingKm = parseFloat(document.getElementById('tripEndingKm').value) || 0;
      const startingKm = parseFloat(document.getElementById('tripStartingKm').value) || 0;
      const fuelUsedLiters = parseFloat(document.getElementById('tripFuelUsedLiters').value) || 0;
      const vehicleNumber = currentTripTruckNumber;

      // Validation for Own Vehicles
      if (!isMarketVehicle) {
          if (endingKm === 0) {
              alert('Please enter a valid Ending KM.');
              return;
          }
          if (endingKm < startingKm) {
              alert('Ending KM cannot be less than Starting KM.');
              return;
          }
          // NOTE: fuelUsedLiters validation removed as zero is acceptable if the tank was full/trip was short.
      }

      // Collect Generic Expenses (Main Trip)
      const genericExpenses = [];
      document.querySelectorAll('#tripGenericExpensesContainer .expense-row').forEach(div => {
        const type = div.querySelector('.expense-type').value;
        const note = div.querySelector('.expense-note').value;
        const amount = parseFloat(div.querySelector('.expense-amount').value) || 0;
        if (amount > 0) {
          const expenseData = { type, note, amount, date: div.querySelector('.expense-date').value };
          // **NEW**: If it's vehicle work, also save the vendorId
          if (type === 'Vehicle Work') {
            const vendorSelect = div.querySelector('.expense-vendor');
            if (vendorSelect) expenseData.vendorId = vendorSelect.value;
          }
          genericExpenses.push(expenseData);
        }
      });

      // Collect Generic Expenses (Empty Trip)
      const emptyGenericExpenses = [];
      document.querySelectorAll('#emptyTripGenericExpensesContainer .expense-row').forEach(div => {
        const type = div.querySelector('.expense-type').value;
        const note = div.querySelector('.expense-note').value;
        const amount = parseFloat(div.querySelector('.expense-amount').value) || 0;
        if (amount > 0) {
          const expenseData = { type, note, amount, date: div.querySelector('.expense-date').value };
          // **NEW**: If it's vehicle work, also save the vendorId
          if (type === 'Vehicle Work') {
            const vendorSelect = div.querySelector('.expense-vendor');
            if (vendorSelect) expenseData.vendorId = vendorSelect.value;
          }
          emptyGenericExpenses.push(expenseData);
        }
      });
      
      // **NEW LOGIC: Aggregate generic expenses into separate fields**
      const aggregateExpenses = (expensesArray) => {
          const aggregated = {
              tyreExpenses: 0,
              tollExpenses: 0,
              foodExpenses: 0,
              loadingUnloadingExpenses: 0,
              policeChallanExpenses: 0,
              tacExpenses: 0,
              permitExpenses: 0,
              brokerageExpenses: 0,
              vehicleWorkAmount: 0,
              commissionExpenses: 0,
              tirpalRopeExpenses: 0,
              otherExpenses: 0,
          };
          expensesArray.forEach(exp => {
              switch (exp.type) {
                  case 'Tyre': aggregated.tyreExpenses += exp.amount; break;
                  case 'Toll': aggregated.tollExpenses += exp.amount; break;
                  case 'Food': aggregated.foodExpenses += exp.amount; break;
                  case 'Loading/Unloading': aggregated.loadingUnloadingExpenses += exp.amount; break;
                  case 'Police Challan': aggregated.policeChallanExpenses += exp.amount; break;
                  case 'TAC': aggregated.tacExpenses += exp.amount; break;
                  case 'Permit': aggregated.permitExpenses += exp.amount; break;
                  case 'Brokerage': aggregated.brokerageExpenses += exp.amount; break;
                  case 'Vehicle Work': aggregated.vehicleWorkAmount += exp.amount; break;
                  case 'Commission': aggregated.commissionExpenses += exp.amount; break;
                  case 'Tirpal & Rope': aggregated.tirpalRopeExpenses += exp.amount; break;
                  case 'Other': aggregated.otherExpenses += exp.amount; break;
              }
          });
          return aggregated;
      };
      
      const tripAggregated = aggregateExpenses(genericExpenses);
      const emptyTripAggregated = aggregateExpenses(emptyGenericExpenses);
      // **END NEW LOGIC**

      // Recalculate totals before saving to ensure correctness
      calculateTripTotals();

      const tripDetails = {
        // Billing, Freight & Advance
        billingRate: parseFloat(document.getElementById('tripBillingRate').value) || 0,
        billingAmount: parseFloat(document.getElementById('tripBillingAmount').value) || 0,
        freightRate: parseFloat(document.getElementById('tripFreightRate').value) || 0,
        freightAmount: parseFloat(document.getElementById('tripFreightAmount').value) || 0,
        advance: parseFloat(document.getElementById('tripAdvance').value) || 0,
        shortage: parseFloat(document.getElementById('tripShortage').value) || 0,
        commission: parseFloat(document.getElementById('tripCommission').value) || 0, 
        
        // KM & Fuel Tracking
        startingKm: startingKm,
        endingKm: endingKm,
        totalKm: parseFloat(document.getElementById('tripTotalKm').value) || 0,
        vehicleAverage: parseFloat(document.getElementById('tripVehicleAverage').value) || 0,
        fuelUsedLiters: fuelUsedLiters,
        dieselRatePerLiter: parseFloat(document.getElementById('tripDieselRatePerLiter').value) || 0,
        
        // **UPDATED: Saved aggregated expenses**
        ...tripAggregated,
        genericExpenses: genericExpenses, // Keep raw array
        
        // Taxes and Totals
        cgstPercentage: parseFloat(document.getElementById('tripCgstPercentage').value) || 9,
        sgstPercentage: parseFloat(document.getElementById('tripSgstPercentage').value) || 9,
        
        totalBillingAmount: parseFloat(document.getElementById('tripTotalBillingAmount').value) || 0,
        totalExpenses: parseFloat(document.getElementById('tripTotalExpenses').value) || 0,
        driverPayable: parseFloat(document.getElementById('tripDriverPayable').value) || 0,
        clientBalance: parseFloat(document.getElementById('tripClientBalance').value) || 0,
        updatedAt: new Date().toISOString()
      };
      
      // Separate structure for empty trip data
      const emptyTripData = {
          emptyTrip: (emptyGenericExpenses.length > 0) || false,
          ...emptyTripAggregated,
          genericExpenses: emptyGenericExpenses, // Keep raw array
          updatedAt: new Date().toISOString()
      };


      try {
        // 1. Update the LR report with trip details and empty trip data
        const lrRef = db.ref(`users/${currentCoreAccountId}/lrReports/${currentTripLRId}`);
        await lrRef.update({
            tripDetails: tripDetails,
            emptyTripData: emptyTripData,
            emptyTrip: emptyTripData.emptyTrip // Flag on the root
        });

        // **NEW**: Update the vehicle's lastEndingKm and log fuel usage (for own vehicles only)
        if (!isMarketVehicle && endingKm > 0) {
            const vehicleQuery = db.ref(`users/${currentCoreAccountId}/vehicles`).orderByChild('vehicleNumber').equalTo(vehicleNumber);
            const vehicleSnap = await vehicleQuery.once('value');
            if (vehicleSnap.exists()) {
                const vehicleId = Object.keys(vehicleSnap.val())[0];
                const vehicleUpdateRef = db.ref(`users/${currentCoreAccountId}/vehicles/${vehicleId}`);

                const updates = { lastEndingKm: endingKm };
                
                // --- FUEL DEDUCTION LOGIC ---
                if (fuelUsedLiters > 0) {
                    const vRef = db.ref(`users/${currentCoreAccountId}/vehicles/${vehicleId}`);
                    const curSnap = await vRef.child('currentFuel').once('value');
                    const before = parseFloat(curSnap.val()) || 0;
                    // Ensure the vehicle exists before updating fuel
                    const vehicleData = allVehicles.find(v => v.id === vehicleId);

                    // Check if the current fuel is enough for the deduction
                    if (before < fuelUsedLiters) {
                        // Log a warning, but still proceed with maximum possible deduction
                        console.warn(`Attempted to deduct ${fuelUsedLiters.toFixed(2)}L but only ${before.toFixed(2)}L available in tank. Setting tank to 0L.`);
                    }

                    const after = Math.max(before - fuelUsedLiters, 0);
                    updates.currentFuel = after;

                    // Log fuel usage
                    await db.ref(`users/${currentCoreAccountId}/fuelLogs`).push({
                      timestamp: new Date().toISOString(),
                      source: 'lr-detail-usage',
                      lrNumber: document.getElementById('modalLrNumber').textContent,
                      usedLiters: fuelUsedLiters,
                      vehicleAverageKmPerL: tripDetails.vehicleAverage,
                      totalKm: tripDetails.totalKm,
                      beforeLiters: before,
                      afterLiters: after,
                      truckNumber: vehicleNumber,
                      userId: auth.currentUser.uid,
                      coreAccountId: currentCoreAccountId,
                    });
                }
                // --- END FUEL DEDUCTION LOGIC ---

                await vehicleUpdateRef.update(updates);
                console.log(`Updated lastEndingKm and Fuel for ${vehicleNumber}`);
            }
        }


        // 2. Log vehicle work payment (if applicable) - only for main trip for now
        if (tripDetails.vehicleWorkAmount > 0) {
            const lrSnap = await lrRef.once('value');
            const lr = lrSnap.val() || {};
            const workData = {
                amount: tripDetails.vehicleWorkAmount,
                date: lr.date,
                notes: `Work for LR No: ${lr.lrNumber} (Trip Expense)`,
                userId: auth.currentUser.uid,
                createdAt: new Date().toISOString(),
                lrId: currentTripLRId,
                lrNumber: lr.lrNumber,
                truckNumber: lr.truckNumber
            };
            await db.ref(`users/${currentCoreAccountId}/workPayments`).push(workData);
        }
        
        
        alert('Trip details saved and all related entries logged successfully!');
        const tripModal = bootstrap.Modal.getInstance(document.getElementById('tripDetailsModal'));
        tripModal.hide();
        loadLRData(); // Refresh the main table
        
      } catch (error) {
        console.error('Error saving trip details:', error);
        alert('Error saving trip details: ' + error.message);
      }
    });

    // --- DATATABLE AND INITIALIZATION ---

    // Hook Add tab to auto-generate when user opens the form
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize DataTable
      lrTable = $('#lrTable').DataTable({
        pageLength: 10,
        order: [[1, 'desc']] // Sort by date descending
      });
      // **NEW**: Initialize Market LR DataTable
      marketLrTable = $('#marketLrTable').DataTable({
        pageLength: 10,
        order: [[1, 'desc']]
      });

      const addTab = document.querySelector('a[data-bs-toggle="tab"][href="#add"]');
      if (addTab) {
        addTab.addEventListener('shown.bs.tab', () => {
          // Generate values and placeholders when Add tab is shown
          applyAutoGenerationSettings();
          const d = document.getElementById('lrDate');
          if (d && !d.value) d.value = new Date().toISOString().split('T')[0];
        });
      }
      // Regenerate numbers when date changes (optional)
      const addDate = document.getElementById('lrDate');
      if (addDate) {
        addDate.addEventListener('change', () => {
          if (autoSettings.lrNo) generateLRNumber(document.getElementById('lrNumber'));
          if (autoSettings.invoiceNo) generateRandomNumber(document.getElementById('invoiceNumberInput'), 'INV');
          if (autoSettings.shipmentNo) generateRandomNumber(document.getElementById('shipmentNo'), 'SHP');
          if (autoSettings.orderNo) generateRandomNumber(document.getElementById('orderNo'), 'ORD');
          if (autoSettings.deliveryNo) generateRandomNumber(document.getElementById('deliveryNo'), 'DLV');
        });
      }
    });

    // **NEW**: Event listener for quick add transporter form submission
    // document.getElementById('quickAddTransporterForm').addEventListener('submit', saveNewTransporterFromModal);


    // Load LR Data (Updated to include + button)
    function loadLRData() {
      // ... (Filtering logic remains the same) ...
      
      const lrRef = db.ref(`users/${currentCoreAccountId}/lrReports`);
      lrRef.on('value', async (snapshot) => {
        if (lrTable) lrTable.clear();
        if (marketLrTable) marketLrTable.clear(); // **NEW**
        selectedLRs = [];
        
        // **NEW**: Fetch clients once to resolve names
        const clientsSnap = await db.ref(`users/${auth.currentUser.uid}/clients`).once('value');
        const clients = clientsSnap.val() || {};
        const getClientName = (id) => clients[id]?.clientName || 'N/A';

        snapshot.forEach((childSnapshot) => {
          const lr = childSnapshot.val();
          const lrId = childSnapshot.key;
          
          if (lr.status === 'invoiced') return; // Skip invoiced LRs

          const details = lr.tripDetails || {};
          const emptyDetails = lr.emptyTripData || {};
          const totalExpenses = (details.tyreExpenses || 0) + (details.tollExpenses || 0) + (details.foodExpenses || 0) + (details.loadingUnloadingExpenses || 0) + (details.policeChallanExpenses || 0) + (details.tacExpenses || 0) + (details.permitExpenses || 0) + (details.brokerageExpenses || 0) + (details.vehicleWorkAmount || 0) + (details.commissionExpenses || 0) + (details.tirpalRopeExpenses || 0) + (details.otherExpenses || 0) + (details.fuelUsedLiters || 0) + (details.advance || 0) + (details.billingAmount || 0) +
                                (emptyDetails.tyreExpenses || 0) + (emptyDetails.tollExpenses || 0) + (emptyDetails.foodExpenses || 0) + (emptyDetails.loadingUnloadingExpenses || 0) + (emptyDetails.policeChallanExpenses || 0) + (emptyDetails.tacExpenses || 0) + (emptyDetails.permitExpenses || 0) + (emptyDetails.brokerageExpenses || 0) + (emptyDetails.vehicleWorkAmount || 0) + (emptyDetails.commissionExpenses || 0) + (emptyDetails.tirpalRopeExpenses || 0) + (emptyDetails.otherExpenses || 0);

          const detailsExist = totalExpenses > 0 || (details.genericExpenses && details.genericExpenses.length > 0) || (emptyDetails.genericExpenses && emptyDetails.genericExpenses.length > 0);
          const detailButtonClass = detailsExist ? 'btn-success' : 'btn-warning';
          const detailButtonIcon = detailsExist ? 'fas fa-check' : 'fas fa-plus';
          const detailButtonTitle = detailsExist ? 'View/Edit Trip Details' : 'Add Trip Details';
          const displayStatus = detailsExist ? 'Completed' : 'Active';
          const displayStatusClass = detailsExist ? 'bg-success' : 'bg-info';
          
          // **NEW**: Logic to separate LRs into two tables
          if (lr.lrType === 'market_company') {
            marketLrTable.row.add([
              `<div class="form-check">
                 <input class="form-check-input market-lr-checkbox" type="checkbox" value="${lrId}" onchange="toggleLRSelection('${lrId}', this.checked, true)">
               </div>`,
              lr.date,
              lr.lrNumber,
              lr.truckNumber,
              lr.transporterCompany || 'N/A', // **NEW**: Display transporter company name
              lr.item || 'N/A',
              lr.fromLocation,
              lr.toLocation,
              lr.weight,
              `<button class="btn btn-sm ${detailButtonClass}" onclick="showTripDetailsModal('${lrId}', '${lr.lrNumber}', ${lr.weight}, '${lr.truckNumber}', '${lr.driverName || 'N/A'}')" title="${detailButtonTitle}">
                 <i class="${detailButtonIcon}"></i>
               </button>`,
              `<span class="badge ${displayStatusClass}">${displayStatus}</span>`,
              `<button class="btn btn-sm btn-outline-info" onclick="showLRCopy('${lrId}')" title="View LR Copy">
                 <i class="fas fa-print"></i>
               </button>`,
              `<button class="btn btn-sm btn-outline-primary" onclick="editLR('${lrId}')">
                 <i class="fas fa-edit"></i>
               </button>
               <button class="btn btn-sm btn-outline-danger" onclick="deleteLR('${lrId}')">
                 <i class="fas fa-trash"></i>
               </button>`
            ]);
          } else { // Own vehicle LRs
            const consignorName = getClientName(lr.clientId);
            const consigneeName = getClientName(lr.consigneeId) || consignorName;

            lrTable.row.add([
              `<div class="form-check">
                 <input class="form-check-input lr-checkbox" type="checkbox" value="${lrId}" onchange="toggleLRSelection('${lrId}', this.checked, false)">
               </div>`,
              lr.date,
              lr.lrNumber,
              lr.truckNumber,
              consignorName,
              consigneeName,
              lr.item || 'N/A',
              lr.fromLocation,
              lr.toLocation,
              lr.weight,
              `<button class="btn btn-sm ${detailButtonClass}" onclick="showTripDetailsModal('${lrId}', '${lr.lrNumber}', ${lr.weight}, '${lr.truckNumber}', '${lr.driverName || 'N/A'}')" title="${detailButtonTitle}">
                 <i class="${detailButtonIcon}"></i>
               </button>`,
              `<span class="badge ${displayStatusClass}">${displayStatus}</span>`,
              `<button class="btn btn-sm btn-outline-info" onclick="showLRCopy('${lrId}')" title="View LR Copy">
                 <i class="fas fa-print"></i>
               </button>`,
              `<button class="btn btn-sm btn-outline-primary" onclick="editLR('${lrId}')">
                 <i class="fas fa-edit"></i>
               </button>
               <button class="btn btn-sm btn-outline-danger" onclick="deleteLR('${lrId}')">
                 <i class="fas fa-trash"></i>
               </button>`
            ]);
          }
        });
        
        if (lrTable) lrTable.draw();
        if (marketLrTable) marketLrTable.draw(); // **NEW**
        updateInvoiceButtonStates();
      });
    }

    // Edit LR (Streamlined)
    function editLR(lrId) {
      currentEditingLRId = lrId;
      if (!currentCoreAccountId) { alert("Error: Cannot determine the account to fetch data from. Please reload."); return; }
      const lrRef = db.ref(`users/${currentCoreAccountId}/lrReports/${lrId}`);
      
      lrRef.once('value').then((snapshot) => {
        const lr = snapshot.val();
        
        // **NEW**: Handle market vehicle toggle in edit modal
        const isMarketVehicle = lr.lrType === 'market';
        document.getElementById('editVehicleTypeToggle').checked = isMarketVehicle;
        toggleEditVehicleInput(isMarketVehicle); // Show/hide correct fields

        // Populate edit form
        document.getElementById('editLrDate').value = lr.date;
        document.getElementById('editLrNumber').value = lr.lrNumber || '';
        document.getElementById('editInvoiceNumberInput').value = lr.invoiceNumber || '';
        document.getElementById('editDeliveryNo').value = lr.deliveryNo || '';
        document.getElementById('editOrderNo').value = lr.orderNo || '';
        document.getElementById('editClientId').value = lr.clientId; // Use clientId

        // **NEW**: Populate correct vehicle and driver fields based on type
        if (isMarketVehicle) {
          document.getElementById('editMarketTruckNumber').value = lr.truckNumber;
          document.getElementById('editMarketDriverName').value = lr.driverName || '';
        } else {
          // Clear market fields if it's an own vehicle
          document.getElementById('editMarketTruckNumber').value = '';
          document.getElementById('editMarketDriverName').value = '';
          document.getElementById('editTruckNumber').value = lr.truckNumber;
          // Set timeout to ensure driver dropdown is populated before setting value
          setTimeout(() => { document.getElementById('editDriverSelect').value = lr.driverName || ''; }, 100);
        }

        // Note: The edit modal doesn't have a separate consignee dropdown, it uses a text field.
        // **NEW**: Set transporter on edit
        document.getElementById('editTransporterSelect').value = lr.transporterId || '';
        document.getElementById('editConsigneeId').value = lr.consigneeId || '';
        document.getElementById('editRouteSelect').value = lr.routeId || '';

        document.getElementById('editNumPackages').value = lr.numPackages || '';
        document.getElementById('editWeightPerPackage').value = lr.weightPerPackage || '';
        document.getElementById('editWeight').value = lr.weight;
        document.getElementById('editShipmentNo').value = lr.shipmentNo || ''; // Corrected
        document.getElementById('editItem').value = lr.item || '';
        // Note: ShipmentNo logic in the simplified form will use editShipmentNo if a field is added.
        
        // Apply auto-generation placeholders/values for empty edit fields
        applyEditAutoGenerationSettings();
        // Show modal
        const editModal = new bootstrap.Modal(document.getElementById('editLRModal'));
        editModal.show();
      });
    }

    // Update LR (Streamlined)
    document.getElementById('updateLRBtn').addEventListener('click', async () => {
      const form = document.getElementById('editLrForm'); // Corrected from editLrForm
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const editRouteSelect = document.getElementById('editRouteSelect');
      const selectedEditRoute = editRouteSelect ? editRouteSelect.options[editRouteSelect.selectedIndex] : null;
      const editFromLoc = selectedEditRoute ? (selectedEditRoute.dataset.from || '') : '';
      const editToLoc = selectedEditRoute ? (selectedEditRoute.dataset.to || '') : '';
      const routeDistance = selectedEditRoute && selectedEditRoute.dataset && selectedEditRoute.dataset.distance ? parseFloat(selectedEditRoute.dataset.distance) || 0 : 0;
      
      // **NEW**: Get data based on vehicle type toggle
      const isMarketVehicle = document.getElementById('editVehicleTypeToggle').checked;
      const truckNumber = isMarketVehicle ? document.getElementById('editMarketTruckNumber').value : document.getElementById('editTruckNumber').value;
      const driverName = isMarketVehicle ? document.getElementById('editMarketDriverName').value : document.getElementById('editDriverSelect').value;
      const transporterSelect = document.getElementById('editTransporterSelect'); // Get the select element
      const transporterId = !isMarketVehicle ? transporterSelect.value : null; // Transporter is only for own vehicles
      const transporterName = !isMarketVehicle && transporterSelect.value ? transporterSelect.options[transporterSelect.selectedIndex].dataset.name : null;

      const vehicle = allVehicles.find(v => (v.vehicleNo || '').toUpperCase() === truckNumber.toUpperCase() && v.driverName === driverName);
      
      const lrUpdateData = {
        date: document.getElementById('editLrDate').value,
        lrNumber: document.getElementById('editLrNumber').value,
        lrType: isMarketVehicle ? 'market' : (transporterId ? 'market_company' : 'own'),
        transporterId: transporterId,
        transporterCompany: transporterName,
        routeId: document.getElementById('editRouteSelect').value, // **FIX**: Save routeId on update
        invoiceNumber: document.getElementById('editInvoiceNumberInput').value,
        deliveryNo: document.getElementById('editDeliveryNo').value,
        orderNo: document.getElementById('editOrderNo').value,
        truckNumber: truckNumber,
        driverName: driverName,
        truckId: vehicle ? vehicle.id : null,
        clientId: document.getElementById('editClientId').value, // Use clientId
        fromLocation: editFromLoc,
        toLocation: editToLoc,
        routeDistanceKm: routeDistance,
        numPackages: parseFloat(document.getElementById('editNumPackages').value) || 0,
        weightPerPackage: parseFloat(document.getElementById('editWeightPerPackage').value) || 0,
        weight: parseFloat(document.getElementById('editWeight').value) || 0,
        consigneeId: document.getElementById('editConsigneeId').value,
        shipmentNo: document.getElementById('editShipmentNo').value,
        item: document.getElementById('editItem').value,
        updatedAt: new Date().toISOString()
      };

      if (!currentCoreAccountId) { alert('Error: Core account ID not found. Cannot update LR.'); return; }
      
      const lrRef = db.ref(`users/${currentCoreAccountId}/lrReports/${currentEditingLRId}`);

      try {
        const snapshot = await lrRef.once('value');
        const existingLR = snapshot.val();
        const existingTripDetails = existingLR.tripDetails || {};
        const newWeight = lrUpdateData.weight;

        // Check if weight has changed and if rates exist to perform recalculation
        if (existingLR.weight !== newWeight && existingTripDetails.billingRate > 0) {
          console.log("Weight changed. Recalculating trip financials...");

          const newBillingAmount = newWeight * (existingTripDetails.billingRate || 0);
          const newFreightAmount = newWeight * (existingTripDetails.freightRate || 0);
          
          const cgstPercentage = existingTripDetails.cgstPercentage || 9;
          const sgstPercentage = existingTripDetails.sgstPercentage || 9;

          const newCgstAmount = (newBillingAmount * cgstPercentage) / 100;
          const newSgstAmount = (newBillingAmount * sgstPercentage) / 100;
          const newTotalBillingAmount = newBillingAmount + newCgstAmount + newSgstAmount;

          // Update the tripDetails object
          lrUpdateData.tripDetails = {
            ...existingTripDetails, // Preserve other details
            billingAmount: newBillingAmount,
            freightAmount: newFreightAmount,
            cgstAmount: newCgstAmount,
            sgstAmount: newSgstAmount,
            totalBillingAmount: newTotalBillingAmount,
            updatedAt: new Date().toISOString()
          };
        }

        // Perform the update
        await lrRef.update(lrUpdateData);

        alert('LR updated successfully!');
        const editModal = bootstrap.Modal.getInstance(document.getElementById('editLRModal'));
        editModal.hide();
        loadLRData();

      } catch (error) {
        console.error('Error updating LR:', error);
        alert('Error updating LR. Please try again.');
      }
    });

    // --- UTILITIES (Routinely used functions from original file) ---

    function updateTruckFilterDropdown() {
      const truckFilter = document.getElementById('truckFilter');
      if (!truckFilter) return;
      
      const currentValue = truckFilter.value;
      truckFilter.innerHTML = '<option value="">All Trucks</option>';
      const uniqueVehicles = [...new Set(allVehicles.map(v => v.vehicleNumber))].filter(Boolean);
      
      uniqueVehicles.sort().forEach(vehicleNo => {
        const option = document.createElement('option');
        option.value = vehicleNo;
        option.textContent = vehicleNo;
        truckFilter.appendChild(option);
      });
      if (currentValue && uniqueVehicles.includes(currentValue)) truckFilter.value = currentValue;
    }
    function searchVehicles(query) { /* ... (same as original) ... */ }
    function searchEditVehicles(query) { /* ... (same as original) ... */ }
    
    // **FIXED**: Implemented checkbox selection logic
    let selectedMarketLRs = []; // **NEW**

    function toggleLRSelection(lrId, isChecked, isMarket) {
      if (isChecked) {
        if (isMarket) {
          if (!selectedMarketLRs.includes(lrId)) selectedMarketLRs.push(lrId);
        } else {
          if (!selectedLRs.includes(lrId)) selectedLRs.push(lrId);
        }
      } else {
        if (isMarket) {
          selectedMarketLRs = selectedMarketLRs.filter(id => id !== lrId);
        } else {
          selectedLRs = selectedLRs.filter(id => id !== lrId);
        }
      }
      updateInvoiceButtonStates();
      updateSelectAllCheckboxes();
    }

    function updateInvoiceButtonStates() {
      document.getElementById('generateInvoiceBtn').disabled = selectedLRs.length === 0;
      document.getElementById('generateMarketInvoiceBtn').disabled = selectedMarketLRs.length === 0;
    }

    function updateSelectAllCheckboxes() {
      const allOwnCheckboxes = document.querySelectorAll('.lr-checkbox');
      const allMarketCheckboxes = document.querySelectorAll('.market-lr-checkbox');
      const selectAllOwn = document.getElementById('selectAllCheckbox');
      const selectAllMarket = document.getElementById('selectAllMarketCheckbox');

      if (selectAllOwn) {
        const allOwnChecked = allOwnCheckboxes.length > 0 && selectedLRs.length === allOwnCheckboxes.length;
        selectAllOwn.checked = allOwnChecked;
        selectAllOwn.indeterminate = selectedLRs.length > 0 && !allOwnChecked;
      }
      if (selectAllMarket) {
        const allMarketChecked = allMarketCheckboxes.length > 0 && selectedMarketLRs.length === allMarketCheckboxes.length;
        selectAllMarket.checked = allMarketChecked;
        selectAllMarket.indeterminate = selectedMarketLRs.length > 0 && !allMarketChecked;
      }
    }

    function toggleSelectAll(isMarket = false) {
      if (isMarket) {
        const selectAllMarketCheckbox = document.getElementById('selectAllMarketCheckbox');
        const allMarketCheckboxes = document.querySelectorAll('.market-lr-checkbox');
        const isChecked = selectAllMarketCheckbox.checked;
        allMarketCheckboxes.forEach(checkbox => {
          checkbox.checked = isChecked;
          toggleLRSelection(checkbox.value, isChecked, true);
        });
      } else {
        const selectAllOwnCheckbox = document.getElementById('selectAllCheckbox');
        const allOwnCheckboxes = document.querySelectorAll('.lr-checkbox');
        const isChecked = selectAllOwnCheckbox.checked;
        allOwnCheckboxes.forEach(checkbox => {
          checkbox.checked = isChecked;
          toggleLRSelection(checkbox.value, isChecked, false);
        });
      }
    }

    async function showLRCopy(lrId) {
      const user = auth.currentUser;
      if (!user) return;

      const lrRef = db.ref(`users/${currentCoreAccountId}/lrReports/${lrId}`);
      const profileRef = db.ref(`users/${user.uid}/profile`);

      try {
        const [lrSnapshot, profileSnapshot] = await Promise.all([
          lrRef.once('value'),
          profileRef.once('value')
        ]);

        if (!lrSnapshot.exists()) { alert('LR data not found.'); return; }
        
        const lr = lrSnapshot.val();
        const profile = profileSnapshot.exists() ? profileSnapshot.val() : {};
        const ownerName = profile.ownerName || 'N/A';
        const companyLogoUrl = profile.companyLogoUrl || '';
        
        // **FIX**: Get freight details from the tripDetails object
        const tripDetails = lr.tripDetails || {};

        const companyName = profile.transportName || 'Transvortex Logistics';
        const companyAddress = `${profile.address || ''}, ${profile.city || ''} - ${profile.pincode || ''}`;
        const companyPhone = profile.phoneNumber || 'N/A';
        const companyGstin = profile.gstin || 'N/A';

        const vehicle = allVehicles.find(v => (v.vehicleNo || v.vehicleNumber) === lr.truckNumber);
        if (!vehicle) {
          console.warn(`Vehicle ${lr.truckNumber} not found in master list.`);
        }
        const driverName = vehicle ? vehicle.driverName : (lr.driverName || 'N/A');
        const driverContact = vehicle ? vehicle.contactNumber : 'N/A';
        const client = allClients.find(c => c.id === lr.clientId) || {};

        const lrCopyContent = `
          <div class="lr-copy-container printable-area" id="lr-pdf-content">
            <div class="lr-header lr-header-content">
              ${companyLogoUrl ? `<img src="${companyLogoUrl}" alt="Logo" class="logo-on-print" style="max-height: 60px; max-width: 150px;">` : ''}
              <div>
                <h4>${companyName}</h4>
                <p>Authorized transport contractor of ${client.clientName || client.name || 'To be billed'}</p>
                <p>Address: ${profile.address || 'N/A'}, City: ${profile.city || 'N/A'}, Pincode: ${profile.pincode || 'N/A'}</p>
                <p>GSTIN: ${companyGstin} | Phone: ${companyPhone}</p>
              </div>
            </div>
            
            <div class="lr-info">
              <div class="lr-info-left">
                <div class="lr-row">From: <strong>${lr.fromLocation || 'N/A'}</strong></div>
                <div class="lr-row">Consignor: <strong>${client.clientName || client.name || 'To be billed'}</strong></div>
                <div class="lr-row">Consignee: <strong>${(allClients.find(c => c.id === lr.consigneeId) || {}).clientName || (allClients.find(c => c.id === lr.consigneeId) || {}).name || client.clientName || client.name || 'N/A'}</strong></div>
                <div class="lr-row">GSTIN: <strong>${client.gstin || 'N/A'}</strong></div>
                <div class="lr-row">Order No: <strong>${lr.orderNo || 'N/A'}</strong></div>
                <div class="lr-row">Delivery No: <strong>${lr.deliveryNo || 'N/A'}</strong></div>
              </div>
              <div class="lr-info-right">
                <div class="lr-row">LR No: <strong>${lr.lrNumber || 'N/A'}</strong></div>
                <div class="lr-row">Date: <strong>${lr.date || 'N/A'}</strong></div>
                <div class="lr-row">Vehicle No: <strong>${lr.truckNumber || 'N/A'}</strong></div>
                <div class="lr-row">Truck Type: <strong>${vehicle ? vehicle.vehicleType || 'N/A' : 'N/A'}</strong></div>
                <div class="lr-row">Party Name: <strong>${client.clientName || client.name || 'To be billed'}</strong></div>
                <div class="lr-row">Invoice No: <strong>${lr.invoiceNumber || lr.invoiceNumberInput || lr.invoiceNo || 'N/A'}</strong></div>
                <div class="lr-row">Shipment No: <strong>${lr.shipmentNo || 'N/A'}</strong></div>
              </div>
            </div>
            
            <table class="lr-table">
              <thead>
                <tr>
                  <th>${(lr.numPackages && lr.numPackages > 0) ? 'No of Bags' : 'Type'}</th>
                  <th>Goods Description</th>
                  <th>Weight in MT</th>
                  <th>Rate</th>
                  <th>Freight</th>
                  <th>Value of Goods Rs.</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>${(lr.numPackages && lr.numPackages > 0) ? lr.numPackages : 'Loose'}</td>
                  <td>${lr.item || 'N/A'}</td>
                  <td>${lr.weight || 'N/A'}</td>
                  <td>${(tripDetails.freightRate && parseFloat(tripDetails.freightRate) > 0) ? `₹${parseFloat(tripDetails.freightRate).toFixed(2)}` : 'To be billed'}</td>
                  <td>${(tripDetails.freightAmount && tripDetails.freightAmount > 0) ? `₹${(parseFloat(tripDetails.freightAmount)).toFixed(2)}` : 'To be billed'}</td>
                  <td>₹${(lr.goodsValue || 0).toFixed(2)}</td>
                </tr>
              </tbody>
            </table>
            
            <div class="lr-row">Remarks: <strong>GIT TO BE PAID BY CONSIGNOR / GOODS TRANSPORTED BY ${client.clientName || client.name || 'N/A'}.</strong></div>
            <div class="lr-row">Driver Name: <strong>${driverName || 'N/A'}</strong></div>
            <div class="lr-row">Truck Owner: <strong>${ownerName || 'N/A'}</strong></div>
            <div class="lr-row">Driver Mobile Number: <strong>${driverContact}</strong></div>
            <div class="lr-row">Truck Type: <strong>${vehicle ? (vehicle.vehicleType || 'N/A') : 'N/A'}</strong></div>
            
            <div class="safety-section">
              <h5>Safety PPE(Personal Protective Equipment) Details</h5>
              <div class="lr-row">Helmet No: <strong>N/A</strong> | Jacket No: <strong>N/A</strong> | Shoes: No: <strong>N/A</strong> | Vehicle Approved By Logistic: <strong>No</strong></div>
            </div>
            
            <div class="receipt-section">
              <h5>Receipt of Goods</h5>
              <div class="lr-row">Order No: <strong>${lr.orderNo || 'N/A'}</strong> | Delivery No: <strong>${lr.deliveryNo || 'N/A'}</strong> | Shipment No: <strong>${lr.shipmentNo || 'N/A'}</strong> | Invoice No: <strong>${lr.invoiceNumber || lr.invoiceNumberInput || lr.invoiceNo || 'N/A'}</strong></div>
              <div class="lr-row">Truck No: <strong>${lr.truckNumber || 'N/A'}</strong> | LR No: <strong>${lr.lrNumber || 'N/A'}</strong></div>
              <div class="lr-row">Truck received at site at time: <strong>__________</strong> | Date and time of receipt: <strong>__________</strong></div>
              <div class="lr-row">Number of bags received: <strong>__________</strong> | Number of bags received short: <strong>__________</strong></div>
              <div class="lr-row">Condition of cement received: <strong>__________</strong> | Quantity of cement found wet or in book and at: <strong>__________</strong></div>
              <div class="lr-row">of damaged bag for which recovery to be made from transporter: <strong>__________</strong></div>
            </div>
            
            <div class="lr-footer">
              <div class="signature-box">
                <div class="signature-line">Signature and seal of Consignor</div>
              </div>
              <div class="signature-box">
                <div class="stamp-on-print" style="width: 150px; height: 150px; margin: 0 auto;">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200">
                    <defs>
                      <path id="topTextPath" fill="none" d="M 30,100 a 70,70 0 1,1 140,0" />
                      <path id="bottomTextPath" fill="none" d="M 30,100 a 70,70 0 1,0 140,0" />
                    </defs>
                    <g fill="#003366" stroke="#003366">
                      <circle cx="100" cy="100" r="95" stroke-width="3" fill="none"/>
                      <circle cx="100" cy="100" r="88" stroke-width="1.5" fill="none"/>
                      <text font-family="'Arial Black', 'Impact', sans-serif" font-size="15" letter-spacing="1.5">
                    
                        <textPath xlink:href="#topTextPath" startOffset="50%" text-anchor="middle">${companyName.toUpperCase()}</textPath>
                      </text>
                      <text font-family="'Arial Black', 'Impact', sans-serif" font-size="12" letter-spacing="1">
                        <textPath xlink:href="#bottomTextPath" startOffset="50%" text-anchor="middle">LOGISTICS & TRANSPORT SERVICE</textPath>
                      </text>
                      <g transform="translate(65, 75) scale(0.4)">
                        <path d="M15,1H4A2,2,0,0,0,2,3V16H1V18H3A3,3,0,0,0,6,21H8A3,3,0,0,0,11,18H21A3,3,0,0,0,24,15V11.5A4.5,4.5,0,0,0,19.5,7H15V1M6,19a1,1,0,1,1,1-1A1,1,0,0,1,6,19M8,19a1,1,0,1,1,1-1A1,1,0,0,1,8,19M19.5,9A2.5,2.5,0,0,1,22,11.5V15H15V9h4.5Z" fill="#003366" stroke="none"/>
                      </g>
                      <text x="100" y="125" font-family="'Arial', sans-serif" font-size="14" font-weight="bold" text-anchor="middle" letter-spacing="1">OFFICIAL SEAL</text>
                      <text x="100" y="145" font-family="'Arial', sans-serif" font-size="9" font-weight="normal" text-anchor="middle">GSTIN: ${companyGstin}</text>
                    </g>
                  </svg>
                </div>
              </div>
            </div>
          </div>
        `;

        document.getElementById('lrCopyContent').innerHTML = lrCopyContent;
        document.getElementById('lrCopyModalLabel').textContent = `${companyName} - Lorry Receipt`;
        const lrCopyModal = new bootstrap.Modal(document.getElementById('lrCopyModal'));
        lrCopyModal.show();

        // **NEW**: Add event listeners for print settings toggles
        document.getElementById('printLogoToggle').onchange = function() {
          document.querySelectorAll('.logo-on-print').forEach(el => el.classList.toggle('hidden-print', !this.checked));
        };
        document.getElementById('printStampToggle').onchange = function() {
          document.querySelectorAll('.stamp-on-print').forEach(el => el.classList.toggle('hidden-print', !this.checked));
        };


      } catch (error) {
        console.error('Error generating LR copy:', error);
        alert('Error loading LR details. Please try again.');
      }
    }

    async function downloadLRCopyPDF() {
      const { jsPDF } = window.jspdf;
      const content = document.getElementById('lr-pdf-content');
      if (!content) {
        alert('Could not find LR content to download.');
        return;
      }

      try {
        const canvas = await html2canvas(content, {
          scale: 2,
          useCORS: true
        });
        
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4'
        });

        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const imgProps = pdf.getImageProperties(imgData);
        const imgWidth = pdfWidth - 20;
        const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

        pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
        
        const lrNumberElement = content.querySelector('.lr-info-right .lr-row:nth-child(1) strong');
        const lrNumber = lrNumberElement ? lrNumberElement.textContent.trim() : 'LR_Copy';

        // **MODIFIED**: Add watermark based on the toggle setting
        const showWatermark = document.getElementById('printWatermarkToggle').checked;
        if (showWatermark) {
          const user = auth.currentUser;
          if (user) {
            const profileSnap = await db.ref(`users/${user.uid}/profile`).once('value');
            const profile = profileSnap.exists() ? profileSnap.val() : {};
            const watermarkText = profile.transportName || 'TransVortex';

            // Set watermark properties
            pdf.setFontSize(50);
            pdf.setTextColor(150, 150, 150); // Light grey color
            pdf.setFont('helvetica', 'bold');
            pdf.saveGraphicsState(); // Save current state
            pdf.setGState(new pdf.GState({opacity: 0.2})); // Set transparency

            // Rotate and place the watermark in the center
            const centerX = pdf.internal.pageSize.getWidth() / 2;
            const centerY = pdf.internal.pageSize.getHeight() / 2;
            pdf.text(watermarkText, centerX, centerY, { align: 'center', angle: -45 });

            pdf.restoreGraphicsState(); // Restore original state
          }
        }

        pdf.save(`${lrNumber}.pdf`); // This was already correct

      } catch (error) {
        console.error('Error generating PDF:', error);
        alert('Failed to generate PDF. Please try again.');
      }
    }
    function preselectEditRoute(from, to, attempt = 0) { /* ... (same as original) ... */ }
    function deleteLR(lrId) {
      if (!currentCoreAccountId) {
        alert('Error: Cannot determine account. Please reload.');
        return;
      }
      if (confirm('Are you sure you want to delete this LR record? This action cannot be undone.')) {
        db.ref(`users/${currentCoreAccountId}/lrReports/${lrId}`).remove()
          .then(() => {
            alert('LR deleted successfully!');
            loadLRData(); // Refresh the table
          })
          .catch((error) => {
            console.error('Error deleting LR:', error);
            alert('Error deleting LR. Please try again.');
          });
      }
    }
    
    // MODIFIED: This function now directly calls createAndSaveInvoice()
    window.showBankDetailsModal = function(isMarket = false) {
      const lrsToInvoice = isMarket ? selectedMarketLRs : selectedLRs;
      if (lrsToInvoice.length === 0) {
        alert('Please select at least one LR to generate an invoice.');
        return;
      }
      // Directly proceed to invoice creation, fetching bank details from profile
      createAndSaveInvoice(isMarket);
    }

    // MODIFIED: This function now fetches bank details from the user's profile
    window.createAndSaveInvoice = async function(isMarket = false) {
      
      const user = auth.currentUser;
      if (!user || !currentCoreAccountId) {
        alert('Authentication error. Please log in again.');
        return;
      }

      try {
        // 1. Fetch company profile and bank details from /profile
        const profileRef = db.ref(`users/${user.uid}/profile`);
        const profileSnap = await profileRef.once('value');
        const profile = profileSnap.exists() ? profileSnap.val() : {};
        
        // Extract Company Details
        const companyDetails = {
          name: profile.transportName || 'N/A',
          address: `${profile.address || ''}, ${profile.city || ''} - ${profile.pincode || ''}`,
          gstNumber: profile.gstin || 'N/A',
        };
        
        // Extract Bank Details
        const bankDetails = {
          bankName: profile.bankName || 'N/A',
          accountNumber: profile.accountNumber || 'N/A',
          accountHolder: profile.accountHolder || 'N/A',
          ifscCode: profile.ifscCode || 'N/A',
        };

        // Basic check for mandatory bank details before proceeding
        if (bankDetails.bankName === 'N/A' || bankDetails.accountNumber === 'N/A') {
            alert('Bank details are missing in your profile. Please update your profile before generating an invoice.');
            return;
        }


        // 2. Fetch details for all selected LRs
        let subtotal = 0;
        let firstClientId = null;
        const invoiceItems = [];

        // **NEW**: Use correct list of LRs
        const lrsToProcess = isMarket ? selectedMarketLRs : selectedLRs;
        const lrPromises = lrsToProcess.map(lrId => db.ref(`users/${currentCoreAccountId}/lrReports/${lrId}`).once('value'));
        const lrSnapshots = await Promise.all(lrPromises);

        for (const snap of lrSnapshots) {
          const lr = snap.val();
          if (!lr) continue;

          // **NEW**: For non-market LRs, ensure they belong to the same client
          if (!isMarket) {
            if (!firstClientId) firstClientId = lr.clientId;
            if (lr.clientId !== firstClientId) {
              alert('Error: All selected LRs must belong to the same client.');
              return;
            }
          }

          const billingAmount = lr.tripDetails?.billingAmount || 0;
          subtotal += billingAmount;

          // **FIX**: Use the correct client list for name resolution
          const consignor = allClients.find(c => c.id === lr.clientId)?.name || 'N/A';
          const consignee = allClients.find(c => c.id === lr.consigneeId)?.name || consignor;

          invoiceItems.push({
            lrId: snap.key,
            date: lr.date,
            lrNumber: lr.lrNumber,
            truckNumber: lr.truckNumber,
            consignor: consignor,
            consignee: consignee,
            from: lr.fromLocation,
            to: lr.toLocation,
            weight: lr.weight,
            amount: billingAmount,
            marketCompanyName: lr.transporterCompany || '' // **FIX**: Use the correct field 'transporterCompany'
          });
        }

        // 3. Calculate totals
        const cgstPercentage = 9;
        const sgstPercentage = 9;
        const cgstAmount = (subtotal * cgstPercentage) / 100;
        const sgstAmount = (subtotal * sgstPercentage) / 100;
        const grandTotal = subtotal + cgstAmount + sgstAmount;

        // 4. Create invoice object
        const invoiceNumber = `INV-${Date.now()}`; 
        const invoiceData = {
          invoiceNumber: invoiceNumber,
          createdAt: new Date().toISOString(),
          clientId: isMarket ? null : firstClientId, 
          invoiceType: isMarket ? 'market' : 'client', // **NEW**: Differentiate invoice type
          companyDetails: companyDetails,
          bankDetails: bankDetails, // Use fetched bank details
          items: invoiceItems,
          lrEntries: lrsToProcess, // Keep the original LR IDs
          subtotal: subtotal,
          cgstAmount: cgstAmount,
          sgstAmount: sgstAmount,
          grandTotal: grandTotal,
          paymentStatus: 'pending',
          paidAmount: 0,
        };

        // 5. Save invoice and update LRs atomically
        const updates = {};
        const newInvoiceKey = db.ref(`users/${currentCoreAccountId}/invoices`).push().key;
        updates[`/users/${currentCoreAccountId}/invoices/${newInvoiceKey}`] = invoiceData;
        lrsToProcess.forEach(lrId => {
          updates[`/users/${currentCoreAccountId}/lrReports/${lrId}/status`] = 'invoiced';
          updates[`/users/${currentCoreAccountId}/lrReports/${lrId}/invoiceId`] = newInvoiceKey;
        });

        await db.ref().update(updates);

        alert('Invoice generated successfully!');
        window.location.href = `invoice.html?view=${newInvoiceKey}`;

      } catch (error) {
        console.error('Error creating invoice:', error);
        alert('Failed to create invoice: ' + error.message);
      }
    }

    function convertNumberToWords(num) { /* ... (same as original) ... */ }
    
    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize DataTable
      // The initialization for lrTable is now at the top of the DOMContentLoaded block
      
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          await loadAllData();
          loadAutoGenerationSettings();
          
          // Set default date to today
          const today = new Date().toISOString().split('T')[0];
          document.getElementById('lrDate').value = today;

          // Event listeners
          document.getElementById('saveLRBtn').addEventListener('click', saveLR);
          document.getElementById('applyFiltersBtn').addEventListener('click', loadLRData);

        } else {
          window.location.href = "index.html";
        }
      });
    });

    // --- NEW TRANSPORTER FUNCTIONS ---

    async function loadTransporterList() {
      if (!currentCoreAccountId || !transportersTable) return;

      const [lrSnap, paymentsSnap] = await Promise.all([
        db.ref(`users/${currentCoreAccountId}/lrReports`).orderByChild('lrType').equalTo('market_trip').once('value'),
        db.ref(`users/${currentCoreAccountId}/transporterPayments`).once('value')
      ]);

      const lrsByTransporter = {};
      if (lrSnap.exists()) {
        lrSnap.forEach(child => {
          const lr = child.val();
          if (!lrsByTransporter[lr.transporterId]) {
            lrsByTransporter[lr.transporterId] = [];
          }
          lrsByTransporter[lr.transporterId].push(lr);
        });
      }

      const paymentsByTransporter = {};
      if (paymentsSnap.exists()) {
        paymentsSnap.forEach(child => {
          const payment = child.val();
          if (!paymentsByTransporter[payment.transporterId]) {
            paymentsByTransporter[payment.transporterId] = [];
          }
          paymentsByTransporter[payment.transporterId].push(payment);
        });
      }

      transportersTable.clear();
      allTransporters.forEach(transporter => {
        const transporterId = transporter.id;
        const associatedLRs = lrsByTransporter[transporterId] || [];
        const associatedPayments = paymentsByTransporter[transporterId] || [];

        const totalBilled = associatedLRs.reduce((sum, lr) => sum + (lr.tripDetails?.totalBillingAmount || 0), 0);
        const totalPaid = associatedPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
        const outstanding = totalBilled - totalPaid;

        transportersTable.row.add([
          transporter.name,
          transporter.contactPerson || '—',
          `₹${totalBilled.toFixed(2)}`,
          `₹${totalPaid.toFixed(2)}`,
          `<span class="fw-bold ${outstanding > 0 ? 'text-danger' : 'text-success'}">₹${outstanding.toFixed(2)}</span>`,
          `<button class="btn btn-sm btn-outline-primary" onclick="viewTransporterDetails('${transporterId}')"><i class="fas fa-eye"></i> View</button>`
        ]);
      });
      transportersTable.draw();
    }

    async function saveTransporterPayment(e) {
      e.preventDefault();
      if (!currentCoreAccountId) return;

      const paymentData = {
        transporterId: document.getElementById('paymentTransporterSelect').value,
        amount: parseFloat(document.getElementById('paymentAmount').value),
        date: document.getElementById('paymentDate').value,
        notes: document.getElementById('paymentNotes').value,
        createdAt: new Date().toISOString(),
        userId: auth.currentUser.uid
      };

      if (!paymentData.transporterId || !paymentData.amount || !paymentData.date) {
        alert('Please select a transporter and enter an amount and date.');
        return;
      }

      try {
        await db.ref(`users/${currentCoreAccountId}/transporterPayments`).push(paymentData);
        alert('Payment saved successfully!');
        e.target.reset();
        document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
        loadTransporterList(); // Refresh the list
      } catch (error) {
        alert('Error saving payment: ' + error.message);
      }
    }

    window.viewTransporterDetails = async function(transporterId) {
      const transporter = allTransporters.find(t => t.id === transporterId);
      if (!transporter) return;

      document.getElementById('transporterListView').style.display = 'none';
      document.getElementById('transporterDetailView').style.display = 'block';
      document.getElementById('transporterDetailTitle').textContent = `Details for ${transporter.name}`;

      const [lrSnap, paymentsSnap] = await Promise.all([
        db.ref(`users/${currentCoreAccountId}/lrReports`).orderByChild('transporterId').equalTo(transporterId).once('value'),
        db.ref(`users/${currentCoreAccountId}/transporterPayments`).orderByChild('transporterId').equalTo(transporterId).once('value')
      ]);

      let totalBilled = 0;
      transporterLrTable.clear();
      if (lrSnap.exists()) {
        lrSnap.forEach(child => {
          const lr = child.val();
          const billingAmount = lr.tripDetails?.totalBillingAmount || 0;
          totalBilled += billingAmount;
          transporterLrTable.row.add([lr.date, lr.lrNumber, `${lr.fromLocation} to ${lr.toLocation}`, `₹${billingAmount.toFixed(2)}`]);
        });
      }
      transporterLrTable.draw();

      let totalPaid = 0;
      transporterPaymentHistoryTable.clear();
      if (paymentsSnap.exists()) {
        paymentsSnap.forEach(child => {
          const payment = child.val();
          totalPaid += payment.amount || 0;
          transporterPaymentHistoryTable.row.add([payment.date, `₹${(payment.amount || 0).toFixed(2)}`, payment.notes || '—']);
        });
      }
      transporterPaymentHistoryTable.draw();

      const outstanding = totalBilled - totalPaid;
      document.getElementById('transporterDetailHeader').innerHTML = `
        <div class="row text-center">
          <div class="col-md-4"><strong>Total Billed:</strong> <span class="fw-bold text-danger">₹${totalBilled.toFixed(2)}</span></div>
          <div class="col-md-4"><strong>Total Paid:</strong> <span class="fw-bold text-success">₹${totalPaid.toFixed(2)}</span></div>
          <div class="col-md-4"><strong>Outstanding:</strong> <span class="fw-bold ${outstanding > 0 ? 'text-warning' : 'text-success'}">₹${outstanding.toFixed(2)}</span></div>
        </div>
      `;
    }

  </script>
<script>
      document.addEventListener('DOMContentLoaded', function() {
        // Initial call to set the correct state based on the checkbox
        const vehicleTypeToggle = document.getElementById('vehicleTypeToggle');
        if (vehicleTypeToggle) {
          toggleVehicleInput(vehicleTypeToggle.checked);
        }

        const editVehicleTypeToggle = document.getElementById('editVehicleTypeToggle');
        if (editVehicleTypeToggle) {
          toggleEditVehicleInput(editVehicleTypeToggle.checked);
        }
      });
    </script>
  </body>
</html>
