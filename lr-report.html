<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LR Management - Transport System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <style>
    body { padding: 0; margin: 0; background-color: #f8f9fa; }
    .tab-content { background: white; padding: 20px; border-radius: 0 0 8px 8px; }
    .subtotal-row { background-color: #f8f9fa; font-weight: bold; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

  <!-- Navbar will be loaded here by navbar-loader.js -->
  <div id="navbar-placeholder"></div>

  <div class="container">
    <h2 class="mb-4"><i class="fas fa-file-invoice me-2"></i>LR Management</h2>
    
    <!-- Tabs -->
    <ul class="nav nav-tabs" id="lrTabs">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#view">View Entries</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#add">Add New LR</a>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- View Tab -->
      <div class="tab-pane fade show active" id="view">
        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label">From Date</label>
            <input type="date" class="form-control" id="fromDate">
          </div>
          <div class="col-md-3">
            <label class="form-label">To Date</label>
            <input type="date" class="form-control" id="toDate">
          </div>
          <div class="col-md-3">
            <label class="form-label">Truck Number</label>
            <select class="form-select" id="truckFilter">
              <option value="">All Trucks</option>
            </select>
          </div>
          <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-primary me-2" id="applyFiltersBtn">Filter</button>
            <button class="btn btn-success" id="exportPdfBtn">PDF</button>
          </div>
        </div>
        <div class="mb-3">
          <button class="btn btn-primary" id="generateInvoiceBtn" onclick="showBankDetailsModal()" disabled>
            <i class="fas fa-file-invoice me-2"></i>Generate Invoice
          </button>
        </div>
        <div class="table-responsive">
          <table id="lrTable" class="table table-striped">
            <thead>
              <tr>
                <th>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="selectAllCheckbox">
                  </div>
                </th>
                <th>Date</th>
                <th>LR No</th>
                <th>Truck No</th>
                <th>Consignor</th>
                <th>Consignee</th>
                <th>Item</th>
                <th>From</th>
                <th>To</th>
                <th>Weight</th>
                <th>Billing Amount</th>
                <th>Freight Amount</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Rows will be populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Add Tab -->
      <div class="tab-pane fade" id="add">
        <form id="lrForm">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Date <span class="text-danger">*</span></label>
              <input type="date" class="form-control" id="lrDate" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">LR Number <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="lrNumber" readonly>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Truck Number <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="truckNumber" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="clientId" class="form-label">Client / Consignor <span class="text-danger">*</span></label>
              <select id="clientId" class="form-select" required>
                <option value="">Select a Client</option>
                <!-- Clients will be populated here by JavaScript -->
              </select>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">From Location <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="fromLocation" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">To Location <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="toLocation" required>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Weight (tonne) <span class="text-danger">*</span></label>
              <input type="number" class="form-control" id="weight" step="0.01" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Consignee (if different from client)</label>
              <input type="text" class="form-control" id="consignee">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Item</label>
              <input type="text" class="form-control" id="item">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Shipment No.</label>
              <input type="text" class="form-control" id="shipmentNo">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Billing Rate (₹/tonne)</label>
              <input type="number" step="0.01" class="form-control" id="billingRate" oninput="calculateBillingAmount()">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Billing Amount (₹)</label>
              <input type="number" step="0.01" class="form-control" id="billingAmount" oninput="calculateBillingRate()">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Freight Rate (₹/tonne)</label>
              <input type="number" step="0.01" class="form-control" id="freightRate" oninput="calculateFreightAmount()">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Freight Amount (₹)</label>
              <input type="number" step="0.01" class="form-control" id="freightAmount" oninput="calculateFreightRate()">
            </div>
          </div>
          
          <!-- NEW EXPENSE FIELDS -->
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Tyre Expenses (₹)</label>
              <input type="number" step="0.01" class="form-control" id="tyreExpenses" value="0">
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Diesel Expenses (₹)</label>
              <input type="number" step="0.01" class="form-control" id="dieselExpenses" value="0">
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Toll Expenses (₹)</label>
              <input type="number" step="0.01" class="form-control" id="tollExpenses" value="0">
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Vehicle Work (₹)</label>
              <input type="number" step="0.01" class="form-control" id="vehicleWork" value="0">
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Food Expenses (₹)</label>
              <input type="number" step="0.01" class="form-control" id="foodExpenses" value="0">
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Other Expenses (₹)</label>
              <input type="number" step="0.01" class="form-control" id="otherExpenses" value="0" oninput="calculateAmount()">
            </div>
          </div>
          <!-- END NEW EXPENSE FIELDS -->
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Payment Type</label>
              <select class="form-select" id="paymentType">
                <option value="">Select Payment Type</option>
                <option value="Cash">Cash</option>
                <option value="Credit">Credit</option>
                <option value="Bank Transfer">Bank Transfer</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Bank Name</label>
              <input type="text" class="form-control" id="bankName">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Shortage (₹)</label>
              <input type="number" step="0.01" class="form-control" id="shortage" value="0" oninput="calculateAmount()">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Advance (₹)</label>
              <input type="number" step="0.01" class="form-control" id="advance" value="0" oninput="calculateAmount()">
            </div>
          </div>
          <div class="row">
            <div class="col-md-3 mb-3">
              <label class="form-label">CGST %</label>
              <input type="number" step="0.01" class="form-control" id="cgstPercentage" value="9" oninput="calculateAmount()">
            </div>
            <div class="col-md-3 mb-3">
              <label class="form-label">CGST Amount (₹)</label>
              <input type="number" step="0.01" class="form-control" id="cgstAmount" readonly>
            </div>
            <div class="col-md-3 mb-3">
              <label class="form-label">SGST %</label>
              <input type="number" step="0.01" class="form-control" id="sgstPercentage" value="9" oninput="calculateAmount()">
            </div>
            <div class="col-md-3 mb-3">
              <label class="form-label">SGST Amount (₹)</label>
              <input type="number" step="0.01" class="form-control" id="sgstAmount" readonly>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Balance (₹)</label>
              <input type="number" step="0.01" class="form-control" id="balance" readonly>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Total Amount (₹)</label>
              <input type="number" step="0.01" class="form-control" id="totalAmount" readonly>
            </div>
          </div>
          <button type="button" class="btn btn-primary" id="saveLRBtn">Save LR</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Bank Details Modal -->
  <div class="modal fade" id="bankDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Enter Bank & Company Details</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="bankDetailsForm">
            <div class="row mb-3">
              <div class="col-md-6">
                <h6>Company Details</h6>
                <div class="mb-3">
                  <label for="inputCompanyName" class="form-label">Company Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="inputCompanyName" required>
                </div>
                <div class="mb-3">
                  <label for="inputCompanyAddress" class="form-label">Company Address</label>
                  <textarea class="form-control" id="inputCompanyAddress" rows="2"></textarea>
                </div>
                <div class="mb-3">
                  <label for="inputGstNumber" class="form-label">GST Number</label>
                  <input type="text" class="form-control" id="inputGstNumber">
                </div>
                <div class="mb-3">
                  <label for="inputCompanyPhone" class="form-label">Phone Number</label>
                  <input type="text" class="form-control" id="inputCompanyPhone">
                </div>
              </div>
              <div class="col-md-6">
                <h6>Bank Details</h6>
                <div class="mb-3">
                  <label for="inputBankName" class="form-label">Bank Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="inputBankName" required>
                </div>
                <div class="mb-3">
                  <label for="inputAccountHolder" class="form-label">Account Holder Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="inputAccountHolder" required>
                </div>
                <div class="mb-3">
                  <label for="inputAccountNumber" class="form-label">Account Number <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="inputAccountNumber" required>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="inputIfscCode" class="form-label">IFSC Code <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="inputIfscCode" required>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="inputAccountType" class="form-label">Account Type</label>
                      <select class="form-select" id="inputAccountType">
                        <option value="Current">Current</option>
                        <option value="Savings">Savings</option>
                        <option value="CC">Cash Credit</option>
                        <option value="OD">Overdraft</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="createAndSaveInvoice()">Generate Invoice</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Invoice Modal -->
  <div class="modal fade" id="invoiceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title">Invoice Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-4" id="invoiceContent">
          <style>
            @media print {
              @page {
                size: A4 landscape;
                margin: 0.5cm;
              }
              body {
                font-family: Arial, sans-serif;
                font-size: 9px;
                line-height: 1.3;
                color: #333;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
              }
              .no-print {
                display: none !important;
              }
              .table {
                page-break-inside: auto;
                border-collapse: collapse;
                width: 100% !important;
                margin: 0;
                table-layout: fixed;
                width: 100%;
                margin-bottom: 1rem;
              }
              .table th, .table td {
                padding: 3px 5px;
                border: 1px solid #dee2e6 !important;
                vertical-align: middle;
                word-wrap: break-word;
                font-size: 8px;
              }
              .table thead th {
                background-color: #f8f9fa;
                font-weight: 600;
                text-align: center;
              }
              .table tbody td {
                padding: 4px 6px;
              }
              .text-end {
                text-align: right !important;
              }
              .text-center {
                text-align: center !important;
              }
              .invoice-header {
                margin-bottom: 15px;
                padding-bottom: 10px;
                border-bottom: 2px solid #dee2e6;
              }
              .company-details {
                margin-bottom: 15px;
              }
              .invoice-details {
                margin-bottom: 15px;
              }
              .bank-details {
                margin-top: 15px;
                padding: 10px;
                border: 1px solid #dee2e6;
                border-radius: 4px;
                background-color: #f8f9fa;
              }
              .signature-area {
                margin-top: 40px;
                padding-top: 20px;
                border-top: 1px solid #dee2e6;
              }
              .signature-line {
                display: inline-block;
                width: 200px;
                border-top: 1px solid #333;
                margin-top: 30px;
                padding-top: 5px;
              }  .text-end {
                text-align: right !important;
              }
              .text-center {
                text-align: center !important;
              }
              .fw-bold {
                font-weight: bold !important;
              }
              .table-active {
                background-color: #f8f9fa !important;
              }
              .table-light {
                background-color: #f8f9fa !important;
              }
              .border-bottom {
                border-bottom: 1px solid #dee2e6 !important;
              }
              .mt-4 {
                margin-top: 1.5rem !important;
              }
              .mb-0 {
                margin-bottom: 0 !important;
              }
              .mb-1 {
                margin-bottom: 0.25rem !important;
              }
              .mb-4 {
                margin-bottom: 1.5rem !important;
              }
              .me-2 {
                margin-right: 0.5rem !important;
              }
              .p-4 {
                padding: 1.5rem !important;
              }
              .small {
                font-size: 80% !important;
              }
            }
            .invoice-header {
              border-bottom: 2px solid #dee2e6;
              margin-bottom: 20px;
              padding-bottom: 15px;
            }
            .invoice-table th {
              white-space: nowrap;
              background-color: #f8f9fa !important;
            }
          </style>
          
          <div id="printableInvoice">
            <div class="row mb-4">
              <div class="col-12 text-center">
                <h3 class="mb-1">TRANSPORT INVOICE</h3>
                <p class="mb-1" id="companyName">Loading company details...</p>
                <p class="mb-1" id="companyAddress">Loading address...</p>
                <p class="mb-0" id="companyGst">GST: Loading...</p>
              </div>
            </div>
            
            <div class="row mb-4">
              <div class="col-6">
                <p class="mb-1"><strong>Bill To:</strong></p>
                <p id="billToAddress" class="mb-0">Consolidated Invoice</p>
              </div>
              <div class="col-6 text-end">
                <p class="mb-1"><strong>Invoice #: </strong><span id="invoiceNumber">INV-${new Date().getFullYear()}${String(new Date().getMonth() + 1).padStart(2, '0')}${String(new Date().getDate()).padStart(2, '0')}-${Math.floor(1000 + Math.random() * 9000)}</span></p>
                <p class="mb-1"><strong>Date: </strong><span id="invoiceDate">${new Date().toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' })}</span></p>
              </div>
            </div>
            
            <div class="table-responsive">
              <table class="table table-bordered table-sm invoice-table">
                <thead class="table-light" style="background-color: #f8f9fa !important;">
                  <tr>
                    <th style="width: 70px;">Date</th>
                    <th style="width: 90px;">LR No</th>
                    <th style="width: 70px;">Truck No</th>
                    <th style="width: 100px;">Consignor</th>
                    <th style="width: 100px;">Consignee</th>
                    <th style="width: 80px;">From</th>
                    <th style="width: 80px;">To</th>
                    <th class="text-end" style="width: 60px;">Weight</th>
                    <th class="text-end" style="width: 60px;">Rate</th>
                    <th class="text-end" style="width: 45px;">GST %</th>
                    <th class="text-end" style="width: 70px;">GST Amt</th>
                    <th class="text-end" style="width: 80px;">Amount</th>
                  </tr>
                </thead>
                <tbody id="invoiceItems">
                  <!-- Invoice items will be populated here -->
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="7" class="border-0"></td>
                    <td class="text-end border-0"><strong>Subtotal:</strong></td>
                    <td class="text-end border-0"></td>
                    <td class="text-end border-0"></td>
                    <td class="text-end border-0" colspan="2">-</td>
                    <td class="text-end fw-bold border-0" id="subtotalAmount">₹0.00</td>
                  </tr>
                  <tr id="cgstRow">
                    <td colspan="7" class="border-0"></td>
                    <td class="text-end border-0" colspan="4"><strong>CGST:</strong></td>
                    <td class="text-end fw-bold border-0" id="invoiceCgstAmount">₹0.00</td>
                  </tr>
                  <tr id="sgstRow">
                    <td colspan="7" class="border-0"></td>
                    <td class="text-end border-0" colspan="4"><strong>SGST:</strong></td>
                    <td class="text-end fw-bold border-0" id="invoiceSgstAmount">₹0.00</td>
                  </tr>
                  <tr class="table-active">
                    <td colspan="7" class="border-0"></td>
                    <td class="text-end border-0"><strong>Grand Total:</strong></td>
                    <td class="text-end border-0" colspan="3">-</td>
                    <td class="text-end fw-bold border-0" id="grandTotal">₹0.00</td>
                  </tr>
                </tfoot>
              </table>
            </div>
            
            <div class="row mt-4">
              <div class="col-md-6">
                <p class="mb-1"><strong>Bank Details:</strong></p>
                <p class="mb-1">Bank: <span id="invoiceBankName">-</span></p>
                <p class="mb-1">Account Number: <span id="invoiceAccountNumber">-</span></p>
                <p class="mb-1">Account Holder: <span id="invoiceAccountHolder">-</span></p>
                <p class="mb-1">IFSC: <span id="invoiceIfscCode">-</span></p>
                <p class="mb-0">Account Type: <span id="invoiceAccountType">Current</span></p>
                <div class="mt-3">
                  <p class="mb-1"><strong>Amount in Words:</strong></p>
                  <p class="mb-0 small" id="amountInWords">-</p>
                </div>
              </div>
              <div class="col-md-6 text-end">
                <div class="mt-5">
                  <p class="mb-4">For <span id="companyNameFooter">[Company Name]</span></p>
                  <p class="mb-0">___________________</p>
                  <p class="mb-0">Authorized Signatory</p>
                </div>
              </div>
            </div>
            
            <div class="row mt-4 text-center">
              <div class="col-12">
                <p class="mb-0"><small>This is a computer-generated invoice. No signature required.</small></p>
              </div>
            </div>
          </div>
          
          <div class="mt-4 no-print text-center">
            <button class="btn btn-primary me-2" onclick="printInvoice()">
              <i class="fas fa-print me-2"></i>Print Invoice
            </button>
            
            <button class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times me-2"></i>Close
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="printInvoice()">
            <i class="fas fa-print me-2"></i>Print Invoice
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="editLRModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit LR Record</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editLrForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Date <span class="text-danger">*</span></label>
                <input type="date" class="form-control" id="editLrDate" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">LR Number <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="editLrNumber" readonly>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Truck Number <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="editTruckNumber" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="editClientId" class="form-label">Client / Consignor <span class="text-danger">*</span></label>
                <select id="editClientId" class="form-select" required>
                  <option value="">Select a Client</option>
                  <!-- Clients will be populated here by JavaScript -->
                </select>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">From Location <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="editFromLocation" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">To Location <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="editToLocation" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Weight (tonne) <span class="text-danger">*</span></label>
                <input type="number" class="form-control" id="editWeight" step="0.01" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Consignee</label>
                <input type="text" class="form-control" id="editConsignee">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Item</label>
                <input type="text" class="form-control" id="editItem">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Shipment No.</label>
                <input type="text" class="form-control" id="editShipmentNo">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Billing Rate (₹/tonne)</label>
                <input type="number" step="0.01" class="form-control" id="editBillingRate" oninput="calculateEditBillingAmount()">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Billing Amount (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editBillingAmount" oninput="calculateEditBillingRate()">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Freight Rate (₹/tonne)</label>
                <input type="number" step="0.01" class="form-control" id="editFreightRate" oninput="calculateEditFreightAmount()">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Freight Amount (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editFreightAmount" oninput="calculateEditFreightRate()">
              </div>
            </div>
            
            <!-- NEW EXPENSE FIELDS FOR EDIT MODAL -->
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">Tyre Expenses (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editTyreExpenses" value="0">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Diesel Expenses (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editDieselExpenses" value="0">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Toll Expenses (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editTollExpenses" value="0">
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">Vehicle Work (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editVehicleWork" value="0">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Food Expenses (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editFoodExpenses" value="0">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Other Expenses (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editOtherExpenses" value="0" oninput="calculateEditAmount()">
              </div>
            </div>
            <!-- END NEW EXPENSE FIELDS FOR EDIT MODAL -->
            
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Payment Type</label>
                <select class="form-select" id="editPaymentType">
                  <option value="">Select Payment Type</option>
                  <option value="Cash">Cash</option>
                  <option value="Credit">Credit</option>
                  <option value="Bank Transfer">Bank Transfer</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Bank Name</label>
                <input type="text" class="form-control" id="editBankName">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Shortage (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editShortage" value="0" oninput="calculateEditAmount()">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Advance (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editAdvance" value="0" oninput="calculateEditAmount()">
              </div>
            </div>
            <div class="row">
              <div class="col-md-3 mb-3">
                <label class="form-label">CGST %</label>
                <input type="number" step="0.01" class="form-control" id="editCgstPercentage" oninput="calculateEditAmount()">
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label">CGST Amount (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editCgstAmount" readonly>
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label">SGST %</label>
                <input type="number" step="0.01" class="form-control" id="editSgstPercentage" oninput="calculateEditAmount()">
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label">SGST Amount (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editSgstAmount" readonly>
              </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Total Amount (₹)</label>
                    <input type="number" step="0.01" class="form-control" id="editTotalAmount" readonly>
                </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="saveEditBtn">Save changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="navbar-loader.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDAlk_K8p8Of8Ne6Jpcl2QqXTtm95NgG7o",
      authDomain: "transport-dashboard-ad69a.firebaseapp.com",
      databaseURL: "https://transport-dashboard-ad69a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "transport-dashboard-ad69a",
      storageBucket: "transport-dashboard-ad69a.appspot.com",
      messagingSenderId: "526889676196",
      appId: "1:526889676196:web:66032c80a4aede690ae531"
    };

    // Global variables
    let lrData = [];
    let selectedLRs = [];
    let currentEditId = null;
    let lrTableInstance = null;
    let auth = null;
    let db = null;

    // Initialize the page
    $(document).ready(function() {
      // Initialize DataTable
      lrTableInstance = $('#lrTable').DataTable({
        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, 'All']],
        columnDefs: [
          { orderable: false, targets: [0, 13] },
          { searchable: false, targets: [0, 13] }
        ]
      });

      // Initialize Firebase
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      auth = firebase.auth();
      db = firebase.database();

      // Check authentication
      auth.onAuthStateChanged(user => {
        if (user) {
          // Load data from Firebase
          loadLRData(user.uid);
          loadClientsForDropdown(user.uid); // Load clients into the form
        } else {
          // Redirect to login if not authenticated
          window.location.href = 'login.html';
        }
      });
      
      // Set current date as default
      const today = new Date().toISOString().split('T')[0];
      $('#lrDate').val(today);
      $('#fromDate').val(today);
      $('#toDate').val(today);
      
      // Event listeners
      $('#saveLRBtn').click(saveLR);
      $('#applyFiltersBtn').click(applyFilters);
      $('#selectAllCheckbox').change(toggleSelectAll);
      $('#saveEditBtn').click(saveEditLR);
      
      // Calculate initial amounts
      calculateAmount();
    });

    // Load clients into the dropdown
    function loadClientsForDropdown(uid) {
        const clientRef = db.ref(`users/${uid}/clients`);
        clientRef.on('value', (snapshot) => {
            const select = $('#clientId');
            select.empty().append('<option value="">Select a Client</option>');
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    const client = child.val();
                    // Store client name in data attribute for later use
                    select.append(`<option value="${child.key}" data-name="${client.clientName}">${client.clientName}</option>`);
                });
            }
        }, (error) => {
            console.error("Error loading clients for dropdown: ", error);
        });
    }

    // Load LR data from localStorage
    function loadLRData(userId) { 

      const lrReportsRef = db.ref('lrReports').orderByChild('userId').equalTo(userId);
      lrReportsRef.on('value', (snapshot) => {
        lrData = [];
        snapshot.forEach(childSnapshot => {
          const lr = childSnapshot.val();
          // Only show LRs that have not been invoiced yet
          if (lr.status !== 'Generated') {
            lrData.push({ id: childSnapshot.key, ...lr });
          }
        });
        // Sort by date descending
        lrData.sort((a, b) => new Date(b.date) - new Date(a.date));
        populateLRTable();
        updateTruckFilter();
        generateLRNumber();
      }, (error) => {
        console.error("Error loading LR data: ", error);
        alert("Could not load LR data. Please check your connection and permissions.");
      });
    }

    // Generate LR number
    function generateLRNumber() {
      const date = new Date();
      const year = date.getFullYear().toString().slice(-2);
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const day = date.getDate().toString().padStart(2, '0');
      
      // Count today's LRs
      const todayLRs = lrData.filter(lr => {
        const lrDate = new Date(lr.date);
        return lrDate.getDate() === date.getDate() && 
               lrDate.getMonth() === date.getMonth() && 
               lrDate.getFullYear() === date.getFullYear();
      });
      
      const count = todayLRs.length + 1;
      const countStr = count.toString().padStart(3, '0');
      
      $('#lrNumber').val(`LR${day}${month}${year}${countStr}`);
    }

    // Calculate billing amount based on rate and weight
    function calculateBillingAmount() {
      const weight = parseFloat($('#weight').val()) || 0;
      const billingRate = parseFloat($('#billingRate').val()) || 0;
      $('#billingAmount').val((weight * billingRate).toFixed(2));
      calculateAmount();
    }

    // Calculate billing rate based on amount and weight
    function calculateBillingRate() {
      const weight = parseFloat($('#weight').val()) || 0;
      const billingAmount = parseFloat($('#billingAmount').val()) || 0;
      if (weight > 0) {
        $('#billingRate').val((billingAmount / weight).toFixed(2));
      }
      calculateAmount();
    }

    // Calculate freight amount based on rate and weight
    function calculateFreightAmount() {
      const weight = parseFloat($('#weight').val()) || 0;
      const freightRate = parseFloat($('#freightRate').val()) || 0;
      $('#freightAmount').val((weight * freightRate).toFixed(2));
      calculateAmount();
    }

    // Calculate freight rate based on amount and weight
    function calculateFreightRate() {
      const weight = parseFloat($('#weight').val()) || 0;
      const freightAmount = parseFloat($('#freightAmount').val()) || 0;
      if (weight > 0) {
        $('#freightRate').val((freightAmount / weight).toFixed(2));
      }
      calculateAmount();
    }

    // Calculate GST and total amount
    function calculateAmount() {
        const billingAmount = parseFloat($('#billingAmount').val()) || 0; // This is the subtotal for the invoice
        // **FIX**: Define percentages before they are used.
        const cgstPercentage = parseFloat($('#cgstPercentage').val()) || 0;
        const sgstPercentage = parseFloat($('#sgstPercentage').val()) || 0;

        const freightAmount = parseFloat($('#freightAmount').val()) || 0; // This is the revenue for the transporter
        
        // Sum of all expenses
        const tyreExpenses = parseFloat($('#tyreExpenses').val()) || 0;
        const dieselExpenses = parseFloat($('#dieselExpenses').val()) || 0;
        const tollExpenses = parseFloat($('#tollExpenses').val()) || 0;
        const vehicleWork = parseFloat($('#vehicleWork').val()) || 0;
        const foodExpenses = parseFloat($('#foodExpenses').val()) || 0;
        const otherExpenses = parseFloat($('#otherExpenses').val()) || 0;
        const shortage = parseFloat($('#shortage').val()) || 0;
        const advance = parseFloat($('#advance').val()) || 0;

        const totalExpenses = tyreExpenses + dieselExpenses + tollExpenses + vehicleWork + foodExpenses + otherExpenses + shortage + advance;

        // Calculate balance (what the client owes after expenses are considered from the bill)
        const totalAmount = billingAmount + (billingAmount * (cgstPercentage / 100)) + (billingAmount * (sgstPercentage / 100));
        const balance = totalAmount - totalExpenses;
        $('#balance').val(balance.toFixed(2));

        // Calculate GST and Grand Total for the invoice
        const cgstAmount = billingAmount * (cgstPercentage / 100);
        const sgstAmount = billingAmount * (sgstPercentage / 100);
        const grandTotal = billingAmount + cgstAmount + sgstAmount;

        $('#cgstAmount').val(cgstAmount.toFixed(2));
        $('#sgstAmount').val(sgstAmount.toFixed(2));
        $('#totalAmount').val(grandTotal.toFixed(2));
    }

    // Save LR record
    function saveLR() {
      // Validate form
      if (!$('#lrForm')[0].checkValidity()) {
        $('#lrForm')[0].reportValidity();
        return;
      }
      
      const user = auth.currentUser;
      if (!user) {
        alert("You must be logged in to save an LR record.");
        return;
      }

      const selectedClientOption = $('#clientId option:selected');

      const lrRecord = {
        date: $('#lrDate').val(),
        lrNumber: $('#lrNumber').val(),
        truckNumber: $('#truckNumber').val().toUpperCase(),
        clientId: selectedClientOption.val(),
        consignor: selectedClientOption.data('name'),
        consignee: $('#consignee').val() || selectedClientOption.data('name'), // Default to client name if empty
        fromLocation: $('#fromLocation').val(),
        toLocation: $('#toLocation').val(),
        weight: parseFloat($('#weight').val()) || 0,
        item: $('#item').val(),
        shipmentNo: $('#shipmentNo').val(),
        billingRate: parseFloat($('#billingRate').val()) || 0,
        billingAmount: parseFloat($('#billingAmount').val()) || 0,
        freightRate: parseFloat($('#freightRate').val()) || 0,
        freightAmount: parseFloat($('#freightAmount').val()) || 0,
        paymentType: $('#paymentType').val(),
        bankName: $('#bankName').val(),
        shortage: parseFloat($('#shortage').val()) || 0,
        advance: parseFloat($('#advance').val()) || 0,
        otherExpenses: parseFloat($('#otherExpenses').val()) || 0,
        status: 'active',
        tyreExpenses: parseFloat($('#tyreExpenses').val()) || 0,
        dieselExpenses: parseFloat($('#dieselExpenses').val()) || 0,
        tollExpenses: parseFloat($('#tollExpenses').val()) || 0,
        vehicleWork: parseFloat($('#vehicleWork').val()) || 0,
        foodExpenses: parseFloat($('#foodExpenses').val()) || 0,
        cgstPercentage: parseFloat($('#cgstPercentage').val()) || 0,
        sgstPercentage: parseFloat($('#sgstPercentage').val()) || 0,
        cgstAmount: parseFloat($('#cgstAmount').val()) || 0,
        sgstAmount: parseFloat($('#sgstAmount').val()) || 0,
        totalAmount: parseFloat($('#totalAmount').val()) || 0,
        userId: user.uid,
        branchId: localStorage.getItem('selectedBranch') || 'main',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      
      const newLrRef = db.ref('lrReports').push();
      newLrRef.set(lrRecord)
        .then(() => {
          alert('LR record saved successfully!');
          const clientRef = db.ref(`users/${user.uid}/clients/${lrRecord.clientId}`);
          clientRef.transaction((clientData) => {
            if (clientData) {
              clientData.totalTrips = (clientData.totalTrips || 0) + 1;
              clientData.outstanding = (clientData.outstanding || 0) + (lrRecord.totalAmount || 0);
            }
            return clientData;
          });

          $('#lrForm')[0].reset();
          generateLRNumber();
          $('#lrDate').val(new Date().toISOString().split('T')[0]);
        })
        .catch((error) => {
          alert('Error saving LR record: ' + error.message);
        });
    }

    // Populate LR table with data
    function populateLRTable() {
      // Clear the table
      lrTableInstance.clear();
      
      // Add each LR record to the table
      lrData.forEach(lr => {
        lrTableInstance.row.add([
          `<div class="form-check">
            <input class="form-check-input lr-checkbox" type="checkbox" value="${lr.id}">
          </div>`,
          lr.date,
          lr.lrNumber,
          lr.truckNumber,
          lr.consignor,
          lr.consignee,
          lr.item,
          lr.fromLocation,
          lr.toLocation,
          lr.weight,
          lr.billingAmount.toFixed(2),
          lr.freightAmount.toFixed(2),
          `<span class="badge ${getStatusBadge(lr.status)}">${lr.status}</span>`,
          `<button class="btn btn-sm btn-outline-primary me-1" onclick="editLR('${lr.id}')">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteLR('${lr.id}')">
            <i class="fas fa-trash"></i>
          </button>`
        ]);
      });
      
      // Redraw the table
      lrTableInstance.draw();
      
      // Update checkbox event listeners
      $('.lr-checkbox').change(function() {
        updateSelectedLRs();
      });
    }

    // Get bootstrap badge class based on status
    function getStatusBadge(status) {
      switch (status.toLowerCase()) {
        case 'completed':
          return 'bg-success';
        case 'generated':
          return 'bg-info';
        default:
          return 'bg-warning';
      }
    }

    // Update truck filter dropdown
    function updateTruckFilter() {
      const truckFilter = $('#truckFilter');
      truckFilter.empty();
      truckFilter.append('<option value="">All Trucks</option>');
      
      // Get unique truck numbers
      const truckNumbers = [...new Set(lrData.map(lr => lr.truckNumber))];
      truckNumbers.forEach(truck => {
        truckFilter.append(`<option value="${truck}">${truck}</option>`);
      });
    }

    // Apply filters to the table
    function applyFilters() {
      const fromDate = document.getElementById('fromDate').value;
      const toDate = document.getElementById('toDate').value;
      const truckNumber = document.getElementById('truckFilter').value;
      
      // Use DataTables custom search function for filtering
      $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
        // Ensure we are targeting the correct table
        if (settings.nTable.id !== 'lrTable') {
          return true;
        }
        
        const rowDate = data[1] || ''; // Date is in the second column (index 1)
        const rowTruck = data[3] || ''; // Truck number is in the fourth column (index 3)
        
        let showRow = true;
        
        // Date range filter
        if (fromDate && rowDate < fromDate) showRow = false;
        if (toDate && rowDate > toDate) showRow = false;
        
        // Truck number filter
        if (truckNumber && rowTruck !== truckNumber) showRow = false;
        
        return showRow;
      });
      
      // Redraw the table with the new filter
      lrTableInstance.draw();
      
      // Update checkbox event listeners
      $('.lr-checkbox').change(function() {
        updateSelectedLRs();
      });
      
      // Update selected LRs
      updateSelectedLRs();

      // Remove the custom filter function so it doesn't interfere with other searches
      $.fn.dataTable.ext.search.length = 0;
    }
    
    // Function to convert number to words (Indian Rupees)
    function numberToWords(num) {
      const a = ['', 'one ', 'two ', 'three ', 'four ', 'five ', 'six ', 'seven ', 'eight ', 'nine ', 'ten ', 'eleven ', 'twelve ', 'thirteen ', 'fourteen ', 'fifteen ', 'sixteen ', 'seventeen ', 'eighteen ', 'nineteen '];
      const b = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
      
      if ((num = num.toString()).length > 9) return 'overflow';
      const n = ('000000000' + num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
      if (!n) return '';
      
      let str = '';
      str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'crore ' : '';
      str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'lakh ' : '';
      str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'thousand ' : '';
      str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'hundred ' : '';
      str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) : '';
      
      return str.trim().replace(/\s+/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ') + ' Only';
    }

    // Show invoice preview modal
    function showInvoicePreview(invoiceData, lrRecords) {
      // Populate company details
      $('#companyName').text(invoiceData.companyDetails.name);
      $('#companyAddress').text(invoiceData.companyDetails.address);
      $('#companyGst').text(`GST: ${invoiceData.companyDetails.gst}`);
      $('#companyNameFooter').text(invoiceData.companyDetails.name);
      
      // Populate invoice details
      $('#invoiceNumber').text(invoiceData.invoiceNumber);
      $('#invoiceDate').text(new Date(invoiceData.createdAt).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' }));
      
      // Populate bank details
      $('#invoiceBankName').text(invoiceData.bankDetails.bankName);
      $('#invoiceAccountNumber').text(invoiceData.bankDetails.accountNumber);
      $('#invoiceAccountHolder').text(invoiceData.bankDetails.accountHolder);
      $('#invoiceIfscCode').text(invoiceData.bankDetails.ifsc);
      $('#invoiceAccountType').text(invoiceData.bankDetails.accountType);

      // Populate invoice items
      const itemsBody = $('#invoiceItems');
      itemsBody.empty();
      lrRecords.forEach(lr => {
        const cgst = (lr.billingAmount || 0) * ((lr.cgstPercentage || 0) / 100);
        const sgst = (lr.billingAmount || 0) * ((lr.sgstPercentage || 0) / 100);
        itemsBody.append(`
          <tr>
            <td>${lr.date}</td><td>${lr.lrNumber}</td><td>${lr.truckNumber}</td>
            <td>${lr.consignor}</td><td>${lr.consignee}</td><td>${lr.fromLocation}</td>
            <td>${lr.toLocation}</td><td class="text-end">${(lr.weight || 0).toFixed(2)}</td>
            <td class="text-end">${(lr.billingRate || 0).toFixed(2)}</td>
            <td class="text-end">${(lr.cgstPercentage || 0) + (lr.sgstPercentage || 0)}%</td>
            <td class="text-end">₹${(cgst + sgst).toFixed(2)}</td>
            <td class="text-end">₹${(lr.billingAmount || 0).toFixed(2)}</td>
          </tr>`);
      });

      // Populate totals
      $('#subtotalAmount').text(`₹${(invoiceData.subtotal || 0).toFixed(2)}`);
      $('#invoiceCgstAmount').text(`₹${(invoiceData.cgstAmount || 0).toFixed(2)}`);
      $('#invoiceSgstAmount').text(`₹${(invoiceData.sgstAmount || 0).toFixed(2)}`);
      $('#grandTotal').text(`₹${(invoiceData.grandTotal || 0).toFixed(2)}`);
      $('#amountInWords').text(numberToWords(Math.floor(invoiceData.grandTotal || 0)));

      $('#invoiceModal').modal('show');
    }

    // Toggle select all checkboxes
    function toggleSelectAll() {
      const isChecked = $('#selectAllCheckbox').prop('checked');
      $('.lr-checkbox').prop('checked', isChecked);
      updateSelectedLRs();
    }

    // Update selected LRs array
    function updateSelectedLRs() {
      selectedLRs = [];
      $('.lr-checkbox:checked').each(function() {
        selectedLRs.push($(this).val());
      });
      
      // Enable/disable generate invoice button
      $('#generateInvoiceBtn').prop('disabled', selectedLRs.length === 0);
    }

    // Show bank details modal - **MODIFIED**
    window.showBankDetailsModal = function() {
      // ** NEW: Check if all selected LRs belong to the same client **
      const selectedLRRecords = lrData.filter(lr => selectedLRs.includes(lr.id));
      if (selectedLRRecords.length > 0) {
        const firstClientId = selectedLRRecords[0].clientId;
        const allSameClient = selectedLRRecords.every(lr => lr.clientId === firstClientId);
        if (!allSameClient) {
          alert('Please select LRs for the same client to generate a single invoice.');
          return;
        }
      }

      $('#bankDetailsModal').modal('show');
    }

    // Generate and save the invoice, then show the print preview
    window.createAndSaveInvoice = async function() { // Make the function async
      const user = auth.currentUser;
      if (!user) return alert("You must be logged in to generate an invoice.");
      if (!$('#bankDetailsForm')[0].checkValidity()) {
        $('#bankDetailsForm')[0].reportValidity();
        return;
      }

      if (selectedLRs.length === 0) {
        alert('No LRs selected for invoice generation.');
        return;
      }
      
      // **FIX: Fetch selected LR records directly from Firebase to ensure data is correct**
      const lrPromises = selectedLRs.map(lrId => db.ref(`lrReports/${lrId}`).get());
      const lrSnapshots = await Promise.all(lrPromises);
      const selectedLRRecords = lrSnapshots.map(snap => snap.exists() ? { id: snap.key, ...snap.val() } : null).filter(Boolean);

      if (selectedLRRecords.length !== selectedLRs.length) {
        return alert("Error: Some selected LRs could not be found in the database. Please refresh and try again.");
      }

      // 1. Create the invoice object
      const invoiceRef = db.ref('invoices').push();
      const invoiceId = invoiceRef.key;
      const now = new Date();
      const clientName = selectedLRRecords.length > 0 ? selectedLRRecords[0].consignor : 'N/A';
      const clientId = selectedLRRecords.length > 0 ? selectedLRRecords[0].clientId : null;

      // Calculate totals directly from selected LR records
      let subtotal = 0;
      let totalCgst = 0;
      let totalSgst = 0;
      selectedLRRecords.forEach(lr => {
        const itemSubtotal = lr.billingAmount || 0;
        const itemCgst = itemSubtotal * ((lr.cgstPercentage || 0) / 100);
        const itemSgst = itemSubtotal * ((lr.sgstPercentage || 0) / 100);
        subtotal += itemSubtotal;
        totalCgst += itemCgst;
        totalSgst += itemSgst;
      });
      const invoiceNumber = `INV-${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}-${Math.floor(1000 + Math.random() * 9000)}`;

      const invoiceData = {
        id: invoiceId,
        invoiceNumber: invoiceNumber,
        userId: user.uid,
        createdAt: now.toISOString(),
        clientId: clientId,
        lrIds: selectedLRs,
        companyDetails: {
          name: $('#inputCompanyName').val(),
          address: $('#inputCompanyAddress').val(),
          gst: $('#inputGstNumber').val(),
          phone: $('#inputCompanyPhone').val()
        },
        clientDetails: {
          name: clientName,
          // address: clientAddress, // Future enhancement: add client address field
        },
        bankDetails: {
          bankName: $('#inputBankName').val(),
          accountHolder: $('#inputAccountHolder').val(),
          accountNumber: $('#inputAccountNumber').val(),
          ifsc: $('#inputIfscCode').val(),
          accountType: $('#inputAccountType').val()
        },
        // Store calculated totals
        subtotal: subtotal,
        cgstAmount: totalCgst,
        sgstAmount: totalSgst,
        grandTotal: subtotal + totalCgst + totalSgst
      };

      // 2. Prepare multi-path update for atomicity - **MODIFIED**
      const updates = {};
      // Add the new invoice
      updates[`/invoices/${invoiceId}`] = invoiceData;

      // Update status and add invoiceId for each LR
      selectedLRs.forEach(lrId => {
        updates[`/lrReports/${lrId}/status`] = 'Generated';
        updates[`/lrReports/${lrId}/invoiceId`] = invoiceId;
        updates[`/lrReports/${lrId}/updatedAt`] = now.toISOString();
      });
      
      // ** NEW: Update client's outstanding balance and trip count **
      if (clientId) {
          const clientOutstandingRef = db.ref(`users/${user.uid}/clients/${clientId}/outstanding`);
          clientOutstandingRef.transaction((currentOutstanding) => {
              return (currentOutstanding || 0) + invoiceData.grandTotal;
          }).then(() => {
            // Execute the rest of the updates after the transaction
            executeInvoiceUpdate(updates, invoiceId);
          });
      } else {
        // Execute update without client changes if no clientId is found
        executeInvoiceUpdate(updates, invoiceId);
        showInvoicePreview(invoiceData, selectedLRRecords);
      }
    }

    function executeInvoiceUpdate(updates, invoiceId) {
      db.ref().update(updates)
        .then(() => {
          $('#bankDetailsModal').modal('hide');
          alert('Invoice generated successfully!');
          // The onValue listener will refresh the LR table automatically
        })
        .catch((error) => {
          console.error("Error generating invoice: ", error);
          alert("Could not generate the invoice. Please check your database rules and try again.");
        });
    }

    // Edit LR record
    function editLR(id) {
      const lr = lrData.find(item => item.id === id);
      if (!lr) return;
      
      currentEditId = id;
      
      // Populate edit form
      $('#editLrDate').val(lr.date);
      $('#editLrNumber').val(lr.lrNumber);
      $('#editTruckNumber').val(lr.truckNumber);

      // **FIX**: Populate client dropdown and select the correct client
      const editClientSelect = $('#editClientId');
      editClientSelect.empty().append('<option value="">Select a Client</option>');
      $('#clientId option').each(function() {
        if ($(this).val()) { // Exclude the placeholder
          editClientSelect.append($(this).clone());
        }
      });
      editClientSelect.val(lr.clientId);

      $('#editConsignee').val(lr.consignee);
      $('#editFromLocation').val(lr.fromLocation);
      $('#editToLocation').val(lr.toLocation);
      $('#editWeight').val(lr.weight);
      $('#editItem').val(lr.item);
      $('#editShipmentNo').val(lr.shipmentNo);
      $('#editBillingRate').val(lr.billingRate);
      $('#editBillingAmount').val(lr.billingAmount);
      $('#editFreightRate').val(lr.freightRate);
      $('#editFreightAmount').val(lr.freightAmount);
      $('#editPaymentType').val(lr.paymentType);
      $('#editBankName').val(lr.bankName);
      $('#editShortage').val(lr.shortage);
      $('#editAdvance').val(lr.advance);
      $('#editOtherExpenses').val(lr.otherExpenses);
      
      // NEW: Populate expense fields in edit modal
      $('#editTyreExpenses').val(lr.tyreExpenses || '0');
      $('#editDieselExpenses').val(lr.dieselExpenses || '0');
      $('#editTollExpenses').val(lr.tollExpenses || '0');
      $('#editVehicleWork').val(lr.vehicleWork || '0');
      $('#editFoodExpenses').val(lr.foodExpenses || '0');

      // Populate CGST/SGST fields
      $('#editCgstPercentage').val(lr.cgstPercentage || 9);
      $('#editSgstPercentage').val(lr.sgstPercentage || 9);
      calculateEditAmount(); // Recalculate all amounts
      
      // Show edit modal
      $('#editLRModal').modal('show');
    }

    // Calculate billing amount for edit form
    function calculateEditBillingAmount() {
      const weight = parseFloat($('#editWeight').val()) || 0;
      const billingRate = parseFloat($('#editBillingRate').val()) || 0;
      $('#editBillingAmount').val((weight * billingRate).toFixed(2));
      calculateEditAmount();
    }

    // Calculate billing rate for edit form
    function calculateEditBillingRate() {
      const weight = parseFloat($('#editWeight').val()) || 0;
      const billingAmount = parseFloat($('#editBillingAmount').val()) || 0;
      if (weight > 0) {
        $('#editBillingRate').val((billingAmount / weight).toFixed(2));
      }
      calculateEditAmount();
    }

    // Calculate freight amount for edit form
    function calculateEditFreightAmount() {
      const weight = parseFloat($('#editWeight').val()) || 0;
      const freightRate = parseFloat($('#editFreightRate').val()) || 0;
      $('#editFreightAmount').val((weight * freightRate).toFixed(2));
      calculateEditAmount();
    }

    // Calculate freight rate for edit form
    function calculateEditFreightRate() {
      const weight = parseFloat($('#editWeight').val()) || 0;
      const freightAmount = parseFloat($('#editFreightAmount').val()) || 0;
      if (weight > 0) {
        $('#editFreightRate').val((freightAmount / weight).toFixed(2));
      }
      calculateEditAmount();
    }

    // Calculate amount for edit form
    function calculateEditAmount() {
      const billingAmount = parseFloat($('#editBillingAmount').val()) || 0;
      const freightAmount = parseFloat($('#editFreightAmount').val()) || 0;

      const totalExpenses = (parseFloat($('#editTyreExpenses').val()) || 0) +
                            (parseFloat($('#editDieselExpenses').val()) || 0) +
                            (parseFloat($('#editTollExpenses').val()) || 0) +
                            (parseFloat($('#editVehicleWork').val()) || 0) +
                            (parseFloat($('#editFoodExpenses').val()) || 0) +
                            (parseFloat($('#editOtherExpenses').val()) || 0) +
                            (parseFloat($('#editShortage').val()) || 0) +
                            (parseFloat($('#editAdvance').val()) || 0);

      const cgstPercentage = parseFloat($('#editCgstPercentage').val()) || 0;
      const sgstPercentage = parseFloat($('#editSgstPercentage').val()) || 0;
      const cgstAmount = billingAmount * (cgstPercentage / 100);
      const sgstAmount = billingAmount * (sgstPercentage / 100);
      const grandTotal = billingAmount + cgstAmount + sgstAmount;

      $('#editCgstAmount').val(cgstAmount.toFixed(2));
      $('#editSgstAmount').val(sgstAmount.toFixed(2));
      $('#editTotalAmount').val(grandTotal.toFixed(2));
    }

    // Save edited LR record
    function saveEditLR() {
      if (!currentEditId) return;
      const lrToUpdate = lrData.find(lr => lr.id === currentEditId);
      if (!lrToUpdate) return;

      const selectedClientOption = $('#editClientId option:selected');
      const newClientId = $('#editClientId').val();
      const newConsignorName = selectedClientOption.text();
      
      const updatedData = {
        ...lrToUpdate,
        date: $('#editLrDate').val(),
        lrNumber: $('#editLrNumber').val(),
        truckNumber: $('#editTruckNumber').val(),
        clientId: newClientId,
        consignor: newConsignorName,
        consignee: $('#editConsignee').val(),
        fromLocation: $('#editFromLocation').val(),
        toLocation: $('#editToLocation').val(),
        weight: parseFloat($('#editWeight').val()) || 0,
        item: $('#editItem').val(),
        shipmentNo: $('#editShipmentNo').val(),
        billingRate: parseFloat($('#editBillingRate').val()) || 0,
        billingAmount: parseFloat($('#editBillingAmount').val()) || 0,
        freightRate: parseFloat($('#editFreightRate').val()) || 0,
        freightAmount: parseFloat($('#editFreightAmount').val()) || 0,
        paymentType: $('#editPaymentType').val(),
        bankName: $('#editBankName').val(),
        shortage: parseFloat($('#editShortage').val()) || 0,
        advance: parseFloat($('#editAdvance').val()) || 0,
        otherExpenses: parseFloat($('#editOtherExpenses').val()) || 0,
        tyreExpenses: parseFloat($('#editTyreExpenses').val()) || 0,
        dieselExpenses: parseFloat($('#editDieselExpenses').val()) || 0,
        tollExpenses: parseFloat($('#editTollExpenses').val()) || 0,
        vehicleWork: parseFloat($('#editVehicleWork').val()) || 0,
        foodExpenses: parseFloat($('#editFoodExpenses').val()) || 0,
        cgstPercentage: parseFloat($('#editCgstPercentage').val()) || 0,
        sgstPercentage: parseFloat($('#editSgstPercentage').val()) || 0,
        cgstAmount: parseFloat($('#editCgstAmount').val()) || 0,
        sgstAmount: parseFloat($('#editSgstAmount').val()) || 0,
        totalAmount: parseFloat($('#editTotalAmount').val()) || 0,
        updatedAt: new Date().toISOString()
      };

      const oldAmount = lrToUpdate.totalAmount || 0;
      const newAmount = updatedData.totalAmount || 0;
      const amountDifference = newAmount - oldAmount;
      const oldClientId = lrToUpdate.clientId;
      
      const user = auth.currentUser;
      if (!user) return;

      const updates = {};
      updates[`/lrReports/${currentEditId}`] = updatedData;

      if (oldClientId !== newClientId) {
        // Client has changed. Atomically update trips and outstanding for both.
        // 1. Revert changes for the old client.
        if (oldClientId) {
          updates[`/users/${user.uid}/clients/${oldClientId}/totalTrips`] = firebase.database.ServerValue.increment(-1);
          updates[`/users/${user.uid}/clients/${oldClientId}/outstanding`] = firebase.database.ServerValue.increment(-oldAmount);
        }
        // 2. Apply changes for the new client.
        if (newClientId) {
          updates[`/users/${user.uid}/clients/${newClientId}/totalTrips`] = firebase.database.ServerValue.increment(1);
          updates[`/users/${user.uid}/clients/${newClientId}/outstanding`] = firebase.database.ServerValue.increment(newAmount);
        }
      } else {
        // Client is the same, just update the outstanding amount if it changed.
        if (amountDifference !== 0 && newClientId) {
          updates[`/users/${user.uid}/clients/${newClientId}/outstanding`] = firebase.database.ServerValue.increment(amountDifference);
        }
      }

      db.ref().update(updates)
        .then(() => {
          $('#editLRModal').modal('hide');
          alert('LR record updated successfully!');
        })
        .catch((error) => {
          alert('Error updating LR record: ' + error.message);
        });
    }

    // Delete LR record
    window.deleteLR = function(id) {
      if (!confirm('Are you sure you want to delete this LR record? This will also update the client\'s balance.')) return;
      
      const user = auth.currentUser;
      if (!user) return;

      const lrToDelete = lrData.find(lr => lr.id === id);
      if (!lrToDelete) {
        alert('Error: LR record not found. It might have already been deleted.');
        return;
      }

      const updates = {};
      // Mark the LR for deletion
      updates[`/lrReports/${id}`] = null;

      // If the LR was linked to a client, prepare to update their stats
      if (lrToDelete.clientId) {
        updates[`/users/${user.uid}/clients/${lrToDelete.clientId}/totalTrips`] = firebase.database.ServerValue.increment(-1);
        updates[`/users/${user.uid}/clients/${lrToDelete.clientId}/outstanding`] = firebase.database.ServerValue.increment(-(lrToDelete.totalAmount || 0));
      }

      // Perform the atomic update
      db.ref().update(updates)
        .then(() => {
          alert('LR record deleted successfully!');
          // The onValue listener will automatically update the table
        })
        .catch((error) => {
          alert('Error deleting LR record: ' + error.message);
        });
    }
  </script>
</body>
</html>
