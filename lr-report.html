<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LR Management - Transport System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <style>
    body { padding: 0; margin: 0; background-color: #f8f9fa; }
    .tab-content { background: white; padding: 20px; border-radius: 0 0 8px 8px; }
    .subtotal-row { background-color: #f8f9fa; font-weight: bold; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

  <!-- Navbar will be loaded here -->
  <div id="navbar-container"></div>

  <div class="container">
    <h2 class="mb-4"><i class="fas fa-file-invoice me-2"></i>LR Management</h2>
    
    <!-- Tabs -->
    <ul class="nav nav-tabs" id="lrTabs">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#view">View Entries</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#add">Add New LR</a>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- View Tab -->
      <div class="tab-pane fade show active" id="view">
        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label">From Date</label>
            <input type="date" class="form-control" id="fromDate">
          </div>
          <div class="col-md-3">
            <label class="form-label">To Date</label>
            <input type="date" class="form-control" id="toDate">
          </div>
          <div class="col-md-3">
            <label class="form-label">Truck Number</label>
            <select class="form-select" id="truckFilter">
              <option value="">All Trucks</option>
            </select>
          </div>
          <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-primary me-2" id="applyFiltersBtn">Filter</button>
            <button class="btn btn-success" id="exportPdfBtn">PDF</button>
          </div>
        </div>
        <div class="table-responsive">
          <table id="lrTable" class="table table-striped">
            <thead>
              <tr>
                <th>Date</th>
                <th>LR No</th>
                <th>Truck No</th>
                <th>Consignor</th>
                <th>Consignee</th>
                <th>Item</th>
                <th>From</th>
                <th>To</th>
                <th>Weight</th>
                <th>Billing Amount</th>
                <th>Freight Amount</th>
                <th>Total Amount</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Add Tab -->
      <div class="tab-pane fade" id="add">
        <form id="lrForm">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Date <span class="text-danger">*</span></label>
              <input type="date" class="form-control" id="lrDate" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">LR Number <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="lrNumber" required>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Truck Number <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="truckNumber" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Consignor <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="consignor" required>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">From Location <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="fromLocation" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">To Location <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="toLocation" required>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Weight (tonne) <span class="text-danger">*</span></label>
              <input type="number" class="form-control" id="weight" step="0.01" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Consignee</label>
              <input type="text" class="form-control" id="consignee">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Item</label>
              <input type="text" class="form-control" id="item">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Shipment No.</label>
              <input type="text" class="form-control" id="shipmentNo">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Invoice No.</label>
              <input type="text" class="form-control" id="invoiceNo">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Billing Rate (₹/tonne)</label>
              <input type="number" step="0.01" class="form-control" id="billingRate" oninput="calculateBillingAmount()">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Billing Amount (₹)</label>
              <input type="number" step="0.01" class="form-control" id="billingAmount" oninput="calculateBillingRate()">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Freight Rate (₹/tonne)</label>
              <input type="number" step="0.01" class="form-control" id="freightRate" oninput="calculateFreightAmount()">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Freight Amount (₹)</label>
              <input type="number" step="0.01" class="form-control" id="freightAmount" oninput="calculateFreightRate()">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Payment Type</label>
              <select class="form-select" id="paymentType">
                <option value="">Select Payment Type</option>
                <option value="Cash">Cash</option>
                <option value="Credit">Credit</option>
                <option value="Bank Transfer">Bank Transfer</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Bank Name</label>
              <input type="text" class="form-control" id="bankName">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Shortage (₹)</label>
              <input type="number" step="0.01" class="form-control" id="shortage" value="0" oninput="calculateAmount()">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Other Expenses (₹)</label>
              <input type="number" step="0.01" class="form-control" id="otherExpenses" value="0" oninput="calculateAmount()">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Diesel Cost (₹)</label>
              <input type="number" step="0.01" class="form-control" id="dieselCost" value="0" oninput="calculateAmount()">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Subtotal (Before GST) (₹)</label>
              <input type="number" step="0.01" class="form-control" id="subtotal" readonly>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">GST %</label>
              <input type="number" step="0.01" class="form-control" id="gstPercentage" value="18" oninput="calculateGST()">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">GST Amount (₹)</label>
              <input type="number" step="0.01" class="form-control" id="gstAmount" readonly>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Total Amount (₹)</label>
              <input type="number" step="0.01" class="form-control" id="totalAmount" readonly>
            </div>
          </div>
          <button type="button" class="btn btn-primary" id="saveLRBtn">Save LR</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="editLRModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit LR Record</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editLrForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Date <span class="text-danger">*</span></label>
                <input type="date" class="form-control" id="editLrDate" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">LR Number <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="editLrNumber" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Truck Number <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="editTruckNumber" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Consignor <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="editConsignor" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">From Location <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="editFromLocation" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">To Location <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="editToLocation" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Weight (tonne) <span class="text-danger">*</span></label>
                <input type="number" class="form-control" id="editWeight" step="0.01" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Consignee</label>
                <input type="text" class="form-control" id="editConsignee">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Item</label>
                <input type="text" class="form-control" id="editItem">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Shipment No.</label>
                <input type="text" class="form-control" id="editShipmentNo">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Invoice No.</label>
                <input type="text" class="form-control" id="editInvoiceNo">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Billing Rate (₹/tonne)</label>
                <input type="number" step="0.01" class="form-control" id="editBillingRate" oninput="calculateEditBillingAmount()">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Billing Amount (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editBillingAmount" oninput="calculateEditBillingRate()">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Freight Rate (₹/tonne)</label>
                <input type="number" step="0.01" class="form-control" id="editFreightRate" oninput="calculateEditFreightAmount()">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Freight Amount (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editFreightAmount" oninput="calculateEditFreightRate()">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Payment Type</label>
                <select class="form-select" id="editPaymentType">
                  <option value="">Select Payment Type</option>
                  <option value="Cash">Cash</option>
                  <option value="Credit">Credit</option>
                  <option value="Bank Transfer">Bank Transfer</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Bank Name</label>
                <input type="text" class="form-control" id="editBankName">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Shortage (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editShortage" value="0" oninput="calculateEditAmount()">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Other Expenses (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editOtherExpenses" value="0" oninput="calculateEditAmount()">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Diesel Cost (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editDieselCost" value="0" oninput="calculateEditAmount()">
              </div>
            </div>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">GST %</label>
                <input type="number" step="0.01" class="form-control" id="editGstPercentage" value="18" oninput="calculateEditGST()">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">GST Amount (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editGstAmount" readonly>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Total Amount (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editTotalAmount" readonly>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="saveEditBtn">Save changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    // Load navbar
    $(document).ready(function() {
      $("#navbar-container").load("navbar.html", function() {
        $("#navbar-container a[href='lr-management.html']").addClass('active');
      });
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDAlk_K8p8Of8Ne6Jpcl2QqXTtm95NgG7o",
      authDomain: "transport-dashboard-ad69a.firebaseapp.com",
      databaseURL: "https://transport-dashboard-ad69a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "transport-dashboard-ad69a",
      storageBucket: "transport-dashboard-ad69a.appspot.com",
      messagingSenderId: "526889676196",
      appId: "1:526889676196:web:66032c80a4aede690ae531"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }

    const db = firebase.database();
    const auth = firebase.auth();

    // Global variables
    let lrTable;
    let lrData = [];
    let currentEditId = null;

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      // Check authentication state
      auth.onAuthStateChanged(function(user) {
        if (!user) {
          window.location.href = 'login.html';
          return;
        }
        initializePage();
      });
    });

    function initializePage() {
      // Set default dates
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('lrDate').value = today;
      document.getElementById('fromDate').value = today;
      document.getElementById('toDate').value = today;

      // Initialize DataTable
      lrTable = $('#lrTable').DataTable({
        order: [[0, 'desc']],
        pageLength: 25,
        responsive: true,
        columns: [
          { data: 'date', render: formatDate },
          { data: 'lrNumber' },
          { data: 'truckNumber' },
          { data: 'consignor' },
          { data: 'consignee' },
          { data: 'item' },
          { data: 'fromLocation' },
          { data: 'toLocation' },
          { data: 'weight', render: (v) => v ? `${Number(v).toFixed(2)}` : '-' },
          { data: 'billingAmount', render: (v) => v ? `₹${Number(v).toFixed(2)}` : '-' },
          { data: 'freightAmount', render: (v) => v ? `₹${Number(v).toFixed(2)}` : '-' },
          { data: 'totalAmount', render: (v) => v ? `₹${Number(v).toFixed(2)}` : '-', className: 'fw-bold' },
          { 
            data: 'status', 
            render: (status) => {
              const badgeClass = status === 'active' ? 'bg-success' : (status === 'completed' ? 'bg-primary' : 'bg-danger');
              return `<span class="badge ${badgeClass}">${status}</span>`;
            }
          },
          {
            data: null,
            render: function(data, type, row) {
              return `
                <div class="btn-group">
                  <button class="btn btn-sm btn-primary" onclick="editLR('${row.id}')">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="deleteLR('${row.id}')">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>`;
            },
            orderable: false,
            searchable: false
          }
        ]
      });

      // Add event listeners
      document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
      document.getElementById('exportPdfBtn').addEventListener('click', exportToPDF);
      document.getElementById('saveLRBtn').addEventListener('click', saveLR);
      document.getElementById('saveEditBtn').addEventListener('click', saveEdit);

      // Load data
      loadLRData();

      // Calculate initial amounts
      setTimeout(() => {
        calculateAmount();
        calculateGST();
      }, 300);
    }

    // Utility functions
    function getVal(id, prefix = '') {
      const el = document.getElementById(prefix + id);
      return el ? parseFloat(el.value) || 0 : 0;
    }

    function getStr(id, prefix = '') {
      const el = document.getElementById(prefix + id);
      return el ? el.value : '';
    }

    function setVal(id, val, prefix = '') {
      const el = document.getElementById(prefix + id);
      if (el) el.value = (typeof val === 'number' ? (+val).toFixed(2) : val);
    }

    function formatDate(dateString) {
      if (!dateString) return '-';
      const options = { year: 'numeric', month: 'short', day: 'numeric' };
      return new Date(dateString).toLocaleDateString('en-US', options);
    }

    // Calculation functions for add form
    function calculateBillingAmount() {
      const weight = getVal('weight');
      const billingRate = getVal('billingRate');
      const billingAmount = weight * billingRate;
      setVal('billingAmount', billingAmount);
      calculateAmount();
    }

    function calculateBillingRate() {
      const weight = getVal('weight');
      const billingAmount = getVal('billingAmount');
      if (weight > 0) {
        const billingRate = billingAmount / weight;
        setVal('billingRate', billingRate);
      }
      calculateAmount();
    }

    function calculateFreightAmount() {
      const weight = getVal('weight');
      const freightRate = getVal('freightRate');
      const freightAmount = weight * freightRate;
      setVal('freightAmount', freightAmount);
      calculateAmount();
    }

    function calculateFreightRate() {
      const weight = getVal('weight');
      const freightAmount = getVal('freightAmount');
      if (weight > 0) {
        const freightRate = freightAmount / weight;
        setVal('freightRate', freightRate);
      }
      calculateAmount();
    }

    function calculateAmount() {
      const billingAmount = getVal('billingAmount');
      const freightAmount = getVal('freightAmount');
      const shortage = getVal('shortage');
      const otherExpenses = getVal('otherExpenses');
      const dieselCost = getVal('dieselCost');
      
      const subtotal = billingAmount + freightAmount - shortage - otherExpenses - dieselCost;
      setVal('subtotal', subtotal);
      calculateGST();
    }

    function calculateGST() {
      const subtotal = getVal('subtotal');
      const gstPercentage = getVal('gstPercentage');
      const gstAmount = subtotal * (gstPercentage / 100);
      const totalAmount = subtotal + gstAmount;
      
      setVal('gstAmount', gstAmount);
      setVal('totalAmount', totalAmount);
    }

    // Calculation functions for edit form
    function calculateEditBillingAmount() {
      const weight = getVal('Weight', 'edit');
      const billingRate = getVal('BillingRate', 'edit');
      const billingAmount = weight * billingRate;
      setVal('BillingAmount', billingAmount, 'edit');
      calculateEditAmount();
    }

    function calculateEditBillingRate() {
      const weight = getVal('Weight', 'edit');
      const billingAmount = getVal('BillingAmount', 'edit');
      if (weight > 0) {
        const billingRate = billingAmount / weight;
        setVal('BillingRate', billingRate, 'edit');
      }
      calculateEditAmount();
    }

    function calculateEditFreightAmount() {
      const weight = getVal('Weight', 'edit');
      const freightRate = getVal('FreightRate', 'edit');
      const freightAmount = weight * freightRate;
      setVal('FreightAmount', freightAmount, 'edit');
      calculateEditAmount();
    }

    function calculateEditFreightRate() {
      const weight = getVal('Weight', 'edit');
      const freightAmount = getVal('FreightAmount', 'edit');
      if (weight > 0) {
        const freightRate = freightAmount / weight;
        setVal('FreightRate', freightRate, 'edit');
      }
      calculateEditAmount();
    }

    function calculateEditAmount() {
      const billingAmount = getVal('BillingAmount', 'edit');
      const freightAmount = getVal('FreightAmount', 'edit');
      const shortage = getVal('Shortage', 'edit');
      const otherExpenses = getVal('OtherExpenses', 'edit');
      const dieselCost = getVal('DieselCost', 'edit');
      
      const subtotal = billingAmount + freightAmount - shortage - otherExpenses - dieselCost;
      calculateEditGST(subtotal);
    }

    function calculateEditGST(subtotal = null) {
      if (subtotal === null) {
        const billingAmount = getVal('BillingAmount', 'edit');
        const freightAmount = getVal('FreightAmount', 'edit');
        const shortage = getVal('Shortage', 'edit');
        const otherExpenses = getVal('OtherExpenses', 'edit');
        const dieselCost = getVal('DieselCost', 'edit');
        subtotal = billingAmount + freightAmount - shortage - otherExpenses - dieselCost;
      }
      
      const gstPercentage = getVal('GstPercentage', 'edit');
      const gstAmount = subtotal * (gstPercentage / 100);
      const totalAmount = subtotal + gstAmount;
      
      setVal('GstAmount', gstAmount, 'edit');
      setVal('TotalAmount', totalAmount, 'edit');
    }

    // Data operations
    function loadLRData() {
      const user = auth.currentUser;
      if (!user) return;
      
      const lrRef = db.ref('lrReports');
      lrRef.orderByChild('userId').equalTo(user.uid).on('value', (snapshot) => {
        lrData = [];
        const trucks = new Set();

        snapshot.forEach((child) => {
          const data = child.val();
          if (data) {
            const lrEntry = {
              id: child.key,
              date: data.date || '',
              lrNumber: data.lrNumber || '',
              truckNumber: data.truckNumber || '',
              consignor: data.consignor || '',
              consignee: data.consignee || '',
              item: data.item || '',
              fromLocation: data.fromLocation || '',
              toLocation: data.toLocation || '',
              shipmentNo: data.shipmentNo || '',
              invoiceNo: data.invoiceNo || '',
              weight: data.weight ? parseFloat(data.weight) : 0,
              billingRate: data.billingRate ? parseFloat(data.billingRate) : 0,
              billingAmount: data.billingAmount ? parseFloat(data.billingAmount) : 0,
              freightRate: data.freightRate ? parseFloat(data.freightRate) : 0,
              freightAmount: data.freightAmount ? parseFloat(data.freightAmount) : 0,
              paymentType: data.paymentType || '',
              bankName: data.bankName || '',
              shortage: data.shortage ? parseFloat(data.shortage) : 0,
              otherExpenses: data.otherExpenses ? parseFloat(data.otherExpenses) : 0,
              dieselCost: data.dieselCost ? parseFloat(data.dieselCost) : 0,
              gstPercentage: data.gstPercentage ? parseFloat(data.gstPercentage) : 0,
              gstAmount: data.gstAmount ? parseFloat(data.gstAmount) : 0,
              totalAmount: data.totalAmount ? parseFloat(data.totalAmount) : 0,
              status: data.status || 'active',
              createdAt: data.createdAt || '',
              updatedAt: data.updatedAt || ''
            };
            lrData.push(lrEntry);
            if (lrEntry.truckNumber) trucks.add(lrEntry.truckNumber);
          }
        });

        updateTruckFilter(Array.from(trucks).sort());
        applyFilters();
      });
    }

    function updateTruckFilter(trucks) {
      const select = document.getElementById('truckFilter');
      if (!select) return;
      
      // Save current value
      const currentValue = select.value;
      
      // Clear and rebuild options
      select.innerHTML = '<option value="">All Trucks</option>';
      trucks.forEach(truck => {
        const option = document.createElement('option');
        option.value = truck;
        option.textContent = truck;
        select.appendChild(option);
      });
      
      // Restore previous selection if still available
      if (currentValue && trucks.includes(currentValue)) {
        select.value = currentValue;
      }
    }

    function applyFilters() {
      const fromDate = document.getElementById('fromDate').value;
      const toDate = document.getElementById('toDate').value;
      const truckNumber = document.getElementById('truckFilter').value;

      let filteredData = [...lrData];

      // Apply date filter
      if (fromDate) {
        const from = new Date(fromDate);
        filteredData = filteredData.filter(item => new Date(item.date) >= from);
      }

      if (toDate) {
        const to = new Date(toDate);
        to.setHours(23, 59, 59, 999);
        filteredData = filteredData.filter(item => new Date(item.date) <= to);
      }

      // Apply truck filter
      if (truckNumber) {
        filteredData = filteredData.filter(item => item.truckNumber === truckNumber);
      }

      updateTable(filteredData);
    }

    function updateTable(data) {
      lrTable.clear().rows.add(data).draw();
    }

    function saveLR() {
      const user = auth.currentUser;
      if (!user) {
        alert('You must be logged in to save LR data.');
        return;
      }

      // Validate required fields
      const requiredFields = ['lrDate', 'lrNumber', 'truckNumber', 'consignor', 'fromLocation', 'toLocation', 'weight'];
      for (const field of requiredFields) {
        if (!document.getElementById(field).value) {
          alert(`Please fill in the ${field.replace(/([A-Z])/g, ' $1').toLowerCase()} field.`);
          return;
        }
      }

      // Recalculate to ensure all values are up to date
      calculateAmount();
      calculateGST();

      const lrData = {
        date: getStr('lrDate'),
        lrNumber: getStr('lrNumber'),
        truckNumber: getStr('truckNumber'),
        consignor: getStr('consignor'),
        consignee: getStr('consignee'),
        item: getStr('item'),
        fromLocation: getStr('fromLocation'),
        toLocation: getStr('toLocation'),
        shipmentNo: getStr('shipmentNo'),
        invoiceNo: getStr('invoiceNo'),
        weight: getVal('weight'),
        billingRate: getVal('billingRate'),
        billingAmount: getVal('billingAmount'),
        freightRate: getVal('freightRate'),
        freightAmount: getVal('freightAmount'),
        paymentType: getStr('paymentType'),
        bankName: getStr('bankName'),
        shortage: getVal('shortage'),
        otherExpenses: getVal('otherExpenses'),
        dieselCost: getVal('dieselCost'),
        gstPercentage: getVal('gstPercentage'),
        gstAmount: getVal('gstAmount'),
        totalAmount: getVal('totalAmount'),
        status: 'active',
        userId: user.uid,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };

      // Save to Firebase
      db.ref('lrReports').push(lrData)
        .then(() => {
          alert('LR saved successfully!');
          document.getElementById('lrForm').reset();
          
          // Reset date to today
          const today = new Date().toISOString().split('T')[0];
          document.getElementById('lrDate').value = today;
          
          // Switch to view tab
          const viewTab = document.querySelector('a[href="#view"]');
          if (viewTab) {
            new bootstrap.Tab(viewTab).show();
          }
        })
        .catch(error => {
          console.error('Error saving LR:', error);
          alert('Error saving LR. Please try again.');
        });
    }

    function editLR(id) {
      currentEditId = id;
      const lr = lrData.find(item => item.id === id);
      if (!lr) return;

      // Fill the edit form
      setVal('LrDate', lr.date, 'edit');
      setVal('LrNumber', lr.lrNumber, 'edit');
      setVal('TruckNumber', lr.truckNumber, 'edit');
      setVal('Consignor', lr.consignor, 'edit');
      setVal('Consignee', lr.consignee, 'edit');
      setVal('Item', lr.item, 'edit');
      setVal('FromLocation', lr.fromLocation, 'edit');
      setVal('ToLocation', lr.toLocation, 'edit');
      setVal('ShipmentNo', lr.shipmentNo, 'edit');
      setVal('InvoiceNo', lr.invoiceNo, 'edit');
      setVal('Weight', lr.weight, 'edit');
      setVal('BillingRate', lr.billingRate, 'edit');
      setVal('BillingAmount', lr.billingAmount, 'edit');
      setVal('FreightRate', lr.freightRate, 'edit');
      setVal('FreightAmount', lr.freightAmount, 'edit');
      document.getElementById('editPaymentType').value = lr.paymentType || '';
      setVal('BankName', lr.bankName, 'edit');
      setVal('Shortage', lr.shortage, 'edit');
      setVal('OtherExpenses', lr.otherExpenses, 'edit');
      setVal('DieselCost', lr.dieselCost, 'edit');
      setVal('GstPercentage', lr.gstPercentage, 'edit');
      setVal('GstAmount', lr.gstAmount, 'edit');
      setVal('TotalAmount', lr.totalAmount, 'edit');

      // Show the modal
      const editModal = new bootstrap.Modal(document.getElementById('editLRModal'));
      editModal.show();

      // Recalculate amounts
      setTimeout(() => {
        calculateEditAmount();
      }, 100);
    }

    function saveEdit() {
      if (!currentEditId) return;

      const user = auth.currentUser;
      if (!user) {
        alert('You must be logged in to update LR data.');
        return;
      }

      // Recalculate to ensure all values are up to date
      calculateEditAmount();

      const updatedData = {
        date: getStr('LrDate', 'edit'),
        lrNumber: getStr('LrNumber', 'edit'),
        truckNumber: getStr('TruckNumber', 'edit'),
        consignor: getStr('Consignor', 'edit'),
        consignee: getStr('Consignee', 'edit'),
        item: getStr('Item', 'edit'),
        fromLocation: getStr('FromLocation', 'edit'),
        toLocation: getStr('ToLocation', 'edit'),
        shipmentNo: getStr('ShipmentNo', 'edit'),
        invoiceNo: getStr('InvoiceNo', 'edit'),
        weight: getVal('Weight', 'edit'),
        billingRate: getVal('BillingRate', 'edit'),
        billingAmount: getVal('BillingAmount', 'edit'),
        freightRate: getVal('FreightRate', 'edit'),
        freightAmount: getVal('FreightAmount', 'edit'),
        paymentType: getStr('PaymentType', 'edit'),
        bankName: getStr('BankName', 'edit'),
        shortage: getVal('Shortage', 'edit'),
        otherExpenses: getVal('OtherExpenses', 'edit'),
        dieselCost: getVal('DieselCost', 'edit'),
        gstPercentage: getVal('GstPercentage', 'edit'),
        gstAmount: getVal('GstAmount', 'edit'),
        totalAmount: getVal('TotalAmount', 'edit'),
        updatedAt: new Date().toISOString()
      };

      // Update in Firebase
      db.ref(`lrReports/${currentEditId}`).update(updatedData)
        .then(() => {
          alert('LR updated successfully!');
          const modal = bootstrap.Modal.getInstance(document.getElementById('editLRModal'));
          if (modal) modal.hide();
        })
        .catch(error => {
          console.error('Error updating LR:', error);
          alert('Error updating LR. Please try again.');
        });
    }

    function deleteLR(id) {
      if (!confirm('Are you sure you want to delete this LR record?')) return;

      db.ref(`lrReports/${id}`).remove()
        .then(() => {
          alert('LR deleted successfully!');
        })
        .catch(error => {
          console.error('Error deleting LR:', error);
          alert('Error deleting LR. Please try again.');
        });
    }

    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({
        orientation: 'landscape',
        unit: 'mm',
        format: 'a4'
      });

      // Title
      doc.setFontSize(16);
      doc.text('LR Management Report', 14, 15);
      
      // Date range
      doc.setFontSize(10);
      const fromDate = document.getElementById('fromDate').value;
      const toDate = document.getElementById('toDate').value;
      const dateRange = `Date Range: ${fromDate} to ${toDate}`;
      doc.text(dateRange, 14, 22);
      
      // Generated date
      doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 28);

      // Table data
      const tableData = [];
      const tableColumns = [
        'Date', 'LR No', 'Truck No', 'Consignor', 'Consignee', 
        'From', 'To', 'Weight', 'Billing Amt', 'Freight Amt', 'Total Amt'
      ];

      // Get filtered data from DataTable
      const filteredData = lrTable.rows({ search: 'applied' }).data().toArray();
      
      filteredData.forEach(row => {
        tableData.push([
          formatDate(row.date),
          row.lrNumber || '',
          row.truckNumber || '',
          row.consignor || '',
          row.consignee || '',
          row.fromLocation || '',
          row.toLocation || '',
          row.weight ? Number(row.weight).toFixed(2) : '0.00',
          row.billingAmount ? `₹${Number(row.billingAmount).toFixed(2)}` : '₹0.00',
          row.freightAmount ? `₹${Number(row.freightAmount).toFixed(2)}` : '₹0.00',
          row.totalAmount ? `₹${Number(row.totalAmount).toFixed(2)}` : '₹0.00'
        ]);
      });

      // Add summary row
      const totalBilling = filteredData.reduce((sum, row) => sum + (row.billingAmount || 0), 0);
      const totalFreight = filteredData.reduce((sum, row) => sum + (row.freightAmount || 0), 0);
      const totalAmount = filteredData.reduce((sum, row) => sum + (row.totalAmount || 0), 0);
      
      tableData.push([
        '', '', '', '', '', '', '',
        'TOTALS:',
        `₹${totalBilling.toFixed(2)}`,
        `₹${totalFreight.toFixed(2)}`,
        `₹${totalAmount.toFixed(2)}`
      ]);

      // Create table
      doc.autoTable({
        head: [tableColumns],
        body: tableData,
        startY: 35,
        theme: 'grid',
        headStyles: {
          fillColor: [46, 139, 87],
          textColor: 255,
          fontStyle: 'bold'
        },
        footStyles: {
          fillColor: [220, 220, 220],
          textColor: 0,
          fontStyle: 'bold'
        },
        styles: {
          fontSize: 8,
          cellPadding: 1
        },
        margin: { top: 35 }
      });

      // Save the PDF
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
      doc.save(`LR_Report_${timestamp}.pdf`);
    }

    function toggleMenu() {
      const navLinks = document.getElementById('navLinks');
      navLinks.classList.toggle('show');
    }

    function logout() {
      auth.signOut()
        .then(() => {
          window.location.href = 'index.html';
        })
        .catch(error => {
          console.error('Logout error:', error);
        });
    }
  </script>
</body>
</html>
