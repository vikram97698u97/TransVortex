<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LR Management - Transport System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <style>
    body { padding: 0; margin: 0; background-color: #f8f9fa; }
    .tab-content { background: white; padding: 20px; border-radius: 0 0 8px 8px; }
    .subtotal-row { background-color: #f8f9fa; font-weight: bold; }
    
    /* Vehicle Validation Styles */
    .vehicle-suggestions {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      width: calc(100% - 30px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .vehicle-suggestion {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .vehicle-suggestion:hover {
      background-color: #f8f9fa;
    }

    .vehicle-suggestion:last-child {
      border-bottom: none;
    }

    .vehicle-not-found {
      color: #dc3545;
      font-size: 0.875em;
      margin-top: 5px;
      display: none;
    }

    .vehicle-input-container {
      position: relative;
    }

    .vehicle-valid {
      border-color: #28a745 !important;
    }

    .vehicle-invalid {
      border-color: #dc3545 !important;
    }

    /* Custom style for the client dropdown */
    #clientId {
      color: #2E8B57;
      font-weight: 500;
    }

    /* Modern LR Copy Styles */
    .lr-copy-container {
      font-family: Arial, sans-serif;
      font-size: 14px;
      color: #333;
      padding: 20px;
      background: #ffffff; /* Changed to white background */
      max-width: 800px;
      margin: 0 auto;
    }

    .lr-header {
      text-align: center;
      margin-bottom: 15px;
    }

    .lr-header h4 {
      margin: 0;
      font-size: 18px;
      font-weight: bold;
    }

    .lr-header p {
      margin: 5px 0 0 0;
    }

    .lr-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    
    .lr-info-left, .lr-info-right {
      width: 48%;
    }
    
    .lr-row {
      margin-bottom: 10px;
    }
    
    .lr-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    
    .lr-table th, .lr-table td {
      border: 1px solid #000;
      padding: 8px;
      text-align: left;
    }
    
    .lr-table th {
      background-color: #f2f2f2;
    }
    
    .safety-section {
      margin-top: 20px;
      border-top: 1px solid #ddd;
      padding-top: 10px;
    }
    
    .receipt-section {
      margin-top: 20px;
      border-top: 1px solid #ddd;
      padding-top: 10px;
    }

    .lr-footer {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
    }
    
    .signature-box {
      width: 45%;
      text-align: center;
    }
    
    .signature-line {
      margin-top: 50px;
      border-top: 1px solid #000;
    }
    
    .stamp {
      border: 2px solid #000;
      border-radius: 50%;
      width: 100px;
      height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      transform: rotate(-15deg);
      font-weight: bold;
    }
    
    .terms-conditions {
      margin-top: 25px;
      padding: 15px;
      font-size: 12px;
    }
    
    @media print {
      body {
        background-color: #ffffd9;
        padding: 0;
      }
      
      .lr-copy-container {
        box-shadow: none;
        max-width: 100%;
      }
      
      .no-print {
        display: none;
      }
    }

    .terms-conditions h6 {
      margin-top: 0;
      color: #2c3e50;
    }

    .lr-barcode {
      text-align: center;
      margin: 20px 0;
      padding: 10px;
      border-top: 1px dashed #ccc;
      border-bottom: 1px dashed #ccc;
    }

  </style>
</head>
<body>

  <!-- Navbar will be loaded here by navbar-loader.js -->
  <div id="navbar-placeholder"></div>

  <div class="container">
    <h2 class="mb-4"><i class="fas fa-file-invoice me-2"></i>LR Management</h2>
    
    <!-- Tabs -->
    <ul class="nav nav-tabs" id="lrTabs">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#view">View Entries</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#add">Add New LR</a>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- View Tab -->
      <div class="tab-pane fade show active" id="view">
        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label">From Date</label>
            <input type="date" class="form-control" id="fromDate">
          </div>
          <div class="col-md-3">
            <label class="form-label">To Date</label>
            <input type="date" class="form-control" id="toDate">
          </div>
          <div class="col-md-3">
            <label class="form-label">Truck Number</label>
            <select class="form-select" id="truckFilter">
              <option value="">All Trucks</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">LR Number</label>
            <input type="text" class="form-control" id="lrSearchInput" placeholder="Search by LR No...">
          </div>
          <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-primary me-2" id="applyFiltersBtn">Filter</button>
            <button class="btn btn-success" id="exportPdfBtn">PDF</button>
          </div>
        </div>
        <div class="mb-3">
          <button class="btn btn-primary" id="generateInvoiceBtn" onclick="showBankDetailsModal()" disabled>
            <i class="fas fa-file-invoice me-2"></i>Generate Invoice
          </button>
        </div>
        <div class="table-responsive">
          <table id="lrTable" class="table table-striped">
            <thead>
              <tr>
                <th>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="selectAllCheckbox">
                  </div>
                </th>
                <th>Date</th>
                <th>LR No</th>
                <th>Truck No</th>
                <th>Consignor</th>
                <th>Consignee</th>
                <th>Item</th>
                <th>From</th>
                <th>To</th>
                <th>Weight</th>
                <th>Billing Amount</th>
                <th>Freight Amount</th>
                <th>Status</th>
                <th>LR Copy</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Rows will be populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Add Tab -->
      <div class="tab-pane fade" id="add">
        <form id="lrForm">
          <div class="card mb-4">
            <div class="card-header bg-light">
              <h5 class="mb-0"><i class="fas fa-file-invoice me-2"></i>Basic LR Information</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Date <span class="text-danger">*</span></label>
                  <input type="date" class="form-control" id="lrDate" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">LR Number <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="lrNumber" readonly>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3 vehicle-input-container">
                  <label class="form-label">Truck Number <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="truckNumber" required 
                         placeholder="Start typing vehicle number..."
                         oninput="searchVehicles(this.value)">
                  <div id="vehicleSuggestions" class="vehicle-suggestions" style="display: none;"></div>
                  <div id="vehicleNotFound" class="vehicle-not-found">
                    <i class="fas fa-exclamation-triangle"></i> This vehicle is not registered in the system.
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="clientId" class="form-label">Client / Consignor <span class="text-danger">*</span></label>
                  <select id="clientId" class="form-select" required>
                    <option value="">Select a Client</option>
                    <!-- Clients will be populated here by JavaScript -->
                  </select>
                </div>
              </div>
              <div class="row">
                <div class="col-md-12 mb-3">
                  <label class="form-label">Route (From --> To) <span class="text-danger">*</span></label>
                  <select class="form-select" id="routeSelect" required>
                    <option value="">Select a Route</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div class="card mb-4">
            <div class="card-header bg-light">
              <h5 class="mb-0"><i class="fas fa-box me-2"></i>Shipment Details</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Consignee (if different from client)</label>
                  <input type="text" class="form-control" id="consignee">
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Item</label>
                  <input type="text" class="form-control" id="item">
                </div>
              </div>
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label class="form-label">Shipment No.</label>
                  <input type="text" class="form-control" id="shipmentNo">
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">Number of Packages</label>
                  <input type="number" class="form-control" id="numPackages" placeholder="For package goods" oninput="calculateWeightFromPackages()">
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">Weight per Package (kg)</label>
                  <input type="number" step="0.01" class="form-control" id="weightPerPackage" placeholder="e.g., 50" oninput="calculateWeightFromPackages()">
                </div>
              </div>
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label class="form-label">Weight (tonne) <span class="text-danger">*</span></label>
                  <input type="number" class="form-control" id="weight" step="0.01" required oninput="handleManualWeightInput()">
                </div>
              </div>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-header bg-light">
              <h5 class="mb-0"><i class="fas fa-money-bill-alt me-2"></i>Billing Information</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Billing Rate (₹/tonne)</label>
                  <input type="number" step="0.01" class="form-control" id="billingRate" oninput="calculateBillingAmount()">
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Billing Amount (₹)</label>
                  <input type="number" step="0.01" class="form-control" id="billingAmount" oninput="calculateBillingRate()">
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Freight Rate (₹/tonne)</label>
                  <input type="number" step="0.01" class="form-control" id="freightRate" oninput="calculateFreightAmount()">
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Freight Amount (₹)</label>
                  <input type="number" step="0.01" class="form-control" id="freightAmount" oninput="calculateFreightRate()">
                </div>
              </div>
            </div>
          </div>
          
          <!-- EXPENSE FIELDS REORGANIZED -->
          <div class="card mb-4">
            <div class="card-header bg-light">
              <h5 class="mb-0"><i class="fas fa-tools me-2"></i>Vehicle Work</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="vehicleWorkVendor" class="form-label">Vehicle Work Vendor</label>
                  <select id="vehicleWorkVendor" class="form-select">
                    <option value="">Select Vendor</option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Vehicle Work Amount (₹)</label>
                  <input type="number" step="0.01" class="form-control" id="vehicleWorkAmount" value="0">
                </div>
                <div class="col-md-12 mb-3">
                  <label for="vehicleWorkNotes" class="form-label">Vehicle Work Notes</label>
                  <textarea id="vehicleWorkNotes" class="form-control" rows="2" placeholder="e.g., Engine oil change, brake service"></textarea>
                </div>
              </div>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-header bg-light">
              <h5 class="mb-0"><i class="fas fa-gas-pump me-2"></i>Fuel Information</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-3 mb-3">
                  <label class="form-label">Vehicle Average (km/l)</label>
                  <input type="number" step="0.01" min="0" class="form-control" id="vehicleAverage" placeholder="e.g., 3.5">
                </div>
                <div class="col-md-3 mb-3">
                  <label class="form-label">Route Distance (KM)</label>
                  <input type="number" step="0.01" min="0" class="form-control" id="routeDistanceKm" placeholder="Auto from route" readonly>
                </div>
                <div class="col-md-2 mb-3">
                  <label class="form-label">Fuel Used (L) [Auto]</label>
                  <input type="number" step="0.01" min="0" class="form-control" id="fuelUsedLiters" placeholder="Auto" readonly>
                </div>
                <div class="col-md-2 mb-3">
                  <label class="form-label">Rate per Liter (₹)</label>
                  <input type="number" step="0.01" min="0" class="form-control" id="dieselRatePerLiter" placeholder="e.g., 95.50">
                </div>
                <div class="col-md-2 mb-3">
                  <label class="form-label">Amount (₹) [Auto]</label>
                  <input type="number" step="0.01" class="form-control bg-light" id="dieselExpenses" readonly>
                </div>
              </div>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-header bg-light">
              <h5 class="mb-0"><i class="fas fa-money-bill-wave me-2"></i>Other Expenses</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-3 mb-3">
                  <label class="form-label">Tyre Expenses (₹)</label>
                  <input type="number" step="0.01" class="form-control" id="tyreExpenses" value="0">
                </div>
                <div class="col-md-3 mb-3">
                  <label class="form-label">Toll Expenses (₹)</label>
                  <input type="number" step="0.01" class="form-control" id="tollExpenses" value="0">
                </div>
                <div class="col-md-3 mb-3">
                  <label class="form-label">Food Expenses (₹)</label>
                  <input type="number" step="0.01" class="form-control" id="foodExpenses" value="0">
                </div>
                <div class="col-md-3 mb-3">
                  <label class="form-label">Other Expenses (₹)</label>
                  <input type="number" step="0.01" class="form-control" id="otherExpenses" value="0" oninput="calculateAmount()">
                </div>
              </div>
            </div>
          </div>
          <!-- END REORGANIZED EXPENSE FIELDS -->

          
          <div class="card mb-4">
            <div class="card-header bg-light">
              <h5 class="mb-0"><i class="fas fa-credit-card me-2"></i>Payment Information</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label class="form-label">Payment Type</label>
                  <select class="form-select" id="paymentType" onchange="toggleBankNameField('paymentType', 'bankNameContainer')">
                    <option value="">Select Payment Type</option>
                    <option value="Cash">Cash</option>
                    <option value="Bank Transfer">Bank Transfer</option>
                  </select>
                </div>
                <div class="col-md-4 mb-3" id="bankNameContainer" style="display: none;">
                  <label class="form-label">Bank Name</label>
                  <input type="text" class="form-control" id="bankName">
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">Advance (₹)</label> 
                  <input type="number" step="0.01" class="form-control" id="advance" value="0" oninput="calculateAmount()"> 
                </div>
              </div>
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label class="form-label">Shortage (kg)</label>
                  <input type="number" step="0.01" class="form-control" id="shortage" value="0" oninput="calculateAmount()" placeholder="Shortage in tonnes">
                </div>
              </div>
              
              <div class="row mt-3">
                <div class="col-12">
                  <h6 class="border-bottom pb-2">Tax Information</h6>
                </div>
              </div>
              <div class="row">
                <div class="col-md-3 mb-3">
                  <label class="form-label">CGST %</label>
                  <input type="number" step="0.01" class="form-control" id="cgstPercentage" value="9" oninput="calculateAmount()">
                </div>
                <div class="col-md-3 mb-3">
                  <label class="form-label">CGST Amount (₹)</label>
                  <input type="number" step="0.01" class="form-control" id="cgstAmount" readonly>
                </div>
                <div class="col-md-3 mb-3">
                  <label class="form-label">SGST %</label>
                  <input type="number" step="0.01" class="form-control" id="sgstPercentage" value="9" oninput="calculateAmount()">
                </div>
                <div class="col-md-3 mb-3">
                  <label class="form-label">SGST Amount (₹)</label>
                  <input type="number" step="0.01" class="form-control" id="sgstAmount" readonly>
                </div>
              </div>
              
              <div class="row mt-3">
                <div class="col-12">
                  <h6 class="border-bottom pb-2">Total</h6>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Balance (₹)</label>
                  <input type="number" step="0.01" class="form-control" id="balance" readonly>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Total Amount (₹)</label>
                  <input type="number" step="0.01" class="form-control" id="totalAmount" readonly>
                </div>
              </div>
            </div>
          </div>
          <button type="button" class="btn btn-primary" id="saveLRBtn">Save LR</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Bank Details Modal -->
  <div class="modal fade" id="bankDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Enter Bank & Company Details</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="bankDetailsForm">
            <div class="row mb-3">
              <div class="col-md-6">
                <h6>Company Details</h6>
                <div class="mb-3">
                  <label for="inputCompanyName" class="form-label">Company Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="inputCompanyName" required>
                </div>
                <div class="mb-3">
                  <label for="inputCompanyAddress" class="form-label">Company Address</label>
                  <textarea class="form-control" id="inputCompanyAddress" rows="2"></textarea>
                </div>
                <div class="mb-3">
                  <label for="inputGstNumber" class="form-label">GST Number</label>
                  <input type="text" class="form-control" id="inputGstNumber">
                </div>
                <div class="mb-3">
                  <label for="inputCompanyPhone" class="form-label">Phone Number</label>
                  <input type="text" class="form-control" id="inputCompanyPhone">
                </div>
              </div>
              <div class="col-md-6">
                <h6>Bank Details</h6>
                <div class="mb-3">
                  <label for="inputBankName" class="form-label">Bank Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="inputBankName" required>
                </div>
                <div class="mb-3">
                  <label for="inputAccountHolder" class="form-label">Account Holder Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="inputAccountHolder" required>
                </div>
                <div class="mb-3">
                  <label for="inputAccountNumber" class="form-label">Account Number <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="inputAccountNumber" required>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="inputIfscCode" class="form-label">IFSC Code <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="inputIfscCode" required>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="inputAccountType" class="form-label">Account Type</label>
                      <select class="form-select" id="inputAccountType">
                        <option value="Current">Current</option>
                        <option value="Savings">Savings</option>
                        <option value="CC">Cash Credit</option>
                        <option value="OD">Overdraft</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="createAndSaveInvoice()">Generate Invoice</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Invoice Modal -->
  <div class="modal fade" id="invoiceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title">Invoice Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-4" id="invoiceContent">
          <style>
            @media print {
              @page {
                size: A4 landscape;
                margin: 0.5cm;
              }
              body {
                font-family: Arial, sans-serif;
                font-size: 9px;
                line-height: 1.3;
                color: #333;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
              }
              .no-print {
                display: none !important;
              }
              .table {
                page-break-inside: auto;
                border-collapse: collapse;
                width: 100% !important;
                margin: 0;
                table-layout: fixed;
                width: 100%;
                margin-bottom: 1rem;
              }
              .table th, .table td {
                padding: 3px 5px;
                border: 1px solid #dee2e6 !important;
                vertical-align: middle;
                word-wrap: break-word;
                font-size: 8px;
              }
              .table thead th {
                background-color: #f8f9fa;
                font-weight: 600;
                text-align: center;
              }
              .table tbody td {
                padding: 4px 6px;
              }
              .text-end {
                text-align: right !important;
              }
              .text-center {
                text-align: center !important;
              }
              .invoice-header {
                margin-bottom: 15px;
                padding-bottom: 10px;
                border-bottom: 2px solid #dee2e6;
              }
              .company-details {
                margin-bottom: 15px;
              }
              .invoice-details {
                margin-bottom: 15px;
              }
              .bank-details {
                margin-top: 15px;
                padding: 10px;
                border: 1px solid #dee2e6;
                border-radius: 4px;
                background-color: #f8f9fa;
              }
              .signature-area {
                margin-top: 40px;
                padding-top: 20px;
                border-top: 1px solid #dee2e6;
              }
              .signature-line {
                display: inline-block;
                width: 200px;
                border-top: 1px solid #333;
                margin-top: 30px;
                padding-top: 5px;
              }  .text-end {
                text-align: right !important;
              }
              .text-center {
                text-align: center !important;
              }
              .fw-bold {
                font-weight: bold !important;
              }
              .table-active {
                background-color: #f8f9fa !important;
              }
              .table-light {
                background-color: #f8f9fa !important;
              }
              .border-bottom {
                border-bottom: 1px solid #dee2e6 !important;
              }
              .mt-4 {
                margin-top: 1.5rem !important;
              }
              .mb-0 {
                margin-bottom: 0 !important;
              }
              .mb-1 {
                margin-bottom: 0.25rem !important;
              }
              .mb-4 {
                margin-bottom: 1.5rem !important;
              }
              .me-2 {
                margin-right: 0.5rem !important;
              }
              .p-4 {
                padding: 1.5rem !important;
              }
              .small {
                font-size: 80% !important;
              }
            }
            .invoice-header {
              border-bottom: 2px solid #dee2e6;
              margin-bottom: 20px;
              padding-bottom: 15px;
            }
            .invoice-table th {
              white-space: nowrap;
              background-color: #f8f9fa !important;
            }
          </style>
          
          <div id="printableInvoice">
            <div class="row mb-4">
              <div class="col-12 text-center">
                <h3 class="mb-1">TRANSPORT INVOICE</h3>
                <p class="mb-1" id="companyName">Loading company details...</p>
                <p class="mb-1" id="companyAddress">Loading address...</p>
                <p class="mb-0" id="companyGst">GST: Loading...</p>
              </div>
            </div>
            
            <div class="row mb-4">
              <div class="col-6">
                <p class="mb-1"><strong>Bill To:</strong></p>
                <p id="billToAddress" class="mb-0">Consolidated Invoice</p>
              </div>
              <div class="col-6 text-end">
                <p class="mb-1"><strong>Invoice #: </strong><span id="invoiceNumber">INV-${new Date().getFullYear()}${String(new Date().getMonth() + 1).padStart(2, '0')}${String(new Date().getDate()).padStart(2, '0')}-${Math.floor(1000 + Math.random() * 9000)}</span></p>
                <p class="mb-1"><strong>Date: </strong><span id="invoiceDate">${new Date().toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' })}</span></p>
              </div>
            </div>
            
            <div class="table-responsive">
              <table class="table table-bordered table-sm invoice-table">
                <thead class="table-light" style="background-color: #f8f9fa !important;">
                  <tr>
                    <th style="width: 70px;">Date</th>
                    <th style="width: 90px;">LR No</th>
                    <th style="width: 70px;">Truck No</th>
                    <th style="width: 100px;">Consignor</th>
                    <th style="width: 100px;">Consignee</th>
                    <th style="width: 80px;">From</th>
                    <th style="width: 80px;">To</th>
                    <th class="text-end" style="width: 60px;">Weight</th>
                    <th class="text-end" style="width: 60px;">Rate</th>
                    <th class="text-end" style="width: 45px;">GST %</th>
                    <th class="text-end" style="width: 70px;">GST Amt</th>
                    <th class="text-end" style="width: 80px;">Amount</th>
                  </tr>
                </thead>
                <tbody id="invoiceItems">
                  <!-- Invoice items will be populated here -->
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="7" class="border-0"></td>
                    <td class="text-end border-0"><strong>Subtotal:</strong></td>
                    <td class="text-end border-0"></td>
                    <td class="text-end border-0"></td>
                    <td class="text-end border-0" colspan="2">-</td>
                    <td class="text-end fw-bold border-0" id="subtotalAmount">₹0.00</td>
                  </tr>
                  <tr id="cgstRow">
                    <td colspan="7" class="border-0"></td>
                    <td class="text-end border-0" colspan="4"><strong>CGST:</strong></td>
                    <td class="text-end fw-bold border-0" id="invoiceCgstAmount">₹0.00</td>
                  </tr>
                  <tr id="sgstRow">
                    <td colspan="7" class="border-0"></td>
                    <td class="text-end border-0" colspan="4"><strong>SGST:</strong></td>
                    <td class="text-end fw-bold border-0" id="invoiceSgstAmount">₹0.00</td>
                  </tr>
                  <tr class="table-active">
                    <td colspan="7" class="border-0"></td>
                    <td class="text-end border-0"><strong>Grand Total:</strong></td>
                    <td class="text-end border-0" colspan="3">-</td>
                    <td class="text-end fw-bold border-0" id="grandTotal">₹0.00</td>
                  </tr>
                </tfoot>
              </table>
            </div>
            
            <div class="row mt-4">
              <div class="col-md-6">
                <p class="mb-1"><strong>Bank Details:</strong></p>
                <p class="mb-1">Bank: <span id="invoiceBankName">-</span></p>
                <p class="mb-1">Account Number: <span id="invoiceAccountNumber">-</span></p>
                <p class="mb-1">Account Holder: <span id="invoiceAccountHolder">-</span></p>
                <p class="mb-1">IFSC: <span id="invoiceIfscCode">-</span></p>
                <p class="mb-0">Account Type: <span id="invoiceAccountType">Current</span></p>
                <div class="mt-3">
                  <p class="mb-1"><strong>Amount in Words:</strong></p>
                  <p class="mb-0 small" id="amountInWords">-</p>
                </div>
              </div>
              <div class="col-md-6 text-end">
                <div class="mt-5">
                  <p class="mb-4">For <span id="companyNameFooter">[Company Name]</span></p>
                  <p class="mb-0">___________________</p>
                  <p class="mb-0">Authorized Signatory</p>
                </div>
              </div>
            </div>
            
            <div class="row mt-4 text-center">
              <div class="col-12">
                <p class="mb-0"><small>This is a computer-generated invoice. No signature required.</small></p>
              </div>
            </div>
          </div>
          
          <div class="mt-4 no-print text-center">
            <button class="btn btn-primary me-2" onclick="printInvoice()">
              <i class="fas fa-print me-2"></i>Print Invoice
            </button>
            
            <button class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times me-2"></i>Close
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="printInvoice()">
            <i class="fas fa-print me-2"></i>Print Invoice
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- LR Copy Modal -->
  <div class="modal fade" id="lrCopyModal" tabindex="-1" aria-labelledby="lrCopyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header text-white" style="background-color: #2E8B57;">
          <h5 class="modal-title" id="lrCopyModalLabel">Lorry Receipt</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0" id="lrCopyContent" style="background-color: #ffffff;">
          <!-- LR Copy content will be populated here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="downloadLRCopyPDF()"><i class="fas fa-file-pdf me-2"></i>Download PDF</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="editLRModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit LR Record</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editLrForm">
            <!-- Basic LR Information -->
            <div class="card mb-4">
              <div class="card-header bg-light"><h5 class="mb-0"><i class="fas fa-file-invoice me-2"></i>Basic LR Information</h5></div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Date <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" id="editLrDate" required>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">LR Number <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="editLrNumber" readonly>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3 vehicle-input-container">
                    <label class="form-label">Truck Number <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="editTruckNumber" required placeholder="Start typing vehicle number..." oninput="searchEditVehicles(this.value)">
                    <div id="editVehicleSuggestions" class="vehicle-suggestions" style="display: none;"></div>
                    <div id="editVehicleNotFound" class="vehicle-not-found"><i class="fas fa-exclamation-triangle"></i> This vehicle is not registered.</div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="editClientId" class="form-label">Client / Consignor <span class="text-danger">*</span></label>
                    <select id="editClientId" class="form-select" required><option value="">Select a Client</option></select>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-12 mb-3">
                    <label class="form-label">Route (From --> To) <span class="text-danger">*</span></label>
                    <select id="editRouteSelect" class="form-select" required><option value="">Select a Route</option></select>
                  </div>
                </div>
              </div>
            </div>
            <!-- Shipment Details -->
            <div class="card mb-4">
              <div class="card-header bg-light"><h5 class="mb-0"><i class="fas fa-box me-2"></i>Shipment Details</h5></div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3"><label class="form-label">Consignee</label><input type="text" class="form-control" id="editConsignee"></div>
                  <div class="col-md-6 mb-3"><label class="form-label">Item</label><input type="text" class="form-control" id="editItem"></div>
                </div>
                <div class="row">
                  <div class="col-md-4 mb-3"><label class="form-label">Shipment No.</label><input type="text" class="form-control" id="editShipmentNo"></div>
                  <div class="col-md-4 mb-3"><label class="form-label">Number of Packages</label><input type="number" class="form-control" id="editNumPackages" oninput="calculateEditWeightFromPackages()"></div>
                  <div class="col-md-4 mb-3"><label class="form-label">Weight per Package (kg)</label><input type="number" step="0.01" class="form-control" id="editWeightPerPackage" oninput="calculateEditWeightFromPackages()"></div>
                </div>
                <div class="row">
                  <div class="col-md-4 mb-3"><label class="form-label">Weight (tonne) <span class="text-danger">*</span></label><input type="number" class="form-control" id="editWeight" step="0.01" required oninput="handleEditManualWeightInput()"></div>
                </div>
              </div>
            </div>
            <!-- Billing Information -->
            <div class="card mb-4">
              <div class="card-header bg-light"><h5 class="mb-0"><i class="fas fa-money-bill-alt me-2"></i>Billing Information</h5></div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3"><label class="form-label">Billing Rate (₹/tonne)</label><input type="number" step="0.01" class="form-control" id="editBillingRate" oninput="calculateEditBillingAmount()"></div>
                  <div class="col-md-6 mb-3"><label class="form-label">Billing Amount (₹)</label><input type="number" step="0.01" class="form-control" id="editBillingAmount" oninput="calculateEditBillingRate()"></div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3"><label class="form-label">Freight Rate (₹/tonne)</label><input type="number" step="0.01" class="form-control" id="editFreightRate" oninput="calculateEditFreightAmount()"></div>
                  <div class="col-md-6 mb-3"><label class="form-label">Freight Amount (₹)</label><input type="number" step="0.01" class="form-control" id="editFreightAmount" oninput="calculateEditFreightRate()"></div>
                </div>
              </div>
            </div>
            <!-- Fuel Information -->
            <div class="card mb-4">
              <div class="card-header bg-light"><h5 class="mb-0"><i class="fas fa-gas-pump me-2"></i>Fuel Information</h5></div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-3 mb-3"><label class="form-label">Vehicle Average (km/l)</label><input type="number" step="0.01" min="0" class="form-control" id="editVehicleAverage" placeholder="e.g., 3.5"></div>
                  <div class="col-md-3 mb-3"><label class="form-label">Route Distance (KM)</label><input type="number" step="0.01" min="0" class="form-control" id="editRouteDistanceKm" placeholder="Auto from route" readonly></div>
                  <div class="col-md-2 mb-3"><label class="form-label">Fuel Used (L) [Auto]</label><input type="number" step="0.01" min="0" class="form-control" id="editFuelUsedLiters" placeholder="Auto" readonly></div>
                  <div class="col-md-2 mb-3"><label class="form-label">Rate per Liter (₹)</label><input type="number" step="0.01" min="0" class="form-control" id="editDieselRatePerLiter" placeholder="e.g., 95.50"></div>
                  <div class="col-md-2 mb-3"><label class="form-label">Amount (₹) [Auto]</label><input type="number" step="0.01" class="form-control bg-light" id="editDieselExpenses" readonly></div>
                </div>
              </div>
            </div>
            <!-- Other Expenses -->
            <div class="card mb-4">
              <div class="card-header bg-light"><h5 class="mb-0"><i class="fas fa-money-bill-wave me-2"></i>Other Expenses</h5></div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-3 mb-3"><label class="form-label">Tyre Expenses (₹)</label><input type="number" step="0.01" class="form-control" id="editTyreExpenses" value="0"></div>
                  <div class="col-md-3 mb-3"><label class="form-label">Toll Expenses (₹)</label><input type="number" step="0.01" class="form-control" id="editTollExpenses" value="0"></div>
                  <div class="col-md-3 mb-3"><label class="form-label">Vehicle Work (₹)</label><input type="number" step="0.01" class="form-control" id="editVehicleWork" value="0"></div>
                  <div class="col-md-3 mb-3"><label class="form-label">Food Expenses (₹)</label><input type="number" step="0.01" class="form-control" id="editFoodExpenses" value="0"></div>
                  <div class="col-md-3 mb-3"><label class="form-label">Other Expenses (₹)</label><input type="number" step="0.01" class="form-control" id="editOtherExpenses" value="0" oninput="calculateEditAmount()"></div>
                </div>
              </div>
            </div>
            <!-- Payment Information -->
            <div class="card mb-4">
              <div class="card-header bg-light"><h5 class="mb-0"><i class="fas fa-credit-card me-2"></i>Payment Information</h5></div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Payment Type</label>
                    <select class="form-select" id="editPaymentType" onchange="toggleBankNameField('editPaymentType', 'editBankNameContainer')">
                      <option value="">Select Payment Type</option><option value="Cash">Cash</option><option value="Bank Transfer">Bank Transfer</option>
                    </select>
                  </div>
                  <div class="col-md-4 mb-3" id="editBankNameContainer" style="display: none;"><label class="form-label">Bank Name</label><input type="text" class="form-control" id="editBankName"></div>
                  <div class="col-md-4 mb-3"><label class="form-label">Advance (₹)</label><input type="number" step="0.01" class="form-control" id="editAdvance" value="0" oninput="calculateEditAmount()"></div>
                </div>
                <div class="row"><div class="col-md-4 mb-3"><label class="form-label">Shortage (kg)</label><input type="number" step="0.01" class="form-control" id="editShortage" value="0" oninput="calculateEditAmount()" placeholder="Shortage in kg"></div></div>
                <div class="row mt-3"><div class="col-12"><h6 class="border-bottom pb-2">Tax Information</h6></div></div>
                <div class="row">
                  <div class="col-md-3 mb-3"><label class="form-label">CGST %</label><input type="number" step="0.01" class="form-control" id="editCgstPercentage" value="9" oninput="calculateEditAmount()"></div>
                  <div class="col-md-3 mb-3"><label class="form-label">CGST Amount (₹)</label><input type="number" step="0.01" class="form-control" id="editCgstAmount" readonly></div>
                  <div class="col-md-3 mb-3"><label class="form-label">SGST %</label><input type="number" step="0.01" class="form-control" id="editSgstPercentage" value="9" oninput="calculateEditAmount()"></div>
                  <div class="col-md-3 mb-3"><label class="form-label">SGST Amount (₹)</label><input type="number" step="0.01" class="form-control" id="editSgstAmount" readonly></div>
                </div>
                <div class="row mt-3"><div class="col-12"><h6 class="border-bottom pb-2">Total</h6></div></div>
                <div class="row">
                  <div class="col-md-6 mb-3"><label class="form-label">Balance (₹)</label><input type="number" step="0.01" class="form-control" id="editBalance" readonly></div>
                  <div class="col-md-6 mb-3"><label class="form-label">Total Amount (₹)</label><input type="number" step="0.01" class="form-control" id="editTotalAmount" readonly></div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="updateLRBtn">Update LR</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SCRIPT LOADING ORDER FIX: Move all scripts to the end of the body -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  
  <script src="navbar-loader.js"></script>
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDAlk_K8p8Of8Ne6Jpcl2QqXTtm95NgG7o",
      authDomain: "transport-dashboard-ad69a.firebaseapp.com",
      databaseURL: "https://transport-dashboard-ad69a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "transport-dashboard-ad69a",
      storageBucket: "transport-dashboard-ad69a.appspot.com",
      messagingSenderId: "526889676196",
      appId: "1:526889676196:web:66032c80a4aede690ae531",
      measurementId: "G-7F9R7HJYDH"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();
    const auth = firebase.auth();

    // Global Constants
    const SHORTAGE_DEDUCTION_RATE = 100; // Example: Deduct ₹100 per tonne of shortage

    let allVehicles = [];
    let allClients = [];
    let allPetrolPumps = [];
    let dieselPumpOptions = ''; // To store pump options HTML
    let selectedLRs = [];
    let currentEditingLRId = null;
    let currentCoreAccountId = null;
    let lrTable; // Define lrTable globally
    // For edit fuel delta handling
    let prevFuelUsedLiters = 0;
    let prevTruckNumber = '';

    // Load all vehicles from Firebase - COMPLETELY FIXED VERSION
    async function loadAllVehicles(userId) {
      try {
        console.log("🔍 Starting vehicle load for user:", userId);
        
        // Method 1: Try to get coreAccountId from user profile first
        const userProfileRef = db.ref(`users/${userId}`);
        const userSnapshot = await userProfileRef.once('value');
        const userData = userSnapshot.val();
        
        if (userData) {
          // Check if this is a branch account
          if (userData.coreAccountId) {
            currentCoreAccountId = userData.coreAccountId;
            console.log("✅ Branch account detected. Core account ID:", currentCoreAccountId);
          } else if (userData.accountType === 'branch' && userData.coreAccountId) {
            currentCoreAccountId = userData.coreAccountId;
            console.log("✅ Branch account detected via accountType. Core account ID:", currentCoreAccountId);
          } else {
            // This is a core account - use their own ID
            currentCoreAccountId = userId;
            console.log("✅ Core account detected. Using user ID:", currentCoreAccountId);
          }
        } else {
          // Fallback: use user's own ID
          currentCoreAccountId = userId;
          console.log("⚠️ No user data found, using user ID as core account:", currentCoreAccountId);
        }

        console.log("🚗 Loading vehicles from path: users/" + currentCoreAccountId + "/vehicles");
        
        const vehiclesRef = db.ref(`users/${currentCoreAccountId}/vehicles`);
        vehiclesRef.on('value', (snapshot) => {
          allVehicles = [];
          if (snapshot.exists()) {
            snapshot.forEach((childSnapshot) => {
              const vehicle = childSnapshot.val();
              allVehicles.push({
                id: childSnapshot.key,
                vehicleNo: vehicle.vehicleNumber || '', // Correct field name from add.html
                driverName: vehicle.driverName || '',
                vehicleType: vehicle.vehicleType || '', // Add vehicle type
                contactNumber: vehicle.contactNumber || '' // Add driver contact number
              });
            });
            console.log("✅ Successfully loaded vehicles:", allVehicles);
          } else {
            console.log("❌ No vehicles found at path: users/" + currentCoreAccountId + "/vehicles");
          }
          updateTruckFilterDropdown();
        }, (error) => {
          console.error("❌ Error loading vehicles:", error);
        });
        
      } catch (error) {
        console.error("❌ Failed to load vehicle master list:", error);
      }
    }

    // Update truck filter dropdown with available vehicles
    function updateTruckFilterDropdown() {
      const truckFilter = document.getElementById('truckFilter');
      if (!truckFilter) return;
      
      // Store current selection
      const currentValue = truckFilter.value;
      
      // Clear and rebuild dropdown
      truckFilter.innerHTML = '<option value="">All Trucks</option>';
      
      // Create a unique set of vehicle numbers
      const uniqueVehicles = [...new Set(allVehicles.map(v => v.vehicleNo))].filter(v => v);
      
      console.log("🔄 Updating truck filter with vehicles:", uniqueVehicles);
      
      uniqueVehicles.sort().forEach(vehicleNo => {
        const option = document.createElement('option');
        option.value = vehicleNo;
        option.textContent = vehicleNo;
        truckFilter.appendChild(option);
      });
      
      // Restore selection if it still exists
      if (currentValue && uniqueVehicles.includes(currentValue)) {
        truckFilter.value = currentValue;
      }
      
      // Also update the truck number input placeholder with count
      const truckInput = document.getElementById('truckNumber');
      if (truckInput && allVehicles.length > 0) {
        truckInput.placeholder = `Start typing vehicle number... (${allVehicles.length} vehicles available)`;
      }
    }

    // Load all clients from Firebase
    async function loadAllClients() {
      const user = auth.currentUser;
      if (!user) return;

      // **FIX**: Fetch from the user-specific path
      const coreAccountId = await getCoreAccountId(user.uid);
      const clientsRef = db.ref(`users/${coreAccountId}/clients`);

      clientsRef.on('value', (snapshot) => {
        allClients = [];
        const clientSelect = document.getElementById('clientId');
        const editClientSelect = document.getElementById('editClientId');
        
        clientSelect.innerHTML = '<option value="">Select a Client</option>';
        editClientSelect.innerHTML = '<option value="">Select a Client</option>';
        
        if (snapshot.exists()) {
          snapshot.forEach((childSnapshot) => {
            const client = childSnapshot.val();
            const clientData = { id: childSnapshot.key, ...client };
            allClients.push(clientData);
            
            // Add to client select dropdowns
            const option = document.createElement('option');
            option.value = clientData.id; // The key of the client object
            option.textContent = clientData.clientName; // The name of the client
            clientSelect.appendChild(option);
            
            const editOption = document.createElement('option');
            editOption.value = clientData.id; // The key of the client object
            editOption.textContent = clientData.clientName; // The name of the client
            editClientSelect.appendChild(editOption);
          });
          console.log("✅ Loaded clients:", allClients.length);
          // **FIX**: Now that clients are loaded, we can safely load the LR data.
          loadLRData();

        } else {
          console.log("❌ No clients found");
        }
      });
    }

    // Load all routes from Firebase and populate the route dropdown (From --> To)
    function loadAllRoutes() {
      // Requires currentCoreAccountId to be set by loadAllVehicles
      if (!currentCoreAccountId) {
        console.warn('Routes cannot be loaded yet. coreAccountId not ready. Retrying...');
        setTimeout(loadAllRoutes, 400);
        return;
      }

      const routeSelect = document.getElementById('routeSelect');
      const editRouteSelect = document.getElementById('editRouteSelect');
      if (!routeSelect && !editRouteSelect) return;

      const routesRef = db.ref(`users/${currentCoreAccountId}/routes`);
      routesRef.on('value', (snapshot) => {
        // Rebuild dropdowns
        if (routeSelect) {
          routeSelect.innerHTML = '<option value="">Select a Route</option>';
        }
        if (editRouteSelect) {
          editRouteSelect.innerHTML = '<option value="">Select a Route</option>';
        }
        if (snapshot.exists()) {
          snapshot.forEach((child) => {
            const r = child.val() || {};
            const opt = document.createElement('option');
            opt.value = child.key;
            opt.textContent = `${r.from || '-'} --> ${r.to || '-'}`;
            opt.dataset.from = r.from || '';
            opt.dataset.to = r.to || '';
            if (r.distance !== undefined) {
              opt.dataset.distance = r.distance;
            }
            if (routeSelect) routeSelect.appendChild(opt.cloneNode(true));
            if (editRouteSelect) editRouteSelect.appendChild(opt);
          });
          // After routes load, try to set distance fields if already selected
          setTimeout(() => {
            updateAddRouteDistanceField();
            updateEditRouteDistanceField();
          }, 0);
        }
      });
    }

    // Load all routes from Firebase and populate the route dropdown (From --> To)
    function loadAllRoutes() {
  // Requires currentCoreAccountId to be set by loadAllVehicles
  if (!currentCoreAccountId) {
    console.warn('Routes cannot be loaded yet. coreAccountId not ready. Retrying...');
    setTimeout(loadAllRoutes, 400);
    return;
  }

  const routeSelect = document.getElementById('routeSelect');
  const editRouteSelect = document.getElementById('editRouteSelect');
  if (!routeSelect && !editRouteSelect) return;

  const routesRef = db.ref(`users/${currentCoreAccountId}/routes`);
  routesRef.on('value', (snapshot) => {
    // Rebuild dropdowns
    if (routeSelect) {
      routeSelect.innerHTML = '<option value="">Select a Route</option>';
    }
    if (editRouteSelect) {
      editRouteSelect.innerHTML = '<option value="">Select a Route</option>';
    }
    if (snapshot.exists()) {
      snapshot.forEach((child) => {
        const r = child.val() || {};
        const opt = document.createElement('option');
        opt.value = child.key;
        opt.textContent = `${r.from || '-'} --> ${r.to || '-'}`;
        opt.dataset.from = r.from || '';
        opt.dataset.to = r.to || '';
        if (r.distance !== undefined) {
          opt.dataset.distance = r.distance;
        }
        if (routeSelect) routeSelect.appendChild(opt.cloneNode(true));
        if (editRouteSelect) editRouteSelect.appendChild(opt);
      });
      // After routes load, try to set distance fields if already selected
      setTimeout(() => {
        updateAddRouteDistanceField();
        updateEditRouteDistanceField();
      }, 0);
    }
  });
}

    // **NEW**: Load work vendors for the dropdown
    function loadWorkVendors() {
        if (!currentCoreAccountId) return;
        const vendorsRef = db.ref(`users/${currentCoreAccountId}/workVendors`);
        const select = document.getElementById('vehicleWorkVendor');
        if (!select) return;

        vendorsRef.on('value', (snapshot) => {
            select.innerHTML = '<option value="">Select Vendor</option>';
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    const vendor = child.val();
                    const option = document.createElement('option');
                    option.value = child.key;
                    option.textContent = vendor.name;
                    select.appendChild(option);
                });
            }
        });
    }

// Load all petrol pumps from Firebase
async function loadAllPetrolPumps() {
  const user = auth.currentUser;
  if (!user) return;
  const pumpsRef = db.ref(`users/${user.uid}/petrolPumps`);
 
  pumpsRef.on('value', (snapshot) => {
    allPetrolPumps = [];
    dieselPumpOptions = '<option value="">Select a Pump</option>';
    if (snapshot.exists()) {
      snapshot.forEach((childSnapshot) => {
        const pump = childSnapshot.val();
        const pumpData = { id: childSnapshot.key, ...pump };
        allPetrolPumps.push(pumpData);
        const optionHtml = `<option value="${pumpData.name}">${pumpData.name} - ${pumpData.place || 'N/A'}</option>`;
        dieselPumpOptions += optionHtml;
      });
      console.log("✅ Loaded petrol pumps and generated options:", allPetrolPumps.length);
    } else {
      const noPumpsOption = '<option value="" disabled>No pumps registered</option>';
      dieselPumpOptions += noPumpsOption;
    }
    // Diesel entries UI removed; no auto-add needed
  });
}

    // **NEW**: Helper function to get the core account ID for any user
    async function getCoreAccountId(userId) {
        if (!userId) return null;
        const userProfileRef = db.ref(`users/${userId}/profile`);
        const userProfileSnap = await userProfileRef.once('value');
        if (userProfileSnap.exists()) {
            const profileData = userProfileSnap.val();
            return profileData.coreAccountId || userId;
        }
        return userId; // Fallback to the user's own ID
    }

    // Vehicle search and validation functions
    function searchVehicles(query) {
      const suggestionsContainer = document.getElementById('vehicleSuggestions');
      const notFoundMessage = document.getElementById('vehicleNotFound');
      const truckNumberInput = document.getElementById('truckNumber');
      
      if (query.length < 1) {
        suggestionsContainer.style.display = 'none';
        notFoundMessage.style.display = 'none';
        truckNumberInput.classList.remove('vehicle-valid', 'vehicle-invalid');
        return;
      }
      
      const filteredVehicles = allVehicles.filter(vehicle => 
        vehicle.vehicleNo.toLowerCase().includes(query.toLowerCase())
      );
      
      if (filteredVehicles.length > 0) {
        suggestionsContainer.innerHTML = '';
        filteredVehicles.forEach(vehicle => {
          const suggestion = document.createElement('div');
          suggestion.className = 'vehicle-suggestion';
          suggestion.textContent = vehicle.vehicleNo;
          suggestion.onclick = () => {
            truckNumberInput.value = vehicle.vehicleNo;
            suggestionsContainer.style.display = 'none';
            notFoundMessage.style.display = 'none';
            truckNumberInput.classList.add('vehicle-valid');
            truckNumberInput.classList.remove('vehicle-invalid');
          };
          suggestionsContainer.appendChild(suggestion);
        });
        suggestionsContainer.style.display = 'block';
        notFoundMessage.style.display = 'none';
        truckNumberInput.classList.remove('vehicle-valid', 'vehicle-invalid');
      } else {
        suggestionsContainer.style.display = 'none';
        notFoundMessage.style.display = 'block';
        truckNumberInput.classList.add('vehicle-invalid');
        truckNumberInput.classList.remove('vehicle-valid');
      }
    }

    function searchEditVehicles(query) {
      const suggestionsContainer = document.getElementById('editVehicleSuggestions');
      const notFoundMessage = document.getElementById('editVehicleNotFound');
      const truckNumberInput = document.getElementById('editTruckNumber');
      
      if (query.length < 1) {
        suggestionsContainer.style.display = 'none';
        notFoundMessage.style.display = 'none';
        truckNumberInput.classList.remove('vehicle-valid', 'vehicle-invalid');
        return;
      }
      
      const filteredVehicles = allVehicles.filter(vehicle => 
        vehicle.vehicleNo.toLowerCase().includes(query.toLowerCase())
      );
      
      if (filteredVehicles.length > 0) {
        suggestionsContainer.innerHTML = '';
        filteredVehicles.forEach(vehicle => {
          const suggestion = document.createElement('div');
          suggestion.className = 'vehicle-suggestion';
          suggestion.textContent = vehicle.vehicleNo;
          suggestion.onclick = () => {
            truckNumberInput.value = vehicle.vehicleNo;
            suggestionsContainer.style.display = 'none';
            notFoundMessage.style.display = 'none';
            truckNumberInput.classList.add('vehicle-valid');
            truckNumberInput.classList.remove('vehicle-invalid');
          };
          suggestionsContainer.appendChild(suggestion);
        });
        suggestionsContainer.style.display = 'block';
        notFoundMessage.style.display = 'none';
        truckNumberInput.classList.remove('vehicle-valid', 'vehicle-invalid');
      } else {
        suggestionsContainer.style.display = 'none';
        notFoundMessage.style.display = 'block';
        truckNumberInput.classList.add('vehicle-invalid');
        truckNumberInput.classList.remove('vehicle-valid');
      }
    }

    // Close suggestions when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.matches('#truckNumber')) {
        document.getElementById('vehicleSuggestions').style.display = 'none';
      }
      if (!e.target.matches('#editTruckNumber')) {
        document.getElementById('editVehicleSuggestions').style.display = 'none';
      }
    });

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize DataTable
      lrTable = $('#lrTable').DataTable({
        pageLength: 10,
        order: [[1, 'desc']] // Sort by date descending
      });
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          console.log("👤 User authenticated:", user.uid);
          
          // Load vehicles first (this is critical for the form to work)
          await loadAllVehicles(user.uid);
          
          // Then load other data
          loadAllRoutes();
          loadAllClients(); // Changed to not await, as it uses onValue
          loadWorkVendors(); // **NEW**: Load vendors for the form
          loadAllPetrolPumps(); // Changed to not await, as it uses onValue
          generateLRNumber(); // This can run independently
          
          // Set default date to today
          const today = new Date().toISOString().split('T')[0];
          document.getElementById('lrDate').value = today;

          // **FIX**: Check for a `view` parameter in the URL to auto-open an LR for editing.
          const urlParams = new URLSearchParams(window.location.search);
          const lrToView = urlParams.get('view');
          if (lrToView) {
            // Use a timeout to ensure the data is loaded before trying to edit
            setTimeout(() => editLR(lrToView), 500);
          }
        } else {
          console.log("❌ User not authenticated");
        }
      });

      // Event listeners
      document.getElementById('saveLRBtn').addEventListener('click', saveLR);
      document.getElementById('updateLRBtn').addEventListener('click', updateLR);
      document.getElementById('applyFiltersBtn').addEventListener('click', loadLRData);

      // Fuel usage auto-calc events (Add)
      const routeSel = document.getElementById('routeSelect');
      if (routeSel) routeSel.addEventListener('change', () => { updateAddRouteDistanceField(); recalcAddFuelUsed(); });
      const avgInput = document.getElementById('vehicleAverage');
      if (avgInput) avgInput.addEventListener('input', recalcAddFuelUsed);

      // **NEW**: Add event listener for diesel rate input
      const dieselRateInput = document.getElementById('dieselRatePerLiter');
      if (dieselRateInput) dieselRateInput.addEventListener('input', recalcAddFuelUsed);

      // Fuel tracking event bindings
      const editTruckInput = document.getElementById('editTruckNumber');
      if (editTruckInput) {
        editTruckInput.addEventListener('change', handleEditTruckChangeFuel);
        editTruckInput.addEventListener('blur', handleEditTruckChangeFuel);
      }
      const editRouteSel = document.getElementById('editRouteSelect');
      if (editRouteSel) { editRouteSel.addEventListener('change', () => { updateEditRouteDistanceField(); recalcEditFuelUsed(); }); }
      const editAvg = document.getElementById('editVehicleAverage');
      if (editAvg) editAvg.addEventListener('input', recalcEditFuelUsed);

      // **NEW**: Add event listener for diesel rate input in the edit modal
      const editDieselRateInput = document.getElementById('editDieselRatePerLiter');
      if (editDieselRateInput) editDieselRateInput.addEventListener('input', recalcEditFuelUsed);

    });

    // Generate LR Number
    function generateLRNumber() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const random = Math.floor(1000 + Math.random() * 9000);
      const lrNumber = `LR${year}${month}${day}${random}`;
      document.getElementById('lrNumber').value = lrNumber;
    }

    // Show LR Copy - REFINED PROFESSIONAL LAYOUT
    async function showLRCopy(lrId) {
      const user = auth.currentUser;
      if (!user) return;

      const lrRef = db.ref(`users/${currentCoreAccountId}/lrReports/${lrId}`);
      // Use current user's profile instead of core account profile
      const profileRef = db.ref(`users/${user.uid}/profile`);

      try {
        const [lrSnapshot, profileSnapshot] = await Promise.all([
          lrRef.once('value'),
          profileRef.once('value')
        ]);

        if (!lrSnapshot.exists()) { alert('LR data not found.'); return; }
        
        const lr = lrSnapshot.val();
        const profile = profileSnapshot.exists() ? profileSnapshot.val() : {};
        const ownerName = profile.ownerName || 'N/A'; // **FIX**: Define ownerName here

        // Construct company details
        const companyName = profile.transportName || 'Transvortex Logistics';
        const companyAddress = `${profile.address || ''}, ${profile.city || ''} - ${profile.pincode || ''}`;
        const companyPhone = profile.phoneNumber || 'N/A';
        const companyGstin = profile.gstin || 'N/A';

        // Fetch driver name from the vehicle master list
        const vehicle = allVehicles.find(v => v.vehicleNo === lr.truckNumber);
        if (!vehicle) {
          console.warn(`Vehicle ${lr.truckNumber} not found in master list.`);
        }
        const driverName = vehicle ? vehicle.driverName : 'N/A';
        const client = allClients.find(c => c.id === lr.clientId) || {};

        const lrCopyContent = `
          <div class="lr-copy-container" id="lr-pdf-content">
            <div class="lr-header">
              <h4>${companyName}</h4>
              <p>Authorized transport contractor of ${client.clientName || 'To be billed'}</p>
              <p>Address: ${profile.address || 'N/A'}, City: ${profile.city || 'N/A'}, Pincode: ${profile.pincode || 'N/A'}</p>
              <p>GSTIN: ${companyGstin} | Phone: ${companyPhone}</p>
            </div>
            
            <div class="lr-info">
              <div class="lr-info-left">
                <div class="lr-row">From: <strong>${lr.fromLocation || 'N/A'}</strong></div>
                <div class="lr-row">Consignor: <strong>${client.clientName || 'To be billed'}</strong></div>
                <div class="lr-row">Consignee: <strong>${lr.consignee || client.clientName || 'N/A'}</strong></div>
                <div class="lr-row">GSTIN: <strong>${client.gstin || 'N/A'}</strong></div>
              </div>
              <div class="lr-info-right">
                <div class="lr-row">LR No: <strong>${lr.lrNumber || 'N/A'}</strong></div>
                <div class="lr-row">Date: <strong>${lr.date || 'N/A'}</strong></div>
                <div class="lr-row">Vehicle No: <strong>${lr.truckNumber || 'N/A'}</strong></div>
                <div class="lr-row">Truck Type: <strong>${vehicle ? vehicle.vehicleType || 'N/A' : 'N/A'}</strong></div>
                <div class="lr-row">Party Name: <strong>${client.clientName || 'To be billed'}</strong></div>
              </div>
            </div>
            
            <table class="lr-table">
              <thead>
                <tr>
                  <th>${(lr.numPackages && lr.numPackages > 0) ? 'No of Bags' : 'Type'}</th>
                  <th>Goods Description</th>
                  <th>Weight in MT</th>
                  <th>Rate</th>
                  <th>Freight</th>
                  <th>Value of Goods Rs.</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>${(lr.numPackages && lr.numPackages > 0) ? lr.numPackages : 'Loose'}</td>
                  <td>${lr.item || 'N/A'}</td>
                  <td>${lr.weight || 'N/A'}</td>
                  <td>${(lr.rate && lr.rate > 0) ? `₹${lr.rate}` : 'To be billed'}</td>
                  <td>${(lr.freightAmount && lr.freightAmount > 0) ? `₹${lr.freightAmount.toFixed(2)}` : 'To be billed'}</td>
                  <td>₹${(lr.goodsValue || 0).toFixed(2)}</td>
                </tr>
              </tbody>
            </table>
            
            <div class="lr-row">Remarks: <strong>GIT TO BE PAID BY CONSIGNOR / GOODS TRANSPORTED BY ${client.clientName || 'N/A'}.</strong></div>
            <div class="lr-row">Driver Name: <strong>${driverName || 'N/A'}</strong></div>
            <div class="lr-row">Truck Owner: <strong>${ownerName || 'N/A'}</strong></div>
            <div class="lr-row">Driver Mobile Number: <strong>${vehicle ? vehicle.contactNumber || 'N/A' : 'N/A'}</strong></div>
            <div class="lr-row">Truck Type: <strong>${vehicle ? vehicle.vehicleType || 'N/A' : 'N/A'}</strong></div>
            
            <div class="safety-section">
              <h5>Safety PPE(Personal Protective Equipment) Details</h5>
              <div class="lr-row">Helmet No: <strong>N/A</strong> | Jacket No: <strong>N/A</strong> | Shoes: No: <strong>N/A</strong> | Vehicle Approved By Logistic: <strong>No</strong></div>
            </div>
            
            <div class="receipt-section">
              <h5>Receipt of Goods</h5>
              <div class="lr-row">Invoice No: <strong>${lr.invoiceNumber || 'N/A'}</strong> | Truck No: <strong>${lr.truckNumber || 'N/A'}</strong> | LR No: <strong>${lr.lrNumber || 'N/A'}</strong></div>
              <div class="lr-row">Truck received at site at time: <strong>__________</strong> | Date and time of receipt: <strong>__________</strong></div>
              <div class="lr-row">Number of bags received: <strong>__________</strong> | Number of bags received short: <strong>__________</strong></div>
              <div class="lr-row">Condition of cement received: <strong>__________</strong> | Quantity of cement found wet or in book and at: <strong>__________</strong></div>
              <div class="lr-row">of damaged bag for which recovery to be made from transporter: <strong>__________</strong></div>
            </div>
            
            <div class="lr-footer">
              <div class="signature-box">
                <div class="signature-line">Signature and seal of Consignor</div>
              </div>
              <div class="signature-box">
                <div class="stamp">${companyName}</div>
              </div>
            </div>
          </div>
        `;

        document.getElementById('lrCopyContent').innerHTML = lrCopyContent;
        // Update modal title with company name
        document.getElementById('lrCopyModalLabel').textContent = `${companyName} - Lorry Receipt`;
        const lrCopyModal = new bootstrap.Modal(document.getElementById('lrCopyModal'));
        lrCopyModal.show();
      } catch (error) {
        console.error('Error generating LR copy:', error);
        alert('Error loading LR details. Please try again.');
      }
    }

    // **NEW**: Download LR Copy as PDF
    async function downloadLRCopyPDF() {
      const { jsPDF } = window.jspdf;
      const content = document.getElementById('lr-pdf-content');
      if (!content) {
        alert('Could not find LR content to download.');
        return;
      }

      try {
        const canvas = await html2canvas(content, {
          scale: 2, // Increase scale for better quality
          useCORS: true
        });
        
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4'
        });

        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const imgProps = pdf.getImageProperties(imgData);
        const imgWidth = pdfWidth - 20; // with 10mm margin on each side
        const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

        pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
        
        // Find LR number from the new format
        const lrNumberElement = content.querySelector('.lr-info-right .lr-row:nth-child(1) strong');
        const lrNumber = lrNumberElement ? lrNumberElement.textContent.trim() : 'LR_Copy';
        pdf.save(`${lrNumber}.pdf`);

      } catch (error) {
        console.error('Error generating PDF:', error);
        alert('Failed to generate PDF. Please try again.');
      }
    }

    // Calculate functions for the main form
    function calculateWeightFromPackages() {
      const numPackages = parseFloat(document.getElementById('numPackages').value) || 0;
      const weightPerPackage = parseFloat(document.getElementById('weightPerPackage').value) || 0;
      
      if (numPackages > 0 && weightPerPackage > 0) {
        const totalWeightKg = numPackages * weightPerPackage;
        const totalWeightTonne = totalWeightKg / 1000;
        document.getElementById('weight').value = totalWeightTonne.toFixed(3);
        calculateBillingAmount();
        calculateFreightAmount();
      }
    }

    function handleManualWeightInput() {
      // Clear package fields when manually entering weight
      document.getElementById('numPackages').value = '';
      document.getElementById('weightPerPackage').value = '';
      calculateBillingAmount();
      calculateFreightAmount();
    }

    function calculateBillingAmount() {
      const weight = parseFloat(document.getElementById('weight').value) || 0;
      const billingRate = parseFloat(document.getElementById('billingRate').value) || 0;
      const billingAmount = weight * billingRate;
      document.getElementById('billingAmount').value = billingAmount.toFixed(2);
      calculateAmount();
    }

    function calculateBillingRate() {
      const weight = parseFloat(document.getElementById('weight').value) || 0;
      const billingAmount = parseFloat(document.getElementById('billingAmount').value) || 0;
      if (weight > 0) {
        const billingRate = billingAmount / weight;
        document.getElementById('billingRate').value = billingRate.toFixed(2);
      }
      calculateAmount();
    }

    function calculateFreightAmount() {
      const weight = parseFloat(document.getElementById('weight').value) || 0;
      const freightRate = parseFloat(document.getElementById('freightRate').value) || 0;
      const freightAmount = weight * freightRate;
      document.getElementById('freightAmount').value = freightAmount.toFixed(2);
      calculateAmount();
    }

    function calculateFreightRate() {
      const weight = parseFloat(document.getElementById('weight').value) || 0;
      const freightAmount = parseFloat(document.getElementById('freightAmount').value) || 0;
      if (weight > 0) {
        const freightRate = freightAmount / weight;
        document.getElementById('freightRate').value = freightRate.toFixed(2);
      }
      calculateAmount();
    }

    function calculateAmount() {
      const billingAmount = parseFloat(document.getElementById('billingAmount').value) || 0;
      const advance = parseFloat(document.getElementById('advance').value) || 0;
      const shortage = parseFloat(document.getElementById('shortage').value) || 0;
      const cgstPercentage = parseFloat(document.getElementById('cgstPercentage').value) || 0;
      const sgstPercentage = parseFloat(document.getElementById('sgstPercentage').value) || 0;
      
      // Calculate GST amounts
      const cgstAmount = (billingAmount * cgstPercentage) / 100;
      const sgstAmount = (billingAmount * sgstPercentage) / 100;
      
      document.getElementById('cgstAmount').value = cgstAmount.toFixed(2);
      document.getElementById('sgstAmount').value = sgstAmount.toFixed(2);
      
      // Calculate total amount (billing + GST)
      const totalAmount = billingAmount + cgstAmount + sgstAmount;
      document.getElementById('totalAmount').value = totalAmount.toFixed(2);
      
      // Calculate balance (total - advance - shortage deduction)
      // **FIX**: Use the dynamic billingRate for shortage calculation, not a fixed rate.
      const currentBillingRate = parseFloat(document.getElementById('billingRate').value) || 0;
      const shortageDeduction = (shortage / 1000) * currentBillingRate;
      const balance = totalAmount - advance - shortageDeduction;
      document.getElementById('balance').value = balance.toFixed(2);
    }

    // Calculate functions for the edit form
    function calculateEditWeightFromPackages() {
      const numPackages = parseFloat(document.getElementById('editNumPackages').value) || 0;
      const weightPerPackage = parseFloat(document.getElementById('editWeightPerPackage').value) || 0;
      
      if (numPackages > 0 && weightPerPackage > 0) {
        const totalWeightKg = numPackages * weightPerPackage;
        const totalWeightTonne = totalWeightKg / 1000;
        document.getElementById('editWeight').value = totalWeightTonne.toFixed(3);
        calculateEditBillingAmount();
        calculateEditFreightAmount();
      }
    }

    function handleEditManualWeightInput() {
      document.getElementById('editNumPackages').value = '';
      document.getElementById('editWeightPerPackage').value = '';
      calculateEditBillingAmount();
      calculateEditFreightAmount();
    }

    function calculateEditBillingAmount() {
      const weight = parseFloat(document.getElementById('editWeight').value) || 0;
      const billingRate = parseFloat(document.getElementById('editBillingRate').value) || 0;
      const billingAmount = weight * billingRate;
      document.getElementById('editBillingAmount').value = billingAmount.toFixed(2);
      calculateEditAmount();
    }

    function calculateEditBillingRate() {
      const weight = parseFloat(document.getElementById('editWeight').value) || 0;
      const billingAmount = parseFloat(document.getElementById('editBillingAmount').value) || 0;
      if (weight > 0) {
        const billingRate = billingAmount / weight;
        document.getElementById('editBillingRate').value = billingRate.toFixed(2);
      }
      calculateEditAmount();
    }

    function calculateEditFreightAmount() {
      const weight = parseFloat(document.getElementById('editWeight').value) || 0;
      const freightRate = parseFloat(document.getElementById('editFreightRate').value) || 0;
      const freightAmount = weight * freightRate;
      document.getElementById('editFreightAmount').value = freightAmount.toFixed(2);
      calculateEditAmount();
    }

    function calculateEditFreightRate() {
      const weight = parseFloat(document.getElementById('editWeight').value) || 0;
      const freightAmount = parseFloat(document.getElementById('editFreightAmount').value) || 0;
      if (weight > 0) {
        const freightRate = freightAmount / weight;
        document.getElementById('editFreightRate').value = freightRate.toFixed(2);
      }
      calculateEditAmount();
    }

    function calculateEditAmount() {
      const billingAmount = parseFloat(document.getElementById('editBillingAmount').value) || 0;
      const advance = parseFloat(document.getElementById('editAdvance').value) || 0;
      const shortage = parseFloat(document.getElementById('editShortage').value) || 0;
      const cgstPercentage = parseFloat(document.getElementById('editCgstPercentage').value) || 0;
      const sgstPercentage = parseFloat(document.getElementById('editSgstPercentage').value) || 0;
      
      const cgstAmount = (billingAmount * cgstPercentage) / 100;
      const sgstAmount = (billingAmount * sgstPercentage) / 100;
      
      document.getElementById('editCgstAmount').value = cgstAmount.toFixed(2);
      document.getElementById('editSgstAmount').value = sgstAmount.toFixed(2);
      
      const totalAmount = billingAmount + cgstAmount + sgstAmount;
      document.getElementById('editTotalAmount').value = totalAmount.toFixed(2);
      
      // **FIX**: Use the dynamic billingRate from the edit form for shortage calculation.
      const currentEditBillingRate = parseFloat(document.getElementById('editBillingRate').value) || 0;
      const shortageDeduction = (shortage / 1000) * currentEditBillingRate;
      const balance = totalAmount - advance - shortageDeduction; 
      document.getElementById('editBalance').value = balance.toFixed(2);
    }

    // Toggle bank name field based on payment type
    function toggleBankNameField(paymentTypeId, containerId) {
      const paymentType = document.getElementById(paymentTypeId).value;
      const bankNameContainer = document.getElementById(containerId);
      
      if (paymentType === 'Bank Transfer') {
        bankNameContainer.style.display = 'block';
      } else {
        bankNameContainer.style.display = 'none';
        document.getElementById(containerId.replace('Container', '')).value = '';
      }
    }

    // Save LR to Firebase
    function saveLR() {
      const form = document.getElementById('lrForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      // Diesel entries removed; handled via vehicle fuel elsewhere

      // Read selected route for from/to
      const routeSelect = document.getElementById('routeSelect');
      const selectedRoute = routeSelect.options[routeSelect.selectedIndex];
      const fromLoc = selectedRoute ? (selectedRoute.dataset.from || '') : '';
      const toLoc = selectedRoute ? (selectedRoute.dataset.to || '') : '';
      const routeDistance = selectedRoute && selectedRoute.dataset && selectedRoute.dataset.distance ? parseFloat(selectedRoute.dataset.distance) || 0 : (parseFloat(document.getElementById('routeDistanceKm').value) || 0);
      const vehicleAverage = parseFloat(document.getElementById('vehicleAverage').value) || 0;
      const fuelUsedLiters = vehicleAverage > 0 ? (routeDistance / vehicleAverage) : 0;

      const dieselRate = parseFloat(document.getElementById('dieselRatePerLiter').value) || 0;
      const dieselAmount = fuelUsedLiters * dieselRate;
      // **FIX**: Calculate fuel cost based on an estimated price.
      // We'll use a placeholder price for now. For more accuracy, you could add a "Current Diesel Price" input field.
      const estimatedDieselPrice = 95.0; // Placeholder price per liter
      const fuelUsedAmountINR = fuelUsedLiters * estimatedDieselPrice;

      // Diesel sums removed
      const vehicleWorkVendorSelect = document.getElementById('vehicleWorkVendor');
      const selectedVendorOption = vehicleWorkVendorSelect.options[vehicleWorkVendorSelect.selectedIndex];

      const lrData = {
        date: document.getElementById('lrDate').value,
        lrNumber: document.getElementById('lrNumber').value,
        truckNumber: document.getElementById('truckNumber').value,
        clientId: document.getElementById('clientId').value,
        fromLocation: fromLoc,
        toLocation: toLoc,
        numPackages: parseFloat(document.getElementById('numPackages').value) || 0,
        weightPerPackage: parseFloat(document.getElementById('weightPerPackage').value) || 0,
        weight: parseFloat(document.getElementById('weight').value) || 0,
        consignee: document.getElementById('consignee').value,
        item: document.getElementById('item').value,
        shipmentNo: document.getElementById('shipmentNo').value,
        billingRate: parseFloat(document.getElementById('billingRate').value) || 0,
        billingAmount: parseFloat(document.getElementById('billingAmount').value) || 0,
        freightRate: parseFloat(document.getElementById('freightRate').value) || 0,
        freightAmount: parseFloat(document.getElementById('freightAmount').value) || 0,
        // --- TRIP EXPENSES - INCLUDING VEHICLE WORK ---
        tyreExpenses: parseFloat(document.getElementById('tyreExpenses').value) || 0,
        dieselEntries: [],
        dieselExpenses: dieselAmount,
        tollExpenses: parseFloat(document.getElementById('tollExpenses').value) || 0,
        vehicleWork: parseFloat(document.getElementById('vehicleWorkAmount').value) || 0, // FIX: Add this field for trip-expenses
        vehicleWorkAmount: parseFloat(document.getElementById('vehicleWorkAmount').value) || 0,
        vehicleWorkVendorId: vehicleWorkVendorSelect.value,
        vehicleWorkVendorName: selectedVendorOption ? selectedVendorOption.text : '',
        vehicleWorkNotes: document.getElementById('vehicleWorkNotes').value,
        foodExpenses: parseFloat(document.getElementById('foodExpenses').value) || 0,
        otherExpenses: parseFloat(document.getElementById('otherExpenses').value) || 0,
        // ----------------------------------------------
        vehicleAverageKmPerL: vehicleAverage,
        routeDistanceKm: routeDistance,
        fuelUsedLiters: fuelUsedLiters,
        // **FIX**: Add the calculated fuel cost to the fuelTracking object
        fuelTracking: {
          fuelUsedLiters: fuelUsedLiters, // Liters used for the trip
          fuelUsedAmountINR: dieselAmount // Total cost of fuel used for the trip
        },
        paymentType: document.getElementById('paymentType').value,
        bankName: document.getElementById('bankName').value,
        advance: parseFloat(document.getElementById('advance').value) || 0,
        shortage: parseFloat(document.getElementById('shortage').value) || 0,
        cgstPercentage: parseFloat(document.getElementById('cgstPercentage').value) || 0,
        cgstAmount: parseFloat(document.getElementById('cgstAmount').value) || 0,
        sgstPercentage: parseFloat(document.getElementById('sgstPercentage').value) || 0,
        sgstAmount: parseFloat(document.getElementById('sgstAmount').value) || 0,
        balance: parseFloat(document.getElementById('balance').value) || 0,
        totalAmount: parseFloat(document.getElementById('totalAmount').value) || 0,
        createdAt: new Date().toISOString(),
        status: 'active' // Set default status
      };

      // **FIX**: Use the `currentCoreAccountId` to save the LR report.
      // This ensures that LRs created by branch accounts are saved to the shared
      // data location, allowing the "Vehicle Work" tab in add.html to see them.
      if (!currentCoreAccountId) {
          alert('Error: Core account ID not found. Cannot save LR.');
          return;
      }
      const newLRRef = db.ref(`users/${currentCoreAccountId}/lrReports`).push();
      newLRRef.set(lrData)
        .then(async () => {
          alert('LR saved successfully!');
          // Deduct fuel from vehicle currentFuel and log usage
          try {
            const truckNo = (document.getElementById('truckNumber').value || '').trim();
            const veh = allVehicles.find(v => (v.vehicleNo || '').toUpperCase() === truckNo.toUpperCase());
            if (veh && fuelUsedLiters > 0) {
              const vRef = db.ref(`users/${currentCoreAccountId}/vehicles/${veh.id}`);
              const curSnap = await vRef.child('currentFuel').once('value');
              const before = parseFloat(curSnap.val()) || 0;
              const after = Math.max(before - fuelUsedLiters, 0);
              await vRef.child('currentFuel').set(after);
              await vRef.child('fuelLogs').push({
                timestamp: new Date().toISOString(),
                source: 'lr-add-usage',
                lrNumber: lrData.lrNumber,
                usedLiters: fuelUsedLiters,
                vehicleAverageKmPerL: vehicleAverage,
                routeDistanceKm: routeDistance,
                from: fromLoc,
                to: toLoc,
                beforeLiters: before,
                afterLiters: after
              });
            }
          } catch (e) {
            console.error('Fuel usage write failed (add):', e);
          }
          form.reset();
          // No diesel entries container to clear
          generateLRNumber();
          document.getElementById('lrDate').value = new Date().toISOString().split('T')[0];
          loadLRData();
        })
        .catch((error) => {
          console.error('Error saving LR:', error);
          alert('Error saving LR. Please try again.');
        });
    }

    // Load LR Data
    function loadLRData() {
      const fromDate = document.getElementById('fromDate').value;
      const toDate = document.getElementById('toDate').value;
      const truckFilter = document.getElementById('truckFilter').value;
      const lrSearchTerm = document.getElementById('lrSearchInput').value.trim().toLowerCase();
      
      const user = auth.currentUser;
      if (!user) return;

      const lrRef = db.ref(`users/${currentCoreAccountId}/lrReports`);
      lrRef.on('value', (snapshot) => {
        // Use the global lrTable variable
        if (lrTable) { lrTable.clear(); }
        selectedLRs = [];
        
        snapshot.forEach((childSnapshot) => {
          const lr = childSnapshot.val();
          const lrId = childSnapshot.key;

          // **FIX**: Only show LRs that have not been invoiced.
          // This prevents already-invoiced LRs from appearing in the list.
          if (lr.status === 'invoiced') return; // Skip this LR if it's invoiced

          // Apply filters
          if (fromDate && lr.date < fromDate) return;
          if (toDate && lr.date > toDate) return;
          if (truckFilter && lr.truckNumber !== truckFilter) return;
          if (lrSearchTerm && !lr.lrNumber.toLowerCase().includes(lrSearchTerm)) return;
          
          // Find client name
          const client = allClients.find(c => c.id === lr.clientId) || {};
          
          lrTable.row.add([
            `<div class="form-check">
               <input class="form-check-input lr-checkbox" type="checkbox" value="${lrId}" onchange="toggleLRSelection('${lrId}', this.checked)">
             </div>`,
            lr.date,
            lr.lrNumber,
            lr.truckNumber,
            client.clientName || 'N/A',
            lr.consignee || client.clientName || 'N/A',
            lr.item || 'N/A',
            lr.fromLocation,
            lr.toLocation,
            lr.weight,
            `₹${lr.billingAmount || 0}`,
            `₹${(lr.freightAmount || 0).toFixed(2)}`,
            `<span class="badge bg-success">Completed</span>`,
            `<button class="btn btn-sm btn-outline-info" onclick="showLRCopy('${lrId}')" title="View LR Copy">
               <i class="fas fa-print"></i>
             </button>`,
            `<button class="btn btn-sm btn-outline-primary" onclick="editLR('${lrId}')">
               <i class="fas fa-edit"></i>
             </button>
             <button class="btn btn-sm btn-outline-danger" onclick="deleteLR('${lrId}')">
               <i class="fas fa-trash"></i>
             </button>`
          ]);
        });
        
        if (lrTable) { lrTable.draw(); }

        // Update generate invoice button state
        document.getElementById('generateInvoiceBtn').disabled = selectedLRs.length === 0;
      });
    }

    // Toggle LR selection
    function toggleLRSelection(lrId, isChecked) {
      if (isChecked) {
        selectedLRs.push(lrId);
      } else {
        selectedLRs = selectedLRs.filter(id => id !== lrId);
        document.getElementById('selectAllCheckbox').checked = false;
      }
      document.getElementById('generateInvoiceBtn').disabled = selectedLRs.length === 0;
    }

    // Toggle select all
    function toggleSelectAll() {
      const checkboxes = document.querySelectorAll('.lr-checkbox');
      const selectAll = document.getElementById('selectAllCheckbox').checked;
      
      selectedLRs = [];
      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll;
        if (selectAll) {
          selectedLRs.push(checkbox.value);
        }
      });
      
      document.getElementById('generateInvoiceBtn').disabled = selectedLRs.length === 0;
    }

    // Edit LR
    function editLR(lrId) {
      currentEditingLRId = lrId;
      // **FIX**: Use the globally available `currentCoreAccountId` to ensure
      // that LR reports can be fetched regardless of whether a core or branch
      // user is logged in. This was previously using `auth.currentUser.uid`,
      // which would fail for branch accounts.
      if (!currentCoreAccountId) {
        alert("Error: Cannot determine the account to fetch data from. Please reload.");
        return;
      }
      const lrRef = db.ref(`users/${currentCoreAccountId}/lrReports/${lrId}`);
      lrRef.once('value').then((snapshot) => {
        const lr = snapshot.val();
        
        // Populate edit form
        document.getElementById('editLrDate').value = lr.date;
        document.getElementById('editLrNumber').value = lr.lrNumber;
        document.getElementById('editTruckNumber').value = lr.truckNumber;
        document.getElementById('editClientId').value = lr.clientId;
        // Preselect route in editRouteSelect based on from/to
        preselectEditRoute(lr.fromLocation, lr.toLocation);
        // Load current vehicle fuel and recalc
        handleEditTruckChangeFuel();
        handleEditRouteChangeFuel();
        document.getElementById('editNumPackages').value = lr.numPackages || '';
        document.getElementById('editWeightPerPackage').value = lr.weightPerPackage || '';
        document.getElementById('editWeight').value = lr.weight;
        document.getElementById('editConsignee').value = lr.consignee || '';
        document.getElementById('editItem').value = lr.item || '';
        document.getElementById('editShipmentNo').value = lr.shipmentNo || '';
        document.getElementById('editBillingRate').value = lr.billingRate || '';
        document.getElementById('editBillingAmount').value = lr.billingAmount || '';
        document.getElementById('editFreightRate').value = lr.freightRate || '';
        document.getElementById('editFreightAmount').value = lr.freightAmount || '';
        // Prefill fuel fields
        document.getElementById('editVehicleAverage').value = lr.vehicleAverageKmPerL || '';
        document.getElementById('editRouteDistanceKm').value = lr.routeDistanceKm || '';
        document.getElementById('editFuelUsedLiters').value = lr.fuelUsedLiters || '';
        // **NEW**: Populate the new diesel rate and expense fields
        document.getElementById('editDieselRatePerLiter').value = lr.dieselRatePerLiter || '';
        document.getElementById('editDieselExpenses').value = lr.dieselExpenses || '';
        recalcEditFuelUsed(); // Recalculate on open to ensure consistency
        prevFuelUsedLiters = lr.fuelUsedLiters || 0;
        prevTruckNumber = lr.truckNumber || '';
        
        // Diesel Expenses UI removed in edit modal
        
        // Populate other expense fields
        document.getElementById('editTyreExpenses').value = lr.tyreExpenses || 0;
        document.getElementById('editTollExpenses').value = lr.tollExpenses || 0;
        document.getElementById('editVehicleWork').value = lr.vehicleWorkAmount || 0;
        document.getElementById('editFoodExpenses').value = lr.foodExpenses || 0;
        document.getElementById('editOtherExpenses').value = lr.otherExpenses || 0;
        
        document.getElementById('editPaymentType').value = lr.paymentType || '';
        document.getElementById('editBankName').value = lr.bankName || '';
        document.getElementById('editAdvance').value = lr.advance || 0;
        document.getElementById('editShortage').value = lr.shortage || 0;
        document.getElementById('editCgstPercentage').value = lr.cgstPercentage || 9;
        document.getElementById('editCgstAmount').value = lr.cgstAmount || 0;
        document.getElementById('editSgstPercentage').value = lr.sgstPercentage || 9;
        document.getElementById('editSgstAmount').value = lr.sgstAmount || 0;
        document.getElementById('editBalance').value = lr.balance || 0;
        document.getElementById('editTotalAmount').value = lr.totalAmount || 0;
        
        // Show/hide bank name field
        toggleBankNameField('editPaymentType', 'editBankNameContainer');
        
        // Show modal
        const editModal = new bootstrap.Modal(document.getElementById('editLRModal'));
        editModal.show();
      });
    }

    // Helper: preselect route in edit modal, retry if options not yet loaded
    function preselectEditRoute(from, to, attempt = 0) {
      const select = document.getElementById('editRouteSelect');
      if (!select) return;
      const options = Array.from(select.options);
      let found = false;
      for (const opt of options) {
        if ((opt.dataset?.from || '') === (from || '') && (opt.dataset?.to || '') === (to || '')) {
          select.value = opt.value;
          found = true;
          break;
        }
      }
      if (!found && attempt < 5) {
        setTimeout(() => preselectEditRoute(from, to, attempt + 1), 300);
      }
    }

    // Update LR
    function updateLR() {
      const form = document.getElementById('editLrForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      // Diesel entries removed from edit as well

      // Read selected route from edit dropdown
      const editRouteSelect = document.getElementById('editRouteSelect');
      const selectedEditRoute = editRouteSelect ? editRouteSelect.options[editRouteSelect.selectedIndex] : null;
      const editFromLoc = selectedEditRoute ? (selectedEditRoute.dataset.from || '') : '';
      const editToLoc = selectedEditRoute ? (selectedEditRoute.dataset.to || '') : '';
      const routeDistance = selectedEditRoute && selectedEditRoute.dataset && selectedEditRoute.dataset.distance ? parseFloat(selectedEditRoute.dataset.distance) || 0 : (parseFloat(document.getElementById('editRouteDistanceKm').value) || 0);
      const vehicleAverage = parseFloat(document.getElementById('editVehicleAverage').value) || 0;
      const fuelUsedLiters = vehicleAverage > 0 ? (routeDistance / vehicleAverage) : 0;

      // **NEW**: Calculate fuel cost for the update using the new rate field
      const dieselRate = parseFloat(document.getElementById('editDieselRatePerLiter').value) || 0;
      const dieselAmount = fuelUsedLiters * dieselRate;
      // This value is now the primary source of truth for fuel cost
      const fuelUsedAmountINR = dieselAmount;

      const lrData = {
        date: document.getElementById('editLrDate').value,
        lrNumber: document.getElementById('editLrNumber').value,
        truckNumber: document.getElementById('editTruckNumber').value,
        clientId: document.getElementById('editClientId').value,
        fromLocation: editFromLoc,
        toLocation: editToLoc,
        numPackages: parseFloat(document.getElementById('editNumPackages').value) || 0,
        weightPerPackage: parseFloat(document.getElementById('editWeightPerPackage').value) || 0,
        weight: parseFloat(document.getElementById('editWeight').value) || 0,
        consignee: document.getElementById('editConsignee').value,
        item: document.getElementById('editItem').value,
        shipmentNo: document.getElementById('editShipmentNo').value,
        billingRate: parseFloat(document.getElementById('editBillingRate').value) || 0,
        billingAmount: parseFloat(document.getElementById('editBillingAmount').value) || 0,
        freightRate: parseFloat(document.getElementById('editFreightRate').value) || 0,
        freightAmount: parseFloat(document.getElementById('editFreightAmount').value) || 0,
        // --- TRIP EXPENSES - INCLUDING VEHICLE WORK ---
        tyreExpenses: parseFloat(document.getElementById('editTyreExpenses').value) || 0,
        dieselEntries: [],
        dieselExpenses: dieselAmount, // **MODIFIED**: Save the calculated diesel amount
        tollExpenses: parseFloat(document.getElementById('editTollExpenses').value) || 0,
        vehicleWork: parseFloat(document.getElementById('editVehicleWork').value) || 0, // FIX: Add this field for trip-expenses
        vehicleWorkAmount: parseFloat(document.getElementById('editVehicleWork').value) || 0,
        foodExpenses: parseFloat(document.getElementById('editFoodExpenses').value) || 0,
        otherExpenses: parseFloat(document.getElementById('editOtherExpenses').value) || 0,
        vehicleAverageKmPerL: vehicleAverage,
        routeDistanceKm: routeDistance,
        dieselRatePerLiter: dieselRate, // **NEW**: Save the rate per liter
        fuelUsedLiters: fuelUsedLiters,
        // **FIX**: Add the calculated fuel cost to the fuelTracking object on update
        fuelTracking: {
          fuelUsedLiters: fuelUsedLiters,
          fuelUsedAmountINR: fuelUsedAmountINR
        },
        paymentType: document.getElementById('editPaymentType').value,
        bankName: document.getElementById('editBankName').value,
        advance: parseFloat(document.getElementById('editAdvance').value) || 0,
        shortage: parseFloat(document.getElementById('editShortage').value) || 0,
        cgstPercentage: parseFloat(document.getElementById('editCgstPercentage').value) || 0,
        cgstAmount: parseFloat(document.getElementById('editCgstAmount').value) || 0,
        sgstPercentage: parseFloat(document.getElementById('editSgstPercentage').value) || 0,
        sgstAmount: parseFloat(document.getElementById('editSgstAmount').value) || 0,
        balance: parseFloat(document.getElementById('editBalance').value) || 0,
        totalAmount: parseFloat(document.getElementById('editTotalAmount').value) || 0,
        updatedAt: new Date().toISOString()
      };

      // **FIX**: Use the `currentCoreAccountId` to update the LR report.
      // This ensures that updates made by any user (core or branch) are saved
      // to the correct shared data location, making the change visible across the app.
      if (!currentCoreAccountId) {
          alert('Error: Core account ID not found. Cannot update LR.');
          return;
      }
      const oldTruck = prevTruckNumber;
      const newTruck = (document.getElementById('editTruckNumber').value || '').trim();
      const oldUsed = prevFuelUsedLiters || 0;
      const newUsed = fuelUsedLiters || 0;
      db.ref(`users/${currentCoreAccountId}/lrReports/${currentEditingLRId}`).update(lrData)
        .then(async () => {
          alert('LR updated successfully!');
          const editModal = bootstrap.Modal.getInstance(document.getElementById('editLRModal'));
          editModal.hide();
          // Adjust vehicle fuels based on delta or vehicle change
          try {
            if (oldTruck && newTruck && oldTruck.toUpperCase() === newTruck.toUpperCase()) {
              const veh = allVehicles.find(v => (v.vehicleNo || '').toUpperCase() === newTruck.toUpperCase());
              if (veh && oldUsed !== newUsed) {
                const delta = newUsed - oldUsed; // positive means extra usage, negative means give back
                const vRef = db.ref(`users/${currentCoreAccountId}/vehicles/${veh.id}`);
                const curSnap = await vRef.child('currentFuel').once('value');
                const before = parseFloat(curSnap.val()) || 0;
                const after = Math.max(before - delta, 0); // subtract delta (if negative, it will add)
                await vRef.child('currentFuel').set(after);
                await vRef.child('fuelLogs').push({
                  timestamp: new Date().toISOString(),
                  source: 'lr-edit-usage',
                  lrNumber: lrData.lrNumber,
                  usedLitersDelta: delta,
                  oldUsedLiters: oldUsed,
                  newUsedLiters: newUsed,
                  vehicleAverageKmPerL: vehicleAverage,
                  routeDistanceKm: routeDistance,
                  from: editFromLoc,
                  to: editToLoc,
                  beforeLiters: before,
                  afterLiters: after
                });
              }
            } else {
              // Vehicle changed: give back oldUsed to old vehicle, deduct newUsed from new vehicle
              if (oldTruck) {
                const oldVeh = allVehicles.find(v => (v.vehicleNo || '').toUpperCase() === oldTruck.toUpperCase());
                if (oldVeh && oldUsed > 0) {
                  const vRef = db.ref(`users/${currentCoreAccountId}/vehicles/${oldVeh.id}`);
                  const curSnap = await vRef.child('currentFuel').once('value');
                  const before = parseFloat(curSnap.val()) || 0;
                  const after = before + oldUsed;
                  await vRef.child('currentFuel').set(after);
                  await vRef.child('fuelLogs').push({
                    timestamp: new Date().toISOString(),
                    source: 'lr-edit-usage-revert',
                    lrNumber: lrData.lrNumber,
                    returnedLiters: oldUsed,
                    beforeLiters: before,
                    afterLiters: after
                  });
                }
              }
              if (newTruck) {
                const newVeh = allVehicles.find(v => (v.vehicleNo || '').toUpperCase() === newTruck.toUpperCase());
                if (newVeh && newUsed > 0) {
                  const vRef = db.ref(`users/${currentCoreAccountId}/vehicles/${newVeh.id}`);
                  const curSnap = await vRef.child('currentFuel').once('value');
                  const before = parseFloat(curSnap.val()) || 0;
                  const after = Math.max(before - newUsed, 0);
                  await vRef.child('currentFuel').set(after);
                  await vRef.child('fuelLogs').push({
                    timestamp: new Date().toISOString(),
                    source: 'lr-edit-usage-apply',
                    lrNumber: lrData.lrNumber,
                    usedLiters: newUsed,
                    vehicleAverageKmPerL: vehicleAverage,
                    routeDistanceKm: routeDistance,
                    from: editFromLoc,
                    to: editToLoc,
                    beforeLiters: before,
                    afterLiters: after
                  });
                }
              }
            }
          } catch (e) {
            console.error('Fuel usage write failed (edit):', e);
          }
          loadLRData();
        })
        .catch((error) => {
          console.error('Error updating LR:', error);
          alert('Error updating LR. Please try again.');
        });
    }

    // ===== Edit fuel helper functions =====
    async function handleEditTruckChangeFuel() {
      try {
        const truckNo = (document.getElementById('editTruckNumber')?.value || '').trim();
      } catch (e) {
        console.error('Failed to load current fuel (edit):', e);
      }
    }

    async function handleEditRouteChangeFuel() {
      try {
        const sel = document.getElementById('editRouteSelect');
        const opt = sel && sel.options[sel.selectedIndex];
        let distance = 0;
        if (opt && opt.dataset && opt.dataset.distance) {
          distance = parseFloat(opt.dataset.distance) || 0;
        } else if (opt && opt.value) {
          const snap = await db.ref(`users/${currentCoreAccountId}/routes/${opt.value}`).once('value');
          const r = snap.val() || {};
          distance = parseFloat(r.distance) || 0;
        }
        document.getElementById('editRouteDistanceKm').value = distance || 0;
        recalcEditFuelUsed();
      } catch (e) {
        console.error('Failed to load route distance (edit):', e);
      }
    }

    function updateAddRouteDistanceField() {
      const sel = document.getElementById('routeSelect');
      const opt = sel && sel.options[sel.selectedIndex];
      const dist = opt && opt.dataset && opt.dataset.distance ? parseFloat(opt.dataset.distance) || 0 : 0;
      const field = document.getElementById('routeDistanceKm');
      if (field) field.value = dist;
    }

    function updateEditRouteDistanceField() {
      const sel = document.getElementById('editRouteSelect');
      const opt = sel && sel.options[sel.selectedIndex];
      const dist = opt && opt.dataset && opt.dataset.distance ? parseFloat(opt.dataset.distance) || 0 : 0;
      const field = document.getElementById('editRouteDistanceKm');
      if (field) field.value = dist;
    }

    function recalcAddFuelUsed() {
      const dist = parseFloat(document.getElementById('routeDistanceKm').value) || 0;
      const avg = parseFloat(document.getElementById('vehicleAverage').value) || 0;
      const used = avg > 0 ? (dist / avg) : 0;
      document.getElementById('fuelUsedLiters').value = used.toFixed(2);
      // **NEW**: Also calculate the total diesel amount
      const rate = parseFloat(document.getElementById('dieselRatePerLiter').value) || 0;
      const totalAmount = used * rate;
      document.getElementById('dieselExpenses').value = totalAmount.toFixed(2);
    }

    function recalcEditFuelUsed() {
      const dist = parseFloat(document.getElementById('editRouteDistanceKm').value) || 0;
      const avg = parseFloat(document.getElementById('editVehicleAverage').value) || 0;
      const used = avg > 0 ? (dist / avg) : 0;
      document.getElementById('editFuelUsedLiters').value = used.toFixed(2);
      // **NEW**: Also calculate the total diesel amount in the edit modal
      const rate = parseFloat(document.getElementById('editDieselRatePerLiter').value) || 0;
      const totalAmount = used * rate;
      document.getElementById('editDieselExpenses').value = totalAmount.toFixed(2);
    }

    // Delete LR
    function deleteLR(lrId) {
      if (confirm('Are you sure you want to delete this LR?')) {
        db.ref(`users/${currentCoreAccountId}/lrReports/${lrId}`).remove()
          .then(() => {
            alert('LR deleted successfully!');
            loadLRData();
          })
          .catch((error) => {
            console.error('Error deleting LR:', error);
            alert('Error deleting LR. Please try again.');
          });
      }
    }

    // Show bank details modal
    async function showBankDetailsModal() {
      if (selectedLRs.length === 0) {
        alert('Please select at least one LR to generate invoice.');
        return;
      }

      // **FIX**: Check if all selected LRs belong to the same client before proceeding.
      try {
        let firstClientId = null;
        let allSameClient = true;

        // Create promises to fetch all selected LR data at once.
        const promises = selectedLRs.map(lrId => 
          db.ref(`users/${currentCoreAccountId}/lrReports/${lrId}`).once('value')
        );

        const snapshots = await Promise.all(promises);

        for (const snapshot of snapshots) {
          if (snapshot.exists()) {
            const lr = snapshot.val();
            if (firstClientId === null) {
              firstClientId = lr.clientId; // Set the client ID from the first LR.
            } else if (lr.clientId !== firstClientId) {
              allSameClient = false; // Found an LR with a different client.
              break;
            }
          }
        }

        if (!allSameClient) {
          alert('Invoice generation failed: All selected LRs must belong to the same consignor.');
          return;
        }

        // If all checks pass, show the bank details modal.
        const bankModal = new bootstrap.Modal(document.getElementById('bankDetailsModal'));
        bankModal.show();
      } catch (error) {
        console.error("Error validating LRs for invoice generation:", error);
        alert("An error occurred while validating the selected LRs. Please try again.");
      }
    }

    // Create and save invoice
    function createAndSaveInvoice() {
      const bankForm = document.getElementById('bankDetailsForm');
      if (!bankForm.checkValidity()) {
        bankForm.reportValidity();
        return;
      }

      // Get company and bank details
      const companyDetails = {
        name: document.getElementById('inputCompanyName').value,
        address: document.getElementById('inputCompanyAddress').value,
        gstNumber: document.getElementById('inputGstNumber').value,
        phone: document.getElementById('inputCompanyPhone').value
      };

      const bankDetails = {
        bankName: document.getElementById('inputBankName').value,
        accountHolder: document.getElementById('inputAccountHolder').value,
        accountNumber: document.getElementById('inputAccountNumber').value,
        ifscCode: document.getElementById('inputIfscCode').value,
        accountType: document.getElementById('inputAccountType').value
      };

      // Generate invoice number
      const now = new Date();
      const invoiceNumber = `INV-${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}-${Math.floor(1000 + Math.random() * 9000)}`;

      // Fetch selected LR data
      const invoiceItems = [];
      let subtotal = 0;
      let totalCgst = 0;
      let totalSgst = 0;
      let firstClientId = null; // To associate the invoice with a client

      const promises = selectedLRs.map(lrId => {
        // **FIX**: Use the correct `currentCoreAccountId` to fetch LR data,
        // ensuring it works for both core and branch accounts.
        return db.ref(`users/${currentCoreAccountId}/lrReports/${lrId}`).once('value').then(snapshot => {
          const lr = snapshot.val();
          // **FIX**: Add a check to ensure the LR data exists before processing it.
          if (!lr) {
            console.warn(`Could not find LR data for ID: ${lrId}. Skipping.`);
            return; // Skip this LR if it's not found
          }
          const client = allClients.find(c => c.id === lr.clientId) || {};
          
          invoiceItems.push({
            date: lr.date,
            lrNumber: lr.lrNumber,
            truckNumber: lr.truckNumber,
            consignor: client.clientName || 'N/A',
            consignee: lr.consignee || client.clientName || 'N/A',
            from: lr.fromLocation,
            to: lr.toLocation,
            weight: lr.weight,
            rate: lr.billingRate || 0,
            gstPercentage: (lr.cgstPercentage || 0) + (lr.sgstPercentage || 0),
            gstAmount: (lr.cgstAmount || 0) + (lr.sgstAmount || 0),
            amount: lr.billingAmount || 0,
          });
          if (!firstClientId) firstClientId = lr.clientId;
          
          subtotal += lr.billingAmount || 0;
          totalCgst += lr.cgstAmount || 0;
          totalSgst += lr.sgstAmount || 0;
        });
      });

      Promise.all(promises).then(() => {
        const grandTotal = subtotal + totalCgst + totalSgst;

        const user = auth.currentUser;

        // Save invoice to database
        const invoiceData = {
          invoiceNumber: invoiceNumber,
          date: now.toISOString().split('T')[0],
          companyDetails: companyDetails,
          bankDetails: bankDetails,
          lrEntries: selectedLRs,
          items: invoiceItems,
          subtotal: subtotal,
          cgstAmount: totalCgst,
          sgstAmount: totalSgst,
          grandTotal: grandTotal,
          createdAt: new Date().toISOString(),
          userId: user.uid,
          clientId: firstClientId
        };

        // **FIX**: Use a multi-path update to save the invoice and update LRs atomically.
        // Also, use `currentCoreAccountId` to ensure LRs are updated in the shared data location,
        // which is critical for branch accounts.
        const updates = {};
        const dataRoot = currentCoreAccountId || user.uid; // Should be coreAccountId
        const newInvoiceKey = db.ref(`users/${dataRoot}/invoices`).push().key;
        
        // 1. Add the new invoice to the updates object.
        updates[`/users/${dataRoot}/invoices/${newInvoiceKey}`] = invoiceData;

        // 2. Update the status of each selected LR.
        selectedLRs.forEach(lrId => {
          updates[`/users/${dataRoot}/lrReports/${lrId}/status`] = 'invoiced';
          updates[`/users/${dataRoot}/lrReports/${lrId}/invoiceId`] = newInvoiceKey;
        });

        // 3. Execute the atomic update.
        db.ref().update(updates)
          .then(() => {
            const bankModal = bootstrap.Modal.getInstance(document.getElementById('bankDetailsModal'));
            bankModal.hide();
            window.location.href = `invoice.html?view=${newInvoiceKey}`;
          })
          .catch(error => {
            console.error('Error saving invoice:', error);
            alert('Error saving invoice. Please try again.');
          });
      });
    }

    // Show invoice preview
    function showInvoicePreview(invoiceData) {
      // Populate invoice content
      document.getElementById('companyName').textContent = invoiceData.companyDetails.name;
      document.getElementById('companyAddress').textContent = invoiceData.companyDetails.address;
      document.getElementById('companyGst').textContent = `GST: ${invoiceData.companyDetails.gstNumber}`;
      document.getElementById('invoiceNumber').textContent = invoiceData.invoiceNumber;
      document.getElementById('invoiceDate').textContent = new Date(invoiceData.date).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
      
      document.getElementById('invoiceBankName').textContent = invoiceData.bankDetails.bankName;
      document.getElementById('invoiceAccountNumber').textContent = invoiceData.bankDetails.accountNumber;
      document.getElementById('invoiceAccountHolder').textContent = invoiceData.bankDetails.accountHolder;
      document.getElementById('invoiceIfscCode').textContent = invoiceData.bankDetails.ifscCode;
      document.getElementById('invoiceAccountType').textContent = invoiceData.bankDetails.accountType;
      document.getElementById('companyNameFooter').textContent = invoiceData.companyDetails.name;

      // Populate invoice items
      const invoiceItems = document.getElementById('invoiceItems');
      invoiceItems.innerHTML = '';
      
      invoiceData.items.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.date}</td>
          <td>${item.lrNumber}</td>
          <td>${item.truckNumber}</td>
          <td>${item.consignor}</td>
          <td>${item.consignee}</td>
          <td>${item.from}</td>
          <td>${item.to}</td>
          <td class="text-end">${item.weight}</td>
          <td class="text-end">₹${item.rate.toFixed(2)}</td>
          <td class="text-end">${item.gstPercentage}%</td>
          <td class="text-end">₹${item.gstAmount.toFixed(2)}</td>
          <td class="text-end">₹${item.amount.toFixed(2)}</td>
        `;
        invoiceItems.appendChild(row);
      });

      // Update totals
      document.getElementById('subtotalAmount').textContent = `₹${invoiceData.subtotal.toFixed(2)}`;
      document.getElementById('invoiceCgstAmount').textContent = `₹${invoiceData.cgstAmount.toFixed(2)}`;
      document.getElementById('invoiceSgstAmount').textContent = `₹${invoiceData.sgstAmount.toFixed(2)}`;
      document.getElementById('grandTotal').textContent = `₹${invoiceData.grandTotal.toFixed(2)}`;

      // Amount in words
      document.getElementById('amountInWords').textContent = convertNumberToWords(invoiceData.grandTotal);

      // Show invoice modal
      const invoiceModal = new bootstrap.Modal(document.getElementById('invoiceModal'));
      invoiceModal.show();
    }

    // Print invoice
    function printInvoice() {
      const printContent = document.getElementById('printableInvoice').innerHTML;
      const originalContent = document.body.innerHTML;
      
      document.body.innerHTML = printContent;
      window.print();
      document.body.innerHTML = originalContent;
      
      // Reload the page to restore functionality
      window.location.reload();
    }

    // --- NEW DIESEL ENTRY FUNCTIONS ---

    // Dynamically add a new diesel entry row
    window.addDieselEntry = function(containerId, optionsHtml, data = {}) {
      const container = document.getElementById(containerId);
      const entryDiv = document.createElement('div');
      entryDiv.className = 'input-group mb-2 diesel-entry';
      entryDiv.innerHTML = `
        <select class="form-select diesel-pump-name" style="flex: 2;">${optionsHtml}</select>
        <input type="number" step="0.01" class="form-control diesel-liters" placeholder="Liters" value="${data.liters || ''}">
        <input type="number" step="0.01" class="form-control diesel-per-liter" placeholder="Price/L" value="${data.perLiter || ''}">
        <input type="number" step="0.01" class="form-control diesel-total bg-light" placeholder="Total" value="${data.total || ''}" readonly>
        <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove(); calculateAmount();"><i class="fas fa-trash"></i></button>
      `;
      
      // Set the selected pump
      if (data.pumpName) {
        entryDiv.querySelector('.diesel-pump-name').value = data.pumpName;
      }

      // Add event listeners to the new inputs
      const litersInput = entryDiv.querySelector('.diesel-liters');
      const perLiterInput = entryDiv.querySelector('.diesel-per-liter');
      litersInput.addEventListener('input', () => calculateDieselRowTotal(entryDiv));
      perLiterInput.addEventListener('input', () => calculateDieselRowTotal(entryDiv));

      container.appendChild(entryDiv);
    }

    // Calculate total for a single diesel entry row
    window.calculateDieselRowTotal = function(entryDiv) {
      const liters = parseFloat(entryDiv.querySelector('.diesel-liters').value) || 0;
      const perLiter = parseFloat(entryDiv.querySelector('.diesel-per-liter').value) || 0;
      const totalInput = entryDiv.querySelector('.diesel-total');
      totalInput.value = (liters * perLiter).toFixed(2);
      
      // Recalculate the main form totals
      if (entryDiv.closest('#lrForm')) {
        calculateAmount(); // This is sufficient
      } else if (entryDiv.closest('#editLrForm')) {
        calculateEditAmount(); // This is sufficient
      }
    }

    // --- END NEW DIESEL ENTRY FUNCTIONS ---

    // Convert number to words (Indian numbering system)
    function convertNumberToWords(num) {
      const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
      const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
      
      if (num === 0) return 'Zero Rupees';
      
      let words = '';
      
      // Handle rupees part
      let rupees = Math.floor(num);
      
      if (rupees >= 10000000) {
        words += convertNumberToWords(Math.floor(rupees / 10000000)) + ' Crore ';
        rupees %= 10000000;
      }
      
      if (rupees >= 100000) {
        words += convertNumberToWords(Math.floor(rupees / 100000)) + ' Lakh ';
        rupees %= 100000;
      }
      
      if (rupees >= 1000) {
        words += convertNumberToWords(Math.floor(rupees / 1000)) + ' Thousand ';
        rupees %= 1000;
      }
      
      if (rupees >= 100) {
        words += convertNumberToWords(Math.floor(rupees / 100)) + ' Hundred ';
        rupees %= 100;
      }
      
      if (rupees > 0) {
        if (words !== '') words += 'and ';
        
        if (rupees < 20) {
          words += ones[rupees];
        } else {
          words += tens[Math.floor(rupees / 10)];
          if (rupees % 10 > 0) {
            words += ' ' + ones[rupees % 10];
          }
        }
      }
      
      words += ' Rupees';
      
      // Handle paise part
      const paise = Math.round((num - Math.floor(num)) * 100);
      if (paise > 0) {
        words += ' and ';
        if (paise < 20) {
          words += ones[paise];
        } else {
          words += tens[Math.floor(paise / 10)];
          if (paise % 10 > 0) {
            words += ' ' + ones[paise % 10];
          }
        }
        words += ' Paise';
      }
      
      return words + ' Only';
    }

    // Export to PDF
    document.getElementById('exportPdfBtn').addEventListener('click', function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l', 'mm', 'a4');
      
      // Add content to PDF
      doc.text('LR Report', 10, 10);
      // Add more content as needed...
      
      doc.save('lr-report.pdf');
    });
  </script>
</body>
</html>
