<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LR Management - Transport System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <style>
    body { padding: 0; margin: 0; background-color: #f8f9fa; }
    .tab-content { background: white; padding: 20px; border-radius: 0 0 8px 8px; }
    .subtotal-row { background-color: #f8f9fa; font-weight: bold; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

  <!-- Navbar will be loaded here by navbar-loader.js -->
  <div id="navbar-placeholder"></div>

  <div class="container">
    <h2 class="mb-4"><i class="fas fa-file-invoice me-2"></i>LR Management</h2>
    
    <!-- Tabs -->
    <ul class="nav nav-tabs" id="lrTabs">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#view">View Entries</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#add">Add New LR</a>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- View Tab -->
      <div class="tab-pane fade show active" id="view">
        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label">From Date</label>
            <input type="date" class="form-control" id="fromDate">
          </div>
          <div class="col-md-3">
            <label class="form-label">To Date</label>
            <input type="date" class="form-control" id="toDate">
          </div>
          <div class="col-md-3">
            <label class="form-label">Truck Number</label>
            <select class="form-select" id="truckFilter">
              <option value="">All Trucks</option>
            </select>
          </div>
          <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-primary me-2" id="applyFiltersBtn">Filter</button>
            <button class="btn btn-success" id="exportPdfBtn">PDF</button>
          </div>
        </div>
        <div class="mb-3">
          <button class="btn btn-primary" id="generateInvoiceBtn" onclick="showBankDetailsModal()" disabled>
            <i class="fas fa-file-invoice me-2"></i>Generate Invoice
          </button>
        </div>
        <div class="table-responsive">
          <table id="lrTable" class="table table-striped">
            <thead>
              <tr>
                <th>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="selectAllCheckbox">
                  </div>
                </th>
                <th>Date</th>
                <th>LR No</th>
                <th>Truck No</th>
                <th>Consignor</th>
                <th>Consignee</th>
                <th>Item</th>
                <th>From</th>
                <th>To</th>
                <th>Weight</th>
                <th>Billing Amount</th>
                <th>Freight Amount</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Rows will be populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Add Tab -->
      <div class="tab-pane fade" id="add">
        <form id="lrForm">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Date <span class="text-danger">*</span></label>
              <input type="date" class="form-control" id="lrDate" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">LR Number <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="lrNumber" readonly>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Truck Number <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="truckNumber" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Consignor <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="consignor" required>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">From Location <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="fromLocation" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">To Location <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="toLocation" required>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Weight (tonne) <span class="text-danger">*</span></label>
              <input type="number" class="form-control" id="weight" step="0.01" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Consignee</label>
              <input type="text" class="form-control" id="consignee">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Item</label>
              <input type="text" class="form-control" id="item">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Shipment No.</label>
              <input type="text" class="form-control" id="shipmentNo">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Billing Rate (₹/tonne)</label>
              <input type="number" step="0.01" class="form-control" id="billingRate" oninput="calculateBillingAmount()">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Billing Amount (₹)</label>
              <input type="number" step="0.01" class="form-control" id="billingAmount" oninput="calculateBillingRate()">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Freight Rate (₹/tonne)</label>
              <input type="number" step="0.01" class="form-control" id="freightRate" oninput="calculateFreightAmount()">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Freight Amount (₹)</label>
              <input type="number" step="0.01" class="form-control" id="freightAmount" oninput="calculateFreightRate()">
            </div>
          </div>
          
          <!-- NEW EXPENSE FIELDS -->
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Tyre Expenses (₹)</label>
              <input type="number" step="0.01" class="form-control" id="tyreExpenses" value="0">
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Diesel Expenses (₹)</label>
              <input type="number" step="0.01" class="form-control" id="dieselExpenses" value="0">
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Toll Expenses (₹)</label>
              <input type="number" step="0.01" class="form-control" id="tollExpenses" value="0">
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Vehicle Work (₹)</label>
              <input type="number" step="0.01" class="form-control" id="vehicleWork" value="0">
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Food Expenses (₹)</label>
              <input type="number" step="0.01" class="form-control" id="foodExpenses" value="0">
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Other Expenses (₹)</label>
              <input type="number" step="0.01" class="form-control" id="otherExpenses" value="0" oninput="calculateAmount()">
            </div>
          </div>
          <!-- END NEW EXPENSE FIELDS -->
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Payment Type</label>
              <select class="form-select" id="paymentType">
                <option value="">Select Payment Type</option>
                <option value="Cash">Cash</option>
                <option value="Credit">Credit</option>
                <option value="Bank Transfer">Bank Transfer</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Bank Name</label>
              <input type="text" class="form-control" id="bankName">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Shortage (₹)</label>
              <input type="number" step="0.01" class="form-control" id="shortage" value="0" oninput="calculateAmount()">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Advance (₹)</label>
              <input type="number" step="0.01" class="form-control" id="advance" value="0" oninput="calculateAmount()">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Balance (₹)</label>
              <input type="number" step="0.01" class="form-control" id="balance" readonly>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Subtotal (Before GST) (₹)</label>
              <input type="number" step="0.01" class="form-control" id="subtotal" readonly>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">GST %</label>
              <input type="number" step="0.01" class="form-control" id="gstPercentage" value="18" oninput="calculateGST()">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">GST Amount (₹)</label>
              <input type="number" step="0.01" class="form-control" id="gstAmount" readonly>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Total Amount (₹)</label>
              <input type="number" step="0.01" class="form-control" id="totalAmount" readonly>
            </div>
          </div>
          <button type="button" class="btn btn-primary" id="saveLRBtn">Save LR</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Bank Details Modal -->
  <div class="modal fade" id="bankDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Enter Bank & Company Details</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="bankDetailsForm">
            <div class="row mb-3">
              <div class="col-md-6">
                <h6>Company Details</h6>
                <div class="mb-3">
                  <label for="inputCompanyName" class="form-label">Company Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="inputCompanyName" required>
                </div>
                <div class="mb-3">
                  <label for="inputCompanyAddress" class="form-label">Company Address</label>
                  <textarea class="form-control" id="inputCompanyAddress" rows="2"></textarea>
                </div>
                <div class="mb-3">
                  <label for="inputGstNumber" class="form-label">GST Number</label>
                  <input type="text" class="form-control" id="inputGstNumber">
                </div>
                <div class="mb-3">
                  <label for="inputCompanyPhone" class="form-label">Phone Number</label>
                  <input type="text" class="form-control" id="inputCompanyPhone">
                </div>
              </div>
              <div class="col-md-6">
                <h6>Bank Details</h6>
                <div class="mb-3">
                  <label for="inputBankName" class="form-label">Bank Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="inputBankName" required>
                </div>
                <div class="mb-3">
                  <label for="inputAccountHolder" class="form-label">Account Holder Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="inputAccountHolder" required>
                </div>
                <div class="mb-3">
                  <label for="inputAccountNumber" class="form-label">Account Number <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="inputAccountNumber" required>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="inputIfscCode" class="form-label">IFSC Code <span class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="inputIfscCode" required>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="inputAccountType" class="form-label">Account Type</label>
                      <select class="form-select" id="inputAccountType">
                        <option value="Current">Current</option>
                        <option value="Savings">Savings</option>
                        <option value="CC">Cash Credit</option>
                        <option value="OD">Overdraft</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="createAndSaveInvoice()">Generate Invoice</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Invoice Modal -->
  <div class="modal fade" id="invoiceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title">Invoice Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-4" id="invoiceContent">
          <style>
            @media print {
              @page {
                size: A4 landscape;
                margin: 0.5cm;
              }
              body {
                font-family: Arial, sans-serif;
                font-size: 9px;
                line-height: 1.3;
                color: #333;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
              }
              .no-print {
                display: none !important;
              }
              .table {
                page-break-inside: auto;
                border-collapse: collapse;
                width: 100% !important;
                margin: 0;
                table-layout: fixed;
                width: 100%;
                margin-bottom: 1rem;
              }
              .table th, .table td {
                padding: 3px 5px;
                border: 1px solid #dee2e6 !important;
                vertical-align: middle;
                word-wrap: break-word;
                font-size: 8px;
              }
              .table thead th {
                background-color: #f8f9fa;
                font-weight: 600;
                text-align: center;
              }
              .table tbody td {
                padding: 4px 6px;
              }
              .text-end {
                text-align: right !important;
              }
              .text-center {
                text-align: center !important;
              }
              .invoice-header {
                margin-bottom: 15px;
                padding-bottom: 10px;
                border-bottom: 2px solid #dee2e6;
              }
              .company-details {
                margin-bottom: 15px;
              }
              .invoice-details {
                margin-bottom: 15px;
              }
              .bank-details {
                margin-top: 15px;
                padding: 10px;
                border: 1px solid #dee2e6;
                border-radius: 4px;
                background-color: #f8f9fa;
              }
              .signature-area {
                margin-top: 40px;
                padding-top: 20px;
                border-top: 1px solid #dee2e6;
              }
              .signature-line {
                display: inline-block;
                width: 200px;
                border-top: 1px solid #333;
                margin-top: 30px;
                padding-top: 5px;
              }  .text-end {
                text-align: right !important;
              }
              .text-center {
                text-align: center !important;
              }
              .fw-bold {
                font-weight: bold !important;
              }
              .table-active {
                background-color: #f8f9fa !important;
              }
              .table-light {
                background-color: #f8f9fa !important;
              }
              .border-bottom {
                border-bottom: 1px solid #dee2e6 !important;
              }
              .mt-4 {
                margin-top: 1.5rem !important;
              }
              .mb-0 {
                margin-bottom: 0 !important;
              }
              .mb-1 {
                margin-bottom: 0.25rem !important;
              }
              .mb-4 {
                margin-bottom: 1.5rem !important;
              }
              .me-2 {
                margin-right: 0.5rem !important;
              }
              .p-4 {
                padding: 1.5rem !important;
              }
              .small {
                font-size: 80% !important;
              }
            }
            .invoice-header {
              border-bottom: 2px solid #dee2e6;
              margin-bottom: 20px;
              padding-bottom: 15px;
            }
            .invoice-table th {
              white-space: nowrap;
              background-color: #f8f9fa !important;
            }
          </style>
          
          <div id="printableInvoice">
            <div class="row mb-4">
              <div class="col-12 text-center">
                <h3 class="mb-1">TRANSPORT INVOICE</h3>
                <p class="mb-1" id="companyName">Loading company details...</p>
                <p class="mb-1" id="companyAddress">Loading address...</p>
                <p class="mb-0" id="companyGst">GST: Loading...</p>
              </div>
            </div>
            
            <div class="row mb-4">
              <div class="col-6">
                <p class="mb-1"><strong>Bill To:</strong></p>
                <p id="billToAddress" class="mb-0">Consolidated Invoice</p>
              </div>
              <div class="col-6 text-end">
                <p class="mb-1"><strong>Invoice #: </strong><span id="invoiceNumber">INV-${new Date().getFullYear()}${String(new Date().getMonth() + 1).padStart(2, '0')}${String(new Date().getDate()).padStart(2, '0')}-${Math.floor(1000 + Math.random() * 9000)}</span></p>
                <p class="mb-1"><strong>Date: </strong><span id="invoiceDate">${new Date().toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' })}</span></p>
              </div>
            </div>
            
            <div class="table-responsive">
              <table class="table table-bordered table-sm invoice-table">
                <thead class="table-light" style="background-color: #f8f9fa !important;">
                  <tr>
                    <th style="width: 70px;">Date</th>
                    <th style="width: 90px;">LR No</th>
                    <th style="width: 70px;">Truck No</th>
                    <th style="width: 100px;">Consignor</th>
                    <th style="width: 100px;">Consignee</th>
                    <th style="width: 80px;">From</th>
                    <th style="width: 80px;">To</th>
                    <th class="text-end" style="width: 60px;">Weight</th>
                    <th class="text-end" style="width: 60px;">Rate</th>
                    <th class="text-end" style="width: 45px;">GST %</th>
                    <th class="text-end" style="width: 70px;">GST Amt</th>
                    <th class="text-end" style="width: 80px;">Amount</th>
                  </tr>
                </thead>
                <tbody id="invoiceItems">
                  <!-- Invoice items will be populated here -->
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="7" class="border-0"></td>
                    <td class="text-end border-0"><strong>Subtotal:</strong></td>
                    <td class="text-end border-0"></td>
                    <td class="text-end border-0"></td>
                    <td class="text-end border-0">-</td>
                    <td class="text-end fw-bold border-0" id="subtotalAmount">₹0.00</td>
                  </tr>
                  <tr id="gstRow">
                    <td colspan="7" class="border-0"></td>
                    <td class="text-end border-0"><strong>GST (<span id="gstPercent">18</span>%):</strong></td>
                    <td class="text-end border-0" colspan="3"></td>
                    <td class="text-end fw-bold border-0" id="invoiceGstAmount">₹0.00</td>
                  </tr>
                  <tr class="table-active">
                    <td colspan="7" class="border-0"></td>
                    <td class="text-end border-0"><strong>Grand Total:</strong></td>
                    <td class="text-end border-0" colspan="3">-</td>
                    <td class="text-end fw-bold border-0" id="grandTotal">₹0.00</td>
                  </tr>
                </tfoot>
              </table>
            </div>
            
            <div class="row mt-4">
              <div class="col-md-6">
                <p class="mb-1"><strong>Bank Details:</strong></p>
                <p class="mb-1">Bank: <span id="invoiceBankName">-</span></p>
                <p class="mb-1">Account Number: <span id="invoiceAccountNumber">-</span></p>
                <p class="mb-1">Account Holder: <span id="invoiceAccountHolder">-</span></p>
                <p class="mb-1">IFSC: <span id="invoiceIfscCode">-</span></p>
                <p class="mb-0">Account Type: <span id="invoiceAccountType">Current</span></p>
              </div>
              <div class="col-md-6 text-end">
                <div class="mt-5">
                  <p class="mb-4">For <span id="companyNameFooter">[Company Name]</span></p>
                  <p class="mb-0">___________________</p>
                  <p class="mb-0">Authorized Signatory</p>
                </div>
              </div>
            </div>
            
            <div class="row mt-4 text-center">
              <div class="col-12">
                <p class="mb-0"><small>This is a computer-generated invoice. No signature required.</small></p>
              </div>
            </div>
          </div>
          
          <div class="mt-4 no-print text-center">
            <button class="btn btn-primary me-2" onclick="printInvoice()">
              <i class="fas fa-print me-2"></i>Print Invoice
            </button>
            
            <button class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times me-2"></i>Close
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="printInvoice()">
            <i class="fas fa-print me-2"></i>Print Invoice
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="editLRModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit LR Record</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editLrForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Date <span class="text-danger">*</span></label>
                <input type="date" class="form-control" id="editLrDate" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">LR Number <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="editLrNumber" readonly>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Truck Number <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="editTruckNumber" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Consignor <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="editConsignor" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">From Location <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="editFromLocation" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">To Location <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="editToLocation" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Weight (tonne) <span class="text-danger">*</span></label>
                <input type="number" class="form-control" id="editWeight" step="0.01" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Consignee</label>
                <input type="text" class="form-control" id="editConsignee">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Item</label>
                <input type="text" class="form-control" id="editItem">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Shipment No.</label>
                <input type="text" class="form-control" id="editShipmentNo">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Billing Rate (₹/tonne)</label>
                <input type="number" step="0.01" class="form-control" id="editBillingRate" oninput="calculateEditBillingAmount()">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Billing Amount (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editBillingAmount" oninput="calculateEditBillingRate()">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Freight Rate (₹/tonne)</label>
                <input type="number" step="0.01" class="form-control" id="editFreightRate" oninput="calculateEditFreightAmount()">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Freight Amount (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editFreightAmount" oninput="calculateEditFreightRate()">
              </div>
            </div>
            
            <!-- NEW EXPENSE FIELDS FOR EDIT MODAL -->
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">Tyre Expenses (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editTyreExpenses" value="0">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Diesel Expenses (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editDieselExpenses" value="0">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Toll Expenses (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editTollExpenses" value="0">
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">Vehicle Work (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editVehicleWork" value="0">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Food Expenses (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editFoodExpenses" value="0">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Other Expenses (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editOtherExpenses" value="0" oninput="calculateEditAmount()">
              </div>
            </div>
            <!-- END NEW EXPENSE FIELDS FOR EDIT MODAL -->
            
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Payment Type</label>
                <select class="form-select" id="editPaymentType">
                  <option value="">Select Payment Type</option>
                  <option value="Cash">Cash</option>
                  <option value="Credit">Credit</option>
                  <option value="Bank Transfer">Bank Transfer</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Bank Name</label>
                <input type="text" class="form-control" id="editBankName">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Shortage (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editShortage" value="0" oninput="calculateEditAmount()">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Advance (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editAdvance" value="0" oninput="calculateEditAmount()">
              </div>
            </div>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">GST %</label>
                <input type="number" step="0.01" class="form-control" id="editGstPercentage" value="18" oninput="calculateEditGST()">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">GST Amount (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editGstAmount" readonly>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Total Amount (₹)</label>
                <input type="number" step="0.01" class="form-control" id="editTotalAmount" readonly>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="saveEditBtn">Save changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="navbar-loader.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDAlk_K8p8Of8Ne6Jpcl2QqXTtm95NgG7o",
      authDomain: "transport-dashboard-ad69a.firebaseapp.com",
      databaseURL: "https://transport-dashboard-ad69a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "transport-dashboard-ad69a",
      storageBucket: "transport-dashboard-ad69a.appspot.com",
      messagingSenderId: "526889676196",
      appId: "1:526889676196:web:66032c80a4aede690ae531"
    };

    // Global variables
    let lrData = [];
    let selectedLRs = [];
    let currentEditId = null;
    let lrTableInstance = null;
    let auth = null;
    let db = null;

    // Initialize the page
    $(document).ready(function() {
      // Initialize DataTable
      lrTableInstance = $('#lrTable').DataTable({
        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, 'All']],
        columnDefs: [
          { orderable: false, targets: [0, 13] },
          { searchable: false, targets: [0, 13] }
        ]
      });

      // Initialize Firebase
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      auth = firebase.auth();
      db = firebase.database();

      // Check authentication
      auth.onAuthStateChanged(user => {
        if (user) {
          // Load data from Firebase
          loadLRData();
        } else {
          // Redirect to login if not authenticated
          window.location.href = 'login.html';
        }
      });
      
      // Set current date as default
      const today = new Date().toISOString().split('T')[0];
      $('#lrDate').val(today);
      $('#fromDate').val(today);
      $('#toDate').val(today);
      
      // Event listeners
      $('#saveLRBtn').click(saveLR);
      $('#applyFiltersBtn').click(applyFilters);
      $('#selectAllCheckbox').change(toggleSelectAll);
      $('#saveEditBtn').click(saveEditLR);
      
      // Calculate initial amounts
      calculateAmount();
    });

    // Load LR data from localStorage
    function loadLRData() { 
      const user = auth.currentUser;
      if (!user) return;

      const lrReportsRef = db.ref('lrReports').orderByChild('userId').equalTo(user.uid);
      lrReportsRef.on('value', (snapshot) => {
        lrData = [];
        snapshot.forEach(childSnapshot => {
          const lr = childSnapshot.val();
          // Only show LRs that have not been invoiced yet
          if (lr.status !== 'Generated') {
            lrData.push({ id: childSnapshot.key, ...lr });
          }
        });
        // Sort by date descending
        lrData.sort((a, b) => new Date(b.date) - new Date(a.date));
        populateLRTable();
        updateTruckFilter();
        generateLRNumber();
      }, (error) => {
        console.error("Error loading LR data: ", error);
        alert("Could not load LR data. Please check your connection and permissions.");
      });
    }

    // Generate LR number
    function generateLRNumber() {
      const date = new Date();
      const year = date.getFullYear().toString().slice(-2);
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const day = date.getDate().toString().padStart(2, '0');
      
      // Count today's LRs
      const todayLRs = lrData.filter(lr => {
        const lrDate = new Date(lr.date);
        return lrDate.getDate() === date.getDate() && 
               lrDate.getMonth() === date.getMonth() && 
               lrDate.getFullYear() === date.getFullYear();
      });
      
      const count = todayLRs.length + 1;
      const countStr = count.toString().padStart(3, '0');
      
      $('#lrNumber').val(`LR${day}${month}${year}${countStr}`);
    }

    // Calculate billing amount based on rate and weight
    function calculateBillingAmount() {
      const weight = parseFloat($('#weight').val()) || 0;
      const billingRate = parseFloat($('#billingRate').val()) || 0;
      $('#billingAmount').val((weight * billingRate).toFixed(2));
      calculateAmount();
    }

    // Calculate billing rate based on amount and weight
    function calculateBillingRate() {
      const weight = parseFloat($('#weight').val()) || 0;
      const billingAmount = parseFloat($('#billingAmount').val()) || 0;
      if (weight > 0) {
        $('#billingRate').val((billingAmount / weight).toFixed(2));
      }
      calculateAmount();
    }

    // Calculate freight amount based on rate and weight
    function calculateFreightAmount() {
      const weight = parseFloat($('#weight').val()) || 0;
      const freightRate = parseFloat($('#freightRate').val()) || 0;
      $('#freightAmount').val((weight * freightRate).toFixed(2));
      calculateAmount();
    }

    // Calculate freight rate based on amount and weight
    function calculateFreightRate() {
      const weight = parseFloat($('#weight').val()) || 0;
      const freightAmount = parseFloat($('#freightAmount').val()) || 0;
      if (weight > 0) {
        $('#freightRate').val((freightAmount / weight).toFixed(2));
      }
      calculateAmount();
    }

    // Calculate GST and total amount
    function calculateAmount() {
      const billingAmount = parseFloat($('#billingAmount').val()) || 0;
      const freightAmount = parseFloat($('#freightAmount').val()) || 0;
      const shortage = parseFloat($('#shortage').val()) || 0;
      const advance = parseFloat($('#advance').val()) || 0;
      const otherExpenses = parseFloat($('#otherExpenses').val()) || 0;
      
      // NEW: Add all expense fields
      const tyreExpenses = parseFloat($('#tyreExpenses').val()) || 0;
      const dieselExpenses = parseFloat($('#dieselExpenses').val()) || 0;
      const tollExpenses = parseFloat($('#tollExpenses').val()) || 0;
      const vehicleWork = parseFloat($('#vehicleWork').val()) || 0;
      const foodExpenses = parseFloat($('#foodExpenses').val()) || 0;
      
      // Calculate subtotal (before GST)
      const subtotal = billingAmount + freightAmount + shortage + advance + otherExpenses + 
                      tyreExpenses + dieselExpenses + tollExpenses + vehicleWork + foodExpenses;
      $('#subtotal').val(subtotal.toFixed(2));
      
      // Calculate balance
      const balance = billingAmount - freightAmount - shortage - advance - otherExpenses - 
                     tyreExpenses - dieselExpenses - tollExpenses - vehicleWork - foodExpenses;
      $('#balance').val(balance.toFixed(2));
      
      // Calculate GST and total
      calculateGST();
    }

    // Calculate GST amount
    function calculateGST() {
      const subtotal = parseFloat($('#subtotal').val()) || 0;
      const gstPercentage = parseFloat($('#gstPercentage').val()) || 0;
      const gstAmount = (subtotal * gstPercentage / 100).toFixed(2);
      $('#gstAmount').val(gstAmount);
      
      const totalAmount = (subtotal + parseFloat(gstAmount)).toFixed(2);
      $('#totalAmount').val(totalAmount);
    }

    // Save LR record
    function saveLR() {
      // Validate form
      if (!$('#lrForm')[0].checkValidity()) {
        $('#lrForm')[0].reportValidity();
        return;
      }
      
      const user = auth.currentUser;
      if (!user) {
        alert("You must be logged in to save an LR record.");
        return;
      }

      const lrRecord = {
        date: $('#lrDate').val(),
        lrNumber: $('#lrNumber').val(),
        truckNumber: $('#truckNumber').val(),
        consignor: $('#consignor').val(),
        consignee: $('#consignee').val(),
        fromLocation: $('#fromLocation').val(),
        toLocation: $('#toLocation').val(),
        weight: parseFloat($('#weight').val()),
        item: $('#item').val(),
        shipmentNo: $('#shipmentNo').val(),
        billingRate: parseFloat($('#billingRate').val()) || 0,
        billingAmount: parseFloat($('#billingAmount').val()) || 0,
        freightRate: parseFloat($('#freightRate').val()) || 0,
        freightAmount: parseFloat($('#freightAmount').val()) || 0,
        paymentType: $('#paymentType').val(),
        bankName: $('#bankName').val(),
        shortage: parseFloat($('#shortage').val()) || 0,
        advance: parseFloat($('#advance').val()) || 0,
        otherExpenses: parseFloat($('#otherExpenses').val()) || 0,
        gstPercentage: parseFloat($('#gstPercentage').val()) || 0,
        gstAmount: parseFloat($('#gstAmount').val()) || 0,
        totalAmount: parseFloat($('#totalAmount').val()) || 0,
        status: 'active',
        
        // NEW: Add expense fields
        tyreExpenses: parseFloat($('#tyreExpenses').val()) || 0,
        dieselExpenses: parseFloat($('#dieselExpenses').val()) || 0,
        tollExpenses: parseFloat($('#tollExpenses').val()) || 0,
        vehicleWork: parseFloat($('#vehicleWork').val()) || 0, // This field is 'vehicler' in your other file, ensure consistency. Using 'vehicleWork' here.
        foodExpenses: parseFloat($('#foodExpenses').val()) || 0,

        // Firebase-specific fields
        userId: user.uid,
        branchId: localStorage.getItem('selectedBranch') || 'main', // Get branch from localStorage
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      
      // Save to Firebase
      const newLrRef = db.ref('lrReports').push();
      newLrRef.set(lrRecord)
        .then(() => {
          alert('LR record saved successfully!');
        })
        .catch((error) => {
          alert('Error saving LR record: ' + error.message);
        });

      // Reset form and generate new LR number
      $('#lrForm')[0].reset();
      generateLRNumber();
      calculateAmount();
      
      // Set current date
      const today = new Date().toISOString().split('T')[0];
      $('#lrDate').val(today);
    }

    // Populate LR table with data
    function populateLRTable() {
      // Clear the table
      lrTableInstance.clear();
      
      // Add each LR record to the table
      lrData.forEach(lr => {
        lrTableInstance.row.add([
          `<div class="form-check">
            <input class="form-check-input lr-checkbox" type="checkbox" value="${lr.id}">
          </div>`,
          lr.date,
          lr.lrNumber,
          lr.truckNumber,
          lr.consignor,
          lr.consignee,
          lr.item,
          lr.fromLocation,
          lr.toLocation,
          lr.weight,
          lr.billingAmount.toFixed(2),
          lr.freightAmount.toFixed(2),
          `<span class="badge ${getStatusBadge(lr.status)}">${lr.status}</span>`,
          `<button class="btn btn-sm btn-outline-primary me-1" onclick="editLR('${lr.id}')">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteLR('${lr.id}')">
            <i class="fas fa-trash"></i>
          </button>`
        ]);
      });
      
      // Redraw the table
      lrTableInstance.draw();
      
      // Update checkbox event listeners
      $('.lr-checkbox').change(function() {
        updateSelectedLRs();
      });
    }

    // Get bootstrap badge class based on status
    function getStatusBadge(status) {
      switch (status.toLowerCase()) {
        case 'completed':
          return 'bg-success';
        case 'generated':
          return 'bg-info';
        default:
          return 'bg-warning';
      }
    }

    // Update truck filter dropdown
    function updateTruckFilter() {
      const truckFilter = $('#truckFilter');
      truckFilter.empty();
      truckFilter.append('<option value="">All Trucks</option>');
      
      // Get unique truck numbers
      const truckNumbers = [...new Set(lrData.map(lr => lr.truckNumber))];
      truckNumbers.forEach(truck => {
        truckFilter.append(`<option value="${truck}">${truck}</option>`);
      });
    }

    // Apply filters to the table
    function applyFilters() {
      const fromDate = document.getElementById('fromDate').value;
      const toDate = document.getElementById('toDate').value;
      const truckNumber = document.getElementById('truckFilter').value;
      
      // Use DataTables custom search function for filtering
      $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
        // Ensure we are targeting the correct table
        if (settings.nTable.id !== 'lrTable') {
          return true;
        }
        
        const rowDate = data[1] || ''; // Date is in the second column (index 1)
        const rowTruck = data[3] || ''; // Truck number is in the fourth column (index 3)
        
        let showRow = true;
        
        // Date range filter
        if (fromDate && rowDate < fromDate) showRow = false;
        if (toDate && rowDate > toDate) showRow = false;
        
        // Truck number filter
        if (truckNumber && rowTruck !== truckNumber) showRow = false;
        
        return showRow;
      });
      
      // Redraw the table with the new filter
      lrTableInstance.draw();
      
      // Update checkbox event listeners
      $('.lr-checkbox').change(function() {
        updateSelectedLRs();
      });
      
      // Update selected LRs
      updateSelectedLRs();

      // Remove the custom filter function so it doesn't interfere with other searches
      $.fn.dataTable.ext.search.length = 0;
    }

    // Toggle select all checkboxes
    function toggleSelectAll() {
      const isChecked = $('#selectAllCheckbox').prop('checked');
      $('.lr-checkbox').prop('checked', isChecked);
      updateSelectedLRs();
    }

    // Update selected LRs array
    function updateSelectedLRs() {
      selectedLRs = [];
      $('.lr-checkbox:checked').each(function() {
        selectedLRs.push($(this).val());
      });
      
      // Enable/disable generate invoice button
      $('#generateInvoiceBtn').prop('disabled', selectedLRs.length === 0);
    }

    // Show bank details modal
    function showBankDetailsModal() {
      $('#bankDetailsModal').modal('show');
    }

    // Generate invoice
    function generateInvoice() {
      // Validate bank details form
      if (!$('#bankDetailsForm')[0].checkValidity()) {
        $('#bankDetailsForm')[0].reportValidity();
        return;
      }
      
      // Get selected LRs
      const selectedLRRecords = lrData.filter(lr => selectedLRs.includes(lr.id));
      
      if (selectedLRRecords.length === 0) {
        alert('No LRs selected for invoice generation.');
        return;
      }
      
      // Generate invoice number and date
      const now = new Date();
      const invoiceNumber = `INV-${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}-${Math.floor(1000 + Math.random() * 9000)}`;
      const invoiceDate = now.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
      
      // Update invoice header
      $('#companyName').text($('#inputCompanyName').val() || 'Your Company Name');
      $('#companyAddress').text($('#inputCompanyAddress').val() || 'Your Company Address');
      $('#companyGst').text('GST: ' + ($('#inputGstNumber').val() || 'Not provided'));
      $('#companyNameFooter').text($('#inputCompanyName').val() || 'Your Company Name');
      
      // Update invoice details
      $('#invoiceNumber').text(invoiceNumber);
      $('#invoiceDate').text(invoiceDate);
      
      // Update bill to address (use first consignee's details)
      const firstConsignee = selectedLRRecords[0]?.consignee || 'Consignee Name';
      $('#billToAddress').text(firstConsignee);
      
      // Update bank details
      $('#invoiceBankName').text($('#inputBankName').val() || 'Bank Name');
      $('#invoiceAccountNumber').text($('#inputAccountNumber').val() || 'Account Number');
      $('#invoiceAccountHolder').text($('#inputAccountHolder').val() || 'Account Holder');
      $('#invoiceIfscCode').text($('#inputIfscCode').val() || 'IFSC Code');
      $('#invoiceAccountType').text($('#inputAccountType').val() || 'Account Type');
      
      // Clear and populate invoice items
      $('#invoiceItems').empty();
      let subtotal = 0;
      let gstAmount = 0;
      
      selectedLRRecords.forEach(lr => {
        const itemSubtotal = lr.billingAmount || 0;
        const itemGst = itemSubtotal * ((lr.gstPercentage || 0) / 100);
        
        subtotal += itemSubtotal;
        gstAmount += itemGst;
        
        $('#invoiceItems').append(`
          <tr>
            <td class="text-center">${lr.date || '-'}</td>
            <td class="text-center">${lr.lrNumber || '-'}</td>
            <td class="text-center">${lr.truckNumber || '-'}</td>
            <td>${lr.consignor || '-'}</td>
            <td>${lr.consignee || '-'}</td>
            <td class="text-center">${lr.fromLocation || '-'}</td>
            <td class="text-center">${lr.toLocation || '-'}</td>
            <td class="text-end">${(lr.weight || 0).toFixed(2)}</td>
            <td class="text-end">${(lr.billingRate || 0).toFixed(2)}</td>
            <td class="text-end">${lr.gstPercentage || 0}%</td>
            <td class="text-end">₹${parseFloat(itemGst).toFixed(2)}</td>
            <td class="text-end">₹${parseFloat(itemSubtotal).toFixed(2)}</td>
          </tr>
        `);
      });
      
      // Update totals with proper formatting
      const formatCurrency = (amount) => {
        return parseFloat(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      };
      
      $('#subtotalAmount').text('₹' + formatCurrency(subtotal));
      $('#invoiceGstAmount').text('₹' + formatCurrency(gstAmount));
      $('#grandTotal').text('₹' + formatCurrency(subtotal + gstAmount));
      $('#gstPercent').text(selectedLRRecords[0]?.gstPercentage || 0);
      
      // Show invoice modal
      $('#bankDetailsModal').modal('hide');
      $('#invoiceModal').modal('show');
    }

    // Generate and save the invoice, then show the print preview
    function generateInvoicePreview(selectedLRRecords) {
      // This function populates the invoice modal's HTML but doesn't show it.
      // It's used to calculate totals before saving to the database.
      
      // Generate invoice number and date
      const now = new Date();
      const invoiceNumber = `INV-${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}-${Math.floor(1000 + Math.random() * 9000)}`;
      const invoiceDate = now.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
      
      // Update invoice header
      $('#companyName').text($('#inputCompanyName').val() || 'Your Company Name');
      $('#companyAddress').text($('#inputCompanyAddress').val() || 'Your Company Address');
      $('#companyGst').text('GST: ' + ($('#inputGstNumber').val() || 'Not provided'));
      $('#companyNameFooter').text($('#inputCompanyName').val() || 'Your Company Name');
      
      // Update invoice details
      $('#invoiceNumber').text(invoiceNumber);
      $('#invoiceDate').text(invoiceDate);
      
      // Update bill to address (use first consignee's details)
      const firstConsignee = selectedLRRecords[0]?.consignee || 'Consignee Name';
      $('#billToAddress').text(firstConsignee);
      
      // Update bank details
      $('#invoiceBankName').text($('#inputBankName').val() || 'Bank Name');
      $('#invoiceAccountNumber').text($('#inputAccountNumber').val() || 'Account Number');
      $('#invoiceAccountHolder').text($('#inputAccountHolder').val() || 'Account Holder');
      $('#invoiceIfscCode').text($('#inputIfscCode').val() || 'IFSC Code');
      $('#invoiceAccountType').text($('#inputAccountType').val() || 'Account Type');
      
      // Clear and populate invoice items
      $('#invoiceItems').empty();
      let subtotal = 0;
      let gstAmount = 0;
      
      selectedLRRecords.forEach(lr => {
        const itemSubtotal = lr.billingAmount || 0;
        // Use the GST percentage from the LR record itself
        const itemGst = itemSubtotal * ((lr.gstPercentage || 0) / 100);
        
        subtotal += itemSubtotal;
        gstAmount += itemGst;
        
        $('#invoiceItems').append(`
          <tr>
            <td class="text-center">${lr.date || '-'}</td>
            <td class="text-center">${lr.lrNumber || '-'}</td>
            <td class="text-center">${lr.truckNumber || '-'}</td>
            <td>${lr.consignor || '-'}</td>
            <td>${lr.consignee || '-'}</td>
            <td class="text-center">${lr.fromLocation || '-'}</td>
            <td class="text-center">${lr.toLocation || '-'}</td>
            <td class="text-end">${(lr.weight || 0).toFixed(2)}</td>
            <td class="text-end">${(lr.billingRate || 0).toFixed(2)}</td>
            <td class="text-end">${lr.gstPercentage || 0}%</td>
            <td class="text-end">₹${parseFloat(itemGst).toFixed(2)}</td>
            <td class="text-end">₹${parseFloat(itemSubtotal).toFixed(2)}</td>
          </tr>
        `);
      });
      
      $('#subtotalAmount').text('₹' + subtotal.toFixed(2));
      $('#invoiceGstAmount').text('₹' + gstAmount.toFixed(2));
      $('#grandTotal').text('₹' + (subtotal + gstAmount).toFixed(2));
      $('#gstPercent').text(selectedLRRecords[0]?.gstPercentage || 18);
    }

    function createAndSaveInvoice() {
      const user = auth.currentUser;
      if (!user) {
        alert("You must be logged in to generate an invoice.");
        return;
      }

      // Validate bank details form
      if (!$('#bankDetailsForm')[0].checkValidity()) {
        $('#bankDetailsForm')[0].reportValidity();
        return;
      }

      const selectedLRRecords = lrData.filter(lr => selectedLRs.includes(lr.id));
      if (selectedLRRecords.length === 0) {
        alert('No LRs selected for invoice generation.');
        return;
      }

      // **FIX**: First, run the preview generation to calculate and populate totals in the DOM
      generateInvoicePreview(selectedLRRecords);

      // 1. Create the invoice object
      const invoiceRef = db.ref('invoices').push();
      const invoiceId = invoiceRef.key;
      const now = new Date();
      // Get the consignee from the first selected LR to use as the client name
      const clientName = selectedLRRecords.length > 0 ? selectedLRRecords[0].consignee : 'N/A';

      const invoiceNumber = `INV-${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}-${Math.floor(1000 + Math.random() * 9000)}`;

      const invoiceData = {
        id: invoiceId,
        invoiceNumber: invoiceNumber,
        userId: user.uid,
        createdAt: now.toISOString(),
        lrIds: selectedLRs,
        companyDetails: {
          name: $('#inputCompanyName').val(),
          address: $('#inputCompanyAddress').val(),
          gst: $('#inputGstNumber').val(),
          phone: $('#inputCompanyPhone').val()
        },
        clientDetails: {
          name: clientName,
          // address: clientAddress, // Future enhancement: add client address field
        },
        bankDetails: {
          bankName: $('#inputBankName').val(),
          accountHolder: $('#inputAccountHolder').val(),
          accountNumber: $('#inputAccountNumber').val(),
          ifsc: $('#inputIfscCode').val(),
          accountType: $('#inputAccountType').val()
        },
        // Store calculated totals
        subtotal: parseFloat($('#subtotalAmount').text().replace(/[^0-9.-]+/g,"")),
        gstAmount: parseFloat($('#invoiceGstAmount').text().replace(/[^0-9.-]+/g,"")),
        grandTotal: parseFloat($('#grandTotal').text().replace(/[^0-9.-]+/g,""))
      };

      // 2. Prepare multi-path update for atomicity
      const updates = {};
      // Add the new invoice
      updates[`/invoices/${invoiceId}`] = invoiceData;
      // Update status and add invoiceId for each LR
      selectedLRs.forEach(lrId => {
        updates[`/lrReports/${lrId}/status`] = 'Generated';
        updates[`/lrReports/${lrId}/invoiceId`] = invoiceId;
        updates[`/lrReports/${lrId}/updatedAt`] = now.toISOString();
      });

      // 3. Execute the update
      db.ref().update(updates)
        .then(() => {
          $('#bankDetailsModal').modal('hide');
          alert('Invoice generated successfully!');
          // Redirect to the invoice page to view the newly created invoice
          window.location.href = `invoice.html?view=${invoiceId}`;
        })
        .catch((error) => {
          console.error("Error generating invoice: ", error);
          alert("Could not generate the invoice. Please check your database rules and try again.");
        });
    }
    window.createAndSaveInvoice = createAndSaveInvoice; // Make it accessible from the modal's onclick

    // Edit LR record
    function editLR(id) {
      const lr = lrData.find(item => item.id === id);
      if (!lr) return;
      
      currentEditId = id;
      
      // Populate edit form
      $('#editLrDate').val(lr.date);
      $('#editLrNumber').val(lr.lrNumber);
      $('#editTruckNumber').val(lr.truckNumber);
      $('#editConsignor').val(lr.consignor);
      $('#editConsignee').val(lr.consignee);
      $('#editFromLocation').val(lr.fromLocation);
      $('#editToLocation').val(lr.toLocation);
      $('#editWeight').val(lr.weight);
      $('#editItem').val(lr.item);
      $('#editShipmentNo').val(lr.shipmentNo);
      $('#editBillingRate').val(lr.billingRate);
      $('#editBillingAmount').val(lr.billingAmount);
      $('#editFreightRate').val(lr.freightRate);
      $('#editFreightAmount').val(lr.freightAmount);
      $('#editPaymentType').val(lr.paymentType);
      $('#editBankName').val(lr.bankName);
      $('#editShortage').val(lr.shortage);
      $('#editAdvance').val(lr.advance);
      $('#editOtherExpenses').val(lr.otherExpenses);
      $('#editGstPercentage').val(lr.gstPercentage);
      $('#editGstAmount').val(lr.gstAmount);
      $('#editTotalAmount').val(lr.totalAmount);
      
      // NEW: Populate expense fields in edit modal
      $('#editTyreExpenses').val(lr.tyreExpenses || 0);
      $('#editDieselExpenses').val(lr.dieselExpenses || 0);
      $('#editTollExpenses').val(lr.tollExpenses || 0);
      $('#editVehicleWork').val(lr.vehicleWork || 0);
      $('#editFoodExpenses').val(lr.foodExpenses || 0);
      
      // Show edit modal
      $('#editLRModal').modal('show');
    }

    // Calculate billing amount for edit form
    function calculateEditBillingAmount() {
      const weight = parseFloat($('#editWeight').val()) || 0;
      const billingRate = parseFloat($('#editBillingRate').val()) || 0;
      $('#editBillingAmount').val((weight * billingRate).toFixed(2));
      calculateEditAmount();
    }

    // Calculate billing rate for edit form
    function calculateEditBillingRate() {
      const weight = parseFloat($('#editWeight').val()) || 0;
      const billingAmount = parseFloat($('#editBillingAmount').val()) || 0;
      if (weight > 0) {
        $('#editBillingRate').val((billingAmount / weight).toFixed(2));
      }
      calculateEditAmount();
    }

    // Calculate freight amount for edit form
    function calculateEditFreightAmount() {
      const weight = parseFloat($('#editWeight').val()) || 0;
      const freightRate = parseFloat($('#editFreightRate').val()) || 0;
      $('#editFreightAmount').val((weight * freightRate).toFixed(2));
      calculateEditAmount();
    }

    // Calculate freight rate for edit form
    function calculateEditFreightRate() {
      const weight = parseFloat($('#editWeight').val()) || 0;
      const freightAmount = parseFloat($('#editFreightAmount').val()) || 0;
      if (weight > 0) {
        $('#editFreightRate').val((freightAmount / weight).toFixed(2));
      }
      calculateEditAmount();
    }

    // Calculate amount for edit form
    function calculateEditAmount() {
      const billingAmount = parseFloat($('#editBillingAmount').val()) || 0;
      const freightAmount = parseFloat($('#editFreightAmount').val()) || 0;
      const shortage = parseFloat($('#editShortage').val()) || 0;
      const advance = parseFloat($('#editAdvance').val()) || 0;
      const otherExpenses = parseFloat($('#editOtherExpenses').val()) || 0;
      
      // NEW: Add all expense fields
      const tyreExpenses = parseFloat($('#editTyreExpenses').val()) || 0;
      const dieselExpenses = parseFloat($('#editDieselExpenses').val()) || 0;
      const tollExpenses = parseFloat($('#editTollExpenses').val()) || 0;
      const vehicleWork = parseFloat($('#editVehicleWork').val()) || 0;
      const foodExpenses = parseFloat($('#editFoodExpenses').val()) || 0;
      
      // Calculate subtotal (before GST)
      const subtotal = billingAmount + freightAmount + shortage + advance + otherExpenses + 
                      tyreExpenses + dieselExpenses + tollExpenses + vehicleWork + foodExpenses;
      
      // Calculate GST and total
      calculateEditGST();
    }

    // Calculate GST for edit form
    function calculateEditGST() {
      const billingAmount = parseFloat($('#editBillingAmount').val()) || 0;
      const freightAmount = parseFloat($('#editFreightAmount').val()) || 0;
      const shortage = parseFloat($('#editShortage').val()) || 0;
      const advance = parseFloat($('#editAdvance').val()) || 0;
      const otherExpenses = parseFloat($('#editOtherExpenses').val()) || 0;
      
      // NEW: Add all expense fields
      const tyreExpenses = parseFloat($('#editTyreExpenses').val()) || 0;
      const dieselExpenses = parseFloat($('#editDieselExpenses').val()) || 0;
      const tollExpenses = parseFloat($('#editTollExpenses').val()) || 0;
      const vehicleWork = parseFloat($('#editVehicleWork').val()) || 0;
      const foodExpenses = parseFloat($('#editFoodExpenses').val()) || 0;
      
      // Calculate subtotal (before GST)
      const subtotal = billingAmount + freightAmount + shortage + advance + otherExpenses + 
                      tyreExpenses + dieselExpenses + tollExpenses + vehicleWork + foodExpenses;
      
      const gstPercentage = parseFloat($('#editGstPercentage').val()) || 0;
      const gstAmount = (subtotal * gstPercentage / 100).toFixed(2);
      $('#editGstAmount').val(gstAmount);
      
      const totalAmount = (subtotal + parseFloat(gstAmount)).toFixed(2);
      $('#editTotalAmount').val(totalAmount);
    }

    // Save edited LR record
    function saveEditLR() {
      if (!currentEditId) return;
      
      // Find the LR record to update
      const lrToUpdate = lrData.find(lr => lr.id === currentEditId);
      if (!lrToUpdate) return;
      
      // Update the record
      const updatedData = {
        ...lrToUpdate,
        date: $('#editLrDate').val(),
        lrNumber: $('#editLrNumber').val(),
        truckNumber: $('#editTruckNumber').val(),
        consignor: $('#editConsignor').val(),
        consignee: $('#editConsignee').val(),
        fromLocation: $('#editFromLocation').val(),
        toLocation: $('#editToLocation').val(),
        weight: parseFloat($('#editWeight').val()),
        item: $('#editItem').val(),
        shipmentNo: $('#editShipmentNo').val(),
        billingRate: parseFloat($('#editBillingRate').val()) || 0,
        billingAmount: parseFloat($('#editBillingAmount').val()) || 0,
        freightRate: parseFloat($('#editFreightRate').val()) || 0,
        freightAmount: parseFloat($('#editFreightAmount').val()) || 0,
        paymentType: $('#editPaymentType').val(),
        bankName: $('#editBankName').val(),
        shortage: parseFloat($('#editShortage').val()) || 0,
        advance: parseFloat($('#editAdvance').val()) || 0,
        otherExpenses: parseFloat($('#editOtherExpenses').val()) || 0,
        gstPercentage: parseFloat($('#editGstPercentage').val()) || 0,
        gstAmount: parseFloat($('#editGstAmount').val()) || 0,
        totalAmount: parseFloat($('#editTotalAmount').val()) || 0,
        status: $('#editStatus').val() || lrToUpdate.status, // Keep existing status unless changed
        
        // NEW: Update expense fields
        tyreExpenses: parseFloat($('#editTyreExpenses').val()) || 0,
        dieselExpenses: parseFloat($('#editDieselExpenses').val()) || 0,
        tollExpenses: parseFloat($('#editTollExpenses').val()) || 0,
        vehicleWork: parseFloat($('#editVehicleWork').val()) || 0,
        foodExpenses: parseFloat($('#editFoodExpenses').val()) || 0,
        updatedAt: new Date().toISOString()
      };
      
      // Save to Firebase
      db.ref('lrReports/' + currentEditId).update(updatedData)
        .then(() => {
          // Close the modal
          $('#editLRModal').modal('hide');
          // Show success message
          alert('LR record updated successfully!');
        })
        .catch((error) => {
          alert('Error updating LR record: ' + error.message);
        });
    }

    // Delete LR record
    function deleteLR(id) {
      if (!confirm('Are you sure you want to delete this LR record?')) return;
      
      // Remove the record
      db.ref('lrReports/' + id).remove()
        .then(() => {
          // Show success message
          alert('LR record deleted successfully!');
          // The onValue listener will automatically update the table
        })
        .catch((error) => {
          alert('Error deleting LR record: ' + error.message);
        });
    }
  </script>
</body>
</html>
