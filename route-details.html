<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fuel Management - Transport System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { padding: 0; margin: 0; background-color: #f8f9fa; }
    .main-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .form-section {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #dee2e6;
    }
    .nav-tabs .nav-link.active {
      background-color: #2E8B57;
      color: white;
      border-color: #2E8B57;
    }
    .nav-tabs .nav-link {
      color: #2E8B57;
    }
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <script src="navbar-loader.js"></script>

  <div class="container mt-4">
    <div class="main-content">
      <!-- This div will contain the main list view -->
      <div id="pumpListView">
        <h2 class="mb-4"><i class="fas fa-gas-pump me-2"></i>Fuel Management</h2>

      <!-- Tabs -->
      <ul class="nav nav-tabs" id="fuelTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="pumps-tab" data-bs-toggle="tab" data-bs-target="#pumps" type="button" role="tab" aria-controls="pumps" aria-selected="true">
            <i class="fas fa-gas-pump me-1"></i> Manage Pumps
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payments" type="button" role="tab" aria-controls="payments" aria-selected="false">
            <i class="fas fa-money-bill-wave me-1"></i> Fuel Payments
          </button>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content" id="fuelTabsContent">
        <!-- Pumps Tab -->
        <div class="tab-pane fade show active p-3" id="pumps" role="tabpanel" aria-labelledby="pumps-tab">
          <!-- Add Pump Form -->
          <form id="pumpForm" class="form-section">
            <h4 class="mb-3">Add New Pump</h4>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="pumpName" class="form-label">Pump Name <span class="text-danger">*</span></label>
                <input type="text" id="pumpName" class="form-control" placeholder="Unique Pump Name" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="pumpPlace" class="form-label">Place / Location <span class="text-danger">*</span></label>
                <input type="text" id="pumpPlace" class="form-control" placeholder="City, State" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="pumpContact" class="form-label">Contact Number</label>
                <input type="tel" id="pumpContact" class="form-control" placeholder="Mobile Number">
              </div>
              <div class="col-md-4 mb-3">
                <label for="pumpEmail" class="form-label">Email</label>
                <input type="email" id="pumpEmail" class="form-control" placeholder="Email Address">
              </div>
              <div class="col-md-4 mb-3">
                <label for="pumpGstin" class="form-label">GSTIN</label>
                <input type="text" id="pumpGstin" class="form-control" placeholder="GST Identification Number">
              </div>
            </div>
            <button type="submit" class="btn btn-primary"><i class="fas fa-plus me-2"></i>Add Pump</button>
          </form>

          <!-- Search + Export -->
          <div class="d-flex justify-content-between align-items-center my-3">
            <h4>Pump List</h4>
            <button id="exportExcel" class="btn btn-success"><i class="fas fa-file-excel me-2"></i>Export to Excel</button>
          </div>

          <!-- Pump List Table -->
          <div class="table-responsive">
            <table id="pumpTable" class="table table-striped table-bordered" style="width:100%">
              <thead>
                <tr>
                  <th>Pump Name</th>
                  <th>Place</th>
                  <th>Contact</th>
                  <th>GSTIN</th>
                  <th class="text-end">Total Billed (₹)</th>
                  <th class="text-end">Total Paid (₹)</th>
                  <th class="text-end">Outstanding (₹)</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody id="pumpTableBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Payments Tab -->
        <div class="tab-pane fade p-3" id="payments" role="tabpanel" aria-labelledby="payments-tab">
          <!-- Add Payment Form -->
          <form id="fuelPaymentForm" class="form-section">
            <h4 class="mb-3">Record a Fuel Payment</h4>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="fuelPaymentPumpSelect" class="form-label">Select Pump <span class="text-danger">*</span></label>
                <select id="fuelPaymentPumpSelect" class="form-select" required>
                  <option value="">Loading pumps...</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label for="fuelPaymentAmount" class="form-label">Amount (₹) <span class="text-danger">*</span></label>
                <input type="number" id="fuelPaymentAmount" class="form-control" placeholder="Amount Paid" required step="0.01">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="fuelPaymentDate" class="form-label">Payment Date <span class="text-danger">*</span></label>
                <input type="date" id="fuelPaymentDate" class="form-control" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="fuelPaymentMode" class="form-label">Payment Mode</label>
                <select id="fuelPaymentMode" class="form-select">
                  <option value="Cash">Cash</option>
                  <option value="UPI">UPI</option>
                  <option value="Bank Transfer">Bank Transfer</option>
                  <option value="Cheque">Cheque</option>
                </select>
              </div>
            </div>
            <label for="fuelPaymentRemarks" class="form-label">Remarks / Notes</label>
            <textarea id="fuelPaymentRemarks" class="form-control" rows="2" placeholder="e.g., Payment for the month of June"></textarea>
            <button type="submit" class="btn btn-primary mt-3"><i class="fas fa-save me-2"></i>Save Payment</button>
          </form>

          <h4 class="mt-5 mb-3">Payment History</h4>
          <div class="table-responsive">
            <table id="fuelPaymentsTable" class="table table-striped table-bordered" style="width:100%">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Pump Name</th>
                  <th class="text-end">Amount (₹)</th>
                  <th>Mode</th>
                  <th>Remarks</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody id="fuelPaymentsTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

      <!-- Pump Detail View (Initially Hidden) -->
      <div id="pumpDetailView" class="hidden">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 id="pumpTitle" class="mb-0">Pump Details</h2>
          <button class="btn btn-secondary" id="backBtn"><i class="fas fa-arrow-left me-2"></i>Back to List</button>
        </div>

        <div class="card mb-4">
          <div class="card-body">
            <div class="row">
              <div class="col-md-4"><strong>Contact:</strong> <span id="pumpDetailContact"></span></div>
              <div class="col-md-4"><strong>GSTIN:</strong> <span id="pumpDetailGSTIN"></span></div>
              <div class="col-md-4"><strong>Email:</strong> <span id="pumpDetailEmail"></span></div>
            </div>
            <hr>
            <div class="row">
              <div class="col-md-3"><strong>Total Billed:</strong> <span id="pumpDetailTotalSpent" class="fw-bold text-danger"></span></div>
              <div class="col-md-3"><strong>Total Paid:</strong> <span id="pumpDetailTotalPaid" class="fw-bold text-success"></span></div>
              <div class="col-md-3"><strong>Outstanding:</strong> <span id="pumpDetailOutstanding" class="fw-bold text-warning"></span></div>
              <div class="col-md-3"><strong>Total Liters:</strong> <span id="pumpDetailTotalLiters" class="fw-bold"></span></div>
            </div>
          </div>
        </div>

        <h4 class="mt-4">Transaction History</h4>
        <div class="table-responsive">
          <table id="pumpTransactionTable" class="table table-striped table-bordered" style="width:100%">
            <thead>
              <tr><th>Date</th><th>LR No.</th><th>Vehicle No.</th><th class="text-end">Liters</th><th class="text-end">Price/Liter</th><th class="text-end">Total Amount (₹)</th></tr>
            </thead>
            <tbody id="pumpTransactionTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, push, onValue, update, remove, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Config
    const firebaseConfig = {
      apiKey: "AIzaSyDAlk_K8p8Of8Ne6Jpcl2QqXTtm95NgG7o",
      authDomain: "transport-dashboard-ad69a.firebaseapp.com",
      databaseURL: "https://transport-dashboard-ad69a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "transport-dashboard-ad69a",
      storageBucket: "transport-dashboard-ad69a.appspot.com",
      messagingSenderId: "526889676196",
      appId: "1:526889676196:web:66032c80a4aede690ae531",
      measurementId: "G-7F9R7HJYDH"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let pumpTable;
    let currentUser = null;
    let transactionTable;
    let fuelPaymentsTable;
    let currentEditingPaymentId = null; // To track which payment is being edited

    // Save active tab
    const fuelTabs = document.querySelectorAll('#fuelTabs button');
    fuelTabs.forEach(tab => {
      tab.addEventListener('shown.bs.tab', event => localStorage.setItem('activeFuelTab', event.target.id));
    });

    // Auth Check
    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        currentUser = user;
        pumpTable = $('#pumpTable').DataTable({
          "pageLength": 10,
          "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
          "columnDefs": [{ "orderable": false, "targets": 7 }, { "className": "text-end", "targets": [4, 5, 6] }],
          "order": [[ 4, "desc" ]] 
        });
        transactionTable = $('#pumpTransactionTable').DataTable({
          "pageLength": 10,
          "order": [[ 0, "desc" ]] // Default sort by Date descending
        });
        fuelPaymentsTable = $('#fuelPaymentsTable').DataTable({
          "pageLength": 10,
          "order": [[ 0, "desc" ]], // Sort by date descending
          "columnDefs": [{ "orderable": false, "targets": 5 }, { "className": "text-end", "targets": 2 }]
        });
        loadPumps(user.uid);

        // Restore active tab
        const activeTabId = localStorage.getItem('activeFuelTab');
        if (activeTabId) {
          const activeTab = document.getElementById(activeTabId);
          if (activeTab) new bootstrap.Tab(activeTab).show();
        }

        // **FIX**: Attach back button event listener after DOM is ready
        const backBtn = document.getElementById('backBtn');
        if (backBtn) {
          backBtn.addEventListener('click', () => {
            document.getElementById('pumpListView').classList.remove('hidden');
            document.getElementById('pumpDetailView').classList.add('hidden');
          });
        }
        loadPumpsForPaymentDropdown(user.uid);
        loadFuelPayments(user.uid);
      }
    });

    // Load pumps into the payment dropdown
    function loadPumpsForPaymentDropdown(uid) {
      const pumpRef = ref(db, `users/${uid}/petrolPumps`);
      const select = document.getElementById('fuelPaymentPumpSelect');
      onValue(pumpRef, (snapshot) => {
        select.innerHTML = '<option value="">Select a Pump</option>';
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const pump = child.val();
            const option = document.createElement('option');
            option.value = pump.name;
            option.textContent = pump.name;
            select.appendChild(option);
          });
        }
      });
    }

    // Handle fuel payment form submission
    document.getElementById('fuelPaymentForm').addEventListener('submit', (e) => {
      e.preventDefault();
      if (!currentUser) return;

      const saveButton = document.querySelector('#fuelPaymentForm button[type="submit"]');
      const paymentData = {
        pumpName: document.getElementById('fuelPaymentPumpSelect').value,
        amount: parseFloat(document.getElementById('fuelPaymentAmount').value),
        date: document.getElementById('fuelPaymentDate').value,
        mode: document.getElementById('fuelPaymentMode').value,
        remarks: document.getElementById('fuelPaymentRemarks').value,
        createdAt: new Date().toISOString(),
        userId: currentUser.uid
      };

      if (currentEditingPaymentId) {
        // Update existing payment
        update(ref(db, `users/${currentUser.uid}/fuelPayments/${currentEditingPaymentId}`), {
          ...paymentData,
          updatedAt: new Date().toISOString()
        })
        .then(() => {
          alert('Payment updated successfully!');
          currentEditingPaymentId = null; // Reset editing state
          saveButton.innerHTML = '<i class="fas fa-save me-2"></i>Save Payment'; // Reset button text
          e.target.reset();
          loadPumps(currentUser.uid); // Reload pumps to update outstanding balances
        })
        .catch(err => alert('Error updating payment: ' + err.message));
      } else {
        // Add new payment
        push(ref(db, `users/${currentUser.uid}/fuelPayments`), paymentData)
        .then(() => {
          alert('Payment recorded successfully!');
          e.target.reset();
          loadPumps(currentUser.uid); // Reload pumps to update outstanding balances
        })
        .catch(err => alert('Error saving payment: ' + err.message));
      }
    });

    // Load fuel payments into the table
    function loadFuelPayments(uid) {
      const paymentsRef = query(ref(db, `users/${uid}/fuelPayments`), orderByChild('date'));
      onValue(paymentsRef, (snapshot) => {
        fuelPaymentsTable.clear();
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const p = child.val();
            fuelPaymentsTable.row.add([
              p.date,
              p.pumpName,
              `₹${p.amount.toFixed(2)}`,
              p.mode,
              p.remarks || '-',
              `<div class="text-center">
                <button class="btn btn-sm btn-outline-secondary me-1" onclick="editFuelPayment('${child.key}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteFuelPayment('${child.key}')"><i class="fas fa-trash"></i></button>
              </div>`
            ]);
          });
        }
        fuelPaymentsTable.draw();
      });
    }

    // Add Pump
    document.getElementById("pumpForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) return;

      const newPumpName = document.getElementById("pumpName").value.trim();
      if (!newPumpName) {
        alert('Pump name cannot be empty.');
        return;
      }

      // Check for duplicates
      const pumpRef = ref(db, `users/${currentUser.uid}/petrolPumps`);
      const snapshot = await get(pumpRef);
      let isDuplicate = false;
      if (snapshot.exists()) {
        snapshot.forEach(childSnapshot => {
          if (childSnapshot.val().name.toLowerCase() === newPumpName.toLowerCase()) {
            isDuplicate = true;
          }
        });
      }

      if (isDuplicate) {
        alert('A pump with this name already exists.');
        return;
      }

      const pumpData = {
        name: newPumpName,
        place: document.getElementById("pumpPlace").value,
        contact: document.getElementById("pumpContact").value,
        email: document.getElementById("pumpEmail").value,
        gstin: document.getElementById("pumpGstin").value,
        createdAt: new Date().toISOString()
      };

      push(pumpRef, pumpData)
        .then(() => {
          e.target.reset();
          alert('Petrol pump added successfully!');
        })
        .catch((error) => {
          alert('Error adding pump: ' + error.message);
        });
    });

    // Load Pumps
    function loadPumps(uid) {
      // First, fetch all LR reports to calculate totals
      const lrReportsPromise = get(query(ref(db, 'lrReports'), orderByChild('userId'), equalTo(uid)));
      const paymentsPromise = get(query(ref(db, `users/${uid}/fuelPayments`)));

      Promise.all([lrReportsPromise, paymentsPromise]).then(([lrSnapshot, paymentSnapshot]) => {
          const pumpTotals = {};
          const pumpPayments = {};

          // Aggregate total spent from LR reports
          if (lrSnapshot.exists()) {
            lrSnapshot.forEach(lrChild => {
              const lr = lrChild.val();
              if (lr.dieselPumpName && lr.dieselExpenses > 0) {
                if (!pumpTotals[lr.dieselPumpName]) {
                  pumpTotals[lr.dieselPumpName] = { totalSpent: 0, totalLiters: 0 };
                }
                pumpTotals[lr.dieselPumpName].totalSpent += parseFloat(lr.dieselExpenses);
                pumpTotals[lr.dieselPumpName].totalLiters += parseFloat(lr.dieselLiters || 0);
              }
            });
          }

          // Aggregate total paid from fuel payments
          if (paymentSnapshot.exists()) {
              paymentSnapshot.forEach(paymentChild => {
                  const payment = paymentChild.val();
                  if (payment.pumpName && payment.amount > 0) {
                      pumpPayments[payment.pumpName] = (pumpPayments[payment.pumpName] || 0) + parseFloat(payment.amount);
                  }
              });
          }

          // Now, load the pumps and display them with the calculated totals
          const pumpRef = ref(db, `users/${uid}/petrolPumps`);
          onValue(pumpRef, (pumpSnapshot) => {
            pumpTable.clear();
            if (pumpSnapshot.exists()) {
              pumpSnapshot.forEach(child => {
                const pump = child.val();
                const totalBilled = pumpTotals[pump.name]?.totalSpent || 0;
                const totalPaid = pumpPayments[pump.name] || 0;
                const outstanding = totalBilled - totalPaid;

                pumpTable.row.add([
                  pump.name,
                  pump.place || "-",
                  pump.contact || "-",
                  pump.gstin || "-",
                  `₹${totalBilled.toFixed(2)}`,
                  `<span class="text-success">₹${totalPaid.toFixed(2)}</span>`,
                  `<span class="fw-bold ${outstanding > 0 ? 'text-danger' : 'text-success'}">₹${outstanding.toFixed(2)}</span>`,
                  `<div class="text-center">
                  <button class="btn btn-sm btn-outline-primary me-1" onclick="viewPump('${child.key}')" title="View Details"><i class="fas fa-eye"></i></button>
                  <button class="btn btn-sm btn-outline-secondary me-1" onclick="editPump('${child.key}', '${pump.name}', '${pump.place || ''}', '${pump.contact || ''}', '${pump.email || ''}', '${pump.gstin || ''}')" title="Edit"><i class="fas fa-edit"></i></button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deletePump('${child.key}')" title="Delete"><i class="fas fa-trash"></i></button>
                </div>`
              ]).node().id = `pump-row-${child.key}`;
            });
          }
            pumpTable.draw();
          });
        }).catch(error => {
          console.error("Error fetching data for pump totals:", error);
          alert("Could not calculate pump totals due to a data loading error.");
        });
    }
    
    // View Pump Details
    window.viewPump = async (pumpId) => {
      document.getElementById('pumpListView').classList.add('hidden');
      document.getElementById('pumpDetailView').classList.remove('hidden');

      const pumpRef = ref(db, `users/${currentUser.uid}/petrolPumps/${pumpId}`);
      const pumpSnap = await get(pumpRef);
      if (!pumpSnap.exists()) return;
      const pump = pumpSnap.val();

      document.getElementById('pumpTitle').textContent = pump.name;
      document.getElementById('pumpDetailContact').textContent = pump.contact || '-';
      document.getElementById('pumpDetailGSTIN').textContent = pump.gstin || '-';
      document.getElementById('pumpDetailEmail').textContent = pump.email || '-';

      // Fetch and display transactions
      const lrQuery = get(query(ref(db, 'lrReports'), orderByChild('userId'), equalTo(currentUser.uid)));
      const paymentQuery = get(query(ref(db, `users/${currentUser.uid}/fuelPayments`), orderByChild('pumpName'), equalTo(pump.name)));

      const [lrSnap, paymentSnap] = await Promise.all([lrQuery, paymentQuery]);

        transactionTable.clear();
        let totalSpent = 0, totalLiters = 0, totalPaid = 0;

        if (lrSnap.exists()) {
            lrSnap.forEach(child => {
                const lr = child.val();
                // **FIX**: Filter for the correct pump name on the client-side
                if (lr.dieselPumpName === pump.name) {
                    totalSpent += parseFloat(lr.dieselExpenses || 0);
                    totalLiters += parseFloat(lr.dieselLiters || 0);
                    transactionTable.row.add([
                        lr.date,
                        lr.lrNumber,
                        lr.truckNumber,
                        (lr.dieselLiters || 0).toFixed(2),
                        `₹${(lr.dieselPerLiter || 0).toFixed(2)}`,
                        `₹${(lr.dieselExpenses || 0).toFixed(2)}`
                    ]);
                }
            });
        }

        if (paymentSnap.exists()) {
            paymentSnap.forEach(child => {
                totalPaid += parseFloat(child.val().amount || 0);
            });
        }

      transactionTable.draw();
      document.getElementById('pumpDetailTotalSpent').textContent = `₹${totalSpent.toFixed(2)}`;
      document.getElementById('pumpDetailTotalPaid').textContent = `₹${totalPaid.toFixed(2)}`;
      document.getElementById('pumpDetailOutstanding').textContent = `₹${(totalSpent - totalPaid).toFixed(2)}`;
      document.getElementById('pumpDetailTotalLiters').textContent = `${totalLiters.toFixed(2)} L`;
    };

    // Edit Pump
    window.editPump = (id, name, place, contact, email, gstin) => {
      const newName = prompt("Enter new pump name:", name);
      if (!newName) return;
      const newPlace = prompt("Enter new place:", place);
      const newContact = prompt("Enter new contact number:", contact);
      const newEmail = prompt("Enter new email:", email);
      const newGstin = prompt("Enter new GSTIN:", gstin);

      update(ref(db, `users/${currentUser.uid}/petrolPumps/${id}`), {
        name: newName,
        place: newPlace,
        contact: newContact,
        email: newEmail,
        gstin: newGstin,
        updatedAt: new Date().toISOString()
      }).then(() => alert('Pump details updated.'))
        .catch(err => alert('Update failed: ' + err.message));
    };

    // Delete Pump
    window.deletePump = (id) => {
      if (confirm("Are you sure you want to delete this petrol pump?")) {
        remove(ref(db, `users/${currentUser.uid}/petrolPumps/${id}`))
          .then(() => alert('Pump deleted.'))
          .catch(err => alert('Deletion failed: ' + err.message));
      }
    };

    // Export to Excel
    document.getElementById("exportExcel").addEventListener("click", () => {
      const table = document.getElementById("pumpTable");
      // Create a clone to remove the "Actions" column before exporting
      const tableClone = table.cloneNode(true);
      Array.from(tableClone.rows).forEach(row => {
        row.deleteCell(-1); // Delete the last cell (Actions)
      });
      const wb = XLSX.utils.table_to_book(tableClone, { sheet: "PetrolPumps" });
      XLSX.writeFile(wb, "PetrolPumps.xlsx");
    });

    // Edit a fuel payment
    window.editFuelPayment = async (paymentId) => {
      const paymentRef = ref(db, `users/${currentUser.uid}/fuelPayments/${paymentId}`);
      const snapshot = await get(paymentRef);
      if (!snapshot.exists()) {
        alert('Payment record not found.');
        return;
      }
      const p = snapshot.val();
      currentEditingPaymentId = paymentId; // Set the ID of the payment being edited

      document.getElementById('fuelPaymentPumpSelect').value = p.pumpName;
      document.getElementById('fuelPaymentAmount').value = p.amount;
      document.getElementById('fuelPaymentDate').value = p.date;
      document.getElementById('fuelPaymentMode').value = p.mode;
      document.getElementById('fuelPaymentRemarks').value = p.remarks;

      document.querySelector('#fuelPaymentForm button[type="submit"]').innerHTML = '<i class="fas fa-save me-2"></i>Update Payment';
      document.getElementById('fuelPaymentForm').scrollIntoView({ behavior: 'smooth' });
    };

    // Delete a fuel payment
    window.deleteFuelPayment = (paymentId) => {
      if (confirm('Are you sure you want to delete this payment record?')) {
        remove(ref(db, `users/${currentUser.uid}/fuelPayments/${paymentId}`))
          .then(() => {
            alert('Payment record deleted.');
            loadPumps(currentUser.uid); // Reload pumps to update outstanding balances
          })
          .catch(err => alert('Deletion failed: ' + err.message));
      }
    };

    // Make functions globally accessible for onclick attributes
    window.viewPump = viewPump;
    window.editPump = editPump;
    window.deletePump = deletePump;
    window.editFuelPayment = editFuelPayment;
    window.deleteFuelPayment = deleteFuelPayment;
</script>
</body>
</html>
