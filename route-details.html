<!DOCTYPE html>
<html lang="en">
<head>
<!-- ðŸ” Secure .env Configuration Loader -->
    <script src="env-config-loader.js"></script>



  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fuel Management - Transport System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <!-- Load secure configuration first -->
  
  

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { padding: 0; margin: 0; background-color: #f8f9fa; }
    .main-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .form-section {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #dee2e6;
    }
    .nav-tabs .nav-link.active {
      background-color: #2E8B57;
      color: white;
      border-color: #2E8B57;
    }
    .nav-tabs .nav-link {
      color: #2E8B57;
    }
    .hidden {
      display: none !important;
    }
    .payment-type-badge {
      display: inline-block;
      padding: .35em .65em;
      font-size: .75em;
      font-weight: 700;
      line-height: 1;
      color: #fff;
      text-align: center;
      white-space: nowrap;
      vertical-align: baseline;
      border-radius: .25rem;
    }
    .payment-type-cash {
      background-color: #28a745;
    }
    .payment-type-upi {
      background-color: #007bff;
    }
    .payment-type-cheque {
      background-color: #6f42c1;
    }
    .payment-type-other {
      background-color: #6c757d;
    }
  </style>
</head>
<body>
  <script src="navbar-loader.js"></script>

  <div class="container mt-4">
    <div class="main-content">
      <div id="pumpListView">
        <h2 class="mb-4"><i class="fas fa-gas-pump me-2"></i>Fuel Management</h2>

      <ul class="nav nav-tabs" id="fuelTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="pumps-tab" data-bs-toggle="tab" data-bs-target="#pumps" type="button" role="tab" aria-controls="pumps" aria-selected="true">
            <i class="fas fa-gas-pump me-1"></i> Manage Pumps
          </button>
        </li>
      </ul>

      <div class="tab-content" id="fuelTabsContent">
        <div class="tab-pane fade show active p-3" id="pumps" role="tabpanel" aria-labelledby="pumps-tab">
          <form id="pumpForm" class="form-section">
            <h4 class="mb-3">Add New Pump</h4>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="pumpName" class="form-label">Pump Name <span class="text-danger">*</span></label>
                <input type="text" id="pumpName" class="form-control" placeholder="Unique Pump Name" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="pumpPlace" class="form-label">Place / Location <span class="text-danger">*</span></label>
                <input type="text" id="pumpPlace" class="form-control" placeholder="City, State" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="pumpContact" class="form-label">Contact Number</label>
                <input type="tel" id="pumpContact" class="form-control" placeholder="Mobile Number">
              </div>
              <div class="col-md-4 mb-3">
                <label for="pumpEmail" class="form-label">Email</label>
                <input type="email" id="pumpEmail" class="form-control" placeholder="Email Address">
              </div>
              <div class="col-md-4 mb-3">
                <label for="pumpGstin" class="form-label">GSTIN</label>
                <input type="text" id="pumpGstin" class="form-control" placeholder="GST Identification Number">
              </div>
            </div>
            <button type="submit" class="btn btn-primary"><i class="fas fa-plus me-2"></i>Add Pump</button>
          </form>

          <div class="d-flex justify-content-between align-items-center my-4">
            <h4 class="mb-0">Pump List</h4>
            <div class="d-flex gap-2 align-items-center">
              <button id="exportExcel" class="btn btn-success"><i class="fas fa-file-excel me-2"></i>Export</button>
            </div>
          </div>

          <div class="table-responsive">
            <table id="pumpTable" class="table table-striped table-bordered" style="width:100%">
              <thead>
                <tr>
                  <th>Pump Name</th>
                  <th>Place</th>
                  <th>Contact</th>
                  <th>GSTIN</th>
                  <th class="text-end">Total Billed (â‚¹)</th>
                  <th class="text-end">Total Paid (â‚¹)</th>
                  <th class="text-end">Outstanding (â‚¹)</th>
                  <th class="text-end">Total Liters (L)</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody id="pumpTableBody"></tbody>
            </table>
          </div>
        </div>

      </div>
    </div>

      <div id="pumpDetailView" class="hidden">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 id="pumpTitle" class="mb-0">Pump Details</h2>
          <button class="btn btn-secondary" id="backBtn"><i class="fas fa-arrow-left me-2"></i>Back to List</button>
        </div>

        <div class="card mb-4">
          <div class="card-body">
            <div class="row">
              <div class="col-md-4"><strong>Contact:</strong> <span id="pumpDetailContact"></span></div>
              <div class="col-md-4"><strong>GSTIN:</strong> <span id="pumpDetailGSTIN"></span></div>
              <div class="col-md-4"><strong>Email:</strong> <span id="pumpDetailEmail"></span></div>
            </div>
            <hr>
            <div class="row">
              <div class="col-md-3"><strong>Total Billed:</strong> <span id="pumpDetailTotalSpent" class="fw-bold text-danger"></span></div>
              <div class="col-md-3"><strong>Total Liters:</strong> <span id="pumpDetailTotalLiters" class="fw-bold"></span></div>
              <div class="col-md-3"><strong>Total Paid:</strong> <span id="pumpDetailTotalPaid" class="fw-bold text-success"></span></div>
              <div class="col-md-3"><strong>Outstanding:</strong> <span id="pumpDetailOutstanding" class="fw-bold text-warning"></span></div>
            </div>
          </div>
        </div>

        <!-- Add Payment Form -->
        <form id="pumpPaymentForm" class="form-section">
          <h4 class="mb-3">Add/Edit Payment</h4>
          <input type="hidden" id="paymentPumpIdHidden">
          <input type="hidden" id="paymentIdHidden">
          <div class="row">
            <div class="col-md-3 mb-3">
              <label for="paymentAmount" class="form-label">Amount (â‚¹) <span class="text-danger">*</span></label>
              <input type="number" id="paymentAmount" class="form-control" required step="0.01">
            </div>
            <div class="col-md-3 mb-3">
              <label for="paymentDate" class="form-label">Date <span class="text-danger">*</span></label>
              <input type="date" id="paymentDate" class="form-control" required>
            </div>
            <div class="col-md-3 mb-3">
              <label for="paymentType" class="form-label">Payment Type <span class="text-danger">*</span></label>
              <select id="paymentType" class="form-control" required>
                <option value="">Select Type</option>
                <option value="cash">Cash</option>
                <option value="upi">UPI</option>
                <option value="cheque">Cheque</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="col-md-3 mb-3">
              <label for="paymentRemark" class="form-label">Remark</label>
              <input type="text" id="paymentRemark" class="form-control" placeholder="Add remark">
            </div>
          </div>
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-success"><i class="fas fa-save me-2"></i>Save Payment</button>
            <button type="button" id="cancelPaymentBtn" class="btn btn-secondary" style="display: none;">
              <i class="fas fa-times me-2"></i>Cancel
            </button>
          </div>
        </form>

        <ul class="nav nav-tabs mt-4" id="detailTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payments" type="button" role="tab">Payments</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions" type="button" role="tab">Transaction History</button>
          </li>
        </ul>

        <div class="tab-content" id="detailTabsContent">
          <div class="tab-pane fade show active p-3" id="payments" role="tabpanel">
            <div class="table-responsive">
              <table id="pumpPaymentTable" class="table table-striped table-bordered" style="width:100%">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Amount (â‚¹)</th>
                    <th>Type</th>
                    <th>Remark</th>
                    <th class="text-center">Actions</th>
                  </tr>
                </thead>
                <tbody id="pumpPaymentTableBody"></tbody>
              </table>
            </div>
          </div>
          <div class="tab-pane fade p-3" id="transactions" role="tabpanel">
            <div class="table-responsive">
              <table id="pumpTransactionTable" class="table table-striped table-bordered" style="width:100%">
                <thead>
                  <tr><th>Date</th><th>LR No.</th><th>Vehicle No.</th><th class="text-end">Liters</th><th class="text-end">Price/Liter</th><th class="text-end">Total Amount (â‚¹)</th></tr>
                </thead>
                <tbody id="pumpTransactionTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, push, onValue, update, remove, get, query, orderByChild, equalTo, set } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Config
    // Load Firebase configuration securely from EVM
    let firebaseConfig;
    
    try {
      // Get Firebase configuration from secure EVM system
      // Initialize Firebase with proper error handling
    try {
        if (!window.FIREBASE_CONFIG) {
            throw new Error('Firebase configuration not loaded. Please ensure evm.js is loaded first.');
        }
        
        if (!window.FIREBASE_CONFIG.databaseURL) {
            throw new Error('Firebase databaseURL not found in configuration.');
        }
        
        if (!window.FIREBASE_CONFIG.projectId) {
            throw new Error('Firebase projectId not found in configuration.');
        }
        
        firebaseConfig = window.FIREBASE_CONFIG;
        
        // Check if we're using fallback values
        if (false) { // Condition is always false in the final logic, keeping as per original structure
            
        } else {
            
            
            
        }
    } catch (error) {
        console.error('âŒ Failed to load Firebase configuration:', error);
        
        // Use fallback configuration to prevent complete failure
        firebaseConfig = {
            apiKey: "AIzaSyDAlk_K8p8Of8Ne6Jpcl2QqXTtm95NgG7o",
            authDomain: "transport-dashboard-ad69a.firebaseapp.com",
            databaseURL: "https://transport-dashboard-ad69a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "transport-dashboard-ad69a",
            storageBucket: "transport-dashboard-ad69a.appspot.com",
            messagingSenderId: "526889676196",
            appId: "1:526889676196:web:66032c80a4aede690ae531",
            measurementId: "G-7F9R7HJYDH"
        };
        
    }} catch (error) {
      console.error('âŒ Failed to load Firebase configuration:', error);
      
      // Use fallback configuration to prevent complete failure
      firebaseConfig = window.FIREBASE_CONFIG;
    }

    const app = initializeApp(window.FIREBASE_CONFIG);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let pumpTable;
    let currentUser = null;
    let transactionTable;
    let paymentTable;
    let currentViewingPumpId = null;
    let currentViewingPumpName = null;
    let currentEditingPumpId = null;
    let coreAccountId = null; 
    let allPumpTransactions = [];
    let allPumps = [];
    let allPumpPayments = [];
    let currentEditingPaymentId = null;


    // Save active tab
    const fuelTabs = document.querySelectorAll('#fuelTabs button');
    fuelTabs.forEach(tab => {
      tab.addEventListener('shown.bs.tab', event => localStorage.setItem('activeFuelTab', event.target.id));
    });

    // Auth Check
    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        currentUser = user;

        // Determine the core account ID to fetch shared data
        const userRef = ref(db, `users/${user.uid}`);
        get(userRef).then(snapshot => {
          if (snapshot.exists()) {
            const userData = snapshot.val();
            coreAccountId = userData.coreAccountId || user.uid;
          } else {
            coreAccountId = user.uid;
          }

          // Initialize tables
          pumpTable = $('#pumpTable').DataTable({
            "pageLength": 10,
            "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
            "columnDefs": [{ "orderable": false, "targets": 7 }, { "className": "text-end", "targets": [4, 5, 6, 7] }],
            "order": [[ 4, "desc" ]] 
          });

          transactionTable = $('#pumpTransactionTable').DataTable({
            "pageLength": 10,
            "order": [[ 0, "desc" ]] 
          });
          
          paymentTable = $('#pumpPaymentTable').DataTable({
            "pageLength": 10,
            "order": [[ 0, "desc" ]]
          });
          
          loadPumps(user.uid);
          loadAllPumpData(coreAccountId, user.uid); // **NEW**: Load all data needed for calculations
        });

        // Restore active tab
        const activeTabId = localStorage.getItem('activeFuelTab');
        if (activeTabId) {
          const activeTab = document.getElementById(activeTabId);
          if (activeTab) new bootstrap.Tab(activeTab).show();
        }

        const backBtn = document.getElementById('backBtn');
        if (backBtn) {
          backBtn.addEventListener('click', () => {
            document.getElementById('pumpListView').classList.remove('hidden');
            document.getElementById('pumpDetailView').classList.add('hidden');
          });
        }
        
        // Payment form handling
        document.getElementById('pumpPaymentForm').addEventListener('submit', savePumpPayment);
        document.getElementById('cancelPaymentBtn').addEventListener('click', resetPaymentForm);
        document.getElementById('paymentDate').valueAsDate = new Date();
      }
    });

    function loadAllPumpData(coreId, userId) {
      // Load fuel transactions
      const transactionsRef = ref(db, `users/${coreId}/fuelLogs`); 
      onValue(transactionsRef, (snapshot) => {
        allPumpTransactions = [];
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const tr = child.val();
            // Map the `fuelLogs` structure to what `getPumpTotals` expects for billing/liters
            if (tr.source === 'pump-fillup' || tr.source === 'manual') {
              const pump = getPump(tr.pumpId);
              allPumpTransactions.push({
                pumpName: pump ? pump.name : 'Unknown Pump',
                total: tr.totalAmount || 0,
                liters: tr.filledLiters || 0,
                date: tr.date || tr.timestamp.slice(0, 10),
                vehicleNumber: tr.truckNumber || 'N/A',
                perLiter: tr.perLiter || 0,
              });
            }
          });
        }
        // Once data is loaded, re-render the pumps table with correct totals
        loadPumps(userId); 
      });
      
      // Load pump payments
      const paymentsRef = ref(db, `users/${userId}/pumpPayments`);
      onValue(paymentsRef, (snapshot) => {
        allPumpPayments = [];
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            allPumpPayments.push({
              id: child.key,
              ...child.val()
            });
          });
        }
        loadPumps(userId);
      });
      
      // Load Pumps to match names in allPumpTransactions
      const pumpRef = ref(db, `users/${userId}/petrolPumps`);
      onValue(pumpRef, (snapshot) => {
          allPumps = [];
          if (snapshot.exists()) {
              snapshot.forEach(child => allPumps.push({ id: child.key, ...child.val() }));
          }
      });
    }
    
    // Helper to get pump details
    function getPump(pumpId) {
        return allPumps.find(p => p.id === pumpId);
    }

    // Helper to get pump payments
    function getPumpPayments(pumpId) {
      return allPumpPayments.filter(p => p.pumpId === pumpId);
    }

    // **NEW**: Helper function to calculate totals for a given pump name
    function getPumpTotals(pumpName, pumpId) {
      const transactions = allPumpTransactions.filter(t => t.pumpName === pumpName);
      const payments = getPumpPayments(pumpId);

      const totalBilled = transactions.reduce((sum, t) => sum + (parseFloat(t.total) || 0), 0);
      const totalLiters = transactions.reduce((sum, t) => sum + (parseFloat(t.liters) || 0), 0);
      const totalPaid = payments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
      const outstanding = totalBilled - totalPaid;

      return {
        totalBilled,
        totalLiters,
        totalPaid,
        outstanding
      };
    }

    // Add Pump
    document.getElementById("pumpForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) return;

      const newPumpName = document.getElementById("pumpName").value.trim();
      if (!newPumpName) {
        alert('Pump name cannot be empty.');
        return;
      }

      const pumpData = {
        name: newPumpName,
        place: document.getElementById("pumpPlace").value,
        contact: document.getElementById("pumpContact").value,
        email: document.getElementById("pumpEmail").value,
        gstin: document.getElementById("pumpGstin").value,
        createdAt: new Date().toISOString()
      };

      const pumpRef = ref(db, `users/${currentUser.uid}/petrolPumps`);
      push(pumpRef, pumpData)
        .then(() => {
          e.target.reset();
          alert('Petrol pump added successfully!');
        })
        .catch((error) => {
          alert('Error adding pump: ' + error.message);
        });
    });

    // Load Pumps
    function loadPumps(uid) {
      const pumpRef = ref(db, `users/${uid}/petrolPumps`);
      onValue(pumpRef, (snapshot) => {
        pumpTable.clear();
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const pumpId = child.key;
            const pump = child.val();
            const totals = getPumpTotals(pump.name, pumpId);

            pumpTable.row.add([
              pump.name,
              pump.place || "-",
              pump.contact || "-",
              pump.gstin || "-",
              `â‚¹${totals.totalBilled.toFixed(2)}`,
              `<span class="text-success">â‚¹${totals.totalPaid.toFixed(2)}</span>`,
              `<span class="fw-bold ${totals.outstanding > 0 ? 'text-danger' : 'text-success'}">â‚¹${totals.outstanding.toFixed(2)}</span>`,
              `${totals.totalLiters.toFixed(2)} L`,
              `<div class="text-center">
                <button class="btn btn-sm btn-outline-primary me-1" onclick="viewPump('${child.key}')" title="View Details"><i class="fas fa-eye"></i></button>
                <button class="btn btn-sm btn-outline-secondary me-1" onclick="editPump('${child.key}')" title="Edit"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-outline-danger" onclick="deletePump('${child.key}')" title="Delete"><i class="fas fa-trash"></i></button>
              </div>`
            ]).node().id = `pump-row-${child.key}`;
          });
        }
        pumpTable.draw();
      });
    }
    
    // View Pump Details
    window.viewPump = async (pumpId) => {
      document.getElementById('pumpListView').classList.add('hidden');
      document.getElementById('pumpDetailView').classList.remove('hidden');

      currentViewingPumpId = pumpId;

      const pumpRef = ref(db, `users/${currentUser.uid}/petrolPumps/${pumpId}`);
      const pumpSnap = await get(pumpRef);
      if (!pumpSnap.exists()) return;
      const pump = pumpSnap.val();
      currentViewingPumpName = pump.name;

      document.getElementById('pumpTitle').textContent = pump.name;
      document.getElementById('pumpDetailContact').textContent = pump.contact || '-';
      document.getElementById('pumpDetailGSTIN').textContent = pump.gstin || '-';
      document.getElementById('pumpDetailEmail').textContent = pump.email || '-';

      // Calculate and display totals in the detail view
      const totals = getPumpTotals(pump.name, pumpId);
      document.getElementById('pumpDetailTotalSpent').textContent = `â‚¹${totals.totalBilled.toFixed(2)}`;
      document.getElementById('pumpDetailTotalLiters').textContent = `${totals.totalLiters.toFixed(2)} L`;
      document.getElementById('pumpDetailTotalPaid').textContent = `â‚¹${totals.totalPaid.toFixed(2)}`;
      document.getElementById('pumpDetailOutstanding').textContent = `â‚¹${totals.outstanding.toFixed(2)}`;

      // Set pump ID in payment form
      document.getElementById('paymentPumpIdHidden').value = pumpId;

      // Load transactions and payments for this pump
      loadPumpTransactions(pumpId);
      loadPumpPayments(pumpId);
    };

    // Load pump transactions (now using fuelLogs)
    async function loadPumpTransactions(pumpId) {
      if (!pumpId || !coreAccountId) return;

      transactionTable.clear();

      // 1. Get the list of transaction keys from the pump's data.
      const transactionKeysRef = ref(db, `users/${currentUser.uid}/petrolPumps/${pumpId}/transactions`);
      const keysSnap = await get(transactionKeysRef);

      if (!keysSnap.exists()) {
        transactionTable.draw(); // Draw an empty table
        return;
      }

      // 2. Fetch each transaction log using its key.
      const transactionPromises = Object.keys(keysSnap.val()).map(logKey =>
        get(ref(db, `users/${coreAccountId}/fuelLogs/${logKey}`))
      );
      const transactionSnaps = await Promise.all(transactionPromises);

      transactionSnaps.forEach(snap => {
        if (snap.exists()) {
          const tr = snap.val();
          transactionTable.row.add([
            tr.date || (tr.timestamp || '').slice(0, 10),
            tr.lrNumber || '-',
            tr.truckNumber || '-',
            (parseFloat(tr.filledLiters || 0)).toFixed(2),
            `â‚¹${(parseFloat(tr.perLiter || 0)).toFixed(2)}`,
            `â‚¹${(parseFloat(tr.totalAmount || 0)).toFixed(2)}`
          ]);
        }
        transactionTable.draw();
      });
    }

    // Load pump payments
    async function loadPumpPayments(pumpId) {
      if (!pumpId) return;
      
      paymentTable.clear();
      const payments = getPumpPayments(pumpId);
      
      if (payments.length > 0) {
        payments.forEach(payment => {
          const typeClass = `payment-type-${payment.type}`;
          const typeText = payment.type.charAt(0).toUpperCase() + payment.type.slice(1);
          
          paymentTable.row.add([
            payment.date,
            `â‚¹${(parseFloat(payment.amount || 0)).toFixed(2)}`,
            `<span class="payment-type-badge ${typeClass}">${typeText}</span>`,
            payment.remark || '-',
            `<div class="text-center">
              <button class="btn btn-sm btn-outline-secondary me-1" onclick="editPumpPayment('${payment.id}')" title="Edit"><i class="fas fa-edit"></i></button>
              <button class="btn btn-sm btn-outline-danger" onclick="deletePumpPayment('${payment.id}')" title="Delete"><i class="fas fa-trash"></i></button>
            </div>`
          ]);
        });
      }
      paymentTable.draw();
    }

    // Save Pump Payment
    async function savePumpPayment(e) {
      e.preventDefault();
      if (!currentUser) return alert("Please log in to save payments.");
      if (!currentViewingPumpId) return alert("No pump selected. Please view a pump's details first.");

      const paymentData = {
        pumpId: currentViewingPumpId,
        amount: parseFloat(document.getElementById('paymentAmount').value),
        date: document.getElementById('paymentDate').value,
        type: document.getElementById('paymentType').value,
        remark: document.getElementById('paymentRemark').value,
        createdAt: new Date().toISOString()
      };

      if (!paymentData.amount || !paymentData.date || !paymentData.type) {
        alert('Please fill all required fields (Amount, Date, Type).');
        return;
      }

      try {
        if (currentEditingPaymentId) {
          // Update existing payment
          await update(ref(db, `users/${currentUser.uid}/pumpPayments/${currentEditingPaymentId}`), paymentData);
          alert('Payment updated successfully!');
          currentEditingPaymentId = null;
        } else {
          // Add new payment
          await push(ref(db, `users/${currentUser.uid}/pumpPayments`), paymentData);
          alert('Payment saved successfully!');
        }

        resetPaymentForm();
        // Refresh the view
        if (currentViewingPumpId) {
          viewPump(currentViewingPumpId);
        }
      } catch (error) {
        console.error('Error saving payment:', error);
        alert('Error saving payment: ' + error.message);
      }
    }

    // Edit Pump Payment
    window.editPumpPayment = async (paymentId) => {
      const paymentRef = ref(db, `users/${currentUser.uid}/pumpPayments/${paymentId}`);
      const snapshot = await get(paymentRef);
      if (!snapshot.exists()) {
        alert('Payment record not found.');
        return;
      }
      
      const payment = snapshot.val();
      currentEditingPaymentId = paymentId;

      document.getElementById('paymentAmount').value = payment.amount;
      document.getElementById('paymentDate').value = payment.date;
      document.getElementById('paymentType').value = payment.type;
      document.getElementById('paymentRemark').value = payment.remark || '';

      const submitBtn = document.querySelector('#pumpPaymentForm button[type="submit"]');
      submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Update Payment';
      document.getElementById('cancelPaymentBtn').style.display = 'inline-block';

      document.getElementById('pumpPaymentForm').scrollIntoView({ behavior: 'smooth' });
    };

    // Delete Pump Payment
    window.deletePumpPayment = async (paymentId) => {
      if (!confirm("Are you sure you want to delete this payment?")) {
        return;
      }

      try {
        await remove(ref(db, `users/${currentUser.uid}/pumpPayments/${paymentId}`));
        alert('Payment deleted successfully!');
        
        // Refresh the view
        if (currentViewingPumpId) {
          viewPump(currentViewingPumpId);
        }
      } catch (error) {
        console.error('Error deleting payment:', error);
        alert('Failed to delete payment: ' + error.message);
      }
    };

    // Reset Payment Form
    function resetPaymentForm() {
      document.getElementById('pumpPaymentForm').reset();
      document.getElementById('paymentDate').valueAsDate = new Date();
      currentEditingPaymentId = null;
      const submitBtn = document.querySelector('#pumpPaymentForm button[type="submit"]');
      submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Payment';
      document.getElementById('cancelPaymentBtn').style.display = 'none';
    }

    // Edit Pump
    window.editPump = (id) => {
      const pumpRef = ref(db, `users/${currentUser.uid}/petrolPumps/${id}`);
      get(pumpRef).then(snapshot => {
        if (snapshot.exists()) {
          const pump = snapshot.val();
          const newName = prompt("Enter new pump name:", pump.name);
          if (!newName) return;
          const newPlace = prompt("Enter new place:", pump.place || '');
          const newContact = prompt("Enter new contact number:", pump.contact || '');
          const newEmail = prompt("Enter new email:", pump.email || '');
          const newGstin = prompt("Enter new GSTIN:", pump.gstin || '');

          update(pumpRef, {
            name: newName, place: newPlace, contact: newContact, email: newEmail, gstin: newGstin, updatedAt: new Date().toISOString()
          }).then(() => alert('Pump details updated.')).catch(err => alert('Update failed: ' + err.message));
        }
      });
    };

    // Delete Pump
    window.deletePump = (id) => {
      if (confirm("Are you sure you want to delete this petrol pump?")) {
        remove(ref(db, `users/${currentUser.uid}/petrolPumps/${id}`))
          .then(() => alert('Pump deleted.'))
          .catch(err => alert('Deletion failed: ' + err.message));
      }
    };

    // Make functions globally accessible
    window.viewPump = viewPump;
    window.editPump = editPump;
    window.deletePump = deletePump;
    window.editPumpPayment = editPumpPayment;
    window.deletePumpPayment = deletePumpPayment;
  </script>
</body>
</html
