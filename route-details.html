<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fuel Management - Transport System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { padding: 0; margin: 0; background-color: #f8f9fa; }
    .main-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .form-section {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #dee2e6;
    }
    .nav-tabs .nav-link.active {
      background-color: #2E8B57;
      color: white;
      border-color: #2E8B57;
    }
    .nav-tabs .nav-link {
      color: #2E8B57;
    }
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <script src="navbar-loader.js"></script>

  <div class="container mt-4">
    <div class="main-content">
      <div id="pumpListView">
        <h2 class="mb-4"><i class="fas fa-gas-pump me-2"></i>Fuel Management</h2>

      <ul class="nav nav-tabs" id="fuelTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="pumps-tab" data-bs-toggle="tab" data-bs-target="#pumps" type="button" role="tab" aria-controls="pumps" aria-selected="true">
            <i class="fas fa-gas-pump me-1"></i> Manage Pumps
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payments" type="button" role="tab" aria-controls="payments" aria-selected="false">
            <i class="fas fa-money-bill-wave me-1"></i> Fuel Payments
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="vehicle-fuel-tab" data-bs-toggle="tab" data-bs-target="#vehicle-fuel" type="button" role="tab" aria-controls="vehicle-fuel" aria-selected="false">
            <i class="fas fa-truck me-1"></i> Vehicle Fuel
          </button>
        </li>
      </ul>

      <div class="tab-content" id="fuelTabsContent">
        <div class="tab-pane fade show active p-3" id="pumps" role="tabpanel" aria-labelledby="pumps-tab">
          <form id="pumpForm" class="form-section">
            <h4 class="mb-3">Add New Pump</h4>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="pumpName" class="form-label">Pump Name <span class="text-danger">*</span></label>
                <input type="text" id="pumpName" class="form-control" placeholder="Unique Pump Name" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="pumpPlace" class="form-label">Place / Location <span class="text-danger">*</span></label>
                <input type="text" id="pumpPlace" class="form-control" placeholder="City, State" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="pumpContact" class="form-label">Contact Number</label>
                <input type="tel" id="pumpContact" class="form-control" placeholder="Mobile Number">
              </div>
              <div class="col-md-4 mb-3">
                <label for="pumpEmail" class="form-label">Email</label>
                <input type="email" id="pumpEmail" class="form-control" placeholder="Email Address">
              </div>
              <div class="col-md-4 mb-3">
                <label for="pumpGstin" class="form-label">GSTIN</label>
                <input type="text" id="pumpGstin" class="form-control" placeholder="GST Identification Number">
              </div>
            </div>
            <button type="submit" class="btn btn-primary"><i class="fas fa-plus me-2"></i>Add Pump</button>
          </form>

          <div class="d-flex justify-content-between align-items-center my-4">
            <h4 class="mb-0">Pump List</h4>
            <div class="d-flex gap-2 align-items-center">
              <button id="exportExcel" class="btn btn-success"><i class="fas fa-file-excel me-2"></i>Export</button>
            </div>
          </div>

          <div class="table-responsive">
            <table id="pumpTable" class="table table-striped table-bordered" style="width:100%">
              <thead>
                <tr>
                  <th>Pump Name</th>
                  <th>Place</th>
                  <th>Contact</th>
                  <th>GSTIN</th>
                  <th class="text-end">Total Billed (₹)</th>
                  <th class="text-end">Total Paid (₹)</th>
                  <th class="text-end">Outstanding (₹)</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody id="pumpTableBody"></tbody>
            </table>
          </div>
        </div>

        <div class="tab-pane fade p-3" id="payments" role="tabpanel" aria-labelledby="payments-tab">
          <form id="fuelPaymentForm" class="form-section">
            <h4 class="mb-3">Record a Fuel Payment</h4>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="fuelPaymentPumpSelect" class="form-label">Select Pump <span class="text-danger">*</span></label>
                <select id="fuelPaymentPumpSelect" class="form-select" required>
                  <option value="">Loading pumps...</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label for="fuelPaymentAmount" class="form-label">Amount (₹) <span class="text-danger">*</span></label>
                <input type="number" id="fuelPaymentAmount" class="form-control" placeholder="Amount Paid" required step="0.01">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="fuelPaymentDate" class="form-label">Payment Date <span class="text-danger">*</span></label>
                <input type="date" id="fuelPaymentDate" class="form-control" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="fuelPaymentMode" class="form-label">Payment Mode</label>
                <select id="fuelPaymentMode" class="form-select">
                  <option value="Cash">Cash</option>
                  <option value="UPI">UPI</option>
                  <option value="Bank Transfer">Bank Transfer</option>
                  <option value="Cheque">Cheque</option>
                </select>
              </div>
            </div>
            <label for="fuelPaymentRemarks" class="form-label">Remarks / Notes</label>
            <textarea id="fuelPaymentRemarks" class="form-control" rows="2" placeholder="e.g., Payment for the month of June"></textarea>
            <button type="submit" class="btn btn-primary mt-3"><i class="fas fa-save me-2"></i>Save Payment</button>
          </form>

          <h4 class="mt-5 mb-3">Payment History</h4>
          <div class="table-responsive">
            <table id="fuelPaymentsTable" class="table table-striped table-bordered" style="width:100%">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Pump Name</th>
                  <th class="text-end">Amount (₹)</th>
                  <th>Mode</th>
                  <th>Remarks</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody id="fuelPaymentsTableBody"></tbody>
            </table>
          </div>
        </div>

        <div class="tab-pane fade p-3" id="vehicle-fuel" role="tabpanel" aria-labelledby="vehicle-fuel-tab">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0"><i class="fas fa-truck me-2"></i>Vehicle Fuel</h4>
            <div class="d-flex gap-2">
              <input type="text" id="vehicleFuelSearch" class="form-control form-control-sm" placeholder="Search vehicle..." style="max-width: 220px;">
              <button class="btn btn-sm btn-outline-secondary" id="refreshVehicleFuel"><i class="fas fa-rotate"></i></button>
            </div>
          </div>
          
          <div id="vehicleFuelCards" class="row g-3"></div>
        </div>
        <div class="modal fade" id="vfLogsModal" tabindex="-1" aria-labelledby="vfLogsModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header bg-light">
                <h5 class="modal-title" id="vfLogsModalLabel">Fuel Log</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="table-responsive">
                  <table class="table table-sm table-striped table-bordered mb-0">
                    <thead>
                      <tr>
                        <th>Vehicle</th>
                        <th>Date</th>
                        <th>Pump</th>
                        <th class="text-end">Liters</th>
                        <th class="text-end">Price/L</th>
                        <th class="text-end">Total (₹)</th>
                        <th>Details</th>
                      </tr>
                    </thead>
                    <tbody id="vfLogsTableBody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

      <div id="pumpDetailView" class="hidden">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 id="pumpTitle" class="mb-0">Pump Details</h2>
          <button class="btn btn-secondary" id="backBtn"><i class="fas fa-arrow-left me-2"></i>Back to List</button>
        </div>

        <div class="card mb-4">
          <div class="card-body">
            <div class="row">
              <div class="col-md-4"><strong>Contact:</strong> <span id="pumpDetailContact"></span></div>
              <div class="col-md-4"><strong>GSTIN:</strong> <span id="pumpDetailGSTIN"></span></div>
              <div class="col-md-4"><strong>Email:</strong> <span id="pumpDetailEmail"></span></div>
            </div>
            <hr>
            <div class="row">
              <div class="col-md-3"><strong>Total Billed:</strong> <span id="pumpDetailTotalSpent" class="fw-bold text-danger"></span></div>
              <div class="col-md-3"><strong>Total Paid:</strong> <span id="pumpDetailTotalPaid" class="fw-bold text-success"></span></div>
              <div class="col-md-3"><strong>Outstanding:</strong> <span id="pumpDetailOutstanding" class="fw-bold text-warning"></span></div>
              <div class="col-md-3"><strong>Total Liters:</strong> <span id="pumpDetailTotalLiters" class="fw-bold"></span></div>
            </div>
          </div>
        </div>

        <ul class="nav nav-tabs mt-4" id="detailTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions" type="button" role="tab">Transaction History</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="payments-history-tab" data-bs-toggle="tab" data-bs-target="#payments-history" type="button" role="tab">Payment History</button>
          </li>
        </ul>

        <div class="tab-content" id="detailTabsContent">
          <div class="tab-pane fade show active p-3" id="transactions" role="tabpanel">
            <div class="table-responsive">
              <table id="pumpTransactionTable" class="table table-striped table-bordered" style="width:100%">
                <thead>
                  <tr><th>Date</th><th>LR No.</th><th>Vehicle No.</th><th class="text-end">Liters</th><th class="text-end">Price/Liter</th><th class="text-end">Total Amount (₹)</th></tr>
                </thead>
                <tbody id="pumpTransactionTableBody"></tbody>
              </table>
            </div>
          </div>
          <div class="tab-pane fade p-3" id="payments-history" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">Payment Filters</h5>
              <div class="d-flex align-items-center gap-2 flex-wrap">
                <input type="text" id="paymentHistorySearch" class="form-control form-control-sm" placeholder="Search history..." style="max-width: 200px;">
                <input type="date" id="paymentHistoryStartDate" class="form-control form-control-sm" title="Start Date">
                <input type="date" id="paymentHistoryEndDate" class="form-control form-control-sm" title="End Date">
                <button id="clearPaymentHistoryFiltersBtn" class="btn btn-sm btn-outline-secondary"><i class="fas fa-times me-1"></i>Clear</button>
                <button id="downloadPaymentHistoryBtn" class="btn btn-sm btn-success"><i class="fas fa-file-pdf me-1"></i> Download PDF</button>
              </div>
            </div>
            <div class="table-responsive">
              <table id="pumpPaymentHistoryTable" class="table table-striped table-bordered" style="width:100%">
                <thead>
                  <tr>
                    <th>Date</th><th class="text-end">Amount (₹)</th><th>Mode</th><th>Remarks</th>
                  </tr>
                </thead>
                <tbody id="pumpPaymentHistoryTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, push, onValue, update, remove, get, query, orderByChild, equalTo, set } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Config
    const firebaseConfig = {
      apiKey: "AIzaSyDAlk_K8p8Of8Ne6Jpcl2QqXTtm95NgG7o",
      authDomain: "transport-dashboard-ad69a.firebaseapp.com",
      databaseURL: "https://transport-dashboard-ad69a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "transport-dashboard-ad69a",
      storageBucket: "transport-dashboard-ad69a.appspot.com",
      messagingSenderId: "526889676196",
      appId: "1:526889676196:web:66032c80a4aede690ae531",
      measurementId: "G-7F9R7HJYDH"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let pumpTable;
    let currentUser = null;
    let transactionTable;
    let fuelPaymentsTable;
    let pumpPaymentHistoryTable; 
    let currentViewingPumpId = null;
    let currentViewingPumpName = null;
    let currentEditingPaymentId = null; 
    let coreAccountId = null; 

    // Vehicle Fuel tab state
    let vf_pumpsOptionsHtml = '<option value="">Select Pump</option>';
    let vf_allVehicles = [];
    let allPumpTransactions = [];
    let allFuelPayments = [];

    // Load pump options for Vehicle Fuel tab
    function loadPumpsForVehicleFuel(uid) {
      const pumpRef = ref(db, `users/${uid}/petrolPumps`);
      onValue(pumpRef, (snapshot) => {
        const opts = [];
        opts.push('<option value="">Select Pump</option>');
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const p = child.val();
            if (p && p.name) opts.push(`<option value="${p.name}">${p.name}</option>`);
          });
        }
        vf_pumpsOptionsHtml = opts.join('');
        renderVehicleFuelCards();
      });
    }

    // Load vehicles list for Vehicle Fuel tab
    function loadVehiclesForFuel() {
      if (!coreAccountId) return;
      const vref = ref(db, `users/${coreAccountId}/vehicles`);
      onValue(vref, (snap) => {
        vf_allVehicles = [];
        if (snap.exists()) {
          snap.forEach(child => {
            const v = child.val() || {};
            vf_allVehicles.push({ id: child.key, ...v });
          });
        }
        renderVehicleFuelCards();
      });
    }

    // Helper to get a vehicle's number consistently
    function getVehicleNumber(v) {
      return (v?.vehicleNo || v?.vehicleNumber || v?.number || '').toString();
    }

    // Render vehicle cards
    function renderVehicleFuelCards(filterText = '') {
      const wrap = document.getElementById('vehicleFuelCards');
      if (!wrap) return;
      const q = (filterText || document.getElementById('vehicleFuelSearch')?.value || '').toLowerCase();
      wrap.innerHTML = '';
      vf_allVehicles
        .filter(v => !q || getVehicleNumber(v).toLowerCase().includes(q))
        .sort((a, b) => getVehicleNumber(a).localeCompare(getVehicleNumber(b)))
        .forEach(v => {
          const cur = parseFloat(v.currentFuel) || 0;
          const card = document.createElement('div');
          card.className = 'col-12 col-md-6 col-lg-4';
          card.innerHTML = `
            <div class="card h-100">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h5 class="card-title mb-0"><i class="fas fa-truck me-2"></i>${getVehicleNumber(v) || '(unnamed)'} </h5>
                  <span class="badge bg-secondary">${v.type || 'Vehicle'}</span>
                </div>
                <div class="mb-2"><strong>Current Fuel:</strong> <span id="vf-cur-${v.id}">${cur.toFixed(2)}</span> L</div>
                <div class="row g-2 align-items-end">
                  <div class="col-4">
                    <label class="form-label">Liters</label>
                    <input type="number" class="form-control" id="vf-liters-${v.id}" step="0.01" min="0" placeholder="e.g., 300">
                  </div>
                  <div class="col-4">
                    <label class="form-label">Price/L</label>
                    <input type="number" class="form-control" id="vf-perl-${v.id}" step="0.01" min="0" placeholder="e.g., 95">
                  </div>
                  <div class="col-4">
                    <label class="form-label">Pump</label>
                    <select class="form-select" id="vf-pump-${v.id}">${vf_pumpsOptionsHtml}</select>
                  </div>
                </div>
                <div class="d-flex gap-2 mt-2">
                  <button class="btn btn-outline-primary" onclick="window.vfAddFuel && window.vfAddFuel('${v.id}')"><i class=\"fas fa-plus me-1\"></i>Add Fuel</button>
                  <div class="input-group" style="max-width: 200px;">
                    <input type="number" class="form-control" id="vf-editcur-${v.id}" step="0.01" min="0" placeholder="Set current fuel">
                    <button class="btn btn-outline-secondary" onclick="window.vfSaveCurrent && window.vfSaveCurrent('${v.id}')"><i class=\"fas fa-save\"></i></button>
                  </div>
                  <button class="btn btn-outline-info" onclick="window.vfViewFuel && window.vfViewFuel('${v.id}')"><i class=\"fas fa-list\"></i> View</button>
                </div>
              </div>
            </div>`;
          wrap.appendChild(card);
        });
    }

    /**
     * Adds a fuel entry for a specific vehicle. This function is designed to be robust
     * and secure, performing three distinct database writes and providing clear feedback.
     * 1. Updates the vehicle's current fuel level.
     * 2. Creates a new fuel log entry.
     * 3. Creates a new pump transaction record.
     */
    window.vfAddFuel = async function(vehicleId) {
      const v = vf_allVehicles.find(x => x.id === vehicleId);
      if (!v) {
        alert('Error: Vehicle data not found. Please refresh and try again.');
        return;
      }

      const litersInput = document.getElementById(`vf-liters-${vehicleId}`);
      const perLInput = document.getElementById(`vf-perl-${vehicleId}`);
      const pumpSelect = document.getElementById(`vf-pump-${vehicleId}`);

      const liters = parseFloat(litersInput.value) || 0;
      const perL = parseFloat(perLInput.value) || 0;
      const pumpName = (pumpSelect.value || '').trim();

      if (liters <= 0 || perL <= 0 || !pumpName) {
        alert('Please enter valid Liters, Price/L, and select a Pump.');
        return;
      }

      const totalAmount = liters * perL;
      const vehicleRef = ref(db, `users/${coreAccountId}/vehicles/${vehicleId}`);

      try {
        // --- Step 1: Get current fuel level ---
        const curSnap = await get(vehicleRef);
        const currentData = curSnap.val() || {};
        const before = parseFloat(currentData.currentFuel) || 0;
        const after = before + liters;

        // --- Step 2: Prepare data for all writes ---
        const now = new Date();
        const timestamp = now.toISOString();
        const date = timestamp.split('T')[0];
        const authenticatedUserId = auth.currentUser.uid;

        const fuelLogData = {
          timestamp,
          source: 'vehicle-fuel-tab',
          addedLiters: liters,
          pricePerLiter: perL,
          totalAmount,
          pumpName,
          beforeLiters: before,
          afterLiters: after,
          userId: authenticatedUserId,
          coreAccountId: coreAccountId
        };

        const pumpTransactionData = {
          timestamp,
          date,
          pumpName,
          vehicleId,
          vehicleNumber: getVehicleNumber(v),
          liters,
          perLiter: perL,
          total: totalAmount,
          source: 'vehicle-fuel',
          userId: authenticatedUserId,
          coreAccountId: coreAccountId
        };

        // --- Step 3: Perform all database writes ---
        const fuelLogRef = ref(db, `users/${coreAccountId}/vehicles/${vehicleId}/fuelLogs`);
        const pumpTransRef = ref(db, `users/${coreAccountId}/pumpTransactions`);

        // Use a multi-path update for atomicity where possible, though push needs separate calls.
        // We will perform them sequentially with error checks.
        await update(vehicleRef, { currentFuel: after });
        await push(fuelLogRef, fuelLogData);
        await push(pumpTransRef, pumpTransactionData);

        // --- Step 4: Update UI on success ---
        document.getElementById(`vf-cur-${vehicleId}`).textContent = after.toFixed(2);
        litersInput.value = '';
        perLInput.value = '';
        // Do not reset pump selection, user might add fuel from the same pump again.

        // Optional: Show a temporary success message
        const originalTitle = v.vehicleNumber || '(unnamed)';
        const titleEl = document.querySelector(`#vf-cur-${vehicleId}`).closest('.card-body').querySelector('.card-title');
        if(titleEl) {
          titleEl.innerHTML = `<i class="fas fa-check-circle text-success"></i> Fuel Added!`;
          setTimeout(() => { titleEl.innerHTML = `<i class="fas fa-truck me-2"></i>${originalTitle}`; }, 2000);
        }

      } catch (error) {
        console.error('vfAddFuel error:', error);
        alert(`Failed to add fuel. Please check your permissions and try again.\n\nError: ${error.message}`);
      }
    }

    window.vfSaveCurrent = async function(vehicleId) {
      const inputEl = document.getElementById(`vf-editcur-${vehicleId}`);
      const val = parseFloat(inputEl.value);

      if (isNaN(val) || val < 0) {
        alert('Please enter a valid, non-negative fuel amount.');
        return;
      }

      const vehicleRef = ref(db, `users/${coreAccountId}/vehicles/${vehicleId}`);

      try {
        await update(vehicleRef, { currentFuel: val });

        // Update UI on success
        inputEl.value = '';
        document.getElementById(`vf-cur-${vehicleId}`).textContent = val.toFixed(2);

      } catch (error) {
        console.error('vfSaveCurrent error:', error);
        alert(`Failed to update current fuel. Please check permissions.\n\nError: ${error.message}`);
      }
    }

    // View a vehicle's fuel log
    window.vfViewFuel = async function(vehicleId) {
      const v = vf_allVehicles.find(x => x.id === vehicleId);
      if (!v) {
        alert('Vehicle not found');
        return;
      }

      const modal = new bootstrap.Modal(document.getElementById('vfLogsModal'));
      const modalLabel = document.getElementById('vfLogsModalLabel');
      const tableBody = document.getElementById('vfLogsTableBody');

      modalLabel.textContent = `Fuel Log for ${getVehicleNumber(v)}`;
      tableBody.innerHTML = '<tr><td colspan="7" class="text-center">Loading logs...</td></tr>';
      modal.show();

      const logsRef = query(ref(db, `users/${coreAccountId}/vehicles/${vehicleId}/fuelLogs`), orderByChild('timestamp'));

      try {
        const snap = await get(logsRef);

        if (!snap.exists()) {
          tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No fuel logs found for this vehicle.</td></tr>';
          return;
        }

        const logs = [];
        snap.forEach(child => logs.push(child.val()));
        logs.reverse(); // Sorts from newest to oldest since we ordered by timestamp ascending

        tableBody.innerHTML = '';
        logs.forEach(log => {
          const date = new Date(log.timestamp).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
          let liters = 0;
          let price = 0;
          let total = 0;
          let details = log.source || 'N/A';

          if (log.source === 'vehicle-fuel-tab') {
            liters = `<span class="text-success">+${(log.addedLiters || 0).toFixed(2)}</span>`;
            price = log.pricePerLiter || 0;
            total = log.totalAmount || 0;
            details = `Fuel added`;
          } else if (log.source && log.source.includes('lr-')) {
            liters = `<span class="text-danger">-${(log.usedLiters || log.usedLitersDelta || 0).toFixed(2)}</span>`;
            price = '-';
            total = '-';
            details = `Usage for LR #${log.lrNumber || 'N/A'}`;
          }

          const row = `
            <tr>
              <td>${getVehicleNumber(v)}</td><td>${date}</td><td>${log.pumpName || '-'}</td><td class="text-end">${liters}</td><td class="text-end">${price > 0 ? `₹${price.toFixed(2)}` : price}</td><td class="text-end">${total > 0 ? `₹${total.toFixed(2)}` : total}</td><td>${details}</td>
            </tr>`;
          tableBody.innerHTML += row;
        });
      } catch (error) {
        console.error('vfViewFuel error:', error);
        alert(`Failed to load fuel logs.\n\nError: ${error.message}`);
      }
    }

    // Save active tab
    const fuelTabs = document.querySelectorAll('#fuelTabs button');
    fuelTabs.forEach(tab => {
      tab.addEventListener('shown.bs.tab', event => localStorage.setItem('activeFuelTab', event.target.id));
    });

    // Auth Check
    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        currentUser = user;

        // Determine the core account ID to fetch shared data
        const userRef = ref(db, `users/${user.uid}`);
        get(userRef).then(snapshot => {
          if (snapshot.exists()) {
            const userData = snapshot.val();
            coreAccountId = userData.coreAccountId || user.uid;
          } else {
            coreAccountId = user.uid;
          }

          // Initialize tables
          pumpTable = $('#pumpTable').DataTable({
            "pageLength": 10,
            "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
            "columnDefs": [{ "orderable": false, "targets": 7 }, { "className": "text-end", "targets": [4, 5, 6] }],
            "order": [[ 4, "desc" ]] 
          });

          transactionTable = $('#pumpTransactionTable').DataTable({
            "pageLength": 10,
            "order": [[ 0, "desc" ]] 
          });
          fuelPaymentsTable = $('#fuelPaymentsTable').DataTable({
            "pageLength": 10,
            "order": [[ 0, "desc" ]], 
            "columnDefs": [{ "orderable": false, "targets": 5 }, { "className": "text-end", "targets": 2 }]
          });
          pumpPaymentHistoryTable = $('#pumpPaymentHistoryTable').DataTable({
            "pageLength": 5,
            "order": [[ 0, "desc" ]],
            "dom": "rt" + "<'d-flex justify-content-end pt-2'p>"
          });
          
          loadPumps(user.uid);
          loadPumpsForPaymentDropdown(user.uid); 
          loadFuelPayments(user.uid);
          loadPumpsForVehicleFuel(user.uid);
          loadAllPumpData(coreAccountId, user.uid); // **NEW**: Load all data needed for calculations
          loadVehiclesForFuel();
        });

        // Restore active tab
        const activeTabId = localStorage.getItem('activeFuelTab');
        if (activeTabId) {
          const activeTab = document.getElementById(activeTabId);
          if (activeTab) new bootstrap.Tab(activeTab).show();
        }

        document.getElementById('downloadPaymentHistoryBtn').addEventListener('click', downloadPaymentHistoryPDF);

        const paymentHistorySearchInput = document.getElementById('paymentHistorySearch');
        paymentHistorySearchInput.addEventListener('keyup', function() {
            pumpPaymentHistoryTable.search(this.value).draw();
        });

        const startDateInput = document.getElementById('paymentHistoryStartDate');
        const endDateInput = document.getElementById('paymentHistoryEndDate');

        $.fn.dataTable.ext.search.push(
            function(settings, data, dataIndex) {
                if (settings.nTable.id !== 'pumpPaymentHistoryTable') {
                    return true; 
                }
                const min = startDateInput.value ? new Date(startDateInput.value) : null;
                const max = endDateInput.value ? new Date(endDateInput.value) : null;
                const date = new Date(data[0]); 

                if ((min === null && max === null) || (min === null && date <= max) || (min <= date && max === null) || (min <= date && date <= max)) {
                    return true;
                }
                return false;
            }
        );

        startDateInput.addEventListener('change', () => pumpPaymentHistoryTable.draw());
        endDateInput.addEventListener('change', () => pumpPaymentHistoryTable.draw());

        const clearFiltersBtn = document.getElementById('clearPaymentHistoryFiltersBtn');
        clearFiltersBtn.addEventListener('click', () => {
            startDateInput.value = '';
            endDateInput.value = '';
            paymentHistorySearchInput.value = '';
            pumpPaymentHistoryTable.search('').draw(); 
        });

        const backBtn = document.getElementById('backBtn');
        if (backBtn) {
          backBtn.addEventListener('click', () => {
            document.getElementById('pumpListView').classList.remove('hidden');
            document.getElementById('pumpDetailView').classList.add('hidden');
          });
        }

        // Vehicle Fuel tab events
        const vSearch = document.getElementById('vehicleFuelSearch');
        if (vSearch) vSearch.addEventListener('input', () => renderVehicleFuelCards(vSearch.value));
        const refreshBtn = document.getElementById('refreshVehicleFuel');
        if (refreshBtn) refreshBtn.addEventListener('click', () => { 
          loadVehiclesForFuel(); 
          loadPumpsForVehicleFuel(currentUser.uid);
        });
      }
    });

    // **NEW**: Load all transactions and payments to enable calculations
    function loadAllPumpData(coreId, userId) {
      const transactionsRef = ref(db, `users/${coreId}/pumpTransactions`);
      onValue(transactionsRef, (snapshot) => {
        allPumpTransactions = [];
        if (snapshot.exists()) {
          snapshot.forEach(child => allPumpTransactions.push(child.val()));
        }
        // Once data is loaded, re-render the pumps table with correct totals
        loadPumps(userId); 
      });

      const paymentsRef = ref(db, `users/${userId}/fuelPayments`);
      onValue(paymentsRef, (snapshot) => {
        allFuelPayments = [];
        if (snapshot.exists()) {
          snapshot.forEach(child => allFuelPayments.push({ id: child.key, ...child.val() }));
        }
        // Re-render pumps table when payments change
        loadPumps(userId);
      });
    }

    // **NEW**: Helper function to calculate totals for a given pump name
    function getPumpTotals(pumpName, pumpId) {
      const transactions = allPumpTransactions.filter(t => t.pumpName === pumpName);
      const payments = allFuelPayments.filter(p => p.pumpId === pumpId);

      const totalBilled = transactions.reduce((sum, t) => sum + (parseFloat(t.total) || 0), 0);
      const totalPaid = payments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
      const totalLiters = transactions.reduce((sum, t) => sum + (parseFloat(t.liters) || 0), 0);
      const outstanding = totalBilled - totalPaid;

      return {
        totalBilled,
        totalPaid,
        outstanding,
        totalLiters
      };
    }

    // Load pumps for payment dropdown
    function loadPumpsForPaymentDropdown(uid) {
      const pumpRef = ref(db, `users/${uid}/petrolPumps`);
      const select = document.getElementById('fuelPaymentPumpSelect');
      onValue(pumpRef, (snapshot) => {
        select.innerHTML = '<option value="">Select a Pump</option>';
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const pump = child.val();
            const option = document.createElement('option');
            option.value = child.key;
            option.textContent = pump.name;
            select.appendChild(option);
          });
        }
      });
    }

    // Handle fuel payment form submission
    document.getElementById('fuelPaymentForm').addEventListener('submit', (e) => {
      e.preventDefault();
      if (!currentUser) return;

      const saveButton = document.querySelector('#fuelPaymentForm button[type="submit"]');
      const paymentData = {
        pumpId: document.getElementById('fuelPaymentPumpSelect').value,
        amount: parseFloat(document.getElementById('fuelPaymentAmount').value),
        date: document.getElementById('fuelPaymentDate').value,
        mode: document.getElementById('fuelPaymentMode').value,
        remarks: document.getElementById('fuelPaymentRemarks').value,
        createdAt: new Date().toISOString(),
        userId: currentUser.uid
      };

      if (currentEditingPaymentId) {
        // Update existing payment
        update(ref(db, `users/${currentUser.uid}/fuelPayments/${currentEditingPaymentId}`), {
          ...paymentData,
          updatedAt: new Date().toISOString()
        })
        .then(() => {
          alert('Payment updated successfully!');
          currentEditingPaymentId = null; 
          saveButton.innerHTML = '<i class="fas fa-save me-2"></i>Save Payment'; 
          e.target.reset();
        })
        .catch(err => alert('Error updating payment: ' + err.message));
      } else {
        // Add new payment
        push(ref(db, `users/${currentUser.uid}/fuelPayments`), paymentData)
        .then(() => {
          alert('Payment recorded successfully!');
          e.target.reset();
        })
        .catch(err => alert('Error saving payment: ' + err.message));
      }
    });

    // Load fuel payments into the table
    function loadFuelPayments(uid) {
      const paymentsRef = query(ref(db, `users/${uid}/fuelPayments`), orderByChild('date'));
      onValue(paymentsRef, (snapshot) => {
        fuelPaymentsTable.clear();
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const p = child.val();
            // Get pump name for display
            const pumpRef = ref(db, `users/${uid}/petrolPumps/${p.pumpId}`);
            get(pumpRef).then(pumpSnap => {
              const pumpName = pumpSnap.exists() ? pumpSnap.val().name : 'Unknown Pump';
              
              fuelPaymentsTable.row.add([
                p.date,
                pumpName,
                `₹${p.amount.toFixed(2)}`,
                p.mode,
                p.remarks || '-',
                `<div class="text-center">
                  <button class="btn btn-sm btn-outline-secondary me-1" onclick="editFuelPayment('${child.key}')"><i class="fas fa-edit"></i></button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteFuelPayment('${child.key}')"><i class="fas fa-trash"></i></button>
                </div>`
              ]);
              fuelPaymentsTable.draw();
            });
          });
        }
      });
    }

    // Add Pump
    document.getElementById("pumpForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) return;

      const newPumpName = document.getElementById("pumpName").value.trim();
      if (!newPumpName) {
        alert('Pump name cannot be empty.');
        return;
      }

      const pumpData = {
        name: newPumpName,
        place: document.getElementById("pumpPlace").value,
        contact: document.getElementById("pumpContact").value,
        email: document.getElementById("pumpEmail").value,
        gstin: document.getElementById("pumpGstin").value,
        createdAt: new Date().toISOString()
      };

      const pumpRef = ref(db, `users/${currentUser.uid}/petrolPumps`);
      push(pumpRef, pumpData)
        .then(() => {
          e.target.reset();
          alert('Petrol pump added successfully!');
        })
        .catch((error) => {
          alert('Error adding pump: ' + error.message);
        });
    });

    // Load Pumps
    function loadPumps(uid) {
      const pumpRef = ref(db, `users/${uid}/petrolPumps`);
      onValue(pumpRef, (snapshot) => {
        pumpTable.clear();
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const pumpId = child.key;
            const pump = child.val();
            const totals = getPumpTotals(pump.name, pumpId);

            pumpTable.row.add([
              pump.name,
              pump.place || "-",
              pump.contact || "-",
              pump.gstin || "-",
              `₹${totals.totalBilled.toFixed(2)}`,
              `₹${totals.totalPaid.toFixed(2)}`,
              `<span class="fw-bold ${totals.outstanding > 0 ? 'text-danger' : 'text-success'}">₹${totals.outstanding.toFixed(2)}</span>`,
              `<div class="text-center">
                <button class="btn btn-sm btn-outline-primary me-1" onclick="viewPump('${child.key}')" title="View Details"><i class="fas fa-eye"></i></button>
                <button class="btn btn-sm btn-outline-secondary me-1" onclick="editPump('${child.key}')" title="Edit"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-outline-danger" onclick="deletePump('${child.key}')" title="Delete"><i class="fas fa-trash"></i></button>
              </div>`
            ]).node().id = `pump-row-${child.key}`;
          });
        }
        pumpTable.draw();
      });
    }
    
    // View Pump Details
    window.viewPump = async (pumpId) => {
      document.getElementById('pumpListView').classList.add('hidden');
      document.getElementById('pumpDetailView').classList.remove('hidden');

      currentViewingPumpId = pumpId;

      const pumpRef = ref(db, `users/${currentUser.uid}/petrolPumps/${pumpId}`);
      const pumpSnap = await get(pumpRef);
      if (!pumpSnap.exists()) return;
      const pump = pumpSnap.val();
      currentViewingPumpName = pump.name;

      document.getElementById('pumpTitle').textContent = pump.name;
      document.getElementById('pumpDetailContact').textContent = pump.contact || '-';
      document.getElementById('pumpDetailGSTIN').textContent = pump.gstin || '-';
      document.getElementById('pumpDetailEmail').textContent = pump.email || '-';

      // **FIX**: Calculate and display totals in the detail view
      const totals = getPumpTotals(pump.name, pumpId);
      document.getElementById('pumpDetailTotalSpent').textContent = `₹${totals.totalBilled.toFixed(2)}`;
      document.getElementById('pumpDetailTotalPaid').textContent = `₹${totals.totalPaid.toFixed(2)}`;
      document.getElementById('pumpDetailOutstanding').textContent = `₹${totals.outstanding.toFixed(2)}`;
      document.getElementById('pumpDetailTotalLiters').textContent = `${totals.totalLiters.toFixed(2)} L`;

      // Load transactions and payments for this pump
      loadPumpTransactions(pump.name);
      loadPumpPaymentHistory(pump.name);
    };

    // Load pump transactions
    function loadPumpTransactions(pumpName) {
      const transactionsRef = query(ref(db, `users/${coreAccountId}/pumpTransactions`), orderByChild('pumpName'), equalTo(pumpName));
      onValue(transactionsRef, (snapshot) => {
        transactionTable.clear();
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const tr = child.val();
            transactionTable.row.add([
              tr.date || (tr.timestamp || '').slice(0,10),
              '-',
              tr.vehicleNumber || '-',
              (parseFloat(tr.liters || 0)).toFixed(2),
              `₹${(parseFloat(tr.perLiter || 0)).toFixed(2)}`,
              `₹${(parseFloat(tr.total || 0)).toFixed(2)}`
            ]);
          });
        }
        transactionTable.draw();
      });
    }

    // Load pump payment history
    function loadPumpPaymentHistory(pumpName) {
      const paymentsRef = query(ref(db, `users/${currentUser.uid}/fuelPayments`));
      // **FIX**: Use the pre-loaded `allFuelPayments` data instead of re-fetching
      pumpPaymentHistoryTable.clear();
      const relevantPayments = allFuelPayments.filter(async (payment) => {
        const pumpRef = ref(db, `users/${currentUser.uid}/petrolPumps/${payment.pumpId}`);
        const pumpSnap = await get(pumpRef);
        return pumpSnap.exists() && pumpSnap.val().name === pumpName;
      });

      relevantPayments.forEach(payment => {
        pumpPaymentHistoryTable.row.add([
          payment.date,
          `₹${(payment.amount || 0).toFixed(2)}`,
          payment.mode || '-',
          payment.remarks || '-'
        ]);
      });
      pumpPaymentHistoryTable.draw();
    }

    // Download Payment History as PDF
    async function downloadPaymentHistoryPDF() {
      if (!currentViewingPumpId || !currentViewingPumpName) {
        alert('No pump selected. Please view a pump first.');
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(18);
      doc.text(`Payment History for ${currentViewingPumpName}`, 14, 22);
      doc.setFontSize(11);
      doc.setTextColor(100);
      doc.text(`Report Generated: ${new Date().toLocaleDateString()}`, 14, 30);

      const tableColumn = ["Date", "Amount (₹)", "Mode", "Remarks"];
      const tableRows = [];

      // Get payment data from the table
      const tableData = pumpPaymentHistoryTable.rows().data().toArray();
      tableData.forEach(row => {
        tableRows.push([row[0], row[1].replace('₹', ''), row[2], row[3]]);
      });

      doc.autoTable({
        head: [tableColumn],
        body: tableRows,
        startY: 35
      });

      doc.save(`Payment_History_${currentViewingPumpName}.pdf`);
    }

    // Edit Pump
    window.editPump = (id) => {
      const pumpRef = ref(db, `users/${currentUser.uid}/petrolPumps/${id}`);
      get(pumpRef).then(snapshot => {
        if (snapshot.exists()) {
          const pump = snapshot.val();
          const newName = prompt("Enter new pump name:", pump.name);
          if (!newName) return;
          const newPlace = prompt("Enter new place:", pump.place || '');
          const newContact = prompt("Enter new contact number:", pump.contact || '');
          const newEmail = prompt("Enter new email:", pump.email || '');
          const newGstin = prompt("Enter new GSTIN:", pump.gstin || '');

          update(pumpRef, {
            name: newName, place: newPlace, contact: newContact, email: newEmail, gstin: newGstin, updatedAt: new Date().toISOString()
          }).then(() => alert('Pump details updated.')).catch(err => alert('Update failed: ' + err.message));
        }
      });
    };

    // Delete Pump
    window.deletePump = (id) => {
      if (confirm("Are you sure you want to delete this petrol pump?")) {
        remove(ref(db, `users/${currentUser.uid}/petrolPumps/${id}`))
          .then(() => alert('Pump deleted.'))
          .catch(err => alert('Deletion failed: ' + err.message));
      }
    };

    // Export to Excel
    document.getElementById("exportExcel").addEventListener("click", () => {
      const table = document.getElementById("pumpTable");
      const wb = XLSX.utils.table_to_book(table, { sheet: "PetrolPumps" });
      XLSX.writeFile(wb, "PetrolPumps.xlsx");
    });

    // Edit a fuel payment
    window.editFuelPayment = async (paymentId) => {
      const paymentRef = ref(db, `users/${currentUser.uid}/fuelPayments/${paymentId}`);
      const snapshot = await get(paymentRef);
      if (!snapshot.exists()) {
        alert('Payment record not found.');
        return;
      }
      const p = snapshot.val();
      currentEditingPaymentId = paymentId; 

      document.getElementById('fuelPaymentPumpSelect').value = p.pumpId;
      document.getElementById('fuelPaymentAmount').value = p.amount;
      document.getElementById('fuelPaymentDate').value = p.date;
      document.getElementById('fuelPaymentMode').value = p.mode;
      document.getElementById('fuelPaymentRemarks').value = p.remarks;

      document.querySelector('#fuelPaymentForm button[type="submit"]').innerHTML = '<i class="fas fa-save me-2"></i>Update Payment';
      document.getElementById('fuelPaymentForm').scrollIntoView({ behavior: 'smooth' });
    };

    // Delete a fuel payment
    window.deleteFuelPayment = (paymentId) => {
      if (confirm('Are you sure you want to delete this payment record?')) {
        remove(ref(db, `users/${currentUser.uid}/fuelPayments/${paymentId}`))
          .then(() => {
            alert('Payment record deleted.');
          })
          .catch(err => alert('Deletion failed: ' + err.message));
      }
    };

    // Set default date for payment form
    document.getElementById('fuelPaymentDate').valueAsDate = new Date();

    // Make functions globally accessible
    window.viewPump = viewPump;
    window.editPump = editPump;
    window.deletePump = deletePump;
    window.editFuelPayment = editFuelPayment;
    window.deleteFuelPayment = deleteFuelPayment;
    window.vfViewFuel = vfViewFuel;

  </script>
</body>
</html>
