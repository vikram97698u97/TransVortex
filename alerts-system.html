<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alerts & Reminders</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #F5F5F5;
      color: #111111;
    }

    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #2E8B57;
      padding: 14px 24px;
      color: white;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      flex-wrap: wrap;
    }

    .logo-container {
      display: flex;
      align-items: center;
    }

    .logo {
      height: 50px;
      width: 250px;
      max-width: 400px;
      transition: transform 0.3s ease;
    }

    .logo:hover {
      transform: scale(1.05);
    }

    .tagline {
      font-size: 12px;
      font-style: italic;
      color: #e0e0e0;
      margin-top: -3px;
      letter-spacing: 0.5px;
    }

    .navbar h1 {
      font-size: 22px;
      margin: 0;
      color: white;
    }

    .nav-links {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
    }

    .nav-links a {
      color: white;
      text-decoration: none;
      margin-left: 16px;
      font-weight: 500;
    }

    .nav-links a:hover {
      text-decoration: underline;
    }

    .nav-links a.active {
      font-weight: bold;
      text-decoration: underline;
    }

    .logout {
      margin-left: 16px;
      background-color: #43B97F;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
    }

    .logout:hover {
      background-color: #3ba06f;
      text-decoration: none;
    }

    .hamburger {
      display: none;
      font-size: 24px;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .nav-links {
        display: none;
        flex-direction: column;
        width: 100%;
        background-color: #26734d;
        margin-top: 10px;
        padding: 10px 0;
      }

      .nav-links.show {
        display: flex;
      }

      .nav-links a,
      .logout {
        margin: 8px auto;
        width: 90%;
        text-align: center;
        padding: 10px 0;
        display: block;
      }

      .logout {
        margin: 8px auto;
        text-align: center;
        max-width: 200px;
      }

      .hamburger {
        display: block;
      }
    }
    
    /* Add padding to main content to account for fixed navbar */
    body {
      padding-top: 100px;
      margin: 0;
    }
    
    @media (max-width: 768px) {
      body {
        padding-top: 90px;
      }
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .alert-card {
      border-left: 4px solid #dc3545;
      background: #f8f9fa;
      padding: 15px;
      margin: 10px 0;
      border-radius: 6px;
    }
    .alert-card.warning {
      border-left-color: #ffc107;
    }
    .alert-card.info {
      border-left-color: #17a2b8;
    }
    .reminder-form {
      background: #e8f0fe;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }
    button {
      cursor: pointer;
    }
    .btn-small {
      margin-top: 5px;
      margin-right: 5px;
      background: #43b97f;
      border: none;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
    }
    .btn-small.email {
      background: #007bff;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <div class="navbar">
    <div class="logo-container">
      <img src="logo.jpg" alt="TransVortex" class="logo">
    </div>
    <div class="hamburger" onclick="toggleMenu()">â˜°</div>
    <div class="nav-links" id="navLinks">
      <a href="home.html">Home</a>
      <a href="booking.html">Thread Booking</a>
      <a href="add.html">Vehicle Info</a>
      <a href="route-details.html">Route Details</a>
      <a href="trip-expenses.html">Trip Expenses</a>
      <a href="tyre.html">Tyres</a>
      <a href="tyre_history.html">Tyre History</a>
      <a href="payment-billing.html">Payments</a>
      <a href="lr-report.html">LR Report</a>
      <a href="invoice.html">Invoice</a>
      <a href="alerts-system.html" class="active">Reminder</a>
      <button class="logout" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="container" style="margin-top: 80px;">
    <h1>Alerts & Reminders System</h1>
    
    <!-- Set Reminders -->
    <div class="reminder-form">
      <h3>Set New Reminder</h3>
      <form id="reminderForm">
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
          <div>
            <label>Reminder Type:</label>
            <select id="reminderType" required>
              <option value="service">Vehicle Service</option>
              <option value="payment">Payment Due</option>
              <option value="permit">Permit Expiry</option>
              <option value="insurance">Insurance Expiry</option>
              <option value="puc">PUC Expiry</option>
            </select>
          </div>
          <div>
            <label>Vehicle Number:</label>
            <input type="text" id="vehicleNumber" required>
          </div>
          <div>
            <label>Due Date:</label>
            <input type="date" id="dueDate" required>
          </div>
        </div>

        <div style="margin-top: 15px;">
          <label>Description:</label>
          <textarea id="description" rows="3" style="width: 100%;"></textarea>
        </div>

        <div style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <label>Recipient Phone:</label>
            <input type="tel" id="recipientPhone" placeholder="10-digit number">
          </div>
          <div>
            <label>Recipient Email:</label>
            <input type="email" id="recipientEmail" placeholder="example@mail.com">
          </div>
        </div>

        <div style="margin-top: 15px;">
          <label>
            <input type="checkbox" id="whatsappReminder"> Send WhatsApp Reminder
          </label>
          <label style="margin-left: 20px;">
            <input type="checkbox" id="emailReminder"> Send Email Reminder
          </label>
        </div>

        <button type="submit" style="margin-top: 15px; background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 6px;">Set Reminder</button>
      </form>
    </div>
    
    <!-- Active Alerts -->
    <div id="alertsList">
      <h3>Active Alerts</h3>
      <!-- Alerts will be populated here -->
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDAlk_K8p8Of8Ne6Jpcl2QqXTtm95NgG7o",
      authDomain: "transport-dashboard-ad69a.firebaseapp.com",
      databaseURL: "https://transport-dashboard-ad69a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "transport-dashboard-ad69a",
      storageBucket: "transport-dashboard-ad69a.appspot.com",
      messagingSenderId: "526889676196",
      appId: "1:526889676196:web:66032c80a4aede690ae531"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUser = null;

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }
      currentUser = user;
      loadAlerts();
    });

    document.getElementById('reminderForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const reminderData = {
        type: document.getElementById('reminderType').value,
        vehicleNumber: document.getElementById('vehicleNumber').value,
        dueDate: document.getElementById('dueDate').value,
        description: document.getElementById('description').value,
        recipientPhone: document.getElementById('recipientPhone').value,
        recipientEmail: document.getElementById('recipientEmail').value,
        whatsappReminder: document.getElementById('whatsappReminder').checked,
        emailReminder: document.getElementById('emailReminder').checked,
        createdAt: Date.now(),
        status: 'active'
      };

      await push(ref(db, `users/${currentUser.uid}/reminders`), reminderData);
      alert('Reminder set successfully!');
      document.getElementById('reminderForm').reset();
    });

    function loadAlerts() {
      const alertsList = document.getElementById('alertsList');
      
      onValue(ref(db, `users/${currentUser.uid}/reminders`), (snapshot) => {
        const reminders = snapshot.val() || {};
        const alertsHtml = [];
        
        Object.entries(reminders).forEach(([key, reminder]) => {
          const dueDate = new Date(reminder.dueDate);
          const today = new Date();
          const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
          
          let alertClass = 'info';
          let alertText = '';
          
          if (daysUntilDue < 0) {
            alertClass = 'alert-card';
            alertText = `OVERDUE: ${Math.abs(daysUntilDue)} days ago`;
          } else if (daysUntilDue <= 7) {
            alertClass = 'alert-card warning';
            alertText = `DUE SOON: ${daysUntilDue} days remaining`;
          } else {
            alertClass = 'alert-card info';
            alertText = `${daysUntilDue} days remaining`;
          }
          
          alertsHtml.push(`
            <div class="${alertClass}">
              <h4>${reminder.type.toUpperCase()} - ${reminder.vehicleNumber}</h4>
              <p><strong>${alertText}</strong></p>
              <p>Due Date: ${reminder.dueDate}</p>
              <p>Description: ${reminder.description || 'No description'}</p>
              <small>Created: ${new Date(reminder.createdAt).toLocaleDateString()}</small>
              <br>
              <button class="btn-small" onclick="sendWhatsApp('${reminder.recipientPhone}', '${reminder.description}')">Send WhatsApp</button>
              <button class="btn-small email" onclick="sendEmail('${reminder.recipientEmail}', '${reminder.description}')">Send Email</button>
            </div>
          `);
        });
        
        alertsList.innerHTML = '<h3>Active Alerts</h3>' + (alertsHtml.length > 0 ? alertsHtml.join('') : '<p>No active alerts</p>');
      });
    }

    // Send functions
    window.sendWhatsApp = function(phone, message) {
      if (!phone) return alert("No phone number provided.");
      window.open(`https://wa.me/91${phone}?text=${encodeURIComponent(message)}`, "_blank");
    };

    window.sendEmail = function(email, message) {
      if (!email) return alert("No email provided.");
      window.location.href = `mailto:${email}?subject=Reminder&body=${encodeURIComponent(message)}`;
    };

    // Make logout function available globally
    window.logout = async function() {
      try {
        await signOut(auth);
        window.location.href = "index.html";
      } catch (e) {
        alert("Logout error: " + e.message);
      }
  };

  // Toggle mobile menu
  window.toggleMenu = function() {
    document.getElementById("navLinks").classList.toggle("show");
  };
</script>
</body>
</html>
