<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alerts & Reminders</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #F5F5F5;
      color: #111111;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .alert-card {
      border-left: 4px solid #dc3545;
      background: #f8f9fa;
      padding: 15px;
      margin: 10px 0;
      border-radius: 6px;
    }
    .alert-card.warning {
      border-left-color: #ffc107;
    }
    .alert-card.info {
      border-left-color: #17a2b8;
    }
    .reminder-form {
      background: #e8f0fe;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }
    button {
      cursor: pointer;
    }
    .btn-small {
      margin-top: 5px;
      margin-right: 5px;
      background: #43b97f;
      border: none;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
    }
    .btn-small.email {
      background: #007bff;
    }
  </style>
</head>
<body>
  <script src="navbar-loader.js"></script>

  <div class="container">
    <h1>Alerts & Reminders System</h1>
    
    <!-- Set Reminders -->
    <div class="reminder-form">
      <h3>Set New Reminder</h3>
      <form id="reminderForm">
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
          <div>
            <label>Reminder Type:</label>
            <select id="reminderType" required>
              <option value="service">Vehicle Service</option>
              <option value="payment">Payment Due</option>
              <option value="permit">Permit Expiry</option>
              <option value="insurance">Insurance Expiry</option>
              <option value="puc">PUC Expiry</option>
            </select>
          </div>
          <div>
            <label>Vehicle Number:</label>
            <input type="text" id="vehicleNumber" required>
          </div>
          <div>
            <label>Due Date:</label>
            <input type="date" id="dueDate" required>
          </div>
        </div>

        <div style="margin-top: 15px;">
          <label>Description:</label>
          <textarea id="description" rows="3" style="width: 100%;"></textarea>
        </div>

        <div style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <label>Recipient Phone:</label>
            <input type="tel" id="recipientPhone" placeholder="10-digit number">
          </div>
          <div>
            <label>Recipient Email:</label>
            <input type="email" id="recipientEmail" placeholder="example@mail.com">
          </div>
        </div>

        <div style="margin-top: 15px;">
          <label>
            <input type="checkbox" id="whatsappReminder"> Send WhatsApp Reminder
          </label>
          <label style="margin-left: 20px;">
            <input type="checkbox" id="emailReminder"> Send Email Reminder
          </label>
        </div>

        <button type="submit" style="margin-top: 15px; background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 6px;">Set Reminder</button>
      </form>
    </div>
    
    <!-- Active Alerts -->
    <div id="alertsList">
      <h3>Active Alerts</h3>
      <!-- Alerts will be populated here -->
    </div>

    <!-- Pagination Controls (Tab System) for Alerts -->
    <div style="margin-top: 16px;">
      <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:10px;">
        <label for="entriesPerPageAlerts" style="font-weight:600;">Entries per page:</label>
        <select id="entriesPerPageAlerts" style="padding:8px; border:1px solid #ccc; border-radius:6px;">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="20">20</option>
          <option value="50">50</option>
        </select>
        <div id="entriesInfoAlerts" style="color:#666; font-size:14px;"></div>
      </div>
      <div style="display:flex; align-items:center; justify-content:center; gap:8px;">
        <button class="tab-nav-control" id="prevAlerts" style="padding:8px 12px; background:#43b97f; color:#fff; border:none; border-radius:4px; cursor:pointer;" disabled>
          <i class="fas fa-chevron-left"></i>
        </button>
        <div class="tab-navigation" id="tabNavigationAlerts" style="display:flex; gap:6px; flex-wrap:wrap; justify-content:center;"></div>
        <button class="tab-nav-control" id="nextAlerts" style="padding:8px 12px; background:#43b97f; color:#fff; border:none; border-radius:4px; cursor:pointer;">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDAlk_K8p8Of8Ne6Jpcl2QqXTtm95NgG7o",
      authDomain: "transport-dashboard-ad69a.firebaseapp.com",
      databaseURL: "https://transport-dashboard-ad69a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "transport-dashboard-ad69a",
      storageBucket: "transport-dashboard-ad69a.appspot.com",
      messagingSenderId: "526889676196",
      appId: "1:526889676196:web:66032c80a4aede690ae531"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUser = null;
    let allReminders = [];
    // Pagination state
    const entriesPerPageSelect = document.getElementById('entriesPerPageAlerts');
    const entriesInfo = document.getElementById('entriesInfoAlerts');
    const tabNavigation = document.getElementById('tabNavigationAlerts');
    const prevBtn = document.getElementById('prevAlerts');
    const nextBtn = document.getElementById('nextAlerts');
    let currentPage = 1;
    let itemsPerPage = 10;
    let totalPages = 1;

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }
      currentUser = user;
      loadAlerts();
    });

    document.getElementById('reminderForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const reminderData = {
        type: document.getElementById('reminderType').value,
        vehicleNumber: document.getElementById('vehicleNumber').value,
        dueDate: document.getElementById('dueDate').value,
        description: document.getElementById('description').value,
        recipientPhone: document.getElementById('recipientPhone').value,
        recipientEmail: document.getElementById('recipientEmail').value,
        whatsappReminder: document.getElementById('whatsappReminder').checked,
        emailReminder: document.getElementById('emailReminder').checked,
        createdAt: Date.now(),
        status: 'active'
      };

      await push(ref(db, `users/${currentUser.uid}/reminders`), reminderData);
      alert('Reminder set successfully!');
      document.getElementById('reminderForm').reset();
    });

    function loadAlerts() {
      const remindersRef = ref(db, `users/${currentUser.uid}/reminders`);
      onValue(remindersRef, (snapshot) => {
        const reminders = snapshot.val() || {};
        // Normalize as array for stable pagination ordering (newest first by createdAt)
        allReminders = Object.entries(reminders).map(([key, r]) => ({ id: key, ...r }))
          .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
        currentPage = 1;
        renderAlertsWithPagination();
      });
    }

    function renderAlertsWithPagination() {
      const alertsList = document.getElementById('alertsList');
      const totalItems = allReminders.length;
      totalPages = Math.max(1, Math.ceil(totalItems / itemsPerPage));
      if (currentPage > totalPages) currentPage = totalPages;
      updatePaginationControls(totalItems);
      const start = (currentPage - 1) * itemsPerPage;
      const end = Math.min(start + itemsPerPage, totalItems);
      const pageData = allReminders.slice(start, end);
      const alertsHtml = pageData.map(reminder => {
        const dueDate = new Date(reminder.dueDate);
        const today = new Date();
        const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
        let alertClass = 'alert-card info';
        let alertText = '';
        if (daysUntilDue < 0) { alertClass = 'alert-card'; alertText = `OVERDUE: ${Math.abs(daysUntilDue)} days ago`; }
        else if (daysUntilDue <= 7) { alertClass = 'alert-card warning'; alertText = `DUE SOON: ${daysUntilDue} days remaining`; }
        else { alertClass = 'alert-card info'; alertText = `${daysUntilDue} days remaining`; }
        return `
          <div class="${alertClass}">
            <h4>${(reminder.type || '').toUpperCase()} - ${reminder.vehicleNumber || ''}</h4>
            <p><strong>${alertText}</strong></p>
            <p>Due Date: ${reminder.dueDate || ''}</p>
            <p>Description: ${reminder.description || 'No description'}</p>
            <small>Created: ${reminder.createdAt ? new Date(reminder.createdAt).toLocaleDateString() : ''}</small>
            <br>
            <button class="btn-small" onclick="sendWhatsApp('${reminder.recipientPhone || ''}', '${reminder.description || ''}')">Send WhatsApp</button>
            <button class="btn-small email" onclick="sendEmail('${reminder.recipientEmail || ''}', '${reminder.description || ''}')">Send Email</button>
          </div>`;
      });
      alertsList.innerHTML = '<h3>Active Alerts</h3>' + (alertsHtml.length > 0 ? alertsHtml.join('') : '<p>No active alerts</p>');
    }

    function updatePaginationControls(totalItems) {
      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === totalPages;
      const startIndex = Math.min((currentPage - 1) * itemsPerPage + 1, totalItems);
      const endIndex = Math.min(currentPage * itemsPerPage, totalItems);
      entriesInfo.textContent = `Showing ${totalItems === 0 ? 0 : startIndex} to ${endIndex} of ${totalItems} entries`;
      generatePageTabs();
    }

    function generatePageTabs() {
      tabNavigation.innerHTML = '';
      if (totalPages <= 1) return;
      addTab(1);
      let startPage = Math.max(2, currentPage - 2);
      let endPage = Math.min(totalPages - 1, currentPage + 2);
      if (startPage > 2) addEllipsis();
      for (let i = startPage; i <= endPage; i++) addTab(i);
      if (endPage < totalPages - 1) addEllipsis();
      addTab(totalPages);
    }

    function addTab(pageNumber) {
      const tab = document.createElement('div');
      tab.className = `tab ${pageNumber === currentPage ? 'active' : ''}`;
      tab.style.cssText = 'padding:6px 10px; background:#e0e0e0; border-radius:4px; cursor:pointer; min-width:36px; text-align:center;';
      tab.textContent = pageNumber;
      tab.addEventListener('click', () => {
        currentPage = pageNumber;
        renderAlertsWithPagination();
      });
      tabNavigation.appendChild(tab);
    }

    function addEllipsis() {
      const ellipsis = document.createElement('div');
      ellipsis.textContent = '...';
      ellipsis.style.cssText = 'padding:6px 10px; color:#666;';
      tabNavigation.appendChild(ellipsis);
    }

    // Hook up pagination controls
    entriesPerPageSelect.addEventListener('change', function () {
      itemsPerPage = parseInt(this.value, 10) || 10;
      currentPage = 1;
      renderAlertsWithPagination();
    });
    prevBtn.addEventListener('click', function () {
      if (currentPage > 1) {
        currentPage--;
        renderAlertsWithPagination();
      }
    });
    nextBtn.addEventListener('click', function () {
      if (currentPage < totalPages) {
        currentPage++;
        renderAlertsWithPagination();
      }
    });

    // Send functions
    window.sendWhatsApp = function(phone, message) {
      if (!phone) return alert("No phone number provided.");
      window.open(`https://wa.me/91${phone}?text=${encodeURIComponent(message)}`, "_blank");
    };

    window.sendEmail = function(email, message) {
      if (!email) return alert("No email provided.");
      window.location.href = `mailto:${email}?subject=Reminder&body=${encodeURIComponent(message)}`;
    };

    // Make logout function available globally
    window.logout = async function() {
      try {
        await signOut(auth);
        window.location.href = "index.html";
      } catch (e) {
        alert("Logout error: " + e.message);
      }
  };

  // No toggleMenu needed; sidebar toggle handled by navbar-loader.js
</script>
</body>
</html>
