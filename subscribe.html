<!DOCTYPE html>
<html lang="en">
<head>
<!-- üîê Secure .env Configuration Loader -->
    <script src="env-config-loader.js"></script>



  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Activate Your Subscription - Transvortex</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Load secure configuration first -->
  
  

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --primary: #2E8B57;
      --primary-dark: #1e6b41;
      --secondary: #3CB371;
      --text: #333;
      --light-bg: #f5f7fa;
      --white: #fff;
      --border: #e1e4e8;
      --danger: #ff6b6b;
      --accent: #ffc107;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      background: var(--light-bg);
      color: var(--text);
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 40px auto;
      background: var(--white);
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      overflow: hidden;
    }

    .header {
      background: var(--primary);
      color: white;
      padding: 30px 40px;
      text-align: center;
    }

    .header h1 {
      margin-bottom: 10px;
      font-size: 2rem;
    }

    .header p {
      opacity: 0.9;
      max-width: 600px;
      margin: 0 auto;
    }

    .content {
      padding: 30px 40px;
    }

    .plan-card {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 30px;
      margin-bottom: 30px;
      text-align: center;
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .plan-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .plan-name {
      font-size: 1.8rem;
      color: var(--primary);
      margin-bottom: 10px;
      text-transform: capitalize;
    }

    .price {
      font-size: 3rem;
      font-weight: 700;
      color: var(--primary);
      margin: 20px 0;
    }

    .price span {
      font-size: 1rem;
      color: #666;
      font-weight: normal;
    }

    .btn {
      display: inline-block;
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: background 0.3s;
      width: 100%;
      text-align: center;
    }

    .btn:hover {
      background: var(--primary-dark);
    }

    .btn:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }

    .qr-container {
      text-align: center;
      margin: 20px 0;
      padding: 20px;
      border: 1px solid var(--border);
      border-radius: 8px;
      display: none;
    }

    #qrcode {
      margin: 0 auto;
      padding: 10px;
      background: white;
      display: inline-block;
    }

    .payment-status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      display: none;
    }

    .payment-success {
      background-color: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #a5d6a7;
    }

    .payment-error {
      background-color: #ffebee;
      color: #c62828;
      border: 1px solid #ef9a9a;
    }

    .trial-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      text-align: center;
      border: 1px dashed var(--border);
    }

    /* Billing Cycle Selector */
    .billing-cycle-selector {
      margin: 30px 0;
    }
    .billing-cycle-selector h4 {
      text-align: center;
      margin-bottom: 20px;
      font-weight: 600;
      color: var(--text);
    }
    .cycle-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    .cycle-option {
      position: relative;
    }
    .cycle-option input[type="radio"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    .cycle-option label {
      display: block;
      padding: 20px;
      border: 2px solid var(--border);
      border-radius: 10px;
      text-align: center;
      transition: all 0.3s ease;
    }
    .cycle-option input[type="radio"]:checked + label {
      border-color: var(--primary);
      background-color: #e8f5e9;
      box-shadow: 0 0 0 3px var(--primary);
    }
    .cycle-option label strong {
      display: block;
      font-size: 1.1rem;
      margin-bottom: 5px;
    }
    .discount-badge {
      background-color: var(--accent);
      color: var(--text);
      font-size: 0.75rem;
      padding: 3px 8px;
      border-radius: 12px;
      font-weight: 700;
      margin-top: 5px;
      display: inline-block;
    }

    .trial-info i {
      color: var(--primary);
      margin-right: 5px;
    }

    @media (max-width: 768px) {
      .container {
        margin: 20px 10px;
      }

      .header, .content {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Subscription Status</h1>
      <p id="statusMessage">Your subscription details are being loaded...</p>
    </div>

    <div class="content">
      <div id="paymentForm">
        <div class="plan-card">
          <h2 id="planName" class="plan-name">Loading Plan...</h2>
          <div id="planPrice" class="price">‚Çπ0<span>/month</span></div>
          <p>Your plan includes <strong id="vehicleLimit">0</strong> vehicles.</p>

          <div class="billing-cycle-selector">
            <h4>Select Billing Cycle</h4>
            <div id="billingCycleOptions" class="cycle-options">
              </div>
          </div>

          <button id="subscribeBtn" class="btn" disabled>Loading Plan...</button>

          <div id="qrContainer" class="qr-container">
            <h3>Scan to Pay with UPI</h3>
            <div id="qrcode"></div>
            <p>Amount: <strong id="paymentAmount">‚Çπ0</strong></p>
            <p>UPI ID: <strong>singhvikram43210s@okhdfcbank</strong></p>
            <p>Reference: <strong id="paymentRef"></strong></p>
            <p>After successful payment, click below to verify</p>
            <button id="verifyPaymentBtn" class="btn" style="margin-top: 15px; background: #4CAF50;">I've Made the Payment</button>
            <button id="cancelPaymentBtn" class="btn" style="margin-top: 10px; background: #f44336;">Cancel</button>
          </div>

          <div id="paymentStatus" class="payment-status">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Verifying your payment...</p>
          </div>
        </div>
      </div>

      <div id="pendingApproval" class="status-card" style="display: none;">
        <div class="status-icon">
          <i class="fas fa-clock" style="color: #ff9800; font-size: 48px;"></i>
        </div>
        <h2>Subscription Pending Approval</h2>
        <p id="pendingMessage">Your subscription request is being reviewed by our team.</p>
        <p>You will receive an email once your subscription is approved.</p>
        <div class="action-buttons">
          <button id="checkStatusBtn" class="btn">Check Status</button>
          <button id="contactSupportBtn" class="btn btn-outline">Contact Support</button>
        </div>
      </div>

      <div id="rejectedStatus" class="status-card" style="display: none;">
        <div class="status-icon">
          <i class="fas fa-times-circle" style="color: #f44336; font-size: 48px;"></i>
        </div>
        <h2>Subscription Declined</h2>
        <p id="rejectionReason">Your payment was not approved.</p>
        <div class="action-buttons">
          <button id="tryAgainBtn" class="btn">Try Again</button>
          <button id="contactSupportBtn2" class="btn btn-outline">Contact Support</button>
        </div>
      </div>

      <div class="trial-info">
        <i class="fas fa-info-circle"></i>
        <span id="trialMessage">Your subscription has ended. Subscribe to continue using all features again.</span>
      </div>
    </div>
  </div>

  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
        getDatabase,
        ref,
        set,
        update,
        get,
        query,
        orderByChild,
        equalTo
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // Firebase configuration
    // Load Firebase configuration securely from EVM
    let firebaseConfig;
    
    try {
      // Get Firebase configuration from secure EVM system
      // Initialize Firebase with proper error handling
    try {
        if (!window.FIREBASE_CONFIG) {
            throw new Error('Firebase configuration not loaded. Please ensure evm.js is loaded first.');
        }
        
        if (!window.FIREBASE_CONFIG.databaseURL) {
            throw new Error('Firebase databaseURL not found in configuration.');
        }
        
        if (!window.FIREBASE_CONFIG.projectId) {
            throw new Error('Firebase projectId not found in configuration.');
        }
        
        firebaseConfig = window.FIREBASE_CONFIG;
        
        // Check if we're using fallback values
        if (false) { // Condition is always false in the final logic, keeping as per original structure
            
        } else {
            
            
            
        }
    } catch (error) {
        console.error('‚ùå Failed to load Firebase configuration:', error);
        
        // Use fallback configuration to prevent complete failure
        firebaseConfig = {
            apiKey: "AIzaSyDAlk_K8p8Of8Ne6Jpcl2QqXTtm95NgG7o",
            authDomain: "transport-dashboard-ad69a.firebaseapp.com",
            databaseURL: "https://transport-dashboard-ad69a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "transport-dashboard-ad69a",
            storageBucket: "transport-dashboard-ad69a.appspot.com",
            messagingSenderId: "526889676196",
            appId: "1:526889676196:web:66032c80a4aede690ae531",
            measurementId: "G-7F9R7HJYDH"
        };
        
    }} catch (error) {
      console.error('‚ùå Failed to load Firebase configuration:', error);
      
      // Use fallback configuration to prevent complete failure
      firebaseConfig = window.FIREBASE_CONFIG;
    }

    // Initialize Firebase
    const app = initializeApp(window.FIREBASE_CONFIG);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // Primary color from CSS: #2E8B57 (Sea Green)
    const PRIMARY_COLOR_RGB = [46, 139, 87];
    const ACCENT_COLOR_RGB = [245, 245, 245]; // Light Gray for table rows

    // Generate a unique payment reference
    function generatePaymentRef() {
        return 'PAY-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5).toUpperCase();
    }

    // Show payment status
    function showStatus(message, isError = false) {
        const statusDiv = document.getElementById('paymentStatus');
        statusDiv.innerHTML = `<p style="color: ${isError ? 'red' : 'green'}">${message}</p>`;
        statusDiv.style.display = 'block';
    }
    
    // Function to handle redirection (simplified to always go home)
    window.redirectToDashboard = function() {
        window.location.href = 'home.html';
    }

    // Function to generate and download the invoice PDF. Attached to window scope.
    window.generateInvoicePDF = async function(paymentId, userId) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const COMPANY_NAME = 'Transvortex';
        const COMPANY_DETAILS = {
            address: '123 Business Street, Ahmedabad, GJ 380009',
            phone: '+91 98765 43210',
            email: 'support@transvortex.com'
        };

        try {
            // 1. Fetch all necessary data
            const paymentRef = ref(db, `subscriptionPayments/${paymentId}`);
            const userRef = ref(db, `users/${userId}`);

            const [paymentSnap, userSnap] = await Promise.all([
                get(paymentRef),
                get(userRef)
            ]);

            if (!paymentSnap.exists()) {
                throw new Error('Payment details not found.');
            }
            const paymentData = paymentSnap.val();
            const userData = userSnap.exists() ? userSnap.val() : {};
            const profileData = userData.profile || {};


            // 2. Define PDF structure
            let y = 10;
            const MARGIN = 15;
            const pageWidth = doc.internal.pageSize.getWidth();
            const today = new Date().toLocaleDateString('en-IN', { year: 'numeric', month: 'long', day: 'numeric' });

            // --- Invoice Header and Logo ---
            // Top Green Bar
            doc.setFillColor(...PRIMARY_COLOR_RGB);
            doc.rect(0, 0, pageWidth, 5, 'F');


            // Title (Left Side)
            y = 25;
            doc.setFontSize(30);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0);
            doc.text("INVOICE", MARGIN, y);

            // Company Info (Right Side)
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`${COMPANY_NAME}`, pageWidth - MARGIN, y - 10, { align: 'right' });
            doc.text(`${COMPANY_DETAILS.address}`, pageWidth - MARGIN, y - 5, { align: 'right' });
            doc.text(`Phone: ${COMPANY_DETAILS.phone}`, pageWidth - MARGIN, y, { align: 'right' });
            doc.text(`Email: ${COMPANY_DETAILS.email}`, pageWidth - MARGIN, y + 5, { align: 'right' });

            y += 15;
            doc.setDrawColor(...PRIMARY_COLOR_RGB);
            doc.setLineWidth(0.5);
            doc.line(MARGIN, y, pageWidth - MARGIN, y); // Separator Line
            y += 10;

            // --- Invoice Metadata ---
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text(`INVOICE NO:`, MARGIN, y);
            doc.text(`DATE:`, MARGIN, y + 5);
            doc.text(`PAYMENT REF:`, MARGIN, y + 10);

            doc.setFont('helvetica', 'normal');
            doc.text(`INV-${paymentId}`, MARGIN + 30, y);
            doc.text(today, MARGIN + 30, y + 5);
            doc.text(paymentData.paymentRef || 'N/A', MARGIN + 30, y + 10);

            // --- BILL TO / CUSTOMER DETAILS ---
            const col2X = pageWidth / 2 + 5;
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(...PRIMARY_COLOR_RGB);
            doc.text("BILLED TO", col2X, y);
            doc.setTextColor(0); // Reset text color

            y += 5;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');

            const contactName = profileData.ownerName || 'N/A';
            const clientCompany = profileData.transportName || 'N/A';
            const clientAddress = profileData.address || 'N/A';
            const clientPhone = profileData.phoneNumber || 'N/A';
            const clientEmail = userData.email || 'N/A';

            // Bill To details
            doc.text(`${clientCompany} (${contactName})`, col2X, y + 5);
            doc.text(`${clientAddress}`, col2X, y + 10);
            doc.text(`Email: ${clientEmail}`, col2X, y + 15);
            doc.text(`Phone: ${clientPhone}`, col2X, y + 20);

            y += 30;

            // --- Items Table ---
            const subtotal = paymentData.amount || 0;
            const taxRate = 0.0; // Assuming 0% tax
            const taxAmount = subtotal * taxRate;
            const total = subtotal + taxAmount;

            doc.autoTable({
                startY: y,
                head: [['DESCRIPTION', 'QTY', 'UNIT PRICE (‚Çπ)', 'TOTAL (‚Çπ)']],
                body: [
                    [`${paymentData.plan || 'Subscription'} Activation - ${paymentData.plan || 'N/A'}`, 1, `${subtotal.toFixed(2)}`, `${subtotal.toFixed(2)}`]
                ],
                foot: [
                    ['', { content: `SUBTOTAL`, colSpan: 2, styles: { fillColor: ACCENT_COLOR_RGB, halign: 'right' } }, { content: `‚Çπ${subtotal.toFixed(2)}`, styles: { fillColor: ACCENT_COLOR_RGB } }],
                    ['', { content: `TOTAL TAX (${(taxRate * 100).toFixed(2)}%)`, colSpan: 2, styles: { fillColor: ACCENT_COLOR_RGB, halign: 'right' } }, { content: `‚Çπ${taxAmount.toFixed(2)}`, styles: { fillColor: ACCENT_COLOR_RGB } }],
                    ['', { content: `TOTAL DUE`, colSpan: 2, styles: { fillColor: PRIMARY_COLOR_RGB, textColor: 255, fontStyle: 'bold', halign: 'right' } }, { content: `‚Çπ${total.toFixed(2)}`, styles: { fillColor: PRIMARY_COLOR_RGB, textColor: 255, fontStyle: 'bold' } }]
                ],
                theme: 'striped',
                headStyles: { fillColor: PRIMARY_COLOR_RGB, textColor: 255, fontStyle: 'bold', fontSize: 11 },
                styles: { fontSize: 10, cellPadding: 3 },
                columnStyles: {
                    0: { cellWidth: 'auto' },
                    1: { cellWidth: 20, halign: 'center' },
                    2: { cellWidth: 35, halign: 'right' },
                    3: { cellWidth: 35, halign: 'right' }
                }
            });

            // --- Footer Notes ---
            const tableY = doc.autoTable.previous.finalY;
            doc.setFontSize(9);
            doc.setTextColor(100);
            doc.text("Thank you for your business. Payment is received in full.", MARGIN, tableY + 10);

            // Bottom Green Bar
            doc.setFillColor(...PRIMARY_COLOR_RGB);
            doc.rect(0, doc.internal.pageSize.getHeight() - 5, pageWidth, 5, 'F');

            // Save the PDF
            doc.save(`Invoice_Transvortex_${paymentId}.pdf`);
            
            // NOTE: We no longer call showStatus here. The calling function handles UI update after download.
            // Returning true to signal successful generation.
            return true;
        } catch (error) {
            console.error("Error generating invoice PDF:", error);
            showStatus("Failed to generate invoice. Please try again or contact support.", true);
            return false;
        }
    }


    // Add styles for status cards
    const style = document.createElement('style');
    style.textContent = `
      .status-card {
        text-align: center;
        padding: 40px 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 30px;
      }
      .status-icon {
        margin-bottom: 20px;
      }
      .status-card h2 {
        color: #333;
        margin-bottom: 15px;
      }
      .status-card p {
        color: #666;
        margin-bottom: 20px;
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
      }
      .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 25px;
      }
      .btn-outline {
        background: white;
        border: 1px solid var(--primary);
        color: var(--primary);
      }
      .btn-outline:hover {
        background: #f5f5f5;
      }
      .btn-primary { /* Add basic styling for the new button if Bootstrap is not fully linked */
        background-color: var(--primary);
        color: white;
        border: none;
      }
    `;
    document.head.appendChild(style);

    onAuthStateChanged(auth, (user) => {
        if (!user) {
            window.location.href = `login.html?redirect=subscribe.html`;
            return;
        }
        initializePage(user);
    });

    async function initializePage(user) {
        // Get all elements
        const paymentForm = document.getElementById('paymentForm');
        const pendingApproval = document.getElementById('pendingApproval');
        const rejectedStatus = document.getElementById('rejectedStatus');
        const statusMessage = document.getElementById('statusMessage');
        const pendingMessage = document.getElementById('pendingMessage');
        const rejectionReason = document.getElementById('rejectionReason');

        const subscribeBtn = document.getElementById('subscribeBtn');
        const qrContainer = document.getElementById('qrContainer');
        const verifyPaymentBtn = document.getElementById('verifyPaymentBtn');
        const cancelPaymentBtn = document.getElementById('cancelPaymentBtn');
        const checkStatusBtn = document.getElementById('checkStatusBtn');
        const tryAgainBtn = document.getElementById('tryAgainBtn');
        const contactSupportBtn = document.getElementById('contactSupportBtn');
        const contactSupportBtn2 = document.getElementById('contactSupportBtn2');

        // Dynamic UI elements
        const planNameEl = document.getElementById('planName');
        const planPriceEl = document.getElementById('planPrice');
        const vehicleLimitEl = document.getElementById('vehicleLimit');
        const paymentRefElement = document.getElementById('paymentRef');
        const paymentAmountEl = document.getElementById('paymentAmount');
        const paymentStatus = document.getElementById('paymentStatus');
        const qrCodeElement = document.getElementById('qrcode');

        // Check URL for status parameters
        const urlParams = new URLSearchParams(window.location.search);
        const status = urlParams.get('status') || sessionStorage.getItem('subscriptionStatus');
        const message = sessionStorage.getItem('pendingMessage');
        const reason = sessionStorage.getItem('rejectionReason');

        // Clear session storage after reading
        sessionStorage.removeItem('subscriptionStatus');
        sessionStorage.removeItem('pendingMessage');
        sessionStorage.removeItem('rejectionReason');

        // Show appropriate view based on status
        function showView(view) {
            paymentForm.style.display = 'none';
            pendingApproval.style.display = 'none';
            rejectedStatus.style.display = 'none';

            switch(view) {
                case 'payment':
                    paymentForm.style.display = 'block';
                    statusMessage.textContent = 'Activate Your Subscription';
                    break;
                case 'pending':
                    pendingApproval.style.display = 'block';
                    statusMessage.textContent = 'Subscription Status';
                    if (message) pendingMessage.textContent = message;
                    break;
                case 'rejected':
                    rejectedStatus.style.display = 'block';
                    statusMessage.textContent = 'Subscription Update';
                    if (reason) rejectionReason.textContent = reason;
                    break;
            }
        }

        // Fetch and display plan details
        async function loadPlanDetails() {
            // Use the correct path to the subscription data.
            const subRef = ref(db, `users/${user.uid}/subscription`);
            const snapshot = await get(subRef);

            if (!snapshot.exists()) {
                statusMessage.textContent = "Error: Could not find your plan details.";
                paymentForm.style.display = 'none';
                return;
            }
            const sub = snapshot.val();
            const baseRate = sub.monthlyRate || 1999; // Use a default if rate is missing

            // Update UI with plan details
            planNameEl.textContent = `${sub.planId || 'Basic'} Plan`;
            vehicleLimitEl.textContent = sub.vehicleLimit === -1 ? 'Unlimited' : `up to ${sub.vehicleLimit}`;

            // Calculate discounted amounts
            const fiveMonthAmount = Math.round(baseRate * 5 * 0.95);
            const twelveMonthAmount = Math.round(baseRate * 12 * 0.90);

            // Create billing cycle options
            const billingOptionsContainer = document.getElementById('billingCycleOptions');
            billingOptionsContainer.innerHTML = `
                <div class="cycle-option">
                    <input type="radio" id="cycle-1" name="billingCycle" value="1" data-amount="${baseRate}" checked>
                    <label for="cycle-1">
                        <strong>1 Month</strong>
                        <span>‚Çπ${baseRate.toLocaleString('en-IN')}</span>
                    </label>
                </div>
                <div class="cycle-option">
                    <input type="radio" id="cycle-5" name="billingCycle" value="5" data-amount="${fiveMonthAmount}">
                    <label for="cycle-5">
                        <strong>5 Months</strong>
                        <span>‚Çπ${fiveMonthAmount.toLocaleString('en-IN')}</span>
                        <span class="discount-badge">5% OFF</span>
                    </label>
                </div>
                <div class="cycle-option">
                    <input type="radio" id="cycle-12" name="billingCycle" value="12" data-amount="${twelveMonthAmount}">
                    <label for="cycle-12">
                        <strong>1 Year</strong>
                        <span>‚Çπ${twelveMonthAmount.toLocaleString('en-IN')}</span>
                        <span class="discount-badge">10% OFF</span>
                    </label>
                </div>
            `;

            // Force the first radio button to be selected and initialize price display
            setTimeout(() => {
                const firstRadio = document.getElementById('cycle-1');
                if (firstRadio) {
                    // Enable the button only after the default option is checked.
                    const subscribeBtn = document.getElementById('subscribeBtn');
                    subscribeBtn.disabled = false;
                    subscribeBtn.textContent = 'Pay Now';
                    firstRadio.checked = true;
                }
                updateDisplayPrice();
            }, 100);

            // Function to update the main price display
            const updateDisplayPrice = () => {
                const selectedOption = document.querySelector('input[name="billingCycle"]:checked');
                if (selectedOption) {
                    const amount = selectedOption.dataset.amount;
                    const months = selectedOption.value;
                    planPriceEl.innerHTML = `‚Çπ${parseInt(amount).toLocaleString('en-IN')}<span>/ ${months} month${months > 1 ? 's' : ''}</span>`;
                }
            };

            // Add event listeners to radio buttons
            document.querySelectorAll('input[name="billingCycle"]').forEach(radio => {
                radio.addEventListener('change', updateDisplayPrice);
            });
        }

        // When user clicks subscribe button
        subscribeBtn.addEventListener('click', async () => {
            try {
                if (!user) {
                    throw new Error('Please log in to subscribe');
                }

                const selectedCycle = document.querySelector('input[name="billingCycle"]:checked');
                if (!selectedCycle) {
                    throw new Error("Please select a billing cycle.");
                }
                const amountToPay = parseInt(selectedCycle.dataset.amount, 10);
                const months = parseInt(selectedCycle.value, 10);

                // Validate the amount
                if (isNaN(amountToPay) || amountToPay <= 0) {
                    throw new Error("Invalid payment amount. Please try again.");
                }

                const paymentRef = generatePaymentRef();

                // Use set for new payment
                await set(ref(db, `subscriptionPayments/${paymentRef}`), {
                    userId: user.uid,
                    amount: amountToPay,
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    clientId: user.uid,
                    timestamp: new Date().toISOString(),
                    plan: `${months} Months` // Store the cycle duration
                });

                sessionStorage.setItem('currentPaymentRef', paymentRef);

                paymentRefElement.textContent = paymentRef;
                paymentAmountEl.textContent = `‚Çπ${amountToPay.toLocaleString('en-IN')}`;
                qrContainer.style.display = 'block';
                subscribeBtn.style.display = 'none';

                const upiId = 'singhvikram43210s@okhdfcbank';
                const amount = `${amountToPay}.00`;
                const note = `Payment Ref: ${paymentRef}`;
                const upiLink = `upi://pay?pa=${encodeURIComponent(upiId)}&pn=Your%20Business&am=${amount}&tn=${encodeURIComponent(note)}`;

                qrCodeElement.innerHTML = '';

                new QRCode(qrCodeElement, {
                    text: upiLink,
                    width: 200,
                    height: 200,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });

                qrContainer.style.display = 'block';

            } catch (error) {
                console.error('Error creating payment:', error);
                showStatus(error.message || 'Error creating payment. Please try again.', true);
            }
        });

        // When user clicks verify payment button
        verifyPaymentBtn.addEventListener('click', async () => {
            try {
                if (!user) {
                    throw new Error('User not authenticated. Please log in again.');
                }

                // Get the payment reference from session
                const paymentReference = sessionStorage.getItem('currentPaymentRef');
                if (!paymentReference) {
                    throw new Error('No payment reference found. Please try subscribing again.');
                }

                // Show verifying message
                qrContainer.style.display = 'none';
                paymentStatus.style.display = 'block';
                paymentStatus.innerHTML = `
                    <div class="status-message">
                        <i class="fas fa-spinner fa-spin" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <h3>Verifying Payment...</h3>
                        <p>Please wait while we verify your payment.</p>
                    </div>
                `;

                // Check payment status with polling
                let paymentVerified = false;
                let attempts = 0;
                const maxAttempts = 30;

                while (attempts < maxAttempts && !paymentVerified) {
                    attempts++;
                    await new Promise(resolve => setTimeout(resolve, 2000));

                    // Check payment status
                    const paymentSnap = await get(ref(db, `subscriptionPayments/${paymentReference}`));
                    if (!paymentSnap.exists()) continue;

                    const paymentData = paymentSnap.val();
                    if (paymentData.status === 'verified') {
                        paymentVerified = true;
                        break;
                    } else if (paymentData.status === 'failed') {
                        throw new Error('Payment was rejected. Please contact support.');
                    }
                }

                if (!paymentVerified) {
                    throw new Error('Payment verification timed out. Please contact support if your payment was successful.');
                }

                // ‚úÖ Payment verified ‚Üí update subscription
                const selectedCycle = document.querySelector('input[name="billingCycle"]:checked');
                const months = parseInt(selectedCycle.value, 10);

                const now = new Date();
                const subscriptionEnd = new Date();
                subscriptionEnd.setMonth(subscriptionEnd.getMonth() + months);

                // Get existing subscription data
                const userRef = ref(db, `users/${user.uid}`);
                const userSnap = await get(userRef);
                const existingData = userSnap.val() || {};
                const existingSubscription = existingData.subscription || {};

                // Create subscription data, preserving the original plan details.
                const subscriptionData = {
                    status: 'active',
                    planId: existingSubscription.planId || 'starter',
                    vehicleLimit: existingSubscription.vehicleLimit || 25,
                    monthlyRate: existingSubscription.monthlyRate || 1999,
                    startDate: now.toISOString(),
                    endDate: subscriptionEnd.toISOString(),
                    nextPayment: subscriptionEnd.toISOString(),
                    lastPayment: now.toISOString(),
                    paymentRef: paymentReference,
                    updatedAt: now.toISOString(),
                    trialStart: existingSubscription.trialStart || now.toISOString(),
                    trialEnd: existingSubscription.trialEnd || now.toISOString()
                };

                // Perform updates on specific paths.
                await update(ref(db, `users/${user.uid}`), {
                    subscription: subscriptionData,
                    'profile/subscription': subscriptionData,
                    lastPayment: now.toISOString()
                });

                // Clear payment ref
                sessionStorage.removeItem('currentPaymentRef');

                // Show success message and download/dashboard action buttons
                paymentStatus.innerHTML = `
                    <div class="status-message">
                        <i class="fas fa-check-circle" style="color: #4CAF50; font-size: 48px;"></i>
                        <h3>Payment Verified Successfully!</h3>
                        <p>Your subscription has been activated.</p>
                        <div class="action-buttons" style="margin-top: 20px;">
                            <button id="downloadInvoiceAndGoHome" class="btn btn-primary" data-payment-ref="${paymentReference}" data-user-id="${user.uid}"><i class="fas fa-download me-2"></i>Download Invoice</button>
                            <button onclick="redirectToDashboard()" class="btn btn-outline" style="background: var(--primary); color: white; border: none; font-weight: 600;">Go to Dashboard</button>
                        </div>
                    </div>
                `;
                
                // Add event listener for the new download button
                document.getElementById('downloadInvoiceAndGoHome').addEventListener('click', async function() {
                    const pRef = this.getAttribute('data-payment-ref');
                    const uId = this.getAttribute('data-user-id');
                    
                    const success = await window.generateInvoicePDF(pRef, uId);
                    
                    if (success) {
                        // After generating the PDF, update the message container to highlight the dashboard button
                        paymentStatus.innerHTML = `
                            <div class="status-message">
                                <i class="fas fa-check-circle" style="color: #4CAF50; font-size: 48px;"></i>
                                <h3>Invoice Downloaded Successfully!</h3>
                                <p>Thank you for subscribing. You can now go to your dashboard.</p>
                                <div class="action-buttons" style="margin-top: 20px;">
                                    <button onclick="redirectToDashboard()" class="btn btn-primary">Go to Dashboard</button>
                                </div>
                            </div>
                        `;
                    }
                });

            } catch (error) {
                console.error('Payment verification error:', error);
                paymentStatus.innerHTML = `
                    <div class="status-message">
                        <i class="fas fa-exclamation-triangle" style="color: #f44336; font-size: 48px;"></i>
                        <h3>Verification Failed</h3>
                        <p>${error.message}</p>
                        <button onclick="window.location.reload()" class="btn" style="margin-top: 15px;">Try Again</button>
                    </div>
                `;
            }
        });

        async function setupPage() {
            await loadPlanDetails();

            // Initial view setup
            if (status === 'pending') {
                showView('pending');
            } else if (status === 'rejected') {
                showView('rejected');
            } else {
                showView('payment');
            }

            // Button event listeners
            checkStatusBtn?.addEventListener('click', () => {
                window.location.reload();
            });

            tryAgainBtn?.addEventListener('click', () => {
                showView('payment');
            });

            const contactSupport = (e) => {
                e.preventDefault();
                window.location.href = 'contact.html';
            };

            contactSupportBtn?.addEventListener('click', contactSupport);
            contactSupportBtn2?.addEventListener('click', contactSupport);

            // Hide QR container and payment status by default
            qrContainer.style.display = 'none';
            paymentStatus.style.display = 'none';
        }

        // Cancel payment button
        cancelPaymentBtn.addEventListener('click', () => {
            sessionStorage.removeItem('currentPaymentRef');
            qrContainer.style.display = 'none';
            subscribeBtn.style.display = 'block';
            paymentStatus.style.display = 'none';
        });

        // Start the page setup
        setupPage();
    }
</script>
</body>
</html>
