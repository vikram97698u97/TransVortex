<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trip Expenses - Transport System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <style>
    body { padding: 0; margin: 0; background-color: #f8f9fa; }
    .tab-content { background: white; padding: 20px; border-radius: 0 0 8px 8px; }
    .profit-positive { color: green; font-weight: bold; }
    .profit-negative { color: red; font-weight: bold; }
    .summary-card { border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

  <!-- Navbar will be loaded here by navbar-loader.js -->
  <div id="navbar-placeholder"></div>

  <div class="container">
    <h2 class="mb-4"><i class="fas fa-money-bill-wave me-2"></i>Trip Expenses</h2>
    
    <!-- Summary Cards -->
    <div class="row mb-4">
      <div class="col-md-3 mb-3">
        <div class="card summary-card bg-primary text-white">
          <div class="card-body">
            <h6 class="card-title">Total Freight</h6>
            <h3 id="totalFreight">₹0.00</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card summary-card bg-info text-white">
          <div class="card-body">
            <h6 class="card-title">Total Expenses</h6>
            <h3 id="totalExpenses">₹0.00</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card summary-card bg-success text-white">
          <div class="card-body">
            <h6 class="card-title">Total Profit</h6>
            <h3 id="totalProfit">₹0.00</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card summary-card bg-warning text-white">
          <div class="card-body">
            <h6 class="card-title">Trips Count</h6>
            <h3 id="tripsCount">0</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="row mb-3">
      <div class="col-md-3">
        <label class="form-label">From Date</label>
        <input type="date" class="form-control" id="fromDate">
      </div>
      <div class="col-md-3">
        <label class="form-label">To Date</label>
        <input type="date" class="form-control" id="toDate">
      </div>
      <div class="col-md-3">
        <label class="form-label">Vehicle Number</label>
        <select class="form-select" id="vehicleFilter">
          <option value="">All Vehicles</option>
        </select>
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <button class="btn btn-primary me-2" id="applyFiltersBtn">Filter</button>
        <button class="btn btn-success" id="exportPdfBtn">PDF</button>
      </div>
    </div>

    <!-- Expenses Table -->
    <div class="table-responsive">
      <table id="expensesTable" class="table table-striped">
        <thead>
          <tr>
            <th>Date</th>
            <th>Vehicle No</th>
            <th>LR No</th>
            <th>From</th>
            <th>To</th>
            <th class="text-end">Tyre Exp</th>
            <th class="text-end">Diesel Exp</th>
            <th class="text-end">Advance</th>
            <th class="text-end">Toll</th>
            <th class="text-end">Vehicle Work</th>
            <th class="text-end">Other Exp</th>
            <th class="text-end">Food Exp</th>
            <th class="text-end">Shortage</th>
            <th class="text-end">Freight Amt</th>
            <th class="text-end">Total Exp</th>
            <th class="text-end">Profit</th>
          </tr>
        </thead>
        <tbody>
          <!-- Rows will be populated by JavaScript -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="navbar-loader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDAlk_K8p8Of8Ne6Jpcl2QqXTtm95NgG7o",
      authDomain: "transport-dashboard-ad69a.firebaseapp.com",
      databaseURL: "https://transport-dashboard-ad69a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "transport-dashboard-ad69a",
      storageBucket: "transport-dashboard-ad69a.appspot.com",
      messagingSenderId: "526889676196",
      appId: "1:526889676196:web:66032c80a4aede690ae531"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }

    const db = firebase.database();
    const auth = firebase.auth();

    // Global variables
    let expensesTable;
    let tripExpensesData = [];
    let lrData = [];

    // Initialize the page
    $(document).ready(function() {
      // First check authentication status
      auth.onAuthStateChanged((user) => {
        if (!user) {
          window.location.href = 'login.html';
        } else {
          // Only initialize table and load data after confirming user is authenticated
          initializeDataTable();
          loadLRData();
          setupEventListeners();
          
          // Set default date range to current month
          const today = new Date();
          const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
          $('#fromDate').val(formatDateForInput(firstDay));
          $('#toDate').val(formatDateForInput(today));
        }
      });
    });

    // Format date for input field (YYYY-MM-DD)
    function formatDateForInput(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // Initialize DataTable
    function initializeDataTable() {
      expensesTable = $('#expensesTable').DataTable({
        pageLength: 10,
        lengthMenu: [10, 25, 50, 100],
        order: [[0, 'desc']],
        columnDefs: [
          { className: "text-end", targets: [5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15] }
        ]
      });
    }

    // Setup event listeners
    function setupEventListeners() {
      // Filter button click
      $('#applyFiltersBtn').on('click', function() {
        applyFilters();
      });

      // Export PDF button click
      $('#exportPdfBtn').on('click', function() {
        exportToPDF();
      });
    }

    // Load LR data from Firebase
    function loadLRData() {
      const user = auth.currentUser;
      if (!user) {
        console.error('No authenticated user found');
        return;
      }
      const userId = user.uid;
      
      const lrRef = db.ref('lrReports').orderByChild('userId').equalTo(userId);
      lrRef.on('value', (snapshot) => {
        lrData = [];
        const data = snapshot.val();
        
        if (data) {
          Object.keys(data).forEach(key => {
            lrData.push({ id: key, ...data[key] });
          });
          
          // Process LR data for trip expenses
          processLRDataForExpenses();
          
          // Populate the table
          populateTable();
          
          // Update vehicle filter dropdown
          updateVehicleFilter();
          
          // Update summary cards
          updateSummaryCards();
        } else {
          // No LR data found
          expensesTable.clear().draw();
          updateSummaryCards();
        }
      }, (error) => {
        console.error('Error loading LR data:', error);
      });
    }

    // Process LR data for trip expenses display
    function processLRDataForExpenses() {
      tripExpensesData = lrData.map(lr => {
        // Calculate total expenses
        const totalExpenses = 
          (parseFloat(lr.tyreExpenses) || 0) +
          (parseFloat(lr.dieselExpenses) || 0) +
          (parseFloat(lr.advance) || 0) +
          (parseFloat(lr.tollExpenses) || 0) +
          (parseFloat(lr.vehicleWork) || 0) +
          (parseFloat(lr.otherExpenses) || 0) +
          (parseFloat(lr.foodExpenses) || 0) +
          (parseFloat(lr.shortage) || 0);
        
        // Calculate profit
        const profit = (parseFloat(lr.billingAmount) || 0) - totalExpenses;
        
        return {
          id: lr.id,
          date: lr.date,
          vehicleNumber: lr.truckNumber,
          lrNumber: lr.lrNumber,
          from: lr.fromLocation,
          to: lr.toLocation,
          tyreExpenses: parseFloat(lr.tyreExpenses) || 0,
          dieselExpenses: parseFloat(lr.dieselExpenses) || 0,
          advancePaid: parseFloat(lr.advance) || 0,
          tollPaid: parseFloat(lr.tollExpenses) || 0,
          vehicleWork: parseFloat(lr.vehicleWork) || 0,
          otherExpenses: parseFloat(lr.otherExpenses) || 0,
          foodExpenses: parseFloat(lr.foodExpenses) || 0,
          shortage: parseFloat(lr.shortage) || 0,
          freightAmount: parseFloat(lr.billingAmount) || 0, // Use billingAmount for display
          totalExpenses: totalExpenses,
          profit: profit
        };
      });
    }

    // Populate the table with trip expenses data
    function populateTable() {
      expensesTable.clear();
      
      tripExpensesData.forEach(expense => {
        const profitClass = expense.profit >= 0 ? 'profit-positive' : 'profit-negative';
        
        const row = [
          formatDate(expense.date),
          expense.vehicleNumber,
          expense.lrNumber,
          expense.from,
          expense.to,
          formatCurrency(expense.tyreExpenses),
          formatCurrency(expense.dieselExpenses),
          formatCurrency(expense.advancePaid),
          formatCurrency(expense.tollPaid),
          formatCurrency(expense.vehicleWork),
          formatCurrency(expense.otherExpenses),
          formatCurrency(expense.foodExpenses),
          formatCurrency(expense.shortage),
          formatCurrency(expense.freightAmount),
          formatCurrency(expense.totalExpenses),
          `<span class="${profitClass}">${formatCurrency(expense.profit)}</span>`
        ];
        
        expensesTable.row.add(row);
      });
      
      expensesTable.draw();
    }

    // Update vehicle filter dropdown
    function updateVehicleFilter() {
      const vehicleFilter = $('#vehicleFilter');
      const vehicles = [...new Set(tripExpensesData.map(expense => expense.vehicleNumber))].sort();
      
      // Clear existing options except the first one
      vehicleFilter.find('option:not(:first)').remove();
      
      // Add vehicle options
      vehicles.forEach(vehicle => {
        if (vehicle) {
          vehicleFilter.append(`<option value="${vehicle}">${vehicle}</option>`);
        }
      });
    }

    // Update summary cards
    function updateSummaryCards() {
      const totalFreight = tripExpensesData.reduce((sum, expense) => 
        sum + (parseFloat(expense.freightAmount) || 0), 0);
      
      const totalExpenses = tripExpensesData.reduce((sum, expense) => 
        sum + (parseFloat(expense.totalExpenses) || 0), 0);
      
      const totalProfit = tripExpensesData.reduce((sum, expense) => 
        sum + (parseFloat(expense.profit) || 0), 0);
      
      $('#totalFreight').text(formatCurrency(totalFreight));
      $('#totalExpenses').text(formatCurrency(totalExpenses));
      $('#totalProfit').text(formatCurrency(totalProfit));
      $('#tripsCount').text(tripExpensesData.length);
    }

    // Apply filters to the table
    function applyFilters() {
      const fromDate = $('#fromDate').val();
      const toDate = $('#toDate').val();
      const vehicle = $('#vehicleFilter').val();

      // Use DataTables custom search function for filtering
      $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
        // Ensure we are targeting the correct table
        if (settings.nTable.id !== 'expensesTable') {
          return true;
        }

        const rowDate = new Date(data[0].split('/').reverse().join('-')); // Convert DD/MM/YYYY to YYYY-MM-DD for comparison
        const rowVehicle = data[1] || '';

        let showRow = true;

        if (fromDate && rowDate < new Date(fromDate)) showRow = false;
        if (toDate && rowDate > new Date(toDate)) showRow = false;
        if (vehicle && rowVehicle !== vehicle) showRow = false;

        return showRow;
      });

      // Redraw the table with the new filter
      expensesTable.draw();
      
      // Update summary cards with filtered data
      updateFilteredSummary();
    }

    // Update summary cards with filtered data
    function updateFilteredSummary() {
      let filteredFreight = 0;
      let filteredExpenses = 0;
      let filteredProfit = 0;
      let filteredCount = 0;
      
      // Get the data for the currently visible (filtered) rows
      const filteredData = expensesTable.rows({ search: 'applied' }).data();
      
      filteredData.each(function(rowData) {
        const freight = parseCurrency(rowData[13]);
        const expenses = parseCurrency(rowData[14]);
        const profit = parseCurrency(rowData[15]);
        filteredFreight += freight;
        filteredExpenses += expenses;
        filteredProfit += profit;
        filteredCount++;
      });
      
      $('#totalFreight').text(formatCurrency(filteredFreight));
      $('#totalExpenses').text(formatCurrency(filteredExpenses));
      $('#totalProfit').text(formatCurrency(filteredProfit));
      $('#tripsCount').text(filteredCount);
    }

    // Format date for display
    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-IN');
    }

    // Format currency for display
    function formatCurrency(amount) {
      if (amount === undefined || amount === null) return '₹0.00';
      return '₹' + parseFloat(amount).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
    }

    // Parse currency from formatted string
    function parseCurrency(currencyString) {
      if (typeof currencyString !== 'string') return 0;
      const cleanedString = currencyString.replace(/<[^>]*>/g, '').replace(/[₹,]/g, '');
      return parseFloat(cleanedString) || 0;
    }

    // Export to PDF
    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Add title
      doc.setFontSize(16);
      doc.text('Trip Expenses Report', 14, 15);
      
      // Add date range if filtered
      const fromDate = $('#fromDate').val();
      const toDate = $('#toDate').val();
      const vehicle = $('#vehicleFilter').val();
      
      doc.setFontSize(10);
      let filterText = 'All Trips';
      
      if (fromDate || toDate || vehicle) {
        filterText = 'Filtered: ';
        if (fromDate && toDate) {
          filterText += `${fromDate} to ${toDate}`;
        } else if (fromDate) {
          filterText += `From ${fromDate}`;
        } else if (toDate) {
          filterText += `To ${toDate}`;
        }
        
        if (vehicle) {
          filterText += `, Vehicle: ${vehicle}`;
        }
      }
      
      doc.text(filterText, 14, 22);
      
      // Get table data
      const tableData = [];
      expensesTable.rows({ search: 'applied' }).every(function() {
        const rowData = expensesTable.row(this).data();
        // Remove HTML from profit column
        const profitText = rowData[15].replace(/<[^>]*>/g, '');
        tableData.push([
          rowData[0],  // Date
          rowData[1],  // Vehicle
          rowData[2],  // LR No
          rowData[3],  // From
          rowData[4],  // To
          rowData[5],  // Tyre
          rowData[6],  // Diesel
          rowData[7],  // Advance
          rowData[8],  // Toll
          rowData[9],  // Vehicle Work
          rowData[10], // Other
          rowData[11], // Food
          rowData[12], // Shortage
          rowData[13], // Freight
          rowData[14], // Total Expenses
          profitText   // Profit
        ]);
      });
      
      // Add table to PDF
      doc.autoTable({
        head: [['Date', 'Vehicle', 'LR No', 'From', 'To', 'Tyre', 'Diesel', 'Advance', 'Toll', 'Veh Work', 'Other', 'Food', 'Shortage', 'Freight', 'Total Exp', 'Profit']],
        body: tableData,
        startY: 30,
        theme: 'grid',
        headStyles: { fillColor: [41, 128, 185] },
        styles: { fontSize: 6 },
        columnStyles: {
          0: { cellWidth: 12 },
          1: { cellWidth: 12 },
          2: { cellWidth: 10 },
          3: { cellWidth: 12 },
          4: { cellWidth: 12 },
          5: { cellWidth: 10 },
          6: { cellWidth: 10 },
          7: { cellWidth: 10 },
          8: { cellWidth: 10 },
          9: { cellWidth: 10 },
          10: { cellWidth: 10 },
          11: { cellWidth: 10 },
          12: { cellWidth: 10 },
          13: { cellWidth: 12 },
          14: { cellWidth: 12 },
          15: { cellWidth: 12 }
        }
      });
      
      // Add summary
      const finalY = doc.lastAutoTable.finalY + 10;
      doc.setFontSize(10);
      doc.text(`Total Trips: ${$('#tripsCount').text()}`, 14, finalY);
      doc.text(`Total Freight: ${$('#totalFreight').text()}`, 14, finalY + 5);
      doc.text(`Total Expenses: ${$('#totalExpenses').text()}`, 14, finalY + 10);
      doc.text(`Total Profit: ${$('#totalProfit').text()}`, 14, finalY + 15);
      
      // Save the PDF
      doc.save('trip-expenses-report.pdf');
    }
  </script>
</body>
</html>
