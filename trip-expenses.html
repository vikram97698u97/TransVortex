<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trip Expenses - Transport System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <style>
    body { padding: 0; margin: 0; background-color: #f8f9fa; }
    .tab-content { background: white; padding: 20px; border-radius: 0 0 8px 8px; }
    .profit-positive { color: green; font-weight: bold; }
    .profit-negative { color: red; font-weight: bold; }
    .summary-card { border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .empty-trip-row { background-color: #ffebee !important; }
    .empty-btn { background: none; border: none; color: #dc3545; cursor: pointer; }
    .empty-btn:hover { color: #c82333; }
    .modal-backdrop { z-index: 1040; }
    .modal { z-index: 1050; }
    /* Styles for child row */
    td.details-control {
        background: url('https://datatables.net/examples/resources/details_open.png') no-repeat center center;
        cursor: pointer;
    }
    tr.details td.details-control {
        background: url('https://datatables.net/examples/resources/details_close.png') no-repeat center center;
    }
    .child-row-table {
      width: 100%;
      margin: 10px 0;
    }
    .child-row-table th, .child-row-table td {
      padding: 8px;
      border: 1px solid #e0e0e0;
    }
    .child-row-table th {
      background-color: #f2f2f2;
      font-weight: 600;
    }
    .child-row-container {
      padding: 10px 20px;
    }
    .card-value {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 0.25rem;
    }
    .card-label {
      font-size: 0.875rem;
      color: #6c757d;
    }
    .card-icon {
      font-size: 2rem;
      opacity: 0.7;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

  <div id="navbar-placeholder"></div>

  <div class="container">
    <h2 class="mb-4"><i class="fas fa-money-bill-wave me-2"></i>Trip Expenses</h2>
    
    <div class="row mb-4">
      <div class="col-md-2 mb-3">
        <div class="card summary-card border-primary">
          <div class="card-body text-center">
            <div class="card-icon text-primary mb-2">
              <i class="fas fa-file-invoice-dollar"></i>
            </div>
            <div class="card-value text-primary" id="totalBilling">₹0.00</div>
            <div class="card-label">Total Billing</div>
          </div>
        </div>
      </div>
      <div class="col-md-2 mb-3">
        <div class="card summary-card border-info">
          <div class="card-body text-center">
            <div class="card-icon text-info mb-2">
              <i class="fas fa-money-bill-wave"></i>
            </div>
            <div class="card-value text-info" id="totalExpenses">₹0.00</div>
            <div class="card-label">Total Expenses</div>
          </div>
        </div>
      </div>
      <div class="col-md-2 mb-3">
        <div class="card summary-card border-success">
          <div class="card-body text-center">
            <div class="card-icon text-success mb-2">
              <i class="fas fa-chart-line"></i>
            </div>
            <div class="card-value text-success" id="totalProfit">₹0.00</div>
            <div class="card-label">Total Profit</div>
          </div>
        </div>
      </div>
      <div class="col-md-2 mb-3">
        <div class="card summary-card border-warning">
          <div class="card-body text-center">
            <div class="card-icon text-warning mb-2">
              <i class="fas fa-truck"></i>
            </div>
            <div class="card-value text-warning" id="tripsCount">0</div>
            <div class="card-label">Trips Count</div>
          </div>
        </div>
      </div>
      <div class="col-md-2 mb-3">
        <div class="card summary-card border-secondary">
          <div class="card-body text-center">
            <div class="card-icon text-secondary mb-2">
              <i class="fas fa-gas-pump"></i>
            </div>
            <div class="card-value text-secondary" id="totalDiesel">₹0.00</div>
            <div class="card-label">Diesel Expenses</div>
          </div>
        </div>
      </div>
      <div class="col-md-2 mb-3">
        <div class="card summary-card border-danger">
          <div class="card-body text-center">
            <div class="card-icon text-danger mb-2">
              <i class="fas fa-tools"></i>
            </div>
            <div class="card-value text-danger" id="totalOtherExp">₹0.00</div>
            <div class="card-label">Other Expenses</div>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-3">
        <label class="form-label">From Date</label>
        <input type="date" class="form-control" id="fromDate">
      </div>
      <div class="col-md-3">
        <label class="form-label">To Date</label>
        <input type="date" class="form-control" id="toDate">
      </div>
      <div class="col-md-3">
        <label class="form-label">Vehicle Number</label>
        <select class="form-select" id="vehicleFilter">
          <option value="">All Vehicles</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Trip Type</label>
        <select class="form-select" id="tripTypeFilter">
          <option value="">All Trips</option>
          <option value="with_empty">With Empty Return</option>
          <option value="without_empty">Standard Trips</option>
        </select>
      </div>
      <div class="col-md-1 d-flex align-items-end">
        <button class="btn btn-primary me-2" id="applyFiltersBtn">Filter</button>
      </div>
      <div class="col-md-1 d-flex align-items-end">
        <button class="btn btn-success" id="exportPdfBtn">PDF</button>
      </div>
    </div>

    <div class="table-responsive">
      <table id="expensesTable" class="table table-striped">
        <thead>
          <tr>
            <th>Empty</th>
            <th>Date</th>
            <th>Vehicle No</th>
            <th>LR No</th>
            <th>From</th>
            <th>To</th>
            <th class="text-end">Tyre Exp</th>
            <th class="text-end">Diesel Exp</th>
            <th class="text-end">Advance</th>
            <th class="text-end">Toll</th>
            <th class="text-end">Vehicle Work</th>
            <th class="text-end">Other Exp</th>
            <th class="text-end">Food Exp</th>
            <th class="text-end">Shortage Amt</th>
            <th class="text-end">Billing Amt</th>
            <th class="text-end">Total Exp</th>
            <th class="text-end">Profit</th>
          </tr>
        </thead>
        <tbody>
          </tbody>
        <tfoot>
          <tr>
            <th colspan="6" style="text-align:right;">Page Total:</th>
            <th class="text-end"></th>
            <th class="text-end"></th>
            <th class="text-end"></th>
            <th class="text-end"></th>
            <th class="text-end"></th>
            <th class="text-end"></th>
            <th class="text-end"></th>
            <th class="text-end"></th>
            <th class="text-end"></th>
            <th class="text-end"></th>
            <th class="text-end"></th>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <div class="modal fade" id="emptyTripModal" tabindex="-1" aria-labelledby="emptyTripModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="emptyTripModalLabel">Empty Return Trip Expenses</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="emptyTripForm">
            <input type="hidden" id="emptyTripId">

            <div class="card mb-3">
              <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-route me-2"></i>Trip Fuel Consumption</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-12 mb-3">
                    <label for="emptyRouteSelect" class="form-label">Route (From --> To)</label>
                    <select id="emptyRouteSelect" class="form-select"></select>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-3 mb-3"><label class="form-label">Distance (KM)</label><input type="number" id="emptyRouteDistanceKm" class="form-control" readonly placeholder="Auto"></div>
                  <div class="col-md-3 mb-3"><label class="form-label">Average (km/l)</label><input type="number" id="emptyVehicleAverage" class="form-control" placeholder="e.g., 4.0"></div>
                  <div class="col-md-3 mb-3"><label class="form-label">Rate/Liter (₹)</label><input type="number" id="emptyDieselRatePerLiter" class="form-control" placeholder="e.g., 95.50"></div>
                  <div class="col-md-3 mb-3"><label class="form-label">Fuel Used (L)</label><input type="number" id="emptyFuelUsedLiters" class="form-control bg-light" readonly></div>
                </div>
                <div class="row justify-content-end">
                  <div class="col-md-4"><label class="form-label">Diesel Amount (₹)</label><input type="number" id="emptyDieselExpenses" class="form-control bg-light" readonly></div>
                </div>
              </div>
            </div>
            
            <div class="card mb-3">
              <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-tools me-2"></i>Vehicle Work</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="emptyVehicleWorkVendor" class="form-label">Vehicle Work Vendor</label>
                    <select id="emptyVehicleWorkVendor" class="form-select">
                      <option value="">Select Vendor</option>
                    </select>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="emptyVehicleWork" class="form-label">Vehicle Work Amount (₹)</label>
                    <input type="number" class="form-control" id="emptyVehicleWork" step="0.01" min="0">
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-12 mb-3">
                    <label for="emptyVehicleWorkNotes" class="form-label">Vehicle Work Notes</label>
                    <textarea id="emptyVehicleWorkNotes" class="form-control" rows="2" placeholder="e.g., Engine oil change for empty return"></textarea>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="card mb-3">
              <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-money-bill-wave me-2"></i>Other Expenses</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="emptyTyreExpenses" class="form-label">Tyre Expenses (₹)</label>
                    <input type="number" class="form-control" id="emptyTyreExpenses" step="0.01" min="0">
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="emptyTollExpenses" class="form-label">Toll Expenses (₹)</label>
                    <input type="number" class="form-control" id="emptyTollExpenses" step="0.01" min="0">
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="emptyFoodExpenses" class="form-label">Food Expenses (₹)</label>
                    <input type="number" class="form-control" id="emptyFoodExpenses" step="0.01" min="0">
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="emptyOtherExpenses" class="form-label">Other Expenses (₹)</label>
                    <input type="number" class="form-control" id="emptyOtherExpenses" step="0.01" min="0">
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveEmptyTripBtn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="navbar-loader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDAlk_K8p8Of8Ne6Jpcl2QqXTtm95NgG7o",
      authDomain: "transport-dashboard-ad69a.firebaseapp.com",
      databaseURL: "https://transport-dashboard-ad69a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "transport-dashboard-ad69a",
      storageBucket: "transport-dashboard-ad69a.appspot.com",
      messagingSenderId: "526889676196",
      appId: "1:526889676196:web:66032c80a4aede690ae531",
      measurementId: "G-7F9R7HJYDH"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }

    const db = firebase.database();
    const auth = firebase.auth();

    // Global variables
    let expensesTable;
    let tripExpensesData = [];
    let lrData = [];
    let coreAccountId = null; // To store the correct data path
    let emptyTripModal;
    let allPetrolPumps = []; // Store all petrol pumps
    let emptyDieselPumpOptions = ''; // Store pump options for the modal
    let allWorkVendors = {}; // Store all work vendors for display/dropdowns

    // Initialize the page
    $(document).ready(function() {
      // First check authentication status
      auth.onAuthStateChanged((user) => {
        if (!user) {
          window.location.href = 'login.html';
        } else {
          // **FIX**: Determine the core account ID to fetch shared data
          getCoreAccountId(user.uid).then((id) => {
            coreAccountId = id;
            console.log("Core Account ID determined for trip expenses:", coreAccountId);
            loadWorkVendors(); // Load vendors first
            loadLRData();
            loadAllRoutes(); 
            loadAllPetrolPumps(user.uid); 
            // Load vehicles for Vehicle Fuel card in empty trip modal
            loadAllVehiclesForTE();
          });

          // Initialize Bootstrap modal
          emptyTripModal = new bootstrap.Modal(document.getElementById('emptyTripModal'));
          initializeDataTable();
          setupEventListeners();
          
          // Set default date range to current month
          const today = new Date();
          const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
          $('#fromDate').val(formatDateForInput(firstDay));
          $('#toDate').val(formatDateForInput(today));
        }
      });
    });

    // **NEW**: Load all routes from Firebase and populate the route dropdown
    function loadAllRoutes() {
      if (!coreAccountId) {
        console.warn('Routes cannot be loaded yet. coreAccountId not ready.');
        return;
      }

      const routeSelect = document.getElementById('emptyRouteSelect');
      if (!routeSelect) return;

      const routesRef = db.ref(`users/${coreAccountId}/routes`);
      routesRef.on('value', (snapshot) => {
        routeSelect.innerHTML = '<option value="">Select a Route for Empty Trip</option>';
        if (snapshot.exists()) {
          snapshot.forEach((child) => {
            const r = child.val() || {};
            const opt = document.createElement('option');
            opt.value = child.key;
            opt.textContent = `${r.from || '-'} --> ${r.to || '-'}`;
            if (r.distance !== undefined) {
              opt.dataset.distance = r.distance;
            }
            // Store from/to for detail display later
            opt.dataset.from = r.from || ''; 
            opt.dataset.to = r.to || ''; 
            routeSelect.appendChild(opt);
          });
        }
      });

      // Add event listeners to auto-calculate fuel usage
      routeSelect.addEventListener('change', recalcEmptyTripFuel);
      document.getElementById('emptyVehicleAverage').addEventListener('input', recalcEmptyTripFuel);
      document.getElementById('emptyDieselRatePerLiter').addEventListener('input', recalcEmptyTripFuel);
    }

    // **FIX/NEW**: Load work vendors for the empty trip modal and store them globally.
    function loadWorkVendors() {
        if (!coreAccountId) {
            console.warn('Work vendors cannot be loaded yet. coreAccountId not ready.');
            return;
        }
        const vendorsRef = db.ref(`users/${coreAccountId}/workVendors`);
        const select = document.getElementById('emptyVehicleWorkVendor');
        if (!select) return;

        vendorsRef.on('value', (snapshot) => {
            allWorkVendors = {}; // Reset global vendor list
            select.innerHTML = '<option value="">Select Vendor</option>';
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    const vendor = child.val();
                    allWorkVendors[child.key] = vendor; // Store vendor globally
                    const option = document.createElement('option');
                    option.value = child.key;
                    option.textContent = vendor.name;
                    select.appendChild(option);
                });
            }
        });
    }

    // **FIX**: Load all petrol pumps from Firebase using coreAccountId
    // Function now accepts the ID directly.
    function loadAllPetrolPumps(accountId) {
      // The old recursive check is removed for robustness.
      console.log("Loading petrol pumps from core account:", accountId);
      
      const pumpsRef = db.ref(`users/${accountId}/petrolPumps`);
      pumpsRef.on('value', (snapshot) => {
        allPetrolPumps = []; // Reset
        emptyDieselPumpOptions = '<option value="">Select Pump</option>'; // Reset
        
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const pump = child.val();
            // Store key, name, and place
            const pumpData = { 
              id: child.key, 
              name: pump.name, 
              place: pump.place || 'No location' 
            };
            allPetrolPumps.push(pumpData);
            
            // Build the options string
            emptyDieselPumpOptions += `<option value="${pump.name}" data-pump-id="${child.key}">${pump.name} - ${pump.place || 'No location'}</option>`;
          });
          console.log("✅ Successfully loaded petrol pumps:", allPetrolPumps.length);
        } else {
          emptyDieselPumpOptions += '<option value="" disabled>No pumps registered</option>';
          console.log("❌ No petrol pumps found");
        }
      }, (error) => {
        console.error("❌ Error loading petrol pumps:", error);
      });
    }

    // **FIX**: Helper function to get the core account ID for any user.
    // This ensures data is fetched from the correct shared path.
    async function getCoreAccountId(userId) {
        if (!userId) return null;
        
        try {
          // 1. Check for coreAccountId field in the root of the user node
          let userRef = db.ref(`users/${userId}`);
          let userSnap = await userRef.once('value');
          if (userSnap.exists()) {
              const userData = userSnap.val();
              if (userData.coreAccountId) {
                console.log("Found coreAccountId in user root:", userData.coreAccountId);
                return userData.coreAccountId;
              }
          }

          // 2. Check for coreAccountId field in the user/profile node
          const userProfileRef = db.ref(`users/${userId}/profile`);
          const userProfileSnap = await userProfileRef.once('value');
          if (userProfileSnap.exists()) {
              const profileData = userProfileSnap.val();
              if (profileData.coreAccountId) {
                console.log("Found coreAccountId in user profile:", profileData.coreAccountId);
                return profileData.coreAccountId;
              }
          }
          
          // 3. Check if this is a branch account by looking at accountType
          if (userSnap.exists()) {
            const userData = userSnap.val();
            if (userData.accountType === 'branch' && userData.coreAccountId) {
              console.log("Found coreAccountId in branch account:", userData.coreAccountId);
              return userData.coreAccountId;
            }
          }
          
          // 4. Fallback to user's own UID if no core ID is found (user is a core account)
          console.log("No coreAccountId found, using user's own UID:", userId);
          return userId; // Fallback
        } catch (error) {
          console.error("Error getting core account ID:", error);
          return userId; // Fallback
        }
    }

    // Format date for input field (YYYY-MM-DD)
    function formatDateForInput(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // Initialize DataTable
    function initializeDataTable() {
      expensesTable = $('#expensesTable').DataTable({
        pageLength: 10,
        lengthMenu: [10, 25, 50, 100, -1],
        order: [[1, 'desc']], // Changed to column 1 (Date) since we added a new first column
        columnDefs: [
          { className: "text-end", targets: [6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16] }
        ],
        footerCallback: function (row, data, start, end, display) {
          var api = this.api();

          // Helper function to parse currency and sum
          var intVal = function (i) {
            return typeof i === 'string' ?
              parseFloat(i.replace(/<[^>]*>/g, '').replace(/[₹,]/g, '')) || 0 :
              typeof i === 'number' ? i : 0;
          };

          // Calculate totals for all visible rows on the current page
          for (let i = 6; i <= 16; i++) {
            const pageTotal = api
              .column(i, { page: 'current' })
              .data()
              .reduce(function (a, b) {
                return intVal(a) + intVal(b);
              }, 0);
            $(api.column(i).footer()).html(formatCurrency(pageTotal));
          }
        }
      });
    }

    // Setup event listeners
    function setupEventListeners() {
      // Filter button click
      $('#applyFiltersBtn').on('click', function() {
        applyFilters();
      });

      // Export PDF button click
      $('#exportPdfBtn').on('click', function() {
        exportToPDF();
      });

      // Save empty trip button click
      $('#saveEmptyTripBtn').on('click', function() {
        saveEmptyTrip();
      });

      // Add event listener for opening and closing details
      $('#expensesTable tbody').on('click', 'td.details-control', function () {
        handleDetailRowClick(this);
      });
    }

    // Load LR data from Firebase
    function loadLRData() {
      const user = auth.currentUser;
      // **FIX**: Ensure coreAccountId is available before attempting to load data
      if (!user || !coreAccountId) { 
        console.error('No authenticated user or coreAccountId found. Retrying in 500ms...');
        setTimeout(loadLRData, 500); // Retry after a short delay
        return;
      }
      
      const lrRef = db.ref(`users/${coreAccountId}/lrReports`); // **FIX**: Use coreAccountId
      lrRef.on('value', (snapshot) => {
        lrData = [];
        const data = snapshot.val() || {};
        
        if (data) {
          Object.keys(data).forEach(key => {
            lrData.push({ id: key, ...data[key] });
          });
          
          // Process LR data for trip expenses
          processLRDataForExpenses();
          
          // Populate the table
          populateTable();
          
          // Update vehicle filter dropdown
          updateVehicleFilter();
          
          // Update summary cards
          updateSummaryCards();
        } else {
          // No LR data found
          expensesTable.clear().draw();
          updateSummaryCards();
        }
      }, (error) => {
        console.error('Error loading LR data:', error);
      });
    }

    // Process LR data for trip expenses display
    function processLRDataForExpenses() {
      tripExpensesData = lrData.map(lr => {
        // **FIX**: Prioritize the new `fuelUsedAmountINR` from `fuelTracking` for diesel cost.
        // This value is now calculated in lr-report.html.
        const fuelUsedAmount = lr.fuelTracking && lr.fuelTracking.fuelUsedAmountINR
          ? parseFloat(lr.fuelTracking.fuelUsedAmountINR) : 0;
        // Fallback to older `dieselExpenses` field for backward compatibility.
        const dieselLegacyAmount = (lr.dieselPurchaseAmount !== undefined)
          ? (parseFloat(lr.dieselPurchaseAmount) || 0) : (parseFloat(lr.dieselExpenses) || 0);
        // Use the new `fuelUsedAmount` if available, otherwise use the legacy amount.
        const dieselForCalc = fuelUsedAmount > 0 ? fuelUsedAmount : dieselLegacyAmount;

        // Compute liters used for display (prefer actual used liters, fallback to purchased liters)
        let dieselUsedLiters = 0;
        if (lr.fuelTracking && lr.fuelTracking.fuelUsedLiters !== undefined) {
          dieselUsedLiters = parseFloat(lr.fuelTracking.fuelUsedLiters) || 0;
        }
        if (!dieselUsedLiters) {
          let purchasedLiters = 0;
          if (Array.isArray(lr.dieselEntries) && lr.dieselEntries.length > 0) {
            purchasedLiters = lr.dieselEntries.reduce((s, e) => s + (parseFloat(e.liters) || 0), 0);
          } else if (lr.dieselLiters !== undefined) {
            purchasedLiters = parseFloat(lr.dieselLiters) || 0;
          }
          dieselUsedLiters = purchasedLiters;
        }

        // Calculate total expenses (main trip only) EXCLUDING shortage amount (added at display time)
        const totalExpenses = 
          (parseFloat(lr.tyreExpenses) || 0) + // Correct
          dieselForCalc +
          (parseFloat(lr.tollExpenses) || 0) + // Correct
          (parseFloat(lr.vehicleWorkAmount) || 0) + // FIX: Changed from lr.vehicleWork
          (parseFloat(lr.otherExpenses) || 0) +
          (parseFloat(lr.foodExpenses) || 0) +
          (parseFloat(lr.advance) || 0);
        
        // **FIX**: Calculate shortage deduction based on the LR's specific billing rate.
        // The shortage value is stored in KG, so convert it to tonnes before multiplying.
        const shortageDeduction = ((parseFloat(lr.shortage) || 0) / 1000) * (parseFloat(lr.billingRate) || 0);

        // Calculate profit (main trip only)
        const profit = (parseFloat(lr.billingAmount) || 0) - totalExpenses;
        
        // Check if this trip has empty return trip data
        const hasEmptyTrip = lr.emptyTrip || false;
        const emptyTripData = lr.emptyTripData || {};
        
        return {
          id: lr.id,
          date: lr.date,
          vehicleNumber: lr.truckNumber,
          lrNumber: lr.lrNumber,
          from: lr.fromLocation,
          to: lr.toLocation,
          tyreExpenses: parseFloat(lr.tyreExpenses) || 0,
          dieselExpenses: dieselForCalc,
          dieselUsedLiters: dieselUsedLiters,
          dieselPumpName: lr.dieselPumpName || '', // **FIX**: Include main trip diesel pump name
          advancePaid: parseFloat(lr.advance) || 0,
          tollPaid: parseFloat(lr.tollExpenses) || 0,
          vehicleWork: parseFloat(lr.vehicleWorkAmount) || 0, // FIX: Changed from lr.vehicleWork
          otherExpenses: parseFloat(lr.otherExpenses) || 0,
          foodExpenses: parseFloat(lr.foodExpenses) || 0,
          shortageAmount: shortageDeduction,
          freightAmount: parseFloat(lr.billingAmount) || 0, // Use billingAmount for display
          totalExpenses: totalExpenses,
          profit: profit,
          hasEmptyTrip: hasEmptyTrip,
          emptyTripData: emptyTripData
        };
      });
    }

    // Populate the table with trip expenses data
    function populateTable() {
      expensesTable.clear();
      
      tripExpensesData.forEach(expense => {
        const profitClass = expense.profit >= 0 ? 'profit-positive' : 'profit-negative';
        
        // Check if this row should be marked as empty trip
        const rowClass = expense.hasEmptyTrip ? 'empty-trip-row' : '';
        
        // Create the control for the first column
        const firstColumnControl = expense.hasEmptyTrip
          ? '' // The td will have the details-control class for the icon
          : `<button class="btn btn-sm btn-outline-secondary" title="Add Empty Return Expenses" onclick="addEmptyTrip('${expense.id}')">
               <i class="fas fa-plus"></i>
             </button>`;

        // Calculate values to display (include empty trip expenses if applicable)
        const displayTyreExpenses = expense.hasEmptyTrip 
          ? (expense.tyreExpenses + (parseFloat(expense.emptyTripData.tyreExpenses) || 0))
          : expense.tyreExpenses;
          
        // Build diesel expenses display (currency) with pump names
        const emptyDieselAmount = parseFloat(expense.emptyTripData.dieselExpenses) || 0;
        const displayDieselExpenses = expense.hasEmptyTrip 
          ? (expense.dieselExpenses + emptyDieselAmount)
          : expense.dieselExpenses;
        const combinedDieselDisplay = expense.hasEmptyTrip 
          ? `${formatCurrency(displayDieselExpenses)} <small class="text-muted d-block">${expense.dieselPumpName || ''} + ${expense.emptyTripData.dieselPumpName || 'Empty Trip'}</small>`
          : `${formatCurrency(displayDieselExpenses)} <small class="text-muted d-block">${expense.dieselPumpName || ''}</small>`;

        const displayTollPaid = expense.hasEmptyTrip 
          ? (expense.tollPaid + (parseFloat(expense.emptyTripData.tollExpenses) || 0))
          : expense.tollPaid;
          
        const emptyVehicleWorkAmount = parseFloat(expense.emptyTripData.vehicleWorkAmount) || 0; // Use the correct field name
        const displayVehicleWork = expense.hasEmptyTrip
          ? (expense.vehicleWork + emptyVehicleWorkAmount)
          : expense.vehicleWork;

        const displayOtherExpenses = expense.hasEmptyTrip 
          ? (expense.otherExpenses + (parseFloat(expense.emptyTripData.otherExpenses) || 0))
          : expense.otherExpenses;
          
        const displayFoodExpenses = expense.hasEmptyTrip 
          ? (expense.foodExpenses + (parseFloat(expense.emptyTripData.foodExpenses) || 0))
          : expense.foodExpenses;
        
        // Recalculate total expenses and profit with empty trip data
        const displayTotalExpenses = expense.hasEmptyTrip 
          ? (expense.totalExpenses + 
             (parseFloat(expense.emptyTripData.tyreExpenses) || 0) +
             emptyDieselAmount +
             (parseFloat(expense.emptyTripData.tollExpenses) || 0) +
             emptyVehicleWorkAmount +
             (parseFloat(expense.emptyTripData.otherExpenses) || 0) +
             (parseFloat(expense.emptyTripData.foodExpenses) || 0))
          : expense.totalExpenses;

        // Add shortage amount to display total (it's not part of empty trip data)
        const finalDisplayTotalExpenses = displayTotalExpenses + (parseFloat(expense.shortageAmount) || 0);
          
        const displayProfit = expense.freightAmount - finalDisplayTotalExpenses;
          
        const displayProfitClass = displayProfit >= 0 ? 'profit-positive' : 'profit-negative';
        
        const row = [
          firstColumnControl,
          formatDate(expense.date),
          expense.vehicleNumber,
          expense.lrNumber,
          expense.from,
          expense.to,
          formatCurrency(displayTyreExpenses),
          combinedDieselDisplay, // Show currency and pump name(s)
          formatCurrency(expense.advancePaid),
          formatCurrency(displayTollPaid),
          formatCurrency(displayVehicleWork),
          formatCurrency(displayOtherExpenses),
          formatCurrency(displayFoodExpenses),
          formatCurrency(expense.shortageAmount),
          formatCurrency(expense.freightAmount),
          formatCurrency(finalDisplayTotalExpenses),
          `<span class="${displayProfitClass}">${formatCurrency(displayProfit)}</span>`
        ];
        
        const addedRow = expensesTable.row.add(row).node();
        addedRow.className = rowClass;
        
        // If it has an empty trip, add the details-control class to the first cell
        if (expense.hasEmptyTrip) {
          $(addedRow).find('td:first').addClass('details-control');
          $(addedRow).data('expense-details', expense); // Store details on the row
        }
      });
      
      expensesTable.draw();
    }

    // Update vehicle filter dropdown
    function updateVehicleFilter() {
      const vehicleFilter = $('#vehicleFilter');
      const vehicles = [...new Set(tripExpensesData.map(expense => expense.vehicleNumber))].sort();
      
      // Clear existing options except the first one
      vehicleFilter.find('option:not(:first)').remove();
      
      // Add vehicle options
      vehicles.forEach(vehicle => {
        if (vehicle) {
          vehicleFilter.append(`<option value="${vehicle}">${vehicle}</option>`);
        }
      });
    }

    // Update summary cards
    function updateSummaryCards() {
      const totalBilling = tripExpensesData.reduce((sum, expense) => 
        sum + (parseFloat(expense.freightAmount) || 0), 0);
      
      const totalExpenses = tripExpensesData.reduce((sum, expense) => {
        let expenseTotal = expense.totalExpenses + (parseFloat(expense.shortageAmount) || 0);
        // Include empty trip expenses in the sum
        if (expense.hasEmptyTrip) {
          const emptyData = expense.emptyTripData;
          expenseTotal += 
            (parseFloat(emptyData.tyreExpenses) || 0) +
            (parseFloat(emptyData.dieselExpenses) || 0) +
            (parseFloat(emptyData.tollExpenses) || 0) +
            (parseFloat(emptyData.vehicleWorkAmount) || 0) + // Use correct field
            (parseFloat(emptyData.otherExpenses) || 0) +
            (parseFloat(emptyData.foodExpenses) || 0);
        }
        return sum + expenseTotal;
      }, 0);
      
      const totalProfit = totalBilling - totalExpenses;
      
      // Calculate diesel expenses (currency)
      const totalDiesel = tripExpensesData.reduce((sum, expense) => {
        let dieselTotal = expense.dieselExpenses || 0;
        if (expense.hasEmptyTrip) {
          dieselTotal += (parseFloat(expense.emptyTripData.dieselExpenses) || 0);
        }
        return sum + dieselTotal;
      }, 0);
      
      // Calculate other expenses (tyre + toll + vehicle work + other + food)
      const totalOtherExp = tripExpensesData.reduce((sum, expense) => {
        let otherTotal = 
          (expense.tyreExpenses || 0) +
          (expense.tollPaid || 0) +
          (expense.vehicleWork || 0) +
          (expense.otherExpenses || 0) +
          (expense.foodExpenses || 0);
          
        if (expense.hasEmptyTrip) {
          const emptyData = expense.emptyTripData;
          otherTotal += 
            (parseFloat(emptyData.tyreExpenses) || 0) +
            (parseFloat(emptyData.tollExpenses) || 0) +
            (parseFloat(emptyData.vehicleWorkAmount) || 0) + // Use correct field
            (parseFloat(emptyData.otherExpenses) || 0) +
            (parseFloat(emptyData.foodExpenses) || 0);
        }
        return sum + otherTotal;
      }, 0);
      
      $('#totalBilling').text(formatCurrency(totalBilling));
      $('#totalExpenses').text(formatCurrency(totalExpenses));
      $('#totalProfit').text(formatCurrency(totalProfit));
      $('#tripsCount').text(tripExpensesData.length);
      $('#totalDiesel').text(formatCurrency(totalDiesel));
      $('#totalOtherExp').text(formatCurrency(totalOtherExp));
    }

    // Apply filters to the table
    function applyFilters() {
      const fromDate = $('#fromDate').val();
      const toDate = $('#toDate').val();
      const vehicle = $('#vehicleFilter').val();
      const tripType = $('#tripTypeFilter').val();

      // Use DataTables custom search function for filtering
      $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
        // Ensure we are targeting the correct table
        if (settings.nTable.id !== 'expensesTable') {
          return true;
        }

        const rowDate = new Date(data[1].split('/').reverse().join('-')); // Convert DD/MM/YYYY to YYYY-MM-DD for comparison
        const rowVehicle = data[2] || '';
        
        // Check if the row has an empty trip. We can check for the details-control class on the first cell.
        const rowNode = expensesTable.row(dataIndex).node();
        const hasEmptyTrip = $(rowNode).find('td:first').hasClass('details-control');
        
        // Date filter
        let datePass = true;
        if (fromDate) {
          const filterFromDate = new Date(fromDate);
          datePass = datePass && rowDate >= filterFromDate;
        }
        if (toDate) {
          const filterToDate = new Date(toDate);
          filterToDate.setHours(23, 59, 59, 999); // End of the day
          datePass = datePass && rowDate <= filterToDate;
        }
        
        // Vehicle filter
        const vehiclePass = !vehicle || rowVehicle === vehicle;
        
        // Trip type filter
        let tripTypePass = true;
        if (tripType === 'with_empty') {
          tripTypePass = hasEmptyTrip;
        } else if (tripType === 'without_empty') {
          tripTypePass = !hasEmptyTrip;
        }
        
        return datePass && vehiclePass && tripTypePass;
      });
      
      // Redraw the table to apply filters
      expensesTable.draw();
      
      // Remove the custom filter function after drawing to avoid stacking
      $.fn.dataTable.ext.search.pop();
      
      // Update summary cards with filtered data
      updateFilteredSummaryCards();
    }

    // Update summary cards with filtered data
    function updateFilteredSummaryCards() {
      const filteredData = expensesTable.rows({ filter: 'applied' }).data().toArray();
      
      let filteredBilling = 0;
      let filteredExpenses = 0;
      let filteredDiesel = 0;
      let filteredOtherExp = 0;
      
      filteredData.forEach(row => {
        // Extract numeric values from the formatted strings in the table
        filteredBilling += parseCurrency(row[14]); // Billing Amount column
        filteredExpenses += parseCurrency(row[15]); // Total Expenses column
        
        // For diesel (liters), parse only the first number from the cell text
        // NOTE: This summary is inaccurate as it parses *liters* from an expense *amount* column.
        // It's a legacy issue in the HTML structure. We'll leave it as is to maintain original behavior,
        // but note that row[7] is a CURRENCY column now.
        const dieselCurrency = parseCurrency(row[7]);
        filteredDiesel += dieselCurrency; // Using currency amount for total diesel summary
        
        // Other expenses: tyre + toll + vehicle work + other + food
        filteredOtherExp += 
          parseCurrency(row[6]) +  // Tyre
          parseCurrency(row[9]) +  // Toll
          parseCurrency(row[10]) + // Vehicle Work
          parseCurrency(row[11]) + // Other
          parseCurrency(row[12]);  // Food
      });
      
      const filteredProfit = filteredBilling - filteredExpenses;
      
      $('#totalBilling').text(formatCurrency(filteredBilling));
      $('#totalExpenses').text(formatCurrency(filteredExpenses));
      $('#totalProfit').text(formatCurrency(filteredProfit));
      $('#tripsCount').text(filteredData.length);
      $('#totalDiesel').text(formatCurrency(filteredDiesel)); // Displaying currency, not liters, as the column is currency
      $('#totalOtherExp').text(formatCurrency(filteredOtherExp));
    }

    // Export to PDF
    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Add title
      doc.setFontSize(16);
      doc.text('Trip Expenses Report', 14, 15);
      
      // Add date range
      const fromDate = $('#fromDate').val() || 'N/A';
      const toDate = $('#toDate').val() || 'N/A';
      doc.setFontSize(10);
      doc.text(`Date Range: ${fromDate} to ${toDate}`, 14, 22);
      
      // Get filtered data
      const filteredData = expensesTable.rows({ filter: 'applied' }).data().toArray();
      
      // Prepare table data
      const tableData = filteredData.map(row => {
        // Extract just the numeric values for the PDF (remove HTML formatting)
        return [
          row[1], // Date
          row[2], // Vehicle No
          row[3], // LR No
          row[4], // From
          row[5], // To
          parseCurrency(row[6]).toFixed(2), // Tyre
          parseCurrency($('<div>').html(row[7]).text().split('\n')[0]).toFixed(2), // Diesel (get only the amount)
          parseCurrency(row[8]).toFixed(2), // Advance
          parseCurrency(row[9]).toFixed(2), // Toll
          parseCurrency(row[10]).toFixed(2), // Vehicle Work
          parseCurrency(row[11]).toFixed(2), // Other
          parseCurrency(row[12]).toFixed(2), // Food
          parseCurrency(row[13]).toFixed(2), // Shortage
          parseCurrency(row[14]).toFixed(2), // Billing
          parseCurrency(row[15]).toFixed(2), // Total Exp
          parseCurrency(row[16]).toFixed(2)  // Profit
        ];
      });
      
      // Add table
      doc.autoTable({
        startY: 30,
        head: [['Date', 'Vehicle', 'LR No', 'From', 'To', 'Tyre', 'Diesel', 'Advance', 'Toll', 'V.Work', 'Other', 'Food', 'Shortage', 'Billing', 'Total Exp', 'Profit']],
        body: tableData,
        styles: { fontSize: 8 },
        headStyles: { fillColor: [41, 128, 185] }
      });
      
      // Add summary
      const finalY = doc.lastAutoTable.finalY + 10;
      doc.setFontSize(10);
      doc.text(`Total Trips: ${filteredData.length}`, 14, finalY);
      doc.text(`Total Billing: ₹${filteredData.reduce((sum, row) => sum + parseCurrency(row[14]), 0).toFixed(2)}`, 14, finalY + 5);
      doc.text(`Total Expenses: ₹${filteredData.reduce((sum, row) => sum + parseCurrency(row[15]), 0).toFixed(2)}`, 14, finalY + 10);
      doc.text(`Total Profit: ₹${(filteredData.reduce((sum, row) => sum + parseCurrency(row[14]), 0) - filteredData.reduce((sum, row) => sum + parseCurrency(row[15]), 0)).toFixed(2)}`, 14, finalY + 15);
      
      // Save the PDF
      doc.save(`trip-expenses-${fromDate}-to-${toDate}.pdf`);
    }

    // Add empty trip expenses
    let te_allVehicles = [];

    function loadAllVehiclesForTE() {
      if (!coreAccountId) return;
      const vref = db.ref(`users/${coreAccountId}/vehicles`);
      vref.on('value', (snap) => {
        te_allVehicles = [];
        if (snap.exists()) {
          snap.forEach(child => {
            const v = child.val() || {};
            te_allVehicles.push({ id: child.key, ...v });
          });
        }
      });
    }

    // **NEW**: Recalculate fuel usage and cost for the empty trip modal
    function recalcEmptyTripFuel() {
      const routeSelect = document.getElementById('emptyRouteSelect');
      const selectedOption = routeSelect.options[routeSelect.selectedIndex];
      const distance = parseFloat(selectedOption.dataset.distance) || 0;
      const average = parseFloat(document.getElementById('emptyVehicleAverage').value) || 0;
      const rate = parseFloat(document.getElementById('emptyDieselRatePerLiter').value) || 0;

      document.getElementById('emptyRouteDistanceKm').value = distance.toFixed(2);
      const fuelUsed = average > 0 ? (distance / average) : 0;
      document.getElementById('emptyFuelUsedLiters').value = fuelUsed.toFixed(2);
      document.getElementById('emptyDieselExpenses').value = (fuelUsed * rate).toFixed(2);
    }

    window.addEmptyTrip = function(lrId) {
      const expense = tripExpensesData.find(e => e.id === lrId);
      if (expense) {
        $('#emptyTripId').val(lrId);
        
        // Clear previous values
        // Note: No emptyDieselEntriesContainer exists, so no need to clear dynamic entries
        $('#emptyTyreExpenses').val('');
        $('#emptyTollExpenses').val('');
        $('#emptyVehicleWork').val('');
        $('#emptyOtherExpenses').val('');
        $('#emptyFoodExpenses').val('');
        // New Vehicle Work fields
        $('#emptyVehicleWorkVendor').val('');
        $('#emptyVehicleWorkNotes').val('');

        // **NEW**: Clear fuel consumption fields
        $('#emptyRouteSelect').val('');
        $('#emptyRouteDistanceKm').val('');
        $('#emptyVehicleAverage').val('');
        $('#emptyDieselRatePerLiter').val('');
        $('#emptyFuelUsedLiters').val('');

        // Show the modal
        emptyTripModal.show();

        // Load vehicle and pre-fill average
        const vehicleNo = expense.vehicleNumber || '';
        const veh = te_allVehicles.find(v => getVehicleNumberField(v).toUpperCase() === vehicleNo.toUpperCase()) || null;
        // **NEW**: Pre-fill average from vehicle data if available
        document.getElementById('emptyVehicleAverage').value = veh?.average || '';
        
        // Initial calculation to clear auto-fields
        recalcEmptyTripFuel();
      }
    }

    // Save empty trip expenses
    function saveEmptyTrip() {
      const lrId = $('#emptyTripId').val();
      const tyreExpenses = parseFloat($('#emptyTyreExpenses').val()) || 0;
      const tollExpenses = parseFloat($('#emptyTollExpenses').val()) || 0;
      const vehicleWorkAmount = parseFloat($('#emptyVehicleWork').val()) || 0;
      const otherExpenses = parseFloat($('#emptyOtherExpenses').val()) || 0;
      const foodExpenses = parseFloat($('#emptyFoodExpenses').val()) || 0;
      const vehicleWorkVendorId = $('#emptyVehicleWorkVendor').val();
      const vehicleWorkVendorName = $('#emptyVehicleWorkVendor option:selected').text();
      const vehicleWorkNotes = $('#emptyVehicleWorkNotes').val();

      // **NEW**: Get fuel consumption data
      const routeSelect = document.getElementById('emptyRouteSelect');
      const selectedRoute = routeSelect.options[routeSelect.selectedIndex];
      const routeId = selectedRoute.value;
      const routeDistanceKm = parseFloat(document.getElementById('emptyRouteDistanceKm').value) || 0;
      const vehicleAverage = parseFloat(document.getElementById('emptyVehicleAverage').value) || 0;
      const dieselRatePerLiter = parseFloat(document.getElementById('emptyDieselRatePerLiter').value) || 0;
      const fuelUsedLiters = parseFloat(document.getElementById('emptyFuelUsedLiters').value) || 0;
      const dieselExpenses = parseFloat(document.getElementById('emptyDieselExpenses').value) || 0;

      // Prepare empty trip data (diesel handled centrally via Vehicle Fuel card)
      const emptyTripData = {
        tyreExpenses: tyreExpenses,
        dieselExpenses: dieselExpenses, 
        tollExpenses: tollExpenses,
        vehicleWork: vehicleWorkAmount, // Legacy field
        vehicleWorkAmount: vehicleWorkAmount, // Corrected field name
        vehicleWorkVendorId: vehicleWorkVendorId,
        vehicleWorkVendorName: vehicleWorkVendorName,
        vehicleWorkNotes: vehicleWorkNotes,
        otherExpenses: otherExpenses,
        foodExpenses: foodExpenses,
        // Fuel Consumption Data
        routeId: routeId,
        routeDistanceKm: routeDistanceKm,
        vehicleAverage: vehicleAverage,
        dieselRatePerLiter: dieselRatePerLiter,
        fuelUsedLiters: fuelUsedLiters
      };
      
      // **NEW**: Deduct used fuel from the vehicle's master record (Only if new data is saved)
      if (fuelUsedLiters > 0) {
        const expense = tripExpensesData.find(e => e.id === lrId);
        if (expense) {
          const vehicleNo = expense.vehicleNumber || '';
          const veh = te_allVehicles.find(v => getVehicleNumberField(v).toUpperCase() === vehicleNo.toUpperCase()) || null;
          if (veh) {
            const vRef = db.ref(`users/${coreAccountId}/vehicles/${veh.id}`);
            // Check if there was existing empty trip data to calculate the delta
            const existingUsed = (expense.emptyTripData?.fuelUsedLiters || 0);
            const delta = fuelUsedLiters - existingUsed;

            if (delta !== 0) { // Only update if fuel consumption changed
                vRef.child('currentFuel').once('value').then(curSnap => {
                  const before = parseFloat(curSnap.val()) || 0;
                  const after = Math.max(0, before - delta);
                  vRef.child('currentFuel').set(after);
                  // Log this usage
                  vRef.child('fuelLogs').push({
                    timestamp: new Date().toISOString(),
                    source: 'trip-expenses-empty-usage-update',
                    lrNumber: expense.lrNumber || '',
                    usedLitersDelta: delta,
                    newUsedLiters: fuelUsedLiters,
                    oldUsedLiters: existingUsed,
                    beforeLiters: before,
                    afterLiters: after,
                    details: 'Fuel used for empty return trip (update).'
                  });
                });
            }
          } else {
            console.warn("Could not find vehicle to deduct fuel from.");
          }
        }
      }

      // Update Firebase
      const user = auth.currentUser;
      if (user && coreAccountId) { // **FIX**: Use coreAccountId
        const lrRef = db.ref(`users/${coreAccountId}/lrReports/${lrId}`); // **FIX**: Use coreAccountId
        lrRef.update({
          emptyTrip: true,
          emptyTripData: emptyTripData
        }).then(() => {
          // Close modal and refresh data
          emptyTripModal.hide();
          loadLRData(); // Reload data to reflect changes
          showToast('Empty trip expenses saved successfully!', 'success');
        }).catch(error => {
          console.error('Error saving empty trip expenses:', error);
          showToast('Error saving empty trip expenses!', 'error');
        });
      }
    }

    // Handle detail row click for empty trips
    function handleDetailRowClick(cell) {
      const tr = $(cell).closest('tr');
      const row = expensesTable.row(tr);
      const expense = $(tr).data('expense-details');
      
      if (row.child.isShown()) {
        // This row is already open - close it
        row.child.hide();
        tr.removeClass('details');
      } else {
        // Open this row
        const emptyTripData = expense.emptyTripData || {};
        const totalEmptyExpenses = 
            (emptyTripData.tyreExpenses || 0) +
            (emptyTripData.dieselExpenses || 0) +
            (emptyTripData.tollExpenses || 0) +
            (emptyTripData.vehicleWorkAmount || 0) + // Use correct field
            (emptyTripData.otherExpenses || 0) +
            (emptyTripData.foodExpenses || 0);
        
        const vendorName = emptyTripData.vehicleWorkVendorName || (emptyTripData.vehicleWorkVendorId ? allWorkVendors[emptyTripData.vehicleWorkVendorId]?.name : 'N/A');
        const workNotes = emptyTripData.vehicleWorkNotes || '—';

        const childHtml = `
          <div class="child-row-container">
            <h6 class="mb-3">Empty Return Trip Expenses</h6>
            <table class="child-row-table">
              <tr>
                <th>Expense Type</th>
                <th>Amount</th>
                <th>Details</th>
              </tr>
              <tr>
                <td>Tyre Expenses</td>
                <td>₹${formatCurrency(emptyTripData.tyreExpenses || 0)}</td>
                <td>-</td>
              </tr>
              <tr>
                <td>Diesel Expenses</td>
                <td>₹${formatCurrency(emptyTripData.dieselExpenses || 0)}</td>
                <td>${(emptyTripData.fuelUsedLiters || 0).toFixed(2)} L @ ₹${(emptyTripData.dieselRatePerLiter || 0).toFixed(2)}/L (Route: ${emptyTripData.routeDistanceKm || 0} km, Avg: ${emptyTripData.vehicleAverage || 0} km/l)</td>
              </tr>
              <tr>
                <td>Toll Expenses</td>
                <td>₹${formatCurrency(emptyTripData.tollExpenses || 0)}</td>
                <td>-</td>
              </tr>
              <tr>
                <td>Vehicle Work</td>
                <td>₹${formatCurrency(emptyTripData.vehicleWorkAmount || 0)}</td>
                <td>Vendor: ${vendorName}, Notes: ${workNotes}</td>
              </tr>
              <tr>
                <td>Other Expenses</td>
                <td>₹${formatCurrency(emptyTripData.otherExpenses || 0)}</td>
                <td>-</td>
              </tr>
              <tr>
                <td>Food Expenses</td>
                <td>₹${formatCurrency(emptyTripData.foodExpenses || 0)}</td>
                <td>-</td>
              </tr>
              <tr>
                <td><strong>Total Empty Trip Expenses</strong></td>
                <td><strong>₹${formatCurrency(totalEmptyExpenses)}</strong></td>
                <td>-</td>
              </tr>
            </table>
            <div class="mt-3">
              <button class="btn btn-sm btn-warning" onclick="editEmptyTrip('${expense.id}')">
                <i class="fas fa-edit me-1"></i>Edit Empty Trip
              </button>
            </div>
          </div>
        `;
        
        row.child(childHtml).show();
        tr.addClass('details');
      }
    }

    // Edit empty trip
    // **FIXED**: This function now correctly populates the Trip Fuel Consumption card.
    window.editEmptyTrip = function(lrId) {
      const expense = tripExpensesData.find(e => e.id === lrId);
      if (expense && expense.emptyTripData) {
        const emptyData = expense.emptyTripData;
        
        $('#emptyTripId').val(lrId);
        
        // Populate Other Expenses
        $('#emptyTyreExpenses').val(emptyData.tyreExpenses || '');
        $('#emptyTollExpenses').val(emptyData.tollExpenses || '');
        $('#emptyOtherExpenses').val(emptyData.otherExpenses || '');
        $('#emptyFoodExpenses').val(emptyData.foodExpenses || '');

        // Populate Vehicle Work Card
        $('#emptyVehicleWork').val(emptyData.vehicleWorkAmount || emptyData.vehicleWork || '');
        $('#emptyVehicleWorkVendor').val(emptyData.vehicleWorkVendorId || '');
        $('#emptyVehicleWorkNotes').val(emptyData.vehicleWorkNotes || '');
        
        // Populate the Trip Fuel Consumption card (THE FIX)
        $('#emptyRouteSelect').val(emptyData.routeId || '');
        $('#emptyRouteDistanceKm').val(emptyData.routeDistanceKm || '');
        $('#emptyVehicleAverage').val(emptyData.vehicleAverage || '');
        $('#emptyDieselRatePerLiter').val(emptyData.dieselRatePerLiter || '');
        $('#emptyFuelUsedLiters').val(emptyData.fuelUsedLiters || '');
        $('#emptyDieselExpenses').val(emptyData.dieselExpenses || '');

        // Recalculate to ensure consistency, especially the auto-calculated fields.
        recalcEmptyTripFuel();
        
        emptyTripModal.show();
      }
    }

    // Utility functions
  function getVehicleNumberField(v) {
    return (v?.vehicleNumber || v?.vehicleNo || v?.number || '').toString();
  }
    function formatCurrency(amount) {
      return parseFloat(amount || 0).toLocaleString('en-IN', {
        style: 'currency',
        currency: 'INR',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    function formatLiters(amount) {
      const n = parseFloat(amount || 0);
      return n.toLocaleString('en-IN', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }) + ' L';
    }

    function parseCurrency(currencyString) {
      if (typeof currencyString === 'number') return currencyString;
      const numericString = String(currencyString).replace(/[^0-9.-]+/g, '');
      return parseFloat(numericString) || 0;
    }

    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }

    function showToast(message, type = 'info') {
      // You can implement a toast notification here if needed
      alert(`${type.toUpperCase()}: ${message}`);
    }
  </script>
</body>
</html>         
