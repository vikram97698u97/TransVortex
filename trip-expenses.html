<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trip Expenses - Transport System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <style>
    body { padding: 0; margin: 0; background-color: #f8f9fa; }
    .tab-content { background: white; padding: 20px; border-radius: 0 0 8px 8px; }
    .profit-positive { color: green; font-weight: bold; }
    .profit-negative { color: red; font-weight: bold; }
    .summary-card { border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .empty-trip-row { background-color: #ffebee !important; }
    .empty-btn { background: none; border: none; color: #dc3545; cursor: pointer; }
    .empty-btn:hover { color: #c82333; }
    .modal-backdrop { z-index: 1040; }
    .modal { z-index: 1050; }
    /* Styles for child row */
    td.details-control {
        background: url('https://datatables.net/examples/resources/details_open.png') no-repeat center center;
        cursor: pointer;
    }
    tr.details td.details-control {
        background: url('https://datatables.net/examples/resources/details_close.png') no-repeat center center;
    }
    .child-row-table {
      width: 100%;
      margin: 10px 0;
    }
    .child-row-table th, .child-row-table td {
      padding: 8px;
      border: 1px solid #e0e0e0;
    }
    .child-row-table th {
      background-color: #f2f2f2;
      font-weight: 600;
    }
    .child-row-container {
      padding: 10px 20px;
    }
    .card-value {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 0.25rem;
    }
    .card-label {
      font-size: 0.875rem;
      color: #6c757d;
    }
    .card-icon {
      font-size: 2rem;
      opacity: 0.7;
    }
  </style>
    <!-- Load secure configuration first -->
  <script src="evm.js"></script>
  <script src="config-loader.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

  <div id="navbar-placeholder"></div>

  <div class="container">
    <h2 class="mb-4"><i class="fas fa-money-bill-wave me-2"></i>Trip Expenses</h2>
    
    <div class="row mb-4">
      <div class="col-md-2 mb-3">
        <div class="card summary-card border-primary">
          <div class="card-body text-center">
            <div class="card-icon text-primary mb-2">
              <i class="fas fa-file-invoice-dollar"></i>
            </div>
            <div class="card-value text-primary" id="totalBilling">₹0.00</div>
            <div class="card-label">Total Billing</div>
          </div>
        </div>
      </div>
      <div class="col-md-2 mb-3">
        <div class="card summary-card border-info">
          <div class="card-body text-center">
            <div class="card-icon text-info mb-2">
              <i class="fas fa-money-bill-wave"></i>
            </div>
            <div class="card-value text-info" id="totalExpenses">₹0.00</div>
            <div class="card-label">Total Expenses</div>
          </div>
        </div>
      </div>
      <div class="col-md-2 mb-3">
        <div class="card summary-card border-success">
          <div class="card-body text-center">
            <div class="card-icon text-success mb-2">
              <i class="fas fa-chart-line"></i>
            </div>
            <div class="card-value text-success" id="totalProfit">₹0.00</div>
            <div class="card-label">Total Profit</div>
          </div>
        </div>
      </div>
      <div class="col-md-2 mb-3">
        <div class="card summary-card border-warning">
          <div class="card-body text-center">
            <div class="card-icon text-warning mb-2">
              <i class="fas fa-truck"></i>
            </div>
            <div class="card-value text-warning" id="tripsCount">0</div>
            <div class="card-label">Trips Count</div>
          </div>
        </div>
      </div>
      <div class="col-md-2 mb-3">
        <div class="card summary-card border-secondary">
          <div class="card-body text-center">
            <div class="card-icon text-secondary mb-2">
              <i class="fas fa-gas-pump"></i>
            </div>
            <div class="card-value text-secondary" id="totalDiesel">₹0.00</div>
            <div class="card-label">Diesel Expenses</div>
          </div>
        </div>
      </div>
      <div class="col-md-2 mb-3">
        <div class="card summary-card border-danger">
          <div class="card-body text-center">
            <div class="card-icon text-danger mb-2">
              <i class="fas fa-tools"></i>
            </div>
            <div class="card-value text-danger" id="totalOtherExp">₹0.00</div>
            <div class="card-label">Other Expenses</div>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-3">
        <label class="form-label">From Date</label>
        <input type="date" class="form-control" id="fromDate">
      </div>
      <div class="col-md-3">
        <label class="form-label">To Date</label>
        <input type="date" class="form-control" id="toDate">
      </div>
      <div class="col-md-3">
        <label class="form-label">Vehicle Number</label>
        <select class="form-select" id="vehicleFilter">
          <option value="">All Vehicles</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Trip Type</label>
        <select class="form-select" id="tripTypeFilter">
          <option value="">All Trips</option>
          <option value="with_empty">With Empty Return</option>
          <option value="without_empty">Standard Trips</option>
        </select>
      </div>
      <div class="col-md-1 d-flex align-items-end">
        <button class="btn btn-primary me-2" id="applyFiltersBtn">Filter</button>
      </div>
      <div class="col-md-1 d-flex align-items-end">
        <button class="btn btn-success" id="exportPdfBtn">PDF</button>
      </div>
    </div>

    <div class="table-responsive">
      <table id="expensesTable" class="table table-striped">
        <thead>
          <tr>
            <th>Empty</th>
            <th>Date</th>
            <th>Vehicle No</th>
            <th>LR No</th>
            <th>From</th>
            <th>To</th>
            <th class="text-end">Tyre Exp</th>
            <th class="text-end">Diesel Exp</th>
            <th class="text-end">Advance</th>
            <th class="text-end">Toll</th>
            <th class="text-end">Commission</th>
            <th class="text-end">Vehicle Work</th>
            <th class="text-end">Tirpal/Rope</th>
            <th class="text-end">Other Exp</th>
            <th class="text-end">Food Exp</th>
            <th class="text-end">Shortage Amt</th>
            <th class="text-end">Billing Amt</th>
            <th class="text-end">Total Exp</th>
            <th class="text-end">Profit</th>
          </tr>
        </thead>
        <tbody>
          </tbody>
        <tfoot>
          <tr>
            <th colspan="6" style="text-align:right;">Page Total:</th>
            <th class="text-end"></th>
            <th class="text-end"></th>
            <th class="text-end"></th>
            <th class="text-end"></th>
            <th class="text-end"></th>
            <th class="text-end"></th>
            <th class="text-end"></th>
            <th class="text-end"></th>
            <th class="text-end"></th>
            <th class="text-end"></th>
            <th class="text-end"></th>
            <th class="text-end"></th>
            <th class="text-end"></th>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- The modal for adding/editing empty trip expenses has been removed to make this page view-only for that data. -->

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="navbar-loader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  
  <script>
    // Firebase configuration
    // Load Firebase configuration securely from EVM
    let firebaseConfig;
    
    try {
      // Get Firebase configuration from secure EVM system
      firebaseConfig = ConfigManager.getFirebaseConfig();
      
      // Check if we're using fallback values
      if (ConfigManager.isUsingFallbackValues()) {
        console.warn('⚠️  Using fallback Firebase configuration. Please update evm.js with real values.');
      } else {
        console.log('✅ Firebase configuration loaded securely from EVM');
      }
    } catch (error) {
      console.error('❌ Failed to load Firebase configuration:', error);
      
      // Use fallback configuration to prevent complete failure
      firebaseConfig = ConfigManager.getFirebaseConfig();
    }

    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }

    const db = firebase.database();
    const auth = firebase.auth();

    // Global variables
    let expensesTable;
    let tripExpensesData = [];
    let lrData = [];
    let coreAccountId = null; // To store the correct data path
    let allPetrolPumps = []; // Store all petrol pumps
    let emptyDieselPumpOptions = ''; // Store pump options for the modal
    let allWorkVendors = {}; // Store all work vendors for display/dropdowns
    let te_allVehicles = []; // Store vehicles for empty trip fuel deduction

    // Initialize the page
    $(document).ready(function() {
      // First check authentication status
      auth.onAuthStateChanged((user) => {
        if (!user) {
          window.location.href = 'login.html';
        } else {
          // **FIX**: Determine the core account ID to fetch shared data
          getCoreAccountId(user.uid).then((id) => {
            coreAccountId = id;
            console.log("Core Account ID determined for trip expenses:", coreAccountId);
            loadWorkVendors(); // Load vendors first
            loadLRData();
            loadAllRoutes(); 
            loadAllPetrolPumps(user.uid); 
            // Load vehicles for Vehicle Fuel card in empty trip modal
            loadAllVehiclesForTE();
          });

          initializeDataTable();
          setupEventListeners();
          
          // Set default date range to current month
          const today = new Date();
          const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
          $('#fromDate').val(formatDateForInput(firstDay));
          $('#toDate').val(formatDateForInput(today));
        }
      });
    });

    // **NEW**: Load all routes from Firebase and populate the route dropdown
    function loadAllRoutes() {
      if (!coreAccountId) {
        console.warn('Routes cannot be loaded yet. coreAccountId not ready.');
        return;
    }
    }

    // **FIX/NEW**: Load work vendors for the empty trip modal and store them globally.
    function loadWorkVendors() {
        if (!coreAccountId) {
            console.warn('Work vendors cannot be loaded yet. coreAccountId not ready.');
            return;
        }
        const vendorsRef = db.ref(`users/${coreAccountId}/workVendors`);

        vendorsRef.on('value', (snapshot) => {
            allWorkVendors = {}; // Reset global vendor list
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    const vendor = child.val();
                    allWorkVendors[child.key] = vendor; // Store vendor globally
                });
            }
        });
    }

    // **FIX**: Helper function to get the core account ID for any user.
    // This ensures data is fetched from the correct shared path.
    async function getCoreAccountId(userId) {
        if (!userId) return null;
        
        try {
          // 1. Check for coreAccountId field in the root of the user node
          let userRef = db.ref(`users/${userId}`);
          let userSnap = await userRef.once('value');
          if (userSnap.exists()) {
              const userData = userSnap.val();
              if (userData.coreAccountId) {
                console.log("Found coreAccountId in user root:", userData.coreAccountId);
                return userData.coreAccountId;
              }
          }

          // 2. Check for coreAccountId field in the user/profile node
          const userProfileRef = db.ref(`users/${userId}/profile`);
          const userProfileSnap = await userProfileRef.once('value');
          if (userProfileSnap.exists()) {
              const profileData = userProfileSnap.val();
              if (profileData.coreAccountId) {
                console.log("Found coreAccountId in user profile:", profileData.coreAccountId);
                return profileData.coreAccountId;
              }
          }
          
          console.log("No coreAccountId found, using user's own UID:", userId);
          return userId; // Fallback to user's own UID
        } catch (error) {
          console.error("Error getting core account ID:", error);
          return userId; // Fallback
        }
    }
    // **FIX**: Load all petrol pumps from Firebase using coreAccountId
    // Function now accepts the ID directly.
    function loadAllPetrolPumps(accountId) {
      // The old recursive check is removed for robustness.
      console.log("Loading petrol pumps from core account:", accountId);
      
      const pumpsRef = db.ref(`users/${accountId}/petrolPumps`);
      pumpsRef.on('value', (snapshot) => {
        allPetrolPumps = []; // Reset
        emptyDieselPumpOptions = '<option value="">Select Pump</option>'; // Reset
        
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const pump = child.val();
            // Store key, name, and place
            const pumpData = { 
              id: child.key, 
              name: pump.name, 
              place: pump.place || 'No location' 
            };
            allPetrolPumps.push(pumpData);
            
            // Build the options string
            emptyDieselPumpOptions += `<option value="${pump.name}" data-pump-id="${child.key}">${pump.name} - ${pump.place || 'No location'}</option>`;
          });
          console.log("✅ Successfully loaded petrol pumps:", allPetrolPumps.length);
        } else {
          emptyDieselPumpOptions += '<option value="" disabled>No pumps registered</option>';
          console.log("❌ No petrol pumps found");
        }
      }, (error) => {
        console.error("❌ Error loading petrol pumps:", error);
      });
    }

    // **FIX**: Helper function to get the core account ID for any user.
    // This ensures data is fetched from the correct shared path.
    async function getCoreAccountId(userId) {
        if (!userId) return null;
        
        try {
          // 1. Check for coreAccountId field in the root of the user node
          let userRef = db.ref(`users/${userId}`);
          let userSnap = await userRef.once('value');
          if (userSnap.exists()) {
              const userData = userSnap.val();
              if (userData.coreAccountId) {
                console.log("Found coreAccountId in user root:", userData.coreAccountId);
                return userData.coreAccountId;
              }
          }

          // 2. Check for coreAccountId field in the user/profile node
          const userProfileRef = db.ref(`users/${userId}/profile`);
          const userProfileSnap = await userProfileRef.once('value');
          if (userProfileSnap.exists()) {
              const profileData = userProfileSnap.val();
              if (profileData.coreAccountId) {
                console.log("Found coreAccountId in user profile:", profileData.coreAccountId);
                return profileData.coreAccountId;
              }
          }
          
          // 3. Check if this is a branch account by looking at accountType
          if (userSnap.exists()) {
            const userData = userSnap.val();
            if (userData.accountType === 'branch' && userData.coreAccountId) {
              console.log("Found coreAccountId in branch account:", userData.coreAccountId);
              return userData.coreAccountId;
            }
          }
          
          // 4. Fallback to user's own UID if no core ID is found (user is a core account)
          console.log("No coreAccountId found, using user's own UID:", userId);
          return userId; // Fallback
        } catch (error) {
          console.error("Error getting core account ID:", error);
          return userId; // Fallback
        }
    }

    // Format date for input field (YYYY-MM-DD)
    function formatDateForInput(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // Initialize DataTable
    function initializeDataTable() {
      expensesTable = $('#expensesTable').DataTable({
        pageLength: 10,
        lengthMenu: [10, 25, 50, 100, -1],
        order: [[1, 'desc']], // Changed to column 1 (Date) since we added a new first column
        columnDefs: [
          { className: "text-end", targets: [6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16] }
        ],
        footerCallback: function (row, data, start, end, display) {
          var api = this.api();

          // Helper function to parse currency and sum
          var intVal = function (i) {
            return typeof i === 'string' ?
              parseFloat(i.replace(/<[^>]*>/g, '').replace(/[₹,]/g, '')) || 0 :
              typeof i === 'number' ? i : 0;
          };

          // Calculate totals for all visible rows on the current page
          for (let i = 6; i <= 18; i++) { // **MODIFIED**: Increased column count for footer
            const pageTotal = api
              .column(i, { page: 'current' })
              .data()
              .reduce(function (a, b) {
                return intVal(a) + intVal(b);
              }, 0);
            $(api.column(i).footer()).html(formatCurrency(pageTotal));
          }
        }
      });
    }

    // Setup event listeners
    function setupEventListeners() {
      // Filter button click
      $('#applyFiltersBtn').on('click', function() {
        applyFilters();
      });

      // Export PDF button click
      $('#exportPdfBtn').on('click', function() {
        exportToPDF();
      });

      // Add event listener for opening and closing details
      $('#expensesTable tbody').on('click', 'td.details-control', function () {
        handleDetailRowClick(this);
      });
    }

    // Load LR data from Firebase
    function loadLRData() {
      const user = auth.currentUser;
      // **FIX**: Ensure coreAccountId is available before attempting to load data
      if (!user || !coreAccountId) { 
        console.error('No authenticated user or coreAccountId found. Retrying in 500ms...');
        setTimeout(loadLRData, 500); // Retry after a short delay
        return;
      }
      
      const lrRef = db.ref(`users/${coreAccountId}/lrReports`); // **FIX**: Use coreAccountId
      lrRef.on('value', (snapshot) => {
        lrData = [];
        const data = snapshot.val() || {};
        
        if (data) {
          Object.keys(data).forEach(key => {
            lrData.push({ id: key, ...data[key] });
            // **NEW**: Exclude market vehicle LRs from this report
            lrData = lrData.filter(lr => lr.lrType !== 'market');
          });
          
          // Process LR data for trip expenses
          processLRDataForExpenses();
          
          // Populate the table
          populateTable();
          
          // Update vehicle filter dropdown
          updateVehicleFilter();
          
          // Update summary cards
          updateSummaryCards();
        } else {
          // No LR data found
          expensesTable.clear().draw();
          updateSummaryCards();
        }
      }, (error) => {
        console.error('Error loading LR data:', error);
      });
    }

    // **UPDATED** processLRDataForExpenses in trip-expenses.html
    function processLRDataForExpenses() {
        tripExpensesData = lrData.map(lr => {
            const details = lr.tripDetails || {};
            const emptyTripData = lr.emptyTripData || {};
            
            // Calculate diesel expenses from fuel used and rate per liter.
            const dieselForCalc = (parseFloat(details.fuelUsedLiters) || 0) * (parseFloat(details.dieselRatePerLiter) || 0);

            // **NEW: Aggregate all non-Tyre, non-Toll, non-Food, non-VW expenses into 'Other' column for display**
            const otherGenericExpenses = 
                (parseFloat(details.loadingUnloadingExpenses) || 0) +
                (parseFloat(details.policeChallanExpenses) || 0) +
                (parseFloat(details.tacExpenses) || 0) +
                (parseFloat(details.permitExpenses) || 0) +
                (parseFloat(details.brokerageExpenses) || 0) +
                // **NOTE**: Commission and Tirpal/Rope are now separate columns, so they are NOT in "Other"
                (parseFloat(details.otherExpenses) || 0);

            // Calculate total main trip expenses (all specific expense fields + advance) EXCLUDING shortage amount
            const mainTripAggregatedExpenses = 
                (parseFloat(details.tyreExpenses) || 0) +
                (parseFloat(details.tollExpenses) || 0) +
                (parseFloat(details.foodExpenses) || 0) +
                (parseFloat(details.vehicleWorkAmount) || 0) +
                (parseFloat(details.commissionExpenses) || 0) +
                (parseFloat(details.tirpalRopeExpenses) || 0) +
                otherGenericExpenses;

            const totalExpenses = mainTripAggregatedExpenses + dieselForCalc + (parseFloat(details.advance) || 0);
            
            // Calculate shortage deduction based on the LR's specific billing rate.
            // Billing rate is not explicitly saved, so we must calculate it or assume a zero rate if billing amount is zero
            const billingAmount = parseFloat(details.billingAmount) || 0;
            const billingRate = (lr.weight > 0) ? (billingAmount / lr.weight) : 0;
            const shortageDeduction = ((parseFloat(details.shortage) || 0) / 1000) * billingRate;

            // Calculate profit (main trip only)
            // Profit is Freight - (Total Expenses + Shortage Deduction)
            const profit = billingAmount - (totalExpenses + shortageDeduction);
            
            
            // **Empty Trip Calculations**
            const emptyOtherGenericExpenses = 
                (parseFloat(emptyTripData.loadingUnloadingExpenses) || 0) +
                (parseFloat(emptyTripData.policeChallanExpenses) || 0) +
                (parseFloat(emptyTripData.tacExpenses) || 0) +
                (parseFloat(emptyTripData.permitExpenses) || 0) +
                (parseFloat(emptyTripData.brokerageExpenses) || 0) +
                // **NOTE**: Commission and Tirpal/Rope are now separate columns, so they are NOT in "Other"
                (parseFloat(emptyTripData.otherExpenses) || 0);

            const emptyTripAggregatedExpenses = 
                (parseFloat(emptyTripData.tyreExpenses) || 0) +
                (parseFloat(emptyTripData.tollExpenses) || 0) +
                (parseFloat(emptyTripData.foodExpenses) || 0) +
                (parseFloat(emptyTripData.vehicleWorkAmount) || 0) +
                (parseFloat(emptyTripData.commissionExpenses) || 0) +
                (parseFloat(emptyTripData.tirpalRopeExpenses) || 0) +
                emptyOtherGenericExpenses;

            const emptyDieselForCalc = (parseFloat(emptyTripData.fuelUsedLiters) || 0) * (parseFloat(emptyTripData.dieselRatePerLiter) || 0);
            const totalEmptyExpenses = emptyTripAggregatedExpenses + emptyDieselForCalc;


            return {
              id: lr.id,
              date: lr.date,
              vehicleNumber: lr.truckNumber,
              lrNumber: lr.lrNumber,
              from: lr.fromLocation,
              to: lr.toLocation,
              
              // Main Trip Expense Fields (read directly)
              tyreExpenses: parseFloat(details.tyreExpenses) || 0,
              tollPaid: parseFloat(details.tollExpenses) || 0,
              vehicleWork: parseFloat(details.vehicleWorkAmount) || 0,
              commission: parseFloat(details.commissionExpenses) || 0,
              tirpalRope: parseFloat(details.tirpalRopeExpenses) || 0,
              foodExpenses: parseFloat(details.foodExpenses) || 0,
              otherExpenses: otherGenericExpenses, // Combined generic expenses
              
              dieselExpenses: dieselForCalc,
              advancePaid: parseFloat(details.advance) || 0,
              shortageAmount: shortageDeduction,
              freightAmount: billingAmount, // Use billingAmount for display
              
              // Totals for main trip (used for profit calculation)
              totalExpenses: totalExpenses,
              profit: profit,
              
              hasEmptyTrip: lr.emptyTrip || false, // Use root flag
              emptyTripData: { // Detailed breakdown for display
                  ...emptyTripData, // Keep all data
                  totalEmptyExpenses: totalEmptyExpenses,
                  emptyTyreExpenses: parseFloat(emptyTripData.tyreExpenses) || 0,
                  emptyTollExpenses: parseFloat(emptyTripData.tollExpenses) || 0,
                  emptyVehicleWorkAmount: parseFloat(emptyTripData.vehicleWorkAmount) || 0,
                  emptyCommission: parseFloat(emptyTripData.commissionExpenses) || 0,
                  emptyTirpalRope: parseFloat(emptyTripData.tirpalRopeExpenses) || 0,
                  emptyFoodExpenses: parseFloat(emptyTripData.foodExpenses) || 0,
                  emptyDieselExpenses: emptyDieselForCalc,
                  emptyOtherExpenses: emptyOtherGenericExpenses // Combined generic expenses
              }
            };
        });
    }

    // Populate the table with trip expenses data
    function populateTable() {
      expensesTable.clear();
      
      tripExpensesData.forEach(expense => {
        // Calculate combined values for display
        const emptyData = expense.emptyTripData;
        const hasEmpty = expense.hasEmptyTrip;

        const displayTyreExpenses = expense.tyreExpenses + (hasEmpty ? emptyData.emptyTyreExpenses : 0);
        const displayDieselExpenses = expense.dieselExpenses + (hasEmpty ? emptyData.emptyDieselExpenses : 0);
        const displayTollPaid = expense.tollPaid + (hasEmpty ? emptyData.emptyTollExpenses : 0);
        const displayCommission = expense.commission + (hasEmpty ? emptyData.emptyCommission : 0);
        const displayVehicleWork = expense.vehicleWork + (hasEmpty ? emptyData.emptyVehicleWorkAmount : 0);
        const displayTirpalRope = expense.tirpalRope + (hasEmpty ? emptyData.emptyTirpalRope : 0);
        const displayFoodExpenses = expense.foodExpenses + (hasEmpty ? emptyData.emptyFoodExpenses : 0);
        const displayOtherExpenses = expense.otherExpenses + (hasEmpty ? emptyData.emptyOtherExpenses : 0);
        
        // Recalculate total expenses and profit with empty trip data
        const emptyTotal = hasEmpty ? emptyData.totalEmptyExpenses : 0;
        const finalDisplayTotalExpenses = expense.totalExpenses + emptyTotal + expense.shortageAmount;
        const displayProfit = expense.freightAmount - finalDisplayTotalExpenses;
          
        const displayProfitClass = displayProfit >= 0 ? 'profit-positive' : 'profit-negative';
        
        // Empty button/icon column
        const firstColumnControl = hasEmpty ? '' // The td will have the details-control class for the icon
          // The button to add empty trip expenses has been removed. This data is now added from the LR Report page.
          : `<span class="text-muted" title="No empty trip data. Add via LR Report page."><i class="fas fa-minus"></i></span>`;

        const row = [
          firstColumnControl,
          formatDate(expense.date),
          expense.vehicleNumber,
          expense.lrNumber,
          expense.from,
          expense.to,
          formatCurrency(displayTyreExpenses),
          formatCurrency(displayDieselExpenses), // Simplified for display
          formatCurrency(expense.advancePaid),
          formatCurrency(displayTollPaid),
          formatCurrency(displayCommission),
          formatCurrency(displayVehicleWork),
          formatCurrency(displayTirpalRope),
          formatCurrency(displayOtherExpenses),
          formatCurrency(displayFoodExpenses),
          formatCurrency(expense.shortageAmount),
          formatCurrency(expense.freightAmount),
          formatCurrency(finalDisplayTotalExpenses),
          `<span class="${displayProfitClass}">${formatCurrency(displayProfit)}</span>`
        ];
        
        const addedRow = expensesTable.row.add(row).node();
        addedRow.className = hasEmpty ? 'empty-trip-row' : '';
        
        // If it has an empty trip, add the details-control class to the first cell
        if (hasEmpty) {
          $(addedRow).find('td:first').addClass('details-control');
          $(addedRow).data('expense-details', expense); // Store details on the row
        }
      });
      
      expensesTable.draw();
    }

    // Update vehicle filter dropdown
    function updateVehicleFilter() {
      const vehicleFilter = $('#vehicleFilter');
      const vehicles = [...new Set(tripExpensesData.map(expense => expense.vehicleNumber))].sort();
      
      // Clear existing options except the first one
      vehicleFilter.find('option:not(:first)').remove();
      
      // Add vehicle options
      vehicles.forEach(vehicle => {
        if (vehicle) {
          vehicleFilter.append(`<option value="${vehicle}">${vehicle}</option>`);
        }
      });
    }

    // Update summary cards
    function updateSummaryCards() {
      // Calculate totals from the main filtered dataset (tripExpensesData)
      let totalBilling = 0;
      let totalExpenses = 0;
      let totalDiesel = 0;
      let totalOtherExp = 0;

      tripExpensesData.forEach(expense => {
        const hasEmpty = expense.hasEmptyTrip;
        const emptyData = expense.emptyTripData;

        totalBilling += expense.freightAmount;
        
        // Total Expenses (Main + Empty + Shortage)
        let expenseTotal = expense.totalExpenses + expense.shortageAmount; // Main trip expenses + advance + diesel + shortage
        if (hasEmpty) {
          expenseTotal += emptyData.totalEmptyExpenses;
        }
        totalExpenses += expenseTotal;
        
        // Diesel Expenses
        let dieselTotal = expense.dieselExpenses || 0;
        if (hasEmpty) {
          dieselTotal += (emptyData.emptyDieselExpenses || 0);
        }
        totalDiesel += dieselTotal;
        
        // Other Expenses (Tyre + Toll + Vehicle Work + Other + Food)
        let otherTotal = 
          (expense.tyreExpenses || 0) +
          (expense.tollPaid || 0) +
          (expense.vehicleWork || 0) +
          (expense.commission || 0) +
          (expense.tirpalRope || 0) +
          (expense.otherExpenses || 0) +
          (expense.foodExpenses || 0);
          
        if (hasEmpty) {
          otherTotal += 
            (emptyData.emptyTyreExpenses || 0) +
            (emptyData.emptyTollExpenses || 0) +
            (emptyData.emptyVehicleWorkAmount || 0) +
            (emptyData.emptyCommission || 0) +
            (emptyData.emptyTirpalRope || 0) +
            (emptyData.emptyOtherExpenses || 0) +
            (emptyData.emptyFoodExpenses || 0);
        }
        totalOtherExp += otherTotal;
      });
      
      const totalProfit = totalBilling - totalExpenses;
      
      $('#totalBilling').text(formatCurrency(totalBilling));
      $('#totalExpenses').text(formatCurrency(totalExpenses));
      $('#totalProfit').text(formatCurrency(totalProfit));
      $('#tripsCount').text(tripExpensesData.length);
      $('#totalDiesel').text(formatCurrency(totalDiesel)); 
      $('#totalOtherExp').text(formatCurrency(totalOtherExp));
    }

    // Apply filters to the table
    function applyFilters() {
      const fromDate = $('#fromDate').val();
      const toDate = $('#toDate').val();
      const vehicle = $('#vehicleFilter').val();
      const tripType = $('#tripTypeFilter').val();

      // Use DataTables custom search function for filtering
      $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
        // Ensure we are targeting the correct table
        if (settings.nTable.id !== 'expensesTable') {
          return true;
        }

        const rowDate = new Date(data[1].split('/').reverse().join('-')); // Convert DD/MM/YYYY to YYYY-MM-DD for comparison
        const rowVehicle = data[2] || '';
        
        // Check if the row has an empty trip. We can check for the details-control class on the first cell.
        const rowNode = expensesTable.row(dataIndex).node();
        const hasEmptyTrip = $(rowNode).find('td:first').hasClass('details-control');
        
        // Date filter
        let datePass = true;
        if (fromDate) {
          const filterFromDate = new Date(fromDate);
          datePass = datePass && rowDate >= filterFromDate;
        }
        if (toDate) {
          const filterToDate = new Date(toDate);
          filterToDate.setHours(23, 59, 59, 999); // End of the day
          datePass = datePass && rowDate <= filterToDate;
        }
        
        // Vehicle filter
        const vehiclePass = !vehicle || rowVehicle === vehicle;
        
        // Trip type filter
        let tripTypePass = true;
        if (tripType === 'with_empty') {
          tripTypePass = hasEmptyTrip;
        } else if (tripType === 'without_empty') {
          tripTypePass = !hasEmptyTrip;
        }
        
        return datePass && vehiclePass && tripTypePass;
      });
      
      // Redraw the table to apply filters
      expensesTable.draw();
      
      // Remove the custom filter function after drawing to avoid stacking
      $.fn.dataTable.ext.search.pop();
      
      // Update summary cards with filtered data
      updateFilteredSummaryCards();
    }

    // Update summary cards with filtered data
    function updateFilteredSummaryCards() {
      const filteredRowNodes = expensesTable.rows({ filter: 'applied' }).nodes().toArray();
      
      let filteredBilling = 0;
      let filteredExpenses = 0;
      let filteredDiesel = 0;
      let filteredOtherExp = 0;
      
      filteredRowNodes.forEach(node => {
        const rowData = expensesTable.row(node).data();
        
        // Billing Amt (Col 14)
        filteredBilling += parseCurrency(rowData[14]); 
        // Total Expenses (Col 15)
        filteredExpenses += parseCurrency(rowData[15]); 
        // Diesel Exp (Col 7)
        filteredDiesel += parseCurrency(rowData[7]); 
        
        // Other expenses: tyre (6) + toll (9) + vehicle work (10) + other (11) + food (12)
        filteredOtherExp += 
          parseCurrency(rowData[6]) +  // Tyre
          parseCurrency(rowData[9]) +  // Toll
          parseCurrency(rowData[10]) + // Vehicle Work
          parseCurrency(rowData[11]) + // Other
          parseCurrency(rowData[12]);  // Food
      });
      
      const filteredProfit = filteredBilling - filteredExpenses;
      
      $('#totalBilling').text(formatCurrency(filteredBilling));
      $('#totalExpenses').text(formatCurrency(filteredExpenses));
      $('#totalProfit').text(formatCurrency(filteredProfit));
      $('#tripsCount').text(filteredRowNodes.length);
      $('#totalDiesel').text(formatCurrency(filteredDiesel)); 
      $('#totalOtherExp').text(formatCurrency(filteredOtherExp));
    }

    // Export to PDF
    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape' });
      
      // Add title
      doc.setFontSize(16);
      doc.text('Trip Expenses Report', 14, 15);
      
      // Add date range
      const fromDate = $('#fromDate').val() || 'N/A';
      const toDate = $('#toDate').val() || 'N/A';
      doc.setFontSize(10);
      doc.text(`Date Range: ${fromDate} to ${toDate}`, 14, 22);
      
      // Get filtered data
      const filteredData = expensesTable.rows({ filter: 'applied' }).data().toArray();
      
      // Prepare table data
      const tableData = filteredData.map(row => {
        // Extract just the numeric values for the PDF (remove HTML formatting)
        return [
          row[1], // Date
          row[2], // Vehicle No
          row[3], // LR No
          row[4], // From
          row[5], // To
          parseCurrency(row[6]).toFixed(2), // Tyre
          parseCurrency(row[7]).toFixed(2), // Diesel
          parseCurrency(row[8]).toFixed(2), // Advance
          parseCurrency(row[9]).toFixed(2), // Toll
          parseCurrency(row[10]).toFixed(2), // Commission
          parseCurrency(row[11]).toFixed(2), // Vehicle Work
          parseCurrency(row[12]).toFixed(2), // Tirpal/Rope
          parseCurrency(row[13]).toFixed(2), // Other
          parseCurrency(row[14]).toFixed(2), // Food
          parseCurrency(row[15]).toFixed(2), // Shortage
          parseCurrency(row[16]).toFixed(2), // Billing
          parseCurrency(row[17]).toFixed(2), // Total Exp
          parseCurrency(row[18]).toFixed(2)  // Profit
        ];
      });
      
      // Add table
      doc.autoTable({
        startY: 30,
        head: [['Date', 'Vehicle', 'LR No', 'From', 'To', 'Tyre', 'Diesel', 'Advance', 'Toll', 'Commission', 'V.Work', 'Tirpal/Rope', 'Other', 'Food', 'Shortage', 'Billing', 'Total Exp', 'Profit']],
        body: tableData,
        styles: { fontSize: 8 },
        headStyles: { fillColor: [41, 128, 185] }
      });
      
      // Add summary
      const finalY = doc.lastAutoTable.finalY + 10;
      doc.setFontSize(10);
      const filteredSummaryData = updateFilteredSummaryCards(); // Recalculate summary data if needed (or fetch from updated cards)
      
      doc.text(`Total Trips: ${filteredData.length}`, 14, finalY);
      doc.text(`Total Billing: ${$('#totalBilling').text()}`, 14, finalY + 5);
      doc.text(`Total Expenses: ${$('#totalExpenses').text()}`, 14, finalY + 10);
      doc.text(`Total Profit: ${$('#totalProfit').text()}`, 14, finalY + 15);
      
      // Save the PDF
      doc.save(`trip-expenses-${fromDate}-to-${toDate}.pdf`);
    }

    // Handle detail row click for empty trips
    function handleDetailRowClick(cell) {
      const tr = $(cell).closest('tr');
      const row = expensesTable.row(tr);
      const expense = $(tr).data('expense-details');
      
      if (row.child.isShown()) {
        // This row is already open - close it
        row.child.hide();
        tr.removeClass('details');
      } else {
        // Open this row
        const emptyData = expense.emptyTripData || {};
        const totalEmptyExpenses = emptyData.totalEmptyExpenses || 0;
        
        const vendorName = emptyData.vehicleWorkVendorName || (emptyData.vehicleWorkVendorId ? allWorkVendors[emptyData.vehicleWorkVendorId]?.name : 'N/A');
        const workNotes = emptyData.vehicleWorkNotes || '—';
        
        // Sum up the Other Expenses that go into the 'Other Exp' column for display in the child row
        const otherCombined = 
            (emptyData.emptyOtherExpenses || 0) +
            (emptyData.loadingUnloadingExpenses || 0) +
            (emptyData.policeChallanExpenses || 0) +
            (emptyData.tacExpenses || 0) +
            (emptyData.permitExpenses || 0) +
            // **NOTE**: Commission and Tirpal/Rope are now separate columns, so they are NOT in "Other"
            (emptyData.brokerageExpenses || 0);

        const childHtml = `
          <div class="child-row-container">
            <h6 class="mb-3">Empty Return Trip Expenses</h6>
            <table class="child-row-table">
              <tr>
                <th>Expense Type</th>
                <th>Amount</th>
                <th>Details</th>
              </tr>
              <tr>
                <td>Tyre Expenses</td>
                <td>₹${formatCurrency(emptyData.emptyTyreExpenses || 0)}</td>
                <td>-</td>
              </tr>
              <tr>
                <td>Diesel Expenses</td>
                <td>₹${formatCurrency(emptyData.emptyDieselExpenses || 0)}</td>
                <td>${(emptyData.fuelUsedLiters || 0).toFixed(2)} L @ ₹${(emptyData.dieselRatePerLiter || 0).toFixed(2)}/L (Route: ${emptyData.routeDistanceKm || 0} km, Avg: ${emptyData.vehicleAverage || 0} km/l)</td>
              </tr>
              <tr>
                <td>Toll Expenses</td>
                <td>₹${formatCurrency(emptyData.emptyTollExpenses || 0)}</td>
                <td>-</td>
              </tr>
              <tr>
                <td>Vehicle Work</td>
                <td>₹${formatCurrency(emptyData.emptyVehicleWorkAmount || 0)}</td>
                <td>Vendor: ${vendorName}, Notes: ${workNotes}</td>
              </tr>
              <tr>
                <td>Commission</td>
                <td>₹${formatCurrency(emptyData.emptyCommission || 0)}</td>
                <td>-</td>
              </tr>
              <tr>
                <td>Tirpal & Rope</td>
                <td>₹${formatCurrency(emptyData.emptyTirpalRope || 0)}</td>
                <td>-</td>
              </tr>
              <tr>
                <td>Food Expenses</td>
                <td>₹${formatCurrency(emptyData.emptyFoodExpenses || 0)}</td>
                <td>-</td>
              </tr>
              <tr>
                <td>Other Expenses (Combined)</td>
                <td>₹${formatCurrency(otherCombined)}</td>
                <td>Includes: L/U, Challan, TAC, Permit, Brokerage, Other.</td>
              </tr>
              <tr>
                <td><strong>Total Empty Trip Expenses</strong></td>
                <td><strong>₹${formatCurrency(totalEmptyExpenses)}</strong></td>
                <td>-</td>
              </tr>
            </table>
          </div>
        `;
        
        row.child(childHtml).show();
        tr.addClass('details');
      }
    }

    // Edit empty trip
    // **FIXED**: This function now correctly populates the Trip Fuel Consumption card.
    window.editEmptyTrip = function(lrId) {
      const expense = tripExpensesData.find(e => e.id === lrId);
      if (expense && expense.emptyTripData) {
        const emptyData = expense.emptyTripData;
        
        $('#emptyTripId').val(lrId);
        
        // Populate Other Expenses (from the fields in the simple modal)
        $('#emptyTyreExpenses').val(emptyData.emptyTyreExpenses || emptyData.tyreExpenses || '');
        $('#emptyTollExpenses').val(emptyData.emptyTollExpenses || emptyData.tollExpenses || '');
        $('#emptyOtherExpenses').val(emptyData.emptyOtherExpenses || emptyData.otherExpenses || '');
        $('#emptyFoodExpenses').val(emptyData.emptyFoodExpenses || emptyData.foodExpenses || '');

        // Populate Vehicle Work Card (Legacy fields)
        $('#emptyVehicleWork').val(emptyData.emptyVehicleWorkAmount || emptyData.vehicleWork || '');
        $('#emptyVehicleWorkVendor').val(emptyData.vehicleWorkVendorId || '');
        $('#emptyVehicleWorkNotes').val(emptyData.vehicleWorkNotes || '');
        
        // Populate the Trip Fuel Consumption card
        $('#emptyRouteSelect').val(emptyData.routeId || '');
        $('#emptyRouteDistanceKm').val(emptyData.routeDistanceKm || '');
        $('#emptyVehicleAverage').val(emptyData.vehicleAverage || '');
        $('#emptyDieselRatePerLiter').val(emptyData.dieselRatePerLiter || '');
        $('#emptyFuelUsedLiters').val(emptyData.fuelUsedLiters || '');
        $('#emptyDieselExpenses').val(emptyData.emptyDieselExpenses || emptyData.dieselExpenses || '');

        // Recalculate to ensure consistency, especially the auto-calculated fields.
        recalcEmptyTripFuel();
        
        emptyTripModal.show();
      }
    }

    // Utility functions
  function getVehicleNumberField(v) {
    return (v?.vehicleNumber || v?.vehicleNo || v?.number || '').toString();
  }
    function formatCurrency(amount) {
      return parseFloat(amount || 0).toLocaleString('en-IN', {
        style: 'currency',
        currency: 'INR',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    function formatLiters(amount) {
      const n = parseFloat(amount || 0);
      return n.toLocaleString('en-IN', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }) + ' L';
    }

    function parseCurrency(currencyString) {
      if (typeof currencyString === 'number') return currencyString;
      // Remove all non-numeric characters except for the decimal point and leading minus sign
      const numericString = String(currencyString).replace(/<[^>]*>/g, '').replace(/[₹,]/g, '');
      return parseFloat(numericString) || 0;
    }

    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }

    function showToast(message, type = 'info') {
      // You can implement a toast notification here if needed
      alert(`${type.toUpperCase()}: ${message}`);
    }
  </script>
</body>
</html>