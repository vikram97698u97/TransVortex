<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign Up - Transport Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root { --pink:#ff3366; --white:#fff; --trans-white:rgba(255,255,255,0.85); }
    *{ box-sizing: border-box; }
    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
      color: var(--white); position:relative; overflow:hidden;
    }
    body::before{ content:""; position:fixed; inset:0;
      background:url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=1600&auto=format&fit=crop') center/cover no-repeat;
      filter: blur(10px) saturate(1.1); transform: scale(1.05); z-index:-2; }
    body::after{ content:""; position:fixed; inset:0; background:linear-gradient(180deg, rgba(10,10,30,0.35), rgba(10,10,30,0.55)); z-index:-1; }
    .auth-container{ width:min(92vw, 420px); border-radius:20px; padding:28px 24px;
      backdrop-filter: blur(6px);
      background:linear-gradient(180deg, rgba(92,45,145,0.65), rgba(150,105,200,0.35));
      box-shadow:0 20px 40px rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.18);
    }
    .top-icon{ display:grid; place-items:center; margin-bottom:14px; }
    .top-icon i{ font-size:48px; color:#fff; text-shadow:0 6px 24px rgba(0,0,0,.35); }
    .auth-header{ text-align:center; margin-bottom:18px; }
    .auth-header h1{ margin:0 0 6px; font-size:22px; letter-spacing:.2px; color:#fff; }
    .auth-header p{ margin:0; font-size:13px; color:rgba(255,255,255,.8); }
    .input-group{ position:relative; margin:14px 0; }
    .input-group i{ position:absolute; left:14px; top:50%; transform:translateY(-50%); color:rgba(255,255,255,.85); font-size:16px; pointer-events:none; }
    .form-control{ width:100%; border:1px solid rgba(255,255,255,.35); background:rgba(255,255,255,.08); color:#fff; padding:12px 14px 12px 44px; border-radius:14px; font-size:15px; outline:none; transition:border-color .2s, background .2s, box-shadow .2s; }
    .form-control::placeholder{ color:rgba(255,255,255,.75); }
    .form-control:focus{ border-color:var(--trans-white); background:rgba(255,255,255,.12); box-shadow:0 8px 26px rgba(0,0,0,.25); }
    .btn{ width:100%; padding:13px 16px; border:none; border-radius:14px; font-size:16px; font-weight:700; cursor:pointer; transition:transform .06s, box-shadow .2s; }
    .btn-primary{ background:var(--pink); color:#fff; box-shadow:0 12px 28px rgba(255,51,102,.45); }
    .btn-primary:hover{ transform:translateY(-1px); }
    .btn-primary:active{ transform:translateY(0); box-shadow:0 6px 18px rgba(255,51,102,.35); }
    .auth-footer{ text-align:center; margin-top:14px; color:rgba(255,255,255,.9); font-size:13px; }
    .auth-footer a{ color:#fff; font-weight:700; text-decoration:none; }
    .auth-footer a:hover{ text-decoration:underline; }
    .error-message{ color:#ffb3c2; font-size:13px; margin-top:6px; min-height:1.1rem; display:block; }
    .error{ border-color:#e74c3c !important; background-color:rgba(231,76,60,.12) !important; }
    #form-error{ display:none; background:rgba(231,76,60,.12); color:#ffb3c2; padding:12px; border-radius:10px; margin-bottom:14px; border-left:4px solid #ffb3c2; }
  </style>
</head>
<body>
  <div class="auth-container">
    <div class="top-icon">
      <i class="fas fa-check-circle" aria-hidden="true"></i>
    </div>
    <div class="auth-header">
      <h1>Create an account</h1>
      <p>Join us to get started</p>
    </div>
    <div id="form-error" style="display:none;"></div>
    <form id="signup-form">
      <div class="input-group">
        <i class="fas fa-user" aria-hidden="true"></i>
        <input type="email" id="signup-email" class="form-control" placeholder="Email address" required>
      </div>
      <div class="error-message" id="signup-email-error"></div>
      <div class="input-group">
        <i class="fas fa-lock" aria-hidden="true"></i>
        <input type="password" id="signup-password" class="form-control" placeholder="Create a password" required>
      </div>
      <div class="error-message" id="signup-password-error"></div>
      <button type="submit" class="btn btn-primary" id="signup-button">Continue</button>
    </form>
    <div class="auth-footer">
      Already have an account? <a href="login.html">Sign in</a>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getAuth, 
      createUserWithEmailAndPassword, 
      sendEmailVerification,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { 
      getDatabase, 
      ref, 
      set,
      update
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDAlk_K8p8Of8Ne6Jpcl2QqXTtm95NgG7o",
      authDomain: "transport-dashboard-ad69a.firebaseapp.com",
      databaseURL: "https://transport-dashboard-ad69a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "transport-dashboard-ad69a",
      storageBucket: "transport-dashboard-ad69a.appspot.com",
      messagingSenderId: "526889676196",
      appId: "1:526889676196:web:66032c80a4aede690ae531",
      measurementId: "G-7F9R7HJYDH"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Show error message
    function showError(fieldId, message) {
      const errorElement = document.getElementById(`${fieldId}-error`);
      if (errorElement) {
        errorElement.textContent = message;
        const input = document.getElementById(fieldId);
        if (input) input.classList.add('error');
      }
    }

    // Clear error
    function clearError(fieldId) {
      const errorElement = document.getElementById(`${fieldId}-error`);
      if (errorElement) {
        errorElement.textContent = '';
        const input = document.getElementById(fieldId);
        if (input) input.classList.remove('error');
      }
    }

    // Validate email format
    function validateEmail() {
      const email = document.getElementById("signup-email").value.trim();
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      
      if (!email) {
        showError('signup-email', 'Email is required');
        return false;
      }
      
      if (!emailRegex.test(email)) {
        showError('signup-email', 'Please enter a valid email address');
        return false;
      }
      
      clearError('signup-email');
      return true;
    }
    
    // Validate password strength
    function validatePassword() {
      const password = document.getElementById("signup-password").value;
      
      if (!password) {
        showError('signup-password', 'Password is required');
        return false;
      }
      
      if (password.length < 6) {
        showError('signup-password', 'Password must be at least 6 characters');
        return false;
      }
      
      clearError('signup-password');
      return true;
    }
    
    // Handle form submission
    window.signUp = async function() {
      const email = document.getElementById("signup-email").value.trim();
      const password = document.getElementById("signup-password").value;
      const signupButton = document.getElementById("signup-button");
      
      // Validate form
      const isEmailValid = validateEmail();
      const isPasswordValid = validatePassword();
      
      if (!isEmailValid || !isPasswordValid) {
        return;
      }
      
      // Show loading state
      const originalButtonText = signupButton.innerHTML;
      signupButton.disabled = true;
      signupButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating account...';
      
      try {
        // Create user account
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        // Update user profile
        await updateProfile(user, {
          displayName: email.split('@')[0],
          photoURL: ''
        });

        // **FIX**: Create the 14-day free trial immediately on signup.
        const trialStart = new Date();
        const trialEnd = new Date();
        trialEnd.setDate(trialStart.getDate() + 14);

        const subscriptionData = {
          status: 'trial',
          // **FIX**: Add all required fields to satisfy the database validation rules.
          planId: 'starter',
          planName: 'starter', // Required by rules
          vehicleLimit: 50,    // Default for starter plan
          price: 699,          // Default for starter plan
          trialStart: trialStart.toISOString(),
          trialEnd: trialEnd.toISOString(),
          createdAt: trialStart.toISOString(),
          subscribedAt: new Date().getTime() // Required by rules
        };

        // Save user data to database
        const userData = {
          email: email,
          accountType: 'core',
          createdAt: new Date().toISOString(),
          status: 'active',
          emailVerified: false,
          subscription: subscriptionData // Add subscription data here
        };
        
        // Save to Realtime Database
        await set(ref(db, `users/${user.uid}`), userData);
        
        // Send email verification
        await sendEmailVerification(user);
        
        // Store email in session for next steps
        sessionStorage.setItem('coreEmail', email);
        sessionStorage.setItem('corePassword', password);
        
        // **FIX**: Redirect to create branch account, which will then lead to plan selection.
        window.location.href = 'create-branch-account.html'; // This page will handle the next redirect
        
      } catch (error) {
        console.error('Signup error:', error);
        
        // Handle specific error cases
        let errorMessage = 'An error occurred during signup. Please try again.';
        
        switch(error.code) {
          case 'auth/email-already-in-use':
            errorMessage = 'This email is already registered. Please use a different email or sign in.';
            showError('signup-email', errorMessage);
            break;
          case 'auth/invalid-email':
            errorMessage = 'Please enter a valid email address.';
            showError('signup-email', errorMessage);
            break;
          case 'auth/weak-password':
            errorMessage = 'Password should be at least 6 characters.';
            showError('signup-password', errorMessage);
            break;
          case 'auth/network-request-failed':
            errorMessage = 'Network error. Please check your internet connection.';
            break;
          default:
            errorMessage = error.message || 'An unexpected error occurred.';
        }
        
        // Show error to user
        const errorContainer = document.getElementById('form-error');
        if (errorContainer) {
          errorContainer.textContent = errorMessage;
          errorContainer.style.display = 'block';
          
          // Auto-hide error after 5 seconds
          setTimeout(() => {
            errorContainer.style.display = 'none';
          }, 5000);
        } else {
          alert(errorMessage);
        }
        
      } finally {
        // Reset button state
        signupButton.disabled = false;
        signupButton.innerHTML = originalButtonText;
      }
    };
    
    // Add input event listeners for real-time validation
    document.addEventListener('DOMContentLoaded', function() {
      // Email validation
      document.getElementById("signup-email").addEventListener('input', () => {
        validateEmail();
        // Clear any previous error message
        const errorContainer = document.getElementById('form-error');
        if (errorContainer) errorContainer.style.display = 'none';
      });
      
      // Password validation
      document.getElementById("signup-password").addEventListener('input', () => {
        validatePassword();
        // Clear any previous error message
        const errorContainer = document.getElementById('form-error');
        if (errorContainer) errorContainer.style.display = 'none';
      });
      
      // Form submission
      document.getElementById('signup-form').addEventListener('submit', function(e) {
        e.preventDefault();
        window.signUp();
      });
      
      // Clear errors on focus
      document.querySelectorAll('input').forEach(input => {
        input.addEventListener('focus', function() {
          clearError(this.id);
        });
      });
    });
  </script>
</body>
</html>
