<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tyre Disposal History</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f5f5f5;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .container h1, h2, h3 {
      color: #2E8B57;
      margin-bottom: 20px;
    }

    .alert {
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 5px;
      font-weight: 500;
    }

    .alert-success {
      background-color: #d4edda;
      color: #155724;
      border-left: 4px solid #28a745;
    }

    .alert-danger {
      background-color: #f8d7da;
      color: #721c24;
      border-left: 4px solid #dc3545;
    }

    .form-section {
      background-color: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      border: 1px solid #eee;
    }

    .search-box {
      display: flex;
      margin-bottom: 20px;
    }

    .search-box input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px 0 0 5px;
      font-size: 16px;
    }

    .search-box button {
      padding: 10px 15px;
      background-color: #2E8B57;
      color: white;
      border: none;
      border-radius: 0 5px 5px 0;
      cursor: pointer;
    }

    .history-table {
      width: 100%;
      border-collapse: collapse;
    }

    .history-table th, .history-table td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }

    .history-table th {
      background-color: #2E8B57;
      color: white;
    }

    .history-table tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    .history-table tr:hover {
      background-color: #e9e9e9;
    }

    .stats-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background-color: #f9f9f9;
      border-radius: 8px;
      padding: 15px;
      flex: 1;
      min-width: 200px;
      border-left: 4px solid #2E8B57;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #2E8B57;
    }

    .stat-label {
      color: #666;
      font-size: 14px;
    }

    .filter-section {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-section select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background-color: #2E8B57;
      color: white;
    }

    .btn-primary:hover {
      background-color: #267349;
    }

    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background-color: #5a6268;
    }

    .btn-restore {
      background-color: #17a2b8;
      color: white;
    }
    @media (max-width: 768px) {
      .stats-container {
        flex-direction: column;
      }
      
      .filter-section {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <script src="navbar-loader.js"></script>
  
  <div class="container">
    <div id="alertContainer"></div>
    
    <h1>Tyre Disposal History</h1>
    
    <div class="form-section">
      <div class="stats-container" id="statsContainer">
        <!-- Stats will be populated dynamically -->
      </div>
      
      <div class="filter-section">
        <select id="vehicleFilter">
          <option value="">All Vehicles</option>
          <!-- Vehicle options will be populated dynamically -->
        </select>
        
        <select id="reasonFilter">
          <option value="">All Reasons</option>
          <!-- Reason options will be populated dynamically -->
        </select>
        
        <select id="timeFilter">
          <option value="all">All Time</option>
          <option value="week">Last Week</option>
          <option value="month">Last Month</option>
          <option value="quarter">Last 3 Months</option>
          <option value="year">Last Year</option>
        </select>
        
        <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
        <button class="btn btn-secondary" onclick="resetFilters()">Reset</button>
      </div>
      
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search by tyre number, brand...">
        <button onclick="searchHistory()">Search</button>
      </div>
      
      <table class="history-table">
        <thead>
          <tr>
            <th>Disposal Date</th>
            <th>Vehicle</th>
            <th>Tyre Number</th>
            <th>Brand</th>
            <th>Age at Disposal</th>
            <th>Added Date</th>
            <th>Position</th>
            <th>Reason</th>
            <th>Resell Price</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="historyTableBody">
          <!-- History entries will be populated dynamically -->
        </tbody>
      </table>

      <!-- Pagination Controls (Tab System) -->
      <div style="margin-top: 16px;">
        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:10px;">
          <label for="entriesPerPage" style="font-weight:600;">Entries per page:</label>
          <select id="entriesPerPage" style="padding:8px; border:1px solid #ccc; border-radius:6px;">
            <option value="5">5</option>
            <option value="10" selected>10</option>
            <option value="20">20</option>
            <option value="50">50</option>
          </select>
          <div id="entriesInfo" style="color:#666; font-size:14px;"></div>
        </div>
        <div style="display:flex; align-items:center; justify-content:center; gap:8px;">
          <button class="tab-nav-control" id="prevPage" style="padding:8px 12px; background:#43b97f; color:#fff; border:none; border-radius:4px; cursor:pointer;" disabled>
            <i class="fas fa-chevron-left"></i>
          </button>
          <div class="tab-navigation" id="tabNavigation" style="display:flex; gap:6px; flex-wrap:wrap; justify-content:center;"></div>
          <button class="tab-nav-control" id="nextPage" style="padding:8px 12px; background:#43b97f; color:#fff; border:none; border-radius:4px; cursor:pointer;">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getDatabase, ref, onValue, get, set, update, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDAlk_K8p8Of8Ne6Jpcl2QqXTtm95NgG7o",
      authDomain: "transport-dashboard-ad69a.firebaseapp.com",
      databaseURL: "https://transport-dashboard-ad69a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "transport-dashboard-ad69a",
      storageBucket: "transport-dashboard-ad69a.appspot.com",
      messagingSenderId: "526889676196",
      appId: "1:526889676196:web:66032c80a4aede690ae531",
      measurementId: "G-7F9R7HJYDH"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    let currentUser = null;
    let allHistoryData = [];
    let filteredHistoryData = [];

    // Pagination state
    const entriesPerPageSelect = document.getElementById('entriesPerPage');
    const entriesInfo = document.getElementById('entriesInfo');
    const tabNavigation = document.getElementById('tabNavigation');
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    let currentPage = 1;
    let itemsPerPage = 10;
    let totalPages = 1;

    // Make Firebase functions available globally
    window.db = db;
    window.ref = ref;
    window.get = get;
    window.currentUser = null; // Will be updated in onAuthStateChanged

    // Navbar is injected via navbar-loader.js

    // Check authentication
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }
      // Enforce main-branch only access
      const selectedBranch = localStorage.getItem('selectedBranch');
      if (selectedBranch && selectedBranch !== 'main') {
        console.error('Not allowed to use Tyre History in limited branch');
        if (confirm('This feature is only available in Main Branch. Go to Home?')) {
          window.location.href = 'home.html';
        }
        return;
      }
      // Role-based access: block normal users
      try {
        const profileSnap = await get(ref(db, `users/${user.uid}/profile`));
        const profile = profileSnap.exists() ? profileSnap.val() : {};
        const role = (profile.role || profile.userRole || 'normal').toLowerCase();
        if (role === 'normal') {
          showAlert('Access restricted: your role cannot view Tyre History. Redirecting to Home...', 'danger');
          setTimeout(() => { window.location.href = 'home.html'; }, 1200);
          return;
        }
      } catch (e) {
        console.warn('Failed to read user role, defaulting to restricted', e);
        showAlert('Access restricted. Redirecting to Home...', 'danger');
        setTimeout(() => { window.location.href = 'home.html'; }, 1200);
        return;
      }
      currentUser = user;
      window.currentUser = user; // Update the global reference
      loadTyreHistory();
    });

    // Show alert message
    window.showAlert = function(message, type) {
      const alertContainer = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      alertContainer.appendChild(alert);
      
      setTimeout(() => {
        alert.remove();
      }, 3000);
    };

    // Load tyre history
    window.loadTyreHistory = function() {
      const historyRef = ref(db, `users/${currentUser.uid}/tyre_history`);
      
      onValue(historyRef, (snapshot) => {
        if (!snapshot.exists()) {
          document.getElementById('historyTableBody').innerHTML = '<tr><td colspan="9">No disposal history found</td></tr>';
          updateStats([]);
          filteredHistoryData = [];
          renderHistoryWithPagination();
          return;
        }
        
        const historyData = [];
        snapshot.forEach((childSnapshot) => {
          const historyItem = childSnapshot.val();
          historyItem.id = childSnapshot.key;
          historyData.push(historyItem);
        });
        
        // Sort by disposal date (newest first)
        historyData.sort((a, b) => (b.disposedAt || 0) - (a.disposedAt || 0));
        
        // Store all data for filtering
        allHistoryData = historyData;
        // Update UI with pagination
        populateFilters(historyData);
        currentPage = 1;
        renderHistoryWithPagination();
        updateStats(computeFilteredData());
      });
    };

    // Render history table
    window.renderHistoryTable = function(historyData) {
      const tableBody = document.getElementById('historyTableBody');
      
      if (historyData.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="10">No matching records found</td></tr>';
        return;
      }
      
      let tableHtml = '';
      
      for (const item of historyData) {
        const disposalDate = item.disposedAt ? new Date(item.disposedAt).toLocaleDateString() : 'Unknown';
        const resellPrice = item.resellPrice ? `₹${item.resellPrice.toFixed(2)}` : 'N/A';
        const addedDate = item.addedAt ? new Date(item.addedAt).toLocaleDateString() : 'Unknown';
        
        // Calculate age at disposal
        let ageText = 'Unknown';
        if (item.addedAt && item.disposedAt) {
          const ageInDays = Math.floor((item.disposedAt - item.addedAt) / (1000 * 60 * 60 * 24));
          if (ageInDays < 30) {
            ageText = `${ageInDays} days`;
          } else if (ageInDays < 365) {
            ageText = `${Math.floor(ageInDays / 30)} months`;
          } else {
            ageText = `${Math.floor(ageInDays / 365)} years, ${Math.floor((ageInDays % 365) / 30)} months`;
          }
        }
        
        tableHtml += `
          <tr>
            <td>${disposalDate}</td>
            <td>${item.vehicleNumber} - ${item.vehicleModel}</td>
            <td>${item.number}</td>
            <td>${item.brand}</td>
            <td>${ageText}</td>
            <td>${addedDate}</td>
            <td>${item.position || 'N/A'}</td>
            <td>${item.disposalReason}</td>
            <td>${resellPrice}</td>
            <td>
              <button class="btn btn-sm btn-restore" onclick="restoreTyre('${item.id}')" title="Restore Tyre">
                <i class="fas fa-undo"></i> Restore
              </button>
            </td>
          </tr>
        `;
      }
      
      tableBody.innerHTML = tableHtml;
    };

    // Update statistics
    window.updateStats = function(historyData) {
      const statsContainer = document.getElementById('statsContainer');
      
      // Calculate statistics
      const totalDisposed = historyData.length;
      const totalResaleValue = historyData.reduce((sum, item) => sum + (item.resellPrice || 0), 0);
      
      // Count by reason
      const reasonCounts = {};
      for (const item of historyData) {
        const reason = item.disposalReason || 'Unknown';
        reasonCounts[reason] = (reasonCounts[reason] || 0) + 1;
      }
      
      // Get top 3 reasons
      const topReasons = Object.entries(reasonCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3);
      
      // Count by age groups
      let newTyres = 0; // < 30 days
      let usedTyres = 0; // 30-180 days
      let oldTyres = 0; // > 180 days
      
      for (const item of historyData) {
        if (item.addedAt && item.disposedAt) {
          const ageInDays = Math.floor((item.disposedAt - item.addedAt) / (1000 * 60 * 60 * 24));
          if (ageInDays <= 30) {
            newTyres++;
          } else if (ageInDays <= 180) {
            usedTyres++;
          } else {
            oldTyres++;
          }
        }
      }
      
      // Build stats HTML
      let statsHtml = `
        <div class="stat-card">
          <div class="stat-value">${totalDisposed}</div>
          <div class="stat-label">Total Disposed Tyres</div>
        </div>

        <div class="stat-card">
          <div class="stat-value">₹${totalResaleValue.toFixed(2)}</div>
          <div class="stat-label">Total Resale Value</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-value">${newTyres}</div>
          <div class="stat-label">New Tyres (<30 days)</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-value">${usedTyres}</div>
          <div class="stat-label">Used Tyres (1-6 months)</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-value">${oldTyres}</div>
          <div class="stat-label">Old Tyres (>6 months)</div>
        </div>
      `;
      
      // Add top reasons if available
      if (topReasons.length > 0) {
        statsHtml += `
          <div class="stat-card">
            <div class="stat-value">${topReasons[0][0]}</div>
            <div class="stat-label">Top Disposal Reason (${topReasons[0][1]} tyres)</div>
          </div>
        `;
      }
      
      statsContainer.innerHTML = statsHtml;
    };

    // Populate filter dropdowns
    window.populateFilters = function(historyData) {
      const vehicleFilter = document.getElementById('vehicleFilter');
      const reasonFilter = document.getElementById('reasonFilter');
      
      // Clear existing options except the first one
      while (vehicleFilter.options.length > 1) {
        vehicleFilter.remove(1);
      }
      
      while (reasonFilter.options.length > 1) {
        reasonFilter.remove(1);
      }
      
      // Get unique vehicles and reasons
      const vehicles = new Set();
      const reasons = new Set();
      
      for (const item of historyData) {
        if (item.vehicleNumber) {
          vehicles.add(`${item.vehicleNumber} - ${item.vehicleModel}`);
        }
        
        if (item.disposalReason) {
          reasons.add(item.disposalReason);
        }
      }
      
      // Add vehicle options
      for (const vehicle of Array.from(vehicles).sort()) {
        const option = document.createElement('option');
        option.value = vehicle;
        option.textContent = vehicle;
        vehicleFilter.appendChild(option);
      }
      
      // Add reason options
      for (const reason of Array.from(reasons).sort()) {
        const option = document.createElement('option');
        option.value = reason;
        option.textContent = reason;
        reasonFilter.appendChild(option);
      }
    };

    // Apply filters
    window.applyFilters = function() {
      const vehicleFilter = document.getElementById('vehicleFilter').value;
      const reasonFilter = document.getElementById('reasonFilter').value;
      const timeFilter = document.getElementById('timeFilter').value;
      
      currentPage = 1;
      renderHistoryWithPagination();
      updateStats(computeFilteredData());
    };

    // Reset filters
    window.resetFilters = function() {
      document.getElementById('vehicleFilter').value = '';
      document.getElementById('reasonFilter').value = '';
      document.getElementById('timeFilter').value = 'all';
      document.getElementById('searchInput').value = '';
      currentPage = 1;
      renderHistoryWithPagination();
      updateStats(computeFilteredData());
    };

    // Search history
    window.searchHistory = function() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      currentPage = 1;
      renderHistoryWithPagination();
      updateStats(computeFilteredData());
    };

    // Compute filtered dataset based on current UI controls
    function computeFilteredData() {
      const vehicleValue = document.getElementById('vehicleFilter').value;
      const reasonValue = document.getElementById('reasonFilter').value;
      const timeValue = document.getElementById('timeFilter').value;
      const searchTerm = (document.getElementById('searchInput').value || '').toLowerCase();
      let data = [...allHistoryData];
      if (vehicleValue) {
        data = data.filter(item => `${item.vehicleNumber} - ${item.vehicleModel}` === vehicleValue);
      }
      if (reasonValue) {
        data = data.filter(item => item.disposalReason === reasonValue);
      }
      if (timeValue !== 'all') {
        const now = Date.now();
        let timeLimit = 0;
        switch (timeValue) {
          case 'week': timeLimit = now - 7 * 24 * 60 * 60 * 1000; break;
          case 'month': timeLimit = now - 30 * 24 * 60 * 60 * 1000; break;
          case 'quarter': timeLimit = now - 90 * 24 * 60 * 60 * 1000; break;
          case 'year': timeLimit = now - 365 * 24 * 60 * 60 * 1000; break;
        }
        data = data.filter(item => item.disposedAt && item.disposedAt >= timeLimit);
      }
      if (searchTerm) {
        data = data.filter(item =>
          (item.number && item.number.toLowerCase().includes(searchTerm)) ||
          (item.brand && item.brand.toLowerCase().includes(searchTerm)) ||
          (item.vehicleNumber && item.vehicleNumber.toLowerCase().includes(searchTerm)) ||
          (item.disposalReason && item.disposalReason.toLowerCase().includes(searchTerm))
        );
      }
      return data;
    }

    function updatePaginationControls(totalItems) {
      prevPageBtn.disabled = currentPage === 1;
      nextPageBtn.disabled = currentPage === totalPages;
      const startIndex = Math.min((currentPage - 1) * itemsPerPage + 1, totalItems);
      const endIndex = Math.min(currentPage * itemsPerPage, totalItems);
      entriesInfo.textContent = `Showing ${totalItems === 0 ? 0 : startIndex} to ${endIndex} of ${totalItems} entries`;
      generatePageTabs();
    }

    function generatePageTabs() {
      tabNavigation.innerHTML = '';
      if (totalPages <= 1) return;
      addTab(1);
      let startPage = Math.max(2, currentPage - 2);
      let endPage = Math.min(totalPages - 1, currentPage + 2);
      if (startPage > 2) addEllipsis();
      for (let i = startPage; i <= endPage; i++) addTab(i);
      if (endPage < totalPages - 1) addEllipsis();
      addTab(totalPages);
    }

    function addTab(pageNumber) {
      const tab = document.createElement('div');
      tab.className = `tab ${pageNumber === currentPage ? 'active' : ''}`;
      tab.style.cssText = 'padding:6px 10px; background:#e0e0e0; border-radius:4px; cursor:pointer; min-width:36px; text-align:center;';
      tab.textContent = pageNumber;
      tab.addEventListener('click', () => {
        currentPage = pageNumber;
        renderHistoryWithPagination();
      });
      tabNavigation.appendChild(tab);
    }

    function addEllipsis() {
      const ellipsis = document.createElement('div');
      ellipsis.textContent = '...';
      ellipsis.style.cssText = 'padding:6px 10px; color:#666;';
      tabNavigation.appendChild(ellipsis);
    }

    function renderHistoryWithPagination() {
      filteredHistoryData = computeFilteredData();
      const totalItems = filteredHistoryData.length;
      totalPages = Math.max(1, Math.ceil(totalItems / itemsPerPage));
      if (currentPage > totalPages) currentPage = totalPages;
      updatePaginationControls(totalItems);
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
      const pageData = filteredHistoryData.slice(startIndex, endIndex);
      renderHistoryTable(pageData);
    }

    // Restore Tyre
    window.restoreTyre = async function(historyId) {
      if (!confirm('Are you sure you want to restore this tyre to its original vehicle?')) {
        return;
      }

      const historyItemRef = ref(db, `users/${currentUser.uid}/tyre_history/${historyId}`);
      const historySnapshot = await get(historyItemRef);

      if (!historySnapshot.exists()) {
        showAlert('History record not found.', 'danger');
        return;
      }

      const tyreToRestore = historySnapshot.val();
      // Destructure to get vehicle details and the remaining tyre data
      const { vehicleId, vehicleNumber, vehicleModel, disposedAt, disposalReason, ...originalTyreData } = tyreToRestore;

      if (!vehicleId) {
        showAlert('Cannot restore: Original vehicle ID is missing from this history record.', 'danger');
        return;
      }

      const vehicleRef = ref(db, `users/${currentUser.uid}/vehicles/${vehicleId}`);
      const vehicleSnapshot = await get(vehicleRef);

      try {
        if (vehicleSnapshot.exists()) {
          // Vehicle exists, add tyre back
          const vehicleData = vehicleSnapshot.val();
          const existingTyres = vehicleData.tyres || [];
          
          // Check if a tyre with the same number is already on the vehicle
          if (existingTyres.some(t => t.number === originalTyreData.number)) {
            showAlert(`Cannot restore: A tyre with number ${originalTyreData.number} already exists on vehicle ${vehicleNumber}.`, 'warning');
            return;
          }

          const updatedTyres = [...existingTyres, originalTyreData];
          await update(vehicleRef, { tyres: updatedTyres });
        } else {
          // Vehicle does not exist, recreate it with the tyre
          const newVehicleData = {
            vehicleNumber: vehicleNumber || 'Unknown Vehicle',
            vehicleModel: vehicleModel || 'Unknown Model',
            tyres: [originalTyreData],
            createdAt: Date.now(),
            updatedAt: Date.now()
          };
          await set(vehicleRef, newVehicleData);
        }

        // Remove from history
        await remove(historyItemRef);

        showAlert('Tyre restored successfully!', 'success');
      } catch (error) {
        console.error('Error restoring tyre:', error);
        showAlert(`Error restoring tyre: ${error.message}`, 'danger');
      }
    };

    // Hook up pagination controls
    entriesPerPageSelect.addEventListener('change', function () {
      itemsPerPage = parseInt(this.value, 10) || 10;
      currentPage = 1;
      renderHistoryWithPagination();
    });
    prevPageBtn.addEventListener('click', function () {
      if (currentPage > 1) {
        currentPage--;
        renderHistoryWithPagination();
      }
    });
    nextPageBtn.addEventListener('click', function () {
      if (currentPage < totalPages) {
        currentPage++;
        renderHistoryWithPagination();
      }
    });

    // Logout function
    window.logout = function() {
      signOut(auth).then(() => {
        window.location.href = "index.html";
      }).catch(error => {
        alert("Error logging out: " + error.message);
      });
    };

    // No toggle menu here; sidebar toggle handled by navbar-loader.js
  </script>
</body>
</html>
