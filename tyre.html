<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tyre Management System</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f5f5f5;
      color: #333;
    }

    #modelContainer {
      width: 100%;
      height: 450px;
      position: relative;
      background-color: #f0f0f0;
      border-radius: 8px;
    }

    /* Scanner Styles from tyre1.html */
    .scan-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 15px;
    }

    .scanner-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      display: none; /* Initially hidden */
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    #qr-reader {
      width: 80%;
      max-width: 500px;
      border: 2px solid #2E8B57;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }

    .scanner-controls {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }

    .scanner-close {
      position: absolute;
      top: 20px;
      right: 20px;
      color: white;
      font-size: 30px;
      cursor: pointer;
      z-index: 1001;
    }

    .scanner-instructions {
      color: white;
      text-align: center;
      margin-top: 15px;
      max-width: 80%;
    }

    /* Manual Input Fallback */
    .manual-input-fallback {
      background-color: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin-top: 15px;
      display: none;
    }

    .annotation {
      position: absolute;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      pointer-events: none; /* So it doesn't interfere with mouse controls */
    }

    /* Ensure body can scroll when modal is open */
    body.modal-open {
      overflow: hidden;
    }

    .container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .container h1, h2, h3 {
      color: #2E8B57;
      margin-bottom: 20px;
    }

    .alert {
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 5px;
      font-weight: 500;
    }

    .alert-success {
      background-color: #d4edda;
      color: #155724;
      border-left: 4px solid #28a745;
    }

    .alert-danger {
      background-color: #f8d7da;
      color: #721c24;
      border-left: 4px solid #dc3545;
    }

    .alert-warning {
      background-color: #fff3cd;
      color: #856404;
      border-left: 4px solid #ffc107;
    }

    .form-section {
      background-color: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      border: 1px solid #eee;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }

    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #2E8B57;
      box-shadow: 0 0 5px rgba(46, 139, 87, 0.2);
    }

    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
      margin: 5px 0;
    }

    /* Card Deck Styles */
    .card-deck {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }

    .card-header {
      background-color: #2E8B57;
      color: white;
      padding: 15px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-header h3 {
      margin: 0;
      color: white;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .vehicle-number {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .vehicle-icon {
      font-size: 1.2em;
    }

    .card-body {
      padding: 0;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .card.expanded .card-body {
      padding: 15px;
      max-height: 100vh; /* Use viewport height as a sensible limit */
      overflow-y: auto; /* Add a scrollbar if content exceeds the viewport height */
    }

    .tyre-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .tyre-item {
      padding: 12px 120px 12px 15px;
      margin: 8px 0;
      background: #ffffff;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      border-left: 4px solid #2E8B57;
      position: relative;
      min-height: 60px;
      transition: all 0.2s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .tyre-item:hover {
      transform: translateX(2px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .tyre-actions {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      gap: 8px;
    }
    
    .tyre-actions {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      gap: 5px;
    }
    
    .tyre-actions .btn {
      width: 30px;
      height: 30px;
      padding: 0;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      transition: all 0.2s ease;
    }
    
    .tyre-actions .btn i {
      font-size: 12px;
      margin: 0;
    }
    
    .tyre-actions .btn:hover {
      transform: scale(1.1);
    }
    
    .status-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .status-badge.active {
      background-color: #d4edda;
      color: #155724;
    }
    
    .status-badge.worn {
      background-color: #fff3cd;
      color: #856404;
    }
    
    .status-badge.damaged {
      background-color: #f8d7da;
      color: #721c24;
    }
    
    .tyre-details {
      margin-right: 10px;
    }

    .rotate-icon {
      transition: transform 0.3s ease;
    }

    .card.expanded .rotate-icon {
      transform: rotate(180deg);
    }

    .btn-primary {
      background-color: #2E8B57;
      color: white;
    }

    .btn-primary:hover {
      background-color: #267349;
    }

    .btn-danger {
      background-color: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background-color: #c82333;
    }

    .btn-warning {
      background-color: #ffc107;
      color: #212529;
    }

    .btn-warning:hover {
      background-color: #e0a800;
    }

    .btn-info {
      background-color: #17a2b8;
      color: white;
    }

    .btn-info:hover {
      background-color: #138496;
    }

    .tyre-container {
      background-color: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid #2E8B57;
    }

    .tyre-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .tyre-title {
      font-weight: 600;
      color: #333;
      font-size: 18px;
    }

    .remove-tyre {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }

    .remove-tyre:hover {
      background-color: #c82333;
    }

    /* Summary Dashboard Styles */
    .summary-dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .summary-card {
      background-color: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #2E8B57;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .summary-card h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .summary-card p {
      font-size: 28px;
      font-weight: 700;
      color: #2E8B57;
      margin: 0;
    }

    .tyre-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .vehicle-card {
      background-color: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #2E8B57;
    }

    .vehicle-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      font-weight: 600;
      color: #333;
      font-size: 18px;
    }

    .vehicle-actions {
      display: flex;
      gap: 10px;
    }

    .tyre-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }

    .tyre-card {
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #ddd;
      position: relative;
    }

    .tyre-actions {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 5px;
    }

    .action-btn {
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      color: white;
    }

    .edit-btn {
      background-color: #ffc107;
      color: #212529;
    }

    .delete-btn {
      background-color: #dc3545;
    }

    .duplicate-btn {
      background-color: #17a2b8;
    }

    .search-section {
      margin-bottom: 20px;
    }

    .search-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
      margin-bottom: 10px;
    }

    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      .tyre-row {
        grid-template-columns: 1fr;
      }
      
      .tyre-grid {
        grid-template-columns: 1fr;
      }
      
      .vehicle-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .vehicle-actions {
        margin-top: 10px;
      }
    }
  </style>
</head>
<body>
  <script src="navbar-loader.js"></script>
  <script src="table-pager.js"></script>

  <div class="container">
    <h1>Tyre Management System</h1>
    
    <!-- Summary Dashboard -->
    <div class="summary-dashboard">
      <div class="summary-card">
        <h3><i class="fas fa-truck"></i> Total Vehicles</h3>
        <p id="totalVehiclesStat">0</p>
      </div>
      <div class="summary-card">
        <h3><i class="fas fa-coins"></i> Total Tyre Investment</h3>
        <p id="totalInvestmentStat">₹0</p>
      </div>
    </div>

    <div id="alertContainer"></div>
    
    <!-- Search Section -->
    <div class="search-section">
      <h3>Search Vehicles</h3>
      <input type="text" id="searchInput" class="search-input" placeholder="Search by vehicle number, model, or tyre details...">
      <button class="btn btn-primary" onclick="searchVehicles()">Search</button>
      <button class="btn btn-primary" onclick="loadVehicles()">Show All</button>
    </div>
    
    <!-- Add Vehicle Form -->
    <div class="form-section">
      <h3 id="formTitle">Add New Vehicle</h3>
      
      <div class="form-group">
        <label for="vehicleNumber">Vehicle Number:</label>
        <input type="text" id="vehicleNumber" placeholder="e.g., RJ38GA2433" required>
      </div>
      
      <div class="form-group">
        <label for="vehicleModel">Vehicle Model:</label>
        <input type="text" id="vehicleModel" placeholder="e.g., Tata Bulker Z" required>
      </div>
      
      <div id="tyresContainer">
        <div class="tyre-container">
          <div class="tyre-header">
            <span class="tyre-title">Tyre 1</span>
          </div>
          <div class="tyre-row">
            <div class="form-group">
              <label>Tyre Number:</label>
              <input type="text" class="tyre-number" placeholder="e.g., T001" required>
            </div>
            <div class="form-group">
              <label>Brand:</label>
              <input type="text" class="tyre-brand" placeholder="e.g., Apollo" required>
            </div>
            <div class="form-group">
              <label>Position:</label>
              <input type="text" class="tyre-position" placeholder="e.g., Front-Left" required>
            </div>
            <div class="form-group">
              <label>Added Date:</label>
              <input type="date" class="tyre-added-date" required>
            </div>
            <div class="form-group">
              <label>Cost (₹):</label>
              <input type="number" class="tyre-cost" placeholder="e.g., 5000" required>
            </div>
          </div>
        </div>
      </div>
      
      <button class="btn btn-primary" onclick="addTyre()">Add Another Tyre</button>
      <button class="btn btn-primary" id="saveVehicleBtn" onclick="saveVehicle()">Save Vehicle</button>
      <button class="btn btn-danger" id="cancelEditBtn" onclick="cancelEdit()" style="display: none;">Cancel</button>
    </div>
    
    <!-- Vehicle List Section -->
    <div class="form-section">
      <h3>Vehicle List</h3>
      <div id="vehicleList"></div>
      <!-- Pagination Controls (Tab System) for Vehicle Cards -->
      <div style="margin-top: 16px;">
        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:10px;">
          <label for="entriesPerPageVehicles" style="font-weight:600;">Entries per page:</label>
          <select id="entriesPerPageVehicles" style="padding:8px; border:1px solid #ccc; border-radius:6px;">
            <option value="5">5</option>
            <option value="10" selected>10</option>
            <option value="20">20</option>
            <option value="50">50</option>
          </select>
          <div id="entriesInfoVehicles" style="color:#666; font-size:14px;"></div>
        </div>
        <div style="display:flex; align-items:center; justify-content:center; gap:8px;">
          <button class="tab-nav-control" id="prevVehicles" style="padding:8px 12px; background:#43b97f; color:#fff; border:none; border-radius:4px; cursor:pointer;" disabled>
            <i class="fas fa-chevron-left"></i>
          </button>
          <div class="tab-navigation" id="tabNavigationVehicles" style="display:flex; gap:6px; flex-wrap:wrap; justify-content:center;"></div>
          <button class="tab-nav-control" id="nextVehicles" style="padding:8px 12px; background:#43b97f; color:#fff; border:none; border-radius:4px; cursor:pointer;">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- PDF Generation Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged ,signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getDatabase, ref, set, push, onValue, update, remove, get, child } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDAlk_K8p8Of8Ne6Jpcl2QqXTtm95NgG7o",
      authDomain: "transport-dashboard-ad69a.firebaseapp.com",
      databaseURL: "https://transport-dashboard-ad69a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "transport-dashboard-ad69a",
      storageBucket: "transport-dashboard-ad69a.appspot.com",
      messagingSenderId: "526889676196",
      appId: "1:526889676196:web:66032c80a4aede690ae531",
      measurementId: "G-7F9R7HJYDH"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    let currentUser = null;
    let editingVehicleId = null;
    let tyreCount = 1;
    let allVehiclesData = {};

    // Pagination state for vehicle cards
    const entriesPerPageVehicles = document.getElementById('entriesPerPageVehicles');
    const entriesInfoVehicles = document.getElementById('entriesInfoVehicles');
    const tabNavigationVehicles = document.getElementById('tabNavigationVehicles');
    const prevVehiclesBtn = document.getElementById('prevVehicles');
    const nextVehiclesBtn = document.getElementById('nextVehicles');
    let currentPageVehicles = 1;
    let itemsPerPageVehicles = 10;
    let totalPagesVehicles = 1;
    let searchTermVehicles = '';

    // Make Firebase functions available globally
    window.db = db;
    window.ref = ref;
    window.get = get;
    window.currentUser = null; // Will be updated in onAuthStateChanged

    // Navbar is now injected via navbar-loader.js

    // Check authentication
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }
      // Enforce main-branch only access
      const selectedBranch = localStorage.getItem('selectedBranch');
      if (selectedBranch && selectedBranch !== 'main') {
        console.error('Not allowed to use Tyre module in limited branch');
        if (confirm('This feature is only available in Main Branch. Go to Home?')) {
          window.location.href = 'home.html';
        }
        return;
      }
      // Role-based access: block normal users
      try {
        const profileSnap = await get(ref(db, `users/${user.uid}/profile`));
        const profile = profileSnap.exists() ? profileSnap.val() : {};
        const role = (profile.role || profile.userRole || 'normal').toLowerCase();
        if (role === 'normal') {
          showAlert('Access restricted: your role cannot use Tyre Management. Redirecting to Home...', 'danger');
          setTimeout(() => { window.location.href = 'home.html'; }, 1200);
          return;
        }
      } catch (e) {
        console.warn('Failed to read user role, defaulting to restricted', e);
        showAlert('Access restricted. Redirecting to Home...', 'danger');
        setTimeout(() => { window.location.href = 'home.html'; }, 1200);
        return;
      }
      currentUser = user;
      window.currentUser = user; // Update the global reference
      loadVehicles();
    });

    // Show alert message
    window.showAlert = function(message, type) {
      const alertContainer = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      alertContainer.appendChild(alert);
      
      setTimeout(() => {
        alert.remove();
      }, 3000);
    };

    // Add new tyre input fields
    window.addTyre = function() {
      // Get all existing tyre numbers to find the highest one
      const tyreNumbers = [];
      document.querySelectorAll('.tyre-number').forEach(input => {
        const num = parseInt(input.value.replace(/\D/g, ''));
        if (!isNaN(num)) {
          tyreNumbers.push(num);
        }
      });
      
      // Start from 1 if no tyres, otherwise continue from the highest number + 1
      const nextTyreNum = tyreNumbers.length > 0 ? Math.max(...tyreNumbers) + 1 : 1;
      
      const tyresContainer = document.getElementById('tyresContainer');
      
      const tyreDiv = document.createElement('div');
      tyreDiv.className = 'tyre-container';
      tyreDiv.innerHTML = `
        <div class="tyre-header">
          <span class="tyre-title">Tyre ${nextTyreNum}</span>
          <button class="remove-tyre" onclick="removeTyre(this)">Remove</button>
        </div>
        <div class="tyre-row">
          <div class="form-group">
            <label>Tyre Number:</label>
            <input type="text" class="tyre-number" value="T${String(nextTyreNum).padStart(3, '0')}" required>
          </div>
          <div class="form-group">
            <label>Brand:</label>
            <input type="text" class="tyre-brand" placeholder="e.g., MRF" required>
          </div>
          <div class="form-group">
            <label>Position:</label>
            <input type="text" class="tyre-position" placeholder="e.g., Rear-Right-Outer" required>
          </div>
          <div class="form-group">
            <label>Added Date:</label>
            <input type="date" class="tyre-added-date" required>
          </div>
          <div class="form-group">
            <label>Cost (₹):</label>
            <input type="number" class="tyre-cost" placeholder="e.g., 5000" required>
          </div>
        </div>
      `;
      
      tyresContainer.appendChild(tyreDiv);
      
      // Update the tyre count to the highest number used
      tyreCount = Math.max(tyreCount, nextTyreNum);
    };

    // Remove tyre input fields
    window.removeTyre = function(button) {
      const tyreContainer = button.closest('.tyre-container');
      tyreContainer.remove();
      
      // Update tyre titles
      const tyreTitles = document.querySelectorAll('.tyre-title');
      tyreTitles.forEach((title, index) => {
        title.textContent = `Tyre ${index + 1}`;
      });
      
      tyreCount = tyreTitles.length;
    };

    // Save vehicle and tyres
    window.saveVehicle = async function() {
      const vehicleNumber = document.getElementById('vehicleNumber').value.trim().toUpperCase();
      const vehicleModel = document.getElementById('vehicleModel').value.trim();
      
      if (!vehicleNumber || !vehicleModel) {
        showAlert('Please fill in all vehicle details', 'warning');
        return;
      }
      
      // Get all tyre inputs
      const tyreContainers = document.querySelectorAll('.tyre-container');
      const newTyres = [];
      const tyreNumbers = new Set();
      
      for (const container of tyreContainers) {
        const tyreNumber = container.querySelector('.tyre-number').value.trim();
        const tyreBrand = container.querySelector('.tyre-brand').value.trim();
        const tyrePosition = container.querySelector('.tyre-position').value.trim();
        const tyreAddedDate = container.querySelector('.tyre-added-date').value;
        const tyreCost = container.querySelector('.tyre-cost').value;
        
        if (!tyreNumber || !tyreBrand || !tyrePosition || !tyreAddedDate || !tyreCost) {
          showAlert('Please fill in all tyre details, including cost', 'warning');
          return;
        }
        
        // Check for duplicate tyre numbers within the form
        if (tyreNumbers.has(tyreNumber)) {
          showAlert(`Duplicate tyre number: ${tyreNumber}`, 'danger');
          return;
        }
        
        tyreNumbers.add(tyreNumber);
        
        newTyres.push({
          number: tyreNumber,
          brand: tyreBrand,
          position: tyrePosition,
          addedAt: new Date(tyreAddedDate).getTime(),
          cost: parseFloat(tyreCost) || 0
        });
      }
      
      if (newTyres.length === 0) {
        showAlert('Please add at least one tyre', 'warning');
        return;
      }
      
      try {
        // Check if we're in edit mode
        if (editingVehicleId) {
          // Get the existing vehicle data
          const vehicleRef = ref(db, `users/${currentUser.uid}/vehicles/${editingVehicleId}`);
          const snapshot = await get(vehicleRef);
          
          if (snapshot.exists()) {
            const existingVehicle = snapshot.val();
            const existingTyres = existingVehicle.tyres || [];
            
            // If we're editing a specific tyre (tyre edit mode)
            const isEditingSingleTyre = document.getElementById('saveVehicleBtn').textContent === 'Update Tyre';
            
            let updatedTyres = [];
            
            if (isEditingSingleTyre) {
              // In tyre edit mode, replace only the edited tyre and keep others
              const editedTyreNumber = document.querySelector('.tyre-number[readonly]')?.value;
              if (editedTyreNumber) {
                updatedTyres = existingTyres.map(t => t.number === editedTyreNumber ? newTyres[0] : t);
              } else {
                // Fallback if the readonly field isn't found, though it should be.
                updatedTyres = [...existingTyres, ...newTyres];
              }
            } else {
              // In add tyre mode, add new tyres to existing ones
              updatedTyres = [...existingTyres, ...newTyres];
            }
            
            // Check for duplicate tyre numbers across all vehicles
            const allVehiclesRef = ref(db, `users/${currentUser.uid}/vehicles`);
            const allVehiclesSnapshot = await get(allVehiclesRef);
            
            if (allVehiclesSnapshot.exists()) {
              const allVehicles = allVehiclesSnapshot.val();
              
              for (const vehicleKey in allVehicles) {
                // Skip the current vehicle we're editing
                if (vehicleKey === editingVehicleId) continue;
                
                const vehicleTyres = allVehicles[vehicleKey].tyres || [];
                
                for (const newTyre of newTyres) {
                  const isDuplicate = vehicleTyres.some(t => t.number === newTyre.number);
                  if (isDuplicate) {
                    showAlert(`Tyre number ${newTyre.number} already exists in another vehicle`, 'danger');
                    return;
                  }
                }
              }
            }
            
            // Update the vehicle with the combined tyres
            await update(vehicleRef, {
              vehicleNumber,
              vehicleModel,
              tyres: updatedTyres,
              updatedAt: Date.now()
            });
            
            showAlert(isEditingSingleTyre ? 'Tyre updated successfully' : 'Tyres added successfully', 'success');
          }
        } else {
          // This is a new vehicle
          const vehiclesRef = ref(db, `users/${currentUser.uid}/vehicles`);
          const snapshot = await get(vehiclesRef);
          
          // Check for duplicate vehicle number
          if (snapshot.exists()) {
            const vehicles = snapshot.val();
            for (const key in vehicles) {
              if (vehicles[key].vehicleNumber === vehicleNumber) {
                showAlert(`Vehicle with number ${vehicleNumber} already exists`, 'danger');
                return;
              }
            }
          }
          
          // Check for duplicate tyre numbers across all vehicles
          if (snapshot.exists()) {
            const vehicles = snapshot.val();
            for (const key in vehicles) {
              const vehicleTyres = vehicles[key].tyres || [];
              for (const newTyre of newTyres) {
                const isDuplicate = vehicleTyres.some(t => t.number === newTyre.number);
                if (isDuplicate) {
                  showAlert(`Tyre number ${newTyre.number} already exists in another vehicle`, 'danger');
                  return;
                }
              }
            }
          }
          
          // Add new vehicle
          await push(vehiclesRef, {
            vehicleNumber,
            vehicleModel,
            tyres: newTyres,
            createdAt: Date.now(),
            updatedAt: Date.now()
          });
          
          showAlert('Vehicle added successfully', 'success');
        }
        
        // Reset form and reload the vehicle list
        resetForm();
        loadVehicles();
      } catch (error) {
        console.error('Error saving vehicle:', error);
        showAlert(`Error: ${error.message}`, 'danger');
      }
    };

    // Load vehicles from database with card deck layout (single realtime listener)
    window.loadVehicles = function() {
      const vehicleListContainer = document.getElementById('vehicleList');
      const vehiclesRef = ref(db, `users/${currentUser.uid}/vehicles`);
      onValue(vehiclesRef, (snapshot) => {
        const vehicles = snapshot.val() || {};
        allVehiclesData = vehicles;
        updateSummaryDashboard(); // Update the new dashboard
        renderVehiclesWithPagination(); // This will now handle pagination
      });
    };

    function computeFilteredVehicles() {
      const term = (searchTermVehicles || '').toLowerCase();
      const entries = Object.entries(allVehiclesData);
      if (!term) return entries;
      return entries.filter(([id, vehicle]) => {
        const vnum = (vehicle.vehicleNumber || '').toLowerCase();
        const vmodel = (vehicle.vehicleModel || '').toLowerCase();
        const tyres = vehicle.tyres || {};
        const tyreMatch = Object.values(tyres).some(t =>
          ((t.number || '').toLowerCase().includes(term)) ||
          ((t.brand || '').toLowerCase().includes(term))
        );
        return vnum.includes(term) || vmodel.includes(term) || tyreMatch;
      });
    }

    function renderVehiclesWithPagination() {
      const vehicleListContainer = document.getElementById('vehicleList');
      const filtered = computeFilteredVehicles();
      const totalItems = filtered.length;
      totalPagesVehicles = Math.max(1, Math.ceil(totalItems / itemsPerPageVehicles));
      if (currentPageVehicles > totalPagesVehicles) currentPageVehicles = totalPagesVehicles;
      updateVehiclePaginationControls(totalItems);
      const start = (currentPageVehicles - 1) * itemsPerPageVehicles;
      const end = Math.min(start + itemsPerPageVehicles, totalItems);
      const pageEntries = filtered.slice(start, end);

      if (pageEntries.length === 0 && !searchTermVehicles) {
        vehicleListContainer.innerHTML = '<p>No vehicles found. Add a vehicle to get started.</p>';
        return;
      }
      let html = '';
      pageEntries.forEach(([id, vehicle]) => {
        const tyreCountLocal = vehicle.tyres ? Object.keys(vehicle.tyres).length : 0;
        const totalTyreCost = (vehicle.tyres || []).reduce((sum, tyre) => sum + (parseFloat(tyre.cost) || 0), 0);
        html += `
          <div class="card" id="vehicle-${id}">
            <div class="card-header" onclick="toggleVehicleCard('${id}')">
              <h3>
                <span class="vehicle-number">
                  <i class="fas fa-truck vehicle-icon"></i>
                  ${vehicle.vehicleNumber || 'N/A'}
                </span>
              </h3>
              <span class="rotate-icon">▼</span>
            </div>
            <div class="card-body">
              <p><strong>Model:</strong> ${vehicle.vehicleModel || 'N/A'}</p>
              <p><strong>Tyres:</strong> ${tyreCountLocal}</p>
              <p><strong>Total Tyre Cost:</strong> ₹${totalTyreCost.toFixed(2)}</p>
              ${tyreCountLocal > 0 ? `
                <h4>Tyre Details</h4>
                <ul class="tyre-list">
                  ${Object.entries(vehicle.tyres || {}).map(([tyreId, tyre]) => `
                    <li class="tyre-item">
                      <div class="tyre-details">
                        <div><strong>#${tyre.number || 'N/A'}</strong> - ${tyre.brand || ''}</div>
                        <div>Status: <span class="status-badge ${tyre.status ? tyre.status.toLowerCase() : 'active'}">${tyre.status || 'Active'}</span></div>
                        <div>Position: <strong>${tyre.position || 'N/A'}</strong> | Added: <strong>${tyre.addedAt ? new Date(tyre.addedAt).toLocaleDateString() : 'N/A'}</strong> | Cost: <strong>₹${(tyre.cost || 0).toFixed(2)}</strong></div>
                      </div>
                      <div class="tyre-actions">
                        <button onclick="event.stopPropagation(); editTyre('${id}', '${tyre.number}')" class="btn btn-primary" title="Edit Tyre">
                          <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="event.stopPropagation(); if(confirm('Are you sure you want to dispose this tyre? This action cannot be undone.')) { disposeTyre('${id}', '${tyre.number}') }" class="btn btn-danger" title="Dispose Tyre">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </li>
                  `).join('')}
                </ul>
              ` : '<p>No tyres added yet.</p>'}
              <div class="vehicle-actions" style="margin-top: 15px;">
                <button onclick="event.stopPropagation(); addTyreToVehicle('${id}')" class="btn btn-primary">Add Tyre</button>
                <button onclick="event.stopPropagation(); editVehicle('${id}')" class="btn btn-secondary">Edit Vehicle</button>
                <button onclick="event.stopPropagation(); downloadVehicleTyrePDF('${id}')" class="btn btn-info">
                  <i class="fas fa-file-pdf"></i> Download PDF
                </button>
                <button onclick="event.stopPropagation(); deleteVehicle('${id}')" class="btn btn-danger">Delete</button>
              </div>
            </div>
          </div>
        `;
      });
      vehicleListContainer.innerHTML = html;
    }

    // Update the summary dashboard with fleet-wide stats
    function updateSummaryDashboard() {
      const vehicles = Object.values(allVehiclesData);
      const totalVehicles = vehicles.length;

      let totalInvestment = 0;
      vehicles.forEach(vehicle => {
        if (vehicle.tyres && Array.isArray(vehicle.tyres)) {
          const vehicleTyreCost = vehicle.tyres.reduce((sum, tyre) => sum + (parseFloat(tyre.cost) || 0), 0);
          totalInvestment += vehicleTyreCost;
        }
      });

      const totalVehiclesEl = document.getElementById('totalVehiclesStat');
      const totalInvestmentEl = document.getElementById('totalInvestmentStat');
      if (totalVehiclesEl) totalVehiclesEl.textContent = totalVehicles;
      if (totalInvestmentEl) totalInvestmentEl.textContent = `₹${totalInvestment.toFixed(2)}`;
    }

    function updateVehiclePaginationControls(totalItems) {
      prevVehiclesBtn.disabled = currentPageVehicles === 1;
      nextVehiclesBtn.disabled = currentPageVehicles === totalPagesVehicles;
      const startIndex = Math.min((currentPageVehicles - 1) * itemsPerPageVehicles + 1, totalItems);
      const endIndex = Math.min(currentPageVehicles * itemsPerPageVehicles, totalItems);
      entriesInfoVehicles.textContent = `Showing ${totalItems === 0 ? 0 : startIndex} to ${endIndex} of ${totalItems} entries`;
      generateVehicleTabs();
    }

    function generateVehicleTabs() {
      tabNavigationVehicles.innerHTML = '';
      if (totalPagesVehicles <= 1) return;
      addVehicleTab(1);
      let startPage = Math.max(2, currentPageVehicles - 2);
      let endPage = Math.min(totalPagesVehicles - 1, currentPageVehicles + 2);
      if (startPage > 2) addVehicleEllipsis();
      for (let i = startPage; i <= endPage; i++) addVehicleTab(i);
      if (endPage < totalPagesVehicles - 1) addVehicleEllipsis();
      addVehicleTab(totalPagesVehicles);
    }

    function addVehicleTab(pageNumber) {
      const tab = document.createElement('div');
      tab.className = `tab ${pageNumber === currentPageVehicles ? 'active' : ''}`;
      tab.style.cssText = 'padding:6px 10px; background:#e0e0e0; border-radius:4px; cursor:pointer; min-width:36px; text-align:center;';
      if (pageNumber === currentPageVehicles) {
        tab.style.background = '#43b97f';
        tab.style.color = '#fff';
      }
      tab.textContent = pageNumber;
      tab.addEventListener('click', () => {
        currentPageVehicles = pageNumber;
        renderVehiclesWithPagination();
      });
      tabNavigationVehicles.appendChild(tab);
    }

    function addVehicleEllipsis() {
      const ellipsis = document.createElement('div');
      ellipsis.textContent = '...';
      ellipsis.style.cssText = 'padding:6px 10px; color:#666;';
      tabNavigationVehicles.appendChild(ellipsis);
    }

    // Toggle vehicle card expansion
    window.toggleVehicleCard = function(vehicleId) {
      const card = document.getElementById(`vehicle-${vehicleId}`);
      if (card) {
        card.classList.toggle('expanded');
      }
    };

    // Search vehicles function
    window.searchVehicles = function() {
      searchTermVehicles = document.getElementById('searchInput').value.trim();
      renderVehiclesWithPagination();
    };

    // Remove duplicate searchVehicles; handled above with pagination

    // Edit vehicle
    window.editVehicle = function(vehicleId) {
      const vehicleRef = ref(db, `users/${currentUser.uid}/vehicles/${vehicleId}`);
      
      get(vehicleRef).then((snapshot) => {
        if (snapshot.exists()) {
          const vehicle = snapshot.val();
          
          // Set form to edit mode
          document.getElementById('formTitle').textContent = 'Edit Vehicle';
          document.getElementById('vehicleNumber').value = vehicle.vehicleNumber;
          document.getElementById('vehicleModel').value = vehicle.vehicleModel;
          
          // Clear existing tyre inputs
          document.getElementById('tyresContainer').innerHTML = '';
          
          // Add tyre inputs for each existing tyre
          const tyres = vehicle.tyres || [];
          tyreCount = 0;
          
          // First pass: find the highest tyre number
          let maxTyreNumber = 0;
          for (const tyre of tyres) {
            const tyreNum = parseInt(tyre.number.replace(/\D/g, '')) || 0;
            maxTyreNumber = Math.max(maxTyreNumber, tyreNum);
          }
          
          // Second pass: create tyre inputs
          for (const tyre of tyres) {
            tyreCount++;
            const tyreDiv = document.createElement('div');
            tyreDiv.className = 'tyre-container';
            tyreDiv.innerHTML = `
              <div class="tyre-header">
                <span class="tyre-title">Tyre ${tyreCount}</span>
                ${tyreCount > 1 ? '<button class="remove-tyre" onclick="removeTyre(this)">Remove</button>' : ''}
              </div>
              <div class="tyre-row">
                <div class="form-group">
                  <label>Tyre Number:</label>
                  <input type="text" class="tyre-number" value="${tyre.number}" required>
                </div>
                <div class="form-group">
                  <label>Brand:</label>
                  <input type="text" class="tyre-brand" value="${tyre.brand}" required>
                </div>
                <div class="form-group">
                  <label>Position:</label>
                  <input type="text" class="tyre-position" value="${tyre.position}" required>
                </div>
                <div class="form-group">
                  <label>Added Date:</label>
                  <input type="date" class="tyre-added-date" value="${tyre.addedAt ? new Date(tyre.addedAt).toISOString().split('T')[0] : ''}" required>
                </div>
                <div class="form-group">
                  <label>Cost (₹):</label>
                  <input type="number" class="tyre-cost" value="${tyre.cost || 0}" required>
                </div>
              </div>
            `;
            
            document.getElementById('tyresContainer').appendChild(tyreDiv);
          }
          
          // Update tyreCount to the highest number found or the number of tyres, whichever is higher
          tyreCount = Math.max(tyreCount, maxTyreNumber);
          
          // If no tyres, add one empty tyre input
          if (tyreCount === 0) {
            addTyre();
          }
          
          // Set editing state
          editingVehicleId = vehicleId;
          document.getElementById('saveVehicleBtn').textContent = 'Update Vehicle';
          document.getElementById('cancelEditBtn').style.display = 'inline-block';
          
          // Scroll to form
          document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
        }
      });
    };

    // Delete vehicle
    window.deleteVehicle = function(vehicleId) {
      if (confirm('Are you sure you want to delete this vehicle? All its tyres will be moved to the disposal history.')) {
        const vehicleRef = ref(db, `users/${currentUser.uid}/vehicles/${vehicleId}`);
        get(vehicleRef).then(snapshot => {
          if (!snapshot.exists()) {
            showAlert('Vehicle not found.', 'danger');
            return;
          }

          const vehicle = snapshot.val();
          const tyresToDispose = vehicle.tyres || [];

          if (tyresToDispose.length > 0) {
            const historyRef = ref(db, `users/${currentUser.uid}/tyre_history`);
            const updates = {};

            tyresToDispose.forEach(tyre => {
              const newHistoryRef = push(historyRef);
              updates[newHistoryRef.key] = {
                ...tyre,
                disposedAt: Date.now(),
                disposalReason: 'Vehicle Deleted',
                vehicleId: vehicleId, // Important for restore
                vehicleNumber: vehicle.vehicleNumber,
                vehicleModel: vehicle.vehicleModel
              };
            });

            update(historyRef, updates);
          }

          // After archiving tyres, remove the vehicle
          remove(vehicleRef).then(() => {
            showAlert('Vehicle deleted and tyres moved to history.', 'success');
            // loadVehicles() is called automatically by the onValue listener
          }).catch(error => showAlert(`Error deleting vehicle: ${error.message}`, 'danger'));

        }).catch(error => showAlert(`Error fetching vehicle data: ${error.message}`, 'danger'));
      }
    };

    // Add tyre to existing vehicle
    window.addTyreToVehicle = function(vehicleId) {
      // Set form to add tyre mode
      resetForm();
      document.getElementById('formTitle').textContent = 'Add Tyre to Vehicle';
      
      // Get vehicle details
      get(ref(db, `users/${currentUser.uid}/vehicles/${vehicleId}`)).then((snapshot) => {
        if (snapshot.exists()) {
          const vehicle = snapshot.val();
          
          // Set vehicle fields and disable them
          document.getElementById('vehicleNumber').value = vehicle.vehicleNumber;
          document.getElementById('vehicleModel').value = vehicle.vehicleModel;
          document.getElementById('vehicleNumber').disabled = true;
          document.getElementById('vehicleModel').disabled = true;
          
          // Set tyre count based on existing tyres
          tyreCount = vehicle.tyres ? vehicle.tyres.length : 0;
          
          // Set editing state
          editingVehicleId = vehicleId;
          document.getElementById('saveVehicleBtn').textContent = 'Add Tyre to Vehicle';
          document.getElementById('cancelEditBtn').style.display = 'inline-block';
          
          // Add one empty tyre input
          addTyre();
          
          // Scroll to form
          document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
        }
      });
    };

    // Edit specific tyre
    window.editTyre = function(vehicleId, tyreNumber) {
      get(ref(db, `users/${currentUser.uid}/vehicles/${vehicleId}`)).then((snapshot) => {
        if (snapshot.exists()) {
          const vehicle = snapshot.val();
          const tyres = vehicle.tyres || [];
          const tyreToEdit = tyres.find(t => t.number === tyreNumber);
          
          if (tyreToEdit) {
            // Set form to edit tyre mode
            resetForm();
            document.getElementById('formTitle').textContent = 'Edit Tyre';
            
            // Set vehicle fields and disable them
            document.getElementById('vehicleNumber').value = vehicle.vehicleNumber;
            document.getElementById('vehicleModel').value = vehicle.vehicleModel;
            document.getElementById('vehicleNumber').disabled = true;
            document.getElementById('vehicleModel').disabled = true;
            
            // Add tyre input with the tyre details
            const tyreDiv = document.createElement('div');
            tyreDiv.className = 'tyre-container';
            tyreDiv.innerHTML = `
              <div class="tyre-header">
                <span class="tyre-title">Edit Tyre</span>
              </div>
              <div class="tyre-row">
                <div class="form-group">
                  <label>Tyre Number:</label>
                  <input type="text" class="tyre-number" value="${tyreToEdit.number}" readonly required>
                  <input type="hidden" class="tyre-original-number" value="${tyreToEdit.number}">
                </div>
                <div class="form-group">
                  <label>Brand:</label>
                  <input type="text" class="tyre-brand" value="${tyreToEdit.brand}" required>
                </div>
                <div class="form-group">
                  <label>Position:</label>
                  <input type="text" class="tyre-position" value="${tyreToEdit.position || ''}" required>
                </div>
                <div class="form-group">
                  <label>Added Date:</label>
                  <input type="date" class="tyre-added-date" value="${tyreToEdit.addedAt ? new Date(tyreToEdit.addedAt).toISOString().split('T')[0] : ''}" required>
                </div>
                <div class="form-group">
                  <label>Cost (₹):</label>
                  <input type="number" class="tyre-cost" value="${tyreToEdit.cost || 0}" required>
                </div>
              </div>
            `;
            
            document.getElementById('tyresContainer').innerHTML = '';
            document.getElementById('tyresContainer').appendChild(tyreDiv);
            
            // Set editing state
            editingVehicleId = vehicleId;
            document.getElementById('saveVehicleBtn').textContent = 'Update Tyre';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';
            
            // Scroll to form
            document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
          }
        }
      });
    };

    // Show disposal modal
    window.disposeTyre = function(vehicleId, tyreNumber) {
      // Create disposal modal if it doesn't exist
      let modal = document.getElementById('disposalModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'disposalModal';
        modal.style.display = 'none';
        modal.style.position = 'fixed';
        modal.style.zIndex = '1000';
        modal.style.left = '0';
        modal.style.top = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        modal.style.flexDirection = 'column';
        
        const modalContent = document.createElement('div');
        modalContent.style.backgroundColor = '#fff';
        modalContent.style.padding = '20px';
        modalContent.style.borderRadius = '8px';
        modalContent.style.width = '90%';
        modalContent.style.maxWidth = '500px';
        modalContent.style.position = 'relative';
        
        const closeBtn = document.createElement('span');
        closeBtn.innerHTML = '&times;';
        closeBtn.style.position = 'absolute';
        closeBtn.style.right = '15px';
        closeBtn.style.top = '5px';
        closeBtn.style.fontSize = '24px';
        closeBtn.style.cursor = 'pointer';
        closeBtn.onclick = function() {
          modal.style.display = 'none';
        };
        
        const title = document.createElement('h3');
        title.textContent = 'Dispose Tyre';
        title.style.marginTop = '0';
        title.style.color = '#2E8B57';
        
        const reasonLabel = document.createElement('label');
        reasonLabel.textContent = 'Select disposal reason:';
        reasonLabel.style.display = 'block';
        reasonLabel.style.marginBottom = '10px';
        
        const select = document.createElement('select');
        select.id = 'disposalReason';
        select.style.width = '100%';
        select.style.padding = '8px';
        select.style.marginBottom = '15px';
        select.style.borderRadius = '4px';
        select.style.border = '1px solid #ddd';

        const resellPriceLabel = document.createElement('label');
        resellPriceLabel.textContent = 'Resell Price (₹):';
        resellPriceLabel.style.display = 'block';
        resellPriceLabel.style.marginBottom = '10px';

        const resellPriceInput = document.createElement('input');
        resellPriceInput.type = 'number';
        resellPriceInput.id = 'resellPrice';
        resellPriceInput.placeholder = 'Enter resell price (optional)';
        resellPriceInput.style.width = 'calc(100% - 20px)';
        resellPriceInput.style.padding = '8px';
        resellPriceInput.style.borderRadius = '4px';
        resellPriceInput.style.border = '1px solid #ddd';
        
        const reasons = [
          'Worn out',
          'Tyre burst',
          'Change',
          'Wrong tyre number',
          'Other'
        ];
        
        reasons.forEach(reason => {
          const option = document.createElement('option');
          option.value = reason;
          option.textContent = reason;
          select.appendChild(option);
        });
        
        const otherInput = document.createElement('input');
        otherInput.type = 'text';
        otherInput.id = 'otherReason';
        otherInput.placeholder = 'Please specify other reason';
        otherInput.style.width = 'calc(100% - 20px)';
        otherInput.style.padding = '8px';
        otherInput.style.marginTop = '10px';
        otherInput.style.borderRadius = '4px';
        otherInput.style.border = '1px solid #ddd';
        otherInput.style.display = 'none';
        
        select.onchange = function() {
          otherInput.style.display = this.value === 'Other' ? 'block' : 'none';
        };
        
        const buttonContainer = document.createElement('div');
        buttonContainer.style.display = 'flex';
        buttonContainer.style.justifyContent = 'flex-end';
        buttonContainer.style.gap = '10px';
        buttonContainer.style.marginTop = '15px';
        
        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'Cancel';
        cancelBtn.className = 'btn btn-danger';
        cancelBtn.onclick = function() {
          modal.style.display = 'none';
        };
        
        const confirmBtn = document.createElement('button');
        confirmBtn.textContent = 'Confirm Disposal';
        confirmBtn.className = 'btn btn-primary';
        confirmBtn.onclick = function() {
          const reason = select.value === 'Other' 
            ? (document.getElementById('otherReason').value.trim() || 'Other')
            : select.value;
          const resellPrice = parseFloat(document.getElementById('resellPrice').value) || 0;
          
          if (!reason) {
            alert('Please enter a disposal reason');
            return;
          }
          
          // Close the modal
          modal.style.display = 'none';
          
          // Proceed with disposal
          proceedWithDisposal(vehicleId, tyreNumber, reason, resellPrice);
        };
        
        buttonContainer.appendChild(cancelBtn);
        buttonContainer.appendChild(confirmBtn);
        
        modalContent.appendChild(closeBtn);
        modalContent.appendChild(title);
        modalContent.appendChild(reasonLabel);
        modalContent.appendChild(select);
        modalContent.appendChild(resellPriceLabel);
        modalContent.appendChild(resellPriceInput);
        modalContent.appendChild(otherInput);
        modalContent.appendChild(buttonContainer);
        
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
      }
      
      // Show the modal
      modal.style.display = 'flex';
      
      // Reset form
      document.getElementById('disposalReason').value = 'Worn out';
      document.getElementById('resellPrice').value = '';
      const otherInput = document.getElementById('otherReason');
      otherInput.value = '';
      otherInput.style.display = 'none';
      
      // Close modal when clicking outside
      modal.onclick = function(event) {
        if (event.target === modal) {
          modal.style.display = 'none';
        }
      };
    };
    
    // Function to handle the actual disposal
    function proceedWithDisposal(vehicleId, tyreNumber, reason, resellPrice) {
      get(ref(db, `users/${currentUser.uid}/vehicles/${vehicleId}`)).then((snapshot) => {
        if (snapshot.exists()) {
          const vehicle = snapshot.val();
          const tyres = vehicle.tyres || [];
          
          // Find the tyre to dispose
          const tyreToDispose = tyres.find(t => t.number === tyreNumber);
          if (!tyreToDispose) return;
          
          // Add disposal information
          const disposedTyre = {
            ...tyreToDispose,
            disposedAt: Date.now(),
            disposalReason: reason,
            resellPrice: resellPrice,
            vehicleId: vehicleId, // Important for restore
            vehicleNumber: vehicle.vehicleNumber,
            vehicleModel: vehicle.vehicleModel
          };
          
          // Save to tyre history
          const historyRef = ref(db, `users/${currentUser.uid}/tyre_history`);
          push(historyRef, disposedTyre).then(() => {
            // Filter out the disposed tyre from vehicle
            const updatedTyres = tyres.filter(t => t.number !== tyreNumber);
            
            // Update the vehicle with the new tyres array
            update(ref(db, `users/${currentUser.uid}/vehicles/${vehicleId}`), {
              tyres: updatedTyres
            }).then(() => {
              showAlert('Tyre disposed successfully', 'success');
            }).catch((error) => {
              showAlert(`Error: ${error.message}`, 'danger');
            });
          }).catch((error) => {
            showAlert(`Error saving to history: ${error.message}`, 'danger');
          });
        }
      });
    };

    // Cancel edit mode
    window.cancelEdit = function() {
      resetForm();
    };

    // Reset form to add new vehicle state
    function resetForm() {
      document.getElementById('formTitle').textContent = 'Add New Vehicle';
      document.getElementById('vehicleNumber').value = '';
      document.getElementById('vehicleModel').value = '';
      document.getElementById('vehicleNumber').disabled = false;
      document.getElementById('vehicleModel').disabled = false;
      
      document.getElementById('tyresContainer').innerHTML = `
        <div class="tyre-container">
          <div class="tyre-header">
            <span class="tyre-title">Tyre 1</span>
          </div>
          <div class="tyre-row">
            <div class="form-group">
              <label>Tyre Number:</label>
              <input type="text" class="tyre-number" placeholder="e.g., T001" required>
            </div>
            <div class="form-group">
              <label>Brand:</label>
              <input type="text" class="tyre-brand" placeholder="e.g., MRF" required>
            </div>
            <div class="form-group">
              <label>Position:</label>
              <input type="text" class="tyre-position" placeholder="e.g., Front-Left" required>
            </div>
            <div class="form-group">
              <label>Added Date:</label>
              <input type="date" class="tyre-added-date" required>
            </div>
            <div class="form-group">
              <label>Cost (₹):</label>
              <input type="number" class="tyre-cost" placeholder="e.g., 5000" required>
            </div>
          </div>
        </div>
      `;
      
      tyreCount = 1;
      editingVehicleId = null;
      document.getElementById('saveVehicleBtn').textContent = 'Save Vehicle';
      document.getElementById('cancelEditBtn').style.display = 'none';
    }

    // Download PDF for a specific vehicle's tyres
    window.downloadVehicleTyrePDF = function(vehicleId) {
      const vehicle = allVehiclesData[vehicleId];
      if (!vehicle) {
        showAlert('Vehicle data not found.', 'danger');
        return;
      }

      const tyres = vehicle.tyres || [];
      if (tyres.length === 0) {
        showAlert('This vehicle has no tyres to report.', 'warning');
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({
        // Using a font that supports the Rupee symbol
        font: "helvetica" 
      });

      // Add a title
      doc.setFontSize(18);
      doc.text(`Tyre Report for ${vehicle.vehicleNumber}`, 14, 22);
      doc.setFontSize(11);
      doc.setTextColor(100);
      doc.text(`Model: ${vehicle.vehicleModel}`, 14, 30);

      // Define table columns and rows
      const tableColumn = ["Tyre Number", "Brand", "Position", "Added Date", "Cost (₹)"];
      const tableRows = [];
      let totalCost = 0;

      tyres.forEach(tyre => {
        const cost = parseFloat(tyre.cost) || 0;
        totalCost += cost;
        const tyreData = [
          tyre.number || 'N/A',
          tyre.brand || 'N/A',
          tyre.position || 'N/A',
          tyre.addedAt ? new Date(tyre.addedAt).toLocaleDateString() : 'N/A',
          cost.toFixed(2)
        ];
        tableRows.push(tyreData);
      });

      // Add table to the PDF
      doc.autoTable(tableColumn, tableRows, { startY: 35 });

      // Add summary section at the end of the PDF
      const finalY = doc.lastAutoTable.finalY;
      doc.setFontSize(12);
      doc.text('Summary:', 14, finalY + 15);
      doc.setFontSize(10);
      doc.text(`Total Number of Tyres: ${tyres.length}`, 14, finalY + 21);
      doc.text(`Total Tyre Investment: ₹${totalCost.toFixed(2)}`, 14, finalY + 27);

      // Save the PDF
      doc.save(`Tyre_Report_${vehicle.vehicleNumber}.pdf`);
    };

    window.logout = function() {
        signOut(auth).then(() => {
          window.location.href = "index.html";
        }).catch(error => {
          alert("Error logging out: " + error.message);
        });
    };

    window.toggleMenu = function () {
      document.getElementById("navLinks").classList.toggle("show");
    };

    // Hook up pagination controls
    entriesPerPageVehicles.addEventListener('change', function () {
      itemsPerPageVehicles = parseInt(this.value, 10) || 10;
      currentPageVehicles = 1;
      renderVehiclesWithPagination();
    });
    prevVehiclesBtn.addEventListener('click', function () {
      if (currentPageVehicles > 1) {
        currentPageVehicles--;
        renderVehiclesWithPagination();
      }
    });
    nextVehiclesBtn.addEventListener('click', function () {
      if (currentPageVehicles < totalPagesVehicles) {
        currentPageVehicles++;
        renderVehiclesWithPagination();
      }
    });
  </script>
</body>
</html>

<!-- Add this CSS inside the existing style tag -->
<style>
  /* ... existing styles ... */
  
  /* Styles for tyre history */
  .history-btn {
    background-color: #17a2b8;
    color: white;
  }
  
  .history-btn:hover {
    background-color: #138496;
  }
  
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.4);
  }
  
  .modal-content {
    background-color: #fefefe;
    margin: 10% auto;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    width: 80%;
    max-width: 800px;
  }
  
  .close-modal {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
  }
  
  .close-modal:hover {
    color: #555;
  }
  
  .history-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  
  .history-table th, .history-table td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: left;
  }
  
  .history-table th {
    background-color: #2E8B57;
    color: white;
  }
  
  .history-table tr:nth-child(even) {
    background-color: #f2f2f2;
  }
  
  .tyre-stats {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }
  
  .stat-card {
    background-color: #f9f9f9;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    flex: 1;
    min-width: 200px;
    margin-right: 15px;
    border-left: 4px solid #2E8B57;
  }
  
  .stat-value {
    font-size: 24px;
    font-weight: bold;
    color: #2E8B57;
  }
  
  .stat-label {
    color: #666;
    font-size: 14px;
  }
  
  .tyre-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
    margin-left: 5px;
  }
  
  .badge-new {
    background-color: #28a745;
    color: white;
  }
  
  .badge-used {
    background-color: #ffc107;
    color: #212529;
  }
  
  .badge-old {
    background-color: #dc3545;
    color: white;
  }
</style>

<!-- Add this HTML right before the closing </div> of the container div -->
<div id="tyreHistoryModal" class="modal">
  <div class="modal-content">
    <span class="close-modal" onclick="closeHistoryModal()">&times;</span>
    <h2 id="historyTitle">Tyre History</h2>
    
    <div class="form-group">
      <input type="text" id="historySearchInput" placeholder="Search vehicles..." class="form-control" onkeyup="searchVehicles()">
    </div>
    
    <div id="historyVehicleList" class="card-deck">
      <!-- Vehicles will be loaded here -->
    </div>
    
    <div class="tyre-stats" id="tyreStats">
      <!-- Stats will be populated dynamically -->
    </div>
    
    <table class="history-table" id="historyTable" data-paginate="true" data-page-sizes="10,20,50,100">
      <thead>
        <tr>
          <th>Date</th>
          <th>Tyre Number</th>
          <th>Brand</th>
          <th>Size</th>
          <th>Position</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="historyTableBody">
        <!-- History entries will be populated dynamically -->
      </tbody>
    </table>
  </div>
</div>

<!-- Update the renderCard function in the JavaScript section -->
<script>
  // Add these functions to your existing script
  
  // Function to calculate tyre age in days
  function getTyreAge(timestamp) {
    if (!timestamp) return 0;
    const now = Date.now();
    const ageInMs = now - timestamp;
    return Math.floor(ageInMs / (1000 * 60 * 60 * 24)); // Convert ms to days
  }
  
  // Function to show tyre history modal
  window.showTyreHistory = function(vehicleId) {
    window.get(window.ref(window.db, `users/${window.currentUser.uid}/vehicles/${vehicleId}`)).then((snapshot) => {
      if (snapshot.exists()) {
        const vehicle = snapshot.val();
        const tyres = vehicle.tyres || [];
        
        // Set modal title
        document.getElementById('historyTitle').textContent = `Tyre History - ${vehicle.vehicleNumber}`;
        
        // Populate tyre stats
        const statsContainer = document.getElementById('tyreStats');
        const totalTyres = tyres.length;
        const newTyres = tyres.filter(t => getTyreAge(t.addedAt) <= 30).length;
        const usedTyres = tyres.filter(t => getTyreAge(t.addedAt) > 30 && getTyreAge(t.addedAt) <= 180).length;
        const oldTyres = tyres.filter(t => getTyreAge(t.addedAt) > 180).length;
        
        statsContainer.innerHTML = `
          <div class="stat-card">
            <div class="stat-value">${totalTyres}</div>
            <div class="stat-label">Total Tyres</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${newTyres}</div>
            <div class="stat-label">New Tyres (<30 days)</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${usedTyres}</div>
            <div class="stat-label">Used Tyres (1-6 months)</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${oldTyres}</div>
            <div class="stat-label">Old Tyres (>6 months)</div>
          </div>
        `;
        
        // Populate history table
        const historyTableBody = document.getElementById('historyTableBody');
        historyTableBody.innerHTML = '';
        
        // Sort tyres by added date (newest first)
        const sortedTyres = [...tyres].sort((a, b) => (b.addedAt || 0) - (a.addedAt || 0));
        
        for (const tyre of sortedTyres) {
          const row = document.createElement('tr');
          const date = tyre.addedAt ? new Date(tyre.addedAt).toLocaleDateString() : 'Unknown';
          
          row.innerHTML = `
            <td>${date}</td>
            <td>${tyre.number}</td>
            <td>${tyre.brand}</td>
            <td>${tyre.size}</td>
            <td>${tyre.position}</td>
            <td>
              <button class="action-btn edit-btn" onclick="editTyre('${vehicleId}', '${tyre.number}'); closeHistoryModal();">Edit</button>
            </td>
          `;
          
          historyTableBody.appendChild(row);
        }
        
        // Show the modal
        document.getElementById('tyreHistoryModal').style.display = 'block';
      }
    });
  };
  
  // Function to close the history modal
  window.closeHistoryModal = function() {
    document.getElementById('tyreHistoryModal').style.display = 'none';
  };
  
  // Close modal when clicking outside of it
  window.onclick = function(event) {
    const modal = document.getElementById('tyreHistoryModal');
    if (event.target === modal) {
      closeHistoryModal();
    }
  };
  
  // Modify the saveVehicle function to track tyre history
  window.saveVehicle = async function() {
    // ... existing code ...
    
    // Add timestamp to each tyre if not already present
    for (const tyre of tyres) {
      if (!tyre.addedAt) {
        tyre.addedAt = Date.now();
      }
    }
    
    // ... rest of the existing function ...
  };
</script>
</body>
</html>
