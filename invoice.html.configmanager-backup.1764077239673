<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Generated Invoices</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <link rel="stylesheet" href="print-invoice.css" media="print">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #2E8B57;
      --secondary: #43B97F;
      --accent: #3CB371;
      --text: #1F1F1F;
      --muted: #556070;
      --bg: #F6FBF8;
      --white: #fff;
      --card: #ffffff;
      --border: #e8efe9;
      --shadow: 0 10px 28px rgba(0,0,0,.08);
      --radius: 12px;
    }
    body { padding: 0; margin: 0; background-color: var(--bg); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: var(--text); }
    
    /* --- CRITICAL PRINT FIX --- */
    @media print {
      body * { visibility: hidden; }
      #invoiceDetailModal .modal-content {
          visibility: hidden; 
      }
      #printableInvoiceDetail, #printableInvoiceDetail * { 
          visibility: visible; 
      }
      #printableInvoiceDetail {
        position: fixed; /* Use fixed position for printing */
        left: 0;
        top: 0;
        width: 100%;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        /* Ensure content flows entirely and does not cut off */
        min-height: 100vh; 
        page-break-before: always;
        page-break-after: always;
        overflow: visible; /* CRITICAL: Allow content to flow */
      }
      .modal-footer, .style-panel-section { display: none !important; }
      
      /* Reset dynamic colors for high-contrast printing */
      .invoice-theme-color { color: #000 !important; }
      .invoice-theme-bg { background-color: #f0f0f0 !important; border-color: #000 !important; color: #000 !important;}
      .table-zebra-stripe { background-color: #f0f0f0 !important; }

      /* Force table to fit */
      .table-responsive { overflow: visible !important; }
    }
    
    /* --- General Modal/Printable Area Styles --- */
    .hidden-print { display: none !important; }

    /* Watermark Stamps */
    .paid-stamp, .partial-stamp, .pending-stamp {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-25deg);
      font-weight: 700;
      border: 8px solid;
      padding: 10px 25px;
      border-radius: 15px;
      opacity: 0.2;
      text-transform: uppercase;
      z-index: 1000;
      pointer-events: none;
    }
    .paid-stamp { font-size: 6rem; color: red; border-color: red; }
    .partial-stamp { font-size: 4rem; color: #ff8c00; border-color: #ff8c00; opacity: 0.35; }
    .pending-stamp { font-size: 6rem; color: #6c757d; border-color: #6c757d; }

    /* Invoice Layout Enhancements */
    .invoice-header-box {
        display: flex;
        justify-content: space-between;
        margin-bottom: 25px;
    }
    .company-details-left {
        width: 45%;
    }
    .invoice-details-right {
        width: 45%;
        text-align: right;
    }
    .invoice-title {
        font-size: 32px;
        font-weight: 800;
        margin-bottom: 10px;
    }
    .logo-placeholder {
        width: 100px;
        height: 100px;
        background-color: #ccc;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #666;
        margin-left: auto;
        margin-bottom: 15px;
    }
    .logo-on-print {
        max-width: 100px;
        max-height: 100px;
        margin-left: auto;
        margin-bottom: 15px;
        display: block;
    }
    .billing-shipping-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
        border-bottom: 1px solid #ddd;
        padding-bottom: 10px;
    }
    .bill-to-box {
        width: 45%;
        border: 1px solid #ccc;
        padding: 15px;
    }
    .ship-to-box {
        width: 45%;
        border: 1px solid #ccc;
        padding: 15px;
    }

    /* Company Seal/Stamp Styling */
    .company-seal {
        width: 180px; 
        height: 180px; 
        margin: 0 auto; 
        display: block; 
    }
    
    /* Dynamic Color Classes */
    .invoice-theme-color { transition: color 0.3s; }
    .invoice-theme-bg { 
        transition: background-color 0.3s, border-color 0.3s; 
        color: #fff !important;
    }
    .table-zebra-stripe {
        background-color: rgba(0, 0, 0, 0.03);
    }

    /* Modal size and layout for side panel */
    #invoiceDetailModal .modal-dialog {
        max-width: 95%; 
        min-width: auto; /* allow full shrink on small screens */
    }
    @media (min-width: 992px) {
      #invoiceDetailModal .modal-dialog {
        min-width: 1200px; /* apply wide layout only on larger screens */
      }
    }
    #invoiceDetailModal .modal-body {
        max-height: 80vh;
        overflow: auto; /* ensure full content is reachable */
    }
    
    .invoice-preview-container {
        max-height: 80vh; 
        overflow-y: auto;
        overflow-x: auto; /* NEW: horizontal scroll for narrow screens */
        -webkit-overflow-scrolling: touch; /* smooth scroll on iOS */
        padding-right: 15px;
        border-right: 1px solid var(--border);
    }
    
    /* Style Panel */
    #styleSettingsPanel {
        padding: 15px;
        background-color: var(--card);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        max-height: none;
        overflow: visible;
    }

    /* Ensure the printable preview can scroll horizontally on mobile */
    #printableInvoiceDetail {
        min-width: 720px; /* smaller minimum to fit more on phones */
    }

    /* Mobile tweaks */
    @media (max-width: 576px) {
      #invoiceDetailModal .modal-dialog {
        max-width: 100% !important;
        min-width: auto !important;
        margin: 0 10px;
      }
      #invoiceDetailModal .modal-content {
        border-radius: 10px;
      }
      #invoiceDetailModal .modal-body {
        max-height: 80vh; /* keep consistent height but allow inner scroll */
      }
      .invoice-preview-container { border-right: none; padding-right: 0; }
      .style-panel-section {
        margin-top: 12px;
      }
      .invoice-header-box { flex-direction: column; gap: 10px; }
      .company-details-left, .invoice-details-right { width: 100%; text-align: left; }
      
      /* Make the preview fit the screen width and allow inner tables to scroll */
      #printableInvoiceDetail {
        min-width: 0 !important; /* override desktop min width */
        width: 100% !important;
        padding: 10px !important;
      }
      #printableInvoiceDetail .table {
        display: block;
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      #printableInvoiceDetail .table thead, 
      #printableInvoiceDetail .table tbody, 
      #printableInvoiceDetail .table tfoot, 
      #printableInvoiceDetail .table tr, 
      #printableInvoiceDetail .table th, 
      #printableInvoiceDetail .table td {
        white-space: nowrap; /* avoid squishing columns */
      }
    }
  </style>
</head>
<body>
    <!-- Load secure configuration first -->
  <script src="evm.js"></script>
  <script src="config-loader.js"></script>

  <script src="navbar-loader.js"></script>

  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0"><i class="fas fa-file-invoice-dollar me-2"></i>Generated Invoices</h2>
    </div>

    <ul class="nav nav-pills mb-3" id="invoiceViewTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="client-invoices-tab" data-bs-toggle="tab" data-bs-target="#client-invoices-content" type="button" role="tab">Client Invoices</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="market-invoices-tab" data-bs-toggle="tab" data-bs-target="#market-invoices-content" type="button" role="tab">Market Invoices</button>
      </li>
    </ul>

    <div class="tab-content" id="invoiceViewTabsContent">
      <div class="tab-pane fade show active" id="client-invoices-content" role="tabpanel">
        <div class="table-responsive">
          <table id="invoicesTable" class="table table-striped">
            <thead>
              <tr>
                <th>Invoice #</th>
                <th>Date</th>
                <th>Company Name</th>
                <th class="text-end">Total Amount</th>
                <th class="text-center">Status</th>
                <th class="text-center">LRs</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody id="invoicesTableBody"></tbody>
          </table>
        </div>
      </div>
      <div class="tab-pane fade" id="market-invoices-content" role="tabpanel">
        <div class="table-responsive">
          <table id="marketInvoicesTable" class="table table-striped">
            <thead>
              <tr>
                <th>Invoice #</th>
                <th>Date</th>
                <th>Company Name</th>
                <th class="text-end">Total Amount</th>
                <th class="text-center">Status</th>
                <th class="text-center">LRs</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody id="marketInvoicesTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>


  <div class="modal fade" id="invoiceDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-fullscreen-sm-down">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title">Invoice Details & Style Customization</h5>
          <div class="d-flex align-items-center gap-2">
            <button type="button" class="btn btn-sm btn-outline-secondary d-inline-block d-sm-none" data-bs-toggle="collapse" data-bs-target="#stylePanelCollapse" aria-expanded="false" aria-controls="stylePanelCollapse">
              Style Panel
            </button>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
        </div>
        <div class="modal-body">
            <div class="row">
                <div class="col-md-9">
                    <h6 class="mb-3">Live Invoice Preview (Scrollable)</h6>
                    <div class="invoice-preview-container">
                        <div id="printableInvoiceDetail" style="width: 100%; min-height: 800px; padding: 15px; background: white; border: 1px solid #ddd;">
                            <div class="text-center p-5 text-muted">Select an invoice to see the live preview.</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 style-panel-section">
                    <div class="collapse show d-sm-block" id="stylePanelCollapse">
                    <div id="styleSettingsPanel">
                        <h6 class="mb-3"><i class="fas fa-palette me-2"></i>Invoice Style</h6>
                        <form id="invoiceStyleForm">
                            <div class="mb-3">
                                <label for="templatePreset" class="form-label small fw-bold">Style Template</label>
                                <select id="templatePreset" class="form-select form-select-sm" onchange="applyTemplate(this.value)">
                                    <option value="custom">-- Custom Style --</option>
                                    <option value="default">Template 1: Default Red (Like Sample)</option>
                                    <option value="blue">Template 2: Corporate Blue</option>
                                    <option value="green">Template 3: Traditional Green</option>
                                    <option value="minimal">Template 4: Minimal</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="themeColor" class="form-label small fw-bold">Primary Theme Color</label>
                                <input type="color" id="themeColor" class="form-control form-control-color" value="#dc3545" title="Choose your primary color">
                            </div>
                            <div class="mb-3">
                                <label for="accentStyle" class="form-label small fw-bold">Table Accent Style</label>
                                <select id="accentStyle" class="form-select form-select-sm">
                                    <option value="header">Header Only</option>
                                    <option value="zebra">Zebra Stripes (Alternating Rows)</option>
                                    <option value="footer">Footer Only</option>
                                    <option value="none">No Accent</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="fontStyle" class="form-label small fw-bold">Font Style</label>
                                <select id="fontStyle" class="form-select form-select-sm">
                                    <option value="sans-serif">Modern Sans-serif (Default)</option>
                                    <option value="serif">Classic Serif</option>
                                    <option value="monospace">Monospace (Technical)</option>
                                </select>
                            </div>
                            <div class="border-top pt-3">
                                <p class="small fw-bold mb-2"><i class="fas fa-cog me-1"></i> Print Content Toggles</p>
                                <div class="form-check form-switch mb-1">
                                    <input class="form-check-input" type="checkbox" id="printLogoToggle" checked><label class="form-check-label small" for="printLogoToggle">Show Logo</label>
                                </div>
                                <div class="form-check form-switch mb-1">
                                    <input class="form-check-input" type="checkbox" id="printStampToggle" checked><label class="form-check-label small" for="printStampToggle">Show Seal</label>
                                </div>
                                <div class="form-check form-switch mb-1">
                                    <input class="form-check-input" type="checkbox" id="printSignToggle" checked><label class="form-check-label small" for="printSignToggle">Show Sign</label>
                                </div>
                            </div>
                            <div class="d-grid mt-3">
                                <button type="button" class="btn btn-sm btn-primary" onclick="saveStyleSettings()">
                                    <i class="fas fa-save me-1"></i> Save Customization
                                </button>
                            </div>
                        </form>
                    </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer d-flex justify-content-end">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="printInvoiceDetail()">
            <i class="fas fa-print me-2"></i>Print
          </button>
          <button type="button" class="btn btn-success" onclick="downloadInvoicePDF()">
            <i class="fas fa-file-pdf me-2"></i>Download PDF
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, get, update, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Load Firebase configuration securely from EVM
    let firebaseConfig;
    
    try {
      // Get Firebase configuration from secure EVM system
      firebaseConfig = ConfigManager.getFirebaseConfig();
      
      // Check if we're using fallback values
      if (ConfigManager.isUsingFallbackValues()) {
        console.warn('⚠️  Using fallback Firebase configuration. Please update evm.js with real values.');
      } else {
        console.log('✅ Firebase configuration loaded securely from EVM');
      }
    } catch (error) {
      console.error('❌ Failed to load Firebase configuration:', error);
      
      // Use fallback configuration to prevent complete failure
      firebaseConfig = {
        apiKey: "placeholder-key",
        authDomain: "placeholder.firebaseapp.com", 
        databaseURL: "https://placeholder.firebaseio.com",
        projectId: "placeholder-project",
        storageBucket: "placeholder.appspot.com",
        messagingSenderId: "000000000000",
        appId: "1:000000000000:web:placeholder",
        measurementId: "G-XXXXXXXXX"
      };
    }

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let invoicesTable;
    let marketInvoicesTable;
    let coreAccountId = null;
    let currentInvoiceData = null;
    let currentUserProfile = null;
    let allClients = []; // Added for use in numberToWords
    let allTransporters = []; // Added for use in numberToWords
    
    let invoiceStyle = {
        themeColor: '#dc3545', // Default to Red to match the sample image
        accentStyle: 'header',
        fontStyle: 'sans-serif'
    };
    
    // **STYLE TEMPLATES/PRESETS**
    const styleTemplates = {
        default: { themeColor: '#dc3545', accentStyle: 'header', fontStyle: 'sans-serif' }, // Red (like sample)
        blue: { themeColor: '#0d6efd', accentStyle: 'zebra', fontStyle: 'sans-serif' },
        green: { themeColor: '#198754', accentStyle: 'footer', fontStyle: 'serif' },
        minimal: { themeColor: '#343a40', accentStyle: 'none', fontStyle: 'sans-serif' }
    };

    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        const userRef = ref(db, `users/${user.uid}`);
        get(userRef).then(snapshot => {
          if (snapshot.exists()) {
            const userData = snapshot.val();
            coreAccountId = userData.coreAccountId || user.uid;
            
            get(ref(db, `users/${user.uid}/profile`)).then(profileSnap => {
                currentUserProfile = profileSnap.val() || {};
                // Load master data before initializing page
                loadMasterData().then(() => {
                    initializePage(user);
                });
            });
          } else {
            coreAccountId = user.uid;
            loadMasterData().then(() => {
                initializePage(user);
            });
          }
        });
      }
    });
    
    async function loadMasterData() {
        const clientSnap = await get(ref(db, `users/${coreAccountId}/clients`));
        if (clientSnap.exists()) {
            const raw = clientSnap.val();
            allClients = Object.keys(raw).map(key => ({ id: key, ...raw[key] }));
        } else {
            allClients = [];
        }
        const transporterSnap = await get(ref(db, `users/${coreAccountId}/transporters`));
        if (transporterSnap.exists()) {
            const rawT = transporterSnap.val();
            allTransporters = Object.keys(rawT).map(key => ({ id: key, ...rawT[key] }));
        } else {
            allTransporters = [];
        }
    }

    // **NEW**: Load and Save Style Settings
    function loadStyleSettings() {
        const storedStyle = localStorage.getItem('invoiceStyleSettings');
        if (storedStyle) {
            invoiceStyle = JSON.parse(storedStyle);
        }
        
        const invoiceModal = document.getElementById('invoiceDetailModal');
        if (invoiceModal) {
            invoiceModal.addEventListener('show.bs.modal', setupLivePreviewListeners);
            invoiceModal.addEventListener('hidden.bs.modal', cleanupLivePreviewListeners);
        }
    }
    
    function setupLivePreviewListeners() {
        const colorInput = document.getElementById('themeColor');
        const accentInput = document.getElementById('accentStyle');
        const fontInput = document.getElementById('fontStyle');

        // Initialize form values from global style object
        colorInput.value = invoiceStyle.themeColor;
        accentInput.value = invoiceStyle.accentStyle;
        fontInput.value = invoiceStyle.fontStyle;
        document.getElementById('templatePreset').value = 'custom'; // Reset template selector

        // Apply styles immediately if an invoice is loaded
        if (currentInvoiceData) {
             applyLiveStyles();
        }

        // Add event listeners for real-time update
        colorInput.addEventListener('input', applyLiveStyles);
        accentInput.addEventListener('change', applyLiveStyles);
        fontInput.addEventListener('change', applyLiveStyles);
    }
    
    function cleanupLivePreviewListeners() {
        // Remove event listeners when modal is closed to prevent memory leaks
        const colorInput = document.getElementById('themeColor');
        const accentInput = document.getElementById('accentStyle');
        const fontInput = document.getElementById('fontStyle');

        if (colorInput) colorInput.removeEventListener('input', applyLiveStyles);
        if (accentInput) accentInput.removeEventListener('change', applyLiveStyles);
        if (fontInput) fontInput.removeEventListener('change', applyLiveStyles);
    }
    
    // **NEW**: Apply template function
    window.applyTemplate = function(templateName) {
        if (templateName === 'custom') return;
        const template = styleTemplates[templateName] || styleTemplates.default;
        
        document.getElementById('themeColor').value = template.themeColor;
        document.getElementById('accentStyle').value = template.accentStyle;
        document.getElementById('fontStyle').value = template.fontStyle;
        
        applyLiveStyles();
        document.getElementById('templatePreset').value = templateName;
    }
    
    // **NEW**: Real-time style application to the loaded HTML
    function applyLiveStyles() {
        if (!currentInvoiceData) return;

        const themeColor = document.getElementById('themeColor').value;
        const accentStyle = document.getElementById('accentStyle').value;
        const fontStyle = document.getElementById('fontStyle').value;
        const previewElement = document.getElementById('printableInvoiceDetail');
        
        if (!previewElement) return;

        // 1. Apply overall font style
        previewElement.style.fontFamily = fontStyle;
        
        // 2. Apply theme color to accents
        document.querySelectorAll('#printableInvoiceDetail .invoice-theme-color').forEach(el => {
            el.style.color = themeColor;
        });
        document.querySelectorAll('#printableInvoiceDetail svg g[fill^="#"], #printableInvoiceDetail svg g[stroke^="#"]').forEach(g => {
            g.setAttribute('fill', themeColor);
            g.setAttribute('stroke', themeColor);
        });

        // 3. Apply table accents
        const table = previewElement.querySelector('.table');
        if (table) {
            const thead = table.querySelector('thead');
            const tfoot = table.querySelector('tfoot');
            const tbodyRows = table.querySelectorAll('tbody tr');
            const tfootTotalRow = tfoot ? tfoot.querySelector('tr:last-child') : null;

            // Reset all dynamic styles
            if (thead) { thead.style.backgroundColor = ''; thead.style.color = ''; }
            if (tfootTotalRow) { tfootTotalRow.style.backgroundColor = ''; tfootTotalRow.style.color = ''; }
            tbodyRows.forEach(row => row.classList.remove('table-zebra-stripe'));

            if (accentStyle === 'header' && thead) {
                thead.style.backgroundColor = themeColor;
                thead.style.color = 'white';
            } else if (accentStyle === 'footer' && tfootTotalRow) {
                tfootTotalRow.style.backgroundColor = themeColor;
                tfootTotalRow.style.color = 'white';
            } else if (accentStyle === 'zebra') {
                tbodyRows.forEach((row, index) => {
                    if (index % 2 !== 0) {
                        row.classList.add('table-zebra-stripe');
                    }
                });
            }
        }
    }


    window.saveStyleSettings = function() {
        // Save the currently selected live values to the global object
        invoiceStyle = {
            themeColor: document.getElementById('themeColor').value,
            accentStyle: document.getElementById('accentStyle').value,
            fontStyle: document.getElementById('fontStyle').value
        };
        localStorage.setItem('invoiceStyleSettings', JSON.stringify(invoiceStyle));
        alert('Invoice style settings saved! New style will be used for all future prints/PDFs.');
    }


    function initializePage(user) {
      invoicesTable = $('#invoicesTable').DataTable({ order: [[1, 'desc']] });
      marketInvoicesTable = $('#marketInvoicesTable').DataTable({ order: [[1, 'desc']] });
      
      loadStyleSettings(); 

      loadInvoices(coreAccountId);

      const urlParams = new URLSearchParams(window.location.search);
      const invoiceToView = urlParams.get('view');
      if (invoiceToView) { 
        viewInvoice(invoiceToView); 
      }
      
      document.getElementById('printLogoToggle').onchange = function() {
        document.querySelectorAll('.logo-on-print').forEach(el => el.classList.toggle('hidden-print', !this.checked));
      };
      document.getElementById('printStampToggle').onchange = function() {
        document.querySelectorAll('.stamp-on-print').forEach(el => el.classList.toggle('hidden-print', !this.checked));
      };
      document.getElementById('printSignToggle').onchange = function() {
        document.querySelectorAll('.signature-on-print').forEach(el => el.classList.toggle('hidden-print', !this.checked));
      };
    }

    async function getInvoiceTotals(inv) {
      // Prefer grandTotal from invoice, else sum item amounts
      const total = typeof inv.grandTotal === 'number' && !isNaN(inv.grandTotal)
        ? inv.grandTotal
        : (Array.isArray(inv.items) ? inv.items.reduce((s, it) => s + (it.amount || 0), 0) : 0);
      // Sum paidAmount across LR entries
      let paid = 0;
      if (Array.isArray(inv.lrEntries) && inv.lrEntries.length > 0) {
        for (const lrId of inv.lrEntries) {
          const lrSnap = await get(ref(db, `users/${coreAccountId}/lrReports/${lrId}`));
          if (lrSnap.exists()) paid += lrSnap.val()?.paidAmount || 0;
        }
      }
      return { total, paid };
    }

    function deriveStatusFromPaid(total, paid) {
      if (paid >= (total - 0.01)) return { status: 'paid', badge: 'bg-success' };
      if (paid > 0) return { status: 'partial', badge: 'bg-warning text-dark' };
      return { status: 'pending', badge: 'bg-danger' };
    }

    async function loadInvoices(userId) {
      const invoicesRef = ref(db, `users/${coreAccountId}/invoices`);
      const snapshot = await get(invoicesRef);

      if (invoicesTable) invoicesTable.clear();
      if (marketInvoicesTable) marketInvoicesTable.clear();

      if (snapshot.exists()) {
        const invoices = [];
        snapshot.forEach(child => {
          invoices.push({ id: child.key, ...child.val() });
        });
        invoices.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        
        for (const inv of invoices) {
          const { total, paid } = await getInvoiceTotals(inv);
          const derived = deriveStatusFromPaid(total, paid);
          const status = derived.status;
          const statusClass = derived.badge;

          // Determine company name based on invoice type and stored ID
          let companyName = 'N/A';
          if (inv.invoiceType === 'market' || inv.invoiceType === 'market_company') {
              const transporter = allTransporters.find(t => t.id === inv.transporterId);
              companyName = transporter?.name || 'Market Company';
          } else {
              const client = allClients.find(c => c.id === inv.clientId);
              companyName = client?.clientName || 'Client Company';
          }

          const displayTotal = total || inv.grandTotal || 0;
          const rowData = [
            inv.invoiceNumber,
            new Date(inv.createdAt).toLocaleDateString('en-IN'),
            companyName,
            `<span class="text-end d-block">₹${(displayTotal).toFixed(2)}</span>`,
            `<span class="badge ${statusClass}">${status}</span>`,
            `<span class="badge bg-secondary">${inv.lrEntries ? inv.lrEntries.length : 0}</span>`,
            `<button class="btn btn-sm btn-outline-primary" onclick="viewInvoice('${inv.id}')"><i class="fas fa-eye"></i> View</button>
             <button class="btn btn-sm btn-outline-warning ms-1" onclick="undoInvoice('${inv.id}')" title="Undo Invoice"><i class="fas fa-undo"></i> Undo</button>`
          ];

          if (inv.invoiceType === 'market' || inv.invoiceType === 'market_company') {
            if (marketInvoicesTable) marketInvoicesTable.row.add(rowData);
          } else {
            if (invoicesTable) invoicesTable.row.add(rowData);
          }
        }
      }
      if (invoicesTable) invoicesTable.draw();
      if (marketInvoicesTable) marketInvoicesTable.draw();
    }

    function numberToWords(num) {
      const a = ['', 'one ', 'two ', 'three ', 'four ', 'five ', 'six ', 'seven ', 'eight ', 'nine ', 'ten ', 'eleven ', 'twelve ', 'thirteen ', 'fourteen ', 'fifteen ', 'sixteen ', 'seventeen ', 'eighteen ', 'nineteen '];
      const b = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
      
      if ((num = Math.floor(num).toString()).length > 9) return 'overflow';
      const n = ('000000000' + num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
      if (!n) return '';
      
      let str = '';
      str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'crore ' : '';
      str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'lakh ' : '';
      str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'thousand ' : '';
      str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'hundred ' : '';
      str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) : '';
      
      return str.trim().replace(/\s+/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ') + ' Only';
    }
    
    // --- viewInvoice (MODIFIED FOR LIVE PREVIEW AND TEMPLATE LAYOUT) ---
    window.viewInvoice = async function(invoiceId) {
      const modalBody = document.getElementById('printableInvoiceDetail');
      modalBody.innerHTML = '<div class="text-center p-5"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Loading invoice...</p></div>';
      
      $('#invoiceDetailModal').modal('show');

      try {
        const user = auth.currentUser;
        if (!user) throw new Error("User not authenticated.");

        const invoiceSnap = await get(ref(db, `users/${coreAccountId}/invoices/${invoiceId}`));
        if (!invoiceSnap.exists()) {
          modalBody.innerHTML = '<p class="text-danger text-center">Invoice not found.</p>';
          return;
        }
        const invoice = invoiceSnap.val();
        currentInvoiceData = invoice;
        
        // 1. Get Live Style Values from inputs
        const themeColor = document.getElementById('themeColor').value;
        const accentStyle = document.getElementById('accentStyle').value;
        const fontStyle = document.getElementById('fontStyle').value;

        let billedToName = 'N/A';
        let billedToGstin = 'N/A';
        let billedToAddress = 'N/A';
        let billedToMobile = 'N/A';
        let billToLabel = 'Client Company';

        const lrs = invoice.items || [];
        
        // 2. Fetch Billed To Details (Same logic as before)
        if (invoice.invoiceType === 'market' || invoice.invoiceType === 'market_company') {
            billToLabel = 'Transporter Company';
            if (invoice.transporterId) {
                const t = allTransporters.find(t => t.id === invoice.transporterId);
                // FIX: Check if 't' is defined before accessing properties
                if (t) {
                    billedToName = t.name || 'N/A';
                    billedToGstin = t.gstin || 'N/A';
                    billedToAddress = t.address || t.billingAddress || 'N/A';
                    billedToMobile = t.mobile || 'N/A';
                }
            }
        } else {
            billToLabel = 'Client Company';
            if (invoice.clientId) {
                const c = allClients.find(c => c.id === invoice.clientId);
                // FIX: Check if 'c' is defined before accessing properties
                if (c) {
                    billedToName = c.clientName || 'N/A';
                    billedToGstin = c.gstin || 'N/A';
                    billedToAddress = c.billingAddress || 'N/A';
                    billedToMobile = c.mobile || 'N/A';
                }
            }
        }

        const profile = currentUserProfile; 
        const companyLogoUrl = profile.companyLogoUrl || '';
        const companyName = profile.transportName || 'Transvortex Logistics';
        const companyPhone = profile.phoneNumber || 'N/A';
        const fullCompanyAddress = `${profile.address || 'N/A'}, ${profile.city || 'N/A'}, ${profile.pincode || 'N/A'}`;
        const companyGstin = profile.gstin || 'N/A';
        const ownerName = profile.ownerName || 'N/A';

        // Derive current payment status from LR paidAmounts
        let stampHtml = '';
        try {
          const { total, paid } = await getInvoiceTotals({ ...invoice, id: invoiceId });
          const derived = deriveStatusFromPaid(total, paid);
          var status = derived.status;
        } catch (_) {
          var status = invoice.paymentStatus || 'pending';
        }
        switch (status) {
          case 'paid': stampHtml = '<div class="paid-stamp">Paid</div>'; break;
          case 'partial': stampHtml = '<div class="partial-stamp">Partially Paid</div>'; break;
          case 'pending': stampHtml = '<div class="pending-stamp">Pending</div>'; break;
        }
        
        // 3. Helper functions for style injection (using the live inputs)
        const getSealSVG = (name, gstin) => `
          <svg class="company-seal stamp-on-print" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" style="display: block;">
            <defs>
              <path id="topTextPath" fill="none" d="M 30,100 a 70,70 0 1,1 140,0" />
              <path id="bottomTextPath" fill="none" d="M 30,100 a 70,70 0 1,0 140,0" />
            </defs>
            <g fill="${themeColor}" stroke="${themeColor}">
              <circle cx="100" cy="100" r="95" stroke-width="3" fill="none"/>
              <circle cx="100" cy="100" r="88" stroke-width="1.5" fill="none"/>
              <text font-family="'Arial Black', 'Impact', sans-serif" font-size="15" letter-spacing="1.5">
                <textPath xlink:href="#topTextPath" startOffset="50%" text-anchor="middle">${name.toUpperCase().substring(0, 20)}</textPath>
              </text>
              <text font-family="'Arial Black', 'Impact', sans-serif" font-size="12" letter-spacing="1">
                <textPath xlink:href="#bottomTextPath" startOffset="50%" text-anchor="middle">OFFICIAL SEAL</textPath>
              </text>
              <text x="100" y="125" font-family="'Arial', sans-serif" font-size="14" font-weight="bold" text-anchor="middle" letter-spacing="1">TRANSPORT</text>
              <text x="100" y="145" font-family="'Arial', sans-serif" font-size="9" font-weight="normal" text-anchor="middle">GSTIN: ${gstin || 'N/A'}</text>
            </g>
          </svg>
        `;
        
        const headerBgStyle = accentStyle === 'header' ? `style="background-color: ${themeColor}; color: white !important;" class="invoice-theme-bg"` : 'class="table-light"';
        const footerBgStyle = accentStyle === 'footer' ? `style="background-color: ${themeColor}; color: white !important;" class="invoice-theme-bg"` : 'class="table-success"';
        const fontStyleAttr = `style="font-family: ${fontStyle}, sans-serif;"`;

        // 4. Construct the HTML with the new layout structure
        const invoiceHtml = `
          <div class="printable-area" ${fontStyleAttr} style="position: relative;">
            ${stampHtml}
            
            <div style="height: 10px; background-color: ${themeColor}; margin-bottom: 20px;"></div>

            <div class="invoice-header-box px-3">
                <div class="company-details-left">
                    <div class="invoice-title invoice-theme-color" style="color: ${themeColor} !important;">INVOICE</div>
                    <p class="fw-bold mb-1">${companyName}</p>
                    <p class="small mb-0">${fullCompanyAddress}</p>
                    <p class="small mb-0">Phone: ${companyPhone}</p>
                    <p class="small mb-0">Email: ${user.email || 'N/A'}</p>
                    <p class="small mb-0">GSTIN: ${companyGstin}</p>
                </div>
                <div class="invoice-details-right">
                    ${companyLogoUrl ? `<img src="${companyLogoUrl}" alt="Logo" class="logo-on-print" style="max-height: 80px; max-width: 100px;">` : `<div class="logo-placeholder">LOGO</div>`}
                    <p class="small mb-1 mt-3">DATE: ${new Date(invoice.createdAt).toLocaleDateString('en-IN')}</p>
                    <p class="small mb-3 fw-bold">INVOICE NO: ${invoice.invoiceNumber}</p>
                </div>
            </div>
            
            <div class="billing-shipping-row px-3">
                <div class="bill-to-box">
                    <p class="fw-bold mb-1 invoice-theme-color" style="color: ${themeColor} !important; border-bottom: 2px solid ${themeColor}; padding-bottom: 5px;">BILL TO:</p>
                    <p class="mb-1 small">${billToLabel}: ${billedToName}</p>
                    <p class="mb-1 small">Address: ${billedToAddress}</p>
                    <p class="mb-0 small">GSTIN: ${billedToGstin}</p>
                </div>
                <div class="ship-to-box text-muted">
                    <p class="fw-bold mb-1 invoice-theme-color" style="color: ${themeColor} !important; border-bottom: 2px solid ${themeColor}; padding-bottom: 5px;">SHIPMENT DETAILS:</p>
                    <p class="mb-1 small">Route: ${lrs[0]?.from || 'N/A'} to ${lrs[0]?.to || 'N/A'}</p>
                    <p class="mb-1 small">Shipment LRs: ${lrs.length}</p>
                    <p class="mb-1 small">Consignee: ${lrs[0]?.consignee || 'N/A'}</p>
                    <p class="mb-0 small">Payment terms (due on receipt)</p>
                </div>
            </div>

            <div class="table-responsive px-3">
              <table class="table table-bordered">
                <thead ${headerBgStyle}>
                  <tr>
                    <th>LR No / Item Description</th>
                    <th style="width: 10%;">Date</th>
                    <th style="width: 12%;">Truck No</th>
                    <th class="text-end" style="width: 10%;">Weight (MT)</th>
                    <th class="text-end" style="width: 10%;">Rate</th>
                    <th class="text-end" style="width: 15%;">Amount (₹)</th>
                  </tr>
                </thead>
                <tbody>
                  ${lrs.map((lr, index) => {
                      const rate = lr.weight > 0 ? (lr.amount / lr.weight).toFixed(2) : '0.00';
                      const rowStyle = accentStyle === 'zebra' && index % 2 !== 0 ? `class="table-zebra-stripe"` : '';
                      return `
                          <tr ${rowStyle}>
                            <td>${lr.lrNumber || 'N/A'} - ${lr.item || 'Freight Charges'}</td>
                            <td>${new Date(lr.date).toLocaleDateString('en-IN') || 'N/A'}</td>
                            <td>${lr.truckNumber || 'N/A'}</td>
                            <td class="text-end">${(lr.weight || 0).toFixed(2)}</td>
                            <td class="text-end">₹${rate}</td>
                            <td class="text-end">₹${(lr.amount || 0).toFixed(2)}</td>
                          </tr>
                      `;
                  }).join('')}
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="3" rowspan="4" class="align-bottom">
                      <p class="fw-bold mb-1">Remarks / Payment Instructions:</p>
                      <p class="small">Payment is due on receipt. Please include the Invoice number in all bank transfers.</p>
                      <div class="row">
                        <div class="col-md-6">
                          <p class="mb-1 mt-3 fw-bold">Bank Details:</p>
                          <p class="mb-1 small">Bank: <span>${invoice.bankDetails.bankName}</span></p>
                          <p class="mb-1 small">A/C No: <span>${invoice.bankDetails.accountNumber}</span></p>
                          <p class="mb-1 small">IFSC: <span>${invoice.bankDetails.ifscCode || 'N/A'}</span></p>
                        </div>
                        <div class="col-md-6 text-end">
                            ${getSealSVG(companyName, companyGstin)}
                        </div>
                      </div>
                    </td>
                    <td colspan="2" class="text-end"><strong>SUBTOTAL:</strong></td>
                    <td class="text-end fw-bold">₹${(invoice.subtotal || 0).toFixed(2)}</td>
                  </tr>
                  <tr>
                    <td colspan="2" class="text-end"><strong>CGST (${invoice.cgstPercentage || 9}%):</strong></td>
                    <td class="text-end fw-bold">₹${(invoice.cgstAmount || 0).toFixed(2)}</td>
                  </tr>
                  <tr>
                    <td colspan="2" class="text-end"><strong>SGST (${invoice.sgstPercentage || 9}%):</strong></td>
                    <td class="text-end fw-bold">₹${(invoice.sgstAmount || 0).toFixed(2)}</td>
                  </tr>
                  <tr ${footerBgStyle}>
                    <td colspan="3" class="text-start ps-3 small fw-bold">AMOUNT IN WORDS: ${numberToWords(invoice.grandTotal || 0)}</td>
                    <td colspan="2" class="text-end"><strong>BALANCE DUE:</strong></td>
                    <td class="text-end fw-bold fs-5">₹${(invoice.grandTotal || 0).toFixed(2)}</td>
                  </tr>
                </tfoot>
              </table>
            </div>
            
            <div class="row mt-5 px-3">
              <div class="col-md-7">
                <p class="small text-muted">Note: Subject to ${invoice.companyDetails.city || 'Jurisdiction'} Jurisdiction.</p>
              </div>
              <div class="col-md-5 text-end signature-on-print">
                <div class="mt-4">
                  <p class="mb-4">For <strong class="invoice-theme-color" style="color: ${themeColor} !important;">${companyName}</strong></p>
                  <p class="mb-0">___________________</p>
                  <p class="mb-0">Authorized Signatory</p>
                </div>
              </div>
            </div>

            <div style="height: 10px; background-color: ${themeColor}; margin-top: 20px;"></div>
          </div>
        `;
        modalBody.innerHTML = invoiceHtml;
        
        // 5. Apply live styles on initial load (must be done after HTML is injected)
        applyLiveStyles();

      } catch (error) {
        console.error("Error viewing invoice:", error);
        modalBody.innerHTML = '<p class="text-danger text-center">Could not load invoice details.</p>';
      }
    }

    window.printInvoiceDetail = function() {
      window.print();
    }

    // PDF generation and undo functions remain largely the same, using live styles for color...
    window.downloadInvoicePDF = function() {
        if (!currentInvoiceData) {
            alert('No invoice data loaded. Please view an invoice first.');
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const invoice = currentInvoiceData;
        
        const client = currentInvoiceData.items[0];
        const lrs = invoice.items;
        
        // Get live style values for PDF
        const themeColor = document.getElementById('themeColor').value;
        const accentStyle = document.getElementById('accentStyle').value;
        const rgbColor = themeColor ? [parseInt(themeColor.substring(1, 3), 16), parseInt(themeColor.substring(3, 5), 16), parseInt(themeColor.substring(5, 7), 16)] : [46, 139, 87];
        
        let headFill = accentStyle === 'header' ? rgbColor : [240, 240, 240];
        let footFill = accentStyle === 'footer' ? rgbColor : [240, 240, 240];
        let headTextColor = accentStyle === 'header' ? 255 : 0;
        let footTextColor = accentStyle === 'footer' ? 255 : 0;
        
        // --- Header (Simplified PDF for structure, focusing on table styling) ---
        doc.setFontSize(18);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(rgbColor[0], rgbColor[1], rgbColor[2]);
        doc.text(currentUserProfile.transportName || 'Transport Company', doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(100);
        doc.text(`Invoice #: ${invoice.invoiceNumber}`, 196, 26, { align: 'right' });
        doc.text(`Date: ${new Date(invoice.createdAt).toLocaleDateString('en-IN')}`, 196, 31, { align: 'right' });

        doc.setFontSize(8);
        doc.setTextColor(0);
        doc.text(`Billed To: ${client?.consignor || 'N/A'}`, 14, 26);
        doc.text(`GSTIN: ${currentUserProfile.gstin || 'N/A'}`, 14, 31);

        // --- Table ---
        const head = [['LR/Description', 'Date', 'Truck No', 'Weight (MT)', 'Rate', 'Amount (₹)']];
        const body = lrs.map(lr => [
            `${lr.lrNumber || 'N/A'} - ${lr.item || 'Freight Charges'}`,
            new Date(lr.date).toLocaleDateString('en-IN') || 'N/A',
            lr.truckNumber || 'N/A',
            (lr.weight || 0).toFixed(2),
            (lr.amount / lr.weight || 0).toFixed(2),
            (lr.amount || 0).toFixed(2)
        ]);

        doc.autoTable({
            head: head,
            body: body,
            startY: 40,
            theme: 'grid',
            headStyles: { 
                fillColor: headFill,
                textColor: headTextColor,
                font: document.getElementById('fontStyle').value,
                fontSize: 7
            },
            alternateRowStyles: accentStyle === 'zebra' ? { fillColor: [248, 248, 248] } : {},
            styles: { fontSize: 7, font: document.getElementById('fontStyle').value },
            columnStyles: {
                3: { halign: 'right' },
                4: { halign: 'right' },
                5: { halign: 'right' }
            },
            didDrawPage: function (data) {
                doc.setFontSize(9);
                doc.setTextColor(0); 
                
                doc.text(`Subtotal:`, 150, doc.internal.pageSize.height - 35, { align: 'right' });
                doc.text(`₹${(invoice.subtotal || 0).toFixed(2)}`, 196, doc.internal.pageSize.height - 35, { align: 'right' });
                
                doc.text(`CGST (${invoice.cgstPercentage || 9}%):`, 150, doc.internal.pageSize.height - 30, { align: 'right' });
                doc.text(`₹${(invoice.cgstAmount || 0).toFixed(2)}`, 196, doc.internal.pageSize.height - 30, { align: 'right' });
                
                doc.text(`SGST (${invoice.sgstPercentage || 9}%):`, 150, doc.internal.pageSize.height - 25, { align: 'right' });
                doc.text(`₹${(invoice.sgstAmount || 0).toFixed(2)}`, 196, doc.internal.pageSize.height - 25, { align: 'right' });
                
                if (accentStyle === 'footer') {
                    doc.setFillColor(footFill[0], footFill[1], footFill[2]);
                    doc.rect(data.settings.margin.left, doc.internal.pageSize.height - 21.5, doc.internal.pageSize.getWidth() - data.settings.margin.left * 2, 7, 'F');
                }

                doc.setFont('helvetica', 'bold');
                doc.setTextColor(accentStyle === 'footer' ? footTextColor : rgbColor[0], rgbColor[1], rgbColor[2]);
                doc.text(`BALANCE DUE:`, 150, doc.internal.pageSize.height - 20, { align: 'right' });
                doc.text(`₹${(invoice.grandTotal || 0).toFixed(2)}`, 196, doc.internal.pageSize.height - 20, { align: 'right' });
                
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(0);
                doc.text(`Amount in Words: ${numberToWords(invoice.grandTotal || 0)}`, 14, doc.internal.pageSize.height - 15);
                
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(rgbColor[0], rgbColor[1], rgbColor[2]);
                doc.text(`For ${currentUserProfile.transportName || 'Transport Company'}`, 196, doc.internal.pageSize.height - 10, { align: 'right' });
            }
        });

        doc.save(`Invoice_${invoice.invoiceNumber}.pdf`);
    }

    window.undoInvoice = async function(invoiceId) {
      if (!confirm('Are you sure you want to undo this invoice? This will move all associated LRs back to the LR Report page and delete this invoice.')) { return; }
      try {
        const user = auth.currentUser;
        if (!user) { alert('Authentication error. Please log in again.'); return; }
        const dataRoot = coreAccountId || user.uid;

        const invoiceRef = ref(db, `users/${dataRoot}/invoices/${invoiceId}`);
        const invoiceSnap = await get(invoiceRef);
        if (!invoiceSnap.exists()) { throw new Error('Invoice not found. It may have already been deleted.'); }
        const invoiceData = invoiceSnap.val();
        const updates = {};

        if (invoiceData.lrEntries && invoiceData.lrEntries.length > 0) {
          invoiceData.lrEntries.forEach(lrId => {
            updates[`/users/${dataRoot}/lrReports/${lrId}/status`] = 'active';
            updates[`/users/${dataRoot}/lrReports/${lrId}/invoiceId`] = null;
          });
        }
        updates[`/users/${dataRoot}/invoices/${invoiceId}`] = null;

        // **MODIFIED**: Handle both client and transporter outstanding balances
        if (invoiceData.invoiceType === 'market' && invoiceData.transporterId && invoiceData.grandTotal) {
          // For market invoices, update transporter's outstanding
          const transporterOutstandingRef = ref(db, `users/${dataRoot}/transporters/${invoiceData.transporterId}/outstanding`);
          await runTransaction(transporterOutstandingRef, (currentValue) => {
            // Subtract the grand total (which includes GST). This may result in a negative balance (credit).
            return (currentValue || 0) - invoiceData.grandTotal;
          });
        } else if (invoiceData.clientId && invoiceData.grandTotal) {
          // For client invoices, update client's outstanding
          const clientOutstandingRef = ref(db, `users/${dataRoot}/clients/${invoiceData.clientId}/outstanding`);
          await runTransaction(clientOutstandingRef, (currentValue) => {
            return (currentValue || 0) - invoiceData.grandTotal;
          });
        }

        await update(ref(db), updates);

        alert('Invoice successfully undone. The LRs are now available for invoicing again.');
        window.location.reload();
      } catch (error) {
        console.error("Error undoing invoice:", error);
        alert(`Failed to undo invoice: ${error.message}`);
      }
    };

    window.logout = function() {
      const user = auth.currentUser;
      if (user) {
        signOut(auth).then(() => { window.location.href = "index.html"; });
      }
    }
  </script>
</body>
</html>
