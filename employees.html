
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Employee Management, Ranking & Payments</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #2E8B57; /* A deep sea green, matching route-details */
      --present-color: #198754; /* Bootstrap Green */
      --absent-color: #dc3545; /* Bootstrap Red */
      --halfday-color: #ffc107; /* Bootstrap Yellow */
      --gold-color: #FFD700;
      --silver-color: #C0C0C0;
      --bronze-color: #CD7F32;
    }
    body { 
      padding: 0; 
      margin: 0; 
      background-color: #f8f9fa; 
      font-family: 'Inter', sans-serif;
    }
    .main-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .form-section {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #dee2e6;
    }
    .nav-tabs .nav-link.active {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    .nav-tabs .nav-link {
      color: var(--primary-color);
    }
    
    /* Attendance Calendar Styles */
    .attendance-calendar-container {
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      background-color: #fff;
    }
    .attendance-grid {
      display: grid;
      grid-template-columns: 200px repeat(7, 1fr); /* Employee Name + 7 Days */
      gap: 1px;
      border: 1px solid #eee;
      background-color: #eee;
    }
    .grid-cell {
      background-color: white;
      padding: 8px 5px;
      text-align: center;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .grid-header {
      background-color: #f8f9fa;
      font-weight: bold;
      color: #333;
      padding: 10px 5px;
    }
    .grid-cell.employee-name {
      text-align: left;
      font-weight: 600;
      background-color: #f8f9fa;
      position: sticky;
      left: 0;
      z-index: 10;
      border-right: 1px solid #eee;
    }
    .status-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      font-size: 0.8rem;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: all 0.2s;
    }
    .status-P { background-color: var(--present-color); color: white; }
    .status-A { background-color: var(--absent-color); color: white; }
    .status-H { background-color: var(--halfday-color); color: #333; }
    .status-L { background-color: #0d6efd; color: white; } /* Leave */

    /* Ranking Award Styles */
    .award-icon {
        margin-right: 5px;
        font-size: 1.1em;
    }
    .rank-1 { color: var(--gold-color); }
    .rank-2 { color: var(--silver-color); }
    .rank-3 { color: var(--bronze-color); }

    /* Table alignment fixes */
    #employeeRankingTable {
      table-layout: fixed !important;
      width: 100% !important;
    }
    #employeeRankingTable th,
    #employeeRankingTable td {
      padding: 8px 12px;
      vertical-align: middle;
    }
    #employeeRankingTable .text-start {
      text-align: left !important;
    }
    #employeeRankingTable .text-end {
      text-align: right !important;
    }
    #employeeRankingTable .text-center {
      text-align: center !important;
    }
    #employeeRankingTable td:first-child {
      max-width: 300px;
      word-wrap: break-word;
      white-space: normal;
    }
    #employeeRankingTable td:last-child {
      white-space: nowrap;
      min-width: 120px;
    }
    .table-responsive {
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>

  <div class="container mt-4">
    <div class="main-content">
      <h2 class="mb-4"><i class="fas fa-users-cog me-2" style="color: var(--primary-color);"></i>Employee Management</h2>

      <ul class="nav nav-tabs" id="employeeTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="employees-ranking-tab" data-bs-toggle="tab" data-bs-target="#employeesRanking" type="button" role="tab">
            <i class="fas fa-list-ol me-1"></i> Employee List & LR Ranking
          </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendanceView" type="button" role="tab">
              <i class="fas fa-calendar-check me-1"></i> Attendance Calendar
            </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payments" type="button" role="tab">
            <i class="fas fa-money-check-alt me-1"></i> Record Salary Payment
          </button>
        </li>
      </ul>

      <div class="tab-content pt-3" id="employeeTabsContent">

        <div class="tab-pane fade show active" id="employeesRanking" role="tabpanel" aria-labelledby="employees-ranking-tab">

          <form id="employeeForm" class="form-section">
            <h4 class="mb-3">Add/Edit Employee</h4>
            <input type="hidden" id="employeeIdHidden">
            <div class="row">
              <div class="col-md-3 mb-3">
                <label for="employeeName" class="form-label">Name <span class="text-danger">*</span></label>
                <input type="text" id="employeeName" class="form-control rounded" required>
              </div>
              <div class="col-md-3 mb-3">
                <label for="employeeDesignation" class="form-label">Designation <span class="text-danger">*</span></label>
                <input type="text" id="employeeDesignation" class="form-control rounded" required>
              </div>
              <div class="col-md-3 mb-3">
                <label for="employeeSalary" class="form-label">Monthly Salary (‚Çπ) <span class="text-danger">*</span></label>
                <input type="number" id="employeeSalary" class="form-control rounded" required step="100">
              </div>
              <div class="col-md-3 mb-3">
                <label for="employeeContact" class="form-label">Contact</label>
                <input type="tel" id="employeeContact" class="form-control rounded">
              </div>
            </div>
            <div class="d-flex gap-2">
              <button type="submit" class="btn text-white rounded shadow-md" style="background-color: var(--primary-color);" id="saveEmployeeBtn">
                <i class="fas fa-save me-2"></i>Add Employee
              </button>
              <button type="button" class="btn btn-secondary rounded shadow-md" id="cancelEditBtn" style="display: none;">
                <i class="fas fa-times me-2"></i>Cancel Edit
              </button>
            </div>
          </form>

          <div class="form-section mt-4">
            <h4 class="mb-3">LR Ranking Filter</h4>
            <div class="row align-items-end">
              <div class="col-md-4 mb-3">
                <label for="rankingFromDate" class="form-label">From Date</label>
                <input type="date" id="rankingFromDate" class="form-control rounded">
              </div>
              <div class="col-md-4 mb-3">
                <label for="rankingToDate" class="form-label">To Date</label>
                <input type="date" id="rankingToDate" class="form-control rounded">
              </div>
              <div class="col-md-4 mb-3">
                <button type="button" class="btn text-white rounded shadow-md w-full" style="background-color: var(--primary-color);" onclick="populateEmployeeRankingTable()">
                  <i class="fas fa-chart-bar me-2"></i>Apply Ranking Filter
                </button>
              </div>
            </div>
          </div>


          <h4 class="mb-3 mt-4">Employee Details & Performance Ranking</h4>
          <div class="table-responsive">
            <table id="employeeRankingTable" class="table table-striped table-bordered" style="width:100%">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Designation</th>
                  <th>Salary (‚Çπ)</th>
                  <th class="text-end">Total LRs Generated</th>
                  <th class="text-end">Total Weight (MT)</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody id="employeeRankingTableBody"></tbody>
            </table>
          </div>
        </div>
        
        <div class="tab-pane fade" id="attendanceView" role="tabpanel" aria-labelledby="attendance-tab">
            <h4 class="mb-3">Weekly Attendance Calendar</h4>
            <div class="row mb-3 align-items-center">
                <div class="col-auto">
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="dropdownWeekView" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-calendar-alt me-2"></i><span id="currentWeekDisplay">Loading...</span>
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownWeekView" id="weekSelectorDropdown">
                            </ul>
                    </div>
                </div>
                <div class="col-auto d-flex gap-2">
                    <button class="btn btn-outline-secondary" onclick="changeWeek(-1)"><i class="fas fa-chevron-left"></i> Previous Week</button>
                    <button class="btn btn-outline-secondary" onclick="changeWeek(1)">Next Week <i class="fas fa-chevron-right"></i></button>
                </div>
            </div>

            <div class="attendance-calendar-container overflow-auto">
                <div id="attendanceCalendarGrid" class="attendance-grid">
                    </div>
                <div class="mt-3">
                    <span class="badge status-P">P - Present</span>
                    <span class="badge status-A">A - Absent</span>
                    <span class="badge status-H">H - Half Day</span>
                    <span class="badge status-L">L - Leave</span>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="payments" role="tabpanel" aria-labelledby="payments-tab">
            <h4 class="mb-3">Record New Salary Payment Transaction</h4>
            <form id="paymentForm" class="form-section">
                <input type="hidden" id="paymentIdHidden">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="paymentEmployeeId" class="form-label">Employee <span class="text-danger">*</span></label>
                        <select id="paymentEmployeeId" class="form-select rounded" required>
                            <option value="">Select Employee</option>
                            </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="paymentDate" class="form-label">Date <span class="text-danger">*</span></label>
                        <input type="date" id="paymentDate" class="form-control rounded" required>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="paymentAmount" class="form-label">Amount (‚Çπ) <span class="text-danger">*</span></label>
                        <input type="number" id="paymentAmount" class="form-control rounded" required step="100" min="1">
                    </div>
                    <div class="col-md-2 mb-3 d-flex align-items-end">
                        <button type="submit" class="btn text-white rounded shadow-md w-100" style="background-color: var(--primary-color);" id="savePaymentBtn">
                            <i class="fas fa-plus me-2"></i>Record Payment
                        </button>
                    </div>
                </div>
            </form>

            <h5 class="mb-3 mt-4">Detailed Payment Transactions History</h5>
            <div class="table-responsive">
                <table id="paymentDetailTable" class="table table-striped table-bordered" style="width:100%">
                    <thead>
                        <tr>
                            <th>Employee Name</th>
                            <th>Date</th>
                            <th class="text-end">Amount (‚Çπ)</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="paymentDetailTableBody">
                    </tbody>
                </table>
            </div>
        </div>

      </div>
    </div>
  </div>

  <div class="modal fade" id="employeeDetailsModal" tabindex="-1" aria-labelledby="employeeDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="employeeDetailsModalLabel">Employee Details: <span id="modalEmployeeName"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            
            <ul class="nav nav-tabs" id="detailTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#detailsContent" type="button" role="tab">
                        <i class="fas fa-info-circle me-1"></i> General
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="salary-tab" data-bs-toggle="tab" data-bs-target="#salaryContent" type="button" role="tab">
                        <i class="fas fa-wallet me-1"></i> Salary & Payments
                    </button>
                </li>
            </ul>

            <div class="tab-content pt-3" id="detailTabsContent">
                <div class="tab-pane fade show active" id="detailsContent" role="tabpanel" aria-labelledby="details-tab">
                    <h6>Contact & Role</h6>
                    <p><strong>Designation:</strong> <span id="modalDesignation"></span></p>
                    <p><strong>Contact:</strong> <span id="modalContact"></span></p>
                    <p><strong>Monthly Salary:</strong> <span id="modalSalary"></span></p>
                    <hr>
                    <div class="d-flex gap-2">
                         <button class="btn btn-sm btn-outline-primary" onclick="editEmployeeFromModal()"><i class="fas fa-edit"></i> Edit Details</button>
                         <button class="btn btn-sm btn-outline-danger" onclick="deleteEmployeeFromModal()"><i class="fas fa-trash"></i> Delete Employee</button>
                    </div>
                </div>

                <div class="tab-pane fade" id="salaryContent" role="tabpanel" aria-labelledby="salary-tab">
                    
                    <h5 class="mb-3">Payment Status (Current Month)</h5>
                    <div id="paymentStatusCard" class="alert alert-info" role="alert">
                        </div>

                    <h5 class="mb-3 mt-4">Recent Payment Transactions</h5>
                    <div class="table-responsive">
                        <table id="modalPaymentDetailTable" class="table table-striped table-bordered" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th class="text-end">Amount (‚Çπ)</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="modalPaymentDetailTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
      </div>
    </div>
  </div>

    <!-- Load secure configuration first -->
  <!-- Inline Configuration (replaces evm.js) -->
    <script>
        // ========================================
        // üî• FIREBASE CONFIGURATION
        // ========================================
        if (!window.FIREBASE_CONFIG) {
            window.FIREBASE_CONFIG = {
                apiKey: "AIzaSyDAlk_K8p8Of8Ne6Jpcl2QqXTtm95NgG7o",
                authDomain: "transport-dashboard-ad69a.firebaseapp.com",
                databaseURL: "https://transport-dashboard-ad69a-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "transport-dashboard-ad69a",
                storageBucket: "transport-dashboard-ad69a.appspot.com",
                messagingSenderId: "526889676196",
                appId: "1:526889676196:web:66032c80a4aede690ae531",
                measurementId: "G-7F9R7HJYDH"
            };
        }

        // ========================================
        // ‚òÅÔ∏è CLOUDINARY CONFIGURATION
        // ========================================
        if (!window.CLOUDINARY_CONFIG) {
            window.CLOUDINARY_CONFIG = {
                cloudName: "doqapn15f",
                uploadPreset: "vehicle-driver",
                folders: {
                    vehicles: "transport/vehicles",
                    drivers: "transport/drivers", 
                    documents: "transport/documents",
                    profiles: "transport/profiles",
                    receipts: "transport/receipts",
                    expenses: "transport/expenses"
                },
                apiUrl: "https://api.cloudinary.com/v1_1/doqapn15f/image/upload",
                baseUrl: "https://res.cloudinary.com/doqapn15f/image/upload"
            };
        }

        // ========================================
        // üåç ENVIRONMENT CONFIGURATION
        // ========================================
        if (!window.ENVIRONMENT) {
            window.ENVIRONMENT = {
                name: "production",
                debug: false,
                apiBaseUrl: window.location.origin,
                version: "1.0.0"
            };
        }
    </script>
  

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="navbar-loader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

  <script>
    // Firebase configuration - (Configuration remains the same)
    // Load Firebase configuration securely from EVM
    let firebaseConfig;
    
    try {
      // Get Firebase configuration from secure EVM system
      // Initialize Firebase with proper error handling
    try {
        if (!window.FIREBASE_CONFIG) {
            throw new Error('Firebase configuration not loaded. Please ensure evm.js is loaded first.');
        }
        
        if (!window.FIREBASE_CONFIG.databaseURL) {
            throw new Error('Firebase databaseURL not found in configuration.');
        }
        
        if (!window.FIREBASE_CONFIG.projectId) {
            throw new Error('Firebase projectId not found in configuration.');
        }
        
        firebaseConfig = window.FIREBASE_CONFIG;
        
        // Check if we're using fallback values
        if (false) { // Condition is always false in the final logic, keeping as per original structure
            
        } else {
            
            
            
        }
    } catch (error) {
        console.error('‚ùå Failed to load Firebase configuration:', error);
        
        // Use fallback configuration to prevent complete failure
        firebaseConfig = {
            apiKey: "AIzaSyDAlk_K8p8Of8Ne6Jpcl2QqXTtm95NgG7o",
            authDomain: "transport-dashboard-ad69a.firebaseapp.com",
            databaseURL: "https://transport-dashboard-ad69a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "transport-dashboard-ad69a",
            storageBucket: "transport-dashboard-ad69a.appspot.com",
            messagingSenderId: "526889676196",
            appId: "1:526889676196:web:66032c80a4aede690ae531",
            measurementId: "G-7F9R7HJYDH"
        };
        
    }} catch (error) {
      console.error('‚ùå Failed to load Firebase configuration:', error);
      
      // Use fallback configuration to prevent complete failure
      firebaseConfig = window.FIREBASE_CONFIG;
    }

    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(window.FIREBASE_CONFIG);
    }
    const db = firebase.database();
    const auth = firebase.auth();

    // Globals
    let currentCoreAccountId = null;
    let userId = null;
    let employeeRankingTable, paymentDetailTable, modalPaymentDetailTable; // Updated table variables
    let allEmployees = {};
    let allLRs = [];
    let allAttendance = {}; 
    let allPayments = []; 
    let isAuthReady = false;
    let currentEmployeeIdViewing = null; 
    let employeeRankingList = []; // NEW: Store the calculated ranking list globally

    // Attendance Calendar State
    let currentWeekStart = getStartOfWeek(new Date()); 
    
    // Status map for display
    const statusMap = {
        'Present': 'P',
        'Absent': 'A',
        'Half Day': 'H',
        'Leave': 'L' 
    };
    const statusCycle = ['Present', 'Absent', 'Half Day', 'Leave']; 


    // --- UTILITY FUNCTIONS ---
    function getStartOfWeek(date) {
      const d = new Date(date);
      const day = d.getDay(); // 0 for Sunday, 6 for Saturday
      const diff = d.getDate() - day;
      d.setDate(diff);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function getWeekDays(startOfWeek) {
        const days = [];
        for (let i = 0; i < 7; i++) {
            const date = new Date(startOfWeek);
            date.setDate(date.getDate() + i);
            days.push({
                dateStr: date.toISOString().split('T')[0],
                dayOfWeek: date.toLocaleDateString('en-US', { weekday: 'short' }),
                display: date.toLocaleDateString('en-IN', { day: '2-digit', month: '2-digit' })
            });
        }
        return days;
    }

    function toDateStr(date) {
        return date.toISOString().split('T')[0];
    }
    
    function formatCurrency(amount) {
        return `‚Çπ${(amount || 0).toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
    }
    
    // --- FIREBASE AUTH STATE CHANGE ---
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        userId = user.uid;
        try {
          const userProfileRef = db.ref(`users/${userId}`);
          const userSnapshot = await userProfileRef.once('value');
          const userData = userSnapshot.val();
          currentCoreAccountId = (userData && userData.coreAccountId) || userId;
        } catch (error) {
          currentCoreAccountId = userId; 
        }
        
        isAuthReady = true;
        await initializeDataTables();
        loadEmployeeData();
        loadAttendanceData();
        loadLRsForRanking();
        loadPaymentData();
        populatePaymentEmployeeSelect(); 
        renderAttendanceCalendar(); 
        
        // Set initial ranking filter dates (Current Month)
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
        document.getElementById('rankingFromDate').value = firstDay;
        document.getElementById('rankingToDate').value = lastDay;
      } else {
        currentCoreAccountId = null;
        userId = null;
        isAuthReady = false;
      }
    });


    // --- DATA TABLE INITIALIZATION ---
    async function initializeDataTables() {
      if (document.readyState === 'loading') {
        await new Promise(resolve => document.addEventListener('DOMContentLoaded', resolve));
      }
      if (typeof $ === 'undefined' || !$.fn.DataTable) {
        await new Promise(resolve => setTimeout(resolve, 500));
        return initializeDataTables();
      }

      const initTable = (selector, config) => {
        const element = $(selector);
        if ($.fn.DataTable.isDataTable(selector)) {
          element.DataTable().destroy();
        }
        element.find('tbody').empty();
        try {
            return element.DataTable(config);
        } catch(e) {
            return null;
        }
      };

      // 1. Employee + Ranking Table (Combined)
      employeeRankingTable = initTable('#employeeRankingTable', {
        pageLength: 10,
        order: [[3, 'desc']], // Default sort by Total LRs Generated
        destroy: true,
        deferRender: true,
        "columns": [
          { "width": "25%", "className": "text-start" },  // Name
          { "width": "20%", "className": "text-start" },  // Designation  
          { "width": "15%", "className": "text-end" },    // Salary
          { "width": "15%", "className": "text-end" },    // Total LRs Generated
          { "width": "15%", "className": "text-end" },    // Total Weight
          { "width": "10%", "className": "text-center", "orderable": false }  // Actions
        ],
        "columnDefs": [
          { "orderable": false, "targets": [5] }
        ],
        scrollX: true,
        scrollY: false,
        autoWidth: false,
        responsive: false, // Disable responsive to maintain fixed layout
        fixedHeader: false,
        stateSave: false, // Don't save state to avoid reload issues
        initComplete: function() {
          // Force table redraw on initialization
          this.api().columns.adjust().draw();
        }
      });
      
      // 2. Detailed Payment Table (Main Tab)
      paymentDetailTable = initTable('#paymentDetailTable', {
        pageLength: 10,
        order: [[1, 'desc']],
        destroy: true,
        deferRender: true,
        "columnDefs": [
            { "className": "text-end", "targets": [2] },
            { "className": "text-center", "targets": [3], "orderable": false }
        ],
        autoWidth: false
      });
      
      // 3. Modal Payment Detail Table (For View Details Modal)
      modalPaymentDetailTable = initTable('#modalPaymentDetailTable', {
        pageLength: 5,
        order: [[0, 'desc']],
        destroy: true,
        deferRender: true,
        paging: false,
        searching: false,
        info: false,
        "columnDefs": [
            { "className": "text-end", "targets": [1] },
            { "className": "text-center", "targets": [2], "orderable": false }
        ],
        autoWidth: false
      });
    }

    // --- FIREBASE DATA LISTENERS ---

    function loadEmployeeData() {
      if (!isAuthReady || !currentCoreAccountId) return;
      const employeesRef = db.ref(`users/${currentCoreAccountId}/employees`);
      
      employeesRef.on('value', (snapshot) => {
        allEmployees = {};
        if (snapshot.exists()) {
          snapshot.forEach((child) => {
            const emp = child.val();
            allEmployees[child.key] = { id: child.key, ...emp };
          });
        }
        populateEmployeeRankingTable(); 
        populatePaymentEmployeeSelect(); 
        renderAttendanceCalendar(); 
        populatePaymentDetailTable(); 
      });
    }

    function loadAttendanceData() {
      if (!isAuthReady || !currentCoreAccountId) return;
      const attendanceRef = db.ref(`users/${currentCoreAccountId}/attendance`);
      
      attendanceRef.on('value', (snapshot) => {
        allAttendance = {};
        if (snapshot.exists()) {
          snapshot.forEach((child) => {
            const att = child.val();
            if (att.date && att.employeeId) {
                allAttendance[`${att.employeeId}_${att.date}`] = { ...att, id: child.key };
            }
          });
        }
        renderAttendanceCalendar();
        if ($('#employeeDetailsModal').hasClass('show')) {
            updateModalPaymentStatus(currentEmployeeIdViewing);
        }
      });
    }

    function loadLRsForRanking() {
      if (!isAuthReady || !currentCoreAccountId) return;
      const lrRef = db.ref(`users/${currentCoreAccountId}/lrReports`);
      
      lrRef.on('value', (snapshot) => {
        allLRs = [];
        if (snapshot.exists()) {
          snapshot.forEach((child) => {
            const lr = child.val();
            if (lr.employeeId) {
              allLRs.push({ id: child.key, ...lr });
            }
          });
        }
        populateEmployeeRankingTable(); 
      });
    }
    
    function loadPaymentData() {
        if (!isAuthReady || !currentCoreAccountId) return;
        const paymentsRef = db.ref(`users/${currentCoreAccountId}/payments`);

        paymentsRef.on('value', (snapshot) => {
            allPayments = [];
            if (snapshot.exists()) {
                snapshot.forEach((child) => {
                    const pay = child.val();
                    allPayments.push({ id: child.key, ...pay });
                });
            }
            populatePaymentDetailTable();
            if ($('#employeeDetailsModal').hasClass('show')) {
                updateModalPaymentStatus(currentEmployeeIdViewing);
            }
        });
    }


    // --- EMPLOYEE & RANKING FUNCTIONS (COMBINED) ---

    // Renamed from generateRankingReport and integrated employee data population
    window.populateEmployeeRankingTable = () => {
        if (!employeeRankingTable || !$.fn.DataTable.isDataTable('#employeeRankingTable')) return;
        
        const fromDateStr = document.getElementById('rankingFromDate').value;
        const toDateStr = document.getElementById('rankingToDate').value;

        let fromDate = new Date(0); 
        let toDate = new Date(); 
        
        if (fromDateStr && toDateStr) {
            fromDate = new Date(fromDateStr);
            toDate = new Date(toDateStr);
            toDate.setHours(23, 59, 59, 999); 
        }

        const rankingData = {};

        // 1. Aggregate LR data based on filter dates
        Object.keys(allEmployees).forEach(empId => {
            rankingData[empId] = { lrCount: 0, totalWeight: 0 };
        });

        allLRs.forEach(lr => {
            const lrDate = new Date(lr.date); 
            const empId = lr.employeeId;
            
            if (lrDate >= fromDate && lrDate <= toDate && rankingData[empId]) {
                const weight = parseFloat(lr.weight) || 0;
                rankingData[empId].lrCount += 1;
                rankingData[empId].totalWeight += weight;
            }
        });
        
        // 2. Prepare the ranked list
        employeeRankingList = Object.values(allEmployees).map(emp => {
            const rank = rankingData[emp.id] || { lrCount: 0, totalWeight: 0 };
            return {
                ...emp,
                lrCount: rank.lrCount,
                totalWeight: rank.totalWeight
            };
        }).sort((a, b) => {
            // Sort: Highest LR Count first, then highest Weight
            if (b.lrCount !== a.lrCount) return b.lrCount - a.lrCount;
            return b.totalWeight - a.totalWeight;
        });

        // 3. Populate the table
        employeeRankingTable.clear();
        
        const newRows = employeeRankingList.map((emp, index) => {
            
            // Determine the rank icon and class
            let rankIcon = '';
            let rankClass = '';
            if (emp.lrCount > 0) {
                if (index === 0) {
                    rankIcon = '<i class="fas fa-medal award-icon rank-1" title="Rank 1"></i>';
                    rankClass = 'rank-1';
                } else if (index === 1) {
                    rankIcon = '<i class="fas fa-medal award-icon rank-2" title="Rank 2"></i>';
                    rankClass = 'rank-2';
                } else if (index === 2) {
                    rankIcon = '<i class="fas fa-medal award-icon rank-3" title="Rank 3"></i>';
                    rankClass = 'rank-3';
                } else {
                    rankIcon = `<span class="badge bg-secondary me-1" title="Rank ${index + 1}">${index + 1}</span>`;
                }
            }


            // Action Column: Using buttons stacked vertically
            const actions = `
                <div class="d-flex flex-column align-items-center gap-1">
                    <button class="btn btn-sm btn-outline-primary" onclick="viewEmployeeDetails('${emp.id}')" title="View Details/Salary"><i class="fas fa-eye"></i></button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="editEmployee('${emp.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteEmployee('${emp.id}')" title="Delete"><i class="fas fa-trash"></i></button>
                </div>`;

            return [
                `${rankIcon} ${emp.name || ''}`,
                emp.designation || '',
                formatCurrency(emp.salary),
                emp.lrCount.toLocaleString('en-IN'),
                emp.totalWeight.toFixed(2),
                actions
            ];
        });
        
        employeeRankingTable.rows.add(newRows).draw(false);
    };

    // --- EMPLOYEE DETAIL MODAL (VIEW TAB SIMULATION) ---
    window.viewEmployeeDetails = (empId) => {
        const emp = allEmployees[empId];
        if (!emp) return;

        currentEmployeeIdViewing = empId;
        
        // 1. Populate General Details Tab
        document.getElementById('modalEmployeeName').textContent = emp.name;
        document.getElementById('modalDesignation').textContent = emp.designation;
        document.getElementById('modalContact').textContent = emp.contact || 'N/A';
        document.getElementById('modalSalary').textContent = formatCurrency(emp.salary);

        // 2. Populate Payment History & Status Tab
        updateModalPaymentStatus(empId);
        populateModalPaymentDetailTable(empId);

        // 3. Show Modal
        const modal = new bootstrap.Modal(document.getElementById('employeeDetailsModal'));
        modal.show();
    };

    function updateModalPaymentStatus(empId) {
        const emp = allEmployees[empId];
        if (!emp) return;

        const summary = {};
        const today = new Date();
        const currentMonth = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
        
        let totalPaidCurrentMonth = 0;
        let lastPayment = { date: 'N/A', amount: 0 };

        allPayments.filter(pay => pay.employeeId === empId).forEach(pay => {
            const paymentMonth = pay.date.substring(0, 7);
            
            // Check for last payment
            const paymentTimestamp = new Date(pay.date).getTime();
            if (paymentTimestamp > new Date(lastPayment.date).getTime()) {
                lastPayment = { date: pay.date, amount: pay.amount };
            }

            // Calculate total paid this month
            if (paymentMonth === currentMonth) {
                totalPaidCurrentMonth += pay.amount;
            }
        });
        
        const salaryStatus = totalPaidCurrentMonth >= emp.salary ? 'Paid' : 'Pending';
        const colorClass = totalPaidCurrentMonth >= emp.salary ? 'alert-success' : 'alert-warning';
        const needed = emp.salary - totalPaidCurrentMonth;

        document.getElementById('paymentStatusCard').className = `alert ${colorClass}`;
        document.getElementById('paymentStatusCard').innerHTML = `
            <p class="mb-1"><strong>Monthly Salary:</strong> ${formatCurrency(emp.salary)}</p>
            <p class="mb-1"><strong>Total Paid This Month (${currentMonth}):</strong> ${formatCurrency(totalPaidCurrentMonth)}</p>
            <p class="mb-1"><strong>Status:</strong> <span class="badge ${totalPaidCurrentMonth >= emp.salary ? 'bg-success' : 'bg-danger'}">${salaryStatus}</span></p>
            ${needed > 0 ? `<p class="mb-0"><strong>Remaining:</strong> ${formatCurrency(needed)}</p>` : ''}
            <p class="mb-0 mt-2 text-muted">Last Payment: ${lastPayment.date} (${formatCurrency(lastPayment.amount)})</p>
        `;
    }

    function populateModalPaymentDetailTable(empId) {
        if (!modalPaymentDetailTable || !$.fn.DataTable.isDataTable('#modalPaymentDetailTable')) return;

        modalPaymentDetailTable.clear();

        const rows = allPayments
            .filter(pay => pay.employeeId === empId)
            .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()) 
            .slice(0, 5) // Show only the 5 most recent
            .map(pay => {
                return [
                    pay.date,
                    formatCurrency(pay.amount),
                    `<button class="btn btn-sm btn-outline-danger" onclick="deletePayment('${pay.id}', true)"><i class="fas fa-trash"></i></button>`
                ];
            });

        modalPaymentDetailTable.rows.add(rows).draw(false);
    }
    
    // Helper functions for CRUD from Modal
    window.editEmployeeFromModal = () => {
        $('#employeeDetailsModal').modal('hide');
        editEmployee(currentEmployeeIdViewing);
        document.getElementById('employees-ranking-tab').click(); 
        document.querySelector('.tab-content').scrollIntoView({ behavior: 'smooth' });
    }
    window.deleteEmployeeFromModal = () => {
        $('#employeeDetailsModal').modal('hide');
        deleteEmployee(currentEmployeeIdViewing);
    }


    // --- ATTENDANCE CALENDAR FUNCTIONS --- (Restored to dedicated tab logic)

    window.changeWeek = (direction) => {
        const newDate = new Date(currentWeekStart);
        newDate.setDate(newDate.getDate() + (direction * 7));
        currentWeekStart = getStartOfWeek(newDate);
        renderAttendanceCalendar();
    }
    
    window.toggleAttendanceStatus = async (employeeId, dateStr) => {
        if (!isAuthReady || !currentCoreAccountId) return;
        
        const lookupKey = `${employeeId}_${dateStr}`;
        const currentAtt = allAttendance[lookupKey];
        const currentStatus = currentAtt?.status || 'Absent';
        
        const currentIndex = statusCycle.indexOf(currentStatus);
        const nextIndex = (currentIndex + 1) % statusCycle.length;
        const nextStatus = statusCycle[nextIndex];
        
        const attendanceData = { 
            date: dateStr, 
            employeeId, 
            status: nextStatus, 
            timestamp: new Date().toISOString() 
        };
        
        try {
            if (currentAtt) {
                await db.ref(`users/${currentCoreAccountId}/attendance/${currentAtt.id}`).update(attendanceData);
            } else {
                const newRef = db.ref(`users/${currentCoreAccountId}/attendance`).push();
                await newRef.set({ ...attendanceData, id: newRef.key });
            }
        } catch (error) {
            alert('Error saving attendance. Please check the console.');
        }
    };

    function renderAttendanceCalendar() {
        const container = document.getElementById('attendanceCalendarGrid');
        if (!container || Object.keys(allEmployees).length === 0) {
            if(container) container.innerHTML = '<div class="p-3 text-center text-muted">No employees found or data not loaded.</div>';
            return;
        }

        const days = getWeekDays(currentWeekStart);
        const employeeList = Object.values(allEmployees).sort((a, b) => a.name.localeCompare(b.name));
        
        const weekStartDisplay = days[0].display;
        const weekEndDisplay = days[6].display;
        document.getElementById('currentWeekDisplay').textContent = `${weekStartDisplay} - ${weekEndDisplay}`;


        let html = '';
        
        // 1. Grid Headers
        html += '<div class="grid-header grid-cell">Employee</div>';
        days.forEach(day => {
            html += `<div class="grid-header grid-cell" title="${day.dateStr}">${day.dayOfWeek}<br>(${day.display})</div>`;
        });

        // 2. Employee Rows
        employeeList.forEach((emp, index) => {
            html += `<div class="grid-cell employee-name">${index + 1}. ${emp.name}</div>`;
            
            days.forEach(day => {
                const lookupKey = `${emp.id}_${day.dateStr}`;
                const att = allAttendance[lookupKey];
                const status = att ? statusMap[att.status] : 'A'; 
                
                html += `<div class="grid-cell" onclick="toggleAttendanceStatus('${emp.id}', '${day.dateStr}')">
                            <span class="status-badge status-${status}">${status}</span>
                         </div>`;
            });
        });

        container.innerHTML = html;
        container.style.gridTemplateColumns = '200px repeat(7, 1fr)';
    }


    // --- PAYMENT CRUD FUNCTIONS ---

    function populatePaymentEmployeeSelect() {
        const select = document.getElementById('paymentEmployeeId');
        if (!select) return;

        while (select.options.length > 1) {
            select.remove(1);
        }

        const employeeList = Object.values(allEmployees).sort((a, b) => a.name.localeCompare(b.name));

        employeeList.forEach(emp => {
            const option = document.createElement('option');
            option.value = emp.id;
            option.textContent = `${emp.name} (${emp.designation}) - ${formatCurrency(emp.salary)}`;
            select.appendChild(option);
        });
    }

    document.getElementById('paymentForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!isAuthReady || !currentCoreAccountId) return;

        const employeeId = document.getElementById('paymentEmployeeId').value;
        const date = document.getElementById('paymentDate').value;
        const amount = parseFloat(document.getElementById('paymentAmount').value) || 0;

        if (!employeeId || !date || amount <= 0) {
            alert('Please fill in all required payment fields correctly.');
            return;
        }

        const paymentData = { 
            employeeId, 
            date, 
            amount, 
            timestamp: new Date().toISOString() 
        };
        
        try {
            const newPaymentRef = db.ref(`users/${currentCoreAccountId}/payments`).push();
            await newPaymentRef.set({ ...paymentData, id: newPaymentRef.key });

            alert('Payment recorded successfully!');
            e.target.reset();
            document.getElementById('paymentDate').value = toDateStr(new Date()); 
        } catch (error) {
            console.error("Error recording payment:", error);
            alert('Error recording payment. Please check the console.');
        }
    });

    function populatePaymentDetailTable() {
        if (!paymentDetailTable || !$.fn.DataTable.isDataTable('#paymentDetailTable')) return;

        paymentDetailTable.clear();

        const rows = allPayments
            .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()) 
            .map(pay => {
                const emp = allEmployees[pay.employeeId] || { name: 'Unknown' };
                return [
                    emp.name,
                    pay.date,
                    formatCurrency(pay.amount),
                    `<button class="btn btn-sm btn-outline-danger" onclick="deletePayment('${pay.id}')"><i class="fas fa-trash"></i></button>`
                ];
            });

        paymentDetailTable.rows.add(rows).draw(false);
    }
    
    // isModalCall is used to know if we need to refresh the modal table
    window.deletePayment = async (paymentId, isModalCall = false) => {
        if (!isAuthReady || !currentCoreAccountId) return;
        if (confirm('Are you sure you want to delete this payment record?')) {
            try {
                const paymentToDelete = allPayments.find(p => p.id === paymentId);
                
                if (paymentToDelete) {
                    await db.ref(`users/${currentCoreAccountId}/payments/${paymentId}`).remove();
                    alert('Payment record deleted successfully!');
                    
                    if(isModalCall) {
                        updateModalPaymentStatus(currentEmployeeIdViewing);
                        populateModalPaymentDetailTable(currentEmployeeIdViewing);
                    }
                } else {
                    alert('Error: Payment record not found locally.');
                }
            } catch (error) {
                console.error("Error deleting payment:", error);
                alert('Error deleting payment. Please check the console.');
            }
        }
    }
    
    // --- EMPLOYEE CRUD FUNCTIONS (Unchanged logic, updated UX) ---
    window.editEmployee = (id) => {
      const emp = allEmployees[id];
      if (emp) {
        document.getElementById('employeeIdHidden').value = id;
        document.getElementById('employeeName').value = emp.name;
        document.getElementById('employeeDesignation').value = emp.designation;
        document.getElementById('employeeSalary').value = emp.salary;
        document.getElementById('employeeContact').value = emp.contact;
        document.getElementById('saveEmployeeBtn').innerHTML = '<i class="fas fa-save me-2"></i>Update Employee';
        document.getElementById('cancelEditBtn').style.display = 'inline-block';
        document.querySelector('.tab-content').scrollIntoView({ behavior: 'smooth' });
      }
    };

    function cancelEdit() {
      document.getElementById('employeeForm').reset();
      document.getElementById('employeeIdHidden').value = '';
      document.getElementById('saveEmployeeBtn').innerHTML = '<i class="fas fa-save me-2"></i>Add Employee';
      document.getElementById('cancelEditBtn').style.display = 'none';
    }
    window.cancelEdit = cancelEdit;

    window.deleteEmployee = async (id) => {
      if (!isAuthReady || !currentCoreAccountId) return;
      if (confirm('Are you sure you want to delete this employee? This will affect LR, Attendance, and Payment records.')) {
        try {
          await db.ref(`users/${currentCoreAccountId}/employees/${id}`).remove();
          alert('Employee deleted successfully!');
        } catch (error) {
          console.error("Error deleting employee:", error);
          alert('Error deleting employee. Please check the console.');
        }
      }
    };


    // Initial call to set current date on the form
    document.getElementById('paymentDate').value = toDateStr(new Date());

  </script>
</body>
</html>
