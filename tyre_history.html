<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tyre Disposal History</title>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script src="evm.js"></script>

  <script src="secure-api-loader.js"></script>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .container {
      margin-top: 20px;
      margin-bottom: 40px;
    }

    .card {
      border: none;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      border-radius: 8px;
    }

    .status-badge {
      font-size: 0.85em;
      padding: 5px 10px;
      border-radius: 20px;
      font-weight: 500;
    }

    .status-sold {
      background-color: #d1e7dd;
      color: #0f5132;
    }

    .status-unsold {
      background-color: #fff3cd;
      color: #664d03;
    }

    .table th {
      font-weight: 600;
      color: #495057;
      background-color: #f8f9fa;
      border-bottom: 2px solid #dee2e6;
    }

    .table td {
      vertical-align: middle;
    }

    .search-container {
      position: relative;
    }

    .search-container i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #adb5bd;
    }

    .search-container input {
      padding-left: 35px;
      border-radius: 20px;
    }
  </style>
</head>

<body>

  <div id="navbar-placeholder"></div>

  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="mb-0"><i class="fas fa-history me-2"></i>Tyre Disposal History</h2>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-2">
            <label class="form-label text-muted small">Filter by Vehicle</label>
            <select class="form-select form-select-sm" id="vehicleFilter" onchange="runFilters()">
              <option value="">All Vehicles</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label text-muted small">Filter by Reason</label>
            <select class="form-select form-select-sm" id="reasonFilter" onchange="runFilters()">
              <option value="">All Reasons</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label text-muted small">Time Period</label>
            <select class="form-select form-select-sm" id="timeFilter" onchange="runFilters()">
              <option value="all">All Time</option>
              <option value="month">This Month</option>
              <option value="quarter">Last 3 Months</option>
              <option value="year">This Year</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label text-muted small">Search</label>
            <div class="search-container">
              <i class="fas fa-search"></i>
              <input type="text" class="form-control form-select-sm" id="searchInput" placeholder="Tyre No, Brand..."
                oninput="runFilters()">
            </div>
          </div>
          <div class="col-md-3 d-flex align-items-end justify-content-end gap-2">
            <button id="bulkSellBtn" class="btn btn-primary btn-sm" onclick="bulkSell()" disabled>
              <i class="fas fa-tags me-1"></i> Bulk Sell
            </button>
            <button class="btn btn-outline-success btn-sm" onclick="exportToCSV()">
              <i class="fas fa-file-csv me-1"></i> Export
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card bg-primary text-white h-100">
          <div class="card-body py-3">
            <h6 class="card-title mb-0 opacity-75">Total Disposed</h6>
            <h3 class="fw-bold mb-0 mt-2" id="totalCount">0</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-success text-white h-100">
          <div class="card-body py-3">
            <h6 class="card-title mb-0 opacity-75">Total Value Recovered</h6>
            <h3 class="fw-bold mb-0 mt-2" id="totalRecovered">₹0</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-warning text-dark h-100">
          <div class="card-body py-3">
            <h6 class="card-title mb-0 opacity-75">Unsold Inventory</h6>
            <h3 class="fw-bold mb-0 mt-2" id="unsoldInventory">0</h3>
          </div>
        </div>
      </div>
    </div>

  </div>

  <ul class="nav nav-tabs mb-3">
    <li class="nav-item">
      <button class="nav-link active" id="tab-disposed" onclick="switchTab('disposed')">
        <i class="fas fa-trash-alt me-2"></i>Disposed / Unsold
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="tab-sold" onclick="switchTab('sold')">
        <i class="fas fa-rupee-sign me-2"></i>Sold History
      </button>
    </li>
  </ul>

  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover mb-0" id="historyTable">
          <thead class="bg-light">
            <tr>
              <th style="width: 40px;" class="text-center">
                <input class="form-check-input" type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
              </th>
              <th>Disposal Date</th>
              <th>Vehicle</th>
              <th>Tyre No</th>
              <th>Brand</th>
              <th>Life Span</th>
              <th>Added Date</th>
              <th>Position</th>
              <th>Reason</th>
              <th class="text-end" id="resellPriceHeader">Resell Price</th>
              <th class="text-center">Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="historyTableBody">
          </tbody>
        </table>
      </div>
    </div>
    <div class="card-footer bg-white border-top-0 py-3">
      <nav aria-label="Page navigation">
        <div class="d-flex justify-content-between align-items-center">
          <span class="text-muted small" id="entriesInfo">Showing 0 to 0 of 0 entries</span>
          <ul class="pagination pagination-sm mb-0" id="paginationControls">
          </ul>
        </div>
      </nav>
    </div>
  </div>
  </div>

  <script src="navbar-loader.js"></script>
  <script>
    // Global Variables
    let db, auth, currentUser;
    let ref, get, update;
    let allHistoryData = [];
    let filteredData = [];
    let currentTab = 'disposed'; // 'disposed' or 'sold'
    let currentPage = 1;
    const itemsPerPage = 15;

    // Standard Initialize function
    function initApp(attempt = 1) {
      // 1. Check if Firebase is loaded
      if (!firebase.apps.length) {
        if (attempt < 20) {
          console.log(`Firebase not yet ready, retrying (${attempt}/20)...`);
          setTimeout(() => initApp(attempt + 1), 200);
          return;
        }
        console.error("Firebase not initialized! Check evm.js loading.");
        alert("System Error: Firebase connection failed.");
        return;
      }

      const app = firebase.app();
      db = firebase.database();
      auth = firebase.auth();
      db = firebase.database();
      auth = firebase.auth();
      // Removed incorrect function assignments

      // 2. Auth Listener
      auth.onAuthStateChanged((user) => {
        if (!user) {
          console.warn("No user logged in, redirecting...");
          // Optional: window.location.href = "index.html"; 
          document.getElementById('historyTableBody').innerHTML =
            '<tr><td colspan="12" class="text-center text-danger py-4">Please log in to view history.</td></tr>';
          return;
        }
        currentUser = user;
        loadTyreHistory();
      });
    }

    // Wait for window load to ensure all scripts (evm.js) have run
    window.addEventListener('load', () => {
      initApp();
      // Initial header state check
      const priceHeader = document.getElementById('resellPriceHeader');
      if (priceHeader) {
        priceHeader.style.display = 'none'; // Default to disposed tab which hides it
      }
    });

    async function loadTyreHistory() {
      if (!currentUser) return;

      const historyTableBody = document.getElementById('historyTableBody');
      historyTableBody.innerHTML = '<tr><td colspan="12" class="text-center py-4"><i class="fas fa-spinner fa-spin me-2"></i>Loading history...</td></tr>';

      try {
        const historyRef = db.ref(`users/${currentUser.uid}/tyre_history`);
        const snapshot = await historyRef.get();

        if (snapshot.exists()) {
          const data = snapshot.val();
          allHistoryData = Object.entries(data).map(([key, value]) => ({
            id: key,
            ...value
          })).sort((a, b) => (b.disposedAt || 0) - (a.disposedAt || 0)); // Newest first

          populateFilters(allHistoryData);
          runFilters(); // Initial render
        } else {
          allHistoryData = [];
          renderHistoryTable();
          updateStats([]);
        }
      } catch (error) {
        console.error("Error loading history:", error);
        historyTableBody.innerHTML = `<tr><td colspan="12" class="text-center text-danger py-3">Error loading data: ${error.message}</td></tr>`;
      }
    }

    function populateFilters(data) {
      const vehicles = new Set();
      const reasons = new Set();

      data.forEach(item => {
        if (item.vehicleNumber) {
          vehicles.add(item.vehicleNumber);
        }
        if (item.disposalReason) reasons.add(item.disposalReason);
      });

      const vSelect = document.getElementById('vehicleFilter');
      const rSelect = document.getElementById('reasonFilter');

      // Keep first option
      vSelect.innerHTML = '<option value="">All Vehicles</option>';
      rSelect.innerHTML = '<option value="">All Reasons</option>';

      [...vehicles].sort().forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        vSelect.appendChild(opt);
      });

      [...reasons].sort().forEach(r => {
        const opt = document.createElement('option');
        opt.value = r;
        opt.textContent = r;
        rSelect.appendChild(opt);
      });
    }

    // Combined Filter Function
    window.runFilters = function () {
      const vVal = document.getElementById('vehicleFilter').value.toLowerCase();
      const rVal = document.getElementById('reasonFilter').value;
      const tVal = document.getElementById('timeFilter').value;
      const sText = document.getElementById('searchInput').value.toLowerCase();

      const now = Date.now();
      const oneDay = 24 * 60 * 60 * 1000;


      filteredData = allHistoryData.filter(item => {
        // Tab Filter
        const isSold = item.status === 'Sold';
        if (currentTab === 'disposed' && isSold) return false;
        if (currentTab === 'sold' && !isSold) return false;

        // Vehicle Filter
        if (vVal && !(item.vehicleNumber || '').toLowerCase().includes(vVal)) return false;

        // Reason Filter
        if (rVal && item.disposalReason !== rVal) return false;

        // Time Filter
        if (tVal !== 'all') {
          const dispTime = item.disposedAt || 0;
          const diff = now - dispTime;
          if (tVal === 'month' && diff > 30 * oneDay) return false;
          if (tVal === 'quarter' && diff > 90 * oneDay) return false;
          if (tVal === 'year' && diff > 365 * oneDay) return false;
        }

        // Search Filter
        if (sText) {
          const searchStr = `${item.number} ${item.brand} ${item.vehicleNumber}`.toLowerCase();
          if (!searchStr.includes(sText)) return false;
        }

        return true;
      });

      currentPage = 1; // Reset to page 1 on filter change
      renderHistoryTable();
      updateStats(filteredData);
    }

    function updateStats(data) {
      document.getElementById('totalCount').textContent = data.length;
      const totalVal = data.reduce((sum, item) => sum + (Number(item.resellPrice) || 0), 0);
      document.getElementById('totalRecovered').textContent = `₹${totalVal.toLocaleString('en-IN')}`;

      // Calculate strictly unsold (where status is NOT Sold and resellPrice is 0 or missing)
      const actualUnsold = data.filter(item => {
        const hasPrice = (item.resellPrice && Number(item.resellPrice) > 0);
        const isMarkedSold = item.status === 'Sold';
        return !hasPrice && !isMarkedSold;
      }).length;

      document.getElementById('unsoldInventory').textContent = actualUnsold;
    }

    function renderHistoryTable() {
      const tableBody = document.getElementById('historyTableBody');
      const selectAll = document.getElementById('selectAllCheckbox');
      selectAll.checked = false;

      if (filteredData.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="12" class="text-center py-4 text-muted">No records found matching filters.</td></tr>';
        document.getElementById('entriesInfo').textContent = 'Showing 0 to 0 of 0 entries';
        document.getElementById('paginationControls').innerHTML = '';
        updateBulkButtonState();
        return;
      }

      // Pagination Logic
      const totalItems = filteredData.length;
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      const startIdx = (currentPage - 1) * itemsPerPage;
      const endIdx = Math.min(startIdx + itemsPerPage, totalItems);
      const pageData = filteredData.slice(startIdx, endIdx);

      let html = '';

      pageData.forEach(item => {
        const disposalDate = item.disposedAt ? new Date(item.disposedAt).toLocaleDateString() : '-';
        const addedDate = item.addedAt ? new Date(item.addedAt).toLocaleDateString() : '-';
        const resellPrice = item.resellPrice ? Number(item.resellPrice) : 0;
        const isSold = resellPrice > 0 || item.status === 'Sold';

        const statusBadge = isSold
          ? '<span class="status-badge status-sold">Sold</span>'
          : '<span class="status-badge status-unsold">Unsold</span>';

        // Calculate Lifespan
        let lifeText = '-';
        if (item.addedAt && item.disposedAt) {
          const diffDays = Math.floor((item.disposedAt - item.addedAt) / (1000 * 60 * 60 * 24));
          if (diffDays < 30) lifeText = `${diffDays} days`;
          else if (diffDays < 365) lifeText = `${Math.floor(diffDays / 30)} mths`;
          else lifeText = `${(diffDays / 365).toFixed(1)} yrs`;
        }

        html += `
           <tr>
             <td class="text-center">
               <input class="form-check-input history-checkbox" type="checkbox" value="${item.id}" 
                      ${isSold ? 'disabled' : ''} onchange="updateBulkButtonState()">
             </td>
             <td>${disposalDate}</td>
             <td>${item.vehicleNumber || '-'}</td>
             <td><strong>${item.number}</strong></td>
             <td>${item.brand}</td>
             <td>${lifeText}</td>
             <td>${addedDate}</td>
             <td>${item.position || '-'}</td>
              <td>${item.disposalReason}</td>
              ${currentTab === 'sold' ? `<td class="text-end fw-bold">${resellPrice > 0 ? '₹' + resellPrice.toLocaleString('en-IN') : '-'}</td>` : ''}
              <td class="text-center">${statusBadge}</td>
              <td>
                 <button class="btn btn-sm btn-light border" title="Restore" onclick="restoreTyre('${item.id}')">
                    <i class="fas fa-undo text-primary"></i>
                 </button>
              </td>
           </tr>
         `;
      });

      tableBody.innerHTML = html;
      document.getElementById('entriesInfo').textContent = `Showing ${startIdx + 1} to ${endIdx} of ${totalItems} entries`;
      renderPaginationControls(totalPages);
      updateBulkButtonState();
    }

    function renderPaginationControls(totalPages) {
      const pagination = document.getElementById('paginationControls');
      let html = '';

      // Prev
      html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                  <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Prev</a>
                </li>`;

      // Pages
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
          html += `<li class="page-item ${currentPage === i ? 'active' : ''}">
                         <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                       </li>`;
        } else if (i === currentPage - 2 || i === currentPage + 2) {
          html += `<li class="page-item disabled"><a class="page-link">...</a></li>`;
        }
      }

      // Next
      html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                  <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
                </li>`;

      pagination.innerHTML = html;
    }

    window.changePage = function (page) {
      if (page < 1) return;
      currentPage = page;
      renderHistoryTable();
    }

    // Bulk Action Logic
    window.toggleSelectAll = function () {
      const check = document.getElementById('selectAllCheckbox').checked;
      document.querySelectorAll('.history-checkbox:not(:disabled)').forEach(cb => cb.checked = check);
      updateBulkButtonState();
    }

    window.updateBulkButtonState = function () {
      const count = document.querySelectorAll('.history-checkbox:checked').length;
      document.getElementById('bulkSellBtn').disabled = count === 0;
    }

    window.bulkSell = function () {
      const checked = document.querySelectorAll('.history-checkbox:checked');
      if (checked.length === 0) return;

      const total = prompt(`Enter Total Sale Price for ${checked.length} tyres:`, "0");
      if (total === null) return;

      const pricePer = parseFloat(total) / checked.length;

      const ids = Array.from(checked).map(cb => cb.value);
      const updates = {};

      ids.forEach(id => {
        updates[`users/${currentUser.uid}/tyre_history/${id}/status`] = 'Sold';
        updates[`users/${currentUser.uid}/tyre_history/${id}/resellPrice`] = pricePer;
      });

      db.ref().update(updates).then(() => {
        alert("Tyres marked as sold!");
        loadTyreHistory();
      }).catch(err => alert("Error: " + err.message));
    }

    window.restoreTyre = async function (id) {
      if (!confirm("Are you sure you want to restore this tyre to the vehicle inventory?")) return;

      const historyRef = db.ref(`users/${currentUser.uid}/tyre_history/${id}`);
      try {
        const snapshot = await historyRef.get();
        if (!snapshot.exists()) {
          alert("Record not found.");
          return;
        }

        const tyreData = snapshot.val();
        const vehicleId = tyreData.vehicleId;

        if (!vehicleId) {
          alert("Vehicle information missing for this tyre. Cannot restore.");
          return;
        }

        const vehicleRef = db.ref(`users/${currentUser.uid}/vehicles/${vehicleId}`);
        const vehicleSnap = await vehicleRef.get();

        if (!vehicleSnap.exists()) {
          alert("The original vehicle for this tyre no longer exists. Cannot restore.");
          return;
        }

        const vehicleData = vehicleSnap.val();
        let tyres = vehicleData.tyres || [];

        // Check if tyre number already exists in current inventory (prevent duplicates)
        if (tyres.some(t => t.number === tyreData.number)) {
          alert(`Tyre number ${tyreData.number} already exists in the vehicle inventory.`);
          return;
        }

        // Reconstruct original tyre object
        const restoredTyre = {
          number: tyreData.number || '',
          brand: tyreData.brand || '',
          position: tyreData.position || '',
          addedAt: tyreData.addedAt || Date.now(),
          cost: Number(tyreData.cost) || 0,
          totalRunningKm: Number(tyreData.totalRunningKm) || 0,
          status: 'Active'
        };

        // Add to vehicle
        tyres.push(restoredTyre);

        // Update Vehicle and Remove from History
        const updates = {};
        updates[`users/${currentUser.uid}/vehicles/${vehicleId}/tyres`] = tyres;
        updates[`users/${currentUser.uid}/tyre_history/${id}`] = null;

        await db.ref().update(updates);

        alert("Tyre successfully restored to vehicle inventory.");
        loadTyreHistory(); // Refresh table

      } catch (error) {
        console.error("Error restoring tyre:", error);
        alert("Failed to restore tyre: " + error.message);
      }
    }

    window.exportToCSV = function () {
      if (!filteredData.length) return;
      let csv = "Date,Vehicle,Tyre No,Brand,Reason,Price,Status\n";
      filteredData.forEach(r => {
        csv += `${new Date(r.disposedAt).toLocaleDateString()},${r.vehicleNumber},${r.number},${r.brand},${r.disposalReason},${r.resellPrice || 0},${r.status || 'Unsold'}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `tyre_history_export.csv`;
      a.click();

    }

    // Tab Switching
    window.switchTab = function (tab) {
      currentTab = tab;

      // Update UI
      document.getElementById('tab-disposed').classList.toggle('active', tab === 'disposed');
      document.getElementById('tab-sold').classList.toggle('active', tab === 'sold');

      // Toggle Bulk Button visibility
      const bulkBtn = document.getElementById('bulkSellBtn');
      if (tab === 'sold') {
        bulkBtn.style.display = 'none';
      } else {
        bulkBtn.style.display = 'inline-block';
      }

      // Toggle Header visibility
      const priceHeader = document.getElementById('resellPriceHeader');
      if (priceHeader) {
        priceHeader.style.display = (tab === 'sold') ? 'table-cell' : 'none';
      }

      runFilters();
    }

  </script>
</body>

</html>
