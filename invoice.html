<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Generated Invoices</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <link rel="stylesheet" href="print-invoice.css" media="print">
  <style>
    body { padding: 0; margin: 0; background-color: #f8f9fa; }
    @media print {
      /* Hide everything except the printable area */
      body * {
        visibility: hidden;
      }
      /* Make the printable area and its children visible */
      #printableInvoiceDetail, #printableInvoiceDetail * {
        visibility: visible;
      }
      /* Position the printable area to fill the page */
      #printableInvoiceDetail {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        margin: 0;
        padding: 0;
      }
      /* Hide the modal's footer when printing */
      .modal-footer {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <script src="navbar-loader.js"></script>

  <div class="container">
    <h2 class="mb-4"><i class="fas fa-file-invoice-dollar me-2"></i>Generated Invoices</h2>
    <div class="table-responsive">
      <table id="invoicesTable" class="table table-striped">
        <thead>
          <tr>
            <th>Invoice #</th>
            <th>Date</th>
            <th>Company Name</th>
            <th class="text-end">Total Amount</th>
            <th class="text-center">LRs</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody id="invoicesTableBody">
          <!-- Data will be populated here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Invoice Detail Modal -->
  <div class="modal fade" id="invoiceDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title">Invoice Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="printableInvoiceDetail">
          <!-- Content will be populated dynamically -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="printInvoiceDetail()">
            <i class="fas fa-print me-2"></i>Print
          </button>
          <button type="button" class="btn btn-success" onclick="downloadInvoicePDF()">
            <i class="fas fa-file-pdf me-2"></i>Download PDF
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

  <!-- PDF Generation Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, get, query, orderByChild, equalTo, update, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDAlk_K8p8Of8Ne6Jpcl2QqXTtm95NgG7o",
      authDomain: "transport-dashboard-ad69a.firebaseapp.com",
      databaseURL: "https://transport-dashboard-ad69a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "transport-dashboard-ad69a",
      storageBucket: "transport-dashboard-ad69a.appspot.com",
      messagingSenderId: "526889676196",
      appId: "1:526889676196:web:66032c80a4aede690ae531",
      measurementId: "G-7F9R7HJYDH"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let invoicesTable;
    let coreAccountId = null; // To store the correct data path
    let currentInvoiceData = null; // To store data for PDF download

    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        // **FIX**: Determine the core account ID before initializing the page.
        // This ensures that invoices are loaded from the correct shared path.
        const userRef = ref(db, `users/${user.uid}`);
        get(userRef).then(snapshot => {
          if (snapshot.exists()) {
            const userData = snapshot.val();
            coreAccountId = userData.coreAccountId || user.uid;
          } else {
            coreAccountId = user.uid; // Fallback for safety
          }
          initializePage(user);
        });
      }
    });

    function initializePage(user) {
      invoicesTable = $('#invoicesTable').DataTable({
        order: [[1, 'desc']]
      });
      loadInvoices(coreAccountId); // **FIX**: Use coreAccountId

      // Check for URL param to auto-show an invoice
      const urlParams = new URLSearchParams(window.location.search);
      const invoiceToView = urlParams.get('view');
      if (invoiceToView) {
        viewInvoice(invoiceToView);
      }
    }

    async function loadInvoices(userId) {
      // **FIX**: Use the determined coreAccountId to fetch shared invoices.
      const invoicesRef = ref(db, `users/${coreAccountId}/invoices`);
      const snapshot = await get(invoicesRef);

      invoicesTable.clear();
      if (snapshot.exists()) {
        const invoices = [];
        snapshot.forEach(child => {
          invoices.push({ id: child.key, ...child.val() });
        });
        invoices.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

        invoices.forEach(inv => {
          invoicesTable.row.add([
            inv.invoiceNumber,
            new Date(inv.createdAt).toLocaleDateString('en-IN'),
            inv.companyDetails.name,
            `<span class="text-end d-block">₹${(inv.grandTotal || 0).toFixed(2)}</span>`,
            `<span class="badge bg-secondary">${inv.lrEntries.length}</span>`,
            `<button class="btn btn-sm btn-outline-primary" onclick="viewInvoice('${inv.id}')">
              <i class="fas fa-eye"></i> View
            </button>
            <button class="btn btn-sm btn-outline-warning ms-1" onclick="undoInvoice('${inv.id}')" title="Undo Invoice">
              <i class="fas fa-undo"></i> Undo
            </button>`
          ]);
        });
      }
      invoicesTable.draw();
    }

    // Function to convert number to words (Indian Rupees)
    function numberToWords(num) {
      const a = ['', 'one ', 'two ', 'three ', 'four ', 'five ', 'six ', 'seven ', 'eight ', 'nine ', 'ten ', 'eleven ', 'twelve ', 'thirteen ', 'fourteen ', 'fifteen ', 'sixteen ', 'seventeen ', 'eighteen ', 'nineteen '];
      const b = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
      
      if ((num = Math.floor(num).toString()).length > 9) return 'overflow';
      const n = ('000000000' + num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
      if (!n) return '';
      
      let str = '';
      str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'crore ' : '';
      str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'lakh ' : '';
      str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'thousand ' : '';
      str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'hundred ' : '';
      str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) : '';
      
      return str.trim().replace(/\s+/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ') + ' Only';
    }

    window.viewInvoice = async function(invoiceId) {
      const modalBody = document.getElementById('printableInvoiceDetail');
      modalBody.innerHTML = '<div class="text-center p-5"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Loading invoice...</p></div>';
      $('#invoiceDetailModal').modal('show');

      try {
        const user = auth.currentUser;
        if (!user) throw new Error("User not authenticated.");

        // **FIX**: Use coreAccountId to fetch the specific invoice.
        const invoiceSnap = await get(ref(db, `users/${coreAccountId}/invoices/${invoiceId}`));
        if (!invoiceSnap.exists()) {
          modalBody.innerHTML = '<p class="text-danger text-center">Invoice not found.</p>';
          return;
        }
        const invoice = invoiceSnap.val();
        currentInvoiceData = invoice; // Store for PDF download

        // **FIX**: Fetch client details using the clientId from the invoice.
        // The clientDetails object was not being saved, causing 'undefined' errors.
        let clientName = invoice.companyDetails.name || 'Client Not Found'; // FIX: Provide a safe fallback
        let clientAddress = 'N/A';
        if (invoice.clientId) {
            const clientSnap = await get(ref(db, `users/${coreAccountId}/clients/${invoice.clientId}`));
            if (clientSnap.exists()) {
                clientName = clientSnap.val().clientName;
                clientAddress = clientSnap.val().billingAddress || 'No address provided';
            }
        }

        // **FIX**: Use the `invoice.items` array directly.
        // The invoice object already contains a simplified list of LR entries (`items`)
        // for display purposes. Re-fetching the full LR reports was unnecessary and
        // was causing the 'undefined' error because the data structure was different.
        const lrs = invoice.items || [];


        // Build the invoice HTML
        const invoiceHtml = `
          <div class="p-4">
            <div class="row mb-4">
              <div class="col-12 text-center">
                <h2 class="mb-1 fw-bold text-success">${invoice.companyDetails.name || 'Transport Company'}</h2>
                <p class="mb-1 text-muted">${invoice.companyDetails.address || 'N/A'}</p>
                <p class="mb-0 text-muted"><strong>GST:</strong> ${invoice.companyDetails.gstNumber || 'N/A'}</p>
              </div>
            </div>
            <hr>
            <div class="row mb-4">
              <div class="col-sm-6">
                <h6 class="fw-bold">Consignor:</h6>
                <p class="mb-0">${lrs[0]?.consignor || 'No consignor provided'}</p>
              </div>
              <div class="col-sm-6 text-sm-end mt-3 mt-sm-0">
                <h6 class="fw-bold">Invoice Details:</h6>
                <p class="mb-1"><strong>Invoice #:</strong> <span>${invoice.invoiceNumber}</span></p>
                <p class="mb-0"><strong>Date:</strong> <span>${new Date(invoice.createdAt).toLocaleDateString('en-IN')}</span></p>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-bordered">
                <thead class="table-light">
                  <tr>
                    <th>Date</th><th>LR No</th><th>Truck No</th><th>Consignor</th><th>Consignee</th><th>From</th><th>To</th><th class="text-end">Weight</th><th class="text-end">Amount</th>
                  </tr>
                </thead>
                <tbody>
                  ${lrs.map(lr => `
                    <tr>
                      <td>${new Date(lr.date).toLocaleDateString('en-IN') || 'N/A'}</td>
                      <td>${lr.lrNumber || 'N/A'}</td>
                      <td>${lr.truckNumber || 'N/A'}</td>
                      <td>${lr.consignor || 'N/A'}</td>
                      <td>${lr.consignee || 'N/A'}</td>
                      <td>${lr.from || 'N/A'}</td>
                      <td>${lr.to || 'N/A'}</td>
                      <td class="text-end">${(lr.weight || 0).toFixed(2)}</td>
                      <td class="text-end">₹${(lr.amount || 0).toFixed(2)}</td>
                    </tr>
                  `).join('')}
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="7" rowspan="4" class="align-bottom">
                      <p class="mb-1"><strong>Bank Details:</strong></p>
                      <p class="mb-1 small">Bank: <span>${invoice.bankDetails.bankName}</span></p>
                      <p class="mb-1 small">A/C No: <span>${invoice.bankDetails.accountNumber}</span></p>
                      <p class="mb-1 small">Holder: <span>${invoice.bankDetails.accountHolder || 'N/A'}</span></p>
                      <p class="mb-0 small">IFSC: <span>${invoice.bankDetails.ifscCode || 'N/A'}</span></p>
                      <div class="mt-3">
                        <p class="mb-1"><strong>Amount in Words:</strong></p>
                        <p class="mb-0 small">${numberToWords(invoice.grandTotal || 0)}</p>
                      </div>
                    </td>
                    <td class="text-end"><strong>Subtotal:</strong></td>
                    <td class="text-end fw-bold">₹${(invoice.subtotal || 0).toFixed(2)}</td>
                  </tr>
                  <tr>
                    <td class="text-end"><strong>CGST:</strong></td>
                    <td class="text-end fw-bold">₹${(invoice.cgstAmount || 0).toFixed(2)}</td>
                  </tr>
                  <tr>
                    <td class="text-end"><strong>SGST:</strong></td>
                    <td class="text-end fw-bold">₹${(invoice.sgstAmount || 0).toFixed(2)}</td>
                  </tr>
                  <tr class="table-success">
                    <td class="text-end"><strong>Grand Total:</strong></td>
                    <td class="text-end fw-bold fs-5">₹${(invoice.grandTotal || 0).toFixed(2)}</td>
                  </tr>
                </tfoot>
              </table>
            </div>
            <div class="row mt-4">
              <div class="col-md-6">
                <p class="small text-muted">This is a computer-generated invoice.</p>
              </div>
              <div class="col-md-6 text-end">
                <div class="mt-5">
                  <p class="mb-4">For ${invoice.companyDetails.name}</p>
                  <p class="mb-0">___________________</p>
                  <p class="mb-0">Authorized Signatory</p>
                </div>
              </div>
            </div>
          </div>
        `;
        modalBody.innerHTML = invoiceHtml;
      } catch (error) {
        console.error("Error viewing invoice:", error);
        modalBody.innerHTML = '<p class="text-danger text-center">Could not load invoice details.</p>';
      }
    }

    window.printInvoiceDetail = function() {
      window.print();
    }

    window.downloadInvoicePDF = function() {
      if (!currentInvoiceData) {
        alert('No invoice data loaded. Please view an invoice first.');
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const invoice = currentInvoiceData;

      // --- Header ---
      doc.setFontSize(18);
      doc.setFont('helvetica', 'bold');
      doc.text(invoice.companyDetails.name || 'Transport Company', doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(100);
      doc.text(invoice.companyDetails.address || 'Company Address', doc.internal.pageSize.getWidth() / 2, 26, { align: 'center' });
      doc.text(`GST: ${invoice.companyDetails.gst || 'N/A'}`, doc.internal.pageSize.getWidth() / 2, 31, { align: 'center' });

      // --- Bill To & Invoice Details ---
      doc.setLineWidth(0.5);
      doc.line(14, 35, 196, 35);
      doc.setFontSize(11);
      doc.setTextColor(0);
      doc.setFont('helvetica', 'bold');
      doc.text('Consignor:', 14, 42);
      doc.setFont('helvetica', 'normal');
      doc.text(invoice.items[0]?.consignor || 'No consignor provided', 14, 48);

      doc.setFont('helvetica', 'bold');
      doc.text(`Invoice #: ${invoice.invoiceNumber}`, 196, 42, { align: 'right' });
      doc.setFont('helvetica', 'normal');
      doc.text(`Date: ${new Date(invoice.createdAt).toLocaleDateString('en-IN')}`, 196, 48, { align: 'right' });

      // --- Table ---
      const head = [['Date', 'LR No', 'Truck No', 'From', 'To', 'Weight', 'Amount']];
      const body = invoice.items.map(lr => [
        lr.date || 'N/A',
        lr.lrNumber || 'N/A',
        lr.truckNumber || 'N/A',
        lr.from || 'N/A',
        lr.to || 'N/A',
        (lr.weight || 0).toFixed(2),
        `Rs. ${(lr.amount || 0).toFixed(2)}`
      ]);

      doc.autoTable({
        head: head,
        body: body,
        startY: 55,
        theme: 'grid',
        headStyles: { fillColor: [46, 139, 87] },
        styles: { fontSize: 8 },
        didDrawPage: function (data) {
          // --- Footer Totals ---
          doc.setFontSize(10);
          doc.text(`Subtotal:`, 150, doc.internal.pageSize.height - 30, { align: 'right' });
          doc.text(`Rs. ${(invoice.subtotal || 0).toFixed(2)}`, 196, doc.internal.pageSize.height - 30, { align: 'right' });
          doc.text(`CGST:`, 150, doc.internal.pageSize.height - 25, { align: 'right' });
          doc.text(`Rs. ${(invoice.cgstAmount || 0).toFixed(2)}`, 196, doc.internal.pageSize.height - 25, { align: 'right' });
          doc.text(`SGST:`, 150, doc.internal.pageSize.height - 20, { align: 'right' });
          doc.text(`Rs. ${(invoice.sgstAmount || 0).toFixed(2)}`, 196, doc.internal.pageSize.height - 20, { align: 'right' });
          doc.setFont('helvetica', 'bold');
          doc.text(`Grand Total:`, 150, doc.internal.pageSize.height - 15, { align: 'right' });
          doc.text(`Rs. ${(invoice.grandTotal || 0).toFixed(2)}`, 196, doc.internal.pageSize.height - 15, { align: 'right' });
        }
      });

      doc.save(`Invoice_${invoice.invoiceNumber}.pdf`);
    }

    window.undoInvoice = async function(invoiceId) {
      if (!confirm('Are you sure you want to undo this invoice? This will move all associated LRs back to the LR Report page and delete this invoice.')) {
        return;
      }

      try {
        const user = auth.currentUser;
        if (!user) {
          alert('Authentication error. Please log in again.');
          return;
        }

        const dataRoot = coreAccountId || user.uid;

        // 1. Get the invoice data
        const invoiceRef = ref(db, `users/${dataRoot}/invoices/${invoiceId}`);
        const invoiceSnap = await get(invoiceRef);
        if (!invoiceSnap.exists()) {
          throw new Error('Invoice not found. It may have already been deleted.');
        }
        const invoiceData = invoiceSnap.val();

        // 2. Prepare a multi-path update
        const updates = {};

        // 3. Revert each LR status
        if (invoiceData.lrEntries && invoiceData.lrEntries.length > 0) {
          invoiceData.lrEntries.forEach(lrId => {
            updates[`/users/${dataRoot}/lrReports/${lrId}/status`] = 'active';
            updates[`/users/${dataRoot}/lrReports/${lrId}/invoiceId`] = null; // Remove invoice link
          });
        }

        // 4. Delete the invoice
        updates[`/users/${dataRoot}/invoices/${invoiceId}`] = null;

        // 5. Adjust client's outstanding balance
        if (invoiceData.clientId && invoiceData.grandTotal) {
          const clientOutstandingRef = ref(db, `users/${dataRoot}/clients/${invoiceData.clientId}/outstanding`);
          // Use a transaction to safely decrement the outstanding balance
          await runTransaction(clientOutstandingRef, (currentValue) => {
            return (currentValue || 0) - invoiceData.grandTotal;
          });
        }

        // 6. Execute the atomic update for LRs and the invoice
        await update(ref(db), updates);

        alert('Invoice successfully undone. The LRs are now available for invoicing again.');
        window.location.reload(); // Reload the page to reflect the changes
      } catch (error) {
        console.error("Error undoing invoice:", error);
        alert(`Failed to undo invoice: ${error.message}`);
      }
    };

    window.logout = function() {
      const user = auth.currentUser;
      if (user) {
        signOut(auth).then(() => { window.location.href = "index.html"; });
      }
    }
  </script>
</body>
</html>
