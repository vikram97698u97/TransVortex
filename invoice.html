<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Generated Invoices</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <link rel="stylesheet" href="print-invoice.css" media="print">
  <style>
    body { padding: 0; margin: 0; background-color: #f8f9fa; }
    @media print {
      /* Hide everything except the printable area */
      body * {
        visibility: hidden;
      }
      /* Make the printable area and its children visible */
      #printableInvoiceDetail, #printableInvoiceDetail * {
        visibility: visible;
      }
      /* Position the printable area to fill the page */
      #printableInvoiceDetail {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        margin: 0;
        padding: 0;
      }
      /* Hide the modal's footer when printing */
      .modal-footer {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <script src="navbar-loader.js"></script>

  <div class="container">
    <h2 class="mb-4"><i class="fas fa-file-invoice-dollar me-2"></i>Generated Invoices</h2>
    <div class="table-responsive">
      <table id="invoicesTable" class="table table-striped">
        <thead>
          <tr>
            <th>Invoice #</th>
            <th>Date</th>
            <th>Company Name</th>
            <th class="text-end">Total Amount</th>
            <th class="text-center">LRs</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody id="invoicesTableBody">
          <!-- Data will be populated here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Invoice Detail Modal -->
  <div class="modal fade" id="invoiceDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title">Invoice Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="printableInvoiceDetail">
          <!-- Content will be populated dynamically -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="printInvoiceDetail()">
            <i class="fas fa-print me-2"></i>Print
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, get, query, orderByChild, equalTo, update, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDAlk_K8p8Of8Ne6Jpcl2QqXTtm95NgG7o",
      authDomain: "transport-dashboard-ad69a.firebaseapp.com",
      databaseURL: "https://transport-dashboard-ad69a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "transport-dashboard-ad69a",
      storageBucket: "transport-dashboard-ad69a.appspot.com",
      messagingSenderId: "526889676196",
      appId: "1:526889676196:web:66032c80a4aede690ae531",
      measurementId: "G-7F9R7HJYDH"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let invoicesTable;

    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        initializePage(user);
      }
    });

    function initializePage(user) {
      invoicesTable = $('#invoicesTable').DataTable({
        order: [[1, 'desc']]
      });
      loadInvoices(user.uid);

      // Check for URL param to auto-show an invoice
      const urlParams = new URLSearchParams(window.location.search);
      const invoiceToView = urlParams.get('view');
      if (invoiceToView) {
        viewInvoice(invoiceToView);
      }
    }

    async function loadInvoices(userId) {
      const invoicesRef = query(ref(db, 'invoices'), orderByChild('userId'), equalTo(userId));
      const snapshot = await get(invoicesRef);

      invoicesTable.clear();
      if (snapshot.exists()) {
        const invoices = [];
        snapshot.forEach(child => {
          invoices.push({ id: child.key, ...child.val() });
        });
        invoices.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

        invoices.forEach(inv => {
          invoicesTable.row.add([
            inv.invoiceNumber,
            new Date(inv.createdAt).toLocaleDateString('en-IN'),
            inv.companyDetails.name,
            `<span class="text-end d-block">â‚¹${(inv.grandTotal || 0).toFixed(2)}</span>`,
            `<span class="badge bg-secondary">${inv.lrIds.length}</span>`,
            `<button class="btn btn-sm btn-outline-primary" onclick="viewInvoice('${inv.id}')">
              <i class="fas fa-eye"></i> View
            </button>
            <button class="btn btn-sm btn-outline-warning ms-1" onclick="undoInvoice('${inv.id}')" title="Undo Invoice">
              <i class="fas fa-undo"></i> Undo
            </button>`
          ]);
        });
      }
      invoicesTable.draw();
    }

    // Function to convert number to words (Indian Rupees)
    function numberToWords(num) {
      const a = ['', 'one ', 'two ', 'three ', 'four ', 'five ', 'six ', 'seven ', 'eight ', 'nine ', 'ten ', 'eleven ', 'twelve ', 'thirteen ', 'fourteen ', 'fifteen ', 'sixteen ', 'seventeen ', 'eighteen ', 'nineteen '];
      const b = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
      
      if ((num = Math.floor(num).toString()).length > 9) return 'overflow';
      const n = ('000000000' + num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
      if (!n) return '';
      
      let str = '';
      str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'crore ' : '';
      str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'lakh ' : '';
      str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'thousand ' : '';
      str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'hundred ' : '';
      str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) : '';
      
      return str.trim().replace(/\s+/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ') + ' Only';
    }

    window.viewInvoice = async function(invoiceId) {
      const modalBody = document.getElementById('printableInvoiceDetail');
      modalBody.innerHTML = '<div class="text-center p-5"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Loading invoice...</p></div>';
      $('#invoiceDetailModal').modal('show');

      try {
        const invoiceSnap = await get(ref(db, `invoices/${invoiceId}`));
        if (!invoiceSnap.exists()) {
          modalBody.innerHTML = '<p class="text-danger text-center">Invoice not found.</p>';
          return;
        }
        const invoice = invoiceSnap.val();

        // Fetch all associated LRs
        const lrPromises = invoice.lrIds.map(lrId => get(ref(db, `lrReports/${lrId}`)));
        const lrSnaps = await Promise.all(lrPromises);
        const lrs = lrSnaps.map(snap => snap.val()).filter(Boolean);

        // Build the invoice HTML
        const invoiceHtml = `
          <div class="p-4">
            <div class="row mb-4">
              <div class="col-12 text-center">
                <h2 class="mb-1 fw-bold text-success">${invoice.companyDetails.name || 'Transport Company'}</h2>
                <p class="mb-1 text-muted">${invoice.companyDetails.address || 'Company Address'}</p>
                <p class="mb-0 text-muted"><strong>GST:</strong> ${invoice.companyDetails.gst || 'N/A'}</p>
              </div>
            </div>
            <hr>
            <div class="row mb-4">
              <div class="col-sm-6">
                <h6 class="fw-bold">Bill To:</h6>
                <p class="mb-0">${invoice.clientDetails?.name || invoice.companyDetails.name}</p>
              </div>
              <div class="col-sm-6 text-sm-end mt-3 mt-sm-0">
                <h6 class="fw-bold">Invoice Details:</h6>
                <p class="mb-1"><strong>Invoice #:</strong> <span>${invoice.invoiceNumber}</span></p>
                <p class="mb-0"><strong>Date:</strong> <span>${new Date(invoice.createdAt).toLocaleDateString('en-IN')}</span></p>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-bordered">
                <thead class="table-light">
                  <tr>
                    <th>Date</th><th>LR No</th><th>Truck No</th><th>Consignor</th><th>Consignee</th><th>From</th><th>To</th><th class="text-end">Weight</th><th class="text-end">Amount</th>
                  </tr>
                </thead>
                <tbody>
                  ${lrs.map(lr => `
                    <tr>
                      <td>${lr.date}</td>
                      <td>${lr.lrNumber}</td>
                      <td>${lr.truckNumber}</td>
                      <td>${lr.consignor}</td>
                      <td>${lr.consignee}</td>
                      <td>${lr.fromLocation}</td>
                      <td>${lr.toLocation}</td>
                      <td class="text-end">${(lr.weight || 0).toFixed(2)}</td>
                      <td class="text-end">â‚¹${(lr.billingAmount || 0).toFixed(2)}</td>
                    </tr>
                  `).join('')}
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="7" rowspan="4" class="align-bottom">
                      <p class="mb-1"><strong>Bank Details:</strong></p>
                      <p class="mb-1 small">Bank: <span>${invoice.bankDetails.bankName}</span></p>
                      <p class="mb-1 small">A/C No: <span>${invoice.bankDetails.accountNumber}</span></p>
                      <p class="mb-1 small">Holder: <span>${invoice.bankDetails.accountHolder}</span></p>
                      <p class="mb-0 small">IFSC: <span>${invoice.bankDetails.ifsc}</span></p>
                      <div class="mt-3">
                        <p class="mb-1"><strong>Amount in Words:</strong></p>
                        <p class="mb-0 small">${numberToWords(invoice.grandTotal || 0)}</p>
                      </div>
                    </td>
                    <td class="text-end"><strong>Subtotal:</strong></td>
                    <td class="text-end fw-bold">â‚¹${(invoice.subtotal || 0).toFixed(2)}</td>
                  </tr>
                  <tr>
                    <td class="text-end"><strong>CGST:</strong></td>
                    <td class="text-end fw-bold">â‚¹${(invoice.cgstAmount || 0).toFixed(2)}</td>
                  </tr>
                  <tr>
                    <td class="text-end"><strong>SGST:</strong></td>
                    <td class="text-end fw-bold">â‚¹${(invoice.sgstAmount || 0).toFixed(2)}</td>
                  </tr>
                  <tr class="table-success">
                    <td class="text-end"><strong>Grand Total:</strong></td>
                    <td class="text-end fw-bold fs-5">â‚¹${(invoice.grandTotal || 0).toFixed(2)}</td>
                  </tr>
                </tfoot>
              </table>
            </div>
            <div class="row mt-4">
              <div class="col-md-6">
                <p class="small text-muted">This is a computer-generated invoice.</p>
              </div>
              <div class="col-md-6 text-end">
                <div class="mt-5">
                  <p class="mb-4">For ${invoice.companyDetails.name}</p>
                  <p class="mb-0">___________________</p>
                  <p class="mb-0">Authorized Signatory</p>
                </div>
              </div>
            </div>
          </div>
        `;
        modalBody.innerHTML = invoiceHtml;
      } catch (error) {
        console.error("Error viewing invoice:", error);
        modalBody.innerHTML = '<p class="text-danger text-center">Could not load invoice details.</p>';
      }
    }

    window.printInvoiceDetail = function() {
      window.print();
    }

    window.undoInvoice = async function(invoiceId) {
      if (!confirm('Are you sure you want to undo this invoice? This will move all associated LRs back to the LR Report page and delete this invoice.')) {
        return;
      }

      try {
        const user = auth.currentUser;
        if (!user) {
          alert('Authentication error. Please log in again.');
          return;
        }

        // 1. Get the invoice data
        const invoiceRef = ref(db, `invoices/${invoiceId}`);
        const invoiceSnap = await get(invoiceRef);
        if (!invoiceSnap.exists()) {
          throw new Error('Invoice not found. It may have already been deleted.');
        }
        const invoiceData = invoiceSnap.val();

        // 2. Prepare a multi-path update
        const updates = {};

        // 3. Revert each LR status
        if (invoiceData.lrIds && invoiceData.lrIds.length > 0) {
          invoiceData.lrIds.forEach(lrId => {
            updates[`/lrReports/${lrId}/status`] = 'active';
            updates[`/lrReports/${lrId}/invoiceId`] = null; // Remove invoice link
          });
        }

        // 4. Delete the invoice
        updates[`/invoices/${invoiceId}`] = null;

        // 5. Adjust client's outstanding balance
        if (invoiceData.clientId && invoiceData.grandTotal) {
          const clientOutstandingRef = ref(db, `users/${user.uid}/clients/${invoiceData.clientId}/outstanding`);
          // Use a transaction to safely decrement the outstanding balance
          await runTransaction(clientOutstandingRef, (currentValue) => {
            return (currentValue || 0) - invoiceData.grandTotal;
          });
        }

        // 6. Execute the atomic update for LRs and the invoice
        await update(ref(db), updates);

        alert('Invoice successfully undone. The LRs are now available for invoicing again.');
        window.location.reload(); // Reload the page to reflect the changes
      } catch (error) {
        console.error("Error undoing invoice:", error);
        alert(`Failed to undo invoice: ${error.message}`);
      }
    };

    window.logout = function() {
      const user = auth.currentUser;
      if (user) {
        signOut(auth).then(() => { window.location.href = "index.html"; });
      }
    }
  </script>
</body>
</html>
