<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Client Management - Transport System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { padding: 0; margin: 0; background-color: #f8f9fa; }
    .main-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .hidden { display: none !important; }
    .form-section {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #dee2e6;
    }
    .list-group-item {
      border-color: #dee2e6;
    }
  </style>
</head>
<body>
  <!-- Navbar will be loaded here by navbar-loader.js -->
  <div id="navbar-placeholder"></div>

  <!-- Main Content -->
  <div class="container mt-4">
    <div class="main-content" id="clientListView">
      <h2 class="mb-4"><i class="fas fa-users me-2"></i>Client / Consignor Management</h2>

    <!-- Add Client Form -->
    <form id="clientForm" class="form-section">
      <h4 class="mb-3">Add New Client</h4>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="clientName" class="form-label">Client Name <span class="text-danger">*</span></label>
          <input type="text" id="clientName" class="form-control" placeholder="Client Name" required>
        </div>
        <div class="col-md-6 mb-3">
          <label for="contactPerson" class="form-label">Contact Person <span class="text-danger">*</span></label>
          <input type="text" id="contactPerson" class="form-control" placeholder="Contact Person" required>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="mobile" class="form-label">Mobile Number <span class="text-danger">*</span></label>
          <input type="tel" id="mobile" class="form-control" placeholder="Mobile Number" required>
        </div>
        <div class="col-md-6 mb-3">
          <label for="email" class="form-label">Email</label>
          <input type="email" id="email" class="form-control" placeholder="Email">
        </div>
      </div>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="gstin" class="form-label">GSTIN</label>
          <input type="text" id="gstin" class="form-control" placeholder="GSTIN">
        </div>
        <div class="col-md-6 mb-3">
          <label for="pan" class="form-label">PAN</label>
          <input type="text" id="pan" class="form-control" placeholder="PAN">
        </div>
      </div>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="billingAddress" class="form-label">Billing Address</label>
          <textarea id="billingAddress" class="form-control" placeholder="Billing Address"></textarea>
        </div>
        <div class="col-md-6 mb-3">
          <label for="dispatchAddress" class="form-label">Dispatch Address</label>
          <textarea id="dispatchAddress" class="form-control" placeholder="Dispatch Address"></textarea>
        </div>
      </div>
      <button type="submit" class="btn btn-primary"><i class="fas fa-plus me-2"></i>Add Client</button>
    </form>

    <!-- Search + Export -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4>Client List</h4>
      <button id="exportExcel" class="btn btn-success"><i class="fas fa-file-excel me-2"></i>Export Excel</button>
    </div>

    <!-- Client List -->
    <div class="table-responsive">
      <table id="clientTable" class="table table-striped table-bordered" style="width:100%">
        <thead>
          <tr>
            <th>Name</th>
            <th>GSTIN</th>
            <th>Contact</th>
            <th class="text-end">Outstanding</th>
            <th class="text-center">Total Trips</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody id="clientTableBody"></tbody>
      </table>
    </div>
  </div>

    <!-- Client Detail View -->
    <div id="clientDetail" class="main-content hidden">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 id="clientTitle" class="mb-0">Client Details</h2>
        <button class="btn btn-secondary" id="backBtn"><i class="fas fa-arrow-left me-2"></i>Back to List</button>
      </div>

      <div class="card mb-4">
        <div class="card-body">
          <div class="row">
            <div class="col-md-4"><strong>Contact:</strong> <span id="clientContact"></span></div>
            <div class="col-md-4"><strong>GSTIN:</strong> <span id="clientGSTIN"></span></div>
            <div class="col-md-4"><strong>PAN:</strong> <span id="clientPAN"></span></div>
          </div>
          <hr>
          <div class="row">
            <div class="col-md-4"><strong>Outstanding:</strong> <span id="clientOutstanding" class="fw-bold text-danger"></span></div>
            <div class="col-md-4"><strong>Total Trips:</strong> <span id="clientTrips" class="fw-bold"></span></div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4">
          <div class="card">
            <div class="card-header bg-primary text-white"><h5><i class="fas fa-file-invoice me-2"></i>Invoices</h5></div>
            <ul id="invoiceList" class="list-group list-group-flush"></ul>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-header bg-info text-white"><h5><i class="fas fa-receipt me-2"></i>LR Reports</h5></div>
            <ul id="lrList" class="list-group list-group-flush"></ul>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-header bg-success text-white"><h5><i class="fas fa-money-bill-wave me-2"></i>Payments</h5></div>
            <ul id="paymentList" class="list-group list-group-flush"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="navbar-loader.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, push, onValue, update, remove, query, orderByChild, equalTo, get } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Config
    const firebaseConfig = {
      apiKey: "AIzaSyDAlk_K8p8Of8Ne6Jpcl2QqXTtm95NgG7o",
      authDomain: "transport-dashboard-ad69a.firebaseapp.com",
      databaseURL: "https://transport-dashboard-ad69a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "transport-dashboard-ad69a",
      storageBucket: "transport-dashboard-ad69a.appspot.com",
      messagingSenderId: "526889676196",
      appId: "1:526889676196:web:66032c80a4aede690ae531",
      measurementId: "G-7F9R7HJYDH"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let clientTable;
    let currentUser = null;

    // Auth Check
    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        currentUser = user;
        clientTable = $('#clientTable').DataTable({
          "pageLength": 10,
          "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
          "columnDefs": [{ "orderable": false, "targets": 5 }]
        });
        loadClients(user.uid);
      }
    });

    // Add Client
    document.getElementById("clientForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) return;

      const newClientName = document.getElementById("clientName").value.trim();
      if (!newClientName) {
        alert('Client name cannot be empty.');
        return;
      }

      // Check for duplicates before saving
      const clientRef = ref(db, `users/${currentUser.uid}/clients`);
      const snapshot = await get(clientRef);
      let isDuplicate = false;
      if (snapshot.exists()) {
        snapshot.forEach(childSnapshot => {
          const client = childSnapshot.val();
          if (client.clientName && client.clientName.toLowerCase() === newClientName.toLowerCase()) {
            isDuplicate = true;
          }
        });
      }

      if (isDuplicate) {
        alert('A client with this name already exists. Please use a different name.');
        return; // Stop the function if a duplicate is found
      }

      // If not a duplicate, proceed to save
      const now = new Date().toISOString();
      const clientData = {
        clientName: newClientName, // Use the trimmed name
        gstin: document.getElementById("gstin").value,
        pan: document.getElementById("pan").value,
        contactPerson: document.getElementById("contactPerson").value,
        mobile: document.getElementById("mobile").value,
        email: document.getElementById("email").value,
        billingAddress: document.getElementById("billingAddress").value,
        dispatchAddress: document.getElementById("dispatchAddress").value,
        outstanding: 0,
        totalTrips: 0,
        createdAt: now,
        updatedAt: now
      };

      push(ref(db, `users/${currentUser.uid}/clients`), clientData)
        .then(() => {
          e.target.reset();
          alert('Client added successfully!');
        })
        .catch((error) => {
          alert('Error adding client: ' + error.message);
        });
    });

    // Load Clients
    function loadClients(uid) {
      const clientRef = ref(db, "users/" + uid + "/clients");
      onValue(clientRef, (snapshot) => {
        clientTable.clear();
        snapshot.forEach(child => {
          const client = child.val();
          clientTable.row.add([
            client.clientName,
            client.gstin || "-",
            client.mobile,
            `₹${(client.outstanding || 0).toFixed(2)}`,
            client.totalTrips || 0,
            `<div class="text-center">
              <button class="btn btn-sm btn-outline-primary me-1" onclick="viewClient('${child.key}')"><i class="fas fa-eye"></i></button>
              <button class="btn btn-sm btn-outline-secondary me-1" onclick="editClient('${child.key}')"><i class="fas fa-edit"></i></button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteClient('${child.key}')"><i class="fas fa-trash"></i></button>
            </div>`
          ]).node().id = `client-row-${child.key}`;
        });
        clientTable.draw();
      });
    }

    // View Client
    window.viewClient = (id) => {
      document.getElementById("clientDetail").classList.remove("hidden");
      document.getElementById("clientListView").classList.add("hidden");

      const clientRef = ref(db, "users/" + currentUser.uid + "/clients/" + id);
      get(clientRef).then((snapshot) => {
        const c = snapshot.val();
        document.getElementById("clientTitle").textContent = c.clientName;
        document.getElementById("clientContact").textContent = c.contactPerson + " (" + c.mobile + ")";
        document.getElementById("clientGSTIN").textContent = c.gstin || "-";
        document.getElementById("clientPAN").textContent = c.pan || "-";
        document.getElementById("clientOutstanding").textContent = `₹${(c.outstanding || 0).toFixed(2)}`;
        document.getElementById("clientTrips").textContent = c.totalTrips || 0;
      });

      // Load linked data
      loadLinkedData(id);
    };

    function loadLinkedData(clientId) {
      const invoiceRef = query(ref(db, "invoices"), orderByChild('clientId'), equalTo(clientId));
      onValue(invoiceRef, (snapshot) => {
        const list = document.getElementById("invoiceList");
        list.innerHTML = "";
        snapshot.forEach(child => {
          const inv = child.val();
          list.innerHTML += `<li class="list-group-item">#${inv.invoiceNumber} - ₹${(inv.grandTotal || 0).toFixed(2)}</li>`;
        });
        if (!list.innerHTML) list.innerHTML = '<li class="list-group-item text-muted">No invoices found.</li>';
      });

      const lrRef = query(ref(db, "lrReports"), orderByChild('clientId'), equalTo(clientId));
      onValue(lrRef, (snapshot) => {
        const list = document.getElementById("lrList");
        list.innerHTML = "";
        snapshot.forEach(child => {
          const lr = child.val();
          list.innerHTML += `<li class="list-group-item">#${lr.lrNumber || 'N/A'} - ${lr.fromLocation || ''} → ${lr.toLocation || ''}</li>`;
        });
        if (!list.innerHTML) list.innerHTML = '<li class="list-group-item text-muted">No LR reports found.</li>';
      });

      const payRef = query(ref(db, "payments"), orderByChild('clientId'), equalTo(clientId));
      onValue(payRef, (snapshot) => {
        const list = document.getElementById("paymentList");
        list.innerHTML = "";
        snapshot.forEach(child => {
          const pay = child.val();
          list.innerHTML += `<li class="list-group-item">₹${parseFloat(pay.amount || 0).toFixed(2)} on ${pay.date || 'N/A'}</li>`;
        });
        if (!list.innerHTML) list.innerHTML = '<li class="list-group-item text-muted">No payments found.</li>';
      });
    }

    // Back button
    document.getElementById("backBtn").addEventListener("click", () => {
      document.getElementById("clientDetail").classList.add("hidden");
      document.getElementById("clientListView").classList.remove("hidden");
    });

    // Edit Client
    window.editClient = (id) => {
      const newName = prompt("Enter new name:");
      if (newName) {
        update(ref(db, "users/" + currentUser.uid + "/clients/" + id), { 
          clientName: newName,
          updatedAt: new Date().toISOString()
        });
      }
    };

    // Delete Client
    window.deleteClient = (id) => {
      if (confirm("Are you sure you want to delete this client? This action cannot be undone.")) {
        remove(ref(db, "users/" + currentUser.uid + "/clients/" + id));
      }
    };

    // Export to Excel
    document.getElementById("exportExcel").addEventListener("click", () => {
      const table = document.getElementById("clientTable");
      const wb = XLSX.utils.table_to_book(table, { sheet: "Clients" });
      XLSX.writeFile(wb, "Clients.xlsx");
    });

    // Make functions globally accessible for onclick attributes
    window.viewClient = viewClient;
    window.editClient = editClient;
    window.deleteClient = deleteClient;
  </script>
</body>
</html>
