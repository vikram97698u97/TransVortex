<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Client Management - Transport System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { padding: 0; margin: 0; background-color: #f8f9fa; }
    .main-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .hidden { display: none !important; }
    .form-section {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #dee2e6;
    }
    .list-group-item {
      border-color: #dee2e6;
    }
    .nav-tabs .nav-link.active {
      background-color: #0d6efd;
      color: white;
    }
    .action-btns button {
      margin-right: 5px;
    }
    
    /* Modern Card Styles */
    .modern-card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      overflow: hidden;
    }
    .modern-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }
    .modern-card .card-header {
      border-bottom: 1px solid rgba(0,0,0,0.05);
      font-weight: 600;
      padding: 15px 20px;
    }
    .modern-card .list-group-item {
      border: none;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      padding: 12px 20px;
      transition: background-color 0.2s;
    }
    .modern-card .list-group-item:last-child {
      border-bottom: none;
    }
    .modern-card .list-group-item:hover {
      background-color: rgba(0,0,0,0.02);
    }
    
    /* Status badges */
    .status-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .status-paid {
      background-color: #d4edda;
      color: #155724;
    }
    .status-pending {
      background-color: #fff3cd;
      color: #856404;
    }
    .status-overdue {
      background-color: #f8d7da;
      color: #721c24;
    }
    
    /* Payment progress */
    .payment-progress {
      height: 8px;
      border-radius: 4px;
      background-color: #e9ecef;
      overflow: hidden;
      margin: 10px 0;
    }
    .payment-progress-bar {
      height: 100%;
      border-radius: 4px;
    }
    
    /* Enhanced table styling */
    .table-modern {
      border-collapse: separate;
      border-spacing: 0;
      border-radius: 8px;
      overflow: hidden;
    }
    .table-modern thead th {
      background-color: #f8f9fa;
      border-bottom: 2px solid #dee2e6;
      font-weight: 600;
      padding: 12px 15px;
    }
    .table-modern tbody td {
      padding: 12px 15px;
      vertical-align: middle;
    }
    
    /* LR Detail Modal */
    .lr-detail-modal .modal-content {
      border-radius: 12px;
      border: none;
    }
    .lr-detail-modal .modal-header {
      background-color: #0d6efd;
      color: white;
      border-bottom: none;
      border-radius: 12px 12px 0 0;
    }
    .lr-detail-modal .detail-row {
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }
    .lr-detail-modal .detail-row:last-child {
      border-bottom: none;
    }
  </style>
</head>
<body>
  <!-- Navbar will be loaded here by navbar-loader.js -->
  <div id="navbar-placeholder"></div>

  <!-- Main Content -->
  <div class="container mt-4">
    <div class="main-content" id="clientListView">
      <h2 class="mb-4"><i class="fas fa-users me-2"></i>Client Management</h2>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-3" id="clientTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="clients-tab" data-bs-toggle="tab" data-bs-target="#clients-content" type="button" role="tab">Clients</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payments-content" type="button" role="tab">Client Payments</button>
      </li>
    </ul>

    <div class="tab-content" id="clientTabsContent">
      <div class="tab-pane fade show active" id="clients-content" role="tabpanel">

    <!-- Add Client Form -->
    <form id="clientForm" class="form-section">
      <h4 class="mb-3">Add New Client</h4>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="clientName" class="form-label">Client Name <span class="text-danger">*</span></label>
          <input type="text" id="clientName" class="form-control" placeholder="Client Name" required>
        </div>
        <div class="col-md-6 mb-3">
          <label for="contactPerson" class="form-label">Contact Person <span class="text-danger">*</span></label>
          <input type="text" id="contactPerson" class="form-control" placeholder="Contact Person" required>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="mobile" class="form-label">Mobile Number <span class="text-danger">*</span></label>
          <input type="tel" id="mobile" class="form-control" placeholder="Mobile Number" required>
        </div>
        <div class="col-md-6 mb-3">
          <label for="email" class="form-label">Email</label>
          <input type="email" id="email" class="form-control" placeholder="Email">
        </div>
      </div>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="gstin" class="form-label">GSTIN</label>
          <input type="text" id="gstin" class="form-control" placeholder="GSTIN">
        </div>
        <div class="col-md-6 mb-3">
          <label for="pan" class="form-label">PAN</label>
          <input type="text" id="pan" class="form-control" placeholder="PAN">
        </div>
      </div>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="billingAddress" class="form-label">Billing Address</label>
          <textarea id="billingAddress" class="form-control" placeholder="Billing Address"></textarea>
        </div>
        <div class="col-md-6 mb-3">
          <label for="dispatchAddress" class="form-label">Dispatch Address</label>
          <textarea id="dispatchAddress" class="form-control" placeholder="Dispatch Address"></textarea>
        </div>
      </div>
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary"><i class="fas fa-plus me-2"></i>Add Client</button>
        <button type="button" id="cancelClientEditBtn" class="btn btn-secondary" style="display: none;"><i class="fas fa-times me-2"></i>Cancel Edit</button>
      </div>
    </form>

    <!-- Search + Export -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4>Client List</h4>
      <button id="exportExcel" class="btn btn-success"><i class="fas fa-file-excel me-2"></i>Export Excel</button>
    </div>

    <!-- Client List -->
    <div class="table-responsive">
      <table id="clientTable" class="table table-striped table-bordered table-modern" style="width:100%">
        <thead>
          <tr>
            <th>Name</th>
            <th>GSTIN</th>
            <th>Contact</th>
            <th class="text-end">Outstanding</th>
            <th class="text-center">Total Trips</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody id="clientTableBody"></tbody>
      </table>
    </div>
      </div>
      <div class="tab-pane fade" id="payments-content" role="tabpanel">
        <form id="paymentForm" class="form-section">
          <h4 class="mb-3">Add New Payment</h4>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="clientSelect">Select Client:</label>
              <select id="clientSelect" class="form-select" required>
                <option value="">Loading clients...</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label for="amount">Amount:</label>
              <input type="number" id="amount" class="form-control" required step="0.01" />
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="date">Date:</label>
              <input type="date" id="date" class="form-control" required />
            </div>
            <div class="col-md-6 mb-3">
              <label for="proofFile">Upload Proof:</label>
              <input type="file" id="proofFile" class="form-control" accept="image/*,application/pdf"/>
              <img id="preview" class="mt-2" style="display:none; max-width: 100px; border-radius: 6px;" />
            </div>
          </div>
          <div class="row">
            <div class="col-md-12 mb-3">
              <label for="paymentNotes">Notes:</label>
              <textarea id="paymentNotes" class="form-control" placeholder="Add any notes about this payment"></textarea>
            </div>
          </div>
          <button type="submit" class="btn btn-primary"><i class="fas fa-plus me-2"></i>Add Payment</button>
        </form>
        
        <div class="d-flex justify-content-between align-items-center mb-3 mt-4">
          <h4>Payment History</h4>
          <input type="text" id="paymentSearchInput" class="form-control w-auto" placeholder="Search by company..." />
        </div>
        
        <div class="table-responsive">
          <table id="paymentTable" class="table table-striped table-bordered table-modern" style="width:100%">
            <thead>
              <tr>
                <th>Company</th>
                <th>Amount</th>
                <th>Date</th>
                <th>Proof</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="paymentTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

    <!-- Client Detail View -->
    <div id="clientDetail" class="main-content hidden">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 id="clientTitle" class="mb-0">Client Details</h2>
        <button class="btn btn-secondary" id="backBtn"><i class="fas fa-arrow-left me-2"></i>Back to List</button>
      </div>

      <div class="card mb-4 modern-card">
        <div class="card-body">
          <div class="row">
            <div class="col-md-4"><strong>Contact:</strong> <span id="clientContact"></span></div>
            <div class="col-md-4"><strong>GSTIN:</strong> <span id="clientGSTIN"></span></div>
            <div class="col-md-4"><strong>PAN:</strong> <span id="clientPAN"></span></div>
          </div>
          <hr>
          <div class="row">
            <div class="col-md-4"><strong>Outstanding:</strong> <span id="clientOutstanding" class="fw-bold text-danger"></span></div>
            <div class="col-md-4"><strong>Total Trips:</strong> <span id="clientTrips" class="fw-bold"></span></div>
            <div class="col-md-4"><strong>Payment Status:</strong> <span id="paymentStatus" class="fw-bold"></span></div>
          </div>
          <div class="payment-progress mt-3">
            <div id="paymentProgressBar" class="payment-progress-bar bg-success" style="width: 0%"></div>
          </div>
          <div class="d-flex justify-content-between mt-1">
            <small class="text-muted">Paid: ₹<span id="paidAmount">0</span></small>
            <small class="text-muted">Total: ₹<span id="totalAmount">0</span></small>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4 mb-4">
          <div class="card modern-card h-100">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
              <h5 class="mb-0"><i class="fas fa-file-invoice me-2"></i>Invoices</h5>
              <span class="badge bg-light text-dark" id="invoiceCount">0</span>
            </div>
            <div class="card-body p-0">
              <ul id="invoiceList" class="list-group list-group-flush"></ul>
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-4">
          <div class="card modern-card h-100">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
              <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>LR Reports</h5>
              <span class="badge bg-light text-dark" id="lrCount">0</span>
            </div>
            <div class="card-body p-0">
              <ul id="lrList" class="list-group list-group-flush"></ul>
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-4">
          <div class="card modern-card h-100">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
              <h5 class="mb-0"><i class="fas fa-money-bill-wave me-2"></i>Payments</h5>
              <span class="badge bg-light text-dark" id="paymentCount">0</span>
            </div>
            <div class="card-body p-0">
              <ul id="paymentList" class="list-group list-group-flush"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- LR Detail Modal -->
  <div class="modal fade lr-detail-modal" id="lrDetailModal" tabindex="-1" aria-labelledby="lrDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="lrDetailModalLabel">LR Report Details</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="lrDetailContent">
          <!-- LR details will be loaded here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="navbar-loader.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, push, onValue, update, remove, query, orderByChild, equalTo, get, set } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Config
    const firebaseConfig = {
      apiKey: "AIzaSyDAlk_K8p8Of8Ne6Jpcl2QqXTtm95NgG7o",
      authDomain: "transport-dashboard-ad69a.firebaseapp.com",
      databaseURL: "https://transport-dashboard-ad69a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "transport-dashboard-ad69a",
      storageBucket: "transport-dashboard-ad69a.appspot.com",
      messagingSenderId: "526889676196",
      appId: "1:526889676196:web:66032c80a4aede690ae531",
      measurementId: "G-7F9R7HJYDH"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let clientTable;
    let currentUser = null;
    let paymentTable;
    let coreAccountId = null;
    let currentEditingClientId = null;
    let currentEditingPaymentId = null;
    let currentClientId = null;

    // Auth Check
    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        currentUser = user;
        // Determine the core account ID for data fetching
        const userProfileRef = ref(db, `users/${user.uid}`);
        get(userProfileRef).then(snapshot => {
          if (snapshot.exists()) {
            const userData = snapshot.val();
            coreAccountId = userData.coreAccountId || user.uid;
          } else {
            coreAccountId = user.uid; // Fallback
          }
          // Load clients after coreAccountId is determined
          loadClients(user.uid);
          loadClientsForPaymentDropdown(user.uid);
          loadClientPayments(user.uid);
        });
        
        // Initialize DataTables
        clientTable = $('#clientTable').DataTable({
          "pageLength": 10,
          "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
          "columnDefs": [{ "orderable": false, "targets": 5 }]
        });
        
        paymentTable = $('#paymentTable').DataTable({
          "pageLength": 10,
          "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
          "order": [[ 2, "desc" ]], // Sort by date descending
          "columnDefs": [{ "orderable": false, "targets": 5 }]
        });
      }
    });

    // Function to cancel client editing
    function cancelClientEdit() {
      currentEditingClientId = null;
      const form = document.getElementById("clientForm");
      form.reset();
      
      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.innerHTML = '<i class="fas fa-plus me-2"></i>Add Client';
      
      const cancelBtn = document.getElementById('cancelClientEditBtn');
      if (cancelBtn) {
        cancelBtn.style.display = 'none';
      }
    }

    // Add Client
    document.getElementById("clientForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) return;

      const newClientName = document.getElementById("clientName").value.trim();
      if (!newClientName) {
        alert('Client name cannot be empty.');
        return;
      }

      const clientData = {
        clientName: newClientName,
        gstin: document.getElementById("gstin").value,
        pan: document.getElementById("pan").value,
        contactPerson: document.getElementById("contactPerson").value,
        mobile: document.getElementById("mobile").value,
        email: document.getElementById("email").value,
        billingAddress: document.getElementById("billingAddress").value,
        dispatchAddress: document.getElementById("dispatchAddress").value,
        updatedAt: new Date().toISOString()
      };

      if (currentEditingClientId) {
        // Update existing client
        const clientRef = ref(db, `users/${currentUser.uid}/clients/${currentEditingClientId}`);
        update(clientRef, clientData)
          .then(() => {
            alert('Client updated successfully!');
            cancelClientEdit();
          })
          .catch((error) => {
            alert('Error updating client: ' + error.message);
          });
      } else {
        // Add new client
        // Check for duplicates before saving
        const clientRef = ref(db, `users/${currentUser.uid}/clients`);
        const snapshot = await get(clientRef);
        let isDuplicate = false;
        if (snapshot.exists()) {
          snapshot.forEach(childSnapshot => {
            const client = childSnapshot.val();
            if (client.clientName && client.clientName.toLowerCase() === newClientName.toLowerCase()) {
              isDuplicate = true;
            }
          });
        }

        if (isDuplicate) {
          alert('A client with this name already exists. Please use a different name.');
          return;
        }

        clientData.outstanding = 0;
        clientData.totalTrips = 0;
        clientData.createdAt = new Date().toISOString();

        push(clientRef, clientData)
          .then(() => {
            e.target.reset();
            alert('Client added successfully!');
          })
          .catch((error) => {
            alert('Error adding client: ' + error.message);
          });
      }
    });

    // --- CLIENT PAYMENT LOGIC ---

    // Load clients into the payment dropdown
    function loadClientsForPaymentDropdown(uid) {
        const clientRef = ref(db, `users/${uid}/clients`);
        onValue(clientRef, (snapshot) => {
            const select = document.getElementById('clientSelect');
            select.innerHTML = '<option value="">Select a Client</option>';
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    const client = child.val();
                    const option = document.createElement('option');
                    option.value = child.key;
                    option.textContent = `${client.clientName} (Outstanding: ₹${(client.outstanding || 0).toFixed(2)})`;
                    option.dataset.name = client.clientName;
                    select.appendChild(option);
                });
            } else {
                select.innerHTML = '<option value="">No clients found</option>';
            }
        });
    }

    // Handle image preview
    document.getElementById("proofFile").addEventListener("change", () => {
      const file = document.getElementById("proofFile").files[0];
      const preview = document.getElementById("preview");
      if (file && file.type.startsWith("image")) {
        const reader = new FileReader();
        reader.onload = () => {
          preview.src = reader.result;
          preview.style.display = "block";
        };
        reader.readAsDataURL(file);
      } else {
        preview.style.display = "none";
      }
    });

    // Cloudinary upload logic
    async function resizeImage(file, maxWidth = 800) {
      return new Promise((resolve) => {
        const img = document.createElement("img");
        const reader = new FileReader();
        reader.onload = (e) => { img.src = e.target.result; };
        img.onload = () => {
          const canvas = document.createElement("canvas");
          const scaleFactor = maxWidth / img.width;
          canvas.width = maxWidth;
          canvas.height = img.height * scaleFactor;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          canvas.toBlob((blob) => {
            resolve(new File([blob], file.name, { type: file.type }));
          }, 'image/jpeg', 0.85);
        };
        reader.readAsDataURL(file);
      });
    }

    async function uploadToCloudinary(file) {
      if (file.type.startsWith("image")) {
        file = await resizeImage(file, 800);
      }
      const url = `https://api.cloudinary.com/v1_1/doqapn15f/auto/upload`;
      const preset = "payment-billing";
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", preset);
      const res = await fetch(url, { method: "POST", body: formData });
      const data = await res.json();
      return data.secure_url;
    }

    // Handle adding a new payment
    document.getElementById("paymentForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const saveButton = e.target.querySelector('button[type="submit"]');
      let fileURL = "";
      const file = document.getElementById("proofFile").files[0];
      const clientSelect = document.getElementById("clientSelect");
      const selectedClientId = clientSelect.value;
      const selectedClientName = clientSelect.options[clientSelect.selectedIndex].dataset.name;
      const amount = parseFloat(document.getElementById("amount").value) || 0;
      const date = document.getElementById("date").value;
      const notes = document.getElementById("paymentNotes").value;
    
      if (!selectedClientId) {
          alert("Please select a client.");
          return;
      }
    
      saveButton.disabled = true;
      saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

      if (file) fileURL = await uploadToCloudinary(file);

      if (currentEditingPaymentId) {
        // Update logic
        const paymentRef = ref(db, `payments/${currentEditingPaymentId}`);
        const oldPaymentSnap = await get(paymentRef);
        const oldPayment = oldPaymentSnap.val();
        const amountDifference = amount - (oldPayment.amount || 0);

        const updates = {};
        updates[`/payments/${currentEditingPaymentId}/amount`] = amount;
        updates[`/payments/${currentEditingPaymentId}/date`] = date;
        updates[`/payments/${currentEditingPaymentId}/companyName`] = selectedClientName;
        updates[`/payments/${currentEditingPaymentId}/clientId`] = selectedClientId;
        updates[`/payments/${currentEditingPaymentId}/notes`] = notes;
        if (file) updates[`/payments/${currentEditingPaymentId}/proof`] = fileURL;

        // Adjust outstanding balance
        const clientRef = ref(db, `users/${currentUser.uid}/clients/${selectedClientId}/outstanding`);
        const snapshot = await get(clientRef);
        const currentOutstanding = snapshot.val() || 0;
        updates[`/users/${currentUser.uid}/clients/${selectedClientId}/outstanding`] = currentOutstanding - amountDifference;

        await update(ref(db), updates);
        alert('Payment updated successfully!');
        currentEditingPaymentId = null;
        saveButton.innerHTML = '<i class="fas fa-plus me-2"></i>Add Payment';
        
        // Refresh payment status if we're viewing this client
        if (currentClientId === selectedClientId) {
          updatePaymentStatus(selectedClientId);
        }
      } else {
        // Add new logic
        const paymentRef = push(ref(db, `payments`));
        const paymentData = { 
          companyName: selectedClientName, 
          amount, 
          date, 
          proof: fileURL, 
          notes,
          id: paymentRef.key, 
          clientId: selectedClientId, 
          userId: currentUser.uid, 
          createdAt: new Date().toISOString(),
          status: 'completed'
        };
        await set(paymentRef, paymentData);
        
        // Update client outstanding balance
        const clientRef = ref(db, `users/${currentUser.uid}/clients/${selectedClientId}/outstanding`);
        const snapshot = await get(clientRef);
        const currentOutstanding = snapshot.val() || 0;
        await set(clientRef, currentOutstanding - amount);
        
        // Update invoice/LR payment status
        await updateInvoiceAndLRStatus(selectedClientId, amount);
        
        alert('Payment added successfully!');
        
        // Refresh payment status if we're viewing this client
        if (currentClientId === selectedClientId) {
          updatePaymentStatus(selectedClientId);
        }
      }
      
      e.target.reset();
      document.getElementById("preview").style.display = "none";
      saveButton.disabled = false;
    });

    // Update invoice and LR status based on payment
    async function updateInvoiceAndLRStatus(clientId, paymentAmount) {
      const dataRoot = coreAccountId || currentUser.uid;
      
      // Get all invoices for this client
      const invoicesQuery = query(ref(db, `users/${dataRoot}/invoices`), orderByChild('clientId'), equalTo(clientId));
      const invoicesSnap = await get(invoicesQuery);
      
      let remainingAmount = paymentAmount;
      
      if (invoicesSnap.exists()) {
        // Sort invoices by date (oldest first)
        const invoices = [];
        invoicesSnap.forEach(child => {
          invoices.push({ key: child.key, ...child.val() });
        });
        
        invoices.sort((a, b) => new Date(a.createdAt || a.date) - new Date(b.createdAt || b.date));
        
        // Apply payment to invoices
        for (const invoice of invoices) {
          if (remainingAmount <= 0) break;
          
          const invoiceAmount = invoice.grandTotal || 0;
          const paidAmount = invoice.paidAmount || 0;
          const outstanding = invoiceAmount - paidAmount;
          
          if (outstanding > 0) {
            const paymentToApply = Math.min(remainingAmount, outstanding);
            const newPaidAmount = paidAmount + paymentToApply;
            const newStatus = newPaidAmount >= invoiceAmount ? 'paid' : 'partial';
            
            // Update invoice
            await update(ref(db, `users/${dataRoot}/invoices/${invoice.key}`), {
              paidAmount: newPaidAmount,
              paymentStatus: newStatus,
              lastPaymentDate: new Date().toISOString()
            });
            
            remainingAmount -= paymentToApply;
          }
        }
      }
      
      // If there's still remaining amount after paying invoices, apply to LRs
      if (remainingAmount > 0) {
        const lrsQuery = query(ref(db, `users/${dataRoot}/lrReports`), orderByChild('clientId'), equalTo(clientId));
        const lrsSnap = await get(lrsQuery);
        
        if (lrsSnap.exists()) {
          const lrs = [];
          lrsSnap.forEach(child => {
            lrs.push({ key: child.key, ...child.val() });
          });
          
          lrs.sort((a, b) => new Date(a.date) - new Date(b.date));
          
          for (const lr of lrs) {
            if (remainingAmount <= 0) break;
            
            const lrAmount = lr.totalAmount || 0;
            const paidAmount = lr.paidAmount || 0;
            const outstanding = lrAmount - paidAmount;
            
            if (outstanding > 0) {
              const paymentToApply = Math.min(remainingAmount, outstanding);
              const newPaidAmount = paidAmount + paymentToApply;
              const newStatus = newPaidAmount >= lrAmount ? 'paid' : 'partial';
              
              // Update LR
              await update(ref(db, `users/${dataRoot}/lrReports/${lr.key}`), {
                paidAmount: newPaidAmount,
                paymentStatus: newStatus,
                lastPaymentDate: new Date().toISOString()
              });
              
              remainingAmount -= paymentToApply;
            }
          }
        }
      }
    }

    // Load client payments into the DataTable
    function loadClientPayments(uid) {
      const paymentsQuery = query(ref(db, 'payments'), orderByChild('userId'), equalTo(uid));
      onValue(paymentsQuery, (snapshot) => {
        paymentTable.clear();
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const payment = child.val();
            if (!payment.plan) { // Filter out subscription payments
              const statusBadge = payment.status === 'completed' 
                ? '<span class="status-badge status-paid">Completed</span>'
                : '<span class="status-badge status-pending">Pending</span>';
                
              paymentTable.row.add([
                payment.companyName,
                `₹${(payment.amount || 0).toFixed(2)}`,
                payment.date,
                payment.proof ? `<a href="${payment.proof}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fas fa-eye me-1"></i>View</a>` : '—',
                statusBadge,
                `<div class="action-btns text-center">
                  <button class="btn btn-sm btn-outline-secondary me-1" onclick="editClientPayment('${child.key}')"><i class="fas fa-edit"></i></button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteClientPayment('${child.key}', '${payment.clientId}', ${payment.amount})"><i class="fas fa-trash"></i></button>
                 </div>`
              ]);
            }
          });
        }
        paymentTable.draw();
      });
    }

    // Edit Client Payment
    window.editClientPayment = async (paymentId) => {
      const paymentRef = ref(db, `payments/${paymentId}`);
      const snapshot = await get(paymentRef);
      if (!snapshot.exists()) {
        alert('Payment record not found.');
        return;
      }
      const payment = snapshot.val();
      currentEditingPaymentId = paymentId;

      document.getElementById('clientSelect').value = payment.clientId;
      document.getElementById('amount').value = payment.amount;
      document.getElementById('date').value = payment.date;
      document.getElementById('paymentNotes').value = payment.notes || '';
      const preview = document.getElementById('preview');
      preview.src = payment.proof || '';
      preview.style.display = payment.proof ? 'block' : 'none';

      document.querySelector('#paymentForm button[type="submit"]').innerHTML = '<i class="fas fa-save me-2"></i>Update Payment';
      document.getElementById('paymentForm').scrollIntoView({ behavior: 'smooth' });
    };

    // Delete Client Payment
    window.deleteClientPayment = async (paymentId, clientId, amount) => {
      if (!confirm("Are you sure you want to delete this payment? This will update the client's outstanding balance.")) {
        return;
      }
      
      try {
        const paymentRef = ref(db, `payments/${paymentId}`);
        
        // Get payment details before deleting
        const paymentSnap = await get(paymentRef);
        const payment = paymentSnap.val();
        
        // Delete the payment
        await remove(paymentRef);
        
        // Update client's outstanding balance by adding back the payment amount
        const clientRef = ref(db, `users/${currentUser.uid}/clients/${clientId}/outstanding`);
        const clientSnap = await get(clientRef);
        const currentOutstanding = clientSnap.val() || 0;
        await set(clientRef, currentOutstanding + amount);
        
        // Update invoice/LR status by removing this payment
        await reversePaymentFromInvoicesAndLRs(clientId, amount);
        
        alert('Payment deleted successfully!');
        
        // Refresh payment status if we're viewing this client
        if (currentClientId === clientId) {
          updatePaymentStatus(clientId);
        }
      } catch (error) {
        console.error("Error deleting payment:", error);
        alert("Failed to delete payment. Please try again.");
      }
    };

    // Reverse payment from invoices and LRs
    async function reversePaymentFromInvoicesAndLRs(clientId, amount) {
      const dataRoot = coreAccountId || currentUser.uid;
      let remainingAmount = amount;
      
      // Get all invoices for this client (newest first for reversal)
      const invoicesQuery = query(ref(db, `users/${dataRoot}/invoices`), orderByChild('clientId'), equalTo(clientId));
      const invoicesSnap = await get(invoicesQuery);
      
      if (invoicesSnap.exists()) {
        const invoices = [];
        invoicesSnap.forEach(child => {
          invoices.push({ key: child.key, ...child.val() });
        });
        
        // Sort by date descending (newest first)
        invoices.sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date));
        
        // Reverse payment from invoices
        for (const invoice of invoices) {
          if (remainingAmount <= 0) break;
          
          const paidAmount = invoice.paidAmount || 0;
          if (paidAmount > 0) {
            const amountToReverse = Math.min(remainingAmount, paidAmount);
            const newPaidAmount = paidAmount - amountToReverse;
            const newStatus = newPaidAmount > 0 ? 'partial' : 'pending';
            
            // Update invoice
            await update(ref(db, `users/${dataRoot}/invoices/${invoice.key}`), {
              paidAmount: newPaidAmount,
              paymentStatus: newStatus
            });
            
            remainingAmount -= amountToReverse;
          }
        }
      }
      
      // If there's still remaining amount, reverse from LRs
      if (remainingAmount > 0) {
        const lrsQuery = query(ref(db, `users/${dataRoot}/lrReports`), orderByChild('clientId'), equalTo(clientId));
        const lrsSnap = await get(lrsQuery);
        
        if (lrsSnap.exists()) {
          const lrs = [];
          lrsSnap.forEach(child => {
            lrs.push({ key: child.key, ...child.val() });
          });
          
          // Sort by date descending (newest first)
          lrs.sort((a, b) => new Date(b.date) - new Date(a.date));
          
          // Reverse payment from LRs
          for (const lr of lrs) {
            if (remainingAmount <= 0) break;
            
            const paidAmount = lr.paidAmount || 0;
            if (paidAmount > 0) {
              const amountToReverse = Math.min(remainingAmount, paidAmount);
              const newPaidAmount = paidAmount - amountToReverse;
              const newStatus = newPaidAmount > 0 ? 'partial' : 'pending';
              
              // Update LR
              await update(ref(db, `users/${dataRoot}/lrReports/${lr.key}`), {
                paidAmount: newPaidAmount,
                paymentStatus: newStatus
              });
              
              remainingAmount -= amountToReverse;
            }
          }
        }
      }
    }

    // Load Clients
    function loadClients(uid) {
      const clientsRef = ref(db, `users/${uid}/clients`);
      
      // Use coreAccountId to fetch shared data like LRs and invoices
      const dataRoot = coreAccountId || uid;
      const invoicesRef = ref(db, `users/${dataRoot}/invoices`);
      const lrsRef = ref(db, `users/${dataRoot}/lrReports`);
      const paymentsQuery = query(ref(db, 'payments'), orderByChild('userId'), equalTo(uid));

      // Use onValue to listen for real-time updates
      onValue(clientsRef, async (clientSnap) => {
        if (!clientSnap.exists()) {
          clientTable.clear().draw();
          return;
        }

        const [invoiceSnap, lrSnap, paymentSnap] = await Promise.all([get(invoicesRef), get(lrsRef), get(paymentsQuery)]);
        const invoicesByClient = {};
        const lrsByClient = {};
        const paymentsByClient = {};

        if (invoiceSnap.exists()) {
          invoiceSnap.forEach(child => {
            const inv = child.val();
            if (!invoicesByClient[inv.clientId]) invoicesByClient[inv.clientId] = [];
            invoicesByClient[inv.clientId].push(inv);
          });
        }

        if (lrSnap.exists()) {
          lrSnap.forEach(child => {
            const lr = child.val();
            if (!lrsByClient[lr.clientId]) lrsByClient[lr.clientId] = [];
            lrsByClient[lr.clientId].push(lr);
          });
        }

        if (paymentSnap.exists()) {
          paymentSnap.forEach(child => {
            const payment = child.val();
            if (!payment.plan) { // Filter out subscription payments
              if (!paymentsByClient[payment.clientId]) paymentsByClient[payment.clientId] = [];
              paymentsByClient[payment.clientId].push(payment);
            }
          });
        }

        clientTable.clear();
        clientSnap.forEach(child => {
          const client = child.val();
          const clientId = child.key;
          const invoices = invoicesByClient[clientId] || [];
          const lrs = lrsByClient[clientId] || [];
          const payments = paymentsByClient[clientId] || [];
          
          // **FIX**: Calculate total billed from invoices and total paid from payments.
          let totalAmount = 0;
          let paidAmount = 0;
          
          // Sum total billed from all invoices for the client.
          invoices.forEach(inv => { totalAmount += inv.grandTotal || 0; });
          // **FIX**: Sum total paid from all payments made by the client.
          payments.forEach(p => {
            paidAmount += p.amount || 0;
          });
          
          // Calculate outstanding
          const outstanding = totalAmount - paidAmount;
          
          // Update client's outstanding in database if different
          if (client.outstanding !== outstanding) {
            update(ref(db, `users/${uid}/clients/${clientId}`), { outstanding });
          }

          clientTable.row.add([
            client.clientName,
            client.gstin || '—',
            client.mobile || '—',
            `<span class="fw-bold ${outstanding > 0 ? 'text-danger' : 'text-success'}">₹${outstanding.toFixed(2)}</span>`,
            `<span class="text-center d-block">${lrs.length}</span>`, // Trip count = total LRs
            `<div class="action-btns text-center">
              <button class="btn btn-sm btn-outline-primary me-1" onclick="viewClientDetails('${clientId}')"><i class="fas fa-eye me-1"></i>View</button>
              <button class="btn btn-sm btn-outline-secondary me-1" onclick="editClient('${clientId}')"><i class="fas fa-edit"></i></button>
            </div>`
          ]);
        });
        clientTable.draw();
      });
    }

    // Edit Client
    window.editClient = (clientId) => {
      const clientRef = ref(db, `users/${currentUser.uid}/clients/${clientId}`);
      get(clientRef).then(snapshot => {
        if (snapshot.exists()) {
          const client = snapshot.val();
          document.getElementById('clientName').value = client.clientName || '';
          document.getElementById('gstin').value = client.gstin || '';
          document.getElementById('pan').value = client.pan || '';
          document.getElementById('contactPerson').value = client.contactPerson || '';
          document.getElementById('mobile').value = client.mobile || '';
          document.getElementById('email').value = client.email || '';
          document.getElementById('billingAddress').value = client.billingAddress || '';
          document.getElementById('dispatchAddress').value = client.dispatchAddress || '';
          
          currentEditingClientId = clientId;
          
          const submitBtn = document.querySelector('#clientForm button[type="submit"]');
          submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Update Client';
          
          const cancelBtn = document.getElementById('cancelClientEditBtn');
          if (cancelBtn) {
            cancelBtn.style.display = 'inline-block';
          }
        }
      });
    };

    // Cancel client edit button
    document.getElementById('cancelClientEditBtn').addEventListener('click', cancelClientEdit);

    // View Client Details
    window.viewClientDetails = async (clientId) => {
      currentClientId = clientId;
      
      const clientRef = ref(db, `users/${currentUser.uid}/clients/${clientId}`);
      const clientSnap = await get(clientRef);
      
      if (!clientSnap.exists()) {
        alert('Client not found.');
        return;
      }
      
      const client = clientSnap.val();
      document.getElementById('clientTitle').textContent = client.clientName;
      document.getElementById('clientContact').textContent = client.mobile || '—';
      document.getElementById('clientGSTIN').textContent = client.gstin || '—';
      document.getElementById('clientPAN').textContent = client.pan || '—';
      document.getElementById('clientOutstanding').textContent = `₹${(client.outstanding || 0).toFixed(2)}`;
      
      // Use coreAccountId to fetch shared data
      const dataRoot = coreAccountId || currentUser.uid;
      const invoicesQuery = query(ref(db, `users/${dataRoot}/invoices`), orderByChild('clientId'), equalTo(clientId));
      const lrsQuery = query(ref(db, `users/${dataRoot}/lrReports`), orderByChild('clientId'), equalTo(clientId));
      const paymentsQuery = query(ref(db, 'payments'), orderByChild('clientId'), equalTo(clientId));
      
      const [invoicesSnap, lrsSnap, paymentsSnap] = await Promise.all([
        get(invoicesQuery),
        get(lrsQuery),
        get(paymentsQuery)
      ]);
      
      // Update trip count (total LRs)
      document.getElementById('clientTrips').textContent = lrsSnap.exists() ? lrsSnap.size : 0;
      
      // Calculate payment statistics
      await updatePaymentStatus(clientId, invoicesSnap, lrsSnap, paymentsSnap);
      
      // Process invoices
      const invoiceList = document.getElementById('invoiceList');
      invoiceList.innerHTML = '';
      if (invoicesSnap.exists()) {
        invoicesSnap.forEach(child => {
          const invoice = child.val();
          const status = invoice.paymentStatus || 'pending';
          const statusClass = status === 'paid' ? 'status-paid' : 
                            status === 'partial' ? 'status-pending' : 'status-overdue';
          
          const listItem = document.createElement('li');
          listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
          listItem.innerHTML = `
            <div>
              <div class="fw-bold">${invoice.invoiceNumber || 'N/A'}</div>
              <small class="text-muted">₹${(invoice.grandTotal || 0).toFixed(2)}</small>
            </div>
            <div>
              <span class="status-badge ${statusClass} me-2">${status}</span>
              <button class="btn btn-sm btn-outline-primary" onclick="viewInvoice('${child.key}')">
                <i class="fas fa-eye"></i>
              </button>
            </div>
          `;
          invoiceList.appendChild(listItem);
        });
      } else {
        invoiceList.innerHTML = '<li class="list-group-item text-center text-muted">No invoices found</li>';
      }
      document.getElementById('invoiceCount').textContent = invoicesSnap.exists() ? invoicesSnap.size : 0;
      
      // Process LR reports
      const lrList = document.getElementById('lrList');
      lrList.innerHTML = '';
      if (lrsSnap.exists()) {
        lrsSnap.forEach(child => {
          const lr = child.val();
          const status = lr.paymentStatus || 'pending';
          const statusClass = status === 'paid' ? 'status-paid' : 
                            status === 'partial' ? 'status-pending' : 'status-overdue';
          
          const listItem = document.createElement('li');
          listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
          listItem.innerHTML = `
            <div>
              <div class="fw-bold">${lr.lrNumber || 'N/A'}</div>
              <small class="text-muted">₹${(lr.totalAmount || 0).toFixed(2)}</small>
            </div>
            <div>
              <span class="status-badge ${statusClass} me-2">${status}</span>
              <button class="btn btn-sm btn-outline-primary" onclick="viewLRDetails('${child.key}')">
                <i class="fas fa-eye"></i>
              </button>
            </div>
          `;
          lrList.appendChild(listItem);
        });
      } else {
        lrList.innerHTML = '<li class="list-group-item text-center text-muted">No LR reports found</li>';
      }
      document.getElementById('lrCount').textContent = lrsSnap.exists() ? lrsSnap.size : 0;
      
      // Process payments
      const paymentList = document.getElementById('paymentList');
      paymentList.innerHTML = '';
      if (paymentsSnap.exists()) {
        paymentsSnap.forEach(child => {
          const payment = child.val();
          if (!payment.plan) { // Filter out subscription payments
            const listItem = document.createElement('li');
            listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
            listItem.innerHTML = `
              <div>
                <div class="fw-bold">${payment.date || 'N/A'}</div>
                <small class="text-muted">${payment.notes || 'Payment'}</small>
              </div>
              <span class="fw-bold text-success">₹${(payment.amount || 0).toFixed(2)}</span>
            `;
            paymentList.appendChild(listItem);
          }
        });
      } else {
        paymentList.innerHTML = '<li class="list-group-item text-center text-muted">No payments found</li>';
      }
      document.getElementById('paymentCount').textContent = paymentsSnap.exists() ? paymentsSnap.size : 0;
      
      // Show the detail view
      document.getElementById('clientListView').classList.add('hidden');
      document.getElementById('clientDetail').classList.remove('hidden');
    };

    // Update payment status and progress bar
    async function updatePaymentStatus(clientId, invoicesSnap = null, lrsSnap = null, paymentsSnap = null) {
      const dataRoot = coreAccountId || currentUser.uid;
      
      // Fetch data if not provided
      if (!invoicesSnap || !lrsSnap || !paymentsSnap) {
        const invoicesQuery = query(ref(db, `users/${dataRoot}/invoices`), orderByChild('clientId'), equalTo(clientId));
        const lrsQuery = query(ref(db, `users/${dataRoot}/lrReports`), orderByChild('clientId'), equalTo(clientId));
        const paymentsQuery = query(ref(db, 'payments'), orderByChild('clientId'), equalTo(clientId));
        
        [invoicesSnap, lrsSnap, paymentsSnap] = await Promise.all([
          get(invoicesQuery),
          get(lrsQuery),
          get(paymentsQuery)
        ]);
      }
      
      // **FIX**: Calculate total billed from invoices and total paid from payments.
      let totalAmount = 0;
      let paidAmount = 0;
      
      // Sum total billed from all invoices for the client.
      if (invoicesSnap.exists()) {
        invoicesSnap.forEach(child => {
          const invoice = child.val();
          totalAmount += invoice.grandTotal || 0;
        });
      }

      // **FIX**: Sum total paid from all payments made by the client.
      if (paymentsSnap.exists()) {
        paymentsSnap.forEach(child => { if (!child.val().plan) paidAmount += child.val().amount || 0; });
      }
      
      // Update payment progress
      const progressPercentage = totalAmount > 0 ? (paidAmount / totalAmount) * 100 : 0;
      document.getElementById('paymentProgressBar').style.width = `${progressPercentage}%`;
      document.getElementById('paidAmount').textContent = paidAmount.toFixed(2);
      document.getElementById('totalAmount').textContent = totalAmount.toFixed(2);
      
      // Update payment status text
      const paymentStatus = document.getElementById('paymentStatus');
      if (progressPercentage >= 100) {
        paymentStatus.textContent = 'Fully Paid';
        paymentStatus.className = 'fw-bold text-success';
      } else if (progressPercentage > 0) {
        paymentStatus.textContent = 'Partially Paid';
        paymentStatus.className = 'fw-bold text-warning';
      } else {
        paymentStatus.textContent = 'Pending';
        paymentStatus.className = 'fw-bold text-danger';
      }
    }

    // View Invoice
    window.viewInvoice = (invoiceId) => {
      // Redirect to invoice page or open in new tab
      window.open(`invoice.html?view=${invoiceId}`, '_blank');
    };

    // View LR Details
    window.viewLRDetails = async (lrId) => {
      const dataRoot = coreAccountId || currentUser.uid;
      const lrRef = ref(db, `users/${dataRoot}/lrReports/${lrId}`);
      const lrSnap = await get(lrRef);
      
      if (!lrSnap.exists()) {
        alert('LR report not found.');
        return;
      }
      
      const lr = lrSnap.val();
      const modalContent = document.getElementById('lrDetailContent');
      
      // Calculate total expenses from the LR data
      const totalExpenses = (
        (parseFloat(lr.tyreExpenses) || 0) +
        (parseFloat(lr.dieselExpenses) || 0) +
        (parseFloat(lr.tollExpenses) || 0) +
        (parseFloat(lr.vehicleWork) || 0) +
        (parseFloat(lr.foodExpenses) || 0) +
        (parseFloat(lr.otherExpenses) || 0) +
        (parseFloat(lr.advance) || 0)
      );
      const profit = (lr.billingAmount || 0) - totalExpenses;

      modalContent.innerHTML = `
        <div class="row">
          <div class="col-md-6">
            <div class="detail-row"><strong>LR Number:</strong> ${lr.lrNumber || 'N/A'}</div>
            <div class="detail-row"><strong>Date:</strong> ${lr.date || 'N/A'}</div>
            <div class="detail-row"><strong>Vehicle:</strong> ${lr.truckNumber || 'N/A'}</div>
            <div class="detail-row"><strong>Route:</strong> ${lr.fromLocation || 'N/A'} to ${lr.toLocation || 'N/A'}</div>
            <div class="detail-row"><strong>Item:</strong> ${lr.item || 'N/A'}</div>
            <div class="detail-row"><strong>Weight:</strong> ${lr.weight || 0} tonnes</div>
          </div>
          <div class="col-md-6">
            <div class="detail-row"><strong>Billing Amount:</strong> ₹${(lr.billingAmount || 0).toFixed(2)}</div>
            <div class="detail-row"><strong>Freight Amount:</strong> ₹${(lr.freightAmount || 0).toFixed(2)}</div>
            <div class="detail-row"><strong>Advance Paid:</strong> ₹${(lr.advance || 0).toFixed(2)}</div>
            <div class="detail-row"><strong>Balance:</strong> ₹${(lr.balance || 0).toFixed(2)}</div>
            <div class="detail-row"><strong>Total Amount (inc. GST):</strong> ₹${(lr.totalAmount || 0).toFixed(2)}</div>
            <div class="detail-row">
              <strong>Payment Status:</strong> 
              <span class="status-badge ${lr.paymentStatus === 'paid' ? 'status-paid' : lr.paymentStatus === 'partial' ? 'status-pending' : 'status-overdue'}">
                ${lr.paymentStatus || 'pending'}
              </span>
            </div>
          </div>
        </div>
        <hr>
        <h5 class="mt-3">Expense Breakdown</h5>
        <div class="row">
            <div class="col-md-4"><div class="detail-row"><strong>Tyre:</strong> ₹${(lr.tyreExpenses || 0).toFixed(2)}</div></div>
            <div class="col-md-4"><div class="detail-row"><strong>Diesel:</strong> ₹${(lr.dieselExpenses || 0).toFixed(2)}</div></div>
            <div class="col-md-4"><div class="detail-row"><strong>Toll:</strong> ₹${(lr.tollExpenses || 0).toFixed(2)}</div></div>
            <div class="col-md-4"><div class="detail-row"><strong>Vehicle Work:</strong> ₹${(lr.vehicleWork || 0).toFixed(2)}</div></div>
            <div class="col-md-4"><div class="detail-row"><strong>Food:</strong> ₹${(lr.foodExpenses || 0).toFixed(2)}</div></div>
            <div class="col-md-4"><div class="detail-row"><strong>Other:</strong> ₹${(lr.otherExpenses || 0).toFixed(2)}</div></div>
        </div>
        <hr>
        <div class="row fw-bold fs-5 mt-3">
            <div class="col-6 text-end">Total Expenses:</div>
            <div class="col-6 text-start">₹${totalExpenses.toFixed(2)}</div>
        </div>
        <div class="row fw-bold fs-5 mt-1 ${profit >= 0 ? 'text-success' : 'text-danger'}">
            <div class="col-6 text-end">Net Profit:</div>
            <div class="col-6 text-start">₹${profit.toFixed(2)}</div>
        </div>
      `;
      
      // Show the modal
      const modal = new bootstrap.Modal(document.getElementById('lrDetailModal'));
      modal.show();
    };

    // Back to List
    document.getElementById('backBtn').addEventListener('click', () => {
      document.getElementById('clientDetail').classList.add('hidden');
      document.getElementById('clientListView').classList.remove('hidden');
      currentClientId = null;
    });

    // Export to Excel
    document.getElementById('exportExcel').addEventListener('click', () => {
      const data = [];
      const headers = ['Name', 'GSTIN', 'Contact', 'Outstanding', 'Total Trips'];
      
      data.push(headers);
      
      const rows = document.querySelectorAll('#clientTableBody tr');
      rows.forEach(row => {
        const rowData = [];
        const cells = row.querySelectorAll('td');
        cells.forEach((cell, index) => {
          if (index !== 5) { // Skip actions column
            rowData.push(cell.textContent.trim());
          }
        });
        data.push(rowData);
      });
      
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Clients');
      XLSX.writeFile(wb, 'clients.xlsx');
    });

    // Payment search functionality
    document.getElementById('paymentSearchInput').addEventListener('input', (e) => {
      paymentTable.search(e.target.value).draw();
    });
  </script>
</body>
</html>
