<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Client Management - Transport System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { padding: 0; margin: 0; background-color: #f8f9fa; }
    .main-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .hidden { display: none !important; }
    .form-section {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #dee2e6;
    }
    .list-group-item {
      border-color: #dee2e6;
    }
    .nav-tabs .nav-link.active {
      background-color: #0d6efd;
      color: white;
    }
    .action-btns button {
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <!-- Navbar will be loaded here by navbar-loader.js -->
  <div id="navbar-placeholder"></div>

  <!-- Main Content -->
  <div class="container mt-4">
    <div class="main-content" id="clientListView">
      <h2 class="mb-4"><i class="fas fa-users me-2"></i>Client Management</h2>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-3" id="clientTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="clients-tab" data-bs-toggle="tab" data-bs-target="#clients-content" type="button" role="tab">Clients</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payments-content" type="button" role="tab">Client Payments</button>
      </li>
    </ul>

    <div class="tab-content" id="clientTabsContent">
      <div class="tab-pane fade show active" id="clients-content" role="tabpanel">

    <!-- Add Client Form -->
    <form id="clientForm" class="form-section">
      <h4 class="mb-3">Add New Client</h4>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="clientName" class="form-label">Client Name <span class="text-danger">*</span></label>
          <input type="text" id="clientName" class="form-control" placeholder="Client Name" required>
        </div>
        <div class="col-md-6 mb-3">
          <label for="contactPerson" class="form-label">Contact Person <span class="text-danger">*</span></label>
          <input type="text" id="contactPerson" class="form-control" placeholder="Contact Person" required>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="mobile" class="form-label">Mobile Number <span class="text-danger">*</span></label>
          <input type="tel" id="mobile" class="form-control" placeholder="Mobile Number" required>
        </div>
        <div class="col-md-6 mb-3">
          <label for="email" class="form-label">Email</label>
          <input type="email" id="email" class="form-control" placeholder="Email">
        </div>
      </div>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="gstin" class="form-label">GSTIN</label>
          <input type="text" id="gstin" class="form-control" placeholder="GSTIN">
        </div>
        <div class="col-md-6 mb-3">
          <label for="pan" class="form-label">PAN</label>
          <input type="text" id="pan" class="form-control" placeholder="PAN">
        </div>
      </div>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="billingAddress" class="form-label">Billing Address</label>
          <textarea id="billingAddress" class="form-control" placeholder="Billing Address"></textarea>
        </div>
        <div class="col-md-6 mb-3">
          <label for="dispatchAddress" class="form-label">Dispatch Address</label>
          <textarea id="dispatchAddress" class="form-control" placeholder="Dispatch Address"></textarea>
        </div>
      </div>
      <button type="submit" class="btn btn-primary"><i class="fas fa-plus me-2"></i>Add Client</button>
    </form>

    <!-- Search + Export -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4>Client List</h4>
      <button id="exportExcel" class="btn btn-success"><i class="fas fa-file-excel me-2"></i>Export Excel</button>
    </div>

    <!-- Client List -->
    <div class="table-responsive">
      <table id="clientTable" class="table table-striped table-bordered" style="width:100%">
        <thead>
          <tr>
            <th>Name</th>
            <th>GSTIN</th>
            <th>Contact</th>
            <th class="text-end">Outstanding</th>
            <th class="text-center">Total Trips</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody id="clientTableBody"></tbody>
      </table>
    </div>
      </div>
      <div class="tab-pane fade" id="payments-content" role="tabpanel">
        <form id="paymentForm" class="form-section">
          <h4 class="mb-3">Add New Payment</h4>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="clientSelect">Select Client:</label>
              <select id="clientSelect" class="form-select" required>
                <option value="">Loading clients...</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label for="amount">Amount:</label>
              <input type="number" id="amount" class="form-control" required step="0.01" />
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="date">Date:</label>
              <input type="date" id="date" class="form-control" required />
            </div>
            <div class="col-md-6 mb-3">
              <label for="proofFile">Upload Proof:</label>
              <input type="file" id="proofFile" class="form-control" accept="image/*,application/pdf"/>
              <img id="preview" class="mt-2" style="display:none; max-width: 100px; border-radius: 6px;" />
            </div>
          </div>
          <button type="submit" class="btn btn-primary"><i class="fas fa-plus me-2"></i>Add Payment</button>
        </form>
        <input type="text" id="paymentSearchInput" class="form-control mb-3" placeholder="Search by company..." />
        <div class="table-responsive">
          <table id="paymentTable" class="table table-striped table-bordered" style="width:100%">
            <thead>
              <tr>
                <th>Company</th>
                <th>Amount</th>
                <th>Date</th>
                <th>Proof</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="paymentTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

    <!-- Client Detail View -->
    <div id="clientDetail" class="main-content hidden">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 id="clientTitle" class="mb-0">Client Details</h2>
        <button class="btn btn-secondary" id="backBtn"><i class="fas fa-arrow-left me-2"></i>Back to List</button>
      </div>

      <div class="card mb-4">
        <div class="card-body">
          <div class="row">
            <div class="col-md-4"><strong>Contact:</strong> <span id="clientContact"></span></div>
            <div class="col-md-4"><strong>GSTIN:</strong> <span id="clientGSTIN"></span></div>
            <div class="col-md-4"><strong>PAN:</strong> <span id="clientPAN"></span></div>
          </div>
          <hr>
          <div class="row">
            <div class="col-md-4"><strong>Outstanding:</strong> <span id="clientOutstanding" class="fw-bold text-danger"></span></div>
            <div class="col-md-4"><strong>Total Trips:</strong> <span id="clientTrips" class="fw-bold"></span></div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4">
          <div class="card">
            <div class="card-header bg-primary text-white"><h5><i class="fas fa-file-invoice me-2"></i>Invoices</h5></div>
            <ul id="invoiceList" class="list-group list-group-flush"></ul>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-header bg-info text-white"><h5><i class="fas fa-receipt me-2"></i>LR Reports</h5></div>
            <ul id="lrList" class="list-group list-group-flush"></ul>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-header bg-success text-white"><h5><i class="fas fa-money-bill-wave me-2"></i>Payments</h5></div>
            <ul id="paymentList" class="list-group list-group-flush"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="navbar-loader.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, push, onValue, update, remove, query, orderByChild, equalTo, get } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Config
    const firebaseConfig = {
      apiKey: "AIzaSyDAlk_K8p8Of8Ne6Jpcl2QqXTtm95NgG7o",
      authDomain: "transport-dashboard-ad69a.firebaseapp.com",
      databaseURL: "https://transport-dashboard-ad69a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "transport-dashboard-ad69a",
      storageBucket: "transport-dashboard-ad69a.appspot.com",
      messagingSenderId: "526889676196",
      appId: "1:526889676196:web:66032c80a4aede690ae531",
      measurementId: "G-7F9R7HJYDH"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let clientTable;
    let currentUser = null;
    let paymentTable;
    let currentEditingPaymentId = null;

    // Auth Check
    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        currentUser = user;
        clientTable = $('#clientTable').DataTable({
          "pageLength": 10,
          "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
          "columnDefs": [{ "orderable": false, "targets": 5 }]
        });
        paymentTable = $('#paymentTable').DataTable({
          "pageLength": 10,
          "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
          "order": [[ 2, "desc" ]], // Sort by date descending
          "columnDefs": [{ "orderable": false, "targets": 4 }]
        });
        loadClients(user.uid);
        loadClientsForPaymentDropdown(user.uid);
        loadClientPayments(user.uid);
      }
    });

    // Add Client
    document.getElementById("clientForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) return;

      const newClientName = document.getElementById("clientName").value.trim();
      if (!newClientName) {
        alert('Client name cannot be empty.');
        return;
      }

      // Check for duplicates before saving
      const clientRef = ref(db, `users/${currentUser.uid}/clients`);
      const snapshot = await get(clientRef);
      let isDuplicate = false;
      if (snapshot.exists()) {
        snapshot.forEach(childSnapshot => {
          const client = childSnapshot.val();
          if (client.clientName && client.clientName.toLowerCase() === newClientName.toLowerCase()) {
            isDuplicate = true;
          }
        });
      }

      if (isDuplicate) {
        alert('A client with this name already exists. Please use a different name.');
        return; // Stop the function if a duplicate is found
      }

      // If not a duplicate, proceed to save
      const now = new Date().toISOString();
      const clientData = {
        clientName: newClientName, // Use the trimmed name
        gstin: document.getElementById("gstin").value,
        pan: document.getElementById("pan").value,
        contactPerson: document.getElementById("contactPerson").value,
        mobile: document.getElementById("mobile").value,
        email: document.getElementById("email").value,
        billingAddress: document.getElementById("billingAddress").value,
        dispatchAddress: document.getElementById("dispatchAddress").value,
        outstanding: 0,
        totalTrips: 0,
        createdAt: now,
        updatedAt: now
      };

      push(ref(db, `users/${currentUser.uid}/clients`), clientData)
        .then(() => {
          e.target.reset();
          alert('Client added successfully!');
        })
        .catch((error) => {
          alert('Error adding client: ' + error.message);
        });
    });

    // --- CLIENT PAYMENT LOGIC ---

    // Load clients into the payment dropdown
    function loadClientsForPaymentDropdown(uid) {
        const clientRef = ref(db, `users/${uid}/clients`);
        onValue(clientRef, (snapshot) => {
            const select = document.getElementById('clientSelect');
            select.innerHTML = '<option value="">Select a Client</option>';
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    const client = child.val();
                    const option = document.createElement('option');
                    option.value = child.key;
                    option.textContent = `${client.clientName} (Outstanding: ₹${(client.outstanding || 0).toFixed(2)})`;
                    option.dataset.name = client.clientName;
                    select.appendChild(option);
                });
            }
        });
    }

    // Handle image preview
    document.getElementById("proofFile").addEventListener("change", () => {
      const file = document.getElementById("proofFile").files[0];
      const preview = document.getElementById("preview");
      if (file && file.type.startsWith("image")) {
        const reader = new FileReader();
        reader.onload = () => {
          preview.src = reader.result;
          preview.style.display = "block";
        };
        reader.readAsDataURL(file);
      } else {
        preview.style.display = "none";
      }
    });

    // Cloudinary upload logic
    async function resizeImage(file, maxWidth = 800) {
      return new Promise((resolve) => {
        const img = document.createElement("img");
        const reader = new FileReader();
        reader.onload = (e) => { img.src = e.target.result; };
        img.onload = () => {
          const canvas = document.createElement("canvas");
          const scaleFactor = maxWidth / img.width;
          canvas.width = maxWidth;
          canvas.height = img.height * scaleFactor;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          canvas.toBlob((blob) => {
            resolve(new File([blob], file.name, { type: file.type }));
          }, 'image/jpeg', 0.85);
        };
        reader.readAsDataURL(file);
      });
    }

    async function uploadToCloudinary(file) {
      if (file.type.startsWith("image")) {
        file = await resizeImage(file, 800);
      }
      const url = `https://api.cloudinary.com/v1_1/doqapn15f/auto/upload`;
      const preset = "payment-billing";
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", preset);
      const res = await fetch(url, { method: "POST", body: formData });
      const data = await res.json();
      return data.secure_url;
    }

    // Handle adding a new payment
    document.getElementById("paymentForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const saveButton = e.target.querySelector('button[type="submit"]');
      let fileURL = "";
      const file = document.getElementById("proofFile").files[0];
      const clientSelect = document.getElementById("clientSelect");
      const selectedClientId = clientSelect.value;
      const selectedClientName = clientSelect.options[clientSelect.selectedIndex].dataset.name;
      const amount = parseFloat(document.getElementById("amount").value) || 0;
      const date = document.getElementById("date").value;
    
      if (!selectedClientId) {
          alert("Please select a client.");
          return;
      }
    
      saveButton.disabled = true;
      saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

      if (file) fileURL = await uploadToCloudinary(file);

      if (currentEditingPaymentId) {
        // Update logic
        const paymentRef = ref(db, `payments/${currentEditingPaymentId}`);
        const oldPaymentSnap = await get(paymentRef);
        const oldPayment = oldPaymentSnap.val();
        const amountDifference = amount - (oldPayment.amount || 0);

        const updates = {};
        updates[`/payments/${currentEditingPaymentId}/amount`] = amount;
        updates[`/payments/${currentEditingPaymentId}/date`] = date;
        updates[`/payments/${currentEditingPaymentId}/companyName`] = selectedClientName;
        updates[`/payments/${currentEditingPaymentId}/clientId`] = selectedClientId;
        if (file) updates[`/payments/${currentEditingPaymentId}/proof`] = fileURL;

        // Adjust outstanding balance
        const clientRef = ref(db, `users/${currentUser.uid}/clients/${selectedClientId}/outstanding`);
        const snapshot = await get(clientRef);
        const currentOutstanding = snapshot.val() || 0;
        updates[`/users/${currentUser.uid}/clients/${selectedClientId}/outstanding`] = currentOutstanding - amountDifference;

        await update(ref(db), updates);
        alert('Payment updated successfully!');
        currentEditingPaymentId = null;
        saveButton.innerHTML = '<i class="fas fa-plus me-2"></i>Add Payment';
      } else {
        // Add new logic
        const paymentRef = push(ref(db, `payments`));
        const paymentData = { companyName: selectedClientName, amount, date, proof: fileURL, id: paymentRef.key, clientId: selectedClientId, userId: currentUser.uid, createdAt: new Date().toISOString() };
        await set(paymentRef, paymentData);
        const clientRef = ref(db, `users/${currentUser.uid}/clients/${selectedClientId}/outstanding`);
        const snapshot = await get(clientRef);
        const currentOutstanding = snapshot.val() || 0;
        await set(clientRef, currentOutstanding - amount);
        alert('Payment added successfully!');
      }
      
      e.target.reset();
      document.getElementById("preview").style.display = "none";
      saveButton.disabled = false;
    });

    // Load client payments into the DataTable
    function loadClientPayments(uid) {
      const paymentsQuery = query(ref(db, 'payments'), orderByChild('userId'), equalTo(uid));
      onValue(paymentsQuery, (snapshot) => {
        paymentTable.clear();
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const payment = child.val();
            if (!payment.plan) { // Filter out subscription payments
              paymentTable.row.add([
                payment.companyName,
                `₹${(payment.amount || 0).toFixed(2)}`,
                payment.date,
                payment.proof ? `<a href="${payment.proof}" target="_blank">View</a>` : '—',
                `<div class="action-btns text-center">
                  <button class="btn btn-sm btn-outline-secondary me-1" onclick="editClientPayment('${child.key}')"><i class="fas fa-edit"></i></button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteClientPayment('${child.key}', '${payment.clientId}', ${payment.amount})"><i class="fas fa-trash"></i></button>
                 </div>`
              ]);
            }
          });
        }
        paymentTable.draw();
      });
    }

    // Edit Client Payment
    window.editClientPayment = async (paymentId) => {
      const paymentRef = ref(db, `payments/${paymentId}`);
      const snapshot = await get(paymentRef);
      if (!snapshot.exists()) {
        alert('Payment record not found.');
        return;
      }
      const payment = snapshot.val();
      currentEditingPaymentId = paymentId;

      document.getElementById('clientSelect').value = payment.clientId;
      document.getElementById('amount').value = payment.amount;
      document.getElementById('date').value = payment.date;
      const preview = document.getElementById('preview');
      preview.src = payment.proof || '';
      preview.style.display = payment.proof ? 'block' : 'none';

      document.querySelector('#paymentForm button[type="submit"]').innerHTML = '<i class="fas fa-save me-2"></i>Update Payment';
      document.getElementById('paymentForm').scrollIntoView({ behavior: 'smooth' });
    };

    // Delete a client payment and update outstanding balance
    window.deleteClientPayment = async (paymentId, clientId, amount) => {
      if (!confirm("Are you sure you want to delete this payment record? This will update the client's outstanding balance.")) return;

      const updates = {};
      updates[`/payments/${paymentId}`] = null; // Delete payment record

      // Add the payment amount back to the client's outstanding balance
      if (clientId && amount) {
        const clientRef = ref(db, `users/${currentUser.uid}/clients/${clientId}/outstanding`);
        const snapshot = await get(clientRef);
        const currentOutstanding = snapshot.val() || 0;
        updates[`/users/${currentUser.uid}/clients/${clientId}/outstanding`] = currentOutstanding + amount;
      }

      try {
        await update(ref(db), updates);
        alert('Payment deleted and client balance updated.');
      } catch (error) {
        alert('Error deleting payment: ' + error.message);
      }
    };

    // Search functionality for payment table
    $('#paymentSearchInput').on('keyup', function () {
        paymentTable.search(this.value).draw();
    });

    // Load Clients
    function loadClients(uid) {
      const clientRef = ref(db, "users/" + uid + "/clients");
      onValue(clientRef, (snapshot) => {
        clientTable.clear();
        snapshot.forEach(child => {
          const client = child.val();
          clientTable.row.add([
            client.clientName,
            client.gstin || "-",
            client.mobile,
            `₹${(client.outstanding || 0).toFixed(2)}`,
            client.totalTrips || 0,
            `<div class="text-center">
              <button class="btn btn-sm btn-outline-primary me-1" onclick="viewClient('${child.key}')"><i class="fas fa-eye"></i></button>
              <button class="btn btn-sm btn-outline-secondary me-1" onclick="editClient('${child.key}')"><i class="fas fa-edit"></i></button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteClient('${child.key}')"><i class="fas fa-trash"></i></button>
            </div>`
          ]).node().id = `client-row-${child.key}`;
        });
        clientTable.draw();
      });
    }

    // View Client
    window.viewClient = (id) => {
      document.getElementById("clientDetail").classList.remove("hidden");
      document.getElementById("clientListView").classList.add("hidden");

      const clientRef = ref(db, "users/" + currentUser.uid + "/clients/" + id);
      get(clientRef).then((snapshot) => {
        const c = snapshot.val();
        document.getElementById("clientTitle").textContent = c.clientName;
        document.getElementById("clientContact").textContent = c.contactPerson + " (" + c.mobile + ")";
        document.getElementById("clientGSTIN").textContent = c.gstin || "-";
        document.getElementById("clientPAN").textContent = c.pan || "-";
        document.getElementById("clientOutstanding").textContent = `₹${(c.outstanding || 0).toFixed(2)}`;
        document.getElementById("clientTrips").textContent = c.totalTrips || 0;
      });

      // Load linked data
      loadLinkedData(id);
    };

    async function loadLinkedData(clientId) {
      // Clear previous data
      const invoiceList = document.getElementById("invoiceList");
      const lrList = document.getElementById("lrList");
      const paymentList = document.getElementById("paymentList");
      const outstandingEl = document.getElementById("clientOutstanding");

      invoiceList.innerHTML = '<li>Loading...</li>';
      lrList.innerHTML = '<li>Loading...</li>';
      paymentList.innerHTML = '<li>Loading...</li>';
      outstandingEl.textContent = 'Calculating...';

      try {
        // Fetch all data concurrently
        const [invoiceSnap, lrSnap, paymentSnap] = await Promise.all([
          get(query(ref(db, "invoices"), orderByChild('userId'), equalTo(currentUser.uid))),
          get(query(ref(db, "lrReports"), orderByChild('userId'), equalTo(currentUser.uid))),
          get(query(ref(db, "payments"), orderByChild('userId'), equalTo(currentUser.uid)))
        ]);

        // Process Invoices
        let totalInvoiced = 0;
        invoiceList.innerHTML = "";
        if (invoiceSnap.exists()) {
          invoiceSnap.forEach(child => {
            const inv = child.val();
            if (inv.clientId !== clientId) return; // Filter for the correct client
            totalInvoiced += (inv.grandTotal || 0);
            invoiceList.innerHTML += `<li class="list-group-item"><a href="invoice.html?view=${child.key}" target="_blank">#${inv.invoiceNumber}</a> - ₹${(inv.grandTotal || 0).toFixed(2)}</li>`;
          });
        }
        if (!invoiceList.innerHTML) invoiceList.innerHTML = '<li class="list-group-item text-muted">No invoices found.</li>';

        // Process LRs
        let totalNonInvoiced = 0;
        lrList.innerHTML = "";
        if (lrSnap.exists()) {
          lrSnap.forEach(child => {
            const lr = child.val();
            if (lr.clientId !== clientId) return; // Filter for the correct client
            lrList.innerHTML += `<li class="list-group-item"><a href="lr-report.html?view=${child.key}" target="_blank">#${lr.lrNumber || 'N/A'}</a> - ${lr.fromLocation || ''} → ${lr.toLocation || ''} - ₹${(lr.totalAmount || 0).toFixed(2)}</li>`;
            if (!lr.invoiceId && lr.status !== 'Generated') {
              totalNonInvoiced += (lr.totalAmount || 0);
            }
          });
        }
        if (!lrList.innerHTML) lrList.innerHTML = '<li class="list-group-item text-muted">No LR reports found.</li>';

        // Process Payments
        let totalPaid = 0;
        const list = document.getElementById("paymentList");
        list.innerHTML = "";
        if (paymentSnap.exists()) {
          paymentSnap.forEach(child => {
            const pay = child.val();
            // Filter for the correct client and ensure it's an operational payment
            if (pay.clientId === clientId && !pay.plan) {
              totalPaid += parseFloat(pay.amount || 0);
              list.innerHTML += `<li class="list-group-item">₹${parseFloat(pay.amount || 0).toFixed(2)} on ${pay.date || 'N/A'}</li>`;
            }
          });
        }
        if (!list.innerHTML) list.innerHTML = '<li class="list-group-item text-muted">No payments found.</li>';

        // Final Calculation
        const finalOutstanding = totalInvoiced + totalNonInvoiced - totalPaid;
        outstandingEl.textContent = `₹${finalOutstanding.toFixed(2)}`;

      } catch (error) {
        console.error("Error loading linked data:", error);
        outstandingEl.textContent = 'Error';
        invoiceList.innerHTML = '<li class="list-group-item text-danger">Could not load invoices.</li>';
        lrList.innerHTML = '<li class="list-group-item text-danger">Could not load LRs.</li>';
        paymentList.innerHTML = '<li class="list-group-item text-danger">Could not load payments.</li>';
      }
    }

    // Back button
    document.getElementById("backBtn").addEventListener("click", () => {
      document.getElementById("clientDetail").classList.add("hidden");
      document.getElementById("clientListView").classList.remove("hidden");
    });

    // Edit Client
    window.editClient = (id) => {
      const newName = prompt("Enter new name:");
      if (newName) {
        update(ref(db, "users/" + currentUser.uid + "/clients/" + id), { 
          clientName: newName,
          updatedAt: new Date().toISOString()
        });
      }
    };

    // Delete Client
    window.deleteClient = async (clientId) => {
      if (!confirm("Are you sure you want to delete this client? This will also delete all associated LR reports, invoices, and payments. This action cannot be undone.")) {
        return;
      }
      if (!currentUser) return alert('Not authenticated.');

      try {
        const updates = {};
        updates[`/users/${currentUser.uid}/clients/${clientId}`] = null;

        // Find and delete associated LRs
        const lrQuery = query(ref(db, "lrReports"), orderByChild('clientId'), equalTo(clientId));
        const lrSnap = await get(lrQuery);
        if (lrSnap.exists()) {
          lrSnap.forEach(child => {
            updates[`/lrReports/${child.key}`] = null;
          });
        }

        // Find and delete associated invoices
        const invQuery = query(ref(db, "invoices"), orderByChild('clientId'), equalTo(clientId));
        const invSnap = await get(invQuery);
        if (invSnap.exists()) {
          invSnap.forEach(child => {
            updates[`/invoices/${child.key}`] = null;
          });
        }

        // Find and delete associated payments
        const payQuery = query(ref(db, "payments"), orderByChild('clientId'), equalTo(clientId));
        const paySnap = await get(payQuery);
        if (paySnap.exists()) {
          paySnap.forEach(child => {
            updates[`/payments/${child.key}`] = null;
          });
        }

        // Perform atomic update
        await update(ref(db), updates);
        alert('Client and all associated data deleted successfully.');
        // The onValue listener in loadClients will handle the UI update automatically.

      } catch (error) {
        console.error("Error deleting client and associated data:", error);
        alert("Failed to delete client. Please try again.");
      }
    };

    // Export to Excel
    document.getElementById("exportExcel").addEventListener("click", () => {
      const table = document.getElementById("clientTable");
      const wb = XLSX.utils.table_to_book(table, { sheet: "Clients" });
      XLSX.writeFile(wb, "Clients.xlsx");
    });

    // Make functions globally accessible for onclick attributes
    window.viewClient = viewClient;
    window.editClient = editClient;
    window.deleteClient = deleteClient;
    window.editClientPayment = editClientPayment;
    window.deleteClientPayment = deleteClientPayment;
  </script>
</body>
</html>

